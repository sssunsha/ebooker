define("rewrite/backbone_rewrite",["require","exports","module"],function(e,t){Backbone.Model.prototype.toJSON=function(){var e=_.clone(this.attributes);return e.local=this.local,e},Backbone.Model.prototype.isNew=function(){return this.local?!0:this.get("local")?!0:null==this.id},Backbone.View.mixin=function(e,t){if(_.defaults(e.prototype,t),_.defaults(e.prototype.events,t.events),void 0!==t.initialize){var i=e.prototype.initialize;e.prototype.initialize=function(){t.initialize.apply(this),i.apply(this)}}},Backbone.View.prototype.close=function(){this.stopListening(),this.undelegateEvents(),this.onClose&&this.onClose()},Backbone.View.prototype.subViews={},Backbone.View.prototype.removeAll=function(){_.isEmpty(this.subViews)||_.each(_.values(this.subViews),function(e){e.onClose&&e.onClose(),e.remove()}),this.onClose&&this.onClose(),this.remove()}}),define("configs/settings",["require","exports","module"],function(e,t){t.is_product_mode=Appest.is_product_mode,t.user=Appest.user,t.userId=parseInt(Appest.user.inboxId.match(/\d+$/)[0],10),t.user.userId=t.userId,t.user.isJustRegistered=!1,t.user.introNum=[],t.protocol=Appest.protocol,t.domain=Appest.domain,t.end_date=Appest.end_date,t.cdn="//"+Appest.cdn,t.language=Appest.language.replace("_","-").toLowerCase(),t.iscnlang=/zh\Scn/i.test(t.language),t.productName=Appest.productName,t.isCnSites=Appest.isCnSites,t.IMG_SRC="/static/",t.API_HOST="//"+window.location.host+"/api/v2",t.API_HOST_V2="//"+window.location.host+"/api/v2",t.API_HOST_V2_PUB="//"+window.location.host+"/pub/api/v2",t.VERSION_API_HOST="//"+window.location.host+"/api/v2",t.API_HOST_V3="//"+window.location.host+"/api/v3",t.API_HOST_V1="//"+window.location.host+"/api/v1",t.autoParseDate=!0,t.canUseTag=!1,t.calendarSubscribe=!1,t.tkcalendar=!1,t.cacheExpireTime=86400,t.orderStep=Math.pow(2,40),t.reminderStamp="TRIGGER:PT0S",t.colors=["transparent","#00cdff","#00d5be","#18d764","#a6da03","#ffd33c","#ffab3c","#ff8c73","#ff6aa6","#dd65ff"],t.debounceTime=100,t.throttleTime=100,t.responsiveTime=100,t.getCalendarTime=36e5,t.aDayTime=864e5,t.user.isDS&&$("html").addClass("developer"),t.defaultAvatar="static/img/avatar-new.png"}),define("lang/index",["require","exports","module"],function(e,t){var i=window.langJsonEN,n=/^(zh\Scn|ru|ru\Smo|pt|pt\Sbr|uk|it|it\Sch|pl|ko|ja|lt)$/i,s=window.Appest?window.Appest.language:navigator.language,a=s.replace("_","-").toLowerCase().replace(/\s*/g,"");if(n.test(s)){var r="langJson"+s.slice(0,2).toUpperCase();i=window[r]||i}t.get=function(e){var t=i[e];if(arguments.length>1)for(var n=1;n<=arguments.length;n++){var s=new RegExp("%s"+n,"g");t=t.replace(s,arguments[n])}return t||e},t.isZHLike=function(){var e=/^(zh|ko|ja)/i;return e.test(s)},t.isZH=function(){var e=/^(zh)/i;return e.test(s)},moment.lang(n.test(s)?a:"en")}),define("utils/browser",["require","exports","module","configs/settings","lang/index"],function(e,t){var i=(e("configs/settings"),e("lang/index"),{Android:!!navigator.userAgent.match(/Android/i),BlackBerry:!!navigator.userAgent.match(/BlackBerry/i),iOS:!!navigator.userAgent.match(/iPhone|iPad|iPod/i),Opera:!!navigator.userAgent.match(/Opera Mini/i),Windows:!!navigator.userAgent.match(/IEMobile/i),Wechat:!!navigator.userAgent.match(/MicroMessenger/i)});t.isMobile={Android:function(){return i.Android},BlackBerry:function(){return i.BlackBerry},iOS:function(){return i.iOS},Opera:function(){return i.Opera},Windows:function(){return i.Windows},Wechat:function(){return i.Wechat},any:function(){return i.Android||i.BlackBerry||i.iOS||i.Opera||i.Windows}};var n=navigator.userAgent.toLowerCase();t.isSafari=n.match(/safari/)&&null===n.match(/chrome/),t.isChrome=null!==n.match(/chrome/),t.isFirefox=null!==n.match(/firefox/),t.isIE=null!==n.match(/trident/),t.isIE10=null!==n.match(/msie 10.0/),t.isOldIE=function(){var e=document.createElement("b");return e.innerHTML="<!--[if lte IE 9 ]><i></i><![endif]-->",1===e.getElementsByTagName("i").length}(),t.isChromeLower=t.isChrome&&parseInt(n.match(/chrome\/(\d+)/)&&n.match(/chrome\/(\d+)/)[1])<38;var s=function(){if(!t.isIE)return!1;var e=n.split("msie"),i=n.split(/rv:(\d+)/);return e&&parseInt(e[1])||i&&parseInt(i[1])}();t.getIeVersion=function(){return s},t.isMac=navigator.platform.match(/Mac/),t.isInMacWebview=t.isMac&&null!==n.match(/applewebkit/)&&!t.isSafari&&!t.isChrome,t.isInMacWebview=t.isMac&&null!==navigator.userAgent.toLowerCase().match(/applewebkit/)&&!t.isSafari&&!t.isChrome}),define("rewrite/string_rewrite",["require","exports","module","utils/browser"],function(e,t){var i=e("utils/browser"),n=i.getIeVersion();n&&9>n&&(String.prototype.trim=function(){return this})}),define("utils/log",["require","exports","module"],function(e,t){t.log=function(){if(Function.prototype.bind&&window.console&&"function"==typeof console.log){var e=Function.prototype.bind.call(console.log,console);e.apply(console,arguments)}},t.info=function(){if(Function.prototype.bind&&window.console&&"function"==typeof console.info){var e=Function.prototype.bind.call(console.info,console);e.apply(console,arguments)}}}),define("model/userProfile",["require","exports","module","configs/settings"],function(e,t){var i=e("configs/settings");t.Model=Backbone.Model.extend({defaults:{userId:i.userId,inboxId:i.user.inboxId,username:i.user.username},url:function(){return i.API_HOST+"/user/profile"},isPro:function(){return i.user.isGFS?!0:!1},isDev:function(){return i.user.isDS?!0:!1},isVerifiedEmail:function(){return this.get("verifiedEmail")}})}),define("service/userProfile",["require","exports","module","model/userProfile"],function(e,t){var i=e("model/userProfile").Model;return new i}),define("configs/dict",["require","exports","module","service/userProfile"],function(e,t){var i=e("service/userProfile"),n=i.get("inboxId"),s=i.get("username");t.sortType={today:"today",week:"week",inbox:"sortOrder",completed:"completedTime",trash:"modifiedTime",explore:"dueDate",calendar:"calendar",assignee:"assignee",sortOrder:"sortOrder",dueDate:"dueDate",completedTime:"completedTime",modifiedTime:"modifiedTime",priority:"priority",title:"title",project:"project",filterCompleted:"filterCompleted"},t.section={assigned:"assigned",today:"today",tomorrow:"tomorrow",date:"date",noDate:"noDate",overdue:"overdue",next7Days:"next-7days",later:"later",priority:"priority",completed:"completed",search:"search",order:"order",title:"title",trash:"trash",tag:"tag",project:"project",chooseDate:"chooseDate"},t.priority={5:"high-priority",3:"medium-priority",1:"low-priority",0:"none-priority"},t.priorityTitle={5:"high",3:"medium",1:"low",0:"none"},t.priorityValue={high:5,medium:3,low:1,none:0},t.weekValue={first:0,second:1,third:2,forth:3,fifth:4,sixth:5,seventh:6},t.weekStr={JA:"Jan",TU:"Tue",WE:"Wed",TH:"Thu",FR:"Fri",SA:"Sat",SU:"Sun"},t.projectType=["completed","trash","today","week","inbox","assignedme","tasks","calendar","explore","group"],t.projectPlace={tasks:"list-collection-a",today:"list-collection-t",week:"list-collection-t",explore:"list-collection-t",calendar:"list-collection-t",completed:"list-collection-c",trash:"list-collection-c",assignedme:"list-collection-t"},t.projectPlace[n]="list-collection-i",t.shortUrl={p:"project",q:"smart",s:"search",d:"calendar",tag:"tag"},t.pluginId={search:"plugin-search",tag:"plugin-tag",duplicate:"plugin-duplicate",calendar:"plugin-calendar",taskActivity:"plugin-task-activity",calSubscribe:"plugin-calendarSubscribe",tkcalendar:"plugin-tkcalendar"},t.plugin={free:[t.pluginId.search,t.pluginId.tag,t.pluginId.duplicate],pro:[t.pluginId.search,t.pluginId.calendar,t.pluginId.taskActivity,t.pluginId.calSubscribe],pro_only:[t.pluginId.calendar,t.pluginId.taskActivity,t.pluginId.calSubscribe,t.pluginId.tkcalendar]},t.format={atomTime:"YYYY-MM-DDTHH:mm:ss.SSSZZ",dateTime:"YYYY-MM-DDT00:00:00.000ZZ"},t.cachePath={projects:s+"/projects",sortTypeAll:s+"/sorttypeoflistall",sortTypeInbox:s+"/sorttypeoflistinbox",sortTypeList:s+"/sorttypeoflist",sortTypeAssignedMe:s+"/sorttype/assignedme",sortTypeToday:s+"/sorttypeoftoday",sortTypeWeek:s+"/sorttypeofweek",smartProjects:s+"/smartprojects",tasks:s+"/tasks",trash:s+"/trash",original:s+"/original",comment:s+"/comment",commentDraft:s+"/commentdraft",taskOrderByDate:s+"/task_order_by_date",shareUsers:s+"shareusers",filterCompleted:s+"filtercompleted",sortTypeTag:s+"/sorttype/tag",preferences:s+"/preferences",subscribeProjects:s+"/subscribe/projects",subscribeEvents:s+"/subscribe/event"},t.icon={dueDate:"icon-sort-by-duedate",priority:"icon-sort-by-priority",sortOrder:"icon-sort-by-custom",title:"icon-sort-by-title",project:"icon-sort-by-list",assignee:"icon-sort-by-assignee"},t.emptyIcon={today:"icon-empty-today-list",week:"icon-empty-week-list",search:"icon-empty-search-list",completed:"icon-empty-completed-list",assign:"icon-empty-assign-list","default":"icon-empty-default-list",trash:"icon-empty-trash-list",subscribe:"icon-empty-subscribe-list"},t.distingFileType={image:/(image)$/i,pdf:/(pdf)$/i,ppt:/(ppt)$/i,xls:/(xls)$/i,doc:/(doc)$/i,text:/(text)$/i,video:/(video)$/i,audio:/(audio)$/i,voice:/(voice)$/i},t.extToFileType={IMAGE:["bmp","gif","jpg","jpeg","png","tiff"],AUDIO:["amr","mp3","3gp","3gpp","m4a"],VIDEO:["mp4","avi"],PDF:["pdf"],DOC:["doc","docx","pages","odt"],TEXT:["txt","rtf"],XLS:["xls","xlsx","numbers","ods"],PPT:["ppt","pps","keynote","odp","pptx","ppsx"]},t.repeatFromType={dueDate:"0",completedTime:"1",defaultVal:"2"},t.openType={project:"projectOpenStatus",tag:"tagOpenStatus",projectGroup:"projectGroupOpenStatus"},t.userPublicProfile={storePath:"userPublicProfiles"},t.projectGroup={storePath:"projectGroup"},t.completedSectionStatus={storePath:"completed_section_status"},t.triggerUnit={2:"years",3:"months",4:"weeks",5:"days",7:"hours",8:"minutes"},t.defaultRemindTime="09:00",t.hoverClass={section:"task-drag-hovered",project:"project-drag-hovered",group:"group-drag-hovered"},t.smartProjectId={all:"tasks",today:"today",week:"week",tkcalendar:"calendar",assignedme:"assignedme",completed:"completed",trash:"trash",subscribe:"subscribe-calendar"},t.smartProjectStatus={auto:"auto",show:"show",hide:"hide"},t.screenSize={mobile:920}}),define("utils/hash",["require","exports","module","configs/dict","lang/index","configs/settings"],function(e,t){var i=e("configs/dict"),n=(e("lang/index"),e("configs/settings"));t.getHash=function(){var e=decodeURI(window.location.href).match(/#(.*)$/);return e?e[1]:""},t.readUrl=function(){var e=t.getHash().split("/"),n={category:i.shortUrl[e[0]],name:e[1],type:e[2],taskid:e[3]};return n},t.getTaskUpperLevelPath=function(){var e=t.getHash().split("/");return e.length>3&&(e=e.slice(0,3)),e[1]=encodeURIComponent(e[1]),e.join("/")},t.getTaskIdFromPath=function(){var e=t.getHash(),i=e.split("/");return i.length>3?i.pop():null},t.isShowDetailView=function(){return t.getTaskIdFromPath()},t.getProjectNameByUrl=function(){var e=t.getHash().split("/");return e[1]},t.getProjectIdByUrl=function(){return t.getHash().split("/")[1]},t.isInTasks=function(){var e=t.getHash().split("/");return"tasks"===e[2]||"inbox"===e[1]},t.isInSubscribeCalendars=function(){var e=t.getHash().split("/");return e[2]===i.smartProjectId.subscribe||t.getHash().indexOf("@calendar."+n.domain)>0||t.getHash().indexOf("@google.com")>0},t.isInInbox=function(){var e=t.getHash().split("/");return"inbox"===e[1]},t.isInProjectAll=function(){var e=t.getHash().split("/");return t.isInSmartProjectView()&&("all"===e[1]&&"tasks"===e[2]||""===t.getHash())},t.isInCompleted=function(){var e=t.getHash().split("/");return"completed"===e[2]},t.isInTrash=function(){var e=t.getHash().split("/");return"trash"===e[2]},t.isInToday=function(){var e=t.getHash().split("/");return"today"===e[2]},t.isInWeek=function(){var e=t.getHash().split("/");return"week"===e[2]},t.isInTodayOrWeek=function(){return t.isInToday()||t.isInWeek()},t.isInProjectView=function(){var e=t.getHash().split("/");return"p"===e[0]},t.isInSmartProjectView=function(){var e=t.getHash().split("/");return"q"===e[0]},t.isInDateView=function(){var e=t.getHash().split("/");return"d"===e[0]},t.isInSearchView=function(){var e=t.getHash().split("/");return"s"===e[0]},t.isInTagView=function(){var e=t.getHash().split("/");return"t"===e[0]},t.isInProjectGroup=function(){var e=t.getHash().split("/");return"g"===e[0]},t.isInAssignedMe=function(){var e=t.getHash().split("/");return"assignedme"===e[2]},t.isSettings=function(){var e=t.getHash().split("/");return"settings"===e[0]},t.canShowArchinveButton=function(){return t.isInProjectAll()||t.isInProjectView()||t.isInToday()||t.isInWeek()},t.redirectToSignon=function(){window.location.href="/signon"},t.redirectToSignout=function(){locache.flush(),window.location.href="/signout"},t.isInTKCalendar=function(){var e=t.getHash().split("/");return e[2]===i.smartProjectId.tkcalendar},t.getProjectGroupNameByUrl=function(){var e=t.getHash().split("/");return e[1]},t.reload=function(){window.location.href="/"}}),define("utils/timeformat",["require","exports","module","lang/index"],function(e,t){var i=e("lang/index"),n="YYYY-MM-DDTHH:mm:00.000ZZ",s=t.prefMoment=function(e){return moment(e).local()};t._today=moment(),t.getUTCStartOfDay=function(e,t,i){var n=moment().startOf("day").utc();return n.add(e,t).format(i)},t.getStartOfDay=function(e,t,i){var n=moment().startOf("day");return n.add(e,t).format(i)},t.getRepeatFirstDateFormat=function(e){if(null==e)return"";var t=s(e);if("1970"!=t.format("YYYY"))return i.get("repeat_start_on")+t.format("YYYY-MM-DD")},t.getDueDateLocalZone=function(e){return null!=e&&""!=e?t.prefMomentFromUtc(e):void 0},t.getDueDateLocalZoneDate=function(e){return null!=e&&""!=e?t.prefMomentFromUtc(e).startOf("day"):void 0},t.getDueDateText=function(e){var i=t.getDueDateLocalZone(e);return i?i.format("YYYY-MM-DD"):""},t.getDateFormat=function(e){var n="",a=t.getDueDateLocalZoneDate(e).diff(s().startOf("day"),"days"),r=t.getDueDateLocalZoneDate(e).diff(s().startOf("day"),"years");if(0===a)n=i.get("today");else{var o=i.isZHLike()?"MMMDo":"MMMM D";0>r&&(o+=", YYYY"),n=t.prefMomentFromUtc(e).format(o)}return n},t.getRecentlyDueDateTip=function(e){var n="",a=t.getDueDateLocalZoneDate(e).diff(s().startOf("day"),"days");if(0===a)n+=i.get("today");else if(1===a)n+=i.get("tomorrow");else if(-1===a)n+=i.get("yesterday");else if(a>0&&6>=a)n+=s(e).format("ddd");else{var r=moment().utc().startOf("day");if(a>0){var o=moment().utc().startOf("day").add(1,"months"),l=t.getDueDateLocalZoneDate(e).diff(o,"days");0>l?n+=i.get("days_later").replace("%s1",a):(n+=r.from(e,!0),n=_.string.sprintf(i.get("later"),n))}else n+=r.from(e,!0),n=_.string.sprintf(i.get("ago"),n)}return n},t.formatCommentTime=function(e){return t.formatActivityTime(e)},t.formatUtcToDateString=function(e){return t.prefMomentFromUtc(e,n).format("YYYY-MM-DD")},t.formatToDateString=function(e){return e.format("YYYY-MM-DD")},t.getDueDateClass=function(e){var i="";return null==e||""==e?i:(0===t.getDueDateLocalZoneDate(e).diff(s().startOf("day"),"days")?i="duedate-today":t.getDueDateLocalZoneDate(e).diff(s().startOf("day"),"days")<=0&&(i="duedate-overdue"),i)},t.prefMoment=s,t.prefMomentFromUtc=function(e,t){return moment.utc(e,t).local()},t.dateToMoment=function(e){return moment(e)},t.dateFormatToMoment=function(e,t){return moment(e,t)},t.getAllTime=function(){return{startDay:"",endDay:""}},t.getToday=function(){var e=moment();return t.getDateRange(e,e)},t.getYesterday=function(){var e=moment().subtract("days",1);return t.getDateRange(e,e)},t.getDateRange=function(e,i){return{startDay:t.formatToUtc(e.format("YYYY-MM-DD")),endDay:t.formatToUtc(i.format("YYYY-MM-DD"))}},t.getThisWeek=function(e){var i=moment().day(e),n=moment().day(e).add(6,"day");return t.getDateRange(i,n)},t.getLastWeek=function(e){var i=moment().day(e).add(-7,"day"),n=moment().day(e).add(-1,"day");return t.getDateRange(i,n)},t.getThisMonth=function(){var e=moment().date(1),i=moment().endOf("month");return t.getDateRange(e,i)},t.getTheMonth=function(e){var i=moment(e).month(),n=moment().month(i).startOf("month"),s=moment().month(i).endOf("month");return t.getDateRange(n,s)},t.getLast7Days=function(){return t.getDateRange(moment().subtract("days",7),moment().subtract("days",1))},t.getLastMonth=function(){var e=moment().month()-1,i=moment().month(e).startOf("month"),n=moment().month(e).endOf("month");return t.getDateRange(i,n)},t.getLast30Days=function(){return t.getDateRange(moment().subtract("days",30),moment().subtract("days",1))},t.getLater=function(e,i,n){return t.formatToDateString(moment(e).add(i,n))},t.getOneDayLater=function(e){return t.getLater(e,1,"days")},t.getWeekLater=function(e){return t.getLater(e,7,"days")},t.getMonthLater=function(e){return t.getLater(e,1,"months")},t.getYearLater=function(e){return t.getLater(e,1,"years")},t.get5YearLater=function(e){return t.getLater(e,5,"years")},t.getStartOfToday=function(){return moment(new Date).startOf("day").format(n)},t.getStartOfTomorrow=function(){return moment(new Date).add(1,"day").startOf("day").format(n)},t.getNowHour=function(){return moment().hour()},t.formatDateForCompleted=function(e){var t="YYYY-MM-DD HH:mm:ss";return moment(e).format(t)},t.getUtcTodayStart=function(){var e="YYYY-MM-DD HH:mm:ss";return moment().utc().startOf("day").format(e)},t.getWeekStart=function(){return moment().subtract("days",7).startOf("day")},t.formatActivityTime=function(e){var n="",a=t.getDueDateLocalZoneDate(e),r=s().startOf("day"),o=a.diff(r,"days");if(a.year()!==r.year())n=moment(e).format("YYYY-MM-DD  HH:mm");else if(0>o)n=moment(e).format("MM-DD HH:mm");else{var l=moment(new Date).diff(moment(e));n=6e4>l?i.get("just_now"):moment(e).fromNow()}return n},t.formatProjectActivityTime=function(e){var n="",a=t.getDueDateLocalZoneDate(e),r=s().startOf("day"),o=a.diff(r,"days"),l=(i.isZHLike(),t.prefMomentFromUtc(e));if(a.year()!=r.year())n=l.format("LL");else if(-1>o){var c=i.isZHLike()?"MMMDo HH:mm":"MMM D HH:mm";n=l.format(c)}else if(-1==o)n=moment(e).format("["+i.get("yesterday")+"] HH:mm");else{var d=moment(new Date).diff(moment(e));n=6e4>d?i.get("just_now"):36e5>d?moment(e).fromNow():moment(e).format("["+i.get("today")+"] HH:mm")}return n},t.formatDueDate=function(e){var n=t.getDueDateLocalZoneDate(e);if(!n)return"";var a=s().startOf("day"),r="";return r=a.year()===n.year()?i.isZHLike()?"MMMDo":"MM.DD":i.isZHLike()?"LL":"YYYY.MM.DD","00:00"!==moment(e).format("HH:mm")&&(r+=" HH:mm"),moment(e).format(r)},t.formatToUtc=function(e){return e?moment(e).utc().format(n):void 0},t.formatToWeek=function(e,n){var s={SAT:-1,SUN:0,MON:1},o=t.prefMoment().add("days",s[n]-moment().day()),l=t.getDueDateLocalZoneDate(e).diff(o.startOf("day"),"days"),c="",d=i.isZHLike();return l>6?c=d?"MMMDo ["+i.get("next")+"]ddd":"["+i.get("next")+"] dddd, MMMM D":(c=a(e),c=c?c:r(e)),moment(e).format(c)},t.formatToWeekRough=function(e){var t=a(e);return t=t?t:r(e),moment(e).format(t)};var a=function(e){var n="",s=i.isZHLike(),a=t.getDueDateLocalZoneDate(e).diff(t.prefMoment().startOf("day"),"days");return 0===a?n=s?"["+i.get("today")+"] ddd":"dddd, ["+i.get("today")+"]":1===a?n=s?"["+i.get("tomorrow")+"] ddd":"dddd, ["+i.get("tomorrow")+"]":-1===a&&(n=s?"["+i.get("yesterday")+"] ddd":"dddd, ["+i.get("yesterday")+"]"),n},r=function(e){var n="",s=i.isZHLike(),a=t.getDueDateLocalZoneDate(e).year()!==t.prefMoment().year();return n=s?a?"YYYY年MMMDo ddd":"MMMDo ddd":a?"dddd, MMMM D, YYYY":"dddd, MMMM D"}}),define("utils/analytics",["require","exports","module","configs/settings","utils/hash","utils/timeformat","utils/log"],function(e,t){var i=e("configs/settings"),n=e("utils/hash"),s=e("utils/timeformat"),a=e("utils/log");t._track=function(){try{var e="_trackEvent",t=Array.prototype.slice.call(arguments);t.unshift(e),i.isCnSites?_czc.push(t):_gaq.push(t)}catch(n){a.log("track error")}},t.extension=function(){this._track("extension",arguments[0])},t.error=function(){this._track("error",arguments[0])},t._date=function(e){var t=s.dateFormatToMoment(e,"YYYY-MM-DD"),i=s.prefMoment().startOf("day"),n=t.diff(i,"days"),a="";return a=0>n?"<0":30>=n?""+n:">30"},t._list=function(){this._track("list",arguments[0],arguments[1])},t._tasklist=function(){this._track("tasklist",arguments[0],arguments[1])},t._detail=function(){this._track("detail",arguments[0],arguments[1])},t._due=function(){this._track("due",arguments[0],arguments[1])},t._reminder=function(){return arguments.length>1?void this._track("reminder",arguments[0],arguments[1]):void this._track("reminder",arguments[0])},t._cal=function(){this._track("calendar_view",arguments[0],arguments[1])},t._mcal=function(){this._track("mini_calendar",arguments[0],arguments[1])},t._scal=function(){this._track("subscribed_calendar",arguments[0],arguments[1])},t._filter=function(){this._track("completed",arguments[0],arguments[1])},t._search=function(){this._track("search",arguments[0])},t._menu=function(){this._track("menu",arguments[0])},t._plugin=function(){this._track("menu",arguments[0],arguments[1])},t._settings=function(){this._track("settings",arguments[0],arguments[1])},t._upgrade=function(){this._track("upgrade",arguments[0],arguments[1])},t.l_list=function(){this._list("list",arguments[0])},t.l_folder=function(){this._list("folder",arguments[0])},t.l_view=function(){var e={all_click:"all_click",tasks:"all_show",today:"today",week:"n7d",completed:"completed",trash:"trash",inbox:"inbox",list:"list",group:"list_all_tasks",calendar:"calendar_view",subscribe:"subscribed_calendar",tag:"tag",assignedme:"assignedme"},t=arguments[0];this._list("view",e[t])},t.l_share=function(){this._list("share_list",arguments[0])},t.t_menu=function(){this._tasklist("menu",arguments[0])},t.t_sort=function(){var e=/duedate|priority|title|order|assignee|project/i,t=arguments[0].toLowerCase().match(e)[0],i={duedate:"due_date",priority:"priority",title:"title",order:"custom",assignee:"assignee",project:"project"};this._tasklist("sort",i[t])},t.t_btn=function(){this._tasklist("btn",arguments[0])},t.t_drag=function(){this._tasklist("drag",arguments[0])},t._addProject=function(){var e=n.getHash().split("/"),t="tasks",i={tasks:"all",today:"today",week:"n7d",inbox:"inbox",list:"list",tag:"tag"};return n.isInSmartProjectView()?t=e[2]:n.isInInbox()?t="inbox":n.isInProjectView()?t="list":n.isInTagView()&&(t="tag"),i[t]},t.t_quick_add=function(){var e=this._addProject();this._tasklist("quick_add_list",e)},t.t_group_add=function(){var e=this._addProject();this._tasklist("group_add_list",e)},t.t_quick_add_key=function(){this._tasklist("quick_add",arguments[0])},t.td_btn=function(){this._detail("btn",arguments[0])},t.td_menu=function(){this._detail("menu",arguments[0])},t.td_sub_task=function(){this._detail("sub_task",arguments[0])},t.td_comment=function(){this._detail("comment",arguments[0])},t.d_date_btn=function(){this._due("date",arguments[0])},t.d_date=function(){var e=this._date(arguments[0]);this._due("date",e)},t.d_time=function(){this._due("time",arguments[0])},t.d_reminder=function(){var e={none:"None",PT0S_d:"due_date",PT0S:"on_time","-PT5M":"5m","-PT30M":"30m","-PT1H":"1h","-P1D":"1d","-P2D":"2d","-P3D":"3d","-P5D":"5d","-P7D":"7d",custom:"custom"},t=arguments[0];this._due("reminder",e[t])},t.d_reminder_count=function(){this._due("reminder_count",arguments[0])},t.d_repeat=function(){var e={never:"on_time_event",daily:"daily",weekly:"weekly",monthly:"monthly",yearly:"yearly",lunar_yearly:"lunar_yearly",other:"other",end_repeat:"end_repeat"},t=arguments[0];this._due("repeat",e[t])},t.d_by=function(){var e={0:"by_due_date",1:"by_completion_date",2:"by_default"},t=arguments[0];this._due("repeat_by",e[t])},t.d_btn=function(){this._due("btn",arguments[0])},t.r_show=function(){this._reminder("show")},t.r_close_icon=function(){this._reminder("close_icon")},t.r_close_btn=function(){this._reminder("close_button")},t.r_mark_done=function(){this._reminder("mark_done")},t.r_mark_all_done=function(){this._reminder("mark_all_done")},t.r_undone=function(){this._reminder("undone")},t.r_view=function(){this._reminder("view")},t.r_snooze=function(){var e={"15m":"15m","1h":"1h","3h":"3h",tomorrow:"1d",custom:"custom"},t=arguments[0];this._reminder("snooze",e[t])},t.c_task=function(){this._cal("task",arguments[0])},t.c_btn=function(){this._cal("operation",arguments[0])},t.m_btn=function(){this._mcal("operation",arguments[0])},t.m_date=function(){var e=this._date(arguments[0]);this._mcal("date",e)},t.s_btn=function(){this._scal("operation",arguments[0])},t.f_list=function(){this._filter("list",arguments[0])},t.f_date=function(){var e={alltime:"all",thisweek:"this_week",lastweek:"last_week",thismonth:"this_month",othermonth:"other_month"},t=arguments[0];this._filter("date",e[t])},t.f_print=function(){this._filter("print")},t.se_normal=function(){this._search("normal")},t.se_advanced=function(){this._search("advanced")},t.me_notify=function(){this._menu("notification")},t.me_settings=function(){this._menu("settings")},t.me_lab=function(){this._menu("lab")},t.me_lab_se=function(){var e={"enable-plugin-search":"enable_search","disable-plugin-search":"disable_search","enable-plugin-tag":"enable_tag","disable-plugin-tag":"disable_tag","enable-plugin-duplicate":"enable_duplication","disable-plugin-duplicate":"disable_duplication","enable-plugin-tkcalendar":"enable_calendar_view","disable-plugin-tkcalendar":"disable_calendar_view","enable_-plugin-calendarSubscribe":"enable_sub_calendar","disable-plugin-calendarSubscribe":"disable_sub_calendar","enable-plugin-version":"enable_revision","disable_-plugin-version":"disable_revision","enable-plugin-calendar":"enable_mini_calendar","disable-plugin-calendar":"disable_mini_calendar"},t=arguments[0];this._plugin("lab",e[t])},t.me_apps=function(){this._menu("get_apps")},t.me_version=function(){this._menu("go-to-new-version")},t.me_help=function(){this._menu("help")},t.me_import=function(){this._menu("import")},t.me_gift=function(){this._menu("gift")},t.me_shortcut=function(){this._menu("shortcut")},t.me_home=function(){this._menu("home")},t.me_sign_out=function(){this._menu("sign_out")},t.set_lang=function(){this._settings("language",arguments[0])},t.set_format=function(){this._settings("time_format",arguments[0])},t.set_daily=function(){this._settings("daily_alert",arguments[0])},t.set_account=function(){this._settings("account",arguments[0])},t.set_mail=function(){this._settings("mail",arguments[0])},t.set_sub=function(){this._settings("subscription",arguments[0])},t.set_theme=function(){this._settings("theme",arguments[0])},t.u_sub=function(){var e={settings:"settings",reminder:"reminder_count",list:"list_count",task:"task_count",subtask:"sub_task_count",sharing:"share_count",attachment:"upload_count","plugin-tkcalendar":"calendar_view","plugin-calendarSubscribe":"subscribe_calendar","plugin-version":"revision","plugin-calendar":"mini_calendar"},t=arguments[0];this._upgrade("show",e[t])}}),define("offline/storage",["require","exports","module","configs/settings","utils/log","utils/analytics","service/userProfile"],function(e,t){var i=e("configs/settings"),n=e("utils/log"),s=e("utils/analytics"),a=e("service/userProfile");t.datesHasTask=[],t.getCacheItem=function(e){try{return locache.get(e)}catch(t){n.log(t),s.error("getCacheItem")}},t.setCacheItem=function(e,t){try{return locache.set(e,t,i.cacheExpireTime)}catch(a){n.log(a),s.error("setCacheItem")}},t.setStoreInfo=function(e,t){try{localStorage.setItem(a.get("username")+"/"+e,t)}catch(i){n.log(i),s.error("localStorage.setItem")}},t.getStoreInfo=function(e,t){try{return"json"==t?JSON.parse(localStorage.getItem(a.get("username")+"/"+e)):localStorage.getItem(a.get("username")+"/"+e)}catch(i){n.log(i),s.error("getStoreInfo")}},t.removeStoreInfo=function(e){localStorage.removeItem(a.get("username")+"/"+e)}}),function(){var e={};!function(e,t){e.VERSION="1.0.0-rc.3",e.COMPILER_REVISION=2,e.REVISION_CHANGES={1:"<= 1.0.rc.2",2:">= 1.0.0-rc.3"},e.helpers={},e.partials={},e.registerHelper=function(e,t,i){i&&(t.not=i),this.helpers[e]=t},e.registerPartial=function(e,t){this.partials[e]=t},e.registerHelper("helperMissing",function(e){if(2===arguments.length)return t;throw new Error("Could not find property '"+e+"'")});var i=Object.prototype.toString,n="[object Function]";e.registerHelper("blockHelperMissing",function(t,s){var a=s.inverse||function(){},r=s.fn,o=i.call(t);return o===n&&(t=t.call(this)),t===!0?r(this):t===!1||null==t?a(this):"[object Array]"===o?t.length>0?e.helpers.each(t,s):a(this):r(t)}),e.K=function(){},e.createFrame=Object.create||function(t){e.K.prototype=t;var i=new e.K;return e.K.prototype=null,i},e.logger={DEBUG:0,INFO:1,WARN:2,ERROR:3,level:3,methodMap:{0:"debug",1:"info",2:"warn",3:"error"},log:function(t,i){if(e.logger.level<=t){var n=e.logger.methodMap[t];"undefined"!=typeof console&&console[n]&&console[n].call(console,i)}}},e.log=function(t,i){e.logger.log(t,i)},e.registerHelper("each",function(t,i){var n,s=i.fn,a=i.inverse,r=0,o="";if(i.data&&(n=e.createFrame(i.data)),t&&"object"==typeof t)if(t instanceof Array)for(var l=t.length;l>r;r++)n&&(n.index=r),o+=s(t[r],{data:n});else for(var c in t)t.hasOwnProperty(c)&&(n&&(n.key=c),o+=s(t[c],{data:n}),r++);return 0===r&&(o=a(this)),o}),e.registerHelper("if",function(t,s){var a=i.call(t);return a===n&&(t=t.call(this)),!t||e.Utils.isEmpty(t)?s.inverse(this):s.fn(this)}),e.registerHelper("unless",function(t,i){return e.helpers["if"].call(this,t,{fn:i.inverse,inverse:i.fn})}),e.registerHelper("with",function(e,t){return t.fn(e)}),e.registerHelper("log",function(t,i){var n=i.data&&null!=i.data.level?parseInt(i.data.level,10):1;e.log(n,t)})}(e);var t=function(){function e(){this.yy={}}var t={trace:function(){},yy:{},symbols_:{error:2,root:3,program:4,EOF:5,simpleInverse:6,statements:7,statement:8,openInverse:9,closeBlock:10,openBlock:11,mustache:12,partial:13,CONTENT:14,COMMENT:15,OPEN_BLOCK:16,inMustache:17,CLOSE:18,OPEN_INVERSE:19,OPEN_ENDBLOCK:20,path:21,OPEN:22,OPEN_UNESCAPED:23,OPEN_PARTIAL:24,partialName:25,params:26,hash:27,DATA:28,param:29,STRING:30,INTEGER:31,BOOLEAN:32,hashSegments:33,hashSegment:34,ID:35,EQUALS:36,PARTIAL_NAME:37,pathSegments:38,SEP:39,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",14:"CONTENT",15:"COMMENT",16:"OPEN_BLOCK",18:"CLOSE",19:"OPEN_INVERSE",20:"OPEN_ENDBLOCK",22:"OPEN",23:"OPEN_UNESCAPED",24:"OPEN_PARTIAL",28:"DATA",30:"STRING",31:"INTEGER",32:"BOOLEAN",35:"ID",36:"EQUALS",37:"PARTIAL_NAME",39:"SEP"},productions_:[0,[3,2],[4,2],[4,3],[4,2],[4,1],[4,1],[4,0],[7,1],[7,2],[8,3],[8,3],[8,1],[8,1],[8,1],[8,1],[11,3],[9,3],[10,3],[12,3],[12,3],[13,3],[13,4],[6,2],[17,3],[17,2],[17,2],[17,1],[17,1],[26,2],[26,1],[29,1],[29,1],[29,1],[29,1],[29,1],[27,1],[33,2],[33,1],[34,3],[34,3],[34,3],[34,3],[34,3],[25,1],[21,1],[38,3],[38,1]],performAction:function(e,t,i,n,s,a,r){var o=a.length-1;switch(s){case 1:return a[o-1];case 2:this.$=new n.ProgramNode([],a[o]);break;case 3:this.$=new n.ProgramNode(a[o-2],a[o]);break;case 4:this.$=new n.ProgramNode(a[o-1],[]);break;case 5:this.$=new n.ProgramNode(a[o]);break;case 6:this.$=new n.ProgramNode([],[]);break;case 7:this.$=new n.ProgramNode([]);break;case 8:this.$=[a[o]];break;case 9:a[o-1].push(a[o]),this.$=a[o-1];break;case 10:this.$=new n.BlockNode(a[o-2],a[o-1].inverse,a[o-1],a[o]);break;case 11:this.$=new n.BlockNode(a[o-2],a[o-1],a[o-1].inverse,a[o]);break;case 12:this.$=a[o];break;case 13:this.$=a[o];break;case 14:this.$=new n.ContentNode(a[o]);break;case 15:this.$=new n.CommentNode(a[o]);break;case 16:this.$=new n.MustacheNode(a[o-1][0],a[o-1][1]);break;case 17:this.$=new n.MustacheNode(a[o-1][0],a[o-1][1]);break;case 18:this.$=a[o-1];break;case 19:this.$=new n.MustacheNode(a[o-1][0],a[o-1][1]);break;case 20:this.$=new n.MustacheNode(a[o-1][0],a[o-1][1],!0);break;case 21:this.$=new n.PartialNode(a[o-1]);break;case 22:this.$=new n.PartialNode(a[o-2],a[o-1]);break;case 23:break;case 24:this.$=[[a[o-2]].concat(a[o-1]),a[o]];break;case 25:this.$=[[a[o-1]].concat(a[o]),null];break;case 26:this.$=[[a[o-1]],a[o]];break;case 27:this.$=[[a[o]],null];break;case 28:this.$=[[new n.DataNode(a[o])],null];

break;case 29:a[o-1].push(a[o]),this.$=a[o-1];break;case 30:this.$=[a[o]];break;case 31:this.$=a[o];break;case 32:this.$=new n.StringNode(a[o]);break;case 33:this.$=new n.IntegerNode(a[o]);break;case 34:this.$=new n.BooleanNode(a[o]);break;case 35:this.$=new n.DataNode(a[o]);break;case 36:this.$=new n.HashNode(a[o]);break;case 37:a[o-1].push(a[o]),this.$=a[o-1];break;case 38:this.$=[a[o]];break;case 39:this.$=[a[o-2],a[o]];break;case 40:this.$=[a[o-2],new n.StringNode(a[o])];break;case 41:this.$=[a[o-2],new n.IntegerNode(a[o])];break;case 42:this.$=[a[o-2],new n.BooleanNode(a[o])];break;case 43:this.$=[a[o-2],new n.DataNode(a[o])];break;case 44:this.$=new n.PartialNameNode(a[o]);break;case 45:this.$=new n.IdNode(a[o]);break;case 46:a[o-2].push(a[o]),this.$=a[o-2];break;case 47:this.$=[a[o]]}},table:[{3:1,4:2,5:[2,7],6:3,7:4,8:6,9:7,11:8,12:9,13:10,14:[1,11],15:[1,12],16:[1,13],19:[1,5],22:[1,14],23:[1,15],24:[1,16]},{1:[3]},{5:[1,17]},{5:[2,6],7:18,8:6,9:7,11:8,12:9,13:10,14:[1,11],15:[1,12],16:[1,13],19:[1,19],20:[2,6],22:[1,14],23:[1,15],24:[1,16]},{5:[2,5],6:20,8:21,9:7,11:8,12:9,13:10,14:[1,11],15:[1,12],16:[1,13],19:[1,5],20:[2,5],22:[1,14],23:[1,15],24:[1,16]},{17:23,18:[1,22],21:24,28:[1,25],35:[1,27],38:26},{5:[2,8],14:[2,8],15:[2,8],16:[2,8],19:[2,8],20:[2,8],22:[2,8],23:[2,8],24:[2,8]},{4:28,6:3,7:4,8:6,9:7,11:8,12:9,13:10,14:[1,11],15:[1,12],16:[1,13],19:[1,5],20:[2,7],22:[1,14],23:[1,15],24:[1,16]},{4:29,6:3,7:4,8:6,9:7,11:8,12:9,13:10,14:[1,11],15:[1,12],16:[1,13],19:[1,5],20:[2,7],22:[1,14],23:[1,15],24:[1,16]},{5:[2,12],14:[2,12],15:[2,12],16:[2,12],19:[2,12],20:[2,12],22:[2,12],23:[2,12],24:[2,12]},{5:[2,13],14:[2,13],15:[2,13],16:[2,13],19:[2,13],20:[2,13],22:[2,13],23:[2,13],24:[2,13]},{5:[2,14],14:[2,14],15:[2,14],16:[2,14],19:[2,14],20:[2,14],22:[2,14],23:[2,14],24:[2,14]},{5:[2,15],14:[2,15],15:[2,15],16:[2,15],19:[2,15],20:[2,15],22:[2,15],23:[2,15],24:[2,15]},{17:30,21:24,28:[1,25],35:[1,27],38:26},{17:31,21:24,28:[1,25],35:[1,27],38:26},{17:32,21:24,28:[1,25],35:[1,27],38:26},{25:33,37:[1,34]},{1:[2,1]},{5:[2,2],8:21,9:7,11:8,12:9,13:10,14:[1,11],15:[1,12],16:[1,13],19:[1,19],20:[2,2],22:[1,14],23:[1,15],24:[1,16]},{17:23,21:24,28:[1,25],35:[1,27],38:26},{5:[2,4],7:35,8:6,9:7,11:8,12:9,13:10,14:[1,11],15:[1,12],16:[1,13],19:[1,19],20:[2,4],22:[1,14],23:[1,15],24:[1,16]},{5:[2,9],14:[2,9],15:[2,9],16:[2,9],19:[2,9],20:[2,9],22:[2,9],23:[2,9],24:[2,9]},{5:[2,23],14:[2,23],15:[2,23],16:[2,23],19:[2,23],20:[2,23],22:[2,23],23:[2,23],24:[2,23]},{18:[1,36]},{18:[2,27],21:41,26:37,27:38,28:[1,45],29:39,30:[1,42],31:[1,43],32:[1,44],33:40,34:46,35:[1,47],38:26},{18:[2,28]},{18:[2,45],28:[2,45],30:[2,45],31:[2,45],32:[2,45],35:[2,45],39:[1,48]},{18:[2,47],28:[2,47],30:[2,47],31:[2,47],32:[2,47],35:[2,47],39:[2,47]},{10:49,20:[1,50]},{10:51,20:[1,50]},{18:[1,52]},{18:[1,53]},{18:[1,54]},{18:[1,55],21:56,35:[1,27],38:26},{18:[2,44],35:[2,44]},{5:[2,3],8:21,9:7,11:8,12:9,13:10,14:[1,11],15:[1,12],16:[1,13],19:[1,19],20:[2,3],22:[1,14],23:[1,15],24:[1,16]},{14:[2,17],15:[2,17],16:[2,17],19:[2,17],20:[2,17],22:[2,17],23:[2,17],24:[2,17]},{18:[2,25],21:41,27:57,28:[1,45],29:58,30:[1,42],31:[1,43],32:[1,44],33:40,34:46,35:[1,47],38:26},{18:[2,26]},{18:[2,30],28:[2,30],30:[2,30],31:[2,30],32:[2,30],35:[2,30]},{18:[2,36],34:59,35:[1,60]},{18:[2,31],28:[2,31],30:[2,31],31:[2,31],32:[2,31],35:[2,31]},{18:[2,32],28:[2,32],30:[2,32],31:[2,32],32:[2,32],35:[2,32]},{18:[2,33],28:[2,33],30:[2,33],31:[2,33],32:[2,33],35:[2,33]},{18:[2,34],28:[2,34],30:[2,34],31:[2,34],32:[2,34],35:[2,34]},{18:[2,35],28:[2,35],30:[2,35],31:[2,35],32:[2,35],35:[2,35]},{18:[2,38],35:[2,38]},{18:[2,47],28:[2,47],30:[2,47],31:[2,47],32:[2,47],35:[2,47],36:[1,61],39:[2,47]},{35:[1,62]},{5:[2,10],14:[2,10],15:[2,10],16:[2,10],19:[2,10],20:[2,10],22:[2,10],23:[2,10],24:[2,10]},{21:63,35:[1,27],38:26},{5:[2,11],14:[2,11],15:[2,11],16:[2,11],19:[2,11],20:[2,11],22:[2,11],23:[2,11],24:[2,11]},{14:[2,16],15:[2,16],16:[2,16],19:[2,16],20:[2,16],22:[2,16],23:[2,16],24:[2,16]},{5:[2,19],14:[2,19],15:[2,19],16:[2,19],19:[2,19],20:[2,19],22:[2,19],23:[2,19],24:[2,19]},{5:[2,20],14:[2,20],15:[2,20],16:[2,20],19:[2,20],20:[2,20],22:[2,20],23:[2,20],24:[2,20]},{5:[2,21],14:[2,21],15:[2,21],16:[2,21],19:[2,21],20:[2,21],22:[2,21],23:[2,21],24:[2,21]},{18:[1,64]},{18:[2,24]},{18:[2,29],28:[2,29],30:[2,29],31:[2,29],32:[2,29],35:[2,29]},{18:[2,37],35:[2,37]},{36:[1,61]},{21:65,28:[1,69],30:[1,66],31:[1,67],32:[1,68],35:[1,27],38:26},{18:[2,46],28:[2,46],30:[2,46],31:[2,46],32:[2,46],35:[2,46],39:[2,46]},{18:[1,70]},{5:[2,22],14:[2,22],15:[2,22],16:[2,22],19:[2,22],20:[2,22],22:[2,22],23:[2,22],24:[2,22]},{18:[2,39],35:[2,39]},{18:[2,40],35:[2,40]},{18:[2,41],35:[2,41]},{18:[2,42],35:[2,42]},{18:[2,43],35:[2,43]},{5:[2,18],14:[2,18],15:[2,18],16:[2,18],19:[2,18],20:[2,18],22:[2,18],23:[2,18],24:[2,18]}],defaultActions:{17:[2,1],25:[2,28],38:[2,26],57:[2,24]},parseError:function(e,t){throw new Error(e)},parse:function(e){function t(){var e;return e=i.lexer.lex()||1,"number"!=typeof e&&(e=i.symbols_[e]||e),e}var i=this,n=[0],s=[null],a=[],r=this.table,o="",l=0,c=0,d=0;this.lexer.setInput(e),this.lexer.yy=this.yy,this.yy.lexer=this.lexer,this.yy.parser=this,"undefined"==typeof this.lexer.yylloc&&(this.lexer.yylloc={});var u=this.lexer.yylloc;a.push(u);var h=this.lexer.options&&this.lexer.options.ranges;"function"==typeof this.yy.parseError&&(this.parseError=this.yy.parseError);for(var p,m,f,g,v,y,k,w,b,_={};;){if(f=n[n.length-1],this.defaultActions[f]?g=this.defaultActions[f]:((null===p||"undefined"==typeof p)&&(p=t()),g=r[f]&&r[f][p]),"undefined"==typeof g||!g.length||!g[0]){var T="";if(!d){b=[];for(y in r[f])this.terminals_[y]&&y>2&&b.push("'"+this.terminals_[y]+"'");T=this.lexer.showPosition?"Parse error on line "+(l+1)+":\n"+this.lexer.showPosition()+"\nExpecting "+b.join(", ")+", got '"+(this.terminals_[p]||p)+"'":"Parse error on line "+(l+1)+": Unexpected "+(1==p?"end of input":"'"+(this.terminals_[p]||p)+"'"),this.parseError(T,{text:this.lexer.match,token:this.terminals_[p]||p,line:this.lexer.yylineno,loc:u,expected:b})}}if(g[0]instanceof Array&&g.length>1)throw new Error("Parse Error: multiple actions possible at state: "+f+", token: "+p);switch(g[0]){case 1:n.push(p),s.push(this.lexer.yytext),a.push(this.lexer.yylloc),n.push(g[1]),p=null,m?(p=m,m=null):(c=this.lexer.yyleng,o=this.lexer.yytext,l=this.lexer.yylineno,u=this.lexer.yylloc,d>0&&d--);break;case 2:if(k=this.productions_[g[1]][1],_.$=s[s.length-k],_._$={first_line:a[a.length-(k||1)].first_line,last_line:a[a.length-1].last_line,first_column:a[a.length-(k||1)].first_column,last_column:a[a.length-1].last_column},h&&(_._$.range=[a[a.length-(k||1)].range[0],a[a.length-1].range[1]]),v=this.performAction.call(_,o,c,l,this.yy,g[1],s,a),"undefined"!=typeof v)return v;k&&(n=n.slice(0,-1*k*2),s=s.slice(0,-1*k),a=a.slice(0,-1*k)),n.push(this.productions_[g[1]][0]),s.push(_.$),a.push(_._$),w=r[n[n.length-2]][n[n.length-1]],n.push(w);break;case 3:return!0}}return!0}},i=function(){var e={EOF:1,parseError:function(e,t){if(!this.yy.parser)throw new Error(e);this.yy.parser.parseError(e,t)},setInput:function(e){return this._input=e,this._more=this._less=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var e=this._input[0];this.yytext+=e,this.yyleng++,this.offset++,this.match+=e,this.matched+=e;var t=e.match(/(?:\r\n?|\n).*/g);return t?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),e},unput:function(e){var t=e.length,i=e.split(/(?:\r\n?|\n)/g);this._input=e+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-t-1),this.offset-=t;var n=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),i.length-1&&(this.yylineno-=i.length-1);var s=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:i?(i.length===n.length?this.yylloc.first_column:0)+n[n.length-i.length].length-i[0].length:this.yylloc.first_column-t},this.options.ranges&&(this.yylloc.range=[s[0],s[0]+this.yyleng-t]),this},more:function(){return this._more=!0,this},less:function(e){this.unput(this.match.slice(e))},pastInput:function(){var e=this.matched.substr(0,this.matched.length-this.match.length);return(e.length>20?"...":"")+e.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var e=this.match;return e.length<20&&(e+=this._input.substr(0,20-e.length)),(e.substr(0,20)+(e.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var e=this.pastInput(),t=new Array(e.length+1).join("-");return e+this.upcomingInput()+"\n"+t+"^"},next:function(){if(this.done)return this.EOF;this._input||(this.done=!0);var e,t,i,n,s;this._more||(this.yytext="",this.match="");for(var a=this._currentRules(),r=0;r<a.length&&(i=this._input.match(this.rules[a[r]]),!i||t&&!(i[0].length>t[0].length)||(t=i,n=r,this.options.flex));r++);return t?(s=t[0].match(/(?:\r\n?|\n).*/g),s&&(this.yylineno+=s.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:s?s[s.length-1].length-s[s.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+t[0].length},this.yytext+=t[0],this.match+=t[0],this.matches=t,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._input=this._input.slice(t[0].length),this.matched+=t[0],e=this.performAction.call(this,this.yy,this,a[n],this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),e?e:void 0):""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var e=this.next();return"undefined"!=typeof e?e:this.lex()},begin:function(e){this.conditionStack.push(e)},popState:function(){return this.conditionStack.pop()},_currentRules:function(){return this.conditions[this.conditionStack[this.conditionStack.length-1]].rules},topState:function(){return this.conditionStack[this.conditionStack.length-2]},pushState:function(e){this.begin(e)}};return e.options={},e.performAction=function(e,t,i,n){switch(i){case 0:if("\\"!==t.yytext.slice(-1)&&this.begin("mu"),"\\"===t.yytext.slice(-1)&&(t.yytext=t.yytext.substr(0,t.yyleng-1),this.begin("emu")),t.yytext)return 14;break;case 1:return 14;case 2:return"\\"!==t.yytext.slice(-1)&&this.popState(),"\\"===t.yytext.slice(-1)&&(t.yytext=t.yytext.substr(0,t.yyleng-1)),14;case 3:return t.yytext=t.yytext.substr(0,t.yyleng-4),this.popState(),15;case 4:return this.begin("par"),24;case 5:return 16;case 6:return 20;case 7:return 19;case 8:return 19;case 9:return 23;case 10:return 23;case 11:this.popState(),this.begin("com");break;case 12:return t.yytext=t.yytext.substr(3,t.yyleng-5),this.popState(),15;case 13:return 22;case 14:return 36;case 15:return 35;case 16:return 35;case 17:return 39;case 18:break;case 19:return this.popState(),18;case 20:return this.popState(),18;case 21:return t.yytext=t.yytext.substr(1,t.yyleng-2).replace(/\\"/g,'"'),30;case 22:return t.yytext=t.yytext.substr(1,t.yyleng-2).replace(/\\'/g,"'"),30;case 23:return t.yytext=t.yytext.substr(1),28;case 24:return 32;case 25:return 32;case 26:return 31;case 27:return 35;case 28:return t.yytext=t.yytext.substr(1,t.yyleng-2),35;case 29:return"INVALID";case 30:break;case 31:return this.popState(),37;case 32:return 5}},e.rules=[/^(?:[^\x00]*?(?=(\{\{)))/,/^(?:[^\x00]+)/,/^(?:[^\x00]{2,}?(?=(\{\{|$)))/,/^(?:[\s\S]*?--\}\})/,/^(?:\{\{>)/,/^(?:\{\{#)/,/^(?:\{\{\/)/,/^(?:\{\{\^)/,/^(?:\{\{\s*else\b)/,/^(?:\{\{\{)/,/^(?:\{\{&)/,/^(?:\{\{!--)/,/^(?:\{\{![\s\S]*?\}\})/,/^(?:\{\{)/,/^(?:=)/,/^(?:\.(?=[} ]))/,/^(?:\.\.)/,/^(?:[\/.])/,/^(?:\s+)/,/^(?:\}\}\})/,/^(?:\}\})/,/^(?:"(\\["]|[^"])*")/,/^(?:'(\\[']|[^'])*')/,/^(?:@[a-zA-Z]+)/,/^(?:true(?=[}\s]))/,/^(?:false(?=[}\s]))/,/^(?:-?[0-9]+(?=[}\s]))/,/^(?:[a-zA-Z0-9_$-]+(?=[=}\s\/.]))/,/^(?:\[[^\]]*\])/,/^(?:.)/,/^(?:\s+)/,/^(?:[a-zA-Z0-9_$-\/]+)/,/^(?:$)/],e.conditions={mu:{rules:[4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,32],inclusive:!1},emu:{rules:[2],inclusive:!1},com:{rules:[3],inclusive:!1},par:{rules:[30,31],inclusive:!1},INITIAL:{rules:[0,1,32],inclusive:!0}},e}();return t.lexer=i,e.prototype=t,t.Parser=e,new e}();e.Parser=t,e.parse=function(t){return t.constructor===e.AST.ProgramNode?t:(e.Parser.yy=e.AST,e.Parser.parse(t))},function(){e.AST={},e.AST.ProgramNode=function(t,i){this.type="program",this.statements=t,i&&(this.inverse=new e.AST.ProgramNode(i))},e.AST.MustacheNode=function(e,t,i){this.type="mustache",this.escaped=!i,this.hash=t;var n=this.id=e[0],s=this.params=e.slice(1),a=this.eligibleHelper=n.isSimple;this.isHelper=a&&(s.length||t)},e.AST.PartialNode=function(e,t){this.type="partial",this.partialName=e,this.context=t},e.AST.BlockNode=function(t,i,n,s){var a=function(t,i){if(t.original!==i.original)throw new e.Exception(t.original+" doesn't match "+i.original)};a(t.id,s),this.type="block",this.mustache=t,this.program=i,this.inverse=n,this.inverse&&!this.program&&(this.isInverse=!0)},e.AST.ContentNode=function(e){this.type="content",this.string=e},e.AST.HashNode=function(e){this.type="hash",this.pairs=e},e.AST.IdNode=function(t){this.type="ID",this.original=t.join(".");for(var i=[],n=0,s=0,a=t.length;a>s;s++){var r=t[s];if(".."===r||"."===r||"this"===r){if(i.length>0)throw new e.Exception("Invalid path: "+this.original);".."===r?n++:this.isScoped=!0}else i.push(r)}this.parts=i,this.string=i.join("."),this.depth=n,this.isSimple=1===t.length&&!this.isScoped&&0===n,this.stringModeValue=this.string},e.AST.PartialNameNode=function(e){this.type="PARTIAL_NAME",this.name=e},e.AST.DataNode=function(e){this.type="DATA",this.id=e},e.AST.StringNode=function(e){this.type="STRING",this.string=e,this.stringModeValue=e},e.AST.IntegerNode=function(e){this.type="INTEGER",this.integer=e,this.stringModeValue=Number(e)},e.AST.BooleanNode=function(e){this.type="BOOLEAN",this.bool=e,this.stringModeValue="true"===e},e.AST.CommentNode=function(e){this.type="comment",this.comment=e}}();var i=["description","fileName","lineNumber","message","name","number","stack"];e.Exception=function(e){for(var t=Error.prototype.constructor.apply(this,arguments),n=0;n<i.length;n++)this[i[n]]=t[i[n]]},e.Exception.prototype=new Error,e.SafeString=function(e){this.string=e},e.SafeString.prototype.toString=function(){return this.string.toString()},function(){var t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},i=/[&<>"'`]/g,n=/[&<>"'`]/,s=function(e){return t[e]||"&amp;"};e.Utils={escapeExpression:function(t){return t instanceof e.SafeString?t.toString():null==t||t===!1?"":n.test(t)?t.replace(i,s):t},isEmpty:function(e){return e||0===e?"[object Array]"===Object.prototype.toString.call(e)&&0===e.length?!0:!1:!0}}}(),e.Compiler=function(){},e.JavaScriptCompiler=function(){},function(t,i){t.prototype={compiler:t,disassemble:function(){for(var e,t,i,n=this.opcodes,s=[],a=0,r=n.length;r>a;a++)if(e=n[a],"DECLARE"===e.opcode)s.push("DECLARE "+e.name+"="+e.value);else{t=[];for(var o=0;o<e.args.length;o++)i=e.args[o],"string"==typeof i&&(i='"'+i.replace("\n","\\n")+'"'),t.push(i);s.push(e.opcode+" "+t.join(" "))}return s.join("\n")},equals:function(e){var t=this.opcodes.length;if(e.opcodes.length!==t)return!1;for(var i=0;t>i;i++){var n=this.opcodes[i],s=e.opcodes[i];if(n.opcode!==s.opcode||n.args.length!==s.args.length)return!1;for(var a=0;a<n.args.length;a++)if(n.args[a]!==s.args[a])return!1}if(t=this.children.length,e.children.length!==t)return!1;for(i=0;t>i;i++)if(!this.children[i].equals(e.children[i]))return!1;return!0},guid:0,compile:function(e,t){this.children=[],this.depths={list:[]},this.options=t;var i=this.options.knownHelpers;if(this.options.knownHelpers={helperMissing:!0,blockHelperMissing:!0,each:!0,"if":!0,unless:!0,"with":!0,log:!0},i)for(var n in i)this.options.knownHelpers[n]=i[n];return this.program(e)},accept:function(e){return this[e.type](e)},program:function(e){var t,i=e.statements;this.opcodes=[];for(var n=0,s=i.length;s>n;n++)t=i[n],this[t.type](t);return this.isSimple=1===s,this.depths.list=this.depths.list.sort(function(e,t){return e-t}),this},compileProgram:function(e){var t,i=(new this.compiler).compile(e,this.options),n=this.guid++;this.usePartial=this.usePartial||i.usePartial,this.children[n]=i;for(var s=0,a=i.depths.list.length;a>s;s++)t=i.depths.list[s],2>t||this.addDepth(t-1);return n},block:function(e){var t=e.mustache,i=e.program,n=e.inverse;i&&(i=this.compileProgram(i)),n&&(n=this.compileProgram(n));var s=this.classifyMustache(t);"helper"===s?this.helperMustache(t,i,n):"simple"===s?(this.simpleMustache(t),this.opcode("pushProgram",i),this.opcode("pushProgram",n),this.opcode("emptyHash"),this.opcode("blockValue")):(this.ambiguousMustache(t,i,n),this.opcode("pushProgram",i),this.opcode("pushProgram",n),this.opcode("emptyHash"),this.opcode("ambiguousBlockValue")),this.opcode("append")},hash:function(e){var t,i,n=e.pairs;this.opcode("pushHash");for(var s=0,a=n.length;a>s;s++)t=n[s],i=t[1],this.options.stringParams?this.opcode("pushStringParam",i.stringModeValue,i.type):this.accept(i),this.opcode("assignToHash",t[0]);this.opcode("popHash")},partial:function(e){var t=e.partialName;this.usePartial=!0,e.context?this.ID(e.context):this.opcode("push","depth0"),this.opcode("invokePartial",t.name),this.opcode("append")},content:function(e){this.opcode("appendContent",e.string)},mustache:function(e){var t=this.options,i=this.classifyMustache(e);"simple"===i?this.simpleMustache(e):"helper"===i?this.helperMustache(e):this.ambiguousMustache(e),this.opcode(e.escaped&&!t.noEscape?"appendEscaped":"append")},ambiguousMustache:function(e,t,i){var n=e.id,s=n.parts[0],a=null!=t||null!=i;this.opcode("getContext",n.depth),this.opcode("pushProgram",t),this.opcode("pushProgram",i),this.opcode("invokeAmbiguous",s,a)},simpleMustache:function(e){var t=e.id;"DATA"===t.type?this.DATA(t):t.parts.length?this.ID(t):(this.addDepth(t.depth),this.opcode("getContext",t.depth),this.opcode("pushContext")),this.opcode("resolvePossibleLambda")},helperMustache:function(e,t,i){var n=this.setupFullMustacheParams(e,t,i),s=e.id.parts[0];if(this.options.knownHelpers[s])this.opcode("invokeKnownHelper",n.length,s);else{if(this.knownHelpersOnly)throw new Error("You specified knownHelpersOnly, but used the unknown helper "+s);this.opcode("invokeHelper",n.length,s)}},ID:function(e){this.addDepth(e.depth),this.opcode("getContext",e.depth);var t=e.parts[0];t?this.opcode("lookupOnContext",e.parts[0]):this.opcode("pushContext");for(var i=1,n=e.parts.length;n>i;i++)this.opcode("lookup",e.parts[i])},DATA:function(e){this.options.data=!0,this.opcode("lookupData",e.id)},STRING:function(e){this.opcode("pushString",e.string)},INTEGER:function(e){this.opcode("pushLiteral",e.integer)},BOOLEAN:function(e){this.opcode("pushLiteral",e.bool)},comment:function(){},opcode:function(e){this.opcodes.push({opcode:e,args:[].slice.call(arguments,1)})},declare:function(e,t){this.opcodes.push({opcode:"DECLARE",name:e,value:t})},addDepth:function(e){if(isNaN(e))throw new Error("EWOT");0!==e&&(this.depths[e]||(this.depths[e]=!0,this.depths.list.push(e)))},classifyMustache:function(e){var t=e.isHelper,i=e.eligibleHelper,n=this.options;if(i&&!t){var s=e.id.parts[0];n.knownHelpers[s]?t=!0:n.knownHelpersOnly&&(i=!1)}return t?"helper":i?"ambiguous":"simple"},pushParams:function(e){for(var t,i=e.length;i--;)t=e[i],this.options.stringParams?(t.depth&&this.addDepth(t.depth),this.opcode("getContext",t.depth||0),this.opcode("pushStringParam",t.stringModeValue,t.type)):this[t.type](t)},setupMustacheParams:function(e){var t=e.params;return this.pushParams(t),e.hash?this.hash(e.hash):this.opcode("emptyHash"),t},setupFullMustacheParams:function(e,t,i){var n=e.params;return this.pushParams(n),this.opcode("pushProgram",t),this.opcode("pushProgram",i),e.hash?this.hash(e.hash):this.opcode("emptyHash"),n}};var n=function(e){this.value=e};i.prototype={nameLookup:function(e,t){return/^[0-9]+$/.test(t)?e+"["+t+"]":i.isValidJavaScriptVariableName(t)?e+"."+t:e+"['"+t+"']"},appendToBuffer:function(e){return this.environment.isSimple?"return "+e+";":{appendToBuffer:!0,content:e,toString:function(){return"buffer += "+e+";"}}},initializeBuffer:function(){return this.quotedString("")},namespace:"Handlebars",compile:function(t,i,n,s){this.environment=t,this.options=i||{},e.log(e.logger.DEBUG,this.environment.disassemble()+"\n\n"),this.name=this.environment.name,this.isChild=!!n,this.context=n||{programs:[],environments:[],aliases:{}},this.preamble(),this.stackSlot=0,this.stackVars=[],this.registers={list:[]},this.compileStack=[],this.inlineStack=[],this.compileChildren(t,i);var a,r=t.opcodes;for(this.i=0,o=r.length;this.i<o;this.i++)a=r[this.i],"DECLARE"===a.opcode?this[a.name]=a.value:this[a.opcode].apply(this,a.args);return this.createFunctionContext(s)},nextOpcode:function(){var e=this.environment.opcodes;return e[this.i+1]},eat:function(){this.i=this.i+1},preamble:function(){var e=[];if(this.isChild)e.push("");else{var t=this.namespace,i="helpers = helpers || "+t+".helpers;";this.environment.usePartial&&(i=i+" partials = partials || "+t+".partials;"),this.options.data&&(i+=" data = data || {};"),e.push(i)}e.push(this.environment.isSimple?"":", buffer = "+this.initializeBuffer()),this.lastContext=0,this.source=e},createFunctionContext:function(t){var i=this.stackVars.concat(this.registers.list);if(i.length>0&&(this.source[1]=this.source[1]+", "+i.join(", ")),!this.isChild)for(var n in this.context.aliases)this.source[1]=this.source[1]+", "+n+"="+this.context.aliases[n];this.source[1]&&(this.source[1]="var "+this.source[1].substring(2)+";"),this.isChild||(this.source[1]+="\n"+this.context.programs.join("\n")+"\n"),this.environment.isSimple||this.source.push("return buffer;");for(var s=this.isChild?["depth0","data"]:["Handlebars","depth0","helpers","partials","data"],a=0,r=this.environment.depths.list.length;r>a;a++)s.push("depth"+this.environment.depths.list[a]);var o=this.mergeSource();if(!this.isChild){var l=e.COMPILER_REVISION,c=e.REVISION_CHANGES[l];o="this.compilerInfo = ["+l+",'"+c+"'];\n"+o}if(t)return s.push(o),Function.apply(this,s);var d="function "+(this.name||"")+"("+s.join(",")+") {\n  "+o+"}";return e.log(e.logger.DEBUG,d+"\n\n"),d},mergeSource:function(){for(var e,t="",i=0,n=this.source.length;n>i;i++){var s=this.source[i];s.appendToBuffer?e=e?e+"\n    + "+s.content:s.content:(e&&(t+="buffer += "+e+";\n  ",e=void 0),t+=s+"\n  ")}return t},blockValue:function(){this.context.aliases.blockHelperMissing="helpers.blockHelperMissing";var e=["depth0"];this.setupParams(0,e),this.replaceStack(function(t){return e.splice(1,0,t),"blockHelperMissing.call("+e.join(", ")+")"})},ambiguousBlockValue:function(){this.context.aliases.blockHelperMissing="helpers.blockHelperMissing";var e=["depth0"];this.setupParams(0,e);var t=this.topStack();e.splice(1,0,t),e[e.length-1]="options",this.source.push("if (!"+this.lastHelper+") { "+t+" = blockHelperMissing.call("+e.join(", ")+"); }")},appendContent:function(e){this.source.push(this.appendToBuffer(this.quotedString(e)))},append:function(){this.flushInline();var e=this.popStack();this.source.push("if("+e+" || "+e+" === 0) { "+this.appendToBuffer(e)+" }"),this.environment.isSimple&&this.source.push("else { "+this.appendToBuffer("''")+" }")},appendEscaped:function(){this.context.aliases.escapeExpression="this.escapeExpression",this.source.push(this.appendToBuffer("escapeExpression("+this.popStack()+")"))},getContext:function(e){this.lastContext!==e&&(this.lastContext=e)},lookupOnContext:function(e){this.push(this.nameLookup("depth"+this.lastContext,e,"context"))},pushContext:function(){this.pushStackLiteral("depth"+this.lastContext)},resolvePossibleLambda:function(){this.context.aliases.functionType='"function"',this.replaceStack(function(e){return"typeof "+e+" === functionType ? "+e+".apply(depth0) : "+e})},lookup:function(e){this.replaceStack(function(t){return t+" == null || "+t+" === false ? "+t+" : "+this.nameLookup(t,e,"context")})},lookupData:function(e){this.push(this.nameLookup("data",e,"data"))},pushStringParam:function(e,t){this.pushStackLiteral("depth"+this.lastContext),this.pushString(t),"string"==typeof e?this.pushString(e):this.pushStackLiteral(e)},emptyHash:function(){this.pushStackLiteral("{}"),this.options.stringParams&&this.register("hashTypes","{}")},pushHash:function(){this.hash={values:[],types:[]}},popHash:function(){var e=this.hash;this.hash=void 0,this.options.stringParams&&this.register("hashTypes","{"+e.types.join(",")+"}"),this.push("{\n    "+e.values.join(",\n    ")+"\n  }")},pushString:function(e){this.pushStackLiteral(this.quotedString(e))},push:function(e){return this.inlineStack.push(e),e},pushLiteral:function(e){this.pushStackLiteral(e)},pushProgram:function(e){this.pushStackLiteral(null!=e?this.programExpression(e):null)},invokeHelper:function(e,t){this.context.aliases.helperMissing="helpers.helperMissing";var i=this.lastHelper=this.setupHelper(e,t,!0);this.push(i.name),this.replaceStack(function(e){return e+" ? "+e+".call("+i.callParams+") : helperMissing.call("+i.helperMissingParams+")"})},invokeKnownHelper:function(e,t){var i=this.setupHelper(e,t);this.push(i.name+".call("+i.callParams+")")},invokeAmbiguous:function(e,t){this.context.aliases.functionType='"function"',this.pushStackLiteral("{}");var i=this.setupHelper(0,e,t),n=this.lastHelper=this.nameLookup("helpers",e,"helper"),s=this.nameLookup("depth"+this.lastContext,e,"context"),a=this.nextStack();this.source.push("if ("+a+" = "+n+") { "+a+" = "+a+".call("+i.callParams+"); }"),this.source.push("else { "+a+" = "+s+"; "+a+" = typeof "+a+" === functionType ? "+a+".apply(depth0) : "+a+"; }")},invokePartial:function(e){var t=[this.nameLookup("partials",e,"partial"),"'"+e+"'",this.popStack(),"helpers","partials"];this.options.data&&t.push("data"),this.context.aliases.self="this",this.push("self.invokePartial("+t.join(", ")+")")},assignToHash:function(e){var t,i=this.popStack();this.options.stringParams&&(t=this.popStack(),this.popStack());var n=this.hash;t&&n.types.push("'"+e+"': "+t),n.values.push("'"+e+"': ("+i+")")},compiler:i,compileChildren:function(e,t){for(var i,n,s=e.children,a=0,r=s.length;r>a;a++){i=s[a],n=new this.compiler;var o=this.matchExistingProgram(i);null==o?(this.context.programs.push(""),o=this.context.programs.length,i.index=o,i.name="program"+o,this.context.programs[o]=n.compile(i,t,this.context),this.context.environments[o]=i):(i.index=o,i.name="program"+o)}},matchExistingProgram:function(e){for(var t=0,i=this.context.environments.length;i>t;t++){var n=this.context.environments[t];if(n&&n.equals(e))return t}},programExpression:function(e){if(this.context.aliases.self="this",null==e)return"self.noop";for(var t,i=this.environment.children[e],n=i.depths.list,s=[i.index,i.name,"data"],a=0,r=n.length;r>a;a++)t=n[a],s.push(1===t?"depth0":"depth"+(t-1));return 0===n.length?"self.program("+s.join(", ")+")":(s.shift(),"self.programWithDepth("+s.join(", ")+")")},register:function(e,t){this.useRegister(e),this.source.push(e+" = "+t+";")},useRegister:function(e){this.registers[e]||(this.registers[e]=!0,this.registers.list.push(e))},pushStackLiteral:function(e){return this.push(new n(e))},pushStack:function(e){this.flushInline();var t=this.incrStack();return e&&this.source.push(t+" = "+e+";"),this.compileStack.push(t),t},replaceStack:function(e){var t,i="",s=this.isInline();if(s){var a=this.popStack(!0);if(a instanceof n)t=a.value;else{var r=this.stackSlot?this.topStackName():this.incrStack();i="("+this.push(r)+" = "+a+"),",t=this.topStack()}}else t=this.topStack();var o=e.call(this,t);return s?((this.inlineStack.length||this.compileStack.length)&&this.popStack(),this.push("("+i+o+")")):(/^stack/.test(t)||(t=this.nextStack()),this.source.push(t+" = ("+i+o+");")),t},nextStack:function(){return this.pushStack()},incrStack:function(){return this.stackSlot++,this.stackSlot>this.stackVars.length&&this.stackVars.push("stack"+this.stackSlot),this.topStackName()},topStackName:function(){return"stack"+this.stackSlot},flushInline:function(){var e=this.inlineStack;if(e.length){this.inlineStack=[];for(var t=0,i=e.length;i>t;t++){var s=e[t];s instanceof n?this.compileStack.push(s):this.pushStack(s)}}},isInline:function(){return this.inlineStack.length},popStack:function(e){var t=this.isInline(),i=(t?this.inlineStack:this.compileStack).pop();return!e&&i instanceof n?i.value:(t||this.stackSlot--,i)},topStack:function(e){var t=this.isInline()?this.inlineStack:this.compileStack,i=t[t.length-1];return!e&&i instanceof n?i.value:i},quotedString:function(e){return'"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"\\n").replace(/\r/g,"\\r")+'"'},setupHelper:function(e,t,i){var n=[];this.setupParams(e,n,i);var s=this.nameLookup("helpers",t,"helper");return{params:n,name:s,callParams:["depth0"].concat(n).join(", "),helperMissingParams:i&&["depth0",this.quotedString(t)].concat(n).join(", ")}},setupParams:function(e,t,i){var n,s,a,r=[],o=[],l=[];r.push("hash:"+this.popStack()),s=this.popStack(),a=this.popStack(),(a||s)&&(a||(this.context.aliases.self="this",a="self.noop"),s||(this.context.aliases.self="this",s="self.noop"),r.push("inverse:"+s),r.push("fn:"+a));for(var c=0;e>c;c++)n=this.popStack(),t.push(n),this.options.stringParams&&(l.push(this.popStack()),o.push(this.popStack()));return this.options.stringParams&&(r.push("contexts:["+o.join(",")+"]"),r.push("types:["+l.join(",")+"]"),r.push("hashTypes:hashTypes")),this.options.data&&r.push("data:data"),r="{"+r.join(",")+"}",i?(this.register("options",r),t.push("options")):t.push(r),t.join(", ")}};for(var s="break else new var case finally return void catch for switch while continue function this with default if throw delete in try do instanceof typeof abstract enum int short boolean export interface static byte extends long super char final native synchronized class float package throws const goto private transient debugger implements protected volatile double import public let yield".split(" "),a=i.RESERVED_WORDS={},r=0,o=s.length;o>r;r++)a[s[r]]=!0;i.isValidJavaScriptVariableName=function(e){return!i.RESERVED_WORDS[e]&&/^[a-zA-Z_$][0-9a-zA-Z_$]+$/.test(e)?!0:!1},e.precompile=function(n,s){if(!n||"string"!=typeof n&&n.constructor!==e.AST.ProgramNode)throw new e.Exception("You must pass a string or Handlebars AST to Handlebars.precompile. You passed "+n);s=s||{},"data"in s||(s.data=!0);var a=e.parse(n),r=(new t).compile(a,s);return(new i).compile(r,s)},e.compile=function(n,s){function a(){var a=e.parse(n),r=(new t).compile(a,s),o=(new i).compile(r,s,void 0,!0);return e.template(o)}if(!n||"string"!=typeof n&&n.constructor!==e.AST.ProgramNode)throw new e.Exception("You must pass a string or Handlebars AST to Handlebars.compile. You passed "+n);s=s||{},"data"in s||(s.data=!0);var r;return function(e,t){return r||(r=a()),r.call(this,e,t)}},e.VM={template:function(t){var i={escapeExpression:e.Utils.escapeExpression,invokePartial:e.VM.invokePartial,programs:[],program:function(t,i,n){var s=this.programs[t];return n?e.VM.program(i,n):s?s:s=this.programs[t]=e.VM.program(i)},programWithDepth:e.VM.programWithDepth,noop:e.VM.noop,compilerInfo:null};return function(n,s){s=s||{};var a=t.call(i,e,n,s.helpers,s.partials,s.data),r=i.compilerInfo||[],o=r[0]||1,l=e.COMPILER_REVISION;if(o!==l){if(l>o){var c=e.REVISION_CHANGES[l],d=e.REVISION_CHANGES[o];throw"Template was precompiled with an older version of Handlebars than the current runtime. Please update your precompiler to a newer version ("+c+") or downgrade your runtime to an older version ("+d+").";

}throw"Template was precompiled with a newer version of Handlebars than the current runtime. Please update your runtime to a newer version ("+r[1]+")."}return a}},programWithDepth:function(e,t,i){var n=Array.prototype.slice.call(arguments,2);return function(i,s){return s=s||{},e.apply(this,[i,s.data||t].concat(n))}},program:function(e,t){return function(i,n){return n=n||{},e(i,n.data||t)}},noop:function(){return""},invokePartial:function(t,i,n,s,a,r){var o={helpers:s,partials:a,data:r};if(void 0===t)throw new e.Exception("The partial "+i+" could not be found");if(t instanceof Function)return t(n,o);if(e.compile)return a[i]=e.compile(t,{data:void 0!==r}),a[i](n,o);throw new e.Exception("The partial "+i+" could not be compiled when running in runtime-only mode")}},e.template=e.VM.template}(e.Compiler,e.JavaScriptCompiler),define("Handlebars",[],function(){return e})}(),define("hbs",["Handlebars"],function(e){var t={},i=".hbs";return{load:function(n,s,a,r){var o=r.hbs&&r.hbs.templateExtension?r.hbs.templateExtension:i;if(r.isBuild){var l=nodeRequire("fs"),c=r.dirBaseUrl+"/"+n+o;t[n]=l.readFileSync(c).toString(),a()}else"object"==typeof chrome&&"object"==typeof chrome.extension&&(n=chrome.extension.getURL("/"==r.baseUrl[r.baseUrl.length-1]?r.baseUrl+n:r.baseUrl+"/"+n)),s(["text!"+n+o],function(t){a(e.compile(t))})},write:function(i,n,s){var a=e.precompile(t[n]);s("define('hbs!"+n+"', ['Handlebars'], function(Handlebars){ \nreturn Handlebars.template("+a.toString()+");\n});\n")}}}),define("hbs!template/pop-tip",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){return'\n    <a class="close line-right">&times;</a>\n    '}function r(e,t){var n,s="";return s+='\n    <a class="action line-right">\n        ',(n=i.actionText)?n=n.call(e,{hash:{},data:t}):(n=e.actionText,n=typeof n===c?n.apply(e):n),s+=d(n)+"\n    </a>\n    "}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var o,l="",c="function",d=this.escapeExpression,u=this;return l+='<div class="pop-tip tip-transition before-animation clearfix">\n    ',o=i["if"].call(t,t.closeAction,{hash:{},inverse:u.noop,fn:u.program(1,a,s),data:s}),(o||0===o)&&(l+=o),l+="\n    ",o=i["if"].call(t,t.actionText,{hash:{},inverse:u.noop,fn:u.program(3,r,s),data:s}),(o||0===o)&&(l+=o),l+='\n    <span class="text line-left">\n        ',(o=i.text)?o=o.call(t,{hash:{},data:s}):(o=t.text,o=typeof o===c?o.apply(t):o),l+=d(o)+"\n    </span>\n\n</div>\n\n"})}),define("view/tip",["require","exports","module","hbs!template/pop-tip"],function(e,t){t.View=Backbone.View.extend({className:"outer-tip",template:e("hbs!template/pop-tip"),events:{"click .action":"undoAction","click .close":"_closeAction"},initialize:function(e){this.initData(e),this.beforeRender(),this.render(),this.autoClose()},initData:function(e){e&&e.className&&(this.attachClass=e.className,e.className=null),_.extend(this,e)},render:function(){var e=this.template({text:this.text,actionText:this.action?this.actionText:!1,closeAction:this.closeAction?!0:!1});this.$el.html(e).appendTo($("body")).addClass(this.attachClass),this.setAnimation()},beforeRender:function(){this.hasOtherTip()&&($ot=$(".pop-tip"),$ot.addClass("fast-close-animation"),setTimeout(function(){$ot.parent().remove()},200))},hasOtherTip:function(){return $(".pop-tip").length?!0:!1},setAnimation:function(){var e=this;setTimeout(function(){e.$(".pop-tip").removeClass("before-animation")})},setCloseAnimation:function(){this.$(".pop-tip").addClass("before-animation")},autoClose:function(){var e=this;this.delayTime=this.delayTime||3e3,this.timer=setTimeout(function(){e.setCloseAnimation(),setTimeout(function(){e.onClose()},200)},this.delayTime)},undoAction:function(){this.action&&this.action(),this.onClose()},_closeAction:function(){this.closeAction&&this.closeAction(),this.onClose()},onClose:function(){_.isUndefined(this.timer)||clearTimeout(this.timer),this.remove()}})}),define("utils/condition",["require","exports","module","configs/dict"],function(e,t){var i=e("configs/dict");t.isClosedProject=function(e){return e&&e.get("closed")},t.isSubscribeCalendarTask=function(e){return e&&e.get("projectId")===i.smartProjectId.subscribe},t.isCalendarProject=function(e){return e===i.smartProjectId.subscribe},t.isToInbox=function(e){return 0===e.indexOf("inbox")}}),define("utils/dom",["require","exports","module","offline/storage","utils/log","utils/analytics","view/tip","utils/condition","configs/dict","utils/hash"],function(e,t){var i=e("offline/storage"),n=e("utils/log"),s=e("utils/analytics"),a=e("view/tip").View,r=e("utils/condition"),o=e("configs/dict"),l=e("utils/hash");t.highlightList=function(){var e="#"+l.getHash(),t=$("#project-list-view").find("li, .fake-li"),i="active";t.removeClass(i);for(var n,s=0,a=t.length;a>s;s++){var r=t.eq(s),o=r.find("> a").attr("href");if(o&&e.match(o)){n=r;break}}n&&n.addClass(i)},t.showStatus=function(e,t){new a({text:e,delayTime:t})},t.highlightDatesWhichHasTask=function(){_.each($(".k-dayswithcolor span"),function(e){-1!=_.indexOf(i.datesHasTask,$(e).attr("data-date"))?$(e).addClass("k-task"):$(e).removeClass("k-task")})},t.highlightDateHasTask=function(e,t){t&&$(".k-dayswithcolor span[data-date='"+t+"']").removeClass("k-task"),$(".k-dayswithcolor span[data-date='"+e+"']").addClass("k-task")},t.setFocusToCurrentProject=function(){var e=$("#project-list-view").find(".project.active").get(0);e?e.focus():$("#project_all").parent("li").addClass("active").focus()},t.hasUserSelection=function(e){var t;return window.getSelection?t=window.getSelection():document.selection&&(t=document.selection.createRange()),t},t.placeCaretAtEnd=function(e){try{e.focus()}catch(t){s.error("placeCaretAtEnd_error"),n.log(t)}if("undefined"!=typeof window.getSelection&&"undefined"!=typeof document.createRange){var i=document.createRange();i.selectNodeContents(e.childNodes[0]?e.childNodes[0]:e),i.collapse(!1);var a=window.getSelection();a.removeAllRanges(),a.addRange(i)}else if("undefined"!=typeof document.body.createTextRange){var r=document.body.createTextRange();r.moveToElementText(e),r.collapse(!1),r.select()}},t.placeCaretAt=function(e,t){try{e.focus()}catch(i){s.error("placeCaretAt_error"),n.log(i)}if("undefined"!=typeof document.body.createTextRange){var a=document.body.createTextRange();a.moveToElementText(e),a.moveStart("character",t),a.collapse(!0),a.select()}else if("undefined"!=typeof window.getSelection&&"undefined"!=typeof document.createRange){var r=document.createRange();e.childNodes[0]&&r.selectNodeContents(e.childNodes[0]),e.childNodes[0]&&r.END_TO_END>t&&r.setStart(e.childNodes[0],t),r.collapse(!0);var o=window.getSelection();o.removeAllRanges(),o.addRange(r)}},t.getCaretPosition=function(e){var t,i,n=0;if(window.getSelection)t=window.getSelection(),t.rangeCount&&(i=t.getRangeAt(0),(i.commonAncestorContainer.parentNode==e||i.commonAncestorContainer==e)&&(n=i.endOffset));else if(document.selection&&document.selection.createRange&&(i=document.selection.createRange(),i.parentElement()==e)){var s=document.createElement("span");e.insertBefore(s,e.firstChild);var a=i.duplicate();a.moveToElementText(s),a.setEndPoint("EndToEnd",i),n=a.text.length}return n},t.getCaretCharacterOffsetWithin=function(e){var t,i=0,n=e.ownerDocument||e.document,s=n.defaultView||n.parentWindow;if("undefined"!=typeof s.getSelection){if(t=s.getSelection(),t.rangeCount>0){var a=s.getSelection().getRangeAt(0),r=a.cloneRange();r.selectNodeContents(e),r.setEnd(a.endContainer,a.endOffset),i=r.toString().length}}else if((t=n.selection)&&"Control"!=t.type){var o=t.createRange(),l=n.body.createTextRange();l.moveToElementText(e),l.setEndPoint("EndToEnd",o),i=l.text.length}return i},t.setCharacterOffset=function(e,i){for(var n=window.getSelection(),s=n.getRangeAt(0),a=e.childNodes,r=e,o=0,l=a.length;l>o;o++){var c=a[o].textContent.length;if(!(i>c)){r=a[o];break}i-=c}r=3==r.nodeType?r:r.childNodes[0],t.trySetPosition(r,i,s),s.collapse(!0),n.removeAllRanges(),n.addRange(s)},t.trySetPosition=function(e,i,n){if(!(0>i))try{n.setStart(e,i)}catch(s){i--,t.trySetPosition(e,i,n)}},t.setCaretPosition=function(e,t){var i=document.createRange(),n=window.getSelection();e.childNodes&&e.childNodes[0]?i.setStart(e.childNodes[0],t):i.setStart(e,t),i.collapse(!0),n.removeAllRanges(),n.addRange(i),e.focus&&e.focus()},t.getInputCaretPosition=function(e){var t=0;if(document.selection){e.focus();var i=document.selection.createRange();i.moveStart("character",-e.value.length),t=i.text.length}else(e.selectionStart||"0"==e.selectionStart)&&(t=e.selectionStart);return t},t.setInputCaretPosition=function(e,t){if(e.setSelectionRange)e.focus(),e.setSelectionRange(t,t);else if(e.createTextRange){var i=e.createTextRange();i.collapse(!0),i.moveEnd("character",t),i.moveStart("character",t),i.select()}},t.selected_tasks=function(){var e=$("#task-ul-list ul > li.addClassDrag.selected, #task-ul-list ul ~ li.addClassDrag.selected").not(".ui-sortable-placeholder");return e=e.length>0?$("#task-ul-list ul > li.selected, #task-ul-list ul ~ li.selected").not(".ui-sortable-placeholder"):$("#task-ul-list ul > li.addClassDrag, #task-ul-list ul ~ li.addClassDrag").not(".ui-sortable-placeholder")},t.showPlaceholder=function(e){e.removeClass("hide")},t.hidePlaceholder=function(e){e.addClass("hide")},t.hideClearTrashBtn=function(e){$("#clearTrash").removeClass("on")},t.resetOrderValue=function(e){$("#task-ul-list li.task").each(function(t){$(this).attr("order",t*e)})},t.changeSortOrder=function(e,t,i,n){var s=$(e),a=i.item.index(),r=[],o=t,l=0,c=!1;if(0==a)l=Number(i.item.next().attr("order"))-n;else if(a==s.length-1)l=Number(i.item.prev().attr("order"))+n;else{var d=Number(i.item.next().attr("order"))-Number(i.item.prev().attr("order"));1==d?c=!0:l=(Number(i.item.next().attr("order"))+Number(i.item.prev().attr("order")))/2}return c?s.each(function(e){var t=e*n;$(this).attr("order",t),r.push({id:$(this).find("a").attr("taskid"),order:t})}):(i.item.attr("order",l),r.push({id:o,order:l})),{postValue:r,newOrderVal:l}},t.repeatTip=function(e){var t=$("#repeat-tip");t.html(e).stop().show().animate({top:11},300),setTimeout(function(){t.stop().animate({top:-20},300).hide()},3e3)},t.existAdvanceRepeatView=function(){return $("#js-repeat-advance").length},t.isDateGroupSort=function(){return $("#task-list-view .task-sortable-by-date").length},t.selectedTasksNotDrag=function(){return $("#task-ul-list ul>li.selected")},t.extraTag=function(e,t,i){i=i||"li",e=e||0,t=t||"extra-tag";var n=document.createElement(i);return n.className=["extra-row",t].join(" "),n.style.height=e+"px",n},t.showRefresh=function(){$(".indicator").addClass("ing")},t.hideRefresh=function(){var e=$(".indicator");e.hasClass("ing")&&(e.addClass("completed"),setTimeout(function(){e.hide().removeClass("ing completed"),setTimeout(function(){e.show()},600)},500))},t.setProjectMenuTop=function(e,t){$(".dropdown.open").not(e).removeClass("open"),e.parent(".dropdown").toggleClass("open");var i=window.innerHeight,n=e.offset().top,s=t.find("ul").height(),a=0;i-n-s>20?a=n+20:(a=n-10,t.addClass("dropup")),t.css({top:a})},t.switchIcon=function(e,t,i){var n=!1,s=!1,a=!1;t?0!=t.get("status")?n=!0:0!=t.get("items").length?s=!0:r.isSubscribeCalendarTask(t)&&(a=!0):i&&(n=!0),e.toggleClass("checked",n).toggleClass("subtask",s).toggleClass("subcalendar",a);var l=!1,c=!1,d=!1;t&&(t.get("priority")==o.priorityValue.low?l=!0:t.get("priority")==o.priorityValue.medium?c=!0:t.get("priority")==o.priorityValue.high&&(d=!0),e.toggleClass("priority-low",l).toggleClass("priority-medium",c).toggleClass("priority-high",d))},t.setProjectColor=function(e,t,i){t=t||"4px",i=i||"transparent";var n="inset "+t+" 0 0 "+i;e.css("box-shadow",n)},t.initScrollbar=function(e){e.antiscroll()},t.adjustPositionTop=function(e){var t=window.innerHeight,i=e.outerHeight(),n=e.position().top,s=e.offset().top,a=t-s-i;0>a&&e.css("top",a+n)},t.adjustDetailHeight=function(e){for(var t=$("#td-container").children(),i=(t.first(),0),n=1;n<t.length;n++)i+=t.eq(n).outerHeight();var s=$("#content-view").height()-$("#td-caption").outerHeight()-i;s=0>s?"auto":s;var a=$("#taskcontent .editor-with-link"),r=$("#sub-task-list");e?(a.animate({"min-height":s},e),r.animate({"min-height":s},e)):(a.css("min-height",s),r.css("min-height",s))},t.showMobileDetail=function(){window.innerWidth<=o.screenSize.mobile&&$("body").addClass("detail-show")}}),define("rewrite/jquery_rewrite",["require","exports","module","utils/dom","utils/hash","utils/analytics","utils/log","lang/index","configs/settings"],function(e,t){var i=e("utils/dom"),n=e("utils/hash"),s=e("utils/analytics"),a=e("utils/log"),r=e("lang/index"),o=e("configs/settings");$.ajaxSetup({cache:!1,timeout:12e4,statusCode:{401:function(e,t,s){i.showStatus("Redirect to sign in...",1e4),setTimeout(function(){n.redirectToSignon()},5e3)},500:function(e,t,n){try{var l=$.parseJSON(e.responseText);switch(l.errorCode){case"need_subscribe":i.showStatus("Nonactivated account, please pay and activate your account.");break;case"calendar_feeds_code_not_exist":break;case"user_email_not_verified":break;case"username_not_set":break;case"get_avatar":break;case"calendar_fetch":break;case"username_password_not_match":break;case"app_runtime":break;case"exceed_max_share_limit":break;case"exceed_pro_max_share_limit":break;case"no_project_permission":i.showStatus(r.get("no_project_permission"));break;default:var c=r.get("error_unknow_server");o.user.isDS&&(c=l.errorMessage),i.showStatus(c)}}catch(d){s.error("not_get_reminder_data"),a.log("failed to get reminder data :(")}}},error:function(e,t,n){if(0===e.status)return void i.showStatus(r.get("error_network_connection"),5e3);switch(t){case"timeout":i.showStatus("network timeout");break;case"abort":break;case"parsererror":i.showStatus("unknown network error");break;default:status.refresh||i.showStatus("connection error")}},complete:function(){Backbone.trigger("updateCounts"),Backbone.trigger("toggleSmartProject"),Backbone.trigger("updateProjectGroupTasksCount")}}),$.fn.modal.Constructor.prototype.enforceFocus=function(){},$.fn.modal.Constructor.prototype.hideWithTransition=function(){var e=this,t=setTimeout(function(){e.$element.off($.support.transition.end),e.hideModal()},0);this.$element.one($.support.transition.end,function(){clearTimeout(t),e.hideModal()})},$.fn.exists=function(){return this.length>0},jQuery.fn.extend({swap:function(e){var t,i,n,s,a,r,o,l,c,d,u=[].indexOf||function(e){for(var t=0,i=this.length;i>t;t++)if(t in this&&this[t]===e)return t;return-1};if(o=function(e,t){return t>e?e:t},n=["INPUT","TEXTAREA"],this.is(document.activeElement))switch(!1){case c=this.prop("tagName"),u.call(n,c)<0:t=this.get(0),null!=t.selectionStart?(l=o(t.selectionStart,e.length),i=o(t.selectionEnd,e.length),this.val(e),t.selectionStart=l,t.selectionEnd=i):this.val(e);break;case"true"!==this.prop("contenteditable"):null!=document.createRange&&null!=window.getSelection?(r=window.getSelection(),r.rangeCount>0?(a=r.getRangeAt(0),l=o(a.startOffset,e.length),i=o(a.endOffset,e.length),r.removeAllRanges(),this.text(e),t=this.get(0),s=document.createRange(),t.firstChild?s.setStart(t.firstChild,l):s.setStart(t,l),t.firstChild?s.setEnd(t.firstChild,i):s.setEnd(t,i),r.addRange(s)):this.text(e)):this.text(e);break;default:this.text(e)}else d=this.prop("tagName"),u.call(n,d)>=0?this.val(e):this.text(e);return this}})}),define("rewrite/index",["require","exports","module","rewrite/backbone_rewrite","rewrite/string_rewrite","rewrite/jquery_rewrite"],function(e,t){e("rewrite/backbone_rewrite"),e("rewrite/string_rewrite"),e("rewrite/jquery_rewrite")}),define("utils/http",["require","exports","module","configs/settings","utils/log"],function(e,t){var i=e("configs/settings"),n=(e("utils/log"),{getError:function(e){var t={};return _.isFunction(e)&&(t={error:function(t){e(t)}}),t}});return n=_.extend({_get:function(e,t,i,n,s){n=_.extend(this.getError(i),n),$.ajax(_.extend({type:"GET",url:e,async:s?!1:!0,contentType:"application/json",success:function(e){_.isFunction(t)&&t(e)}},n||{}))},_put:function(e,t,i,n,s){s=_.extend(this.getError(n),s),$.ajax(_.extend({type:"PUT",url:e,contentType:"application/json",data:t,success:function(e){_.isFunction(i)&&i(e)}},s||{}))},_del:function(e,t,i,n,s){s=_.extend(this.getError(n),s),$.ajax(_.extend({type:"DELETE",url:e,contentType:"application/json",data:JSON.stringify(t),success:function(e){_.isFunction(i)&&i(e)}},s||{}))},_post:function(e,t,i,n,s){s=_.extend(this.getError(n),s),$.ajax(_.extend({type:"POST",url:e,contentType:"application/json",data:t,success:function(e){_.isFunction(i)&&i(e)}},s||{}))}},n),{get_v1_sync:function(e,t,s,a){n._get(i.API_HOST_V1+e,t,s,a,!0)},get_v1:function(e,t,s,a){n._get(i.API_HOST_V1+e,t,s,a)},put_v1:function(e,t,s,a,r){n._put(i.API_HOST_V1+e,t,s,a,r)},del_v1:function(e,t,s,a,r){n._del(i.API_HOST_V1+e,t,s,a,r)},post_v1:function(e,t,s,a,r){n._post(i.API_HOST_V1+e,t,s,a,r)},get_sync:function(e,t,s,a){n._get(i.API_HOST_V2+e,t,s,a,!0)},get:function(e,t,s,a){n._get(i.API_HOST_V2+e,t,s,a)},put:function(e,t,s,a,r){n._put(i.API_HOST_V2+e,t,s,a,r)},del:function(e,t,s,a,r){n._del(i.API_HOST_V2+e,t,s,a,r)},post:function(e,t,s,a,r){n._post(i.API_HOST_V2+e,t,s,a,r)},pub_post:function(e,t,s,a,r){n._post(i.API_HOST_V2_PUB+e,t,s,a,r)},get_v3_sync:function(e,t,s,a){n._get(i.API_HOST_V3+e,t,s,a,!0)},get_v3:function(e,t,s,a){n._get(i.API_HOST_V3+e,t,s,a)},put_v3:function(e,t,s,a,r){n._put(i.API_HOST_V3+e,t,s,a,r)},del_v3:function(e,t,s,a,r){n._del(i.API_HOST_V3+e,t,s,a,r)},post_v3:function(e,t,s,a,r){n._post(i.API_HOST_V3+e,t,s,a,r)}}}),define("utils/server",["require","exports","module","utils/http","utils/timeformat","utils/log","service/userProfile"],function(e,t,i){var n=e("utils/http"),s=e("utils/timeformat"),a=e("utils/log"),r=e("service/userProfile");return{http:n,getShareMoreCount:function(e,t,i){n.get("/project/"+e+"/share/check-quota",t,i)},getCalendarFeeds:function(e,t){n.get("/calendar/feeds/code",e,t)},getProjectShareUsers:function(e,t,i){var s="/project/"+e+"/shares";n.get(s,t,i)},checkVerifyEmail:function(e,t){n.get("/user/isVerified",e,t)},getMailCode:function(e,t){n.get("/settings/mail/task/code",e,t)},getRanking:function(e,t){n.get("/user/ranking",e,t)},getNotificationCount:function(e,t){n.get("/notification/count",e,t,{statusCode:{500:function(){a.log("Failed:: git notification count")}}})},getReminder:function(e,t){n.get("/reminder",e,t,{statusCode:{500:function(){a.log("Failed: get reminder")}}})},getAvatar:function(e,t){n.get("/avatar/getUrl",e,t)},getPhoto:function(e,t,i){var s="/avatar/getUrlByEmail?email="+e;n.get(s,t,i)},getPlugin:function(e){n.get_sync("/user/preferences/pluginSettings",e)},getCalendarSubscribe:function(e,t){n.get("/calendar/subscription",e,t)},getShareContacts:function(e){n.get("/share/shareContacts",e)},getSubscribeEvent:function(e,t){var i="/calendar/subscribe/events"+(t?"/"+t:"");n.get(i,e)},getUserStatus:function(e,t){n.get_sync("/user/status",e,t)},suggestcn:function(e,t){n.get("/user/sign/suggestcn",e,t)},getCompletedTasksShowInAll:function(e,t,i,s,a){var r="/project/all/completedInAll/?from="+t.fd+"&to="+t.td+"&limit="+i;n.get(r,s,a)},filterCompletedAndArchivedTasks:function(e,t,i,s,a){var r="/project/"+e+"/completed/?from="+t.fd+"&to="+t.td+"&limit="+i;n.get(r,s,a)},getTrashTasksByPagination:function(e,t,i,s){var a="/project/all/trash/pagination?start="+e+"&limit="+t;n.get(a,i,s)},getTasksByRangeDueDate:function(e,t,i){n.get("/date/"+e+"/to/"+t+"/tasks?timezone=",i)},getTasks:function(e,t,i,s){var a="/task/"+e+"?projectId="+t;n.get(a,i,s)},getInboxTasks:function(e,t){var i="/project/"+r.get("inboxId")+"/tasks";n.get(i,e,t)},getAllTodoTasks:function(e,t){n.get("/project/all/tasks",e,t)},getTodayAndOverdueTasks:function(e,t){n.get("/project/all/tasks",e,t)},getWeekAndOverdueTasks:function(e,t){n.get("/project/all/tasks",e,t)},getTodoTasksByProjectId:function(e,t,i){var s="/project/"+e+"/tasks";n.get(s,t,i)},getTasksByDate:function(e,t,i){var a="/date/"+e+"/tasks?timeZone="+s.prefMoment().format("ZZ").replace("+","");n.get(a,t,i)},getUserStatus:function(e,t){n.get_sync("/user/status",e,t)},getSubscribeStatus:function(e,t){n.get("/subscribe/status",e,t)},getVersionTask:function(e,t,i){var s="/version/task/"+e.projectId+"/"+e.modelId;n.get(s,t,i)},search:function(e,t,i){n.get("/search/task"+e,t,i)},downloadBackup:function(e,t){n.get("/data/export",e,t)},getTaskOrderByDate:function(e,t,i,s){n.get("/task/order-by-date/"+e+"?projectId="+t,i,s)},getGroupsByProjectId:function(e,t,i){n.get("/project/"+e+"/group",t,i)},getUserRegistered:function(e,t){n.get("/user/isJustRegistered",e,t)},resetMailCode:function(e,t){n.post("/settings/mail/task/code/new",void 0,e,t)},remindOwnerUpgrade:function(e,t){var i="/project/"+e+"/reminderToPay";n.post(i,null,t)},postTaskOrderByProject:function(e,t,i,s){n.post("/task/order-by-project/"+e,t,i,s)},postTaskOrderByDate:function(e,t,i,s,a){n.post("/task/order-by-date/"+e+"?projectId="+t,i,s,a)},makeCalendarFeeds:function(e,t){n.post("/calendar/feeds/code/new",{},e,t)},postTaskShare:function(e,t){n.post("/task/share",e,t)},postProjectShare:function(e,t,i,s){var a="/project/"+e+"/share";n.post(a,t,i,s)},verifyEmail:function(e,t){n.post("/user/resentVerifyEmail",{},e,t)},setPluginSetting:function(e,t){n.post("/user/preferences/pluginSettings",e,t)},postCalendarSubscribe:function(e,t,i){n.post("/calendar/subscribe",e,t,i)},uploadFile:function(e,t,i,n){var s=new FormData;s.append("file",e,e.name);var r=new XMLHttpRequest;r.open("POST",t),r.send(s),r.onreadystatechange=function(){if(4===r.readyState)if(200===r.status){var e=null;try{e=JSON.parse(r.responseText)}catch(t){a.log("uploadFile",e)}i&&i(e)}else n&&n()}},postUserAvatar:function(e,t){var i=new XMLHttpRequest;i.open("POST","/api/v1/avatar"),i.send(e),i.onreadystatechange=function(){4===i.readyState&&200===i.status&&t&&t()}},batchTasksMoveToProject:function(e,t,i){n.post("/task/moveProject",e,t,i)},taskMoveToProject:function(e,t,i){n.post("/task/moveProject",e,t,i)},changePassword:function(e,t,i){n.post("/user/changePassword",e,t,i,{dataType:"json"})},assign:function(e,t,i){n.post("/task/assign",e,t,i)},resetOrder:function(e,t,i){n.post("/project/"+e+"/order/reset",t,i)},share:function(e,t,i){var s="/"+e.entityType+"/"+e.entityId+"/share/accept/"+e.modelId+"?actionStatus="+e.actionStatus,a={actionStatus:e.actionStatus};n.post(s,a,t,i)},restoreTrash:function(e,t,i,s,a){var r=i?"/trash/restore/"+e+"?keepOrder=true":"/trash/restore/"+e;n.post(r,t,s,a)},markRead:function(e,t,i){var s="/notification/markRead";n.post(s,e,t,i)},changeGroupAttr:function(e,t,i,s){n.put("/project/"+e+"/group",t,i,s)},changeEmail:function(e,t,i){var s="/user/profile/email";n.put(s,e,t,i)},saveEmail:function(e,t,i){n.put("/user/profile/fakedUsername",e,t,i)},muteNotification:function(e,t,i){n.put("/notification/mute",e,t,i)},archiveCompletedTasks:function(e,t,i){var s="/task/archive/"+e;n.put(s,{},t,i)},batchUpdateMutiTasks:function(e,t,i){n.put("/task",e,t,i)},updateUsername:function(e,t,i){n.put("/user/profile/name",e,t,i)},sortProject:function(){var e,t,i;1===arguments.length?(e="",t=arguments[0]):(e=arguments[0],t=arguments[1]),arguments.length>=3&&"function"==typeof arguments[2]&&(i=arguments[2]),e=e?"/"+e:"";var s="/project"+e+"/order";n.put(s,t)},disableCalendarFeeds:function(e,t){n.del("/calendar/feeds/cancel",void 0,e,t)},stopProjectShare:function(e,t,i,s){var a="/project/"+e+"/share/"+t;n.del(a,null,i,s)},stopTaskShare:function(e,t,i,s){var a="/task/share/"+e+"/"+t;n.del(a,null,i,s)},deleteAccount:function(e,t,i){n.del("/user/deleteAccount",e,t,i)},deleteThirdSiteAccount:function(e,t){n.del("/user/deleteThirdSiteAccount",null,e,t)},deleteCalendarSubscribe:function(e,t){n.del("/calendar/unsubscribe/"+e,null,t)},clearTrashTasks:function(e,t){n.del("/trash/empty",{},e,t)},deleteTask:function(e,t,i,s){var a="/task"+e;n.del(a,t,i,s)},deleteMutiTasks:function(e,t,i){n.del("/task",e,t,i)},deleteMutiTasksForever:function(e,t,i){n.del("/task?deleteforever=true",e,t,i)},deleteTaskForever:function(e,t,i){n.del("/task?deleteforever=true",e,t,i)},deleteAccount:function(e,t,i){n.del("/user/deleteAccount",e,t,i)},getProjectActivity:function(e,t,i){var s="/project/"+e+"/activity";n.get_v1(s,t,i)},getTaskActivity:function(e,t,i){var s="/project/"+e.projectId+"/task/"+e.taskId+"/activity";n.get_v1(s,t,i)},getAttachmentIsUnderQuota:function(e,t){n.get_v1("/attachment/isUnderQuota",e,t)},deleteAttachment:function(e,t,i){n.del_v1("/attachment/"+e,null,t,i)},getWechatUserinfo:function(e,t){n.get_v1("/wechat/userInfo",e,t)},getWechatQrcode:function(e,t){n.get_v1("/wechat/qrcode-url",e,t)},getWechatStatus:function(e,t,i){n.get_v1("/wechat/scan/update",e,t)},redeem:function(e,t,i){var s="/giftcard/apply/"+e;n.post_v1(s,"",t,i)},deleteWechatBind:function(e,t,i){n.del("/user/unbinding?siteId=5",null,t,i)},getBindings:function(e,t){n.get("/user/userBindingInfo",e,t)},deleteBindings:function(e,t,i){n.del("/user/unbinding?siteId="+e,null,t,i)},dataSync:function(e,t,i){n.get("/batch/check/"+e,t,i)},postInviteProjectCollaboration:function(e,t,i){var e=e;n.post("/project/"+e+"/collaboration/invite",null,t,i)},getInviteProjectCollaboration:function(e,t,i){var e=e;n.get("/project/"+e+"/collaboration/invite-url",t,i)},deleteInviteProjectCollaboration:function(e,t,i){var e=e;n.del("/project/"+e+"/collaboration/invite",null,t,i)},acceptInviteProjectCollaboration:function(e,t,i){var e=e;n.put("/project/collaboration/accept?notificationId="+e,null,t,i)},refuseInviteProjectCollaboration:function(e,t,i){var e=e;n.put("/project/collaboration/refuse?notificationId="+e,null,t,i)},getPublicProfile:function(e,t,i){n.pub_post("/userPublicProfiles",e,t,i)},getProjectGroups:function(e,t){n.get("/projectGroups",e,t)},getExploreTasks:function(e,t){n.get_v3("/explore/subscriptions",e,t)},delSubscribeEvent:function(e,t,i){n.del_v3("/explore/subscriptions/"+e+"/unsubscribe",t,i)}}}),define("model/preferences",["require","exports","module","configs/settings","offline/storage","configs/dict","utils/timeformat","lang/index"],function(e,t){var i=e("configs/settings"),n=e("offline/storage"),s=e("configs/dict"),a=e("utils/timeformat"),r=e("lang/index");t.Model=Backbone.Model.extend({url:function(){return i.API_HOST+"/user/preferences/settings"},defaults:{showMeridiem:!1,startDayOfWeek:"SUN",theme:"classic",smartDateParsing:"show"},messages:function(){this.on("sync",this.updateSettings)},checkTimezone:function(){this.has("timeZone")||this.set("timeZone",jstz.determine().name())},checkStartDayOfWeek:function(){this.get("startDayOfWeek")||this.set("startDayOfWeek","SUN")},getWeekStartDay:function(){switch(this.get("startDayOfWeek")){case"SUN":return 0;case"MON":return 1;case"SAT":return 6;default:return 0}},initialize:function(){this.messages()},setMeridiem:function(){if(!this.has("showMeridiem")){var e=new Date,t=e.toLocaleTimeString().split(" ")[1];(!t||"AM"!==t&&"PM"!==t)&&this.set("showMeridiem",!1),this.set("showMeridiem",!0)}},getsortTypeOfInbox:function(){return this.get("sortTypeOfInbox")?this.get("sortTypeOfInbox"):s.sortType.dueDate},setSortTypeOfInbox:function(e){this.get("sortTypeOfInbox")!==e&&(this.set("sortTypeOfInbox",e),this.save())},getSortTypeOfAssignedMe:function(){return this.get("sortTypeOfAssignMe")?this.get("sortTypeOfAssignMe"):s.sortType.project},setSortTypeOfAssignedMe:function(e){this.get("sortTypeOfAssignMe")!==e&&(this.set("sortTypeOfAssignMe",e),this.save())},getSortTypeOfToday:function(){return this.get("sortTypeOfToday")?this.get("sortTypeOfToday"):s.sortType.dueDate},setSortTypeOfToday:function(e){this.get("sortTypeOfToday")!==e&&(this.set("sortTypeOfToday",e),this.save())},getSortTypeOfWeek:function(){return this.get("sortTypeOfWeek")?this.get("sortTypeOfWeek"):s.sortType.dueDate},setSortTypeOfWeek:function(e){this.get("sortTypeOfWeek")!==e&&(this.set("sortTypeOfWeek",e),this.save())},getSortTypeOfAllProject:function(){return this.get("sortTypeOfAllProject")===s.sortType.assignee?"dueDate":this.get("sortTypeOfAllProject")?this.get("sortTypeOfAllProject"):s.sortType.dueDate},setSortTypeOfAllProject:function(e){this.get("sortTypeOfAllProject")!==e&&(this.set("sortTypeOfAllProject",e),this.save())},setDailyRemindTime:function(e){_.isEmpty(e)?this.set("dailyRemindTime","-1"):this.set("dailyRemindTime",this.getUTCHour(e))},setSmartDateParsing:function(e){_.isEmpty(e)?this.set("smartDateParsing","-1"):this.set("smartDateParsing",e)},updateSettings:function(){n.setStoreInfo(s.cachePath.preferences,JSON.stringify(this.toJSON())),this.checkStartDayOfWeek(),this.setMeridiem(),this.checkTimezone()},getSnoozeTip:function(e){var t=a.getDueDateLocalZoneDate(e).diff(a.prefMoment().startOf("day"),"days"),i="";return 0===t?i="["+r.get("today")+"] ":1===t&&(i="["+r.get("tomorrow")+"] "),i+=this.get("showMeridiem")?"LT":"HH:mm",e.format(i)},_dateFormat:function(e,t){var i="",n=a.prefMomentFromUtc(e,s.format.atomTime),o=a.getDueDateLocalZoneDate(e).diff(a.prefMoment().startOf("day"),"days");if(0===o)if(t||null===t)i+=r.get("today");else{var l=r.isZHLike()?"A hh:mm":"hh:mm A";i+=" "+n.format(this.get("showMeridiem")?l:"HH:mm")}else if(1===o)i+=r.get("tomorrow");else if(-1===o)i+=r.get("yesterday");else if(o>0&&6>=o)i+=n.format("ddd");else if(a.getDueDateLocalZoneDate(e).year()==a.prefMoment().year()){var c=r.isZHLike()?"MMMDo":"MMM D";i+=" "+n.format(c)}else{var c="LL";i+=" "+n.format(c)}return i},getTaskDetailSnooze:function(e){var t=this._dateFormat(e);return t},getListItemDueDateForList:function(e,t){if(!e)return"";var i=this._dateFormat(e,t);return i},getTaskDetailDueDateTip:function(e){return e?a.getRecentlyDueDateTip(a.getDueDateLocalZoneDate(e)):void 0},getDailyRemindTime:function(){return this.has("dailyRemindTime")||this.set("dailyRemindTime",this.getUTCHour(s.defaultRemindTime)),"-1"==this.get("dailyRemindTime")?this.getUTCHour(s.defaultRemindTime):this.get("dailyRemindTime")},getUTCHour:function(e){var t=this.get("showMeridiem")?"MM-DD-YYYY hh:mm A":"MM-DD-YYYY hh:mm",i=a.dateFormatToMoment("4-12-1984 "+e,t).lang("en");return i.utc().format("HH:mm")},getLocalHourString:function(e){if(e&&"-1"!=e){var t=a.prefMomentFromUtc("4-12-1984 "+e,"MM-DD-YYYY HH:mm").lang("en"),i=this.get("showMeridiem")?"hh:mm A":"HH:mm";return a.prefMomentFromUtc(t).format(i)}},formatToUtcString:function(e){var t=this.get("showMeridiem")?"YYYY-MM-DDhh:mm A":"YYYY-MM-DDhh:mm",e=a.dateFormatToMoment(e,t);return e.format(s.format.atomTime)}})}),define("service/prefs",["require","exports","module","model/preferences"],function(e,t){var i=e("model/preferences").Model,n=new i;return n}),define("model/project",["require","exports","module","configs/settings","lang/index","utils/log","service/userProfile"],function(e,t){var i=e("configs/settings"),n=e("lang/index"),s=e("utils/log"),a=e("service/userProfile");t.Model=Backbone.Model.extend({defaults:{id:"",name:"",listType:"",sortType:"",taskType:""},messages:function(){this.on("change",this.markDirty),this.on("sync",this.unmarkDirty)},initialize:function(){this.messages()},markDirty:function(){this.isDirty=!0},unmarkDirty:function(){this.isDirty=!1},url:function(){return i.API_HOST+"/project"+(this.isNew()?"":"/"+this.id)},validate:function(e){return _.isEmpty(e.name)?n.get("empty_project_name"):void 0},saveSortType:function(e){var t=this;setTimeout(function(){t.id===a.get("inboxId")?t.set("sortType",e):t.get("sortType")!==e&&t.save({sortType:e})},i.responsiveTime)},changeGroupId:function(e){this.get("groupId")!=e?(this.set("groupId",e),this.save()):this.trigger("change:groupId")},save:function(e,t){t||(t={}),t.error=function(){s.log("project save error")},Backbone.Model.prototype.save.call(this,e,t)},isShared:function(){return this.get("userCount")>1?!0:!1}})}),define("collection/project",["require","exports","module","configs/settings","model/project"],function(e,t){var i=e("configs/settings");t.Collection=Backbone.Collection.extend({model:e("model/project").Model,comparator:"sortOrder",url:function(){return i.API_HOST+"/projects";

}})}),define("model/smart-project",["require","exports","module"],function(e,t){t.Model=Backbone.Model.extend({messages:function(){this.on("change:status",this.triggerSmartProject)},initialize:function(){this.messages()},triggerSmartProject:function(){Backbone.trigger("toggleSmartProject")}})}),define("collection/smart-project",["require","exports","module","model/smart-project"],function(e,t){t.Collection=Backbone.Collection.extend({model:e("model/smart-project").Model})}),define("configs/regexp",["require","exports","module"],function(e,t){return{projectNameFilter:/[\\\/\'\"\:\?\<\>\|]/g,autocomplete:/^[\d\w\s\-\:\u4e00-\u9fa5]+$/,trigger:/^TRIGGER\:(-)?P(\d+Y)?(\d+M)?(\d+W)?(\d+D)?(T(\d+H)?(\d+M)?(\d+S)?)?$/,calendarUrl:/^[a-zA-z]+:\/\/[^\s]*/,emailRegexp:/^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,9}$/i,urlProjectId:/\/?project\/([^\s\/\#]*)/i,urlTaskId:/\/?task\/([^\s\/\#]*)/i,link:/(((http|https|ftp|ftps)\:\/\/)?([a-zA-Z0-9\-\.]+\.[a-zA-Z]{2,3}(\/\S*)?))/g,email:/\b([A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,4})\b/gi,protocol:/^((http|https|ftp|ftps)\:\/\/)/g,tag:/&((\w{2,8})|(#\d{2,8});)/g}}),define("utils/string",["require","exports","module","configs/regexp","utils/timeformat","utils/browser"],function(e,t){var i=e("configs/regexp"),n=e("utils/timeformat"),s=e("utils/browser");t.isValidMail=function(e){var t=i.emailRegexp;return t.test(e)},t.isValidDate=function(e){if(!_.isEmpty(e)){var t=n.prefMoment(e);if(t)return t.isValid()}return!1},t.encode=function(e){return s.isSafari?encodeURIComponent(e):e},t.quote=function(e){return'"'+e+'"'},t.cut20=function(e){var t="";return e.length>20?(t=e.substr(0,20),t+="..."):t=e,t},t.replaceSpace=function(e){var t=/([^<]*)(<a(.)*?<\/a>)?([^<]*)/g;return e.replace(t,function(e,t,i,n,s){return i?t.replace(/\s/gi,"&nbsp;")+i+s.replace(/\s/gi,"&nbsp;"):e.replace(/\s/gi,"&nbsp;")})},t.encodeHTML=function(e){return e.replace(/</g,"&lt;").replace(/>/g,"&gt;")},t.decodeHTML=function(e){return e.replace(/&amp/g,"&").replace(/&quot;/g,'"').replace(/&lt;/g,"<").replace(/&gt;/g,">")}}),define("configs/keycode",["require","exports","module"],function(e,t){return{0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause_break:19,caps_lock:20,escape:27,space:32,page_up:33,page_down:34,end:35,home:36,left_arrow:37,up_arrow:38,right_arrow:39,down_arrow:40,insert:45,"delete":46,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,left_window_key:91,right_window_key:92,select_key:93,numpad_0:96,numpad_1:97,numpad_2:98,numpad_3:99,numpad_4:100,numpad_5:101,numpad_6:102,numpad_7:103,numpad_8:104,numpad_9:105,multiply:106,add:107,subtract:109,decimal_point:110,divide:111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,num_lock:144,scroll_lock:145,semi_colon:186,equal_sign:187,comma:188,dash:189,period:190,forward_slash:191,grave_accent:192,open_bracket:219,back_slash:220,close_braket:221,single_quote:222,firefox_command:224}}),define("utils/index",["require","exports","module","configs/settings","configs/dict","lang/index","utils/dom","utils/string","utils/timeformat","utils/condition","configs/keycode"],function(e,t){var i=e("configs/settings"),n=e("configs/dict"),s=(e("lang/index"),e("utils/dom")),a=(e("utils/string"),e("utils/timeformat")),o=(e("utils/condition"),e("configs/keycode"));t.getTodoTasksCount=function(e){var t=0;return _.each(e,function(e){e.get("dueDate")&&0==e.get("status")&&a.getDueDateLocalZoneDate(e.get("dueDate")).diff(a.prefMoment().startOf("day"),"days")<=0&&t++}),t},t.setBadgeForExtension=function(e){chrome.browserAction.setBadgeText(e>0?{text:e.toString()}:{text:""})},t.getDefaultColorIndex=function(e){var t=0;return null!=e&&$.each(i.colors,function(n){i.colors[n].toUpperCase()==e.toUpperCase()&&(t=n)}),t},t.getProjectColor=function(e){return i.colors[t.getDefaultColorIndex(e)]},t.clone=function(e){return JSON.parse(JSON.stringify(e))},t.cloneDeep=function(e){if("object"!=typeof e||null==e)return e;if(e instanceof Date)return new Date(e.getTime());var t={};"[object Array]"===Object.prototype.toString.call(e)&&(t=[]);for(var i in e)t[i]=this.cloneDeep(e[i]);return t},t.verifyPasteEnter=function(e,t){var i,n,s,a,r,o=[],l=t.indexOf("\n");if(-1==t.indexOf("\n"))return t;if(i=t.substr(0,l),_.isEmpty(e.get("items")))e.set({content:t.substr(l+1)+"\n"+e.get("content")});else{if(n=t.substr(l+1),!n)return i;s=n.split("\n"),a=e.get("items"),r=-11111,_.each(s,function(e){var t={id:ObjectId(),status:0,title:e,sortOrder:r};o.push(t),r+=1}),e.set({items:o.concat(a),content:""})}return i},t.screenshotImage=function(e,t){var i=document.createElement("canvas");i.width=e.width,i.height=e.height;var n=i.getContext("2d");n.drawImage(e,0,0,e.width,e.height);var s=document.createElement("canvas");s.width=t[2],s.height=t[3];var a=s.getContext("2d");return a.drawImage(i,t[0],t[1],t[2],t[3],0,0,t[2],t[3]),s.toDataURL("image/jpeg",.5)},t.hasReminders=function(e){return e&&e.length},t.svgIcon=function(e,t){var i=[];return i.push('<svg class="'+e+" "),_.isObject(t)||i.push(t),i.push('"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#'),i.push(e),i.push('"></use></svg>'),i.join("")},t.imgIcon=function(e,t){var i=[];return i.push('<i class="'+e+" "),_.isObject(t)||i.push(t),i.push('"></i>'),i.join("")},t.getImg=function(e,t){var n=new Array,s="upgrade-img",r=window.devicePixelRatio>1;return n.push("<img"),i.iscnlang||(s="tick-"+s),r&&(s=s.concat("@2")),s='src="static/img/'+s.concat("/",e,".png?v="+a.prefMoment().format("YYYYMMDD"))+'"',n.push(s),n.push(">"),n.join(" ")},t.getPriorityIcon=function(e){var i={0:t.svgIcon("icon-priority-3","i-4"),1:t.svgIcon("icon-priority-1"),3:t.svgIcon("icon-priority-2"),5:t.svgIcon("icon-priority-3")};return i[e]},t.convertHex=function(e,t){return e=e.replace("#",""),r=parseInt(e.substring(0,2),16),g=parseInt(e.substring(2,4),16),b=parseInt(e.substring(4,6),16),result="rgba("+r+","+g+","+b+","+t/100+")",result},t.getOffsetDays=function(e){return t.getOffsetDaysOfDay(e.get("dueDate"))},t.getOffsetDaysOfDay=function(e){e=a.prefMomentFromUtc(e,n.format.atomTime),e.startOf("day");var t=a.prefMoment().startOf("day");return e.diff(t,"days")},t.timeKeyLimit=function(e){var t=e.which?e.which:event.keyCode,i=s.getInputCaretPosition(e.currentTarget);return 1>=i||i>2&&5>i?t>=o[0]&&t<=o[9]||t>=o.numpad_0&&t<=o.numpad_9?!0:!1:6===i?t===o.numpad_1||t===o.f1||t===o.a||t===o.p?!0:!1:7===i?t===o.subtract||t===o.m?!0:!1:void 0}}),define("dao/projectdb",["require","exports","module","offline/storage","configs/dict","configs/settings","lang/index","service/prefs","collection/project","collection/smart-project","model/project","utils/index","service/userProfile"],function(e,t,i){var n=e("offline/storage"),s=e("configs/dict"),a=e("configs/settings"),r=e("lang/index"),o=e("service/prefs"),l=e("collection/project").Collection,c=e("collection/smart-project").Collection,d=e("model/project").Model,u=(e("utils/index"),e("service/userProfile")),h=new l,p=new c;h.on("change",function(){Backbone.trigger("projectDBUpdate")});var m=a.user.isJustRegistered,f={id:s.smartProjectId.all,name:r.get("list_all"),listType:"non-project",sortType:s.sortType.dueDate,taskType:"tasks",status:"show"},g={id:s.smartProjectId.today,name:r.get("list_today"),listType:"non-project",sortType:s.sortType.dueDate,taskType:"today",status:"show"},v={id:s.smartProjectId.week,name:r.get("list_week"),listType:"non-project",sortType:s.sortType.dueDate,taskType:"week",status:m?"hide":"show"},y={id:s.smartProjectId.tkcalendar,name:r.get("tk_calendar_project"),listType:"non-project",sortType:s.sortType.dueDate,taskType:"calendar",status:u.isPro()?"show":"hide"},k={id:s.smartProjectId.assignedme,name:r.get("assigned_me"),listType:"non-project",sortType:s.sortType.project,taskType:"assignedme",status:"auto"},w={id:u.get("inboxId"),name:r.get("list_inbox"),listType:"project",sortType:n.getCacheItem(s.cachePath.sortTypeInbox),taskType:"inbox",inAll:!0},b={id:s.smartProjectId.completed,name:r.get("list_completed"),listType:"non-project",sortType:s.sortType.completedTime,taskType:"completed",status:"show"},T={id:s.smartProjectId.trash,name:r.get("list_trash"),listType:"non-project",sortType:s.sortType.modifiedTime,taskType:"trash",status:m?"hide":"show"};p.add([f,v,g,T,b,y,k]),t.db={collection:h,smartCollection:p,projectInbox:new d(w),refresh:function(e){var t=n.getCacheItem(s.cachePath.projects)?!0:!1;h.reset(n.getCacheItem(s.cachePath.projects)),this.projectInbox.set("sortType",o.getsortTypeOfInbox()),this.getSmartProjectStatus(),h.fetch({success:function(t){e&&e.apply(),setTimeout(function(){n.setCacheItem(s.cachePath.projects,t)},a.responsiveTime)},error:function(){e&&t&&e.apply()},reset:!0})},getSubscribeList:function(){var e=p.filter(function(e){return e.get("type")==s.smartProjectId.subscribe}),t={};return _.each(e,function(e){t[e.get("id")]={name:e.get("name"),url:e.get("url")}}),t},getSubscribeModels:function(){return p.filter(function(e){return e.get("type")==s.smartProjectId.subscribe})},replaceSubscribeProject:function(e){var t=p.where({type:s.smartProjectId.subscribe});p.remove(t),_.each(e,function(e){var t={id:e.id,name:e.name,url:e.url,type:s.smartProjectId.subscribe,listType:"non-project",sortType:s.sortType.dueDate,taskType:"tasks"};p.add(t)})},resetSmartProjectByLocal:function(){var e=n.getCacheItem(s.cachePath.subscribeProjects);!_.isEmpty(e)&&p.add(e)},getSmartProjectStatus:function(){var e=[{id:s.smartProjectId.all,key:"showAllList"},{id:s.smartProjectId.today,key:"showTodayList"},{id:s.smartProjectId.week,key:"showNext7DaysList"},{id:s.smartProjectId.tkcalendar,key:"showTKCalendar"},{id:s.smartProjectId.assignedme,key:"showAssignedMeList"},{id:s.smartProjectId.completed,key:"showCompletedList"},{id:s.smartProjectId.trash,key:"showTrashList"}];_.each(e,function(e){p.get(e.id).set("status",o.get(e.key)?o.get(e.key):p.get(e.id).get("status"))})},dumpToLocalStorage:function(){var e=p.where({type:s.smartProjectId.subscribe});n.setCacheItem(s.cachePath.projects,h.toJSON()),n.setCacheItem(s.cachePath.smartProjects,p.toJSON()),n.setCacheItem(s.cachePath.subscribeProjects,e)},normalProjectCount:function(){return h.length},smartProjectCount:function(){return p.length},getProjects:function(){return h.filter(function(e){return"non-project"!=e.get("listType")})},getProjectsWithInbox:function(){return[this.projectInbox].concat(this.getProjects())},getCountingProjects:function(){return[this.getProjectById(u.get("inboxId")),this.getSmartProjectById("tasks"),this.getSmartProjectById("today"),this.getSmartProjectById("week"),this.getSmartProjectById("assignedme")]},getProjectByName:function(e){return h.find(function(t){return t.get("name")==e})},getSmartProjectByName:function(e){return p.find(function(t){return t.get("name")==e})},getProjectById:function(e){return"inbox"===e||e===u.get("inboxId")?this.projectInbox:h.get(e)},getProjectsByGroupId:function(e){return h.sort(),h.filter(function(t){return t.get("closed")!==!0&&t.get("groupId")===e})},getProjectsNotUnderGroup:function(){return h.filter(function(e){var t=e.get("groupId");return!e.get("closed")&&(/none/i.test(t)||!t)})},getProjectsClosed:function(){return h.sort(),h.filter(function(e){return!!e.get("closed")})},getProjectsUnClosed:function(){return h.filter(function(e){return!e.get("closed")})},getProjectsUnClosedWithInbox:function(){return[this.projectInbox].concat(this.getProjectsUnClosed())},getProjectColorById:function(e){var t=this.getProjectById(e);if(t){var i=t.get("color");if(i)return i}return""},getSmartProjectById:function(e){return p.get(e)},getFromAllProjectsById:function(e){return this.getProjectById(e)||this.getSmartProjectById(e)},getProjectByIndex:function(e){return h.at(e)},getSmartProjectByIndex:function(e){return p.at(e)},getDefaultProject:function(){return h.find(function(e){return e.get("defaultProject")})},getMaxSortOrder:function(){if(1==h.length)return-a.orderStep;var e=h.max(function(e){return e.get("sortOrder")});return e.get?e.get("sortOrder"):0},getMinSortOrder:function(){var e=h.min(function(e){return e.get("sortOrder")});return e.get?e.get("sortOrder"):0},isDuplicate:function(e,t){var i=this.getProjectByName(t);return null==i||null!=e&&e.id==i.id?!1:!0},getProjectsNotShowInAll:function(){var e=h.filter(function(e){return 0==e.get("inAll")});return e},ifProjectShowInAll:function(e){var t=!0;return _.each(this.getProjectsNotShowInAll(),function(i){i.get("id")==e&&(t=!1)}),t},setProjectListOpenStatus:function(e){n.setStoreInfo(s.openType.project,e)},getProjectListOpenStatus:function(){return n.getStoreInfo(s.openType.project)},hasClosedProject:function(){var e=h.filter(function(e){return e.get("closed")===!0});return e.length},hasSharedProject:function(){var e=h.filter(function(e){return parseInt(e.get("userCount"))>1&&!e.get("closed")});return e.length},getNotInAllProjects:function(){return h.filter(function(e){return!e.get("inAll")})},updateProjectsSortOrder:function(e){var t=this;_.each(e,function(e){var i=e.id,n=e.order,s=t.collection.get(i);s&&s.set("sortOrder",n)})}}}),define("utils/calculate",["require","exports","module","configs/regexp","configs/dict","utils/timeformat"],function(e,t){var n=e("configs/regexp"),s=e("configs/dict"),a=e("utils/timeformat"),r=s.triggerUnit;return{remindTime:function(e,t){if(!e||!t)return null;var i=t.match(n.trigger);if(!i)return null;var o=a.prefMoment(e).utc(),l="-"===i[1],c=i.length;if(c>2)for(var d=2;c>d;d++)if(6!==d&&i[d]){var u=parseInt(i[d]);l&&(u=-u),o.add(r[d],u)}return o.startOf("minute"),o.format(s.format.atomTime)},decimalToDegree:function(e){if(0>e){var t=!0;e=-e}else t=!1;for(;e>360;)e-=360;var i=Math.round(e),n=60*Math.round(e-i),s=(3600*(e-i-n/60)).toFixed(1),a=i+"°"+n+"′"+s+"″";return t?"-"+a:a},compareReminder:function(e,t){var s,a,o=0;if(e.trigger?(s=e.trigger.match(n.trigger),a=t.trigger.match(n.trigger)):(s=("TRIGGER:"+e).match(n.trigger),a=("TRIGGER:"+t).match(n.trigger)),!s)return 1;if(!a)return-1;if(!s[1])return-1;if(!a[1])return 1;for(i in r)if(s[i]){if(!a[i]){o=1;break}var l=parseInt(s[i]),c=parseInt(a[i]);if(l!==c){o=c>l?-1:1;break}}else if(a[i]){o=-1;break}return o}}}),define("service/filter",["require","exports","module","configs/dict","dao/projectdb","utils/string","utils/timeformat","utils/calculate","utils/index","service/userProfile"],function(e,t){var i=e("configs/dict"),n=e("dao/projectdb"),s=e("utils/string"),a=e("utils/timeformat"),r=e("utils/calculate"),o=e("utils/index"),l=e("service/userProfile"),c=t.filter={_noDuedate:function(e){return!s.isValidDate(e.get("dueDate"))},_getcompletedTimeOffsetDays:function(e){var t=a.prefMomentFromUtc(e.get("completedTime"),i.format.atomTime);if(_.isNull(t))return!1;var n=a.prefMomentFromUtc(t),s=(n.startOf("day"),a.prefMoment().startOf("day"));return n.diff(s,"days")},_getRemindTimeOffsetMinutes:function(e){var t=a.prefMomentFromUtc(e,i.format.atomTime);return t.startOf("minute").diff(a.prefMoment().startOf("minute"),"minutes")},_getDueDateOffsetMinutes:function(e){var t=a.prefMomentFromUtc(e.get("dueDate"),i.format.atomTime);return t.startOf("minute").diff(a.prefMoment().startOf("minute"),"minutes")},_archived:function(e){return 2==e.get("status")},_notInAll:function(e){var t=_.pluck(n.db.getProjectsNotShowInAll(),"id");return _.contains(t,e.get("projectId"))},_forGroup:function(e){return c.completed(e)?!1:c._noDuedate(e)?!1:!0},_isClosed:function(e){return e.get("projectId")&&(project=n.db.getProjectById(e.get("projectId")),project)?project.get("closed"):void 0},urgentPriority:function(e){return c.completed(e)?!1:5==e.get("priority")},normalPriority:function(e){return c.completed(e)?!1:3==e.get("priority")},lowPriority:function(e){return c.completed(e)?!1:1==e.get("priority")},noPriority:function(e){return c.completed(e)?!1:0==e.get("priority")},completed:function(e){return e.get("status")>0},deleted:function(e){return e.get("deleted")>0},todo:function(e){return 0==e.get("status")},overDue:function(e){return c._forGroup(e)?o.getOffsetDays(e)<0:!1},today:function(e){return c._forGroup(e)?0==o.getOffsetDays(e):!1},todayAndOverdue:function(e){return c.today(e)?!0:c.overDue(e)?!0:!1},tomorrow:function(e){return c._forGroup(e)?1==o.getOffsetDays(e):!1},week:function(e){if(!c._forGroup(e))return!1;var t=o.getOffsetDays(e);return t==this.dayOffset},next7days:function(e){if(!c._forGroup(e))return!1;var t=o.getOffsetDays(e);return t>1&&7>=t},later:function(e){return c._forGroup(e)?o.getOffsetDays(e)>7:!1},noDate:function(e){return c.completed(e)?!1:c._noDuedate(e)},sortOrder:function(e){return c.todo(e)},chooseDate:function(e){return c.todo(e)?this.chooseDate?a.formatToDateString(moment(e.get("dueDate")))===this.chooseDate:!0:!1},sortTitle:function(e){return c.todo(e)},search:function(e){return!0},tag:function(e){if(c.deleted(e))return!1;var t=e.get("tags");if(!t)return!1;var i=_.findIndex(t,function(e){return e.toLowerCase()===this.tName},this);return-1!==i},assigned:function(e){return c.deleted(e)?!1:c.completed(e)?!1:null!==e.get("assignee")&&parseInt(e.get("assignee"))===parseInt(this.assignee)},noAssigned:function(e){return c.deleted(e)?!1:c.completed(e)?!1:e.has("assignee")?null===e.get("assignee")||-1===parseInt(e.get("assignee")):!0},group:function(e){return c.completed(e)?!1:e.get("projectId")===this.projectId},countAll:function(e){return c.completed(e)?!1:c._notInAll(e)?!1:!0},countInbox:function(e){return c.completed(e)?!1:e.get("projectId")==l.get("inboxId")},countTodayAndOverdue:function(e){if(c._notInAll(e))return!1;if(c.completed(e))return!1;if(c._noDuedate(e))return!1;var t=o.getOffsetDays(e);return 0>=t},countWeek:function(e){if(c._notInAll(e))return!1;if(c.completed(e))return!1;if(c._noDuedate(e))return!1;var t=o.getOffsetDays(e);return 7>t},getInboxTasks:function(e){return e.get("projectId")==l.get("inboxId")},getAllTodoTasks:function(e){return c._notInAll(e)?!1:!0},getTodayAndOverdueTasks:function(e){return c._notInAll(e)?!1:c.completed(e)?!0:c._noDuedate(e)?!1:o.getOffsetDays(e)<=0},getWeekAndOverdueTasks:function(e){if(c._notInAll(e))return!1;if(c.completed(e))return!0;if(c._noDuedate(e))return!1;var t=o.getOffsetDays(e);return 7>t},onTimeTasks:function(e){if(!c.todo(e))return!1;if(c._noDuedate(e))return!1;if(c._isClosed(e))return!1;if(e.get("remindTime")&&0===c._getRemindTimeOffsetMinutes(e.get("remindTime")))return!0;var t=e.get("reminders");if(_.isEmpty(t))return!1;for(var i=e.getCalTime(),n=0;n<t.length;n++){var s=t[n],a=r.remindTime(i,s.trigger);if(0===c._getRemindTimeOffsetMinutes(a))return!0}return!1},modelHasId:function(e){return e?void 0!=e.get("id"):!1},getInAllTasksWithDueDate:function(e){return c._notInAll(e)||c._noDuedate(e)?!1:!0},getAllTasks:function(e){return!0},getTasksNotDelOrArchived:function(e){return c.deleted(e)||c._archived(e)?!1:!0},getTasksCompletedToday:function(e){return c._notInAll(e)?!1:c.completed(e)&&0===c._getcompletedTimeOffsetDays(e)},tasksAssignedMe:function(e){return c.deleted(e)?!1:c.completed(e)?!1:e.get("assignee")===l.get("userId")}}}),define("service/sort",["require","exports","module","dao/projectdb","configs/dict","service/userProfile"],function(e,t){var i=e("dao/projectdb"),n=e("configs/dict"),s=e("service/userProfile");t.rank=rank=function(){return{_defined:function(e,t){return e?t?0:-1:t?1:0},_undefined:function(e,t){return void 0!=e?void 0!=t?0:-1:void 0!=t?1:0},_boolean:function(e,t){return e==t?0:!e&&t?1:-1},_status:function(e,t){return e==t?0:t>e?-1:1},_compareDate:function(e,t){var i=rank._defined(e,t);if(0!==i)return i;if(e==t)return 0;var n=moment(e).unix(),s=moment(t).unix();return n==s?0:n>s?1:-1},_compareDateString:function(e,t){var i=rank._defined(e,t);return 0!==i?i:rank._compareDigit(e,t)},_compareDigit:function(e,t){return e==t?0:e>t?1:-1},_duedate:function(e,t){var i=e.get("dueDate"),n=t.get("dueDate");return rank._compareDate(i,n)},_allday:function(e,t){var i=e.get("dueDate"),n=t.get("dueDate");if(!moment(i).isSame(n,"D"))return 0;var s=e.get("isAllDay"),a=t.get("isAllDay");return rank._boolean(s,a)},_priority:function(e,t){var i=e.get("priority"),n=t.get("priority");return-rank._compareDigit(i,n)},_project:function(e,t){var n=i.db.getProjectById(e.get("projectId")),s=i.db.getProjectById(t.get("projectId"));return rank.projectOrder(n,s)},_sortOrder:function(e,t){var i=e.get("sortOrder"),n=t.get("sortOrder");return rank._compareDigit(i,n)},_taskId:function(e,t){var i=e.get("id"),n=t.get("id");return i.localeCompare(n)},projectOrder:function(e,t){return e&&t?e===t?0:e.id===s.get("inboxId")?-1:t.id===s.get("inboxId")?1:rank._compareDigit(e.get("sortOrder"),t.get("sortOrder")):0},subscribecalendar:function(e,t){var i=e.get("projectId"),s=t.get("projectId");return i==s&&s==n.smartProjectId.subscribe?rank.dueDate(e,t):i==n.smartProjectId.subscribe?1:s==n.smartProjectId.subscribe?-1:0},dueDate:function(e,t){var i=rank._allday(e,t);return 0!==i?i:(i=rank._duedate(e,t),0!==i?i:(i=rank._priority(e,t),0!==i?i:(i=rank._project(e,t),0!==i?i:(i=rank._sortOrder(e,t),0!==i?i:rank._taskId(e,t)))))},remindTime:function(e,t){var i=e.get("remindTime"),n=t.get("remindTime");return rank._compareDate(i,n)},calendar:function(e,t){var i=e.get("status"),n=t.get("status"),s=rank._compareDigit(i,n);return 0!==s?s:(s=rank.remindTime(e,t),0!==s?s:rank.dueDate(e,t))},sortOrder:function(e,t){var i=rank._sortOrder(e,t);return 0!==i?i:rank._taskId(e,t)},modifiedTime:function(e,t){var i=e.get("modifiedTime"),n=t.get("modifiedTime"),s=-rank._compareDate(i,n);return 0!==s?s:rank._taskId(e,t)},completedTime:function(e,t){var i=e.get("completedTime"),n=t.get("completedTime"),s=rank._defined(i,n);return 0!==s?s:(s=-rank._compareDateString(i,n),0!==s?s:rank._taskId(e,t))},priority:function(e,t){var i=rank._priority(e,t);return 0!==i?i:(i=rank._allday(e,t),0!==i?i:(i=rank._duedate(e,t),0!==i?i:(i=rank._project(e,t),0!==i?i:(i=rank._sortOrder(e,t),0!==i?i:rank._taskId(e,t)))))},title:function(e,t){var i=e.get("title"),n=t.get("title"),s=i.localeCompare(n);return 0!==s?s:rank._taskId(e,t)},assignee:function(e,t){if(i=rank._allday(e,t),0!==i)return i;var i=rank._duedate(e,t);return 0!==i?i:(i=rank._priority(e,t),0!==i?i:(i=rank._project(e,t),0!==i?i:(i=rank._sortOrder(e,t),0!==i?i:rank._taskId(e,t))))},today:function(e,t){return rank.dueDate(e,t)},week:function(e,t){return rank.dueDate(e,t)},sharedUsers:function(e,t){if(e.get("isOwner"))return-1;if(t.get("isOwner"))return 1;if(e.get("isMyself"))return-1;if(t.get("isMyself"))return 1;if(!e.get("isAccept")&&t.get("isAccept"))return-1;if(e.get("isAccept")&&!t.get("isAccept"))return 1;var i=e.get("createdTime"),n=t.get("createdTime");return-rank._compareDate(i,n)},taskGroupSortOrder:function(e,t,i,n){var s=rank._undefined(e,t);return 0!==s?s:(s=rank._compareDigit(e,t),0!==s?s:rank._taskId(i,n))},search:function(e,t){return rank._compareDigit(e.get("searchOrder"),t.get("searchOrder"))},tag:function(e,t){var i=rank._status(e.get("status"),t.get("status"));return 0!==i?i:(i=rank.title(e,t),0!==i?i:rank._taskId(e,t))},mincalendar:function(e,t){return rank.dueDate(e,t)}}}()}),define("configs/status",["require","exports","module","configs/settings"],function(e,t){e("configs/settings");t.inCalendar=!1,t.isWindowBlur=!1,$(window).blur(function(e){t.isWindowBlur=!0}),$(window).focus(function(){t.isWindowBlur=!1})}),define("utils/task-util",["require","exports","module","utils/log","configs/dict","utils/timeformat"],function(e,t){var i=e("utils/log"),n=e("configs/dict"),s=e("utils/timeformat"),a="LUNAR:",r="RRULE:",o=new CalendarConverter,l=function(e,i,o,l){var c,h;if(o&&e){if(-1==o.indexOf(a)&&-1==o.indexOf(r)&&(o=r+o),_isLunarRepeatFlag(o)){var p=RRule.parseString(t.sliceRepeatFlag(o)),m=moment(e).toDate();h=d(m,p);for(var f=0;null!=h&&h<new Date&&(h=d(h,p),!(f++>1e3)););return c=h?s.prefMoment(h).format(n.format.atomTime):null}var g=!1,m=e,v=i;n.repeatFromType.completedTime===l&&v&&(m=v),m=moment(m).toDate();var y=m;if(n.repeatFromType.defaultVal==l||null==l){var k=s.getStartOfToday();k=moment(k).toDate(),k>m&&(y=k,g=!0)}var p=RRule.parseString(t.sliceRepeatFlag(o));p.dtstart=m;var w=new RRule(p);if(!(p.until&&moment(p.until).startOf("days").diff(moment().startOf("days"))<=0))return h=u(w,y,g),c=h?s.prefMoment(h).format(n.format.atomTime):null}},c=function(e,t,n,s){try{return l(e,t,n,s)}catch(a){i.log(a)}},d=function(e,t){var i=o.solar2lunar(e);if(lunarMonthDay=null!=t.bymonthday?t.bymonthday:i.lDay,lunarYear=i.lYear,lunarMonth=i.lMonth,o.leapMonth(lunarYear)==lunarMonth){var n=new Date(e);n.setDate(n.getDate()+o.daysOfMonth(lunarYear,lunarMonth));var s=o.solar2lunar(n);if(s.isLeap)return n;lunarYear++}else lunarYear++;(30==lunarMonthDay||-1==lunarMonthDay)&&(lunarMonthDay=o.daysOfMonth(lunarYear,lunarMonth));var a=o.lunar2solar(new Date(lunarYear,lunarMonth-1,lunarMonthDay),o.leapMonth(lunarYear)==lunarMonth);return new Date(a.sYear,a.sMonth-1,a.sDay,e.getHours(),e.getMinutes())},u=function(e,t,i){var n=e.after(t,!!i);return n?n:null};_isLunarRepeatFlag=function(e){return e&&-1!=e.indexOf(a)?!0:!1},t.getNextDueDate=function(e){var t=e.get("repeatFlag"),i=e.get("dueDate"),n=e.get("repeatFrom"),s=e.get("completedTime");return c(i,s,t,n)},t.autoCreateNextRepeat=function(e){if(null!==e.get("repeatFlag")&&null!==e.get("dueDate")){var i=t.getNextDueDate(e);if(null==i)return;e.set("dueDate",i),e.set("dueEnd",i),e.set("dueStart",i)}},t.getNextReminderTime=function(e){return t.getNextDueDate(e)},t.sliceRepeatFlag=function(e){return e.replace(r,"").replace(a,"")},t.getNextDate=function(e,t,i){var s,a,r=moment(),o=moment(i),l=r.diff(o,"days");if(i&&0>=l)o=0==l?o.subtract("days",1):o,s=o.utc().format(n.format.atomTime);else{var d=r.subtract("days",1);s=d.utc().format(n.format.atomTime)}a=r.utc().format(n.format.atomTime);var u=c(s,a,e,t);return u&&moment(u).format("YYYY-MM-DD")}}),define("model/task",["require","exports","module","configs/settings","configs/dict","utils/calculate","utils/hash","utils/string","utils/timeformat","utils/log","service/prefs","utils/server","utils/task-util","utils/index","service/userProfile","offline/storage"],function(e,t){var i=e("configs/settings"),n=e("configs/dict"),s=e("utils/calculate"),a=e("utils/hash"),r=(e("utils/string"),e("utils/timeformat")),o=e("utils/log"),l=e("service/prefs"),c=e("utils/server"),d=e("utils/task-util"),u=e("utils/index"),h=e("service/userProfile"),p=e("offline/storage");t.Model=Backbone.Model.extend({defaults:{title:"",content:"",sortOrder:0,priority:0,projectId:h.get("inboxId"),dueDate:null,timeZone:l.get("timeZone"),status:0,items:[],assignee:null,deleted:0},validate:function(e,t){return e.id?void 0:"need error"},messages:function(){this.on("change",this.taskChanged),this.on("toggleModelComplete",this.toggleModelComplete,this),this.on("deleteForever",this.deleteForever,this),this.on("restore",this.restore,this),this.on("dropOnOverdueSection",this.dropOnOverdueSection,this),this.on("dropOnNext7DaysSection",this.dropOnNext7DaysSection,this),this.on("dropOnLaterSection",this.dropOnLaterSection,this),this.on("dropOnNoDateSection",this.dropOnNoDateSection,this),this.on("dropOnPrioritySection",this.dropOnPrioritySection,this),this.on("dropOnSortOrderSection",this.dropOnSortOrderSection,this),this.on("dropOnAssigneeSection",this.dropOnAssigneeSection,this),this.on("dropOnTitleSection",this.dropOnTitleSection,this),this.on("dropOnCompletedTaskGroup",this.dropOnCompletedTaskGroup,this),this.on("dropOnCompletedTaskGroupInCompleted",this.dropOnCompletedTaskGroupInCompleted,this),this.on("sync",this.afterSync),this.on("change:dueDate",this.afterChangeDuedate),this.on("change:reminders",this.taskRemindersChange),this.on("delAssignee",this.delAssignee)},initialize:function(){this.changedTime=r.prefMoment().unix(),this.messages(),this.dumpInTemp(this)},taskRemindersChange:function(){this.set({reminder:null,remindTime:null})},resetModifyData:function(){this.set("modifiedItems",{deletedIds:[],modifiedIds:[]})},updateModifiedIds:function(e){var t=this.get("modifiedItems");null==t&&this.resetModifyData(),-1===_.indexOf(this.get("modifiedItems").modifiedIds,e)&&this.get("modifiedItems").modifiedIds.push(e)},updateDeletedIds:function(e){var t=this.get("modifiedItems");null==t&&this.resetModifyData(),-1===_.indexOf(this.get("modifiedItems").deletedIds,e)&&this.get("modifiedItems").deletedIds.push(e)},checkItemsOrder:function(){var e=_.sortBy(this.get("items"),function(e){return e.sortOrder});return e=_.sortBy(e,function(e){return e.status}),this.set({items:e},{silent:!0}),e},updateItemsOrder:function(){if(this.get("items")&&this.get("items").length>0){var e=0,t=this;_.each(this.get("items"),function(i){i.sortOrder!=e&&(t.updateModifiedIds(i.id),i.sortOrder=e),e+=1})}},taskChanged:function(){var e=r.prefMoment().format(n.format.atomTime);this.set({modifiedTime:e},{silent:!0}),this.collection&&p.setCacheItem(n.cachePath.tasks,this.collection.toJSON());var t=["tags","assignee","deleted","dueDate","priority","projectId","sortOrder","status"];for(var i in this.changedAttributes())if(_.contains(t,i))return Backbone.trigger("taskChanged",this),void Backbone.trigger("updateCounts")},unmarkDirty:function(){this.isDirty=!1},markDirty:function(){this.isDirty=!0,Backbone.trigger("dumpInOriginalServer",this)},url:function(){return i.API_HOST+"/task"+(this.isNew()?"":"/"+this.id)},isEmpty:function(){return!(this.get("title")||this.get("content")||this.get("desc")||this.get("items").length>1||1==this.get("items").length&&this.get("items")[0].title.length||this.get("attachments")||this.get("commentCount"))},afterChangeDuedate:function(){this.updateRemindTime(),this.formatToUtc(),this.updateCalendar(this)},updateRemindTime:function(){this.set("remindTime",null)},formatToUtc:function(){var e=r.formatToUtc(this.get("dueDate"));e&&this.set("dueDate",e,{silent:!0})},updateCalendar:function(e){var t=e._previousAttributes.dueDate,i=e.changed.dueDate;e.isNormal()&&Backbone.trigger("updateCalendarDateWithTask",r.getDueDateText(t),r.getDueDateText(i))},setItemsNewId:function(e){e=e||[],e.map(function(e){e.id=ObjectId()})},resetSubtaskStatus:function(){var e=this.get("items")||[];e.map(function(e){e.status=0})},cloneTask:function(e){var i=u.clone(this);return i=new t.Model(i),i.set("id",ObjectId()),i.unset("etag"),i.unset("completedTime"),i.unset("commentCount"),"object"==typeof e&&i.set(e),i.setItemsNewId(i.get("attachments")),i.setItemsNewId(i.get("reminders")),i.setItemsNewId(i.get("items")),i},_cloneAchiveTask:function(){var e=this.cloneTask({repeatFlag:null,status:2,completedTime:r.prefMoment().format(n.format.atomTime),repeatTaskId:this.get("id")});e.local=!0,Backbone.trigger("addToTaskdb",e),e.save({},{success:function(){e.local=!1}})},toggleModelComplete:function(e){var t=this.get("status"),i=t?0:2;this.set(i>0?{completedTime:r.prefMoment().format(n.format.atomTime)}:{sortOrder:e?e:this.get("sortOrder")});var s=this.isWillRepeat=this.willRepeat(),a=this;s?(this.set("status",0),this._cloneAchiveTask(),this.resetSubtaskStatus(),this.setNextDuedate(),this.unset("completedTime"),setTimeout(function(){a.trigger("toggleRepeatTip")},1100)):(t&&Backbone.trigger("updateTaskOrderFromCompleted",[this]),this.set("status",i)),this.updateItemsOrder(),this.save()},setNextDuedate:function(){try{var e=this.nextDueDate;if(this.get("repeatFrom")===n.repeatFromType.completedTime&&null!=this.nextDueDate){var t=new Date(this.get("dueDate"));e=new Date(e),e.setHours(t.getHours()),e.setMinutes(t.getMinutes()),e.setSeconds(t.getSeconds()),e=e.toString()}this.set("dueDate",e)}catch(i){o.log(i)}},afterSync:function(){this.local=null,this.set("local",!1),Backbone.trigger("refreshTagsList");var e=_.sortBy(this.get("items"),function(e){return e.sortOrder});this.set({items:e},{silent:!0}),this.resetModifyData(),a.isInCompleted()&&0===this.get("status")&&(this.trigger("destroy"),this.trigger("closeDetailView")),Backbone.trigger("updateCalendarDatesWithTask"),this.unmarkDirty(),this.requesting=!1,
this.saveCallback&&this.save()},_getTimeByDueDate:function(){var e=this.get("dueDate");return null!=e?r.prefMoment(e).format("HH:mm:ss"):"00:00:00"},_dropDateHandle:function(e){var t=this._getTimeByDueDate(),i=r.dateFormatToMoment(e,"YYYYMMDD").format("YYYY-MM-DDT"+t+".000ZZ");return i},dropOnTodayTomoWeekSection:function(e){var t=this._dropDateHandle(e);this.set({status:0,dueDate:t}),this.doSave()},dropOnOverdueSection:function(){var e=this._dropDateHandle(r.prefMoment().add("days",-1));this.set({status:0,dueDate:e}),this.doSave()},dropOnNext7DaysSection:function(){var e=this._dropDateHandle(r.prefMoment().add("days",2));this.set({status:0,dueDate:e,repeatFirstDate:e}),this.doSave()},dropOnLaterSection:function(){var e=this._dropDateHandle(r.prefMoment().add("days",8));this.set({status:0,dueDate:e,repeatFirstDate:e}),this.doSave()},dropOnNoDateSection:function(){this.set({reminders:null,isAllDay:null,status:0,dueDate:null}),this.doSave()},dropOnPrioritySection:function(e){this.doSave({status:0,priority:e})},dropOnCompletedTaskGroup:function(){return this.willRepeat()?void this.toggleModelComplete():void this.doSave({completedTime:r.prefMoment().format(n.format.atomTime),status:2})},dropOnCompletedTaskGroupInCompleted:function(e){this.doSave({completedTime:r.prefMoment(e).format(n.format.atomTime),status:2})},dropOnSortOrderSection:function(){this.get("status")&&this.doSave({status:0})},dropOnAssigneeSection:function(e){this.doSave({assignee:e,status:0})},dropOnTitleSection:function(){this.get("status")?this.doSave({status:0}):this.isNew()&&this.doSave()},doSave:function(e){this.save(e),this.isNew()&&Backbone.trigger("refresh")},save:function(e,t){var i=(new Date).getTime(),n=this.lastSyncTime||0,s=i-n;if(this.saveCallback=!1,12e4>=s&&this.requesting)return this.saveCallback=!0,void o.log("frequent saving detected");this.lastSyncTime=i,this.requesting=!0,(!this.get("status")||e&&0===e.status)&&this.get("completedTime")&&this.unset("completedTime"),this.get("dueDate")?_.isEmpty(this.get("reminders"))&&this.set("isAllDay",!0):this.set({reminders:null,isAllDay:null,remindTime:null,reminder:null}),this.updateItemsOrder(),Backbone.trigger("dumpInOriginalClient",this),this.unmarkDirty();var a=this;t||(t={}),t.error=function(e){a.requesting=!1,a.markDirty(),o.log("task save error",e)},Backbone.Model.prototype.save.call(this,e,t)},deleteForever:function(){var e={taskId:this.get("id"),projectId:this.get("projectId")};c.deleteTaskForever([e])},restore:function(){var e={taskId:this.get("id"),projectId:this.get("projectId")};c.restoreTrash(this.get("projectId"),JSON.stringify([e]),!0)},hasAssign:function(){return 0===parseInt(this.get("assignee"))?(this.set("assignee",-1),!1):null==this.get("assignee")||-1===parseInt(this.get("assignee"))?!1:!0},subtaskNotText:function(){return this.get("items").length>0},textNotSubtask:function(){return 0===this.get("items").length},hasContent:function(){return!_.isEmpty(this.get("content"))},willRepeat:function(){var e=this.get("repeatFlag");if(null===e||_.isEmpty(e))return!1;var t=this.nextDueDate=d.getNextDueDate(this);return t?!0:!1},locateSubview:function(e){var t=this,i=_.filter(e,function(e){return null!=e.taskListItemViews[t.id]});return i[0]||null},findTargetSubview:function(e){var t=this,i=_.filter(e,function(e){return e.ifCanShowIn(t)});return i[0]||null},hasSnoozeTime:function(){var e=this.get("reminders"),t=this.get("dueDate"),i=this.get("remindTime"),n=this.get("status");if(!t||_.isEmpty(e))return this.set({reminders:null,remindTime:null}),!1;if(n)return!1;if(!i)return!1;var a=moment(i).unix();if(a>moment().unix()&&a>moment(t).unix()){for(var r=0;r<e.length;r++){var o=e[r],l=s.remindTime(t,o.trigger);if(moment(l).unix()===moment(i).unix())return!1}return!0}return!1},getCalTime:function(){var e=this.get("dueDate");if(this.get("isAllDay")){var t=l.getDailyRemindTime(),i=moment(e).format("YYYY-MM-DDT")+t;e=moment.utc(i)}return e},_reducedErrorReminder:function(){var e=this.get("reminders"),t=this.get("dueDate"),i=this.get("reminder"),n=!1;if(t){if(_.isEmpty(e)&&i){var s={id:ObjectId(),trigger:i};this.set("reminders",[s]),this.set("isAllDay",!1),n=!0}null===this.get("isAllDay")&&(_.isEmpty(e)?(this.set("isAllDay",!0),n=!0):(this.set("isAllDay",!1),n=!0)),n&&this.save()}},hasReminder:function(){var e=this.get("reminders"),t=this.get("dueDate"),i=this.get("status");if(i)return!1;if(!t||_.isEmpty(e))return!1;if(this.hasSnoozeTime())return!0;if(u.hasReminders(e)&&t){for(var n=this.getCalTime(),a=0;a<e.length;a++){var o=e[a],l=s.remindTime(n,o.trigger),c=r.prefMoment(l).diff(r.prefMoment().startOf("minute"),"minutes");if(c>0)return!0}return!1}return!1},formatItemDuedate:function(){var e=this.get("dueDate"),t=this.get("isAllDay");return l.getListItemDueDateForList(e,t)},isNormal:function(){return 0===this.get("status")},dumpInTemp:function(e){this.beforeChange=JSON.parse(JSON.stringify(e))},prviousModel:function(){return new t.Model(this.previousAttributes())},_postAssignee:function(e){c.assign(JSON.stringify(e),function(e){_.isEmpty(e.id2error)||o.log(e.id2error)})},_setAssignee:function(e){var t=[];t.push({projectId:this.get("projectId"),taskId:this.get("id"),assignee:e}),this._postAssignee(t)},delAssignee:function(){this.set({assignee:null},{silent:!0}),this._setAssignee(-1)}})}),define("collection/task",["require","exports","module","service/sort","utils/timeformat","model/task"],function(e,t){var i=e("service/sort").rank,n=e("utils/timeformat");t.Collection=Backbone.Collection.extend({model:e("model/task").Model,orderBy:function(e){return this.comparator=i[e],this.sort()},orderByPlus:function(e){return"modifiedTime"===e?(this.comparator=function(t){var i=n.prefMoment(t.get(e)).unix();return-i},this.sort()):this.orderBy(e)}})}),define("model/calendar",["require","exports","module","utils/timeformat","configs/settings","utils/browser","configs/dict","model/task"],function(e,t){var i=e("utils/timeformat"),n=e("configs/settings"),s=e("utils/browser"),a=e("configs/dict"),r=e("model/task").Model;t.Model=r.extend({defaults:{title:"",content:"",sortOrder:0,priority:0,projectId:a.smartProjectId.subscribe,dueDate:null,status:0,items:[]},initDay:function(){var e=this.get("dueStart"),t=this.get("dueEnd"),a=i.prefMoment(e),r=i.prefMoment(t);(r-a)%n.aDayTime===0&&r-a!==0&&(this.set({allDay:!0,isAllDay:!0}),s.isIE||this.set("dueStart",moment(e)._d.setUTCHours(0,0,1)));var o=this.get("isAllDay")?null:[{id:ObjectId(),trigger:"TRIGGER:PT0S"}];this.set({dueDate:e,reminders:o},{silent:!0})},initContent:function(){},hasReminder:function(){var e=this.get("dueDate");if(!e)return!1;var t=i.prefMoment(e).diff(i.prefMoment().startOf("minute"),"minutes");return t>0?!0:!1},willRepeat:function(){return!1},subtaskNotText:function(){return!1},save:function(){},hasContent:function(){return!1},hasAssign:function(){return!1},toggleModelComplete:function(){return!1}})}),define("collection/calendar",["require","exports","module","model/calendar"],function(e,t){t.Collection=Backbone.Collection.extend({model:e("model/calendar").Model})}),define("model/plugin",["require","exports","module"],function(e,t){t.Model=Backbone.Model.extend({defaults:{}})}),define("collection/plugin",["require","exports","module","configs/settings","model/plugin"],function(e,t){var i=e("configs/settings");t.Collection=Backbone.Collection.extend({model:e("model/plugin").Model,url:i.API_HOST+"/plugins"})}),define("modules/mini-kalendae/kalendae",["require","exports","module","offline/storage","utils/analytics"],function(e,t){var i=e("offline/storage"),n=e("utils/analytics"),s=function(e,t){var i=this;return _.extend(t,{switchMonthAndDay:function(){i.switchMonthAndDay()}}),this.kalendae=new Kalendae(e,t),this.$el=$(e).find(".kalendae"),this.$kal=this.$el.find(".k-calendar"),this.$header=this.$el.find(".k-header"),this.$days=this.$el.find(".k-days"),this.topClass=".k-top",this.localKey="calendar_view_opened",this.init(),this.kalendae};s.prototype={analyEvent:function(){this.$el.find(".date-toggle").click(function(){n.m_btn("open_month")}),this.$el.find(".k-btn-previous-month").click(function(){n.m_btn("last_month")}),this.$el.find(".k-btn-next-month").click(function(){n.m_btn("next_month")}),this.$el.find(".k-btn-today").click(function(){n.m_btn("today")})},init:function(){this.initBase(),this.renderTop(),this.messages(),this.analyEvent(),this.initMiniStatus()},messages:function(){var e=this;this.$el.find(this.topClass).on("click",function(){e.toggleFullAndMini()})},initMiniStatus:function(){this.opened||this.changeToMini(),this.initAntiscroll(),this.resizeProjectList()},switchMonthAndDay:function(){this.resizeProjectList()},refreshKalendae:function(){this.kalendae.viewStartDate=moment().hour(12).date(1),this.kalendae.draw()},initAntiscroll:function(){$("#project-list-view .project-list-inner").antiscroll()},resizeProjectList:function(){var e=this;setTimeout(function(){var t=e.$el.outerHeight();$("#project-list-view").css("padding-bottom",t)},201)},renderTop:function(){this.$kal.prepend('<div class="k-top fast-transition"><div class="fake-enlarge-mini-cal"></div><div class="fake-narrow-mini-cal"></div></div>')},toggleFullAndMini:function(){this.opened?(this.changeToMini(),this.refreshKalendae(),n.m_btn("collpase")):(this.changeToFull(),n.m_btn("expand")),this.opened=!this.opened,this.resizeProjectList(),i.setCacheItem(this.localKey,this.opened)},initBase:function(){var e=this.$days.find("span").index($(".k-today"))+1,t=parseInt(e/7)+1;this.ltNum=7*(t-1),this.gtNum=7*t-1;var n=i.getCacheItem(this.localKey);this.opened=n,null===n&&(this.opened=!1,i.setCacheItem(this.localKey,this.opened))},changeToMini:function(){this.$el.find(".nav-open").removeClass("nav-open"),this.$el.find(".nav-selector").removeClass("open"),this.$el.addClass("collpase"),this.$days.find("span:lt("+this.ltNum+")").animate({height:0},200).hide(200),this.$days.find("span:gt("+this.gtNum+")").animate({height:0},200).hide(200)},changeToFull:function(){this.$el.find(".k-btn-next-month, .k-btn-previous-month").show(),this.$el.removeClass("collpase"),this.$days.find("span").animate({height:31},200).show()}},t.KalendaeMini=s}),define("plugins/calendar",["require","exports","module","configs/status","configs/dict","lang/index","utils/hash","utils/dom","service/prefs","utils/string","utils/timeformat","model/plugin","modules/mini-kalendae/kalendae"],function(e,t){var i=e("configs/status"),n=e("configs/dict"),s=e("lang/index"),a=(e("utils/hash"),e("utils/dom")),r=e("service/prefs"),o=(e("utils/string"),e("utils/timeformat"),e("model/plugin").Model),l=e("modules/mini-kalendae/kalendae").KalendaeMini;t.Model=o.extend({initialize:function(){this.set({id:n.pluginId.calendar,title:s.get("plugin_calendar_title"),description:s.get("plugin_calendar_content")})},installation:function(){i.calendar=new l(document.getElementById("datepicker"),{months:1,mode:"single",dayOutOfMonthClickable:!0,weekStart:r.getWeekStartDay(),useYearNav:!1,navSelector:!0,daysWithColor:!0,subscribe:{change:function(){$("#task-action-bar").hide(),a.highlightDatesWhichHasTask(),window.location.href="#d/"+this.getSelected()+"/tasks"},"after-drawn":a.highlightDatesWhichHasTask}}),$("#datepicker").on("mouseenter",function(){i.dropOnMinCalendar=!0}),$("#datepicker").on("mouseleave",function(){i.dropOnMinCalendar=!1}),$(".k-days span").droppable({accept:".task",tolerance:"pointer",hoverClass:"calendar-drag-hovered",drop:function(e,t){var n=$("#task-ul-list ul>li.addClassDrag.selected");n=$(n.length>0?"#task-ul-list ul>li.selected":"#task-ul-list ul>li.addClassDrag");var s=$(this).attr("data-date");Backbone.trigger("setNewTaskDate",s,n),i.dropOnMinCalendar=!0}}),Backbone.trigger("updateCalendarDatesWithTask"),Backbone.on("refresh",function(){Backbone.trigger("updateCalendarDatesWithTask")})}})}),define("plugins/task-activity",["require","exports","module","lang/index","configs/dict","model/plugin"],function(e,t){var i=e("lang/index"),n=e("configs/dict"),s=e("model/plugin").Model;t.Model=s.extend({initialize:function(){this.set({id:n.pluginId.taskActivity,title:i.get("plugin_task_activity_title"),description:i.get("plugin_task_activity_content")})},installation:function(){}})}),define("plugins/tag",["require","exports","module","configs/settings","model/plugin","lang/index","configs/dict"],function(e,t){var i=(e("configs/settings"),e("model/plugin").Model),n=e("lang/index"),s=e("configs/dict");t.Model=i.extend({initialize:function(){this.set({id:s.pluginId.tag,title:n.get("plugin_tag_title"),description:n.get("plugin_tag_content")})},installation:function(){$(".l-tabs").removeClass("disabled-tag")}})}),define("plugins/calendarSubscribe",["require","exports","module","lang/index","configs/dict","model/plugin"],function(e,t){var i=e("lang/index"),n=e("configs/dict"),s=e("model/plugin").Model;t.Model=s.extend({initialize:function(){this.set({id:n.pluginId.calSubscribe,title:i.get("plugin_calendar_subscribe_title"),description:i.get("plugin_calendar_subscribe_content")})},installation:function(){Backbone.trigger("showSubscribe")}})}),define("plugins/tkcalendar",["require","exports","module","model/plugin","lang/index","configs/dict"],function(e,t){var i=e("model/plugin").Model,n=e("lang/index"),s=e("configs/dict");t.Model=i.extend({initialize:function(){this.set({id:s.pluginId.tkcalendar,title:n.get("plugin_tkcalendar_title"),description:n.get("plugin_tkcalendar_content")})},installation:function(){}})}),define("plugins/duplicate",["require","exports","module","lang/index","configs/dict","model/plugin"],function(e,t){var i=e("lang/index"),n=e("configs/dict"),s=e("model/plugin").Model;t.Model=s.extend({initialize:function(){this.set({id:n.pluginId.duplicate,title:i.get("plugin_duplicate_title"),description:i.get("plugin_duplicate_content")})},installation:function(){}})}),define("plugins/search",["require","exports","module","lang/index","configs/dict","model/plugin"],function(e,t){var i=e("lang/index"),n=e("configs/dict"),s=e("model/plugin").Model;t.Model=s.extend({initialize:function(){this.set({id:n.pluginId.search,title:i.get("plugin_search_title"),description:i.get("plugin_search_content")})},installation:function(){}})}),define("service/plugin",["require","exports","module","utils/server","configs/dict","collection/plugin","plugins/calendar","plugins/task-activity","plugins/tag","plugins/calendarSubscribe","plugins/tkcalendar","plugins/duplicate","plugins/search","offline/storage"],function(e,t){var i=e("utils/server"),n=e("configs/dict"),s=e("collection/plugin").Collection,a=e("plugins/calendar").Model,r=e("plugins/task-activity").Model,o=e("plugins/tag").Model,l=e("plugins/calendarSubscribe").Model,c=e("plugins/tkcalendar").Model,d=e("plugins/duplicate").Model,u=(e("plugins/search").Model,e("offline/storage")),h=[new o,new d,new c,new l,new r,new a],p=new s(h),m={};return{loadPlugins:function(){return p},installPlugins:function(){var e=m;this.setPlugin(e)},setPlugin:function(e){_.each(e,function(e){var t=p.get(e.id);t&&(t.set("enabled",e.enabled),1==t.get("enabled")&&t.installation())})},installationBeforeRendering:function(e){i.getPlugin(function(e){m=e;var t=null,i=null;_.each(e,function(e){e.id==n.pluginId.tag&&(t=e)}),t?(i=p.get(t.id),i&&(i.set("enabled",t.enabled),1==i.get("enabled")&&i.installation())):u.setStoreInfo("list_tag_tab",0)})},getPlugin:function(e){return p.get(e)},applyChanges:function(e){i.setPluginSetting(JSON.stringify(p.models),function(){e&&e()})},isPluginEnable:function(e){var t=this.getPlugin(e);return t?t.get("enabled"):!1}}}),define("dao/scalendardb",["require","exports","module","configs/settings","utils/timeformat","utils/task-util","utils/server","service/filter","configs/dict","utils/calculate","collection/calendar","service/plugin","service/userProfile","offline/storage","utils/hash"],function(e,t,i){var n=e("configs/settings"),s=e("utils/timeformat"),a=e("utils/task-util"),r=e("utils/server"),o=e("service/filter"),l=e("configs/dict"),c=(e("utils/calculate"),e("collection/calendar").Collection),d=(e("service/plugin"),e("service/userProfile")),u=e("offline/storage"),h=e("utils/hash");t.db={calendarList:{},dirtyList:[],initByLocal:function(){var e=this,t=u.getCacheItem(l.cachePath.subscribeEvents);_.each(t,function(t,i){e.calendarList[i]=new c,e.calendarList[i].reset(t)})},getAllCalendar:function(e,t){if(!d.isPro())return[];_.isEmpty(this.dirtyList)||(this._setCalendarEventFromDirty(),this._setLocalEvent());var i=this.getAllCalendarFromLocal();if(!e)return i;if(t&&this.isNeedLimitRequest())return i;var n=this;return r.getSubscribeEvent(function(e){if(t&&(n.timeForCalendar=new Date),_.isString(e)&&e.length)var e=JSON.parse(e);n._resetCalendarEvent(e),Backbone.trigger("refresh")}),i},getAllCalendarFromLocal:function(){var e=[];return _.each(this.calendarList,function(t){e=e.concat(t.models)}),e},getCalendar:function(e,t){if(!d.isPro())return[];var i=this.getTaskByCalendar(t);if(!e)return i;var n=this;return Backbone.trigger("fetch"),r.getSubscribeEvent(function(e){if(_.isString(e)&&e.length)var e=JSON.parse(e);_.isEmpty(e)||(n._setCalendarEvent(e),n._setLocalEvent(),Backbone.trigger("renderCalenderProjectName",e.id,e.name)),Backbone.trigger("refresh")},t),_.clone(i)},getCalendarById:function(e){var t;return _.each(this.calendarList,function(i){t=t||i.get(e)}),t},isNeedLimitRequest:function(){var e=0;return this.timeForCalendar&&(e=new Date-this.timeForCalendar),!e||e>n.getCalendarTime?!1:!0},getTaskByCalendar:function(e){return this.calendarList[e]?this.calendarList[e].models:[]},deleteCalendar:function(e,t){this.calendarList&&this.calendarList[e]&&this.calendarList[e].reset(),delete this.calendarList[e],r.deleteCalendarSubscribe(e,function(){t&&t()})},getOnTimeSCalendarTasks:function(){var e=[];return _.each(this.calendarList,function(t){e=e.concat(t.filter(o.filter.onTimeTasks))}),e},_resetCalendarEvent:function(e){var t=this;this.calendarList={},_.each(e,function(e){t._setCalendarEvent(e),Backbone.trigger("renderCalenderProjectName",e.id,e.name)}),this._setLocalEvent()},_setCalendarEvent:function(e){h.isInSubscribeCalendars()&&h.getProjectIdByUrl()===e.id?this._setCalendarEventModel(e):this.dirtyList.push(e)},_setCalendarEventModel:function(e){var t=this.calendarList[e.id]||new c,i=[],n=s.prefMoment(new Date).format("YYYY-MM-DD");_.each(e.events,function(e){var r=(s.prefMoment(e.dueStart),s.prefMoment(e.dueEnd));if(r.format("YYYY-MM-DD")==n&&"00:00:00"==moment(e.dueEnd).utc().format("HH:mm:ss")&&r.utc().subtract(1,"s"),!(r.format("YYYY-MM-DD")<n)||e.repeatFlag){var o=new t.model(e);if(o.initDay(),o.set("id",e.uid),r.format("YYYY-MM-DD")<n&&e.repeatFlag&&a.autoCreateNextRepeat(o),o.get("dueEnd")){var l=s.prefMoment(o.get("dueEnd")).format("YYYY-MM-DD");l>=n&&i.push(o)}}}),t.reset(i),this.calendarList[e.id]=t},_setCalendarEventFromDirty:function(){for(var e=[];this.dirtyList.length;)e=this.dirtyList.pop(),this._setCalendarEventModel(e)},_setLocalEvent:function(){u.setCacheItem(l.cachePath.subscribeEvents,this.calendarList)}},t.db.initByLocal()}),define("collection/calendarTaskCollection",["require","exports","module","collection/task","service/sort","model/task"],function(e,t){var i=e("collection/task").Collection,n=e("service/sort").rank;t.Collection=i.extend({model:e("model/task").Model,message:function(){this.on("change:dueDate change:status change:priority change:content change:reminders",this.sortByDueDate,this),this.on("add",this.sortByDueDate,this)},initialize:function(){this.message(),this.comparator=n.calendar},sortByDueDate:function(){this.sort()}})}),define("dao/calendardb",["require","exports","module","utils/server","service/filter","configs/dict","dao/scalendardb","collection/calendarTaskCollection"],function(e,t,i){var n=e("utils/server"),s=e("service/filter"),a=e("configs/dict"),r=e("dao/scalendardb").db,o=e("collection/calendarTaskCollection").Collection;t.db={refreshTasksByDueDateRangeForTKCalendar:function(e,t){var i=moment(e),s=moment(t),o=i.format(a.format.atomTime),l=s.format(a.format.atomTime),c=this;n.getTasksByRangeDueDate(o,l,function(e){var t=c._addCollection(e);t=t.concat(r.getAllCalendar(!0,!0)),c._syncLocalTask(i,s,t)})},_syncLocalTask:function(e,t,i){var n=t.diff(e,"days"),s=this,a=e.year(),r=e.month(),l=Number(e.format("DD")),c=[];for(this.calendarCollectionMap||this._initCalendarCollectionMapForTKCalendar(),this.serverTempCol={},_.each(i,function(e){var t=moment(e.dueDate||e.get("dueDate")).format("YYYY-MM-DD");s.serverTempCol[t]||(s.serverTempCol[t]=new o),s.serverTempCol[t].add(e,{merge:!0,silent:!0})}),index=0;index<n;index++){var d=moment(new Date(a,r,l+index)).format("YYYY-MM-DD");this._syncTwoCollection(this.calendarCollectionMap[d],this.serverTempCol[d])&&c.push(d)}c=_.union(c),_.each(c,function(e){s.calendarCollectionMap[e].trigger("add")})},getTaskByDueDateForTKCalendar:function(e){this.calendarCollectionMap||this._initCalendarCollectionMapForTKCalendar();var t=moment(e).format("YYYY-MM-DD");return this.calendarCollectionMap[t]||(this.calendarCollectionMap[t]=new o),this.calendarCollectionMap[t]},_initCalendarCollectionMapForTKCalendar:function(){this.calendarCollectionMap||(this.calendarCollectionMap={});var e=this.collection.filter(s.filter.getInAllTasksWithDueDate),t=this;_.each(e,function(e){if(!e.get("dueDate"))return!1;var i=moment(e.get("dueDate")).format("YYYY-MM-DD");t.calendarCollectionMap[i]||(t.calendarCollectionMap[i]=new o),t.calendarCollectionMap[i].add(e,{merge:!0,silent:!0})})},_syncTwoCollection:function(e,t){if(e||(e=new o),t||(t=new o),e.models.length===t.models.length){for(var i=t.models.length-1;i>=0;i--){var n=t.models[i],s=e.get(n.get("id"));if(!s)return e.set(t.models,{merge:!0,silent:!0}),!0;if(s.get("etag")!=n.get("etag"))return e.set(t.models,{merge:!0,silent:!0}),!0}return!1}return e.set(t.models,{merge:!0,silent:!0}),!0},add:function(e){this.collection.add(e)},getById:function(e){return _.isEmpty(r.getCalendarById(e))?this.collection.get(e):r.getCalendarById(e)},_addCollection:function(e){this.collection.add(e,{merge:!0,silent:!0});var t=[];return _.each(e,function(e){t.push(this.collection.get(e.id))},this),t},clearCalendarData:function(){this.calendarCollectionMap=null}}}),define("dao/taskdb",["require","exports","module","offline/storage","configs/dict","service/filter","service/sort","configs/status","utils/server","utils/string","utils/timeformat","collection/task","collection/task","dao/scalendardb","dao/calendardb","utils/log","utils/hash"],function(e,t,i){var n=e("offline/storage"),s=e("configs/dict"),a=e("service/filter"),r=e("service/sort"),o=e("configs/status"),l=e("utils/server"),c=e("utils/string"),d=e("utils/timeformat"),u=e("collection/task").Collection,h=e("collection/task").Collection,p=e("dao/scalendardb").db,m=e("dao/calendardb").db,f=e("utils/log"),g=e("utils/hash"),v=new u,y=new h,k={};v.reset(n.getCacheItem(s.cachePath.tasks)),y.reset(n.getCacheItem(s.cachePath.trash)),v.models=_.filter(v.models,a.filter.modelHasId),m.collection=v,_.isUndefined(window.expose)&&(window.expose={}),v.on("add",function(){setTimeout(function(){Backbone.trigger("refreshAutoComplete")},500)}),t.db=window.expose.task={collection:v,trash:y,calendardb:m,pagination:k,dumpToLocalStorage:function(){n.setCacheItem(s.cachePath.tasks,v.toJSON()),n.setCacheItem(s.cachePath.trash,y.toJSON())},getTodoTasksInProject:function(e){var t=[];return t=this.collection.filter(function(t){return 0===t.get("status")&&t.get("projectId")===e})},getCompletedTasksInLocal:function(){return this.collection.filter(a.filter.completed)},fetchCompletedTasksPagination:function(e,t,i,n,s,a){var r=this;(!this.pagination.td||i)&&(this.pagination.td=d.formatDateForCompleted(new Date),this.pagination.fd=""),a&&i&&(a.td&&(this.pagination.td=a.td),a.fd&&(this.pagination.fd=a.fd)),s&&(this.pagination.fd=d.getUtcTodayStart()),n?l.getCompletedTasksShowInAll(e,this.pagination,t,function(e){r.handleCompleteTasksFromServer(e)}):l.filterCompletedAndArchivedTasks(e,this.pagination,t,function(e){r.handleCompleteTasksFromServer(e)})},handleCompleteTasksFromServer:function(e){e.length>0?(this.pagination.td=d.formatDateForCompleted(e[e.length-1].completedTime),Backbone.trigger("showMoreCompletedTasks",this.commonHandleDataInPagination(e,this.collection))):Backbone.trigger("showMoreCompletedTasks",[])},getTrashTasksInLocal:function(){return this.trash.filter(a.filter.deleted)},popTrashTasksInLocal:function(e){for(;this.trash.length>e;)this.trash.pop()},fetchTrashTasksPagination:function(e,t,i,n,s){var a=this;(!this.pagination.start||i)&&(this.pagination.start=0),-1!==this.pagination.start&&l.getTrashTasksByPagination(this.pagination.start,t,function(e){a.pagination.start=e.nextStart;var t=a.commonHandleDataInPagination(e.tasks,a.trash);t.sort(r.rank.modifiedTime),Backbone.trigger("showMoreTrashTasks",t,i)})},commonHandleDataInPagination:function(e,t){var i=[];return e.length>0?(t.add(e,{merge:!0,silent:!0}),_.each(e,function(e){i.push(t.get(e.id))})):t.reset(),i},getCompletedAndArchivedTasksByProjectIdFromLocal:function(e,t){var i=t,n=[],s=e.split(",");return n=i.collection.filter("all"===e?function(e){return 0!=e.get("status")}:function(e){return 0!=e.get("status")&&-1!==s.indexOf(e.get("projectId"))}),_.each(n,function(e){0!=e.get("status")&&null==e.get("completedTime")&&e.set("completedTime",e.get("modifiedTime"),{silent:!0})}),n},getCompleteAndArchivedTasksByRange:function(e,t,i){l.filterCompletedAndArchivedTasks(e,t,"",i)},getCompletedAndArchivedTasksByProjectIds:function(e,t,i,n){"tasks"===e&&(e="all"),localFilterFunction=this.getCompletedAndArchivedTasksByProjectIdFromLocal;var s=this._getCompletedTaskListByPagination(localFilterFunction,e,"completedTime",e,this.collection,t,i,n);return s},_getCompletedTaskListByPagination:function(e,t,i,n,s,a,r,c){var h=this;if(this.pagination.pageSize=c?c:this.pagination.pageSize,r&&(this.pagination.fd=g.isInToday()||g.isInWeek()?d.formatToGetCompletedString(d.getTodayStart()):"",this.pagination.td=d.formatToGetCompletedString(new Date),this.pagination.sendingStart=-1,this.pagination.pageSize=c?c:50,this.pagination.serverLastRecordTime=0,this.pagination.ids=[]),-1!=this.pagination.sendingStart){var p={tasks:[],hasMore:!0};return p}var m=e(n,this),f=new u(m);f=f.orderByPlus(o.CurrentSortType);var v=f.filter(function(e){return-1===_.indexOf(h.pagination.ids,e.id)});if(f=new u(v.slice(0,this.pagination.pageSize)),f.models.length>0&&(this.pagination.ids=_.union(this.pagination.ids,_.pluck(f.models,"id"))),a&&""!==this.pagination.td&&this.pagination.td!==this.pagination.sendingStart){this.pagination.sendingStart=this.pagination.td;var y=l.filterCompletedAndArchivedTasks;(g.isInToday()||g.isInWeek()||g.isInProjectAll())&&(y=l.getCompletedTasksShowInAll),y(t,this.pagination,this.pagination.pageSize,function(t){if(h.pagination.td="",t.length>0){h.pagination.td=d.formatToGetCompletedString(t[t.length-1].completedTime),_.each(t,function(e){0!==e.status&&null===e.completedTime&&(e.completedTime=e.modifiedTime)});var a=[],r=[],l=[];_.each(t,function(e){if(eachModel=s.get(e.id),eachModel){if(eachModel.get("etag")!==e.etag){var t=eachModel.get(i);delete e.items,eachModel.set(e,{silent:!0}),t!=eachModel.get(i)&&a.push(eachModel)}}else eachModel=new h.collection.model(e),s.add(eachModel,{silent:!0}),r.push(eachModel)},this);var c=d.prefMoment(_.first(t)[i]).unix(),p=d.prefMoment(_.last(t)[i]).unix(),f=c;f<h.pagination.serverLastRecordTime&&(f=h.pagination.serverLastRecordTime);var g=e(n,h).filter(function(e){var t=d.prefMoment(e.get(i)).unix();return 0===h.pagination.serverLastRecordTime?t>=p:f>t&&t>=p}),v=_.pluck(t,"id"),y=_.difference(_.pluck(g,"id"),v);if(0!==y.length&&_.each(y,function(e){var t=s.get(e);h.collection.remove(t,{silent:!0}),l.push(t)},this),m=e(n,h),a.length>0&&Backbone.trigger("changePaginationTaskGroup",m,a),r.length>0){var k=m.concat(r),w=new u(k);w=w.orderByPlus(o.CurrentSortType);var b=new u(r);b=b.orderByPlus(o.CurrentSortType),Backbone.trigger("addPaginationTaskGroup",w.models,b.models),h.pagination.ids=_.union(h.pagination.ids,_.pluck(r,"id"))}l.length>0&&(Backbone.trigger("removePaginationTaskGroup",m,l),h.pagination.ids=_.difference(h.pagination.ids,_.pluck(l,"id"))),h.pagination.serverLastRecordTime=p}h.pagination.sendingStart=-1,t.length<h.pagination.pageSize&&(h.pagination.td="",Backbone.trigger("paginationDataUpdated"))},function(){h.pagination.sendingStart=-1,Backbone.trigger("fetchCompletedFailed")})}var p={tasks:f.models,hasMore:""===this.pagination.td?!1:!0};return p},_getTaskListByPagination:function(e,t,i,n,s,a,r,c,h){var p=this;if(this.pagination.pageSize=h?h:this.pagination.pageSize,c&&(this.pagination.list=e,this.pagination.start=0,this.pagination.sendingStart=-1,this.pagination.pageSize=h?h:50,this.pagination.serverLastRecordTime=0,this.pagination.ids=[]),-1!=this.pagination.sendingStart){var m={tasks:[],hasMore:!0};return m}var f=t(s,this),v=new u(f);v=v.orderByPlus(o.CurrentSortType);var y=v.filter(function(e){return-1===_.indexOf(p.pagination.ids,e.id)});v=new u(y.slice(0,this.pagination.pageSize)),v.models.length>0&&(this.pagination.ids=_.union(this.pagination.ids,_.pluck(v.models,"id")));var k=!1;0===v.length&&(k=!0),r&&-1!==this.pagination.start&&this.pagination.start!==this.pagination.sendingStart&&(this.pagination.sendingStart=this.pagination.start,l.getTasksByPagination(i,this.pagination.start,this.pagination.pageSize,function(e){if(p.pagination.start=e.nextStart,e.tasks.length>0){_.each(e.tasks,function(e){0!==e.status&&null==e.completedTime&&(e.completedTime=e.modifiedTime)});var i=[],r=[],l=[];_.each(e.tasks,function(e){if(eachModel=a.get(e.id),eachModel){if(eachModel.get("etag")!==e.etag){var t=eachModel.get(n);delete e.items,eachModel.set(e,{silent:!0}),t!=eachModel.get(n)&&i.push(eachModel)}}else eachModel=new p.collection.model(e),a.add(eachModel,{silent:!0}),r.push(eachModel)},this);var h=d.prefMoment(_.first(e.tasks)[n]).unix(),m=d.prefMoment(_.last(e.tasks)[n]).unix(),y=h;y<p.pagination.serverLastRecordTime&&(y=p.pagination.serverLastRecordTime);var w=t(s,p).filter(function(e){var t=d.prefMoment(e.get(n)).unix();return 0===p.pagination.serverLastRecordTime?t>=m:y>t&&t>=m}),b=_.pluck(e.tasks,"id"),T=_.difference(_.pluck(w,"id"),b);if(0!==T.length&&_.each(T,function(e){var t=a.get(e);p.collection.remove(t,{silent:!0}),l.push(t)},this),f=t(s,p),i.length>0&&Backbone.trigger("changePaginationTaskGroup",f,i),r.length>0){var I=f.concat(r),C=new u(I);C=C.orderByPlus(o.CurrentSortType);var x=new u(r);x=x.orderByPlus(o.CurrentSortType),Backbone.trigger("addPaginationTaskGroup",C.models,x.models),p.pagination.ids=_.union(p.pagination.ids,_.pluck(r,"id"))}l.length>0&&(Backbone.trigger("removePaginationTaskGroup",f,l),p.pagination.ids=_.difference(p.pagination.ids,_.pluck(l,"id"))),p.pagination.serverLastRecordTime=m}p.pagination.sendingStart=-1,(k||-1===e.nextStart)&&Backbone.trigger("paginationDataUpdated"),g.isInTrash()&&c&&(p.trash.remove(v.models,{silent:!0}),Backbone.trigger("refreshTrash",p.trash.set(e.tasks)))},function(){p.pagination.sendingStart=-1,Backbone.trigger("fetchCompletedFailed")}));var m={tasks:v.models,hasMore:-1===this.pagination.start?!1:!0};return m},getDeletedTasksByProjectIdFromLocal:function(e,t){var i=t,n=[];return n="tasks"===e?i.trash.models:i.trash.filter(function(t){return t.get("projectId")===e})},getDeletedTasksByProjectId:function(e,t,i){var n="/project/all/trash/pagination",s=this.getDeletedTasksByProjectIdFromLocal,a=this._getTaskListByPagination("trash_"+e,s,n,"modifiedTime",e,this.trash,t,i);return a},_contains:function(e,t){return""==t?!0:null==e?!1:-1!==String(e).indexOf(t)},getTasksBySearch:function(e){var t=this,i=[];return l.search("?"+e,function(e){t.collection.add(e,{merge:!0}),_.each(e,function(e,n){var s=t.collection.get(e.id);s.set({searchOrder:n},{silent:!0}),i.push(s)}),Backbone.trigger("showSearchResult",i)},function(){Backbone.trigger("showSearchResult",i)}),i},getTasksBySearchLocal:function(e){var t=e.dueFrom,i=e.dueTo,n=e.projectIds,s=e.statuss,a=$.trim(e.kw).split(/\s+/),r=this,o={
due:function(e){var n=moment(e.get("dueDate"));return e.get("dueDate")?t&&n.isBefore(t)?!1:i&&n.isAfter(i)?!1:!0:!1},list:function(e){return~n.indexOf(e.get("projectId"))?!0:!1},status:function(e){return~s.indexOf(e.get("status"))?!0:!1},keyword:function(e){for(var t,i=0;t=a[i++];){var n=e.get("title"),s=e.get("items");if(_.isEmpty(s)){var o=e.get("content")||"";if(!~n.indexOf(t)&&!~o.indexOf(t))return!1}else{var l=e.get("desc")||"";if(!~n.indexOf(t)&&!r._searchInSubtask(t,s)&&!~l.indexOf(t))return!1}}return!0}},l=this.collection.filter(function(e){return(!t&&!i||o.due(e))&&(_.isEmpty(n)||o.list(e))&&(_.isEmpty(s)||o.status(e))&&(_.isEmpty(a)||o.keyword(e))?!0:!1});return l.map(function(e){return e.set({searchOrder:9999},{silent:!0})}),l},_searchInSubtask:function(e,t){for(var i,n=0;i=t[n++];){var s=i.title||"";if(~s.indexOf(e))return!0}return!1},getTasksByAssignee:function(e,t){var i=this.collection.filter(function(i){return i.get("assignee")===e&&i.get("projectId")===t?!0:!1});return i},getTasksAssigned:function(e){var t=this.collection.filter(function(t){return t.hasAssign()&&t.get("projectId")===e?!0:!1});return t},getOnTimeTasks:function(){var e=this.collection.filter(a.filter.onTimeTasks);return e&&(e=_.filter(e,function(e){return e.get("projectId")===s.smartProjectId.subscribe?(f.log("subscribe task in taskdb"),!1):!0})),e},clearCompleted:function(e){var t="tasks"===e?"all":e;l.archiveCompletedTasks(t,function(){Backbone.trigger("refreshTagsList")});var i=this.getCompletedTasksByProjectId(e);_.each(i,function(e){e.set({status:2}),e.trigger("destroy")})},clearTrash:function(){l.clearTrashTasks(function(){y.reset(null)}),y.reset(null)},moveOutFromTrash:function(e,t,i){l.restoreTrash(t,JSON.stringify(e),null,i)},batchUpdateTasks:function(e){_.each(e,function(e){delete e.modifiedTime}),l.batchUpdateMutiTasks(JSON.stringify(e),function(){},function(){f.log("batch update error")})},getCompletedTasksByProjectId:function(e){var t=[];return t=this.collection.filter("tasks"===e?function(e){return 0!=e.get("status")}:function(t){return 0!=t.get("status")&&t.get("projectId")===e})},countCompletedTasksByProjectId:function(e){return this.getCompletedTasksByProjectId().length},getDatesHasTask:function(){var e=_.uniq(this.collection.pluck("dueDate")),t=[];return _.each(e,function(e){c.isValidDate(e)&&t.push(d.prefMoment(e).format("YYYY-MM-DD"))}),_.uniq(t)},getDatesHasNormalTaskInAll:function(){var e=this.collection.filter(function(e){return a.filter.getAllTodoTasks(e)&&e.isNormal()}),t=[];return _.each(e,function(e){var i=e.get("dueDate");c.isValidDate(i)&&t.push(d.prefMoment(i).format("YYYY-MM-DD"))}),_.uniq(t)},getById:function(e){return _.isEmpty(p.getCalendarById(e))?this.collection.get(e)||y.get(e):p.getCalendarById(e)},add:function(e){this.collection.add(e)},moveToTrash:function(e){e.set({deleted:1},{silent:!0}),this.collection.remove(e,{silent:!0}),e.get("title")||e.set("title",""),e.get("content")||e.set("content","");var t=e.get("title").length+e.get("content").length===0,i="";t&&(i="?deleteforever=true");var n={taskId:e.get("id"),projectId:e.get("projectId")};l.deleteTask(i,[n]),this.trash.add(e,{silent:!0}),Backbone.trigger("refreshTagsList"),Backbone.trigger("refresh")},batchMoveToTrash:function(e){var t=[];_.each(e,function(e){e.set({deleted:1},{silent:!0}),this.collection.remove(e,{silent:!0}),this.trash.add(e,{silent:!0}),t.push({taskId:e.get("id"),projectId:e.get("projectId")})},this),l.deleteMutiTasks(t),Backbone.trigger("refreshTagsList"),Backbone.trigger("refresh")},batchDeleteForever:function(e){var t=[];_.each(e,function(e){this.collection.remove(e,{slice:!0}),this.trash.remove(e,{slice:!0}),e.trigger("removeElement"),t.push({taskId:e.get("id"),projectId:e.get("projectId")})},this),l.deleteMutiTasksForever(t,function(){Backbone.trigger("refresh")})},moveFromTrash:function(e){e.set({deleted:0},{silent:!0}),this.collection.add(e,{silent:!0}),this.trash.remove(e,{silent:!0}),Backbone.trigger("refreshTagsList")},permanentDelete:function(e){this.trash.remove(e,{silent:!0})},stopShareToMyself:function(e){this.collection.remove(e,{silent:!0}),e.trigger("hideOnListView closeDetailView")},getTasksByProjects:function(e){var t=this,i=_.map(e,function(e){return e.get("id")});if(!_.isEmpty(i)){var n=i.join(",");l.getTodoTasksByProjectId(n,function(e){t.collection.add(e,{merge:!0})})}}}}),define("dao/original_version",["require","exports","module"],function(e,t){var i={set:function(e,t){this.db[e]=JSON.parse(JSON.stringify(t))},get:function(e){return this.db[e]},has:function(e){return _.isObject(this.db[e])},del:function(e){this.has(e)&&delete this.db[e]},clear:function(){this.db={}},reset:function(e){this.db=e||{}}},n={db:{}},s={db:{}};t.server=_.extend(n,i),t.client=_.extend(s,i)}),define("dao/original",["require","exports","module","dao/original_version","offline/storage","configs/dict"],function(e,t){var i=e("dao/original_version"),n=e("offline/storage"),s=e("configs/dict");t.dumpClient=function(e){_.isObject(e)&&i.client.set(e.id,JSON.parse(JSON.stringify(e)))},t.dumpServer=function(e){_.isObject(e)&&i.server.set(e.id,JSON.parse(JSON.stringify(e)))},t.dropClient=function(e){i.client.del(e)},t.dropServer=function(e){i.server.del(e)},t.hasClient=function(e){return i.client.has(e)},t.hasServer=function(e){return i.server.has(e)},t.getClient=function(e){return i.client.get(e)},t.getServer=function(e){return i.server.get(e)},t.dumpToLocalStorage=function(){n.setCacheItem(s.cachePath.original,i)},t._dumpInOriginalServer=function(e){!t.hasServer(e.get("id"))&&e.beforeChange&&t.dumpServer(e.beforeChange)},t._dumpInOriginalClient=function(e){t.dumpClient(e)};var a=n.getCacheItem(s.cachePath.original);n.setCacheItem(s.cachePath.original,{}),a&&!_.isEmpty(a)&&(i.client.db=JSON.parse(JSON.stringify(a.client.db)),i.server.db=JSON.parse(JSON.stringify(a.server.db))),Backbone.on("dumpInOriginalServer",t._dumpInOriginalServer),Backbone.on("dumpInOriginalClient",t._dumpInOriginalClient)}),define("utils/merge",["require","exports","module","utils/log","utils/analytics"],function(e,t){var i=e("utils/log"),n=e("utils/analytics");t.getAutoMergedTask=function(e,t,i){var i=JSON.parse(JSON.stringify(i));return e.etag!=t.etag&&(i=mergeTask(e,t,i)),i},mergeTask=function(e,t,s){s.status=getRevisedStatus(e.status,t.status,s.status),s.title=getRevisedTextByDiff(e.title,t.title,s.title),s.content=getRevisedTextByDiff(e.content,t.content,s.content),s.desc=getRevisedTextByDiff(e.desc,t.desc,s.desc),s.sortOrder=getRevisedSortOrder(e.sortOrder,t.sortOrder,s.sortOrder);try{s.items=getRevisedItems(e.items,t.items,s.items)}catch(a){n.error("merge_item_error"),i.log("merge subitem error ",a)}return s.dueDate=getRevisedSortOrder(e.dueDate,t.dueDate,s.dueDate),s.remindTime=getRevisedSortOrder(e.remindTime,t.remindTime,s.remindTime),s.reminders=getRevisedSortOrder(e.reminders,t.reminders,s.reminders),s.repeatFlag=getRevisedSortOrder(e.repeatFlag,t.repeatFlag,s.repeatFlag),s.priority=getRevisedSortOrder(e.priority,t.priority,s.priority),s.attachments=getRevisedAttachmentByDiff(e.attachments,t.attachments,s.attachments),s.tags=t.tags,s.etag=t.etag,s.commentCount=t.commentCount,s.deleted=t.deleted,s},getRevisedItems=function(e,t,i){var n,s,a={},r={},o={};for(var l in e)a[e[l].id]=e[l];for(var l in i)r[i[l].id]=i[l];for(var l=t.length;l--;)o[t[l].id]=t[l],t[l]=t[l]?t[l]:"",r[t[l].id]?(n=r[t[l].id]?r[t[l].id]:"",s=a[t[l].id]?a[t[l].id]:"",r[t[l].id].status=getRevisedStatus(s.status,t[l].status,n.status),r[t[l].id].title=getRevisedTextByDiff(s.title,t[l].title,n.title),r[t[l].id].sortOrder=getRevisedSortOrder(s.sortOrder,t[l].sortOrder,n.sortOrder)):a[t[l].id]?(s=a[t[l].id],t[l].title==s.title&&t[l].status==s.status||(r[t[l].id]=t[l])):r[t[l].id]=t[l];for(var l in e){var c=e[l].id;o[c]||r[c]&&r[c].title==e[l].title&&r[c].status==e[l].status&&(r[c].needDelete=!0)}var d=[];for(var l in r)r[l].needDelete||d.push(r[l]);return d},getRevisedAttachmentByDiff=function(e,t,i){if(!e)return t;if(!i)return t;var n=e.length;if(n!=i.length)return i;for(var s=0;n>s;s++)if(e[s].fileName!=i[s].fileName||e[s].fileType!=i[s].fileType||e[s].id!=i[s].id||e[s].size!=i[s].size)return i;return t},getRevisedSortOrder=function(e,t,i){return e==i?t:i},getRevisedStatus=function(e,t,i){return 0==e?max(e,t,i):min(e,t,i)},max=function(e,t,i){return t>e&&(e=t),i>e&&(e=i),e},min=function(e,t,i){return e>t&&(e=t),e>i&&(e=i),e},getRevisedTextByDiff=function(e,t,i){if(t==i||t==e)return i;var n=new diff_match_patch;return n.patch_apply(n.patch_make(e,t),i)[0]}}),define("model/userTags",["require","exports","module"],function(e,t){t.Model=Backbone.Model.extend({defaults:{taglist:[],tags:[]}})}),define("dao/userTagdb",["require","exports","module","model/userTags","configs/dict","offline/storage","service/plugin"],function(e,t){var i=e("model/userTags").Model,n=e("configs/dict"),s=new i,a=[],r=e("offline/storage"),o=e("service/plugin");t.db={getUserTagsModel:function(){var e=JSON.parse(localStorage.getItem("userTagsModel"));if(e){var t=s.get("tags"),i=e.tags,n=null,a=[];return t!=i?(a=_.keys(i),n=s.set({taglist:a,tags:i})):(a=_.keys(t),n=s.set({taglist:a,tags:t})),this.__setToUserTagsArrayForAuto(a),n}return s},setUserTagsModel:function(e){if(!_.isEqual(e,s.get("tags"))){var t=_.keys(e),i=s.get("taglist");s.set({taglist:t,tags:e}),this.autoCompleteTags(),this.__setToUserTagsArrayForAuto(t),localStorage.setItem("userTagsModel",JSON.stringify(s)),_.isEqual(t,i)&&Backbone.trigger("UpdateTagsCount")}},getUserTagsArrayForAuto:function(){return a},autoCompleteTags:function(){var e=this;o.isPluginEnable(n.pluginId.tag)&&$(".typeahead")&&$(".typeahead").typeahead({source:e.getUserTagsArrayForAuto(),limit:8,holder:[" ","\n"," ","　"],symbol:["＃","#"],matcher:function(e){return e.toLowerCase().match(this.Tick.matchStr.toLowerCase())?!0:!1},sorter:function(e){return e.sort()},addEvent:function(){this.$menu.on("mousedown",$.proxy(function(e){e.stopPropagation(),e.preventDefault(),this.select()},this)).on("mouseup",$.proxy(function(e){e.stopPropagation(),e.preventDefault()},this))},click:function(e){e.stopPropagation(),e.preventDefault()}})},getTagListOpenStatus:function(){return r.getStoreInfo(n.openType.tag)||"close"},setTagListOpenStatus:function(e){r.setStoreInfo(n.openType.tag,e)},__setToUserTagsArrayForAuto:function(e){for(var t=a.length;t--;)a.pop();for(var t=e.length;t--;)a.push(e[t])}}}),define("service/tag",["require","exports","module","dao/taskdb","dao/userTagdb","service/filter"],function(e,t){var i=e("dao/taskdb").db,n=e("dao/userTagdb").db,s=e("service/filter").filter;t._getTasksWithTags=function(){return i.collection.filter(s.todo)},t.updateTagsFromServer=function(){this.updateTags()},t.updateTags=function(){var e=[],t=this._getTasksWithTags();_.each(t,function(t){var i=t.get("tags");i&&_.each(i,function(t){e.push(t.toLowerCase())})}),e.sort();var i=_.countBy(e,function(e){return e});n.setUserTagsModel(i)}}),define("service/task",["require","exports","module","configs/settings","utils/server","configs/dict","service/filter","service/sort","utils/analytics","utils/dom","utils/string","offline/storage","utils/timeformat","dao/taskdb","dao/original","utils/merge","service/tag","utils/log","utils/hash"],function(e,t){var i=e("configs/settings"),n=e("utils/server"),s=e("configs/dict"),a=e("service/filter"),r=e("service/sort"),o=(e("utils/analytics"),e("utils/dom")),l=e("utils/string"),c=e("offline/storage"),d=e("utils/timeformat"),u=e("dao/taskdb"),h=e("dao/original"),p=e("utils/merge"),m=e("service/tag"),f=e("utils/log"),g=e("utils/hash");t.restore=function(e,t){var i=[];_.each(e,function(e){i.push({taskId:e.get("id"),projectId:e.get("projectId")}),e.set({projectId:t},{silent:!0}),u.db.moveFromTrash(e)}),Backbone.trigger("updateTaskOrderFromRestore",t,e),u.db.moveOutFromTrash(i,t,function(){_.each(e,function(e){e.trigger("hideOnListView")})})},t.getTasksCountByProject=function(e){var t=u.db.collection.filter(function(t){return 0==t.get("status")&&t.get("projectId")===e});return t.length},t.attachServerOriginal=function(e){var t=e.id;if(h.hasServer(t)){var i=JSON.parse(JSON.stringify(h.getServer(t)));e.originalVersion=i}return e},t.mergeSync=function(e){if(_.isNull(e))return null;var t=e.id,i=u.db.getById(t);if(!i)return e;if(i.get("etag")!=e.etag){if(h.hasClient(t)&&_.isObject(i)){var n=h.getClient(t),s=e,a=i.toJSON(),r=p.getAutoMergedTask(n,s,a);return this.clearOriginal(e),r}return this.clearOriginal(e),e}return this.clearOriginal(e),i.toJSON()},t.clearOriginal=function(e){h.dropServer(e.id),h.dropClient(e.id),u.db.getById(e.id).dumpInTemp(e)},t.checkDatesHasTask=function(e){var t=this._getNormalTasksInAllByDate(e);0===t.length&&(c.datesHasTask=_.without(c.datesHasTask,e),o.highlightDatesWhichHasTask())},t.markDatesHasTask=function(e){if(-1===_.indexOf(c.datesHasTask,e)){var t=this._getNormalTasksInAllByDate(e);t.length>0&&(c.datesHasTask.push(e),o.highlightDatesWhichHasTask())}},t.updateCalendarDatesWithTask=function(){c.datesHasTask=u.db.getDatesHasNormalTaskInAll(),o.highlightDatesWhichHasTask()},t.saveForCollapse=function(){u.db.dumpToLocalStorage(),h.dumpToLocalStorage()},t._merge=function(e,t,i,n){var s=this;_.each(e,function(e){eachModel=i.get(e.id),eachModel?eachModel.get("etag")!==e.etag&&(e=s.mergeSync(e),eachModel.set(e)):(eachModel=new i.model(e),i.add(eachModel,{silent:!0})),eachModel._reducedErrorReminder()});var a=_.pluck(e,"id"),r=_.difference(t,a);0!==r.length&&_.each(r,function(e){try{var t=i.get(e);t.isNew()||t.get("local")?(t.markDirty(),t.local=!0):i.remove(t,{silent:!0})}catch(n){f.log(n)}}),n&&n.apply()},t._dumpToLocal=function(e,t,n){n&&Backbone.trigger("refresh"),setTimeout(function(){c.setCacheItem(e,t.toJSON())},i.responsiveTime)},t._updateFromServer=function(e,t,i,n){var a=_.pluck(e,"id"),r=u.db.collection,o=s.cachePath.tasks,l=this;i&&Backbone.trigger("fetch"),n&&n(function(e){l._merge(e,a,r,function(){l._dumpToLocal(o,r,!0),m.updateTagsFromServer()})},function(){})},t.getInboxTasks=function(e){var t=this,i=[];return i=u.db.collection.filter(a.filter.getInboxTasks),e&&t._updateFromServer(i,!1,!0,n.getInboxTasks),i},t.getAllTodoTasks=function(e){var t=this,i=[];return i=u.db.collection.filter(a.filter.getAllTodoTasks),e&&t._updateFromServer(i,!1,!0,n.getAllTodoTasks),i},t.getTodayAndOverdueTasks=function(e){var t=this,i=[];return i=u.db.collection.filter(a.filter.getTodayAndOverdueTasks),e&&t._updateFromServer(i,!1,!0,n.getTodayAndOverdueTasks),i},t.getWeekAndOverdueTasks=function(e){var t=this,i=[];return i=u.db.collection.filter(a.filter.getWeekAndOverdueTasks),e&&t._updateFromServer(i,!1,!0,n.getWeekAndOverdueTasks),i},t.getTodoTasksByProjectIds=function(e,t){var i=this,s=[],a=e.split(",");return s=u.db.collection.filter(function(e){return-1!==a.indexOf(e.get("projectId"))}),t&&i._updateFromServer(s,!1,!0,function(t){n.getTodoTasksByProjectId(e,t)}),s},t.getAssignedMeTasks=function(){return u.db.collection.filter(a.filter.tasksAssignedMe)},t.getTodoTasksByProjectId=function(e,t){var i=this,s=[];return"tasks"==e?i.getAllTodoTasks(t):(s=u.db.collection.filter(function(t){return t.get("projectId")===e}),t&&i._updateFromServer(s,!1,!0,function(t){n.getTodoTasksByProjectId(e,t)}),s)},t.getTasksByDate=function(e,t){var i=this,a=u.db.collection.filter(function(t){return l.isValidDate(t.get("dueDate"))&&d.prefMoment(t.get("dueDate")).format("YYYY-MM-DD")===e});return t&&i._updateFromServer(a,!1,!0,function(t){var i=moment(e).format(s.format.atomTime),a=moment(d.getOneDayLater(e)).format(s.format.atomTime);n.getTasksByRangeDueDate(i,a,t)}),a},t._getNormalTasksInAllByDate=function(e,t){var i=this,s=u.db.collection.filter(function(t){return a.filter.getAllTodoTasks(t)&&t.isNormal()&&l.isValidDate(t.get("dueDate"))&&d.prefMoment(t.get("dueDate")).format("YYYY-MM-DD")===e});return t&&i._updateFromServer(s,!1,!0,function(t){n.getTasksByDate(e,t)}),s},t.clearTasksByProjectId=function(e){_.each(this.getTodoTasksByProjectId(e),function(e){u.db.collection.remove(e,{silent:!0}),e.trigger&&e.trigger("hideOnListView")}),_.each(u.db.getCompletedAndArchivedTasksByProjectIds(e),function(e){u.db.collection.remove(e,{silent:!0}),e.trigger&&e.trigger("hideOnListView")}),_.each(u.db.getDeletedTasksByProjectId(e),function(e){u.db.trash.remove(e,{silent:!0}),e.trigger&&e.trigger("hideOnListView")})},t.getMinSortOrder=function(e){var t=0,n=this.getTodoTasksByProjectId(e);if(n.length>0){var s=_.min(n,function(e){return e.get("sortOrder")});t=s==1/0?0-i.orderStep:Number(s.get("sortOrder"))-i.orderStep}return t},t.getMaxSortOrder=function(e){var t=0,n=this.getTodoTasksByProjectId(e);if(n.length>0){var s=_.max(n,function(e){return e.get("sortOrder")});t=Number(s.get("sortOrder"))+i.orderStep}return t},t.batchMoveToProject=function(e,t,s){var a=this.getMinSortOrder(t),r=[];_.each(e.reverse(),function(e){r.push({fromProjectId:e.get("projectId"),toProjectId:t,sortOrder:a,taskId:e.get("id")}),e.set({projectId:t,sortOrder:a}),a-=i.orderStep}),n.batchTasksMoveToProject(JSON.stringify(r),s)},t.moveToProject=function(e,t,i){var s=e.get("sortOrder"),a=e.get("projectId");a!==t&&(s=this.getMinSortOrder(t));var r={fromProjectId:a,toProjectId:t,taskId:e.get("id"),sortOrder:s};e.set("projectId",t),n.taskMoveToProject(JSON.stringify([r]),i)},t.refreshReminderTasks=function(e){var t=this,i=u.db;n.getReminder(function(e){_.each(e,function(e){eachModel=i.collection.get(e.id),eachModel?eachModel.get("etag")!==e.etag&&(e=t.mergeSync(e),eachModel.set(e,{silent:!0})):(eachModel=new i.collection.model(e),i.collection.add(eachModel,{silent:!0}))})},function(){e&&e()})},t.getTaskFromServerById=function(e,t,i){var s=this;g.isInTrash()||n.getTasks(e,t,function(t){if(t){t=s.mergeSync(t);var n=u.db.getById(e);n?n.set(t):n=u.db.collection.create(t),i&&i.apply(null,[n]),n.checkItemsOrder()}})},t.getCompletedTasksInLocal=function(e){var i=u.db.getCompletedTasksInLocal();return i.length>50&&(i.sort(r.rank.completedTime),i.length=50),e&&t.fetchCompletedTasksPagination("all",50,!0),i},t.getTrashTasksInLocal=function(){var e=u.db.getTrashTasksInLocal();return e.length>50&&(e.sort(r.rank.modifiedTime),e.length=50,u.db.popTrashTasksInLocal(50)),t.fetchTrashTasksPagination("all",50,!0),e},t.fetchCompletedTasksPagination=function(e,t,i,n,s,a){e&&"tasks"!==e||(e="all"),t||(t=50),u.db.fetchCompletedTasksPagination(e,t,i,n,s,a)},t.fetchTrashTasksPagination=function(e,t,i){e&&"tasks"!==e||(e="all"),t||(t=50),u.db.fetchTrashTasksPagination(e,t,i)},t.updateCalendarDateWithTask=function(e,t){var i=this._getNormalTasksInAllByDate(e),n=to=null;0===i.length&&(n=e),to=t,o.highlightDateHasTask(to,n)},t.setNewTaskDate=function(e,t){var i=[];_.each(t,function(t){var n=u.db.getById($(t).find("a").attr("taskid"));if(n){i.push(n);var a=n.get("dueDate"),r=d.dateToMoment(e).format(s.format.atomTime);if(l.isValidDate(a)){var o=d.prefMomentFromUtc(a);"1970"!=o.format("YYYY")&&(r=d.dateFormatToMoment(e+" "+o.format("HH:mm"),"YYYY-MM-DD HH:mm").format(s.format.atomTime))}n.set({dueDate:r})}}),u.db.batchUpdateTasks(i)},Backbone.on("updateCalendarDatesWithTask",this.updateCalendarDatesWithTask),Backbone.on("updateCalendarDateWithTask",this.updateCalendarDateWithTask,this),Backbone.on("setNewTaskDate",this.setNewTaskDate)}),define("dao/sync",["require","exports","module","service/task","dao/original","utils/log","utils/analytics"],function(e,t){var i=e("service/task"),n=e("dao/original"),s=e("utils/log"),a=e("utils/analytics"),r=!("undefined"==typeof window||!window.ActiveXObject||window.XMLHttpRequest&&(new XMLHttpRequest).dispatchEvent),o={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};Backbone.Model.prototype.sync=function(e,t,l){i.saveForCollapse();var c=o[e],d={type:c,dataType:"json"};if(l.url||(d.url=_.result(t,"url")||urlError()),null==l.data&&t&&("create"===e||"update"===e||"patch"===e)){d.contentType="application/json";var u=l.attrs||t.toJSON(l);n.dumpClient(u),d.data=JSON.stringify(i.attachServerOriginal(u))}if(l.emulateJSON&&(d.contentType="application/x-www-form-urlencoded",d.data=d.data?{model:d.data}:{}),l.emulateHTTP&&("PUT"===c||"DELETE"===c||"PATCH"===c)){d.type="POST",l.emulateJSON&&(d.data._method=c);var h=l.beforeSend;l.beforeSend=function(e){return e.setRequestHeader("X-HTTP-Method-Override",c),h?h.apply(this,arguments):void 0}}"GET"===d.type||l.emulateJSON||(d.processData=!1),"PATCH"===d.type&&r&&(d.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});var p=l.success;l.success=function(e){if(_.isFunction(p)){var t;try{t=i.mergeSync(e)}catch(n){a.error("sync_error"),s.log("sync error::",n),t=e}p(t)}};var m=l.xhr=Backbone.ajax(_.extend(d,l));return t.trigger("request",t,m,l),m}}),define("model/share-user",["require","exports","module"],function(e,t){t.Model=Backbone.Model.extend({})}),define("collection/share-user",["require","exports","module","model/share-user"],function(e,t){t.Collection=Backbone.Collection.extend({model:e("model/share-user").Model,comparator:function(e,t){var i=e.get("username"),n=t.get("username");return i.localeCompare(n)}})}),define("dao/shareduserdb",["require","exports","module","utils/server","dao/projectdb","collection/share-user","offline/storage","configs/dict","configs/settings","utils/log"],function(e,t,i){var n=e("utils/server"),s=e("dao/projectdb"),a=e("collection/share-user").Collection,r=e("offline/storage"),o=e("configs/dict"),l=e("configs/settings"),c=e("utils/log"),d=new a;d.reset(JSON.parse(r.getCacheItem(o.cachePath.shareUsers))),t.dumpToLocalStorage=function(){r.setCacheItem(o.cachePath.shareUsers,JSON.stringify(d.models))};var u={collection:d,init:function(){this.__update=_.debounce(this.__updateFromServer,l.responsiveTime)},updateFromServer:function(e){var t=this;try{t.__update(e)}catch(i){c.log(i)}},__updateFromServer:function(e){var t=this;n.getProjectShareUsers(e.get("id"),function(i){i=_.map(i,function(t){return t.id=t.userId,t.projectId=e.get("id"),t});var n=t.getUsersByProject(e,!1),s=_.chain(n).map(function(e){return e.toJSON()}).value(),a=function(e,t){return e.id<t.id},r=!0;if(i.length===s.length){r=!1;for(var o=i.sort(a),l=s.sort(a),c=0;c<o.length;c++)if(o[c].avatarUrl!==l[c].avatarUrl||o[c].displayName!==l[c].displayName||o[c].isAccept!==l[c].isAccept){r=!0;break}}r&&(t.collection.remove(n,{silent:!0}),t.collection.add(i,{merge:!0,silent:!0}),t.collection.sort(),t.collection.trigger("refreshUserCollection"))})},setUserAvatar:function(e,t){if(this.collection.get(e)){var i=this.collection.get(e);i.set("avatarUrl",t),this.collection.trigger("refreshUserCollection")}},getUsersByProject:function(e,t){var i=this.collection.filter(function(t){return t.get("projectId")===e.get("id")});return t&&this.updateFromServer(e),i},getUsersByProjectId:function(e,t){var i=this.collection.filter(function(t){return t.get("projectId")===e});if(t){var n=s.db.getProjectById(e);this.updateFromServer(n)}return i},getUserById:function(e){var t="",i=!1,n=this.collection.get(e);if(arguments.length>1&&(t=arguments[1],3===arguments.length&&(i=arguments[2])),!n&&t&&i){var a=s.db.getProjectById(t);_.isUndefined(a)||this.updateFromServer(a)}return n},getUserByEmail:function(e){var t=this.collection.filter(function(t){return t.get("username")===e&&!_.isEmpty(t.get("avatarUrl"))});return _.isEmpty(t)?"":t[0]},getAssignee:function(e){if(e.hasAssign()){var t=this.getUserById(e.get("assignee"),e.get("projectId"),!0);if(t){var i=null;return i=t.get("avatarUrl")||l.defaultAvatar,{avatar_url:i,display_name:t.get(t.get("displayName")?"displayName":"username")}}}return null},getAcceptedUsers:function(e,t){var i=this.getUsersByProjectId(e,t),n=i.filter(function(e){return e.get("isAccept")});return n}};u.init(),t.db=u}),define("utils/avatar",["require","exports","module","configs/settings","utils/timeformat","dao/shareduserdb"],function(e,t){var i=e("configs/settings"),n=e("utils/timeformat"),s=e("dao/shareduserdb");t.getGravatarUrl=function(e,t){var a="//"+i.cdn+"/static/img/avatar-new.png?v="+n.prefMoment().format("YYYYMMDD");if(e)var r=s.db.getUserById(e);else if(t)var r=s.db.getUserByEmail(t);return!_.isEmpty(r)&&r.get("avatarUrl")&&(a=r.get("avatarUrl")),a},t.getAvatarByEmail=function(e){var t="";if(e){var i=s.db.getUserByEmail(e);!_.isEmpty(i)&&i.get("avatarUrl")&&(t=i.get("avatarUrl"))}return t},t.getAvatar=function(e){return e?"/pub/user/avatar/"+e+"/avatar.png":""},t.getUserAvatar=function(e){var t="//"+i.cdn+"/static/img/avatar-new.png?v="+n.prefMoment().format("YYYYMMDD");return e?e:t}}),define("service/project",["require","exports","module","utils/hash","dao/projectdb","utils/log","utils/analytics","service/userProfile"],function(e,t){var i=e("utils/hash"),n=e("dao/projectdb").db,s=e("utils/log"),a=e("utils/analytics"),r=e("service/userProfile");return{getProjectsCount:function(){return n.normalProjectCount()},getCurrentProject:function(){var e=i.getProjectNameByUrl();if(!e)return void 0;var t=n.getProjectById(e);return t||(t=n.getProjectByName(decodeURIComponent(e))),t||(t=n.getSmartProjectById("tasks")),t},getCurrentDateProjectId:function(){try{var e=this.getCurrentProject().id;return"tasks"==e&&(e=i.getProjectNameByUrl()),e}catch(t){a.error("getDateProjectId_error"),s.log("sync error::",t)}},getUniqProjectId:function(){var e=this.getCurrentProject();if(_.isObject(e)){var t=e.get("id");return"tasks"==t&&(t=i.readUrl().type),t}},getProjectForCreateTask:function(){return i.isInProjectView()&&i.isInTasks()?this.getCurrentProject():n.getProjectById(r.get("inboxId"))},getFirstProjectByGroupId:function(e){var t=n.getProjectsByGroupId(e);return t[0]},getProjectNameById:function(e){var t="";if(""==e)return t=n.smartCollection.get(e).get("name");var i=n.getProjectById(e);return i&&(t=i.get("name")),t},getProjectIdByName:function(e){var t=n.getProjectByName(e);return t?t.id:null},isShareProejct:function(e){var t=n.getProjectById(e);return t&&parseInt(t.get("userCount"))>1?!0:!1},isInClosedProject:function(){var e=i.getHash().split("/");if("p"!==e[0])return!1;var t=e[1];return project=n.getProjectById(t),project?project.get("closed"):!1}}}),define("template/helper/all",["require","exports","module","configs/dict","utils/index","utils/condition","utils/avatar","configs/settings","lang/index","Handlebars","utils/hash","service/project","utils/string","utils/timeformat","service/plugin","service/prefs","dao/taskdb","dao/projectdb","service/userProfile","configs/regexp"],function(e,i){var n=e("configs/dict"),s=e("utils/index"),a=e("utils/condition"),r=e("utils/avatar"),o=e("configs/settings"),l=e("lang/index"),c=e("Handlebars"),d=e("utils/hash"),u=e("service/project"),h=e("utils/string"),p=e("utils/timeformat"),m=e("service/plugin"),f=e("service/prefs"),g=e("dao/taskdb").db,v=e("dao/projectdb").db,y=e("service/userProfile"),k=e("configs/regexp");c.registerHelper("ifequal",function(e,t,i){return e==t?i.fn(this):i.inverse(this)}),c.registerHelper("ifequalor",function(){for(var e=arguments.length,t=arguments[e-1],i=arguments[0],n=!1,s=1;e-1>s;s++)n=n||i===arguments[s];return n?t.fn(this):t.inverse(this)}),c.registerHelper("ifempty",function(e,t){return _.isEmpty(e)?t.fn(this):t.inverse(this)}),c.registerHelper("or",function(){for(var e=arguments[0],t=0;t<arguments.length-1;t++)e=e||arguments[t+1];return e}),c.registerHelper("for",function(e,t,i,n){for(var s="",a=e;t>a;a+=i)s+=n.fn(a);return s}),c.registerHelper("uppercase",function(e){return e.toUpperCase()}),c.registerHelper("I18n_date",function(e,t,i){var n=l.get(e);n&&(t=p.getDateFormat(t));var s=new RegExp("%s1","g");return n=n.replace(s,t),void 0!=n?n:e}),c.registerHelper("iftrue",function(e,t){return"true"==e||1==e?t.fn(this):t.inverse(this)}),c.registerHelper("iffalse",function(e,t){return"false"==e||0==e||null==e?t.fn(this):t.inverse(this)}),c.registerHelper("ifnotequal",function(e,t,i){return e!=t?i.fn(this):i.inverse(this)}),c.registerHelper("ifgreaterthan",function(e,t,i){return e>t?i.fn(this):i.inverse(this)}),c.registerHelper("iflessthan",function(e,t,i){return t>e?i.fn(this):i.inverse(this)}),c.registerHelper("ifpro",function(e){return y.isPro()?e.fn(this):e.inverse(this)}),c.registerHelper("ifcn",function(e){return o.isCnSites?e.fn(this):e.inverse(this)}),c.registerHelper("ifzh",function(e){return o.iscnlang?e.fn(this):e.inverse(this)}),c.registerHelper("ifInTasks",function(e){return d.isInTasks()?e.fn(this):e.inverse(this)}),c.registerHelper("ifInTkCalendar",function(e){return d.isInTKCalendar()?e.fn(this):e.inverse(this)}),c.registerHelper("ifInProjectAll",function(e){return d.isInProjectAll()&&d.isInTasks()?e.fn(this):e.inverse(this)}),c.registerHelper("ifNotInDisabledList",function(e){return d.isInSubscribeCalendars()||d.isInTrash()||u.isInClosedProject()||this.projectId&&a.isCalendarProject(this.projectId)?e.inverse(this):e.fn(this)}),c.registerHelper("ifInSubscribe",function(e){return d.isInSubscribeCalendars()?e.fn(this):e.inverse(this)}),c.registerHelper("ifInCompleted",function(e){return d.isInCompleted()?e.fn(this):e.inverse(this)}),c.registerHelper("ifInNormalProject",function(e){return d.isInProjectView()?e.fn(this):e.inverse(this)}),c.registerHelper("ifInNormalProjectWithoutShare",function(e){if(d.isInProjectView()){var t=d.getProjectIdByUrl(),i=v.getProjectById(t);return!i||i.get("userCount")>1||"inbox"==t?e.inverse(this):e.fn(this)}return e.inverse(this)}),c.registerHelper("ifInTrash",function(e){return d.isInSmartProjectView()&&d.isInTrash()?e.fn(this):e.inverse(this)}),c.registerHelper("ifInToday",function(e){return d.isInSmartProjectView()&&d.isInToday()?e.fn(this):e.inverse(this)}),c.registerHelper("ifNotInTodayOrWeek",function(e){return d.isInTodayOrWeek()?e.inverse(this):e.fn(this)}),c.registerHelper("ifInAssignedMe",function(e){return d.isInAssignedMe()?e.fn(this):e.inverse(this)}),c.registerHelper("ifIsShareProject",function(e){var t=d.getProjectIdByUrl(),i=v.getProjectById(t);return i&&i.get("userCount")>1?e.fn(this):e.inverse(this)}),c.registerHelper("ifNotInTrash",function(e){return 0==d.isInTrash()?e.fn(this):e.inverse(this)}),c.registerHelper("ifNotInAssignedMe",function(e){return d.isInAssignedMe()?e.inverse(this):e.fn(this)}),c.registerHelper("ifNotInCompleted",function(e){return 0==d.isInCompleted()?e.fn(this):e.inverse(this)}),c.registerHelper("ifInClosed",function(e){return u.isInClosedProject()?e.fn(this):e.inverse(this)}),c.registerHelper("ifNotDeletedAndClosed",function(e){return d.isInTrash()||u.isInClosedProject()?e.inverse(this):e.fn(this)}),c.registerHelper("ifSubtaskNotText",function(e){var t=this.items||this.model.items;return t.length>0?e.fn(this):e.inverse(this)}),c.registerHelper("ifWillRepeat",function(e){return this.model.repeatFlag?e.fn(this):e.inverse(this)}),c.registerHelper("getAllProjectRestore",function(e,t){var i="",n=v.collection;n.sort();for(var s=0;s<v.normalProjectCount();s++){var a=n.at(s);if(a.get("name")!=l.get("list_all")){var r;r=a.id==e?'<li class="active"><a href="javascript:void(0);">'+a.get("name")+"</a></li>":'<li><a href="javascript:void(0);">'+a.get("name")+"</a></li>",a.id==y.get("inboxId")?i=r+i:i+=r}}var o='<ul class="dropdown-menu'+(1==t?" pull-right":"")+'" role="menu">';return o+=i+"</ul>"}),c.registerHelper("getListItemDueDateTip",function(e,t){return f.getListItemDueDateForList(e,t)}),c.registerHelper("getTaskDetailDueDate",function(e){return p.formatDueDate(e)}),c.registerHelper("getDueDateClass",function(e){return p.getDueDateClass(e)}),c.registerHelper("getProjectNameById",function(e){return u.getProjectNameById(e)}),c.registerHelper("getTitleByProject",function(e){var t=d.readUrl();return e&&a.isCalendarProject(e.id)?e.name:"calendar"===t.type?l.get("tk_calendar_view"):"assignedme"===t.type?l.get("assigned_me"):"subscribe-calendar"===t.type?e.name:"smart"==t.category?l.get("tasks"===t.type?"list_all":"list_"+t.type.toLowerCase()):e.name}),c.registerHelper("isTaskCompleted",function(e){return e>0?"checked":""}),c.registerHelper("ifHasCompleted",function(e){return e>0?"on":""}),c.registerHelper("ifHasTasksInTrash",function(e){
return g.trash.length>0?"on":""}),c.registerHelper("isTaskUrgent",function(e){return 5==e}),c.registerHelper("isTaskShared",function(e){return e>1?" on":""}),c.registerHelper("getPriorityClass",function(e){var t="";switch(e){case 5:t="priority-high";break;case 3:t="priority-medium";break;case 1:t="priority-low";break;case 0:default:t="priority-none"}return t}),c.registerHelper("upgradeIcon",function(e){var t=n.pluginId,i={"upgrade-search":"search","upgrade-task-limit":"task","upgrade-list-limit":"list","upgrade-subtask-limit":"subtask","upgrade-attachment":"attachment","upgrade-reminder":"reminder","upgrade-share":"share","upgrade-p-activity":"project_activity","setting-premium":"default","upgrade-mini-cal":t.calendar,"upgrade-t-activity":t.taskActivity,"upgrade-cal":n.smartProjectId.tkcalendar,"upgrade-subscribe":t.calSubscribe};return i=_.invert(i),s.getImg(i[e],"icon_home")}),c.registerHelper("upgradeFor",function(e){var t=n.pluginId,i={upgrade_for_search:"search",upgrade_for_task_limit:"task",upgrade_for_list_limit:"list",upgrade_for_subtask_limit:"subtask",upgrade_for_attachment:"attachment",upgrade_for_reminder:"reminder",upgrade_for_share:"share",upgrade_for_p_activity:"project_activity",upgrade_for_mini_cal:t.calendar,upgrade_for_t_activity:t.taskActivity,upgrade_for_cal:n.smartProjectId.tkcalendar,upgrade_for_subscribe:t.calSubscribe};i=_.invert(i);var s=l.get(i[e]);return void 0!=s?s.replace(/%s1/g,o.productName):e}),c.registerHelper("upgradeDesc",function(e,t){var i=n.pluginId,s={get_upgrade_filter_search:"search",get_upgrade_limited_task:"task",get_upgrade_limited_list:"list",get_upgrade_limited_subtask:"subtask",get_upgrade_limited_attachment:"attachment",get_upgrade_limited_reminder:"reminder",get_upgrade_share:"share",get_upgrade_share_not_owner:"share_not_owner",get_upgrade_project_activity:"project_activity",plugin_calendar_limit:i.calendar,plugin_task_activity_limit:i.taskActivity,plugin_tkcalendar_limit:n.smartProjectId.tkcalendar,plugin_calendar_subscribe_limit:i.calSubscribe};s=_.invert(s);var a=l.get(s[e]);return void 0!=a?a.replace(/%s1/g,o.productName).replace(/%p1/g," "+t+" "):e}),c.registerHelper("proLimitFor",function(e){var t={task:"pro_limited_task",list:"pro_limited_list",subtask:"pro_limited_subtask",attachment:"pro_limited_attachment",reminder:"pro_limited_reminder",subscribe:"settings_cal_subscription_limit"},i=l.get(t[e]);return void 0!=i?i:e}),c.registerHelper("getGravatarUrl",function(e,t){return r.getGravatarUrl(e,t)}),c.registerHelper("getUserAvatar",function(e){return r.getUserAvatar(e)}),c.registerHelper("getAvatar",function(){for(var e=arguments[0],t=1;t<arguments.length-1&&!e;t++)e=e||arguments[t];if(k.emailRegexp.test(e)){var i=e;return r.getAvatarByEmail(i)}return r.getAvatar(e)}),c.registerHelper("dateFormat",function(e,t){if(e=e||new Date,window.moment){var i=t.hash.format||"YYYY-MM-DD";return p.prefMomentFromUtc(e).format(i)}return e}),c.registerHelper("isSearchEnabled",function(e){var t=m.isPluginEnable(n.pluginId.search);return t?e.fn(this):e.inverse(this)}),c.registerHelper("isTaskActivityPluginEnabled",function(e){var t;return m&&(t=m.isPluginEnable(n.pluginId.taskActivity)),1==t?e.fn(this):e.inverse(this)}),c.registerHelper("isDuplicatePluginEnabled",function(e){var t;return m&&(t=m.isPluginEnable(n.pluginId.duplicate)),1==t?e.fn(this):e.inverse(this)}),c.registerHelper("formatVersionContent",function(e){return e.replace(/\r?\n/,"<br>")}),c.registerHelper("isDev",function(e){return y.isDev()?e.fn(this):e.inverse(this)}),c.registerHelper("getProjectInnerHtml",function(e,t){switch(e){case"tasks":return s.svgIcon("icon-all-list","i-1")+'<span class="l-title ">'+t+"</span>";case"today":return s.svgIcon("icon-today-list","i-1")+'<div class="outer-date"><span class="inner-date">'+p.prefMoment().date()+'</span></div><span class="l-title ">'+t+"</span>";case"week":var i=p.prefMoment().lang("en").format("ddd").slice(0,1);return s.svgIcon("icon-today-list","i-1")+'<div class="outer-date"><span class="inner-date">'+i+'</span></div><span class="l-title ">'+t+"</span>";case"calendar":return s.svgIcon("icon-calendar-list","i-1")+'<span class="l-title ">'+t+"</span>";case"assignedme":return s.svgIcon("icon-assigned-to-me-list","i-1")+'<span class="l-title ">'+t+"</span>";case y.get("inboxId"):return s.svgIcon("icon-inbox-list","i-1")+'<span class="l-title ">'+t+"</span>";case"completed":return s.svgIcon("icon-completed-list","i-1")+'<span class="l-title ">'+t+"</span>";case"trash":return s.svgIcon("icon-delete-list","i-1")+'<span class="l-title ">'+t+"</span>";default:return'<span class="normal-project-icons icons">'+s.svgIcon("icon-normal-list","i-1 normal-icon active-icon")+s.svgIcon("icon-share-list","i-1 share-icon share-active-icon")+'</span><span class="l-title project-title">'+t+"</span>"}}),c.registerHelper("encode",function(e){return h.encode(e)}),c.registerHelper("I18nURL",function(e){var t=h.encode(l.get(e));return void 0!=t?t:e}),c.registerHelper("getProjectColor",function(e){return s.getProjectColor(e)}),c.registerHelper("I18n_Plus",function(e){var t=l.get(e);if(t)for(var i=1;i<=arguments.length;i++){var n=new RegExp("%s"+i,"g");t=t.replace(n,arguments[i])}return void 0!=t?t:e}),c.registerHelper("I18n_Plus_or",function(e){var t=l.get(e);if(t){for(var i=new RegExp("%s1","g"),n="",s=1;s<=arguments.length;s++)n=n||arguments[s];t=t.replace(i,n)}return void 0!=t?t:e}),c.registerHelper("isContain",function(e,t,i){return~e.indexOf(t)?i.fn(this):i.inverse(this)}),c.registerHelper("svgIcon",function(e,t){return s.svgIcon(e,t)}),c.registerHelper("adjustBarHeight",function(){return d.isInTrash()||d.isInSubscribeCalendars()||d.isInTagView()||d.isInAssignedMe()||u.isInClosedProject()?"bar-short":d.isInCompleted()?"bar-tall":void 0}),c.registerHelper("renderEmptyInfo",function(){function e(e){return s.svgIcon(e,"i-xxl")}var t='%s1<span class="text-lrg text-link line-sml">%s2</span><span class="text-sml text-info line-sml">%s3</span>',i={icon:e(n.emptyIcon["default"]),text:l.get("empty_default_list"),desc:l.get("empty_default_list_desc")};return d.isInToday()?_.extend(i,{icon:e(n.emptyIcon.today),text:l.get("empty_today_list"),desc:l.get("empty_today_list_desc")}):d.isInWeek()?_.extend(i,{icon:e(n.emptyIcon.week),text:l.get("empty_week_list"),desc:l.get("empty_week_list_desc")}):d.isInAssignedMe()?_.extend(i,{icon:e(n.emptyIcon.assign),text:l.get("empty_assign_list"),desc:l.get("empty_assign_list_desc")}):d.isInCompleted()?_.extend(i,{icon:e(n.emptyIcon.completed),text:l.get("empty_completed_list"),desc:l.get("empty_completed_list_desc")}):d.isInTrash()?_.extend(i,{icon:e(n.emptyIcon.trash),text:l.get("empty_trash_list"),desc:l.get("empty_trash_list_desc")}):d.isInSearchView()?_.extend(i,{icon:e(n.emptyIcon.search),text:"",desc:l.get("empty_search_list")}):d.isInSubscribeCalendars()&&_.extend(i,{icon:e(n.emptyIcon.subscribe),text:"",desc:l.get("empty_subscribe_list")}),t.replace(/\%s1/g,i.icon).replace(/\%s2/g,i.text).replace(/\%s3/g,i.desc)}),c.registerHelper("renderCustomEmpty",function(e,i,n){function a(e){return s.svgIcon(e,"i-xxl")}return t=a(e)+'<span class="text-lrg text-link line-sml">'+l.get(i)+'</span><span class="text-sml text-info line-sml">'+l.get(n)+"</span>"}),c.registerHelper("renderLoading",function(){return'<div><ul class="css-loading">      <li></li>      <li></li>      <li></li>    </ul></div>'}),i.Handlebars=c}),define("template/helper/I18n",["require","exports","module","lang/index","Handlebars"],function(e,t){var i=e("lang/index"),n=e("Handlebars");n.registerHelper("I18n",function(e){var t=i.get(e);return void 0!=t?t:e})}),define("model/task_sort_order",["require","exports","module"],function(e,t){t.Model=Backbone.Model.extend({defaults:{order:"",id:""}})}),define("collection/task_sort_order",["require","exports","module","model/task_sort_order"],function(e,t){t.Collection=Backbone.Collection.extend({model:e("model/task_sort_order").Model,comparator:"order"})}),define("dao/order_by_date",["require","exports","module","collection/task_sort_order","configs/settings","offline/storage","configs/dict","utils/hash","utils/server","utils/timeformat","service/project","dao/taskdb"],function(e,t){var i=e("collection/task_sort_order").Collection,n=e("configs/settings"),s=e("offline/storage"),a=e("configs/dict"),r=e("utils/hash"),o=e("utils/server"),l=e("utils/timeformat"),c=e("service/project"),d=e("dao/taskdb").db;t.db={collectiondb:{},getTaskOrderByDate:function(e,t){var i=this,n=this._getDateCollectionByProjectId(e,t);return o.getTaskOrderByDate(e,t,function(s){if(!s||_.isEmpty(s.orders)||_.isEmpty(s.orders[t]))n&&n.reset();else{var a=s.orders[t];n.reset(a),n=n.sort()}i._syncLocalGroupCollection(e,t,n),Backbone.trigger("refresh")}),n},postDefaultSortOrder:function(e,t){var i=this.getGroupByGroupId(e,t),n={changed:[],deleted:[]};n.changed=i,i.length&&this.postTaskOrderByDateBean(e,t,n)},_syncLocalGroupCollection:function(e,t,i){this.collectiondb[e]||(this.collectiondb[e]={}),this.collectiondb[e][t]=i},_getDateCollectionByProjectId:function(e,t){var n=new i;return this.collectiondb||(this.collectiondb={}),this.collectiondb[e]?this.collectiondb[e][t]?this.collectiondb[e][t].models||(n.reset(this.collectiondb[e][t]),this.collectiondb[e][t]=n):this.collectiondb[e][t]=n:(this.collectiondb[e]={},this.collectiondb[e][t]=n),this.collectiondb[e][t]},syncTaskOrder:function(e,t,i){return this.syncTaskOrderByDate(e,t,i)},syncTaskOrderByDate:function(e,t,i){var n,s={},a={},r=this,o=[],l=[],c={changed:[],deleted:[]};_.each(i,function(i){var c=$(i).attr("date"),d=$(i).find("a").attr("taskid"),u=r.getTaskOrderByTaskId(d,t,e);if(c&&c!=t){var h=r._removeTheTaskOrderByTaskId(d,c,e);n!=c&&(o=[]),void 0!=h&&(o.push({id:d,order:h}),s[c]=o),n=c}void 0!=u&&(l.push({id:d,order:u}),a[t]=l)}),_.isEmpty(a)&&_.isEmpty(s)||(_.isEmpty(s)||_.each(s,function(t,i){c.changed=[],c.deleted=t,r.postTaskOrderByDateBean(i,e,c)}),_.isEmpty(a)||_.each(a,function(t,i){c.deleted=[],c.changed=t,r.postTaskOrderByDateBean(i,e,c)}))},postTaskOrderByDateBean:function(e,t,i){o.postTaskOrderByDate(e,t,JSON.stringify(i))},syncQuickAddTaskOrderByDate:function(e,t,i){var n={changed:[],deleted:[]};n.changed=i,this.postTaskOrderByDateBean(e,t,n)},_setDefaultTaskSortOrders:function(e){var t=[];return e.each(function(e){var i=e*n.orderStep,s=$(this).find("a").attr("taskid");t.push({id:s,order:i})}),t},createDefaultDateSort:function(e,t,i){var n=this.getTaskOrderCollectionByDate(e,t),s=this._setDefaultTaskSortOrders(i);n.set(s)},updateTaskOrderFromTimecard:function(e,t,i){var s=this.getGroupByGroupId(t,e);if(s.length){var a=this.getGroupTaskMinSortOrder(t,e),r=i.length,o=[],l=[];i.each(function(e){var i=a-(r-e)*n.orderStep,s=$(this),c=s.find("a").attr("taskid"),d=s.attr("date");d!=t&&(l.push(s),o.push({id:c,order:i}))}),o.length&&(s.add(o,{merge:!0}).sort(),this.syncTaskOrder(e,t,l))}},updateTaskOrderFromRestore:function(e,t){var i,s,a,r=[],o=0,c=!0,d=this,u={},h={changed:[],deleted:[]};_.each(t,function(t,a){s=l.prefMoment(t.get("dueDate")).format("YYYYMMDD"),c=d.isGroupExisted(s,e),c&&(i=d.getGroupTaskMinSortOrder(s,e),o=i-a*n.orderStep,taskId=t.get("id"),r.push({id:taskId,order:o}),u[s]=r)}),_.isEmpty(u)||_.each(u,function(t,i){a=d.getGroupByGroupId(i,e),a.add(t,{merge:!0}),h.changed=t,d.postTaskOrderByDateBean(i,e,h)})},updateTaskOrderFromCompleted:function(e){var t,i,s,a,r=[],o=0,d=!0,u=this,h={},p={changed:[],deleted:[]};_.each(e,function(e,a){t="all"==c.getCurrentDateProjectId()?"all":e.get("projectId"),s=l.prefMoment(e.get("dueDate")).format("YYYYMMDD"),d=u.isGroupExisted(s,t),d&&(i=u.getGroupTaskMinSortOrder(s,t),o=i-a*n.orderStep,taskId=e.get("id"),r.push({id:taskId,order:o}),h[s]=r)}),_.isEmpty(h)||_.each(h,function(e,i){a=u.getGroupByGroupId(i,t),a.add(e,{merge:!0}),p.changed=e,u.postTaskOrderByDateBean(i,t,p)})},isGroupExisted:function(e,t){var i=l.prefMoment().format("YYYYMMDD"),n=l.prefMoment().add("days",1).format("YYYYMMDD");if(r.isInWeek()&&(n=l.prefMoment().add("days",6).format("YYYYMMDD")),i>e||e>n)return!1;var s=this.getTaskOrderCollectionByDate(e,t);return s.length>0},getGroupByGroupId:function(e,t){return this.getTaskOrderCollectionByDate(e,t)},getTaskOrderCollectionByDate:function(e,t){return this._getDateCollectionByProjectId(e,t)},getTaskOrderByTaskId:function(e,t,i){var n=this._getDateCollectionByProjectId(t,i),s=n.get(e);return s?s.get("order"):void 0},_removeTheTaskOrderByTaskId:function(e,t,i){var n,s,a=this.getTaskOrderCollectionByDate(t,i);return(n=a.get(e))?(s=n.get("order"),a.remove(n),s):void 0},getGroupTaskMinSortOrder:function(e,t){var i=0,s=this.getTaskOrderCollectionByDate(e,t),a=s.length?s.at(0).get("order"):null;return i=null==a?0-n.orderStep:a-n.orderStep},hasDateGroupSort:function(e,t){return this.getTaskOrderCollectionByDate(e,t).length},_getTimeByDueDate:function(e){return null!=e?l.prefMoment(e).format("HH:mm:ss"):"00:00:00"},_saveTaskByDate:function(e,t,i){var n=this;e.each(function(){var e=$(this).find("a").attr("taskid"),s=d.getById(e),a=l.prefMoment(s.get("dueDate")).format("YYYYMMDD"),r=n._getTimeByDueDate(s.get("dueDate")),o=l.dateFormatToMoment(t,"YYYYMMDD").format("YYYY-MM-DDT"+r+".000ZZ"),c=s.get("status");if($(this).attr("date",t),a!=t||c)s.set({dueDate:o,status:0}),s.save();else if(!i){var u=!0;Backbone.trigger("taskChanged",s,u)}})},_resetSortOrder:function(e){var t=[];return e.each(function(e){var i=e*n.orderStep,s=$(this).find("a").attr("taskid");t.push({id:s,order:i})}),t},changeSortOrderByDate:function(e,t,i,s,a,r){var o,l,c,d,u,h,a=a,p=e.item.next(),m=e.item.prev(),f=i.length,g=n.orderStep,v=[],y=[],k=this.getGroupByGroupId(s,a);if(this.needResetTaskSortOrder=!1,f>1&&(m.length?m.after(i):p.length?p.before(i):null),i.length>1&&(t=e.item.closest(".task-sortable-by-date").find("li")),m.length)if(p.length)if(o=p.find("a").attr("taskid"),l=this.getTaskOrderByTaskId(o,s,a),c=m.find("a").attr("taskid"),d=this.getTaskOrderByTaskId(c,s,a),void 0==d||void 0==l||~o.indexOf("calendar")||~c.indexOf("calendar"))this.needResetTaskSortOrder=!0;else{var w=l-d-1;if(1>w/f)this.needResetTaskSortOrder=!0;else{var b=Math.abs(Math.floor(w/f));i.each(function(e){h=d+(e+1)*b,u=$(this).find("a").attr("taskid"),v.push({id:u,order:h})})}}else c=m.find("a").attr("taskid"),d=this.getTaskOrderByTaskId(c,s,a),void 0==d||~c.indexOf("calendar")?this.needResetTaskSortOrder=!0:i.each(function(e){h=d+(e+1)*g,u=$(this).find("a").attr("taskid"),v.push({id:u,order:h})});else o=p.find("a").attr("taskid"),l=this.getTaskOrderByTaskId(o,s,a),void 0==l||~o.indexOf("calendar")?this.needResetTaskSortOrder=!0:i.each(function(e){h=l-(f-e)*g,u=$(this).find("a").attr("taskid"),v.push({id:u,order:h})});this.needResetTaskSortOrder?(y=this._resetSortOrder(t),k.set(y),this.syncTaskOrder(a,s,t)):(k.add(v,{merge:!0}).sort(),this.syncTaskOrder(a,s,i)),this._saveTaskByDate(i,s,r)},_dumpTaskOrders:function(){s.setCacheItem(a.cachePath.taskOrderByDate,JSON.stringify(this.collectiondb))},_initFromLocalStorage:function(){this.collectiondb=JSON.parse(s.getCacheItem(a.cachePath.taskOrderByDate))||{}},dumpToLocalStorage:function(){this._dumpTaskOrders()}},t.db._initFromLocalStorage()}),define("model/project-group",["require","exports","module","configs/settings"],function(e,t){var i=e("configs/settings");t.Model=Backbone.Model.extend({defaults:{id:"",name:"",sortOrder:"",sortType:"",listType:"group",open:!1},messages:function(){this.on("sync",this.afterSync),this.on("change:open",this.changeOpenStatus)},initialize:function(){this.messages()},url:function(){return i.API_HOST_V2+"/projectGroup/"+(this.isNew()?"":this.get("id"))},afterSync:function(){this.local=null,this.set("local",!1)},changeOpenStatus:function(){Backbone.trigger("storeGroupInfoToLocal")},saveSortType:function(e){var t=this;setTimeout(function(){t.get("sortType")!==e&&(t.set("sortType",e),t.save())},i.responsiveTime)}})}),define("collection/project-group",["require","exports","module","model/project-group"],function(e,t){t.Collection=Backbone.Collection.extend({model:e("model/project-group").Model,comparator:"sortOrder"})}),define("dao/project-group",["require","exports","module","collection/project-group","utils/server","configs/dict","offline/storage","utils/hash","dao/projectdb"],function(e,t){var i=e("collection/project-group").Collection,n=e("utils/server"),s=e("configs/dict"),a=e("offline/storage"),r=e("utils/hash"),o=e("dao/projectdb").db,l=new i;l.reset(a.getStoreInfo(s.projectGroup.storePath,"json")),t.db={groupCollection:l,getProjectGroups:function(e){var t=this;return e&&n.getProjectGroups(function(e){t.mergeSetToLocal(e)}),t.groupCollection},getGroupsNotEmpty:function(){return this.groupCollection.filter(function(e){return 0!==o.getProjectsByGroupId(e.get("id")).length})},getGroupById:function(e){return this.groupCollection.get(e)},getGroupByName:function(e){return this.groupCollection.find(function(t){return t.get("name")==e})},getCurrentProjectGroup:function(){var e=r.getProjectGroupNameByUrl();if(!e)return void 0;var t=this.getGroupById(e);return t||(t=this.getGroupByName(decodeURIComponent(e))),t},updateProjectGroups:function(e){var t=this;_.each(e,function(e){var i=e.id,n=e.order,s=t.groupCollection.get(i);s&&(s.set("sortOrder",n),s.save())})},fetchProjectGroups:function(){var e=this;n.getProjectGroups(function(t){e.mergeSetToLocal(t)})},setToLocal:function(e){this.groupCollection.reset(e),this.storeInfo()},mergeSetToLocal:function(e){var t=this,i=!1;_.map(e,function(e){var n=t.groupCollection.get(e.id);n&&e.etag==n.get("etag")||(i=!0),n&&(e.open=n.get("open"))}),e.length!=this.groupCollection.length&&(i=!0),i&&this.setToLocal(e)},storeInfo:function(){a.setStoreInfo(s.projectGroup.storePath,JSON.stringify(this.groupCollection.models))},addNewGroup:function(e){this.groupCollection.add(e),this.storeInfo()},getMinSortOrder:function(){var e=this.groupCollection.min(function(e){return e.get("sortOrder")});return e&&e!==1/0?e.get("sortOrder"):0}}}),define("data-sync/index",["require","exports","module","dao/taskdb","dao/projectdb","service/task","offline/storage","model/task","model/project","utils/hash","utils/server","dao/order_by_date","dao/project-group","utils/dom","dao/userTagdb"],function(e,t){var i=e("dao/taskdb").db,n=e("dao/projectdb").db,s=e("service/task"),a=(e("offline/storage"),e("model/task").Model),r=e("model/project").Model,o=e("utils/hash"),l=e("utils/server"),c=e("dao/order_by_date").db,d=e("dao/project-group").db,u=e("utils/dom"),h=(e("dao/userTagdb").db,function(){var e=this;e.point=(new Date).getTime()});h.prototype.task=function(e){var t=o.getTaskIdFromPath(),n=$(".title, .content").is(":focus"),r=t&&n,l=e.update||[],c=e.deletedInTrash||[],d=e.deletedForever||[];if(!o.isInTrash()){for(var u=0;u<l.length;u++){var h=l[u];if(r&&h.id===t){var p=i.getById(h.id);if(p.get("etag")!==h.etag&&!p.isDirty){var m=s.mergeSync(h);p.set(m)}}else{var p=i.getById(h.id);if(_.isUndefined(p)){var f=new a(h);i.add(f),Backbone.trigger("refresh")}else{var m=s.mergeSync(h);p.set(m)}}}for(var u=0;u<c.length;u++){var h=c[u];if(!r||h.taskId!==t){var p=i.getById(h.taskId);_.isUndefined(p)||(p.trigger("hideOnListViewForDelete"),i.collection.remove(p,{silent:!0}),Backbone.trigger("refreshTagsList"))}}for(var u=0;u<d.length;u++){var h=d[u];if(!r||h.taskId!==t){var p=i.getById(h.taskId);_.isUndefined(p)||(p.trigger("deleteForever"),i.permanentDelete(p))}}}},h.prototype.taskOrder=function(e){if(e&&e.taskOrderByDate){var t,n=o.getTaskIdFromPath(),s=$(".title, .content").is(":focus"),a=n&&s,r=[];if(!a){var l=e.taskOrderByDate;_.each(l,function(e,n){_.each(e,function(e,s){if(e.changed.length){var a=c.getTaskOrderCollectionByDate(n,s);a.add(e.changed,{merge:!0}),_.each(e.changed,function(e){t=i.getById(e),r.push(t)})}if(e.deleted.length){var a=c.getTaskOrderCollectionByDate(n,s);a.remove(e.deleted)}})})}}},h.prototype.project=function(e){if(!_.isNull(e)){var t=n.collection.toJSON(),i=e;_.each(t,function(e){if("inbox"!==e.taskType){var t=_.find(i,function(t){return t.id===e.id});return _.isUndefined(t)?void n.collection.get(e.id).destroy():e.etag!==t.etag?void n.collection.get(e.id).set(t):void 0}}),_.each(i,function(e){var i=_.find(t,function(t){return t.id===e.id});if(_.isUndefined(i)){var s=new r(e);return s.local=!0,n.collection.add(s),void(s.local=!1)}})}},h.prototype.notification=function(){},h.prototype.reminder=function(){},h.prototype.preference=function(){},h.prototype.comments=function(){},h.prototype.projectGroup=function(e){e instanceof Array&&d.mergeSetToLocal(e)},h.prototype.sync=function(){var e=this;u.showRefresh(),e.point=e.point?e.point:(new Date).getTime(),l.dataSync(e.point,function(t){u.hideRefresh(),e.point=t.checkPoint?t.checkPoint:e.point,e.projectGroup(t.projectGroups),e.project(t.projectProfiles),e.taskOrder(t.syncTaskOrderBean),e.task(t.syncTaskBean),Backbone.trigger("refreshTagsList")})},h.prototype.once=function(){this.sync()},h.prototype.start=function(){var e=this;setInterval(function(){e.sync()},6e5)};var p=new h;return p}),define("model/notification",["require","exports","module"],function(e,t){t.Model=Backbone.Model.extend({})}),define("collection/notification",["require","exports","module","configs/settings","utils/timeformat","model/notification"],function(e,t){var i=e("configs/settings"),n=e("utils/timeformat");t.Collection=Backbone.Collection.extend({model:e("model/notification").Model,comparator:function(e){var t=n.prefMoment(e.get("createdTime")).unix();return-t},url:i.API_HOST+"/notification?autoMarkRead=false"})}),define("dao/notificationdb",["require","exports","module","utils/server","utils/dom","collection/notification"],function(e,t){var i=e("utils/server"),n=(e("utils/dom"),e("collection/notification").Collection);t.db={collection:new n,initialize:function(){this.getCountFromServer()},getCountFromServer:function(){i.getNotificationCount(this._updateNotificationCount)},updateFromServer:function(e){var t=this,i=0;this.collection.fetch({success:function(){e&&e(),t._updateNotificationCount(i)}})},getAllNotifications:function(){return this.collection.models},_updateNotificationCount:function(e){Backbone.trigger("updateNotificationCount",e)}}}),define("modules/popup/popup",["require","exports","module"],function(e,t){t.View=Backbone.View.extend({className:"popup fast-transition",tagName:"div",events:{"click .popup-close":"onRemove","blur .popup":"onRemove"},message:function(){var e=this;$("body").on("keydown",function(t){27===t.keyCode&&e.onRemove()})},initialize:function(e){_.extend(this,e),this.render(),this.message()},render:function(){var e=this.buildCoverDom();this.$cover=$(e),this.$el.html(this.view.$el),this.$cover.append(this.$el),this.extendClass&&this.$el.addClass(this.extendClass),this.$el.css({transform:"scale(0.9)",opacity:"0.2"}),$("body").append(this.$cover);var t=this;setTimeout(function(){t.$el.css({transform:"scale(1)",opacity:1})})},buildCoverDom:function(){var e=document.createElement("div");return e.className="popup-cover",e},cleanOld:function(){$("."+this.className).remove()},removeCover:function(){this.$cover.remove()},onRemove:function(){this.view&&this.view.remove(),this.remove(),this.removeCover()}})}),define("hbs!template/sent-verify-email",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o,l="",c=i.helperMissing,d=this.escapeExpression,u="function";return l+='<div class="popup-header">\n    <a class="popup-close">&times;</a>\n    <h1 class="popup-title text-lrg text-primary">\n        ',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"verify_email",o):c.call(t,"I18n","verify_email",o)))+'\n    </h1>\n</div>\n\n<div class="popup-body">\n    <p class="text-primary">',(r=i.text)?r=r.call(t,{hash:{},data:s}):(r=t.text,r=typeof r===u?r.apply(t):r),l+=d(r)+'</p>\n</div>\n\n<div class="popup-footer">\n    <button class="btn btn-primary">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"ok",o):c.call(t,"I18n","ok",o)))+"</button>\n</div>\n"})}),define("view/modal/sent-verify-email",["require","exports","module","modules/popup/popup","lang/index","service/userProfile","hbs!template/sent-verify-email"],function(e,t){var i=e("modules/popup/popup").View,n=e("lang/index"),s=e("service/userProfile");t.View=Backbone.View.extend({id:"sent-verify-email",template:e("hbs!template/sent-verify-email"),events:{"click .btn-primary":"close"},initialize:function(e){this.render()},render:function(){this.$el.html(this.template({text:n.get("confirm_your_email").replace("%s",s.get("username"))})),this.renderPopup()},renderPopup:function(){this.popupView=new i({view:this})},close:function(){this.popupView.onRemove()}})}),define("hbs!template/verify-email",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o="",l=i.helperMissing,c=this.escapeExpression;return o+='<div class="popup-header">\n    <a class="popup-close">&times;</a>\n    <h1 class="popup-title text-lrg text-primary">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"verify_email",r):l.call(t,"I18n","verify_email",r)))+'</h1>\n</div>\n\n<div class="popup-body">\n    <p class="text-primary">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"user_email_not_verified",r):l.call(t,"I18n","user_email_not_verified",r)))+'</p>\n</div>\n\n<div class="popup-footer">\n    <button class="close-modal btn btn-cancel">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"close",r):l.call(t,"I18n","close",r)))+'</button>\n    <button class="verify-email btn btn-primary">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"verify_email",r):l.call(t,"I18n","verify_email",r)))+"</button>\n</div>\n"})}),define("view/modal/verify-email",["require","exports","module","utils/server","view/modal/sent-verify-email","modules/popup/popup","hbs!template/verify-email"],function(e,t){var i=e("utils/server"),n=e("view/modal/sent-verify-email").View,s=e("modules/popup/popup").View;return t.View=Backbone.View.extend({id:"verify-email-view",template:e("hbs!template/verify-email"),events:{"click .verify-email":"verifyEmail","click .popup-close, .close-modal":"closeModal"},initialize:function(e){this.initData(e),this.render()},initData:function(e){_.extend(this,e)},render:function(){this.$el.html(this.template()),this.popupView=new s({view:this})},verifyEmail:function(){var e,t,s=this;return t=function(){new n,s.closeModal()},e=function(){return s.closeModal(),"do nothing if fails"},i.verifyEmail(t,e)},closeModal:function(){this.popupView.onRemove()}}),t}),define("hbs!template/notification_list_item",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){var i="";return i}function r(e,t){var n,s,a="";return a+='\n         <img src="',s={hash:{},data:t},a+=W((n=i.getAvatar,n?n.call(e,(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.fromUserCode),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.userCode),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.fromUsername),s):z.call(e,"getAvatar",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.fromUserCode),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.userCode),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.fromUsername),s)))+'" />\n      '}function o(e,t){return'\n         <i class="icon_home icon-sml-logo"></i>\n      '}function l(e,t){var n,s,a,r="";return r+="\n        ",a={hash:{},inverse:G.program(10,d,t),fn:G.program(8,c,t),data:t},n=i.ifempty,s=n?n.call(e,(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.projectName),a):z.call(e,"ifempty",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.projectName),a),(s||0===s)&&(r+=s),r+="\n      "}function c(e,t){return'\n          <i class="icon_home icon-sml-logo"></i>\n        '}function d(e,t){var n,s,a="";return a+='\n          <img src="',s={hash:{},data:t},a+=W((n=i.getAvatar,n?n.call(e,(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.fromUserCode),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.userCode),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.fromUsername),s):z.call(e,"getAvatar",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.fromUserCode),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.userCode),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.fromUsername),s)))+'" />\n        '}function u(e,t){var n,s,a="";return a+='\n        \n            <p class="text text-secondary text-sml">\n            ',s=i["if"].call(e,(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.taskTitle),{hash:{},inverse:G.program(15,p,t),fn:G.program(13,h,t),data:t}),(s||0===s)&&(a+=s),a+="\n            </p>\n            \n        "}function h(e,t){var n,s,a,r="";return r+="\n              ",a={hash:{},data:t},n=i.I18n_Plus,s=n?n.call(e,"assigned_task_notification",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.taskId),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.taskTitle),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.projectId),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.projectName),a):z.call(e,"I18n_Plus","assigned_task_notification",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.taskId),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.taskTitle),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.projectId),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.projectName),a),(s||0===s)&&(r+=s),r+="\n            "}function p(e,t){var n,s,a,r="";return r+="\n              ",a={hash:{},data:t},n=i.I18n_Plus,s=n?n.call(e,"assigned_task_notitle_notification",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.taskId),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.projectId),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.projectName),a):z.call(e,"I18n_Plus","assigned_task_notitle_notification",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.taskId),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.projectId),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.projectName),a),(s||0===s)&&(r+=s),r+="\n            "}function m(e,t){var n,s,a,r="";return r+='\n          <p class="text text-secondary text-sml">\n            ',a={hash:{},data:t},n=i.I18n_Plus,s=n?n.call(e,"unassigned_task_notification",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.taskId),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.taskTitle),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.projectId),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.projectName),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.assigneeUserDisplayName),a):z.call(e,"I18n_Plus","unassigned_task_notification",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.taskId),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.taskTitle),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.projectId),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.projectName),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.assigneeUserDisplayName),a),(s||0===s)&&(r+=s),r+="\n          </p>\n        "}function f(e,t){var n,s,a,r="";return r+='\n              <p class="text text-secondary text-sml">\n                ',a={hash:{},inverse:G.noop,fn:G.program(20,g,t),data:t},n=i.ifequalor,s=n?n.call(e,(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE),(n=e.STATUS,null==n||n===!1?n:n.SHARE_REFUSE),(n=e.STATUS,null==n||n===!1?n:n.SHARE_CANCEL),a):z.call(e,"ifequalor",(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE),(n=e.STATUS,null==n||n===!1?n:n.SHARE_REFUSE),(n=e.STATUS,null==n||n===!1?n:n.SHARE_CANCEL),a),(s||0===s)&&(r+=s),r+="\n\n                ",a={hash:{},inverse:G.noop,fn:G.program(22,v,t),data:t},n=i.ifequal,s=n?n.call(e,(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE_ACCEPT),a):z.call(e,"ifequal",(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,
null==n||n===!1?n:n.SHARE_ACCEPT),a),(s||0===s)&&(r+=s),r+="\n\n\n                ",a={hash:{},inverse:G.noop,fn:G.program(24,y,t),data:t},n=i.ifequal,s=n?n.call(e,(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE_JOIN),a):z.call(e,"ifequal",(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE_JOIN),a),(s||0===s)&&(r+=s),r+="\n\n\n                ",a={hash:{},inverse:G.noop,fn:G.program(26,k,t),data:t},n=i.ifequal,s=n?n.call(e,(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE_REJECTED),a):z.call(e,"ifequal",(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE_REJECTED),a),(s||0===s)&&(r+=s),r+="\n\n\n                ",a={hash:{},inverse:G.noop,fn:G.program(28,w,t),data:t},n=i.ifequal,s=n?n.call(e,(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE_DELETED),a):z.call(e,"ifequal",(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE_DELETED),a),(s||0===s)&&(r+=s),r+="\n\n                ",a={hash:{},inverse:G.noop,fn:G.program(30,b,t),data:t},n=i.ifequal,s=n?n.call(e,(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE_REMOVE),a):z.call(e,"ifequal",(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE_REMOVE),a),(s||0===s)&&(r+=s),r+="\n\n                ",a={hash:{},inverse:G.noop,fn:G.program(32,_,t),data:t},n=i.ifequal,s=n?n.call(e,(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE_LEAVE),a):z.call(e,"ifequal",(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE_LEAVE),a),(s||0===s)&&(r+=s),r+="\n\n\n                ",a={hash:{},inverse:G.noop,fn:G.program(34,T,t),data:t},n=i.ifequalor,s=n?n.call(e,(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE_INVITE),(n=e.STATUS,null==n||n===!1?n:n.SHARE_INVITE_ACCEPT),(n=e.STATUS,null==n||n===!1?n:n.SHARE_INVITE_REFUSE),a):z.call(e,"ifequalor",(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE_INVITE),(n=e.STATUS,null==n||n===!1?n:n.SHARE_INVITE_ACCEPT),(n=e.STATUS,null==n||n===!1?n:n.SHARE_INVITE_REFUSE),a),(s||0===s)&&(r+=s),r+="\n\n\n                ",a={hash:{},inverse:G.noop,fn:G.program(36,I,t),data:t},n=i.ifequal,s=n?n.call(e,(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE_INVITE_ACCEPTED),a):z.call(e,"ifequal",(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE_INVITE_ACCEPTED),a),(s||0===s)&&(r+=s),r+="\n\n\n                ",a={hash:{},inverse:G.noop,fn:G.program(38,C,t),data:t},n=i.ifequal,s=n?n.call(e,(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE_INVITE_REFUSED),a):z.call(e,"ifequal",(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE_INVITE_REFUSED),a),(s||0===s)&&(r+=s),r+="\n              </p>\n\n              ",a={hash:{},inverse:G.noop,fn:G.program(40,x,t),data:t},n=i.ifequalor,s=n?n.call(e,(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE),(n=e.STATUS,null==n||n===!1?n:n.SHARE_ACCEPT),(n=e.STATUS,null==n||n===!1?n:n.SHARE_REFUSE),(n=e.STATUS,null==n||n===!1?n:n.SHARE_CANCEL),(n=e.STATUS,null==n||n===!1?n:n.SHARE_INVITE),(n=e.STATUS,null==n||n===!1?n:n.SHARE_INVITE_ACCEPT),(n=e.STATUS,null==n||n===!1?n:n.SHARE_INVITE_REFUSE),a):z.call(e,"ifequalor",(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE),(n=e.STATUS,null==n||n===!1?n:n.SHARE_ACCEPT),(n=e.STATUS,null==n||n===!1?n:n.SHARE_REFUSE),(n=e.STATUS,null==n||n===!1?n:n.SHARE_CANCEL),(n=e.STATUS,null==n||n===!1?n:n.SHARE_INVITE),(n=e.STATUS,null==n||n===!1?n:n.SHARE_INVITE_ACCEPT),(n=e.STATUS,null==n||n===!1?n:n.SHARE_INVITE_REFUSE),a),(s||0===s)&&(r+=s),r+="\n\n        "}function g(e,t){var n,s,a,r="";return r+="\n                    ",a={hash:{},data:t},n=i.I18n_Plus_or,s=n?n.call(e,"shared_a_project",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.entityName),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.title),a):z.call(e,"I18n_Plus_or","shared_a_project",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.entityName),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.title),a),(s||0===s)&&(r+=s),r+="\n                "}function v(e,t){var n,s,a,r="";return r+="\n                    ",a={hash:{},data:t},n=i.I18n_Plus_or,s=n?n.call(e,"shared_to_you",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.entityName),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.title),a):z.call(e,"I18n_Plus_or","shared_to_you",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.entityName),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.title),a),(s||0===s)&&(r+=s),r+="\n                "}function y(e,t){var n,s,a,r="";return r+="\n                    ",a={hash:{},data:t},n=i.I18n_Plus_or,s=n?n.call(e,"shared_list_joined",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.entityName),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.title),a):z.call(e,"I18n_Plus_or","shared_list_joined",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.entityName),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.title),a),(s||0===s)&&(r+=s),r+="\n                "}function k(e,t){var n,s,a,r="";return r+="\n                    ",a={hash:{},data:t},n=i.I18n_Plus_or,s=n?n.call(e,"shared_list_refused",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.entityName),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.title),a):z.call(e,"I18n_Plus_or","shared_list_refused",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.entityName),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.title),a),(s||0===s)&&(r+=s),r+="\n                "}function w(e,t){var n,s,a,r="";return r+="\n                    ",a={hash:{},data:t},n=i.I18n_Plus_or,s=n?n.call(e,"shared_list_deleted",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.entityName),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.title),a):z.call(e,"I18n_Plus_or","shared_list_deleted",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.entityName),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.title),a),(s||0===s)&&(r+=s),r+="\n                "}function b(e,t){var n,s,a,r="";return r+="\n                    ",a={hash:{},data:t},n=i.I18n_Plus_or,s=n?n.call(e,"shared_list_removed",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.entityName),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.title),a):z.call(e,"I18n_Plus_or","shared_list_removed",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.entityName),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.title),a),(s||0===s)&&(r+=s),r+="\n                "}function _(e,t){var n,s,a,r="";return r+="\n                    ",a={hash:{},data:t},n=i.I18n_Plus_or,s=n?n.call(e,"shared_list_quitted",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.entityName),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.title),a):z.call(e,"I18n_Plus_or","shared_list_quitted",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.entityName),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.title),a),(s||0===s)&&(r+=s),r+="\n                "}function T(e,t){var n,s,a,r="";return r+="\n                    ",a={hash:{},data:t},n=i.I18n_Plus_or,s=n?n.call(e,"requests_to_join_your_shared_list",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.entityName),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.title),a):z.call(e,"I18n_Plus_or","requests_to_join_your_shared_list",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.entityName),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.title),a),(s||0===s)&&(r+=s),r+="\n                "}function I(e,t){var n,s,a,r="";return r+="\n                    ",a={hash:{},data:t},n=i.I18n_Plus_or,s=n?n.call(e,"agreed_to_share_list_with_you",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.entityName),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.title),a):z.call(e,"I18n_Plus_or","agreed_to_share_list_with_you",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.entityName),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.title),a),(s||0===s)&&(r+=s),r+="\n                "}function C(e,t){var n,s,a,r="";return r+="\n                    ",a={hash:{},data:t},n=i.I18n_Plus_or,s=n?n.call(e,"declined_to_share_list_with_you",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.entityName),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.title),a):z.call(e,"I18n_Plus_or","declined_to_share_list_with_you",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.entityName),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.title),a),(s||0===s)&&(r+=s),r+="\n                "}function x(e,t){var n,s,a,r="";return r+="\n\n                ",a={hash:{},inverse:G.noop,fn:G.program(41,S,t),data:t},n=i.ifequal,s=n?n.call(e,(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE),a):z.call(e,"ifequal",(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE),a),(s||0===s)&&(r+=s),r+="\n\n                ",a={hash:{},inverse:G.noop,fn:G.program(43,D,t),data:t},n=i.ifequal,s=n?n.call(e,(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE_INVITE),a):z.call(e,"ifequal",(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE_INVITE),a),(s||0===s)&&(r+=s),r+="\n\n                ",a={hash:{},inverse:G.noop,fn:G.program(45,j,t),data:t},n=i.ifequalor,s=n?n.call(e,(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE_INVITE_ACCEPT),(n=e.STATUS,null==n||n===!1?n:n.SHARE_ACCEPT),a):z.call(e,"ifequalor",(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE_INVITE_ACCEPT),(n=e.STATUS,null==n||n===!1?n:n.SHARE_ACCEPT),a),(s||0===s)&&(r+=s),r+="\n\n\n                ",a={hash:{},inverse:G.noop,fn:G.program(47,$,t),data:t},n=i.ifequalor,s=n?n.call(e,(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE_INVITE_REFUSE),(n=e.STATUS,null==n||n===!1?n:n.SHARE_REFUSE),a):z.call(e,"ifequalor",(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE_INVITE_REFUSE),(n=e.STATUS,null==n||n===!1?n:n.SHARE_REFUSE),a),(s||0===s)&&(r+=s),r+="\n\n\n                ",a={hash:{},inverse:G.noop,fn:G.program(49,P,t),data:t},n=i.ifequal,s=n?n.call(e,(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE_CANCEL),a):z.call(e,"ifequal",(n=e.model,null==n||n===!1?n:n.actionStatus),(n=e.STATUS,null==n||n===!1?n:n.SHARE_CANCEL),a),(s||0===s)&&(r+=s),r+="\n\n              "}function S(e,t){var n,s,a="";return a+='\n                  <button id="btn-refuse-share" class="btn btn-tny btn-refuse" type="button">',s={hash:{},data:t},a+=W((n=i.I18n,n?n.call(e,"refuse_share",s):z.call(e,"I18n","refuse_share",s)))+'</button>\n                  <button id="btn-accept-share" class="btn btn-tny btn-accept" type="button">',s={hash:{},data:t},a+=W((n=i.I18n,n?n.call(e,"accept_share",s):z.call(e,"I18n","accept_share",s)))+"</button>\n                "}function D(e,t){var n,s,a="";return a+='\n                  <button id="btn-refuse-share-invite" class="btn btn-tny btn-refuse">',s={hash:{},data:t},a+=W((n=i.I18n,n?n.call(e,"refuse_share",s):z.call(e,"I18n","refuse_share",s)))+'</button>\n                  <button id="btn-accept-share-invite" class="btn btn-tny btn-accept">',s={hash:{},data:t},a+=W((n=i.I18n,n?n.call(e,"accept_share",s):z.call(e,"I18n","accept_share",s)))+"</button>\n                "}function j(e,t){var n,s,a="";return a+='\n                  <span class="status text-info">',s={hash:{},data:t},a+=W((n=i.I18n,n?n.call(e,"accepted_share",s):z.call(e,"I18n","accepted_share",s)))+"</span>\n                "}function $(e,t){var n,s,a="";return a+='\n                  <span class="status text-info text-sml">',s={hash:{},data:t},a+=W((n=i.I18n,n?n.call(e,"refused_share",s):z.call(e,"I18n","refused_share",s)))+"</span>\n                "}function P(e,t){var n,s,a="";return a+='\n                    <span class="status text-info text-sml">',s={hash:{},data:t},a+=W((n=i.I18n,n?n.call(e,"cancelled_share",s):z.call(e,"I18n","cancelled_share",s)))+"</span>\n                "}function M(e,t){var n,s,a,r="";return r+='\n          <p class="text text-secondary text-sml topic">\n            ',a={hash:{},data:t},n=i.I18n_Plus,s=n?n.call(e,"forum_topic_notification",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.topicUrl),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.topicTitle),a):z.call(e,"I18n_Plus","forum_topic_notification",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.topicUrl),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.topicTitle),a),(s||0===s)&&(r+=s),r+="\n          </p>\n        "}function A(e,t){var n,s,a,r="";return r+='\n          <p class="text text-secondary text-sml">\n            ',a={hash:{},inverse:G.noop,fn:G.program(54,V,t),data:t},n=i.ifequal,s=n?n.call(e,(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.action),"COMMENT",a):z.call(e,"ifequal",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.action),"COMMENT",a),(s||0===s)&&(r+=s),r+="\n\n            ",a={hash:{},inverse:G.noop,fn:G.program(56,O,t),data:t},n=i.ifequal,s=n?n.call(e,(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.action),"REPLY",a):z.call(e,"ifequal",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.action),"REPLY",a),(s||0===s)&&(r+=s),r+="\n\n            ",a={hash:{},inverse:G.noop,fn:G.program(58,B,t),data:t},n=i.ifequal,s=n?n.call(e,(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.action),"MENTION",a):z.call(e,"ifequal",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.action),"MENTION",a),(s||0===s)&&(r+=s),r+="\n          </p>\n        "}function V(e,t){var n,s,a,r="";return r+="\n              ",a={hash:{},data:t},n=i.I18n_Plus,s=n?n.call(e,"comment_task_notification",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.taskId),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.taskTitle),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.projectId),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.title),a):z.call(e,"I18n_Plus","comment_task_notification",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.taskId),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.taskTitle),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.projectId),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.title),a),(s||0===s)&&(r+=s),r+="\n            "}function O(e,t){var n,s,a,r="";return r+="\n              ",a={hash:{},data:t},n=i.I18n_Plus,s=n?n.call(e,"reply_task_notification",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.taskId),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.taskTitle),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.projectId),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.title),a):z.call(e,"I18n_Plus","reply_task_notification",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.taskId),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.taskTitle),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.projectId),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.title),a),(s||0===s)&&(r+=s),r+="\n            "}function B(e,t){var n,s,a,r="";return r+="\n              ",a={hash:{},data:t},n=i.I18n_Plus,s=n?n.call(e,"mentioned_task_notification",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.taskId),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.taskTitle),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.projectId),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.title),a):z.call(e,"I18n_Plus","mentioned_task_notification",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.taskId),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.taskTitle),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.projectId),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.title),a),(s||0===s)&&(r+=s),r+="\n            "}function N(e,t){var n,s,a,r="";return r+="\n            ",a={hash:{},inverse:G.program(64,L,t),fn:G.program(61,E,t),data:t},n=i.ifempty,s=n?n.call(e,(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.projectName),a):z.call(e,"ifempty",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.projectName),a),(s||0===s)&&(r+=s),r+="\n\n        "}function E(e,t){var n,s,a,r="";return r+='\n                <p class="text text-secondary text-sml">\n                  ',a={hash:{},data:t},n=i.I18n_date,s=n?n.call(e,"renew_reminder",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.expiryDate),a):z.call(e,"I18n_date","renew_reminder",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.expiryDate),a),(s||0===s)&&(r+=s),r+="\n                </p>\n\n              ",a={hash:{},inverse:G.noop,fn:G.program(62,R,t),data:t},n=i.iftrue,s=n?n.call(e,(n=e.model,null==n||n===!1?n:n.unread),a):z.call(e,"iftrue",(n=e.model,null==n||n===!1?n:n.unread),a),(s||0===s)&&(r+=s),r+="\n\n            "}function R(e,t){var n,s,a="";return a+='\n                <a href="/about/upgrade" target="_blank" class="btn btn-tny btn-accept">\n                  ',s={hash:{},data:t},a+=W((n=i.I18n,n?n.call(e,"renew_now",s):z.call(e,"I18n","renew_now",s)))+"\n                </a>\n              "}function L(e,t){var n,s,a,r="";return r+='\n              \n                <p class="text text-secondary text-sml">\n                  ',a={hash:{},data:t},n=i.I18n_Plus,s=n?n.call(e,"upgrade_reminder",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.userDisplayName),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.projectId),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.projectName),a):z.call(e,"I18n_Plus","upgrade_reminder",(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.userDisplayName),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.projectId),(n=e.model,n=null==n||n===!1?n:n.data,null==n||n===!1?n:n.projectName),a),(s||0===s)&&(r+=s),r+="\n                </p>\n\n              ",a={hash:{},inverse:G.noop,fn:G.program(65,H,t),data:t},n=i.iftrue,s=n?n.call(e,(n=e.model,null==n||n===!1?n:n.unread),a):z.call(e,"iftrue",(n=e.model,null==n||n===!1?n:n.unread),a),(s||0===s)&&(r+=s),r+="\n\n          "}function H(e,t){var n,s,a="";return a+='\n                <a href="/about/upgrade" target="_blank" class="btn btn-tny btn-accept">\n                  ',s={hash:{},data:t},a+=W((n=i.I18n,n?n.call(e,"upgrade_now",s):z.call(e,"I18n","upgrade_now",s)))+"\n                </a>\n              "}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var U,F,q,Y="",z=i.helperMissing,W=this.escapeExpression,G=this;return Y+='\n<div class="n-left">\n    <div class="avatar">\n\n      ',q={hash:{},inverse:G.program(3,r,s),fn:G.program(1,a,s),data:s},U=i.ifequalor,F=U?U.call(t,(U=t.model,null==U||U===!1?U:U.type),"forumTopic","PayReminder",q):z.call(t,"ifequalor",(U=t.model,null==U||U===!1?U:U.type),"forumTopic","PayReminder",q),(F||0===F)&&(Y+=F),Y+="\n\n      ",q={hash:{},inverse:G.noop,fn:G.program(5,o,s),data:s},U=i.ifequal,F=U?U.call(t,(U=t.model,null==U||U===!1?U:U.type),"forumTopic",q):z.call(t,"ifequal",(U=t.model,null==U||U===!1?U:U.type),"forumTopic",q),(F||0===F)&&(Y+=F),Y+="\n\n      ",q={hash:{},inverse:G.noop,fn:G.program(7,l,s),data:s},U=i.ifequal,F=U?U.call(t,(U=t.model,null==U||U===!1?U:U.type),"PayReminder",q):z.call(t,"ifequal",(U=t.model,null==U||U===!1?U:U.type),"PayReminder",q),(F||0===F)&&(Y+=F),Y+='\n\n    </div>\n\n</div>\n\n<div class="n-right">\n\n    <div class="n-header">\n        <span class="time text-info text-tny line-right">',q={hash:{},data:s},Y+=W((U=i.dateFormat,U?U.call(t,(U=t.model,null==U||U===!1?U:U.createdTime),q):z.call(t,"dateFormat",(U=t.model,null==U||U===!1?U:U.createdTime),q)))+'</span>\n        <span class="author text-primary text-sml line-left">',q={hash:{},data:s},Y+=W((U=i.or,U?U.call(t,(U=t.model,U=null==U||U===!1?U:U.data,null==U||U===!1?U:U.userDisplayName),(U=t.model,U=null==U||U===!1?U:U.data,null==U||U===!1?U:U.fromUserDisplayName),(U=t.model,U=null==U||U===!1?U:U.data,null==U||U===!1?U:U.fromUsername),(U=t.model,U=null==U||U===!1?U:U.data,null==U||U===!1?U:U.name)," ",q):z.call(t,"or",(U=t.model,U=null==U||U===!1?U:U.data,null==U||U===!1?U:U.userDisplayName),(U=t.model,U=null==U||U===!1?U:U.data,null==U||U===!1?U:U.fromUserDisplayName),(U=t.model,U=null==U||U===!1?U:U.data,null==U||U===!1?U:U.fromUsername),(U=t.model,U=null==U||U===!1?U:U.data,null==U||U===!1?U:U.name)," ",q)))+'</span>\n    </div>\n\n    <div class="n-content">\n\n        ',q={hash:{},inverse:G.noop,fn:G.program(12,u,s),data:s},U=i.ifequal,F=U?U.call(t,(U=t.model,null==U||U===!1?U:U.type),"assign",q):z.call(t,"ifequal",(U=t.model,null==U||U===!1?U:U.type),"assign",q),(F||0===F)&&(Y+=F),Y+="\n\n        ",q={hash:{},inverse:G.noop,fn:G.program(17,m,s),data:s},U=i.ifequal,F=U?U.call(t,(U=t.model,null==U||U===!1?U:U.type),"unassign",q):z.call(t,"ifequal",(U=t.model,null==U||U===!1?U:U.type),"unassign",q),(F||0===F)&&(Y+=F),Y+="\n\n\n        ",q={hash:{},inverse:G.noop,fn:G.program(19,f,s),data:s},U=i.ifequal,F=U?U.call(t,(U=t.model,null==U||U===!1?U:U.type),"share",q):z.call(t,"ifequal",(U=t.model,null==U||U===!1?U:U.type),"share",q),(F||0===F)&&(Y+=F),Y+="\n\n\n        ",q={hash:{},inverse:G.noop,fn:G.program(51,M,s),data:s},U=i.ifequal,F=U?U.call(t,(U=t.model,null==U||U===!1?U:U.type),"forumTopic",q):z.call(t,"ifequal",(U=t.model,null==U||U===!1?U:U.type),"forumTopic",q),(F||0===F)&&(Y+=F),Y+="\n\n        ",q={hash:{},inverse:G.noop,fn:G.program(53,A,s),data:s},U=i.ifequal,F=U?U.call(t,(U=t.model,null==U||U===!1?U:U.type),"comment",q):z.call(t,"ifequal",(U=t.model,null==U||U===!1?U:U.type),"comment",q),(F||0===F)&&(Y+=F),Y+="\n\n        ",q={hash:{},inverse:G.noop,fn:G.program(60,N,s),data:s},U=i.ifequal,F=U?U.call(t,(U=t.model,null==U||U===!1?U:U.type),"PayReminder",q):z.call(t,"ifequal",(U=t.model,null==U||U===!1?U:U.type),"PayReminder",q),(F||0===F)&&(Y+=F),Y+="\n\n    </div>\n</div>\n"})}),define("view/notification/item",["require","exports","module","configs/settings","lang/index","utils/dom","dao/projectdb","dao/taskdb","service/task","utils/server","view/modal/verify-email","hbs!template/notification_list_item"],function(e,t){var i=(e("configs/settings"),e("lang/index")),n=e("utils/dom"),s=e("dao/projectdb").db,a=e("dao/taskdb").db,r=e("service/task"),o=e("utils/server"),l=e("view/modal/verify-email").View;t.View=Backbone.View.extend({tagName:"li",template:e("hbs!template/notification_list_item"),STATUS:{SHARE:0,SHARE_ACCEPT:1,SHARE_REFUSE:2,SHARE_CANCEL:3,SHARE_JOIN:4,SHARE_REJECTED:5,SHARE_DELETED:6,SHARE_REMOVE:7,SHARE_LEAVE:8,SHARE_INVITE:9,SHARE_INVITE_ACCEPT:10,SHARE_INVITE_REFUSE:11,SHARE_INVITE_ACCEPTED:12,SHARE_INVITE_REFUSED:13},events:{"click #btn-accept-share":"acceptShare","click #btn-refuse-share":"refuseShare","click #btn-accept-share-invite":"acceptInvite","click #btn-refuse-share-invite":"refuseInvite","click a":"navigate"},initObject:function(){this.$btnAcceptShare=this.$("#btn-accept-share"),this.$btnAcceptShareInvite=this.$("#btn-accept-share-invite")},initialize:function(e){this.render(),this.initObject()},refresh:function(e){this.model.set("actionStatus",e),this.render(),this.refreshApp()},refreshApp:function(){var e=this.model.get("data");"project"==e.entityType?s.refresh():r.getTaskFromServerById(e.entityId)},actionShareUrlParams:function(){var e=this.model.get("data");return{entityType:e.entityType,entityId:e.entityId,modelId:this.model.id}},showVerifyEmailView:function(){new l},acceptShare:function(e){e.stopPropagation();var t=this,s=_.extend(this.actionShareUrlParams(),{actionStatus:t.STATUS.SHARE_ACCEPT});t.renderAcceptingButton(t.$btnAcceptShare),o.share(s,function(e){t.refresh(t.STATUS.SHARE_ACCEPT)},function(e){var s=JSON.parse(e.responseText);"user_email_not_verified"==s.errorCode?t.showVerifyEmailView():n.showStatus(i.get("error_unknow_server"),5e3)})},renderAcceptingButton:function(e){e.text(i.get("accepting")).attr("disabled",!0)},refuseShare:function(e){e.stopPropagation();var t=this,i=_.extend(t.actionShareUrlParams(),{actionStatus:t.STATUS.SHARE_REFUSE});o.share(i,function(){t.refresh(t.STATUS.SHARE_REFUSE)})},acceptInvite:function(){var e=this;e.renderAcceptingButton(e.$btnAcceptShareInvite),o.acceptInviteProjectCollaboration(e.model.get("id"),function(){e.refresh(e.STATUS.SHARE_INVITE_ACCEPT)})},refuseInvite:function(){var e=this;o.refuseInviteProjectCollaboration(e.model.get("id"),function(){e.refresh(e.STATUS.SHARE_INVITE_REFUSE)})},render:function(){var e=this.template({model:this.model.toJSON(),STATUS:this.STATUS});this.$el.html(e),this.rerenderHref()},navigate:function(e){e=e||window.event;var t=$(e.target).attr("href"),i=Backbone.history.getFragment();t&&t.replace(/^#/,"")===i&&Backbone.history.loadUrl(i)},rerenderHref:function(){this.existProject(),this.existTask()},existProject:function(){var e,t=this.model.get("data");if(t.projectId?e=s.getProjectById(t.projectId):t.entityName&&(e=s.getProjectByName(t.entityName)),!e)for(var i=this.$("p").not(".topic").find("a"),n=0;n<i.length;n++){var a=$(i[n]);a.replaceWith(a.text())}},existTask:function(){var e=this.model.get("data"),t=e.taskId;if(t){{var i=a.getById(t);i?i.get("deleted"):1}if(!i||i&&i.get("deleted")||i&&i.get("projectId")!==e.projectId)for(var n=this.$("p").not(".topic").find("a"),s=0;s<n.length;s++){var r=$(n[s]),o=r.attr("href");if(o.match(t))return void r.replaceWith(r.text())}}}})}),define("hbs!template/notification_center",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o,l="",c="function",d=i.helperMissing;return l+='<div id="notification-loading" class="loading">\n    ',(a=i.renderLoading)?a=a.call(t,{hash:{},data:s}):(a=t.renderLoading,a=typeof a===c?a.apply(t):a),(a||0===a)&&(l+=a),l+='\n</div>\n<ul id="notification-view" class="antiscroll-inner"></ul>\n<div id="notification-empty-view" class="notification-empty-view">\n    ',o={hash:{},data:s},a=i.svgIcon,r=a?a.call(t,"icon-empty-notification","i-xl",o):d.call(t,"svgIcon","icon-empty-notification","i-xl",o),(r||0===r)&&(l+=r),l+='\n    <span class="text-lrg text-link line-sml">\n        ',o={hash:{},data:s},a=i.I18n,r=a?a.call(t,"no_notification_title",o):d.call(t,"I18n","no_notification_title",o),(r||0===r)&&(l+=r),l+='\n    </span>\n    <span class="text-sml text-secondary line-sml">\n        ',o={hash:{},data:s},a=i.I18n,r=a?a.call(t,"no_notification_content",o):d.call(t,"I18n","no_notification_content",o),(r||0===r)&&(l+=r),l+="\n    </span>\n</div>\n"})}),define("view/notification/list",["require","exports","module","utils/dom","utils/server","dao/notificationdb","view/notification/item","hbs!template/notification_center"],function(e,t){var i=(e("utils/dom"),e("utils/server")),n=e("dao/notificationdb").db,s=e("view/notification/item").View;t.View=Backbone.View.extend({template:e("hbs!template/notification_center"),className:"antiscroll-wrap",events:{"click .content a":"onClose"},listenClick:function(){this.$el.on("click.notification-inner",function(e){"A"!==e.target.tagName&&e.stopPropagation()})},initDom:function(){this.$notificationEmptyView=this.$("#notification-empty-view"),this.$notificationView=this.$("#notification-view"),this.$loading=this.$("#notification-loading")},markRead:function(){var e=[];_.each(this.notifications,function(t){t.get("unread")&&e.push(t.id)}),e.length&&i.markRead(JSON.stringify(e))},getNotifications:function(){this.notifications=n.getAllNotifications()},initialize:function(){this.subViews=[],this.render(),this.updateFromServe(),this.initScrollbar()},updateFromServe:function(){this.$loading.show(),this.toggleNotificationEmptyView(),n.updateFromServer(_.bind(function(){this.render();var e=this;setTimeout(function(){e.$loading.slideUp(),setTimeout(function(){e.toggleNotificationEmptyView()},500)},700),this.markRead(),this.initScrollbar()},this))},render:function(){this.getNotifications(),this.$el.html(this.template()),$("#notification_panel").html(this.$el);var e=this;this.initDom(),this.notifications.length&&_.each(this.notifications,function(t){var i=new s({model:t});e.subViews.push(i),e.$notificationView.append(i.$el)}),this.toggleNotificationEmptyView(),this.listenClick()},toggleNotificationEmptyView:function(){"none"!==this.$loading.css("display")?this.$notificationEmptyView.hide():this.notifications.length?this.$notificationEmptyView.hide():this.$notificationEmptyView.show()},initScrollbar:function(){var e=this;setTimeout(function(){e.$el.antiscroll()})},onClose:function(){this.subViews.map(function(e){e.remove()}),this.remove()},stopPropagation:function(e){"A"!==e.target.tagName&&e.stopPropagation()}})}),define("hbs!template/body",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){return'\n                            <i class="icon-s-pro-tny icon_home"> </i>\n                        '}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var r,o,l,c="",d=this,u="function",h=i.blockHelperMissing,p=i.helperMissing,m=this.escapeExpression;return c+='<!-- Container start -->\n<div id="container-main" class="container-fluid can-not-select">\n    <div class="row-fluid">\n        <!-- left view start -->\n        <div id="left-view" class="g-left">\n\n            <!-- action bar -->\n            <div class="tool-bar">\n                <div class="indicator slow-transition"></div>\n\n                <div class="t-user user dropdown" id="preferences-menu">\n                    <a data-toggle="dropdown" class="dropdown-toggle boult">\n                        <img class="avatar" />\n                        ',l={hash:{},inverse:d.noop,fn:d.program(1,a,s),data:s},(r=i.ifpro)?r=r.call(t,l):(r=t.ifpro,r=typeof r===u?r.apply(t):r),i.ifpro||(r=h.call(t,r,l)),(r||0===r)&&(c+=r),c+='\n                    </a>\n                    <span data-toggle="dropdown" class="username t-name"></span>\n\n                    <ul class="dropdown-menu pull-left">\n                      <li><a id="refresh">',l={hash:{},data:s},c+=m((r=i.I18n,r?r.call(t,"sync_indicator",l):p.call(t,"I18n","sync_indicator",l)))+'</a></li>\n                      <li><a id="settings" href="#settings">',l={hash:{},data:s},c+=m((r=i.I18n,r?r.call(t,"settings",l):p.call(t,"I18n","settings",l)))+'</a></li>\n                      <li><a id="homepage" href="/home" target="_blank">',l={hash:{},data:s},c+=m((r=i.I18n,r?r.call(t,"return_homepage",l):p.call(t,"I18n","return_homepage",l)))+'</a></li>\n                      <li><a id="help" href="https://help.',(o=i.site_domain)?o=o.call(t,{hash:{},data:s}):(o=t.site_domain,o=typeof o===u?o.apply(t):o),c+=m(o)+'" target="_blank">',l={hash:{},data:s},c+=m((r=i.I18n,r?r.call(t,"help",l):p.call(t,"I18n","help",l)))+'</a></li>\n                      <li><a id="logout">',l={hash:{},data:s},c+=m((r=i.I18n,r?r.call(t,"logout",l):p.call(t,"I18n","logout",l)))+'</a></li>\n                    </ul>\n\n                </div>\n\n                <a id="search" class="t-search" href="#s/">\n                    ',l={hash:{},data:s},r=i.svgIcon,o=r?r.call(t,"icon-search","i-1",l):p.call(t,"svgIcon","icon-search","i-1",l),(o||0===o)&&(c+=o),c+='\n                </a>\n\n                <div id="notification-menu" class="dropdown notification t-notify">\n                    <a class="dropdown-toggle power-tip boult" data-toggle="dropdown" title=\'',l={hash:{},data:s},c+=m((r=i.I18n,r?r.call(t,"recent_notifications",l):p.call(t,"I18n","recent_notifications",l)))+"'>\n                        ",
l={hash:{},data:s},r=i.svgIcon,o=r?r.call(t,"icon-notification","i-1",l):p.call(t,"svgIcon","icon-notification","i-1",l),(o||0===o)&&(c+=o),c+='\n                        <span class="badge n-count"></span>\n                    </a>\n                    <div class="dropdown-menu pull-left">\n                        <div id="notification_panel" class="notify-panel"></div>\n                    </div>\n                </div>\n\n            </div>\n            <!-- /action bar -->\n\n            <!--list view start-->\n            <div id="project-list-view" class="lists">\n                <div class="project-list-inner antiscroll-wrap">\n                    <div class="antiscroll-inner first-hide">\n\n                        <div class="collection list-group">\n                            <ul id="list-collection-a"></ul>\n                        </div>\n\n                        <div class="collection list-group">\n                            <ul id="list-collection-t"></ul>\n                        </div>\n\n                        <div class="collection list-group">\n                            <ul id="list-collection-i"></ul>\n                        </div>\n\n                        <div class="l-tabs l-l-t l-c disabled-tag">\n                          <a class="l-tab t-active">\n                            <span class="text-sml">',l={hash:{},data:s},c+=m((r=i.I18n,r?r.call(t,"project_list",l):p.call(t,"I18n","project_list",l)))+'</span>\n                          </a>\n                          <a class="l-tab">\n                            <span class="text-sml">',l={hash:{},data:s},c+=m((r=i.I18n,r?r.call(t,"tags",l):p.call(t,"I18n","tags",l)))+'</span>\n                          </a>\n                        </div>\n\n                        <!--list start-->\n                        <div class="project-list list-group l-tab-pane-0 t-active">\n                          <ul id="project-ul" class="project-ul"></ul>\n                        </div>\n                        <!--list end-->\n\n                        <!-- close-project start -->\n                        <div class="list-group list-closed l-c l-tab-pane-0 t-active">\n                            <ul id="close-project-ul" class="l-closed-ul inner-ul">\n                            </ul>\n                        </div>\n                        <!-- close-project end -->\n\n                        <!-- new list -->\n                        <div class="l-new l-tab-pane-0 t-active">\n                        </div>\n\n                        <!--tagList start -->\n                        <div class="tag-list list-group l-tab-pane-1 hide">\n                          <div class="empty-tag">\n                            ',l={hash:{},data:s},r=i.svgIcon,o=r?r.call(t,"icon-empty-tag","i-xl",l):p.call(t,"svgIcon","icon-empty-tag","i-xl",l),(o||0===o)&&(c+=o),c+="\n                            <span>",l={hash:{},data:s},r=i.I18n,o=r?r.call(t,"empty_tag",l):p.call(t,"I18n","empty_tag",l),(o||0===o)&&(c+=o),c+='</span>\n                          </div>\n                        </div>\n                        <!--tagList end -->\n\n                        <div class="l-divider"></div>\n\n                        <!--calendarList start -->\n                        <div class="calendar-list list-group">\n                            <ul id="calendar-ul">\n                            </ul>\n                            <div class="l-divider hide"></div>\n                        </div>\n                        \n                        <!--calendarList end -->\n\n                        <!--another collection start-->\n                        <div class="collection list-group">\n                            <ul id="list-collection-c" class="list"></ul>\n                        </div>\n                        <!--another collection end-->\n\n                    </div>\n                </div>\n            </div>\n            <!--list view end-->\n\n            <!--plugin calendar view start-->\n            <div id="left-bottom-view">\n                <div id="datepicker" class="min-cal"></div>\n\n                \n            </div>\n            <!--plugin calendar view end-->\n        </div>\n        <!-- left view end-->\n\n        <!--center view start-->\n        <div id="center-view" class="g-center"></div>\n        <!--center view end-->\n\n        <!-- tkcalendar view start -->\n        <div id="tkcalendar-view" class="tkcalendar-view"></div>\n        <!-- tkcalendar view end-->\n\n        <!-- right view start -->\n        <div id="right-view" class="g-right">\n            <a id="right-menu" class="right-menu-t"></a>\n            <div id="detail-view" class="b-h"></div>\n        </div>\n        <!-- right view end -->\n    </div>\n\n    <!-- reminders modal-->\n    <div id="reminders-modal">\n      <ul class="reminders"></ul>\n    </div>\n    <!-- /reminders modal-->\n\n    <a id="left-menu" class="left-menu-t"><span></span></a>\n\n</div>\n<!-- Container end-->\n'})}),define("view/body",["require","exports","module","utils/analytics","utils/hash","data-sync/index","configs/settings","view/notification/list","service/userProfile","utils/browser","configs/dict","service/prefs","utils/server","hbs!template/body"],function(e,t){var i=e("utils/analytics"),n=e("utils/hash"),s=e("data-sync/index"),a=e("configs/settings"),r=e("view/notification/list").View,o=e("service/userProfile"),l=e("utils/browser"),c=e("configs/dict"),d=e("service/prefs"),u=e("utils/server");t.View=Backbone.View.extend({template:e("hbs!template/body"),el:"body",messages:function(){this.listenTo(o,"change:picture change:name",this.renderUserInfo),this.listenTo(Backbone,"updateNotificationCount",this.updateNotificationCount),this.listenTo(Backbone,"updateAttachmentLimit",this.updateAttachmentLimit),this.listenTo(Backbone,"doHideMobileList",this.doHideMobileList),this.listenTo(d,"change:theme",this.initTheme)},events:{"click #homepage":"openHome","click #logout":"logout","click #help":"openHelp","click #notification-menu":"openNotification",click:"clickBody","click #left-menu":"toggleList","click #right-menu":"toggleDetail","click #refresh":"refresh"},initialize:function(){this.messages(),this.$el.prepend(this.template({site_domain:a.domain})),this.checkChannel(),this.notify=!1,this.renderUserInfo(),this.hack(),this.hideMobileListByHash(),this.listenWindowResize(),this.updateAttachmentLimit()},initTheme:function(){var e={dark:"dark-theme"};this.$el.removeClass("dark-theme").addClass(e[d.get("theme")||"classic"])},hack:function(){this.ieHack(),this.iosHack(),this.firefoxHack(),this.safariHack(),this.mobileHack(),this.chromeLowerhack()},chromeLowerhack:function(){l.isChromeLower&&this.$el.addClass("chrome-lower")},mobileHack:function(){l.isMobile.any()&&this.$el.addClass("mobile")},ieHack:function(){var e=l.getIeVersion();e&&this.$el.addClass("ie ie"+e)},safariHack:function(){(l.isSafari||l.isInMacWebview)&&this.$el.addClass("safari")},iosHack:function(){l.isMobile.iOS()&&(this.$el.addClass("ios"),FastClick.attach(document.body))},firefoxHack:function(){l.isFirefox&&this.$el.addClass("firefox")},checkChannel:function(){/\?channel=chrome_extension_open_panel/.test(location.href)&&this.$('[href="/signout"]').attr("href","/signout?dest=signin?channel=chrome_extension_open_panel")},openHome:function(){i.me_home()},openNotification:function(){this.notifView&&this.notifView.onClose(),this.notifView=new r,i.me_notify()},openHelp:function(){i.me_help()},logout:function(){i.me_sign_out(),n.redirectToSignout()},clickBody:function(e){e=e||window.event;var t=$(e.target);this.hideMobileDetail(t),this.hideMobileList(t),this.hideMobileTabs(),this.hideTimeCard(t)},hideTimeCard:function(e){e.closest("#js-timecard").length||Backbone.trigger("hideTimeCard")},hideMobileDetail:function(e){window.innerWidth>c.screenSize.mobile||!e.closest("body").length||e.closest("#reminders-modal").length||e.closest(".popup").length||e.closest("#detail-view").length||e.closest(".task").length||this.doHideMobileList()},doHideMobileList:function(){window.innerWidth>c.screenSize.mobile||this.$el.removeClass("detail-show")},hideMobileList:function(e){this.$el.hasClass("list-show")&&e.closest("#container-main").length&&!e.closest("#left-view").length&&!e.closest("#project-group-option-menu").length&&this.$el.removeClass("list-show")},hideMobileListByHash:function(){var e=this;"onhashchange"in window&&$(window).on("hashchange",function(){e.$el.removeClass("list-show")})},hideMobileTabs:function(){window.innerWidth<=c.screenSize.mobile&&this.$el.removeClass("tabs-show")},recoverWindow:function(){window.innerWidth>c.screenSize.mobile&&this.$el.removeClass("list-show detail-show tabs-show")},listenWindowResize:function(){this.resizeWindow=_.throttle(this.resizeWindow,500);var e=this;$(window).on("resize",function(){e.resizeWindow()})},resizeWindow:function(){this.recoverWindow()},refresh:function(e){s.once()},renderUserInfo:function(){this.$("#preferences-menu .avatar").attr("src",o.get("picture")),this.$(".username").html(o.get("name"))},updateAttachmentLimit:function(){u.getAttachmentIsUnderQuota(function(e){a.canUploadAttachment=e})},updateNotificationCount:function(e){var t=this.$(".notification a");e?(t.addClass("new-notification"),t.find(".n-count").html(10>e?e:"9+")):t.removeClass("new-notification")},toggleList:function(e){e=e||window.event,e.stopPropagation(),this.$el.toggleClass("list-show")},toggleDetail:function(e){e=e||window.event,e.stopPropagation(),this.$el.toggleClass("detail-show")}})}),define("model/comment",["require","exports","module","configs/settings"],function(e,t){var i=e("configs/settings");t.Model=Backbone.Model.extend({defaults:{title:"",taskId:"",projectId:"",id:"",modifiedTime:"",createdTime:"",replyCommentId:"",mentions:[],userProfile:{},replyUserProfile:{}},url:function(){return i.API_HOST+"/project/"+this.get("projectId")+"/task/"+this.get("taskId")+"/comment"+(this.isNew()?"":"/"+this.get("id"))}})}),define("collection/comment",["require","exports","module","model/comment"],function(e,t){t.Collection=Backbone.Collection.extend({model:e("model/comment").Model})}),define("dao/commentdb",["require","exports","module","collection/comment","configs/settings","offline/storage","configs/dict"],function(e,t){var i=e("collection/comment").Collection,n=e("configs/settings"),s=e("offline/storage"),a=e("configs/dict");t.db={collectiondb:{},draftdb:{},getCommentsById:function(e,t,i){var s=this.getCollectionById(e);if(i){s.url=n.API_HOST_V2+"/project/"+t+"/task/"+e+"/comments";var a=this;s.fetch({success:function(i){a.afterFetchCollection(e,t,i)}})}return s},afterFetchCollection:function(e,t,i){_.each(i.models,function(i){i.set({taskId:e,projectId:t})}),i.trigger("refreshComment")},initCommentCollection:function(e,t){var n=new i(t);return this.setCollection(e,n),n},getDraft:function(e){return this.draftdb[e]},setDraft:function(e,t){this.draftdb[e]=t},getCollectionById:function(e){var t=this.collectiondb[e];return(!t||_.isEmpty(t))&&(t=this.initCommentCollection(e)),t},setCollection:function(e,t){this.collectiondb[e]=t},_dumpComment:function(){s.setCacheItem(a.cachePath.comment,JSON.stringify(this.collectiondb))},_InitFromLocalStorage:function(){var e=JSON.parse(s.getCacheItem(a.cachePath.comment))||{};if(e)for(var t in e)this.initCommentCollection(t,e[t]);this.draftdb=JSON.parse(s.getCacheItem(a.cachePath.commentDraft))||{}},_dumpCommentDraft:function(){s.setCacheItem(a.cachePath.commentDraft,JSON.stringify(this.draftdb))},dumpToLocalStorage:function(){this._dumpComment(),this._dumpCommentDraft()}},t.db._InitFromLocalStorage()}),define("utils/dbstore",["require","exports","module","configs/status","dao/projectdb","dao/taskdb","dao/commentdb","dao/shareduserdb","dao/original","dao/order_by_date"],function(e,t){var i=e("configs/status"),n=e("dao/projectdb"),s=e("dao/taskdb"),a=e("dao/commentdb"),r=e("dao/shareduserdb"),o=e("dao/original"),l=e("dao/order_by_date");t.listenBrowserClose=function(){i.refresh=!0,Backbone.trigger("closeDetailView"),n.db.dumpToLocalStorage(),s.db.dumpToLocalStorage(),o.dumpToLocalStorage(),a.db.dumpToLocalStorage(),r.dumpToLocalStorage(),l.db.dumpToLocalStorage()}}),define("utils/print",["require","exports","module","configs/settings","utils/timeformat","utils/browser"],function(e,t){var i=e("configs/settings"),n=(e("utils/timeformat"),e("utils/browser")),s={debug:!1,importCSS:!0,importStyle:!0,printContainer:!0,loadCSS:"",pageTitle:"",removeInline:!1,printDelay:n.isFirefox?1e3:0,header:null,formValues:!0},a=(new Date).getTime(),r={detail:i.cdn+"/static/build/app/core/print-detail.css?v="+a,list:i.cdn+"/static/build/app/core/print-list.css?v="+a};i.is_product_mode||(r.detail="/static/styles/dist/print-detail.css",r.list="/static/styles/dist/print-list.css"),t.printTaskDetail=function(){s.loadCSS=r.detail,$("#task-detail-view").printThis(s)},t.printTasks=function(){s.loadCSS=r.list,$("#task-list-view").printThis(s)},t.preloadcss=function(){var e=document.createElement("iframe");if(e.name="preloadIframe",e.style.display="none",e.id="preloadIframe",window.location.hostname!==document.domain&&navigator.userAgent.match(/msie/i)){var t='javascript:document.write("<head><script>document.domain=\\"'+document.domain+'\\";</script></head><body></body>")';e.src=t}document.body.appendChild(e),setTimeout(function(){_.each(r,function(t){var i=document.createElement("link");i.type="text/css",i.rel="stylesheet",i.href=t;var n=e.contentDocument||e.contentWindow.document;n.getElementsByTagName("head")[0].appendChild(i)})},333)}}),define("hbs!template/get_upgrade",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){var n,s,a="";return a+='\n      <h1 class="popup-title text-lrg text-primary">\n        ',s={hash:{},data:t},a+=f((n=i.I18n,n?n.call(e,"pro_limit_tip",s):m.call(e,"I18n","pro_limit_tip",s)))+"\n      </h1>\n    "}function r(e,t){var n,s,a,r="";return r+="\n        ",a={hash:{},data:t},n=i.upgradeIcon,s=n?n.call(e,e.type,a):m.call(e,"upgradeIcon",e.type,a),(s||0===s)&&(r+=s),r+="\n    "}function o(e,t){var n,s,a="";return a+="\n        <p>",s={hash:{},data:t},a+=f((n=i.proLimitFor,n?n.call(e,e.type,s):m.call(e,"proLimitFor",e.type,s)))+"</p>\n    "}function l(e,t){var n,s,a="";return a+='\n        <h1 class="popup-title text-lrg text-primary">',s={hash:{},data:t},a+=f((n=i.upgradeFor,n?n.call(e,e.type,s):m.call(e,"upgradeFor",e.type,s)))+'</h1>\n        <p class="free-limit">',s={hash:{},data:t},a+=f((n=i.upgradeDesc,n?n.call(e,e.type,s):m.call(e,"upgradeDesc",e.type,s)))+"</p>\n    "}function c(e,t){var n,s,a="";return a+='\n        <button type="button" class="btn btn-primary">',s={hash:{},data:t},a+=f((n=i.I18n,n?n.call(e,"ok",s):m.call(e,"I18n","ok",s)))+"</button>\n    "}function d(e,t){var n,s,a="";return a+='\n        <a id="upgrade" href="/payment" target="_blank" class="btn btn-med btn-primary">',s={hash:{},data:t},a+=f((n=i.I18n,n?n.call(e,"upgrade_now",s):m.call(e,"I18n","upgrade_now",s)))+'</a>\n        <a class="more-info text-tny" href="/about/upgrade" target="_blank">',s={hash:{},data:t},a+=f((n=i.I18n,n?n.call(e,"get_upgrade_view_detail",s):m.call(e,"I18n","get_upgrade_view_detail",s)))+"</a>\n    "}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var u,h,p="",m=i.helperMissing,f=this.escapeExpression,g=this,v="function",y=i.blockHelperMissing;return p+='<div class="popup-header">\n    <a class="popup-close">&times;</a>\n    ',h={hash:{},inverse:g.program(3,r,s),fn:g.program(1,a,s),data:s},(u=i.ifpro)?u=u.call(t,h):(u=t.ifpro,u=typeof u===v?u.apply(t):u),i.ifpro||(u=y.call(t,u,h)),(u||0===u)&&(p+=u),p+='\n</div>\n\n<div class="popup-body">\n    ',h={hash:{},inverse:g.program(7,l,s),fn:g.program(5,o,s),data:s},(u=i.ifpro)?u=u.call(t,h):(u=t.ifpro,u=typeof u===v?u.apply(t):u),i.ifpro||(u=y.call(t,u,h)),(u||0===u)&&(p+=u),p+='\n</div>\n\n<div class="popup-footer">\n    ',h={hash:{},inverse:g.program(11,d,s),fn:g.program(9,c,s),data:s},(u=i.ifpro)?u=u.call(t,h):(u=t.ifpro,u=typeof u===v?u.apply(t):u),i.ifpro||(u=y.call(t,u,h)),(u||0===u)&&(p+=u),p+="\n</div>\n"})}),define("hbs!template/get_upgrade_share",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){var n,s,a="";return a+='\n      <h1 class="popup-title text-lrg text-primary">\n        ',s={hash:{},data:t},a+=y((n=i.I18n,n?n.call(e,"pro_limit_tip",s):v.call(e,"I18n","pro_limit_tip",s)))+"\n      </h1>\n    "}function r(e,t){var n,s,a,r="";return r+="\n        ",a={hash:{},data:t},n=i.upgradeIcon,s=n?n.call(e,"share",a):v.call(e,"upgradeIcon","share",a),(s||0===s)&&(r+=s),r+="\n    "}function o(e,t){var n,s,a="";return a+="\n        <p>",s={hash:{},data:t},a+=y((n=i.I18n,n?n.call(e,"pro_limited_sharing",s):v.call(e,"I18n","pro_limited_sharing",s)))+"</p>\n    "}function l(e,t){var n,s,a,r="";return r+='\n        <h1 class="popup-title text-lrg text-primary">',a={hash:{},data:t},r+=y((n=i.upgradeFor,n?n.call(e,"share",a):v.call(e,"upgradeFor","share",a)))+'</h1>\n\n        <p class="free-limit">\n        ',s=i["if"].call(e,e.isOwner,{hash:{},inverse:k.program(10,d,t),fn:k.program(8,c,t),data:t}),(s||0===s)&&(r+=s),r+="\n        </p>\n    "}function c(e,t){var n,s,a="";return a+="\n            ",s={hash:{},data:t},a+=y((n=i.upgradeDesc,n?n.call(e,"share",s):v.call(e,"upgradeDesc","share",s)))+"\n        "}function d(e,t){var n,s,a="";return a+="\n            ",s={hash:{},data:t},a+=y((n=i.upgradeDesc,n?n.call(e,"share_not_owner",e.owner,s):v.call(e,"upgradeDesc","share_not_owner",e.owner,s)))+"\n        "}function u(e,t){var n,s,a="";return a+='\n        <button ="button" class="btn btn-primary">',s={hash:{},data:t},a+=y((n=i.I18n,n?n.call(e,"ok",s):v.call(e,"I18n","ok",s)))+"</button>\n    "}function h(e,t){var n,s="";return s+="\n        ",n=i["if"].call(e,e.isOwner,{hash:{},inverse:k.program(17,m,t),fn:k.program(15,p,t),data:t}),(n||0===n)&&(s+=n),s+="\n    "}function p(e,t){var n,s,a="";return a+='\n            <a id="upgrade" href="/payment" target="_blank" class="btn btn-med btn-primary">',s={hash:{},data:t},a+=y((n=i.I18n,n?n.call(e,"upgrade_now",s):v.call(e,"I18n","upgrade_now",s)))+'</a>\n            <a class="more-info text-tny" href="/about/upgrade" target="_blank">',s={hash:{},data:t},a+=y((n=i.I18n,n?n.call(e,"get_upgrade_view_detail",s):v.call(e,"I18n","get_upgrade_view_detail",s)))+"</a>\n        "}function m(e,t){var n,s,a="";return a+='\n            <a id="upgrade" href="/payment" target="_blank" class="btn btn-med btn-primary">',s={hash:{},data:t},a+=y((n=i.I18n,n?n.call(e,"remind_owner_upgrade",s):v.call(e,"I18n","remind_owner_upgrade",s)))+"</a>\n        "}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var f,g="",v=i.helperMissing,y=this.escapeExpression,k=this;return g+='<div class="popup-header">\n    <a class="popup-close">&times;</a>\n    ',f=i["if"].call(t,t.proLimit,{hash:{},inverse:k.program(3,r,s),fn:k.program(1,a,s),data:s}),(f||0===f)&&(g+=f),g+='\n</div>\n\n<div class="popup-body">\n    ',f=i["if"].call(t,t.proLimit,{hash:{},inverse:k.program(7,l,s),fn:k.program(5,o,s),data:s}),(f||0===f)&&(g+=f),g+='\n</div>\n\n<div class="popup-footer">\n    ',f=i["if"].call(t,t.proLimit,{hash:{},inverse:k.program(14,h,s),fn:k.program(12,u,s),data:s}),(f||0===f)&&(g+=f),g+="\n</div>"})}),define("view/modal/get-upgrade",["require","exports","module","utils/analytics","modules/popup/popup","service/userProfile","hbs!template/get_upgrade","hbs!template/get_upgrade_share"],function(e,t){var i=e("utils/analytics"),n=e("modules/popup/popup").View,s=e("service/userProfile");t.View=Backbone.View.extend({id:"get-upgrade-view",template:e("hbs!template/get_upgrade"),shareTp:e("hbs!template/get_upgrade_share"),events:{"click .upgrade":"upgrade","click .btn-cancel":"close","click .btn-primary":"close","click #upgrade":"onClickUpgrade"},initialize:function(e){this.initData(e),"share"===this.type?this.renderShare():this.render(),this.messages()},messages:function(){this.$("img").error(function(){$(this).hide()})},initData:function(e){_.extend(this,e)},render:function(){this.$el.html(this.template({type:this.type})),this.renderPopup()},renderShare:function(){var e={proLimit:this.proLimit,isOwner:this.isOwner,owner:this.owner,shareLimitText:this.shareLimitText};this.$el.html(this.shareTp(e)),this.renderPopup()},renderPopup:function(){var e=s.isPro()&&_.isUndefined(this.isOwner)?"":"upgrade-pop";this.popupView=new n({view:this,extendClass:e})},upgrade:function(){i.u_sub(this.type)},onClickUpgrade:function(e){this.action&&(this.action(),e.preventDefault())},close:function(){this.popupView.onRemove()}})}),define("utils/limit-lab",["require","exports","module","view/modal/get-upgrade","service/userProfile"],function(e,t){var i=e("view/modal/get-upgrade").View,n=e("service/userProfile");t.checkPro=function(e,t){return n.isPro()?void(t&&t()):void new i({type:e})}}),define("collection/multi-tasks",["require","exports","module","configs/dict","utils/calculate","utils/timeformat","service/project","utils/index","utils/log"],function(e,t){var i=e("configs/dict"),n=(e("utils/calculate"),e("utils/timeformat")),s=(e("service/project"),e("utils/index")),a=e("utils/log");t.Collection=Backbone.Collection.extend({initialize:function(){},getCommonDuedate:function(){var e=this.map(function(e){return e.get("dueDate")}),t=_.uniq(e);return 1===t.length?_.isUndefined(t[0])?null:t[0]:null},isEveryTaskRepeatable:function(){return _.every(this.models,function(e){return!!e.get("repeatFlag")})},panelSetting:function(e){e=e||{};var t=[];this.each(function(a){if(e.dueDate){_.isEmpty(e.reminders)&&(e.isAllDay=!0);var r=n.prefMoment(e.dueDate);e.isAllDay&&(r=r.startOf("day"));var o=s.cloneDeep(e.reminders||[]);a.set({isAllDay:e.isAllDay,dueDate:r.utc().format(i.format.atomTime),repeatFlag:e.repeatFlag,reminders:o}),a.setItemsNewId(a.get("reminders"))}else a.set({remindTime:null,dueDate:null,reminders:null,isAllDay:null,repeatFlag:null,reminders:null});t.push(a)}),this.add(t,{merge:!0})},getCommonReminders:function(){try{for(var e,t,i=this.map(function(e){return e.get("reminders")}),n={},s=0;t=i[s];s++)for(var r,o=0;r=t[o++];)if(s){if(e!==t.length)return null;if(!n[r.trigger])return null}else n[r.trigger]=!0,e=t.length;return i[0]}catch(l){return a.log(l),null}},getCommonIsAllDay:function(){var e=this.map(function(e){return e.get("isAllDay")});return e=_.uniq(e),1==e.length?_.isUndefined(e[0])?null:e[0]:!0},getCommonRepeatFlag:function(){var e=this.map(function(e){return e.get("repeatFlag")});return e=_.uniq(e),1==e.length?_.isUndefined(e[0])?null:e[0]:null},getCommonPriority:function(){var e=_.uniq(this.pluck("priority"));return 1==e.length?e[0]:0},getCommonProjectId:function(){var e=_.uniq(this.pluck("projectId"));return 1==e.length?e.shift():null},getCommonStatus:function(){var e=_.uniq(this.pluck("status"));return 1===e.length?e[0]:0}})}),define("configs/limit",["require","exports","module","configs/settings"],function(e,t){var i=e("configs/settings"),n={},s={projectNumber:299,projectTaskNumber:999,shareUserNumber:19,subtaskNumber:199},a={projectNumber:19,projectTaskNumber:99,shareUserNumber:1,subtaskNumber:19,inboxTaskNumber:999};return n=i.user.isGFS?_.extend({},s):_.extend({},a),n.pro=_.extend({},s),n.commentWordLimit=140,n.uploadFileSize=5e6,n.subtaskWordLimit=512,n.taskTitleWordLimit=512,n.taskContentWordLimit=16e4,n.taskDescWordLimit=2048,n.remindersFreeLimit=2,n.remindersProLimit=5,n.subscribeLimit=5,n}),define("utils/limit",["require","exports","module","configs/limit","configs/keycode"],function(e,t){var i=e("configs/limit"),n=e("configs/keycode");t.isOverLimitTitle=function(e,t){return s(e,t.length>=i.taskTitleWordLimit)},t.isOverLimitContent=function(e,t){return s(e,t.length>=i.taskContentWordLimit)},t.isOverLimitDesc=function(e,t){return s(e,t.length>=i.taskDescWordLimit)};var s=function(e,t){var i=e.keyCode===n.backspace,s=_.contains([n.left_arrow,n.up_arrow,n.right_arrow,n.down_arrow],e.keyCode),a=e.keyCode===n.c&&e.metaKey,r=e.keyCode===n.a&&e.metaKey,o=e.keyCode===n.x&&e.metaKey,l=e.keyCode===n.z&&e.metaKey;return!t||r||a||o||l||s||i?!1:!0}}),define("utils/convert",["require","exports","module","configs/regexp","utils/browser","utils/dom","configs/dict","service/plugin","utils/log"],function(e,t){var i=e("configs/regexp"),n=e("utils/browser"),s=e("utils/dom"),a=e("configs/dict"),r=e("service/plugin"),o=e("utils/log");t.convertToHtml=function(e){e=e.replace(/</g,"&lt;").replace(/>/g,"&gt;");var t,i=twttr.txt.extractEntitiesWithIndices(e);return t=r.isPluginEnable(a.pluginId.tag)?twttr.txt.autoLinkEntities(e,i,{hashtagClass:"searchTag"}):twttr.txt.autoLinkEntities(e,i,{unrenderTag:!0})},t._replaceHtml=function(e){var t=e.text();e.html(t.replace(i.tag,"&amp;$1").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\s/gi,"&nbsp;"))},t.convertToEdit=function(e){var i=e.text(),a=e.get(0),r=s.hasUserSelection(),l=r,c=n.getIeVersion();if(document.selection&&(l=r.text),n.isIE)if(void 0===l||l.toString().length||c&&9>c)t._replaceHtml(e);else{var d=document.createRange();d.setStart(a,0),r.anchorNode&&d.setEnd(r.anchorNode,r.anchorOffset);var u=d.toString().length;t._replaceHtml(e),u&&s.placeCaretAt(a,u)}else if(n.isFirefox||n.isSafari){for(var h=r.anchorOffset,p=r.anchorNode,m=0;m<a.childNodes.length&&p!=a.childNodes[m];m++)h+=a.childNodes[m].textContent.length;h=h<i.length?h:i.length,o.log("caret position: ",h),r.removeAllRanges(),t._replaceHtml(e);var d=document.createRange();a.childNodes[0]?(d.selectNodeContents(a.childNodes[0]),d.setStart(a.childNodes[0],h),d.setEnd(a.childNodes[0],h)):d.setStart(a,0),r.addRange(d)}else t._replaceHtml(e)}}),define("modules/link-editor/editor",["require","exports","module","utils/browser","utils/dom","utils/log","utils/analytics","utils/limit","utils/convert","view/tip","lang/index"],function(e,t){function i(e){this.options=e||{},this.$el=this.makeHtml(),this.setupListener(),this.options.text?this.setText(this.options.text):this.syncText(),this.showViewer(),this.initAutosize()}var n=e("utils/browser"),s=e("utils/dom"),a=e("utils/log"),o=e("utils/analytics"),l=e("utils/limit"),c=e("utils/convert"),d=e("view/tip").View,u=e("lang/index");return i.prototype.$=function(e){return this.$el.find(e)},i.prototype.makeHtml=function(){var e,t,i,s,a=this.options.readonly?!1:n.isIE?!0:!1,o=this.options.whereUseIt,l="",c="";return t="placeholder='"+this.options.empty+"'","title"===o?(l="title task-title",c="title task-title typeahead"):"content"===o?(l="td-content",c="td-content content typeahead"):"desc"===o&&(l="td-sub-desc",c="td-sub-desc sub-desc typeahead placeholder-hide"),i="<div class='link-viewer link-views "+l+"' contenteditable='"+a+"'></div>",e="<textarea class='link-editor link-views "+c+"' "+t+"></textarea>",r="<textarea class='link-editor link-views td-content typeahead content' "+t+"></textarea>",s=$("<div class='editor-with-link'>"+i+e+"</div>"),n.isIE&&s.find("textarea").html(""),s},i.prototype.syncText=function(){var e=this.$(".link-editor").val(),t=this.$(".link-viewer");t.html("content"===this.options.whereUseIt?this.convert(e):this.convertText(e))},i.prototype.setupListener=function(){this.options.readonly&&(this.$(".link-editor").attr("readonly","true"),this.$(".link-viewer").click(function(e){return e=e||window.event,e.preventDefault(),!1}));var e=this,t=this.options.whereUseIt;return this.$el.on("keydown",".link-editor",function(e){if(e=e||window.event,"title"===t){if(l.isOverLimitTitle(e,$(this).val()))return e.preventDefault(),e.stopPropagation(),!1}else if("content"===t){if(l.isOverLimitContent(e,$(this).val()))return e.preventDefault(),e.stopPropagation(),!1}else if("desc"===t&&l.isOverLimitDesc(e,$(this).val())){e.preventDefault(),e.stopPropagation();{new d({text:u.get("limit_desc_tip")})}return!1}}).on("keyup",".link-editor",function(){return setTimeout(function(){return e.syncText()})}).on("input",".link-editor",function(t){e.syncText(),e.refreshHeight()}).on("paste",".link-editor",function(){return setTimeout(function(){return e.syncText()})}).on("blur",".link-editor",function(){return e.showViewer()}).on("click",".link-viewer a",function(t){return t=t||window.event,e.stopPropagation(t)}).on("click",function(t){return t=t||window.event,e.whenFocus(t)}).on("mouseover",".link-editor",function(){"desc"===t&&e.$el.find(".link-editor").attr("placeholder",u.get("write_some_description"))}).on("mouseout",".link-editor",function(){"desc"===t&&e.$el.find(".link-editor").attr("placeholder","")}),n.isSafari&&this.$el.on("mouseup",function(t){var i=s.hasUserSelection();i&&i.toString().length&&e.whenFocus(t)}),this},i.prototype.refreshHeight=function(e){if(-1!==["title","desc"].indexOf(this.options.whereUseIt)){var t=this.$el.find(".link-editor"),i=t.height();t.parent().css("height",i)}},i.prototype.initAutosize=function(){var e=this;-1!==["title","desc"].indexOf(this.options.whereUseIt)&&setTimeout(function(){e.$el.find(".link-editor").autosize()},10)},i.prototype.adjustSize=function(){var e=this;this.$el.height("auto"),setTimeout(function(){e.$el.find(".link-editor").trigger("autosize")},10)},i.prototype.whenFocus=function(e){e=e||window.event,$target=$(e.target),$target.is(".link-viewer")?this.showEditor(e):$target.is(".editor-with-link")&&(this.showEditor(e),this.simulateCaretEnd())},i.prototype.stopPropagation=function(e){return e=e||window.event,e.stopPropagation(),!0},i.prototype.showEditor=function(e){var t,i,n,r=this.$(".link-editor").get(0),o=s.hasUserSelection(),l=o;if(!e||!$(e.target).is("a"))if(document.selection&&(l=o.text),l&&l.toString().length)this.$(".link-editor").show(),i=this.getLength(o,"anchorNode"),n=this.getLength(o,"focusNode"),n>i?r.setSelectionRange(i,n):r.setSelectionRange(n,i),r.focus();else if(t=this.getLength(o,"anchorNode"),this.$(".link-editor").show(),e){var c=this.$(".link-editor").parents("#content-view"),d=c.scrollTop();this.$(".link-editor").focus();var u=c.scrollTop();u!=d&&c.scrollTop(d),this.simulateCaret(t)}Backbone.trigger("refreshAutoComplete"),a.log("show editor")},i.prototype.getLength=function(e,t){var i,s,r;if(null!==e){if("anchorNode"==t?(i=e.anchorNode,anchorOffset=e.anchorOffset):(i=e.focusNode,anchorOffset=e.focusOffset),s=this.$el.get(0),r=document.createRange()||document.body.createTextRange(),!r)return 0;if(null!=s&&r.setStartBefore(s),null!=i)try{r.setEnd(i,anchorOffset)}catch(o){a.log(o)}return n.isIE?r.toString().replace(/\n/g,"").length:r.toString().length}return 0},i.prototype.showViewer=function(){var e=this.$(".link-editor").val();return $.trim(e).length>0?this.$(".link-editor").hide():void 0},i.prototype.convertTitle=function(e){return c.convertToHtml(e)},i.prototype.convert=function(e){var t=c.convertToHtml(e);return t+"<br>"},i.prototype.convertText=function(e){return c.convertToHtml(e)},i.prototype.recordLength=function(){var e,t,i,n,s;return null!=window.getSelection?(s=window.getSelection(),e=s.anchorNode,t=s.anchorOffset,i=this.$(".link-viewer").get(0),n=document.createRange(),null!=i&&n.setStartBefore(i),null!=e&&n.setEnd(e,t),n.toString().length,s.removeAllRanges(),s.addRange(n),s.toString().length):0},i.prototype.simulateCaret=function(e){try{this.$(".link-editor").get(0).selectionStart=e,this.$(".link-editor").get(0).selectionEnd=e}catch(t){o.error("simulateCaret_error"),a.log("simulateCaret ::",t)}},i.prototype.simulateCaretEnd=function(){var e=this.$(".link-editor").val().length;this.simulateCaret(e)},i.prototype.getText=function(){return this.$(".link-editor").val()},i.prototype.setText=function(e){this.$(".link-editor").swap(e),this.syncText()},i}),define("modules/multi-select/menu",["require","exports","module"],function(e,t){var i=function(e){this.initOptions(e),this.init()},n=i.prototype;n.initOptions=function(e){this.profiles=e.data||[],this.selects=e.selects||[]},n.emit=function(e,t){var i=this;this.eventsOutside[e]&&$.each(this.eventsOutside[e],function(e,n){n.call(i,t)})},n.on=function(e,t){e&&"function"==typeof t&&(t in this.eventsOutside[e]||this.eventsOutside[e].push(t));

},n.trigger=function(e,t){var i=this;this.eventsInside[e]&&$.each(this.eventsInside[e],function(e,n){n.call(i,t)})},n.bind=function(e,t){e&&"function"==typeof t&&(t in this.eventsInside[e]||this.eventsInside[e].push(t))},n.template=function(){this.el=$("<div>"),this.el.addClass("multi-select-menu"),this.el.append('<div class="select-title" data-toggle="dropdown"></div>'),this.el.append('<div class="select-arrow" data-toggle="dropdown">▾</div>');var e=$("<div>").addClass("select-list"),t=$.map(this.profiles,function(e,t){return"<div class='option-item' data-key='"+e.key+"' >"+e.value+"</div>"}).join("");e.append(t),this.el.append(e)},n.renderTitle=function(){for(var e=this.getSelectedPfs(),t="",i=[],n=0;n<e.length;n++)i.push(e[n].value);t=""+i.join(", ");var s=this.el.find(".select-title");return s.text(t),s},n.checkData=function(){if(!this.selects)throw new Error("no select");if(!this.profiles||!this.profiles.length)throw new Error("no profiles")},n.getSelectedPfs=function(){for(var e=[],t=this.selects,i=this.profiles,n=0;n<t.length;n++)for(var s=0;s<i.length;s++)i[s].key===t[n]&&e.push(i[s]);return e.length||e.push(this.profiles[0]),e},n.init=function(){this.eventsInside={close:[],select:[]},this.eventsOutside={close:[],select:[]},this.checkData(),this.template(),this.renderTitle(),this.renderSelectdItem(),this.startBind()},n.bindItem=function(){var e=this;this.el.on("click",".option-item",function(t){t.stopPropagation();var i=$(t.target).attr("data-key");e.justUseItem(i),e.renderTitle(),e.emit("select",e.getSelectingPf(i))})},n.getSelectingPf=function(e){for(var t=0;t<this.profiles.length;t++)if(this.profiles[t].key===e)return this.profiles[t]},n.selectItem=function(e){~this.selects.indexOf(e)||this.selects.push(e),this.selectItemUi(e)},n.selectItemUi=function(e){var t='.option-item[data-key="'+e+'"]';this.el.find(t).addClass("selected-item")},n.unSelectItem=function(e){var t=this.selects.indexOf(e);if(-1!==t){this.selects.splice(t,1);var i='.option-item[data-key="'+e+'"]';this.el.find(i).removeClass("selected-item"),this.renderTitle()}},n.removeAllSelected=function(){this.selects=[],this.el.find(".option-item").removeClass("selected-item")},n.renderSelectdItem=function(){for(var e=0;e<this.selects.length;e++)this.selectItemUi(this.selects[e])},n.justUseItem=function(e){~this.selects.indexOf(e)?this.unSelectItem(e):this.selectItem(e)},n.startBind=function(){this.bindItem(),this.bind("select",this.trySelectItem),this.bind("close",this.tryClose)},n.trySelectItem=function(e){this.justUseItem(e),this.renderTitle()},n.tryClose=function(){this.el.removeClass("open")},n.remove=function(){this.el.remove()},t.Menu=i}),define("modules/drop-menu/menu",["require","exports","module"],function(e,t){var i=function(e){this.profiles=e.data,this.select=e.select,this.init()},n=i.prototype;n.emit=function(e,t){var i=this;null!=this.eventsOutside[e]&&$.each(this.eventsOutside[e],function(e,n){n.call(i,t)})},n.on=function(e,t){null!=e&&"function"==typeof t&&(t in this.eventsOutside[e]||this.eventsOutside[e].push(t))},n.trigger=function(e,t){var i=this;null!=this.eventsInside[e]&&$.each(this.eventsInside[e],function(e,n){n.call(i,t)})},n.bind=function(e,t){null!=e&&"function"==typeof t&&(t in this.eventsInside[e]||this.eventsInside[e].push(t))},n.template=function(){this.el=$("<div>"),this.el.addClass("select-menu"),this.el.append('<div class="select-title" data-toggle="dropdown"></div>'),this.el.append('<div class="select-arrow" data-toggle="dropdown">▾</div>');var e=$("<div>").addClass("select-list"),t=$.map(this.profiles,function(e,t){return"<div class='option-item' data-key='"+e.key+"' >"+e.value+"</div>"}).join("");e.append(t),this.el.append(e)},n.renderTitle=function(){var e=this.findSelected(this.select);this.el.find(".select-title").text(e.value)},n.checkData=function(){if(null==this.select)throw new Error("no select");if(null==this.profiles)throw new Error("no profiles");if(this.profiles.length<1)throw new Error("profiles empty")},n.findSelected=function(e){null==e&&(e=this.select);var t;return $.each(this.profiles,function(i,n){n.key==e&&(t=n)}),null==t&&(t=this.profiles[0]),t},n.init=function(){this.eventsInside={select:[]},this.eventsOutside={select:[]},this.checkData(),this.template(),this.renderSelected(),this.renderTitle(),this.startBind()},n.bindItem=function(){var e=this;this.el.on("click",".option-item",function(t){var i=$(t.target).attr("data-key");e.justUseItem(i),e.emit("select",e.findSelected(i)),e.renderSelected()})},n.renderSelected=function(){this.el.find(".selected-item").removeClass("selected-item");var e='.option-item[data-key="'+this.select+'"]',t=this.el.find(e).addClass("selected-item");t.get(0)&&t.get(0).scrollIntoViewIfNeeded&&t.get(0).scrollIntoViewIfNeeded()},n.justCloseMenu=function(){this.el.find(".selected-item").removeClass("selected-item")},n.justUseItem=function(e){this.select=e,this.renderSelected();var t=this.findSelected(e);this.el.find(".select-title").text(t.value)},n.startBind=function(){this.bindItem(),this.bind("select",this.trySelectItem)},n.trySelectItem=function(e){this.justUseItem(e)},t.Menu=i}),define("hbs!template/reminder_ahead_item",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o="",l=i.helperMissing,c=this.escapeExpression;return o+='\n  <div id="r-custom" class="r-select-custom r-select shadow pop-bg">\n    <div class="r-custom-container clearfix">\n      <input type="text" class="r-custom-num half-menu input-sml left text-center" value="15">\n      <div class="r-custom-unit r-select-unit half-menu right">\n        <!-- placeholder for select unit -->\n      </div>\n    </div>\n    <div class="ahead-tip"></div>\n    <div class="confirm-container btns">\n      <button id="custom-cancel" class="btn-tny btn-cancel">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"cancel",r):l.call(t,"I18n","cancel",r)))+'</button>\n      <button id="custom-confirm" class="btn-tny btn-primary">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"ok",r):l.call(t,"I18n","ok",r)))+"</button>\n    </div>\n  </div>\n"})}),define("modules/timecard/reminder-custom",["require","exports","module","modules/drop-menu/menu","lang/index","utils/calculate","configs/regexp","configs/dict","utils/index","configs/keycode","utils/dom","hbs!template/reminder_ahead_item"],function(e,t){var i=e("modules/drop-menu/menu").Menu,n=e("lang/index"),s=(e("utils/calculate"),e("configs/regexp")),a=e("configs/dict"),r=e("utils/index"),o=e("configs/keycode"),l=e("utils/dom"),c=a.triggerUnit,d={M:"minute",H:"hour",D:"day",W:"week"},u="TRIGGER:",h="s",p="_before",m={};t.View=Backbone.View.extend({tagName:"li",template:e("hbs!template/reminder_ahead_item"),messages:function(){this.on("customChange",this.listenCustomChanged)},events:{"keyup .r-custom-num":"keyupCustomDigit","keydown .r-custom-num":"keydownCustomDigit","blur .r-custom-num":"blurCustomDigit","focus .r-custom-num":"focusCustomDigit","click #custom-cancel":"cancelCustom","click #custom-confirm":"confirmCustom"},initialize:function(e){this.initData(e),this.render(),this.initVariables(),this.initComponents(),this.messages(),this.writeReminder()},initData:function(e){_.extend(this,e),m.trigger=u+(this.parent.isAllDay?"-P1D":"-PT15M"),this.ahead=m.trigger.slice(8)},initVariables:function(){this.$custom=this.$(".r-select-custom"),this.$cnum=this.$(".r-custom-num"),this.$cunit=this.$(".r-custom-unit")},initComponents:function(){this.initAheadCustom()},render:function(){this.$el.html(this.template())},_changeOptionsText:function(){for(var e=this.fmenu.el.find(".option-item"),t=this.fmenu.profiles=this._getProfiles(),i=0;i<e.length;i++)$(e[i]).text(t[i].value);this.fmenu.trigger("select",this.fmenu.select)},writeReminder:function(){var e=this.$(".ahead-tip"),t="";t=n.get(this.num>1?d[this.unit]+h+p:d[this.unit]+p),t=t.replace("%s1",this.num),e.text(t)},_hideCustom:function(){this.$custom.addClass("hide"),this.parent.toggleActiveReminder()},_showCustom:function(){this.$custom.removeClass("hide"),l.adjustPositionTop(this.$("#r-custom"))},cancelCustom:function(){this._hideCustom(),this.parent.menu.unSelectItem("custom")},_turnToWeek:function(e){return 7===parseInt(this.num)&&"D"===this.unit?e+="1W":e=e+this.num+this.unit,e},_coverTrigger:function(){var e="",t="TRIGGER:";return"M"===this.unit||"H"===this.unit?e="-PT":("D"===this.unit||"W"===this.unit)&&(e="-P"),e=this._turnToWeek(e),t+e},createReminder:function(){return m.id=ObjectId(),m.trigger=this._coverTrigger(),r.cloneDeep(m)},confirmCustom:function(){this.parent.reminders.push(this.createReminder()),this.parent.updateReminders(),this.parent.initMultiMenu(),this._hideCustom()},_hasTime:function(){return!this.parent.isAllDay},keydownCustomDigit:function(e){var t=($.caretPos(e.currentTarget),e.which?e.which:e.keyCode);return o.backspace===t||o["delete"]===t||o.left_arrow===t||o.right_arrow===t?!0:void(t>=o[0]&&t<=o[9]||t>=o.numpad_0&&t<=o.numpad_9||t===o.up_arrow||t===o.down_arrow||e.preventDefault())},keyupCustomDigit:function(e){var t=60,i=$(e.target).val();Number(i)?i>t&&(i=t,$(e.target).val(i)):$(e.target).val("1").select(),this.num=this.$cnum.val(),this.writeReminder(),this._changeOptionsText()},focusCustomDigit:function(e){$(e.target).select()},blurCustomDigit:function(){this.num=this.$cnum.val(),this.writeReminder()},listenCustomChanged:function(){this.num=this.$cnum.val(),this.writeReminder()},_getProfiles:function(){var e=r.cloneDeep(d);if(this.num>1)for(k in e)e[k]=e[k]+h;var t=[{key:"D",value:n.get(e.D)},{key:"W",value:n.get(e.W)}];if(this._hasTime()){t.splice(1,1);var i=[{key:"M",value:n.get(e.M)},{key:"H",value:n.get(e.H)}];t=i.concat(t)}return t},_getCustomNumUnit:function(){var e=s.trigger,t=m.trigger.match(e),i=15,n="M";for(k in c)if(t[k]){i=parseInt(t[k]),n=c[k].substr(0,1).toUpperCase();break}return{num:i,unit:n}},initAheadCustom:function(){var e=this.ahead;if("none"===e||"PT0S"===e)this._hasTime()?(this.unit="M",this.num=15):(this.unit="D",this.num=1);else{var t=this._getCustomNumUnit();this.num=t.num,this.unit=t.unit}this.$cnum.val(this.num),this.$custom.addClass("hide");var n,s,a=this;n=this._getProfiles(),this.fmenu=s=new i({data:n,select:a.unit}),this.$cunit.append(s.el),s.on("select",function(e){a.unit=e.key,a.trigger("customChange")})}})}),define("hbs!template/reminder_ahead",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o="",l=i.helperMissing,c=this.escapeExpression;return o+='<div class="hint-icon">\n  <a class="icon icons">\n    <i class="icon_home icon-reminder active-icon"></i>\n    <i class="icon_home icon-reminder-white normal-icon"></i>\n  </a>\n</div>\n\n<div id="r-smart" class="r-select-smart r-select">\n  <!-- placeholder for select -->\n</div>\n\n<div class="smart-btns btns">\n    <button id="reminder-cancel" class="btn-tny btn-cancel">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"cancel",r):l.call(t,"I18n","cancel",r)))+'</button>\n    <button id="reminder-confirm" class="btn-tny btn-primary">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"ok",r):l.call(t,"I18n","ok",r)))+"</button>\n</div>\n\n\n"})}),define("modules/timecard/reminder-ahead",["require","exports","module","modules/multi-select/menu","lang/index","utils/dom","utils/index","configs/regexp","configs/dict","utils/calculate","utils/timeformat","configs/limit","service/prefs","modules/timecard/reminder-custom","view/modal/get-upgrade","service/userProfile","hbs!template/reminder_ahead"],function(e,t){var i=e("modules/multi-select/menu").Menu,n=e("lang/index"),s=e("utils/dom"),a=e("utils/index"),r=e("configs/regexp"),o=e("configs/dict"),l=e("utils/calculate"),c=(e("utils/timeformat"),e("configs/limit")),d=e("service/prefs"),u=e("modules/timecard/reminder-custom").View,h=e("view/modal/get-upgrade").View,p=e("service/userProfile"),m=o.triggerUnit,f="TRIGGER:",g="_before";t.View=Backbone.View.extend({template:e("hbs!template/reminder_ahead"),initialize:function(e){this.initData(e),this.render(),this.initDom(),this.renderCommepnts(),this.listenTimecardClick()},initData:function(e){_.extend(this,e),this.oldReminders=a.clone(this.reminders),this.oldIsAllDay=this.isAllDay,this.dailyRTime=d.getLocalHourString(d.getDailyRemindTime()),this.dailyRTimeText=n.get("bracket").replace("%s1",this.dailyRTime)},renderCommepnts:function(){this.initMultiMenu(),this.initCustom()},processReminders:function(){this.checkReminders(),this.uniqReminders(),this.sortReminders()},render:function(){this.$el.html(this.template({})),this.toggleActiveReminder()},checkReminders:function(){var e=/(-PT0M|-PT0H|-P0D|-P0W)$/,t=[];_.each(this.reminders,function(i){i.trigger.match(e)&&(i.trigger=f+"PT0S"),t.push(i)}),this.reminders=t},_changeSelectTitle:function(){var e=this.menu.renderTitle(),t=e.text();t===n.get("no_reminder")&&(t=n.get("set_reminder")),t.replace(this.dailyRTimeText,""),e.text(t)},initDom:function(){this.$smart=this.$("#r-smart"),this.$btns=this.$(".smart-btns")},getAheads:function(){var e=[];return this.processReminders(),_.each(this.reminders,function(t){e.push(t.trigger.slice(8))}),e},_getAheadText:function(e){var t,i=r.trigger,s=f+e,a="",o=s.match(i),l={key:s.slice(8),value:""};for(k in m)if(o[k]){t=parseInt(o[k]),a=n.get(t>1?m[k]+g:m[k].substr(0,m[k].length-1)+g),l.value=a.replace("%s1",t)+(this._hasTime()?"":this.dailyRTimeText);break}return l},_hasTime:function(){return!this.isAllDay},_getSmartOptions:function(){var e,t,i=[],s=this.getAheads(),a=[{key:"none",value:n.get("no_reminder")}];this.isAllDay?(e=["PT0S","-P1D","-P3D","-P5D","-P1W"],i=[{key:"PT0S",value:n.get("due_date_remind_time")+this.dailyRTimeText},{key:"-P1D",value:""+n.get("day_before").replace("%s1",1)+this.dailyRTimeText},{key:"-P3D",value:""+n.get("days_before").replace("%s1",3)+this.dailyRTimeText},{key:"-P5D",value:""+n.get("days_before").replace("%s1",5)+this.dailyRTimeText},{key:"-P1W",value:""+n.get("week_before").replace("%s1",1)+this.dailyRTimeText},{key:"custom",value:n.get("custom")}]):(e=["PT0S","-PT5M","-PT30M","-PT1H","-P1D"],i=[{key:"PT0S",value:n.get("on_time")},{key:"-PT5M",value:""+n.get("minutes_before").replace("%s1",5)},{key:"-PT30M",value:""+n.get("minutes_before").replace("%s1",30)},{key:"-PT1H",value:""+n.get("hour_before").replace("%s1",1)},{key:"-P1D",value:""+n.get("day_before").replace("%s1",1)},{key:"custom",value:n.get("custom")}]),i=a.concat(i),t=_.difference(s,e);var r=[].concat(e);return _.each(t,function(e){if("none"!==e){var t=this._getAheadText(e);r=r.concat(e),r=r.sort(l.compareReminder);var n=r.indexOf(e);i.splice(n+1,0,t)}},this),{options:i,selected:s}},listenTimecardClick:function(){var e=this;setTimeout(function(){$("#js-timecard").on("click",function(t){t=t||window.event,!$(t.target).closest("#r-smart").length&&e.$(".multi-select-menu").hasClass("open")&&e.cancelReminders()})},10)},initBtns:function(){this.menu.el.find(".select-list").append(this.$btns),this.listenBtns()},listenBtns:function(){var e=this;this.$("#reminder-cancel").on("click",function(){e.cancelReminders()}),this.$("#reminder-confirm").on("click",function(){e.confirmReminders()})},initMultiMenu:function(){var e=this,t=this._getSmartOptions();this.$smart.removeClass("hide"),this.menu=new i({data:t.options,selects:t.selected.length?t.selected:["none"]}),this.$smart.empty().append(this.menu.el),this.initBtns(),this._changeSelectTitle(),this.menu.on("select",function(t){e._selectControl(t),e._changeSelectTitle()});var n=this.menu.el.find(".select-list");this.menu.el.find(".select-title").on("click",function(){setTimeout(function(){s.adjustPositionTop(n)})})},initCustom:function(){this.customView=new u({parent:this}),this.$el.append(this.customView.el)},_selectControl:function(e){if("none"===e.key)return this.unReminders(),this.menu.removeAllSelected(),void this.menu.trySelectItem("none");if(this.menu.unSelectItem("none"),"custom"===e.key)this.showCustomRminder();else{var t=e.key,i=this.getAheads();~i.indexOf(t)?this.deleteReminder(t):this.addReminder(t)}},unReminders:function(){this.isAllDay=!0,this.reminders=[],this.updateReminders(),this.renderCommepnts()},showCustomRminder:function(){return this.checkFreeLimit()||this.checkMaxLimit()?void this.showLimitTip():(this.menu.trigger("close"),void this.customView._showCustom())},showLimitTip:function(){Backbone.trigger("confirmCard"),new h({type:"reminder"})},addReminder:function(e){if(this.checkFreeLimit()||this.checkMaxLimit())return void this.showLimitTip();var t=f+e,i={id:ObjectId(),trigger:t};this.reminders.push(i),this.updateReminders()},deleteReminder:function(e){var t=[];_.each(this.reminders,function(i){i.trigger.match(e)||t.push(i)}),this.reminders=t,this.updateReminders()},confirmReminders:function(){this.menu.trigger("close"),this.toggleActiveReminder(),this.oldReminders=a.clone(this.reminders),this.oldIsAllDay=this.isAllDay},cancelReminders:function(){this.reminders=a.clone(this.oldReminders||[]),this.isAllDay=this.oldIsAllDay,this.updateReminders(),this.menu.el.remove(),this.initMultiMenu(),this.toggleActiveReminder()},updateReminders:function(){this.trigger("remindersUpdate",this.reminders,this.isAllDay)},uniqReminders:function(){this.reminders=_.uniq(this.reminders,!1,function(e){return e.trigger})},sortReminders:function(){this.reminders=this.reminders.sort(l.compareReminder)},clearReminder:function(){this.reminders=[]},setOnTimeByClock:function(){this.reminders=[];var e={id:ObjectId(),trigger:f+"PT0S"};this.reminders.push(e),this.updateReminders()},checkFreeLimit:function(){var e=this.reminders.length;return!p.isPro()&&c.remindersFreeLimit<=e?!0:!1},checkMaxLimit:function(){var e=this.reminders.length;return c.remindersProLimit<=e?!0:!1},_hasReminders:function(){return this.reminders.length?_.every(this.reminders,function(e){return!/none/.test(e.trigger)}):!1},toggleActiveReminder:function(){this._hasReminders()?this.$el.addClass("has-reminder"):this.$el.removeClass("has-reminder")}})}),define("hbs!template/reminder",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o="",l=i.helperMissing,c=this.escapeExpression;return o+='<div class="choose-time line">\n  <div class="dropdown bootstrap-timepicker">\n    <a class="fake-del delete"></a>\n    <input id="time-editor" type="text" class="input-sml text-center" maxlength="8" placeholder="',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"set_time",r):l.call(t,"I18n","set_time",r)))+'"/>\n  </div>\n</div>\n<div class="reminder-ahead-section line">\n  <!-- place holder for ahead options -->\n</div>\n'})}),define("modules/timecard/reminder",["require","exports","module","lang/index","utils/index","utils/dom","utils/timeformat","modules/timecard/reminder-ahead","hbs!template/reminder"],function(e,t){var i=(e("lang/index"),e("utils/index")),n=e("utils/dom"),s=e("utils/timeformat"),a=e("modules/timecard/reminder-ahead").View;return t.View=Backbone.View.extend({template:e("hbs!template/reminder"),className:"reminder-settings",events:{"click #time-editor":"listenTimeEditor","click .delete":"deleteClock"},render:function(){this.$el.html(this.template())},initialize:function(e){this.defaultOptions(),this.extractOptions(e),this.render(),this.initComponents()},initComponents:function(){this.initClock(),this.initAhead()},hasSetClock:function(){var e=!this.settings.isAllDay&&!!i.hasReminders(this.settings.reminders);return e},deleteClock:function(e){this.timepicker.val(""),this.settings.isAllDay=!0,this.domCloseClock(),this.settings.reminders=[],this.initAhead(),this.trigger("settingsUpdate",this.exposeOptions(this.settings))},initClock:function(){this.initTimepicker(),this.hasSetClock()&&(this.domOpenClock(),this.setTime(this.settings.clock))},initTimepicker:function(){var e=this;return this.timepicker=this.$("#time-editor"),this.timepicker.on("keydown",i.timeKeyLimit),this.timepicker.on("click",function(t){var i=t.which?t.which:event.button,s=n.getInputCaretPosition(t.currentTarget);return 6!==s&&7!==s||1!==i?void 0:e.timepicker.timepicker("toggleMeridian")}),this.timepicker.timepicker({showMeridian:this.settings.meridiem,defaultTime:!1}).on("changeTime.timepicker",function(t){e.listenClockChange(t.time.value)})},initAhead:function(){var e=this;this.reminderItemsView&&this.reminderItemsView.remove(),this.reminderItemsView=new a({reminders:this._filterReminders(this.settings.reminders),isAllDay:this.settings.isAllDay}),this.$(".reminder-ahead-section").empty().append(this.reminderItemsView.el),this.reminderItemsView.on("remindersUpdate",function(t,i){e.listenRemindersUpdate(t,i)})},defaultOptions:function(){this.settings={}},extractOptions:function(e){this.settings.meridiem=e.meridiem,this.settings.clock=e.clock||this.getNextHour(e),this.settings.reminders=e.reminders,this.settings.isAllDay=_.isEmpty(e.reminders)?!0:e.isAllDay},_filterReminders:function(e){var t=[],i=!1;return _.each(e,function(e){e.trigger.match(/none|undefined/i)||t.push(e)}),e=t,e=_.uniq(e,i,function(e){return e.trigger}),e=_.isEmpty(e)?[]:e},exposeOptions:function(e){var t={clock:e.clock,reminders:this._filterReminders(e.reminders),isAllDay:e.isAllDay};return t},listenRemindersUpdate:function(e,t){this.settings.reminders=e;var i=this._filterReminders(e);_.isEmpty(i)||t?(this.settings.isAllDay=!0,this.domCloseClock()):(this.settings.isAllDay=!1,this.domOpenClock()),this.trigger("settingsUpdate",this.exposeOptions(this.settings))},listenClockChange:function(e){this.settings.clock=e,this.domOpenClock(),this.defaultToday(),this.trigger("settingsUpdate",this.exposeOptions(this.settings))},setTime:function(e){this.timepicker.timepicker("setTime",e)},listenTimeEditor:function(){this.defaultToday(),this.hasSetClock()||this.reminderItemsView.setOnTimeByClock(),this.settings.clock=this.settings.clock||this.getNextHour(this.settings),this.setTime(this.settings.clock),this.domOpenClock(),this.settings.isAllDay=!1,this.initAhead(),this.trigger("settingsUpdate",this.exposeOptions(this.settings))},defaultToday:function(){this.settings.dueDate||this.trigger("forceToday")},getNextHour:function(e){var t=e.meridiem?"hh:00 A":"HH:00";return s.prefMoment().lang("en").startOf("hour").add("hours",1).format(t)},domOpenClock:function(){this.$el.addClass("has-time")},domCloseClock:function(){this.$el.removeClass("has-time"),this.timepicker.val("")}}),t}),define("modules/square-menu/menu",["require","exports","module"],function(e,t){var i=function(e){this.profiles=e.data,this.select=e.select,this.eventsInside={select:[]},this.eventsOutside={select:[]},this.init()},n=i.prototype;n.emit=function(e,t){var i=this;null!=this.eventsOutside[e]&&$.each(this.eventsOutside[e],function(e,n){n.call(i,t)})},n.on=function(e,t){null!=e&&"function"==typeof t&&(t in this.eventsOutside[e]||this.eventsOutside[e].push(t))},n.trigger=function(e,t){var i=this;null!=this.eventsInside[e]&&$.each(this.eventsInside[e],function(e,n){n.call(i,t)})},n.bind=function(e,t){null!=e&&"function"==typeof t&&(t in this.eventsInside[e]||this.eventsInside[e].push(t))},n.template=function(){this.el=$("<div>").addClass("select-squares");var e=$.map(this.profiles,function(e){var t='<div class="select-item" data-key="'+e.key+'">'+e.value+"</div>";return t}).join("");this.el.html(e)},n.checkData=function(){if(!this.profiles.length)throw new Error("no data given");if(null==this.select.length)throw new Error("wrong selection")},n.init=function(){this.checkData(),this.template(),this.markSelected(),this.bindEvents()},n.markSelected=function(){var e=this;$.each(this.profiles,function(t,i){var n='div[data-key="'+i.key+'"]';e.has(e.select,i.key)?$(e.el).find(n).addClass("item-selected"):$(e.el).find(n).removeClass("item-selected")})},n.bindEvents=function(){this.bindClick();var e=this;this.bind("select",function(t){e.onSelect(t)})},n.onSelect=function(e){this.select=e,this.markSelected()},n.bindClick=function(){var e=this;$(this.el).on("click",".select-item",function(t){var i=$(t.target),n=i.attr("data-key");e.has(e.select,n)?(e.select=e.minus(e.select,n),i.removeClass("item-selected")):(e.select.push(n),i.addClass("item-selected")),e.markSelected(),e.emit("select",e.select)})},n.minus=function(e,t){var i=[];return $.map(e,function(e){t!=e&&i.push(e)}),i},n.has=function(e,t){var i=!1;return $.map(e,function(e){e==t&&(i=!0)}),i},t.Menu=i}),define("hbs!template/repeat_end",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o="",l=i.helperMissing,c=this.escapeExpression;return o+='<div class="repeat-end-wrap">\n	<div class="repeat-end-container upper-half">\n      <div class="repeat-end-type line">\n        <div id="end-type-select" class="end-type-select">\n           \n        </div>\n      </div>\n\n      <div class="set-details">\n        <div id="js-set-count" class="set-end-count">\n          <div class="repeat-count line">\n            <span>',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"repeat_end_after",r):l.call(t,"I18n","repeat_end_after",r)))+'</span>\n            <input id="end-count-input" type=\'text\' class="repeat-digit" size="3" value="" />\n            <span>',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"repeat_end_occurrences",r):l.call(t,"I18n","repeat_end_occurrences",r)))+'</span>\n          </div>\n        </div>\n\n        <div id="js-set-date" class="set-end-date">\n            <div class="repeat-until line">\n              <span>',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"repeat_end_on",r):l.call(t,"I18n","repeat_end_on",r)))+'</span>\n              <input id="end-date-input" class="text-center repeat-end-input input-sml" type=\'text\' size="10" value="" autocomplete="off" />\n            </div>\n        </div>\n      </div>\n  </div>\n</div>'})}),define("modules/timecard/repeat-end",["require","exports","module","utils/dom","lang/index","utils/timeformat","configs/settings","offline/storage","modules/drop-menu/menu","configs/keycode","service/prefs","hbs!template/repeat_end"],function(e,t){var i=(e("utils/dom"),e("lang/index")),n=e("utils/timeformat"),s=(e("configs/settings"),e("offline/storage"),e("modules/drop-menu/menu").Menu),a=e("configs/keycode"),r=e("service/prefs");t.View=Backbone.View.extend({id:"js-repeat-end",className:"repeat-end",template:e("hbs!template/repeat_end"),events:{"click #end-count-input":"clickCountInput","keydown #end-count-input":"keydownCountInput","keyup #end-count-input":"keyupCountInput","keydown #end-date-input":"keydownDateInput","keyup #end-date-input":"keyupDateInput","blur #end-date-input":"blurDateInput"},initialize:function(e){this.tparam=e,this.defaultOptions(e),this.render(),this.initComponents(),this.listenEvents(),this.limitDigit={min:1,max:999}},render:function(){this.$el.html(this.template())},defaultOptions:function(){this.endParam={type:this.tparam.count?"count":this.tparam.until?"date":"never",count:this.tparam.count||null,until:this.tparam.until||null,dueDate:n.dateToMoment(this.tparam.date).format("YYYY-MM-DD")}},initComponents:function(){this.initEndType(),this.initEndCount(),this.initEndDate(),this.updateVisibleStatus(this.endParam)},initEndType:function(){var e,t,n=this;e=[{key:"never",value:i.get("repeat_end_never")},{key:"date",value:i.get("repeat_end_date")}],this.menu=t=new s({data:e,select:this.endParam.type}),this.$("#end-type-select").append(t.el),t.on("select",function(e){return n.changeRepeatEndType(e)})},changeRepeatEndType:function(e){if(this.endParam.type=e.key,"never"===e.key)this.endParam.count=null,this.endParam.until=null;else if("count"===e.key)this.endParam.count=this.$("#end-count-input").val(),this.endParam.until=null;else{var t=this.$("#end-date-input").val();this.endParam.until=t,this.endParam.count=null}this.updateVisibleStatus(this.endParam),this.trigger("repeatEndSettingsUpdate",this.endParam)},initEndCount:function(){var e=this.endParam.count||"1";this.$("#end-count-input").val(e)},clickCountInput:function(e){$(e.target).select(),e.stopPropagation()},keydownCountInput:function(e){var t=$.caretPos(e.currentTarget),i=e.which?e.which:e.keyCode;if(a.backspace===i||a["delete"]===i||a.left_arrow===i||a.right_arrow===i)return!0;if(i>=a[0]&&i<=a[9]||i>=a.numpad_0&&i<=a.numpad_9||i===a.up_arrow||i===a.down_arrow){var n=$(e.target).val();if(i===a.up_arrow&&n<this.limitDigit.max)n=Number(n)+1,$(e.target).val(n);else if(i===a.down_arrow&&n>this.limitDigit.min)n=Number(n)-1,$(e.target).val(n);else if(n.length>2||n>99&&t>=2||n>this.limitDigit.max||t>2)return e.preventDefault()}else e.preventDefault()},keyupCountInput:function(e){var t=$(e.target).val();Number(t)?(t>this.limitDigit.max&&(t=this.limitDigit.max,$(e.target).val(t)),this.endParam.count=t):(this.endParam.count=this.limitDigit.min,$(e.target).val("1").select()),this.trigger("repeatEndSettingsUpdate",this.endParam)},initEndDate:function(){this.defaultEndDate(),this.initCalendar()},defaultEndDate:function(){var e,t=this.endParam.dueDate,i="yearly"===this.tparam.oldFreq?this.tparam.oldFreq:this.tparam.freq;if(this.endParam.until)return this.endParam.date=n.dateToMoment(this.endParam.until).format("YYYY-MM-DD");switch(i){case"daily":e=n.getWeekLater(t);break;case"weekly":e=n.getMonthLater(t);break;case"monthly":e=n.getYearLater(t);break;case"yearly":e=n.get5YearLater(t);break;default:e=t}this.endParam.date=e},refreshDefaultEndDate:function(){var e,t=this.endParam.dueDate,i="yearly"===this.tparam.oldFreq?this.tparam.oldFreq:this.tparam.freq;switch(i){case"daily":e=n.getWeekLater(t);break;case"weekly":e=n.getMonthLater(t);break;case"monthly":e=n.getYearLater(t);break;case"yearly":e=n.get5YearLater(t);break;default:e=t}this.endParam.date=e},initCalendar:function(){var e=this,t=this.$("#end-date-input");this.calendar=new Kalendae.Input(t[0],{month:1,model:"single",format:"YYYY-MM-DD",direction:"future",dayOutOfMonthClickable:!0,weekStart:e.tparam.weekStart||r.getWeekStartDay(),selected:e.endParam.date,useYearNav:!1,navSelector:!0,side:"smart",blackout:function(t){return t.format("YYYY-MM-DD")<=e.endParam.dueDate},subscribe:{change:function(){e.trigger("dateChange",this.getSelected())}}}),$(this.calendar.container).addClass("k-pop repeat-end-pop").on("click",function(e){$(e.target).parent().hasClass("k-days")&&t.blur(),e.preventDefault(),e.stopPropagation()})},keyupDateInput:function(e){var t=this.calendar.getSelected(),i=this.endParam.dueDate;i>=t||"Invalid date"===t||(this.endParam.until=t,this.trigger("repeatEndSettingsUpdate",this.endParam))},blurDateInput:function(e){var t=this.calendar.getSelected(),i=this.endParam.dueDate,s=n.getOneDayLater(i);(i>=t||"Invalid date"===t||void 0===t)&&(this.calendar.setSelected(s),e.target.value=s,this.endParam.until=s,this.trigger("repeatEndSettingsUpdate",this.endParam))},refreshParam:function(e){this.tparam=e},listenEvents:function(){this.on("dateChange",this.listenDateChange),this.on("changeEndDefDate",this.listenFreqChange)},listenFreqChange:function(e){this.refreshParam(e),this.refreshDefaultEndDate(),this.calendar.input.value=this.endParam.date,this.listenDateChange(this.endParam.date)},listenDateChange:function(e){this.endParam.date=e,"date"===this.menu.select&&(this.endParam.until=e,this.trigger("repeatEndSettingsUpdate",this.endParam))},domSetCount:function(e){this.$("#js-set-count").toggleClass("open",e)},domSetDate:function(e){this.$("#js-set-date").toggleClass("open",e)},decideCountStatus:function(e){return"count"===this.endParam.type},decideDateStatus:function(e){return"date"===this.endParam.type},updateVisibleStatus:function(e){this.domSetCount(this.decideCountStatus(e)),this.domSetDate(this.decideDateStatus(e))},onClose:function(){this.remove()}})}),define("hbs!template/repeat_advance",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o="",l=i.helperMissing,c=this.escapeExpression;return o+='	<div class="repeat-advance-inner">\n	 <div class="upper-half">\n	 		\n	 	  <div class="repeat-firset-section">\n	 	  	<div class="repeat-type line">\n	 	  	  <div id="repeat-type">\n	 	  	     \n	 	  	  </div>\n	 	  	</div>\n\n	 	  	<div class="repeat-freq line clearfix">\n\n	 	  	  \n	 	  	  <div class="half-menu repeat-interval left">\n	 	  	    <span class="title-every">',
r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"every",r):l.call(t,"I18n","every",r)))+'</span>\n	 	  	    <input id="repeat-advance-input" type=\'text\' class="text-right repeat-digit input-sml" value="1" />\n	 	  	  </div>\n\n		 	  	<div class="half-menu repeat-frequency right">\n		 	  		<div id="repeat-frequency">\n		 	  		   \n		 	  		</div>\n		 	  	</div>\n\n		 	  	\n	 	  	</div>\n	 	  </div>\n	 </div>\n\n		\n	  <div id="repeat-second-section" class="repeat-second-section">\n	    <div class="set-details">\n	      <div class="set-week line">\n	        <!-- placeholder for week settings -->\n	      </div>\n\n	      <!-- 每月重复,天/周 -->\n	      <div class="set-month">\n	        <div class="line clearfix">\n	          <span class="radio half-menu left">\n                <input type="radio" name="repeatMonth" class="repeat-radio" id="repeat-date" value="date" checked="true" />\n                <label for="repeat-date">\n	              ',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"each",r):l.call(t,"I18n","each",r)))+'\n	            </label>\n	          </span>\n	          <span class="radio half-menu right">\n\n                <input type="radio" name="repeatMonth" class="repeat-radio" id="repeat-week" value="week" />\n                <label for="repeat-week">\n	              ',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"on_the",r):l.call(t,"I18n","on_the",r)))+'\n	            </label>\n	          </span>\n	        </div>\n		      <div class="repeat-month-type set-month-date open line">\n		        \n		        <!-- placeholder for month date options -->\n		      </div>\n\n		      <div class="repeat-month-type set-month-week line clearfix">\n		        <div class="half-menu month-week-left left">\n		        <!-- placeholder for month week digits -->\n		        </div>\n		        \n		        <div class="half-menu month-week-right right">\n		        <!-- placeholder for month week days -->\n		        </div>\n		      </div>\n	      	\n	      </div>\n	    </div>\n	  </div>\n\n\n	  <!-- repeat end setting -->\n	  <div id="repeat-end-view">\n\n	  </div>\n\n	  \n	  <div class="repeat-third-section">\n	    <div class="confirm-container section btns">\n	      <button class="cancel-card btn-tny btn-cancel">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"cancel",r):l.call(t,"I18n","cancel",r)))+'</button>\n	      <button class="confirm-advance-card btn-tny btn-primary">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"ok",r):l.call(t,"I18n","ok",r)))+"</button>\n	    </div>\n	  </div>\n\n	</div>\n"})}),define("modules/timecard/repeat-advance",["require","exports","module","modules/drop-menu/menu","modules/square-menu/menu","lang/index","utils/dom","utils/timeformat","utils/index","modules/timecard/repeat-end","configs/dict","service/prefs","hbs!template/repeat_advance"],function(e,t){var i=e("modules/drop-menu/menu").Menu,n=e("modules/square-menu/menu").Menu,s=e("lang/index"),a=e("utils/dom"),r=e("utils/timeformat"),o=e("utils/index"),l=e("modules/timecard/repeat-end").View,c=e("configs/dict"),d=e("service/prefs"),u={D:"day",W:"week",M:"month"},h="s";t.View=Backbone.View.extend({id:"js-repeat-advance",className:"tc-repeat-advance shadow pop-bg",template:e("hbs!template/repeat_advance"),events:{"click #repeat-advance-input":"focusDigitInput","keydown #repeat-advance-input":"keydownRepeatDigit","keyup #repeat-advance-input":"keyupRepeatDigit","click .repeat-radio":"switchRepeatMonthType","click .cancel-card":"cancelCard"},initialize:function(e){this.parentView=e.parentView,this.opt=o.cloneDeep(e.param),this.defaultOptions(e.param),this.render(),this.initComponents(),this.setPosition(),this.triggerSettingsUpdate()},initComponents:function(){this.initRepeatType(),this.initRepeatFreq(),this.initRepeatDigit(),this.initWeekSetting(),this.initMonthSetting(),this.updateVisibleStatus(),this.initRepeatEnd()},setPosition:function(){var e=this;setTimeout(function(){a.adjustPositionTop(e.$el)})},initRepeatEnd:function(){var e=this;this.repeatEndView&&this.repeatEndView.onClose(),this.repeatEndView=new l(this.tparam),this.repeatEndView.$el.appendTo(this.$("#repeat-end-view")),this.repeatEndView.on("repeatEndSettingsUpdate",function(t){return e.repeatEndSettingsUpdate(t)})},triggerSettingsUpdate:function(e){return this.parentView.advancedSettingsUpdate(e?e:this.tparam)},repeatEndSettingsUpdate:function(e){var t=e;this.tparam.count=t.count?parseInt(t.count):null,this.tparam.until=t.until?r.dateToMoment(t.until)._d:null,this.triggerSettingsUpdate(),this.setPosition()},render:function(){this.$el.html(this.template())},defaultOptions:function(e){var t=$("#js-timecard .k-selected").attr("data-date")||$("#js-timecard .k-today").attr("data-date"),i=e.date||t,n=moment(i),s=["SU","MO","TU","WE","TH","FR","SA"],a=s[n.weekday()],r=n.dates(),o=e.count,l=e.until;this.tparam={date:i,weekStart:e.weekStart||d.getWeekStartDay(),weekdays:_.isEmpty(e.weekdays)?[a]:e.weekdays,monthdays:_.isEmpty(e.monthdays)?[r]:e.monthdays,onMonth:e.onMonth||"date",freq:e.freq&&"yearly"!==e.freq?e.freq:"weekly",kind:"advanced",repeatFrom:e.repeatFrom===c.repeatFromType.dueDate||e.repeatFrom===c.repeatFromType.completedTime?e.repeatFrom:c.repeatFromType.dueDate,digit:e.digit||1,mweekdays:e.mweekdays||{},count:o,until:l,oldFreq:e.freq}},initRepeatType:function(){var e,t,n=this;e=[{key:c.repeatFromType.dueDate,value:s.get("repeat_advance_duedate")},{key:c.repeatFromType.completedTime,value:s.get("repeat_advance_completion_date")}],t=new i({data:e,select:this.tparam.repeatFrom}),this.$("#repeat-type").append(t.el),t.on("select",function(e){return n.changeRepeatType(e)})},initRepeatFreq:function(){var e,t,n=this;e=this._freqOptions(),this.freqMenu=t=new i({data:e,select:this.tparam.freq}),this.$("#repeat-frequency").append(t.el),t.on("select",function(e){return n.changeRepeatFreq(e)})},initWeekSetting:function(){var e,t,i=this,a=this.tparam.weekStart;return t=[{key:"SU",value:s.get("su_week")},{key:"MO",value:s.get("mo_week")},{key:"TU",value:s.get("tu_week")},{key:"WE",value:s.get("we_week")},{key:"TH",value:s.get("th_week")},{key:"FR",value:s.get("fr_week")},{key:"SA",value:s.get("sa_week")}],1===a?t.push(t.shift()):6===a&&t.unshift(t.pop()),e=new n({data:t,select:this.tparam.weekdays}),this.$(".set-week").append(e.el),e.on("select",function(e){return i.changeRepeatWeek(e)}),this.on("reset-weeks",function(){return e.trigger("select",[])})},initMonthSetting:function(){this.initRepeatMonthType(),this.repeatMonthByDate(),this.repeatMonthByWeek()},repeatMonthByDate:function(){var e,t,i=this;t=[];for(var a=1;32>a;a++){var r={key:a,value:a};t.push(r)}return t.push({key:-1,value:s.get("last_day")}),e=new n({data:t,select:this.tparam.monthdays}),this.$(".set-month-date").append(e.el),e.on("select",function(e){return i.changeRepeatMonthDays(e)}),this.on("reset-month-date",function(){return e.trigger("select",[])})},repeatMonthByWeek:function(){this.repeatMonthByWeekDigits(),this.repeatMonthByWeekDays()},repeatMonthByWeekDigits:function(){var e,t,n=this;e=[{key:"1",value:s.get("first")},{key:"2",value:s.get("second")},{key:"3",value:s.get("third")},{key:"4",value:s.get("fourth")},{key:"5",value:s.get("fifth")},{key:"-1",value:s.get("last")}],this.tparam.mweekdays.n=this.tparam.mweekdays.n||"1",t=new i({data:e,select:n.tparam.mweekdays.n}),this.$(".month-week-left").append(t.el),t.on("select",function(e){return n.changeMonthWeekDigits(e)}),this.on("reset-month-week",function(){return t.trigger("select","1")})},repeatMonthByWeekDays:function(){var e,t,n=this;e=[{key:"SU",value:s.get("sunday")},{key:"MO",value:s.get("monday")},{key:"TU",value:s.get("tuesday")},{key:"WE",value:s.get("wednesday")},{key:"TH",value:s.get("thursday")},{key:"FR",value:s.get("friday")},{key:"SA",value:s.get("saturday")}],this.tparam.mweekdays.weekday=this.tparam.mweekdays.weekday||n.tparam.weekdays[0]||"SU",t=new i({data:e,select:n.tparam.mweekdays.weekday}),this.$(".month-week-right").append(t.el),t.on("select",function(e){return n.changeMonthWeekDays(e)}),this.on("reset-month-week",function(){return t.trigger("select","SU")})},changeMonthWeekDigits:function(e){return this.tparam.mweekdays.n=e.key,this.triggerSettingsUpdate()},changeMonthWeekDays:function(e){return this.tparam.mweekdays.weekday=e.key,this.triggerSettingsUpdate()},initRepeatMonthType:function(){var e=this.tparam.onMonth;this.$(".repeat-month-type").removeClass("open"),this.$(".set-month-"+e).addClass("open"),this.$("#repeat-"+e).attr("checked",!0)},switchRepeatMonthType:function(e){e=e||window.event;var t=e.target.value,i={n:this.tparam.mweekdays.n||"1",weekday:this.tparam.mweekdays.weekday||this.tparam.weekdays[0]||"SU"};this.tparam.onMonth=t,this.tparam.mweekdays=i,this.$(".repeat-month-type").removeClass("open"),this.$(".set-month-"+t).addClass("open"),this.trigger("date"===t?"reset-month-week":"reset-month-date"),this.triggerSettingsUpdate()},changeRepeatFreq:function(e){this.tparam.freq=e.key,this.updateVisibleStatus(),this.changeIntervalUnit(),this.repeatEndView&&this.repeatEndView.trigger("changeEndDefDate",this.tparam)},_freqOptions:function(){var e=o.cloneDeep(u);if(this.tparam.digit>1)for(k in e)e[k]=e[k]+h;var t=[{key:"daily",value:s.get(e.D)},{key:"weekly",value:s.get(e.W)},{key:"monthly",value:s.get(e.M)}];return t},_changeOptionsText:function(){for(var e=this.freqMenu.el.find(".option-item"),t=this.freqMenu.profiles=this._freqOptions(),i=0;i<e.length;i++)$(e[i]).text(t[i].value);this.freqMenu.trigger("select",this.freqMenu.select)},changeIntervalUnit:function(){this._changeOptionsText(),this.triggerSettingsUpdate()},resetStatus:function(){this.trigger("reset-weeks"),this.trigger("reset-month-date"),this.trigger("reset-month-week")},changeRepeatType:function(e){this.tparam.repeatFrom=e.key,(e.key===c.repeatFromType.dueDate||e.key===c.repeatFromType.completedTime)&&(this.tparam.weekdays=[],this.tparam.onMonth="date",this.resetStatus()),this.updateVisibleStatus(),this.triggerSettingsUpdate()},changeRepeatWeek:function(e){return this.tparam.weekdays=e,this.triggerSettingsUpdate()},changeRepeatMonthDays:function(e){return this.tparam.monthdays=e,this.triggerSettingsUpdate()},initRepeatDigit:function(){return this.$("#repeat-advance-input").val(this.tparam.digit)},focusDigitInput:function(e){return e=e||window.event,$(e.target).select(),e.stopPropagation()},keydownRepeatDigit:function(e){e=e||window.event;var t=$(e.target),i=$.caretPos(e.currentTarget),n=e.which?e.which:e.keyCode;if(8===n||46===n||37===n||39===n)return!0;if(n>=48&&57>=n||n>=96&&105>=n||38===n||40===n){var s=t.val();if(38===n&&365>s)s=Number(s)+1,t.val(s);else if(40===n&&s>1)s=Number(s)-1,t.val(s);else{if(s.length>2||s>36&&i>=2||s>365)return e.preventDefault();if(i>2)return e.preventDefault();if(2===i&&36===Number(s)&&n>=54&&57>=n)return e.preventDefault();if(1===i){if(Number(s)>=40)return e.preventDefault();if(Number(s)>=36&&n>=54&&57>=n)return e.preventDefault();if(Number(s)>=30&&Number(s)<=35&&n>=55&&57>=n)return e.preventDefault()}if(0===i){if(2===s.length&&n>=52&&57>=n)return e.preventDefault();if(Number(s)>65&&51===n)return e.preventDefault()}}}else e.preventDefault()},keyupRepeatDigit:function(e){e=e||window.event;var t=$(e.target),i=t.val();Number(i)?(i>365&&(i=365,t.val(i)),this.tparam.digit=i):(this.tparam.digit=1,t.val("1").select()),this.changeIntervalUnit()},domSetMonth:function(e){this.$(".set-month").toggleClass("open",e)},decideMonthStatus:function(){return"monthly"===this.tparam.freq&&this.tparam.repeatFrom===c.repeatFromType.dueDate},domSetWeek:function(e){this.$(".set-week").toggleClass("open",e)},decideWeekStatus:function(){return"weekly"===this.tparam.freq&&this.tparam.repeatFrom===c.repeatFromType.dueDate},updateVisibleStatus:function(){this.domSetMonth(this.decideMonthStatus()),this.domSetWeek(this.decideWeekStatus()),this.setPosition()},showTimecardBtns:function(){$("#js-timecard-btns").show()},cancelCard:function(){this.triggerSettingsUpdate(this.opt),this.onClose()},onClose:function(){this.showTimecardBtns(),this.remove()}})}),define("utils/reminder-util",["require","exports","module","configs/dict","service/prefs","utils/timeformat","utils/task-util","configs/settings","lang/index"],function(e,t){var i=e("configs/dict"),n=e("service/prefs"),s=e("utils/timeformat"),a=e("utils/task-util"),r=e("configs/settings"),o=e("lang/index"),l="lunar_yearly";t.extractOptions=function(e,t){var a={meridiem:n.get("showMeridiem"),weekStart:n.getWeekStartDay(),format:i.format.atomTime};if(t?(a.dueDate=t.get("dueDate"),a.repeatFlag=t.get("repeatFlag"),a.reminders=t.get("reminders"),a.isAllDay=t.get("isAllDay"),a.repeatFrom=t.get("repeatFrom")):_.extend(a,e),a.dueDate){var r=s.prefMoment(a.dueDate);a.date=r.format("YYYY-MM-DD"),_.isEmpty(a.reminders)||(a.clock=a.meridiem?r.lang("en").format("hh:mm A"):r.format("HH:mm"))}return a},t.extractRepeat=function(e,n){var s=e;if(n&&(s=t.extractOptions(e,n)),s.repeatFlag){var r=~s.repeatFlag.indexOf("LUNAR"),o=RRule.parseString(a.sliceRepeatFlag(s.repeatFlag));switch(o.freq){case RRule.DAILY:s.kind=s.freq="daily";break;case RRule.WEEKLY:s.kind=s.freq="weekly";break;case RRule.YEARLY:s.kind=s.freq=r?l:"yearly";break;case RRule.MONTHLY:s.kind=s.freq="monthly"}s.digit=o.interval?o.interval:1,s.count=o.count,s.until=o.until,(s.digit>1||_.contains([i.repeatFromType.dueDate,i.repeatFromType.completedTime],s.repeatFrom)||s.count||s.until)&&(s.kind="advanced"),o.byweekday?(s.onMonth="week",7===o.byweekday.length?s.kind="daily":(s.kind="advanced",s.weekdays=_.filter(s.weekdays,function(e){return null!=e}),s.weekdays=_.map(o.byweekday,function(e){switch(e.weekday){case RRule.SU.weekday:return"SU";case RRule.MO.weekday:return"MO";case RRule.TU.weekday:return"TU";case RRule.WE.weekday:return"WE";case RRule.TH.weekday:return"TH";case RRule.FR.weekday:return"FR";case RRule.SA.weekday:return"SA"}}),"week"===s.onMonth&&(s.mweekdays={n:o.byweekday[0].n,weekday:s.weekdays[0]}))):o.bymonthday&&(_.isArray(o.bymonthday)?s.monthdays=o.bymonthday:(s.monthdays=s.monthdays||[],s.monthdays.push(o.bymonthday)))}else s.kind="no",s.repeatFlag=null;return s},t._isLastDayInMonth=function(e,t){if(t.kind===l){var i=t.repeatFlag;return"30"==e.lDay||i&&~i.indexOf("BYMONTHDAY=-1")}var n=s.dateToMoment(t.date),a="YYYY-MM-DD";return n.format(a)==n.endOf("month").format(a)},t._getMonthDays=function(e){var t="Day %s every month",i=e.monthdays,n=t.replace("%s",i.toString());return{date:i,text:n}},t._getRepeatDate=function(e){return e.repeatFrom===i.repeatFromType.completedTime&&e.completeDate?s.prefMoment(e.completeDate).format("D"):e.date?s.prefMoment(e.date).format("D"):s.prefMoment().format("D")},t.ordinate=function(e){var t=e%10;switch(t){case 1:return""+e+"st";case 2:return""+e+"nd";case 3:return""+e+"rd";case-1:return"last";default:return""+e+"th"}},t.getBaseDate=function(e){var i="Day %s every month",n=t._getRepeatDate(e),s=i.replace("%s",t.ordinate(n));return{date:n,text:s}},t.getBaseWeek=function(e){var i=e.mweekdays.n,n=e.mweekdays.weekday,s="Every %d %s";if(!i||!n)return"";var a=s.replace("%d",t.ordinate(i)).replace("%s",n);return{nth:i,weekday:n,text:a}},t.exposeRepeat=function(e,n){var a,c,d,u,h,p,m,f=e,g={};if(n)var f=t.extractRepeat(e,n);if(f.kind===l)var v=new CalendarConverter,y=f.date?new Date(f.date):new Date,k=v.solar2lunar(y),w=(k.lYear,k.lMonth),b=k.lDay,T=(k.lunarYear,k.lunarMonth),I=k.lunarDay;var C=t._isLastDayInMonth(k,f),x=i.repeatFromType.completedTime===f.repeatFrom;switch(f.kind){case"no":d=null;break;case"daily":d=new RRule({freq:RRule.DAILY,interval:1});break;case"weekly":d=new RRule({freq:RRule.WEEKLY,interval:1});break;case"monthly":d=new RRule(C?{freq:RRule.MONTHLY,interval:1,bymonthday:-1}:{freq:RRule.MONTHLY,interval:1});break;case"yearly":d=new RRule({freq:RRule.YEARLY,interval:1});break;case"lunar_yearly":d=new RRule(C?{freq:RRule.YEARLY,interval:1,bymonthday:-1}:{freq:RRule.YEARLY,interval:1});break;case"advanced":switch(f.freq){case"daily":m={freq:RRule.DAILY,interval:f.digit};break;case"weekly":h=function(){switch(f.weekStart){case 0:return RRule.SU;case 1:return RRule.MO;case 2:return RRule.TU;case 3:return RRule.WE;case 4:return RRule.TH;case 5:return RRule.FR;case 6:return RRule.SA}}(),p=_.map(f.weekdays,function(e){return RRule[e]}),p=_.filter(p,function(e){return null!=e}),m={freq:RRule.WEEKLY,interval:f.digit,wkst:h,byweekday:p},x&&(m.byweekday=null);break;case"monthly":"date"===f.onMonth?f.monthdays.length?(a=t._getMonthDays(f),m={freq:RRule.MONTHLY,interval:f.digit,bymonthday:a.date}):C?m={freq:RRule.MONTHLY,interval:f.digit,bymonthday:-1}:(a=t.getBaseDate(f),m={freq:RRule.MONTHLY,interval:f.digit,bymonthday:a.date}):"week"===f.onMonth&&f.mweekdays.n&&f.mweekdays.weekday&&(a=t.getBaseWeek(f),u=a.weekday.toUpperCase(),m={freq:RRule.MONTHLY,interval:f.digit,byweekday:RRule[u].nth(a.nth)}),x&&(m.byweekday=null,m.bymonthday=null);break;case"yearly":m={freq:RRule.YEARLY,interval:f.digit}}m&&f.count&&(m.count=f.count),m&&f.until&&(m.until=f.until),m&&(d=new RRule(m))}if(d){var S=r.iscnlang?d.toText(null,RRULE_CHINESE):d.toText();c=t._orderDaysText(S,f),"advanced"===f.kind&&r.iscnlang&&(c=c.replace(/every weekday/i,"每周 "+o.get("repeat_advance_weekday"))),c=c.replace(/every day/i,o.get("daily")).replace(/(weekdays|weekday)/i,o.get("repeat_advance_weekday")).replace(/every week/i,o.get("weekly")).replace(/every month/i,o.get("monthly")).replace(/ on the last$/i,o.get("last_day_in_month")).replace(/every year/i,f.kind===l?o.get(l)+" "+T+"月 "+(-1!==d.options.bynmonthday.indexOf(-1)?"":I):o.get("yearly")),"advanced"===f.kind&&r.iscnlang&&(c=c.replace(/every /i,"每").replace(/ days/i,"天").replace(/ weeks/i,"周").replace(/ months/i,"月"),"weekly"===f.freq?c=c.replace(/ on /i," "):"date"===f.onMonth?c=c.replace(/ and /i,"和").replace(/ on the /i,"的").replace(/last/,"最后一天").replace(/(st|nd|rd|th)/gi,"日"):"week"===f.onMonth&&(c=c.replace(/ and /i,"和").replace(/ on the last/,"最后一个").replace(/ on the /i,"第").replace(/(st|nd|rd|th)/gi,"个")),c=c.replace(/ for /,";重复").replace(/(times|time)/,"次后结束"),f.until&&(c=c.replace(/[\s]*until[\S\s]+/,";直到"+s.dateToMoment(f.until).format("LL")))),g.preview=c[0].toUpperCase()+c.slice(1),g.repeatFlag=f.kind===l?"LUNAR:"+d.toString()+";BYMONTH="+w+";BYMONTHDAY="+b:"RRULE:"+d.toString().replace(/BYDAY=\+/,"BYDAY=")}else g.preview="",g.repeatFlag=null;return g.preview.length||(g.preview=o.get("no_repeat")),g.repeatFrom=f.repeatFrom,g},t._orderDaysText=function(e,t){if(!t.monthdays||t.monthdays.length<3)return e;var i,n=e.search(/ and /),s=e.match(/\d+(st|nd|rd|th)/gi),a=e.substr(0,e.search(/\d/));if(!s)return e;var r=s.sort(function(e,t){return parseInt(e)<parseInt(t)?-1:1});return i=a+r.join(", "),~t.monthdays.lastIndexOf(-1)?i+=e.substr(n):(i=i.replace(", "+r[r.length-1]," and "+r[r.length-1]),t.count?i+=e.match(/ for \d+ (times|time)/)[0]:t.until&&(i+=e.match(/until[\S\s]*/)[0])),i}}),define("hbs!template/repeat",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){return this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{},'<div class="choose-repeat line" type="text">\n  <div id="repeat-kind">\n    <!-- placeholder for settings -->\n  </div>\n</div>\n<div id="js-advance-repeat-preview" class="advance-repeat-preview cr-pointer"></div>'})}),define("modules/timecard/repeat",["require","exports","module","modules/drop-menu/menu","lang/index","utils/dom","utils/timeformat","configs/settings","modules/timecard/repeat-advance","configs/dict","utils/reminder-util","hbs!template/repeat"],function(e,t){var i=e("modules/drop-menu/menu").Menu,n=e("lang/index"),s=e("utils/dom"),a=(e("utils/timeformat"),e("configs/settings")),r=e("modules/timecard/repeat-advance").View,o=e("configs/dict"),l=e("utils/reminder-util");return t.View=Backbone.View.extend({className:"repeat-settings",template:e("hbs!template/repeat"),events:{"click .choose-repeat .hint-icon i":"toggleRepeat","click #js-advance-repeat-preview":"showAdvanceRepeat"},initialize:function(e){this.defaultOptions(),this.extractOptions(e),this.render(),this.initComponents()},render:function(){return this.$el.html(this.template())},showAdvanceRepeat:function(){var e=this.$("[data-key='advanced']");e&&e.click()},initComponents:function(){return this.initRepeatKind(),this.updateVisibleStatus(this.tparam),this.renderRepeatKind()},initRepeatKind:function(){var e,t,r=this;t=[{key:"no",value:n.get("no_repeat")},{key:"daily",value:n.get("daily")},{key:"weekly",value:n.get("weekly")},{key:"monthly",value:n.get("monthly")},{key:"yearly",value:n.get("yearly")},{key:"advanced",value:n.get("advanced")}],(a.iscnlang||a.isCnSites)&&t.splice(-1,0,{key:"lunar_yearly",value:n.get("lunar_yearly")}),this.repeatKindMenu=e=new i({data:t,select:this.tparam.kind}),this.$("#repeat-kind").append(e.el),this.on("selectKind",function(t){e.trigger("select",t)}),e.on("select",function(e){r.listenRepeatKind(e)});var o=e.el.find(".select-list");e.el.find(".select-title").on("click",function(){setTimeout(function(){s.adjustPositionTop(o)})})},defaultOptions:function(){return this.tparam={weekdays:[],monthdays:[],onMonth:"date",freq:"",kind:"no",repeatFrom:o.repeatFromType.defaultVal,mweekdays:{}}},extractOptions:function(e){var t=this,i=_.extend(this.tparam,e);return _.extend(this.tparam,l.extractRepeat(i)),this.tparam.repeatFrom===o.repeatFromType.completedTime?(this.tparam.weekdays=[],this.tparam.mweekdays={},this.tparam.onMonth="date",_.delay(function(){return t.trigger("settingsUpdate",t.exposeOptions(t.tparam))})):void 0},renderRepeatByTimecard:function(e){this.tparam.date=e.date;var t=this.exposeOptions(this.tparam);e.repeatFlag=t.repeatFlag,this.renderRepeatKind()},exposeOptions:function(e){return l.exposeRepeat(e)},toggleRepeat:function(){this.tparam.kind="no"===this.tparam.kind||null==this.tparam.kind?null!=this.tparam.oldKind?this.tparam.oldKind:"daily":(this.tparam.oldKind=this.tparam.kind,"no"),this.updateVisibleStatus(this.tparam),this.trigger("selectKind",this.tparam.kind),this.renderRepeatKind()},listenRepeatKind:function(e){var t=this.tparam.repeatFrom;return"no"!==this.tparam.kind&&(this.tparam.oldKind=this.tparam.kind),this.tparam.repeatFrom="advanced"===e.key&&(t===o.repeatFromType.dueDate||t===o.repeatFromType.completedTime)?t:o.repeatFromType.defaultVal,this.tparam.kind=e.key,this.updateVisibleStatus(this.tparam),this.renderRepeatKind(),this.trigger("settingsUpdate",this.exposeOptions(this.tparam))},writeBaseDateText:function(e){return this.$('.set-month option[data-key="date"]').text(e)},writeBaseWeekText:function(e){return this.$('.set-month option[data-key="week"]').text(e)},renderOnMonth:function(){var e,t;return e=l.getBaseDate(this.tparam),t=l.getBaseWeek(this.tparam),this.$('.set-month option[data-key="date"]').text(e.text),this.$('.set-month option[data-key="week"]').text(t.text)},renderRepeat:function(){var e;return this.updateRRule(),this.renderOnMonth(),e=this.tparam.preview,this.$(".choose-repeat .preview").text(null!=e&&e.length>0?e:this.viewDatas.noRepeat)},renderRepeatKind:function(){var e=this.exposeOptions(this.tparam),t=this.repeatKindMenu.el.find(".select-title");if(!e.repeatFlag)return this.repeatKindMenu.trySelectItem("no"),t.text(n.get("set_repeat")),this.renderAdvanceRepeatPreview(""),void this.toggleStatus(!1);if(e.repeatFrom===o.repeatFromType.dueDate||e.repeatFrom===o.repeatFromType.completedTime)this.renderAdvanceRepeatPreview(e.preview),t.text(n.get("advanced"));else{this.renderAdvanceRepeatPreview("");var i=t.text();i===n.get("no_repeat")&&(i=n.get("set_repeat")),t.text(i)}},renderAdvanceRepeatPreview:function(e){this.$("#js-advance-repeat-preview").text(e)},toggleStatus:function(e){this.$(".choose-repeat").toggleClass("has-repeat",e)},hideTimecardBtns:function(){$("#js-timecard-btns").hide()},domSetDetail:function(e){e?(this.hideTimecardBtns(),this.advancedRepeatView=new r({parentView:this,param:this.tparam}),this.advancedRepeatView.$el.appendTo($("#js-timecard"))):this.advancedRepeatView&&this.advancedRepeatView.onClose()},advancedSettingsUpdate:function(e){return this.tparam=_.extend(this.tparam,e),this.renderRepeatKind(),this.trigger("settingsUpdate",this.exposeOptions(this.tparam))},decideDetailStatus:function(e){return"advanced"===e.kind},decideRepeatStatus:function(e){return"no"!==e.kind},updateVisibleStatus:function(e){return this.domSetDetail(this.decideDetailStatus(e)),this.toggleStatus(this.decideRepeatStatus(e))}}),t}),define("hbs!template/timecard",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o="",l=i.helperMissing,c=this.escapeExpression;return o+='<div class="tc-inner">\n  <div class="calendar-container"></div>\n  <div class="divider"></div>\n  <div class="reminder-container"></div>\n  <div class="repeat-container line"></div>\n\n  <div id="js-timecard-btns" class="confirm-container btns">\n    <button class="clear-card btn-tny btn-cancel">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"clear",r):l.call(t,"I18n","clear",r)))+'</button>\n    <button class="confirm-card btn-tny btn-primary">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"ok",r):l.call(t,"I18n","ok",r)))+"</button>\n  </div>\n</div>\n\n"})}),define("modules/timecard/timecard",["require","exports","module","modules/timecard/reminder","modules/timecard/repeat","utils/dom","utils/timeformat","utils/index","utils/analytics","utils/task-util","utils/reminder-util","configs/dict","hbs!template/timecard"],function(e,t){var i=e("modules/timecard/reminder").View,n=e("modules/timecard/repeat").View,s=e("utils/dom"),a=e("utils/timeformat"),r=e("utils/index"),o=e("utils/analytics"),l=e("utils/task-util"),c=e("utils/reminder-util"),d=e("configs/dict");return t.View=Backbone.View.extend({className:"timecard pop-shadow boult",id:"js-timecard",template:e("hbs!template/timecard"),events:{"click .confirm-card":"confirmCard","click .confirm-advance-card":"confirmAdvance","click .clear-card":"clearCard","dblclick .k-active":"confirmCard","keydown #time-editor":"saveTimeCard","click .date-toggle":"_analyOpenMon","click .k-btn-next-month":"_analyNextMon","click .k-btn-previous-month":"_analyPrevMon","click .k-btn-today ":"_analyToday"},messages:function(){this.listenTo(Backbone,"confirmCard",this.confirmCard)},_analyOpenMon:function(){o.d_date_btn("open_month")},_analyNextMon:function(){o.d_date_btn("next_month")},_analyPrevMon:function(){o.d_date_btn("prev_month")},_analyToday:function(){o.d_date_btn("today")},_analyDate:function(){var e=this.settings.date,t=this.oldOpt.date,i=t!==e;e&&i&&o.d_date(e)},_analyTime:function(){var e=this.$(".reminder-settings").hasClass("has-time"),t=this.settings.isAllDay!==this.oldOpt.isAllDay,i=e?"has_time":"no_time";t&&o.d_time(i)},_analyReminders:function(){var e=this.settings.reminders,t=this.oldOpt.reminders,i=!_.isEqual(e,t);if(i){var n="none";if(_.isEmpty(e))return o.d_reminder(n),void o.d_reminder_count("0");var s=/(PT0S|-P[1,2,3,5,7]D|-PT5M|-PT30M|-PT1H)/g,a=this.$(".reminder-settings").hasClass("has-time");_.each(e,function(e){var t=e.trigger,i=t.match(s);n=i?"PT0S"===i[0]?a?"PT0S":"PT0S_d":i[0]:"custom",o.d_reminder(n)}),o.d_reminder_count(e.length+"")}},_analyRepeat:function(){var e=this.settings.repeatFlag,t=e!==this.oldOpt.repeatFlag;if(t){var i="never";if(e){var n=RRule.parseString(l.sliceRepeatFlag(e));switch(n.freq){case RRule.DAILY:i="daily";break;case RRule.WEEKLY:i="weekly";break;case RRule.YEARLY:i=-1!==e.indexOf("LUNAR")?"lunar_yearly":"yearly";break;case RRule.MONTHLY:i="monthly"}(n.interval>1||n.byweekday&&n.byweekday.length>1||n.bymonthday&&n.bymonthday.length>1)&&(i="other"),n.until&&(i="end_repeat")}o.d_repeat(i)}},_analyRepeatFrom:function(){var e=this.settings.repeatFrom,t=e!==this.oldOpt.repeatFrom,i=this.settings.repeatFlag,n=this.oldOpt.repeatFlag;i&&(n||d.repeatFromType.defaultVal!==e&&e?t&&o.d_by(e):o.d_by(d.repeatFromType.defaultVal))},analyAfterConf:function(){this._analyDate(),this._analyTime(),this._analyReminders(),this._analyRepeat(),this._analyRepeatFrom(),o.d_btn("save")},render:function(){return this.$el.html(this.template(this.settings))},initialize:function(e){this.initData(e),this.render(),this.initComponents(),this.messages(),this.listenEvents()},initData:function(e){this.settings=_.extend({},c.extractOptions(e)),this.oldOpt=r.cloneDeep(this.settings)},initComponents:function(){this.initCalendar(),this.initReminder(),this.initRepeat()},initCalendar:function(){var e=this,t=this.settings.date,i=this.settings.weekStart;this.calendar=new Kalendae(this.$(".calendar-container").get(0),{month:1,model:"single",dayOutOfMonthClickable:!0,weekStart:i,selected:t,useYearNav:!1,navSelector:!0,subscribe:{change:function(){return e.trigger("dateChange",this.getSelected())}}})},initReminder:function(){var e=this,t=this.settings,n=t.meridiem,s=t.date,a=t.clock,r=t.reminders,o=t.isAllDay,l=new i({meridiem:n,date:s,clock:a,reminders:r,isAllDay:o});return this.$(".reminder-container").empty().append(l.el),l.on("settingsUpdate",function(t){return e.listenReminderUpdate(t)})},initRepeat:function(){var e=this,t=this.settings,i=t.repeatFlag,s=t.repeatFrom,a=t.date,r=t.weekStart;this.repeatView=new n({repeatFlag:i,repeatFrom:s,date:a,weekStart:r}),this.$(".repeat-container").empty().append(this.repeatView.el),this.repeatView.on("settingsUpdate",function(t){return e.listenRepeatUpdate(t)})},exposeOptions:function(e){var t,i,n,s,r,o;return s={},s.reminders=e.reminders,s.isAllDay=e.isAllDay,s.repeatFlag=null!=(o=e.repeatFlag)?o:void 0,s.preview=e.preview||"",s.repeatFrom=e.repeatFrom,r=a.prefMoment(null!=e.date?null!=e.clock?e.date+" "+e.clock:e.date:new Date),i=e.date,t=e.clock,s.dueDate=null!=i?null!=t?(r=i+" "+t,n=e.meridiem?"YYYY-MM-DD hh:mm A":"YYYY-MM-DD HH:mm",a.dateFormatToMoment(r,n).utc().format(e.format)):a.dateFormatToMoment(i,"YYYY-MM-DD").utc().format(e.format):null,s},listenEvents:function(){return this.on("hideCard",this.hideCard),this.on("blurCard",this.blurCard),this.on("forceToday",this.forceToday),this.on("dateChange",this.listenDateChange)},listenDateChange:function(e){return this.settings.date=e,this.repeatView.renderRepeatByTimecard(this.settings),this.trigger("settingsUpdate",this.exposeOptions(this.settings))},listenReminderUpdate:function(e){return this.forceToday(),this.settings.clock=e.clock,this.settings.reminders=e.reminders,this.settings.isAllDay=e.isAllDay,e=this.exposeOptions(this.settings),this.trigger("settingsUpdate",e)},listenRepeatUpdate:function(e){return this.forceToday(),this.settings.repeatFlag=e.repeatFlag,this.settings.repeatFrom=e.repeatFrom,this.settings.preview=e.preview,e=this.exposeOptions(this.settings),this.trigger("settingsUpdate",e)},forceToday:function(){return null==this.settings.date?(this.calendar.setSelected(a.prefMoment().format("YYYY-MM-DD")),this.trigger("dateChange",this.calendar.getSelected())):void 0},hideCard:function(){this.remove()},confirmAdvance:function(){var e=this.settings.repeatFlag,t=RRule.parseString(l.sliceRepeatFlag(e)),i=this.exposeOptions(this.settings);if(t.freq!==RRule.DAILY&&i.repeatFrom!==d.repeatFromType.completedTime){var n=l.getNextDate(e,i.repeatFrom,i.dueDate);this.calendar.setSelected(n)}this.confirmCard()},confirmCard:function(){return Backbone.trigger("updateTaskOrderFromTimecard",this.settings.date),this.forceToday(),this.trigger("confirmTime",this.exposeOptions(this.settings)),s.existAdvanceRepeatView()?void this.repeatView.advancedRepeatView.onClose():(this.hideCard(),void this.analyAfterConf())},saveTimeCard:function(e){var e=e||window.event;13==e.keyCode&&(this.$("#time-editor").blur(),this.confirmCard())},blurCard:function(){this.hideCard(),this.trigger("confirmTime",this.exposeOptions(this.settings))},clearCard:function(){this.hideCard(),this.settings={reminders:null,repeatFlag:null,preview:"",dueDate:null,repeatFrom:"2",isAllDay:null},this.trigger("settingsUpdate",this.exposeOptions(this.settings)),this.trigger("clearTime",this.exposeOptions(this.settings)),o.d_btn("clear")}}),t}),define("hbs!template/time_menu",["Handlebars"],function(e){
return e.template(function(e,t,i,n,s){function a(e,t){var n,s="";return s+='\n  <a class="item avoid-event ',(n=i.activeClass)?n=n.call(e,{hash:{},data:t}):(n=e.activeClass,n=typeof n===l?n.apply(e):n),s+=c(n)+'" data-time="',(n=i.time)?n=n.call(e,{hash:{},data:t}):(n=e.time,n=typeof n===l?n.apply(e):n),s+=c(n)+'">\n    ',(n=i.iconClass)?n=n.call(e,{hash:{},data:t}):(n=e.iconClass,n=typeof n===l?n.apply(e):n),(n||0===n)&&(s+=n),s+='\n    <p class="text-secondary time-text text-sml">',(n=i.text)?n=n.call(e,{hash:{},data:t}):(n=e.text,n=typeof n===l?n.apply(e):n),s+=c(n)+"</p>\n  </a>\n"}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var r,o="",l="function",c=this.escapeExpression,d=this;return r=i.each.call(t,t.times,{hash:{},inverse:d.noop,fn:d.program(1,a,s),data:s}),(r||0===r)&&(o+=r),o+="\n \n"})}),define("view/taskdetail/time-menu",["require","exports","module","utils/index","utils/timeformat","lang/index","configs/dict","hbs!template/time_menu"],function(e,t){{var i=e("utils/index"),n=e("utils/timeformat"),s=e("lang/index");e("configs/dict")}t.View=Backbone.View.extend({className:"time-menu pop-shadow",template:e("hbs!template/time_menu"),events:{"click a":"setTime",click:"stopEvent"},initialize:function(e){this.initData(e),this.render()},initData:function(e){_.extend(this,e)},render:function(){this.$el.html(this.template({times:this.getTimeData()})),$("#quick-time").append(this.$el),$(".td-time").addClass("boult")},stopEvent:function(e){e=e||window.event,e.stopPropagation()},setTime:function(e){var t=$(e.currentTarget).attr("data-time");this.action&&this.action(t),this.onClose()},getTimeData:function(){var e="YYYY-MM-DD",t=["today","tomorrow","nextweek","nextmonth"],a=[n.getStartOfDay(0,"days",e),n.getStartOfDay(1,"days",e),n.getStartOfDay(7,"days",e),n.getStartOfDay(1,"month",e)],r=["today","tomorrow","next_week","next_month"],o=this.dueDate&&n.formatUtcToDateString(this.dueDate);return _.map(t,function(e,t){return{time:a[t],text:s.get(r[t]),activeClass:o===a[t]?"active":"",iconClass:i.svgIcon("icon-quick-"+e,"i-med i-6")}},this)},onClose:function(){this.remove(),this.timeId&&(clearTimeout(this.timeId),this.timeId=null),$(".time-menu").not(".hide").length||$(".td-time.boult").removeClass("boult")},onSlowClose:function(){var e=this;this.timeId=setTimeout(function(){e.onClose()},350)}})}),define("hbs!template/group_sub_menu",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){var n,s="";return s+='\n        <li class="project-item ',(n=i.active)?n=n.call(e,{hash:{},data:t}):(n=e.active,n=typeof n===l?n.apply(e):n),s+=c(n)+'">\n            <a class="project-item" projectid="',(n=i.id)?n=n.call(e,{hash:{},data:t}):(n=e.id,n=typeof n===l?n.apply(e):n),s+=c(n)+'">\n                ',(n=i.iconClass)?n=n.call(e,{hash:{},data:t}):(n=e.iconClass,n=typeof n===l?n.apply(e):n),(n||0===n)&&(s+=n),s+="\n                ",(n=i.name)?n=n.call(e,{hash:{},data:t}):(n=e.name,n=typeof n===l?n.apply(e):n),s+=c(n)+"\n            </a>\n        </li>\n    "}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var r,o="",l="function",c=this.escapeExpression,d=this;return o+='<ul class="antiscroll-inner">\n    ',r=i.each.call(t,t.projects,{hash:{},inverse:d.noop,fn:d.program(1,a,s),data:s}),(r||0===r)&&(o+=r),o+="\n</ul>\n"})}),define("modules/project-menu/groupMenu",["require","exports","module","utils/index","dao/projectdb","hbs!template/group_sub_menu"],function(e,t){var i=e("utils/index"),n=e("dao/projectdb").db;t.View=Backbone.View.extend({className:"dropdown-menu groups-ul i-text",template:e("hbs!template/group_sub_menu"),events:{"click .dropdown-menu a":"close","click a.project-item":"setProject",mouseover:"keepShow"},initialize:function(e){this.initData(e),this.render(),this.initDropdownToggle()},initData:function(e){_.extend(this,e)},setProject:function(e){var e=e||window.event;this.action&&this.action(e,this.hoveredGroup)},keepShow:function(){this.hoveredGroup.addClass("open")},initDropdownToggle:function(){var e=this;$("html").click(function(){e.close()})},hideDropdownMenu:function(){this.$(".dropdown.open").removeClass("open"),this.remove()},render:function(){return this.$el.appendTo(this.appendToView),this.$el.html(this.template({projects:this.getRenderData()})),this.renderScrollBar(),this},renderScrollBar:function(){this.$el.antiscroll()},getRenderData:function(){var e=n.getProjectsByGroupId(this.groupId),t=[],s=this;return e.map(function(e){t[t.length]={id:e.get("id"),active:e.get("id")===s.projectId?"active":"",name:e.get("name"),iconClass:e.get("userCount")>1?i.svgIcon("icon-share-list","i-3"):i.svgIcon("icon-normal-list","i-3")}}),t},onClose:function(){this.hideDropdownMenu()}})}),define("hbs!template/project_menu",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){var n,s="";return s+='\n          <li class="',(n=i.activeClass)?n=n.call(e,{hash:{},data:t}):(n=e.activeClass,n=typeof n===l?n.apply(e):n),s+=c(n)+'" >\n            <a projectid="',(n=i.projectId)?n=n.call(e,{hash:{},data:t}):(n=e.projectId,n=typeof n===l?n.apply(e):n),s+=c(n)+'" ',(n=i.classAttr)?n=n.call(e,{hash:{},data:t}):(n=e.classAttr,n=typeof n===l?n.apply(e):n),(n||0===n)&&(s+=n),s+=" >\n              ",(n=i.itemHtml)?n=n.call(e,{hash:{},data:t}):(n=e.itemHtml,n=typeof n===l?n.apply(e):n),(n||0===n)&&(s+=n),s+="\n            </a>\n          </li>\n        "}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var r,o="",l="function",c=this.escapeExpression,d=this;return o+='<div class="dropdown-menu project-dropdown-menu i-text-i">\n    <ul class="antiscroll-inner">\n        ',r=i.each.call(t,t.lists,{hash:{},inverse:d.noop,fn:d.program(1,a,s),data:s}),(r||0===r)&&(o+=r),o+="\n    </ul>\n</div>"})}),define("modules/project-menu/menu",["require","exports","module","utils/index","dao/projectdb","dao/project-group","modules/project-menu/groupMenu","hbs!template/project_menu"],function(e,t){var i=e("utils/index"),n=e("dao/projectdb").db,s=e("dao/project-group").db,a=e("modules/project-menu/groupMenu").View;t.View=Backbone.View.extend({className:"menu-ul",tagName:"div",template:e("hbs!template/project_menu"),events:{"click a":"selectItem","mouseover .group-item":"showGroupsUl","mouseover .project-dropdown-menu .project-item":"hideGroupsUl"},messages:function(){var e=this;$("html").on("click.dropdown.data-api",function(){setTimeout(function(){e.renderScrollBar()})})},initialize:function(e){this.initProps(e),this.render(),this.messages()},initProps:function(e){_.extend(this,e)},render:function(){var e=this.getLists(this.projectId,this.right);this.$el.html(this.template({lists:e})),this.$wrap.append(this.$el)},renderScrollBar:function(){var e=this.$(".project-dropdown-menu");"none"!==e.css("display")&&e.antiscroll()},getLists:function(e,t){var a=[],r=n.getProjectsNotUnderGroup(),o=s.getGroupsNotEmpty()||[],l=r.concat(o);return l=_.sortBy(l,function(e){return e.get("sortOrder")}),l.unshift(n.projectInbox),a=_.map(l,function(t){var s={activeClass:"",projectId:"",classAttr:"",itemHtml:""};if("group"===t.get("listType")){var a=n.getProjectsByGroupId(t.get("id"));a.map(function(t){t.get("id")===e&&(s.activeClass="active")}),s.projectId=a[0].get("id"),s.classAttr='groupid="'+t.get("id")+'" class="group-item"',s.itemHtml=i.svgIcon("icon-folder","i-3")+t.get("name")+' <span class="direct"></span>'}else t.get("id")===e&&(s.activeClass="active"),s.projectId=t.get("id"),s.itemHtml=t.get("name"),s.classAttr='class="project-item"',s.itemHtml=t.get("userCount")>1?i.svgIcon("icon-share-list","i-3")+s.itemHtml:i.svgIcon("icon-normal-list","i-3")+s.itemHtml;return s})},selectItem:function(e){var t=$(e.currentTarget);if(this.removeActive(),this.setProjectId(t),this.action&&this.action(t),this.subMenuView){var i=this;setTimeout(function(){i.subMenuView.remove()})}this.refreshRender()},refreshRender:function(){var e=this;setTimeout(function(){e.render()})},removeActive:function(){this.$("li").removeClass("active")},showGroupsUl:function(e){var t=$(e.currentTarget),i=t.attr("groupId");this.$("a").not(t).removeClass("open"),t.toggleClass("open"),this.subMenuView&&this.subMenuView.remove(),this.subMenuView=new a({groupId:i,projectId:this.projectId,hoveredGroup:t,appendToView:this.$el,action:_.bind(this.selecteFolder,this)});var n=t.position(),s=t.outerWidth(),r={top:n.top,left:n.left+s},o=t.closest("ul").outerHeight(),l=this.subMenuView.$el.outerHeight();if(n.top+l>o){var c=32;_.extend(r,{top:n.top-l+c})}var d=this.subMenuView.$el.outerWidth(),u=t.offset().left-d,h=window.innerWidth-t.offset().left-s-d;0>h&&u>=-d/2&&_.extend(r,{left:n.left-d}),this.subMenuView.$el.css(r)},hideGroupsUl:function(e){var e=e||window.event,t=this.$(e.currentTarget),i=this;t.removeClass("open"),i.subMenuView&&i.subMenuView.remove()},selecteFolder:function(e,t){this.setGroupItemActive(t),this.action&&this.action($(e.currentTarget))},setGroupItemActive:function(e){e.closest("li").addClass("active")},setProjectId:function(e){var t=e.attr("projectid");this.projectId=t},onClose:function(){$("html").off("click.dropdown.data-api"),this.remove()}})}),define("hbs!template/assignment-menu-item",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){var n,s="";return s+='\n    <a>\n        <img class="avatar med icon-avatar" src="',(n=i.avatar_url)?n=n.call(e,{hash:{},data:t}):(n=e.avatar_url,n=typeof n===c?n.apply(e):n),s+=d(n)+'">\n        ',(n=i.display_name)?n=n.call(e,{hash:{},data:t}):(n=e.display_name,n=typeof n===c?n.apply(e):n),s+=d(n)+"\n    </a>\n"}function r(e,t){var n,s,a,r="";return r+="\n    <a>\n        ",a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-assignment-nobody","i-3",a):u.call(e,"svgIcon","icon-assignment-nobody","i-3",a),(s||0===s)&&(r+=s),r+="\n        ",(s=i.display_name)?s=s.call(e,{hash:{},data:t}):(s=e.display_name,s=typeof s===c?s.apply(e):s),r+=d(s)+"\n    </a>\n"}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var o,l="",c="function",d=this.escapeExpression,u=i.helperMissing,h=this;return o=i["if"].call(t,t.is_assignee,{hash:{},inverse:h.program(3,r,s),fn:h.program(1,a,s),data:s}),(o||0===o)&&(l+=o),l+="\n"})}),define("view/taskdetail/assignment/item",["require","exports","module","lang/index","utils/analytics","service/userProfile","hbs!template/assignment-menu-item"],function(e,t){var i=e("lang/index"),n=e("utils/analytics"),s=e("service/userProfile");t.View=Backbone.View.extend({tagName:"li",template:e("hbs!template/assignment-menu-item"),events:{click:"assign"},initialize:function(e){this.assignee=e.assignee,this.render()},render:function(){var e=this,t=!1;(e.assignee==this.model.get("userId")||null===e.assignee&&-1===parseInt(e.model.get("userId")))&&(e.$el.addClass("active"),t=!0);var n=e.model.get(e.model.get("displayName")?"displayName":"username"),a=n;s.get("userId")===e.model.get("userId")&&(n=i.get("me"));var r=!(-1===parseInt(e.model.get("userId")));e.$el.html(e.template({avatar_url:e.model.get("avatarUrl"),display_name:n,username:a,active:t,is_assignee:r}))},assign:function(){Backbone.trigger("selectAssignee",parseInt(this.model.get("userId"))),n.td_btn("assign")}})}),define("hbs!template/assignment",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){return' data-toggle="dropdown" '}function r(e,t){return" disabled "}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var o,l,c="",d=this,u="function",h=i.blockHelperMissing,p=this.escapeExpression;return c+='<!--<div class="btn-assignment">-->\n    <a id="btn-assignment" ',l={hash:{},inverse:d.program(3,r,s),fn:d.program(1,a,s),data:s},(o=i.ifNotInDisabledList)?o=o.call(t,l):(o=t.ifNotInDisabledList,o=typeof o===u?o.apply(t):o),i.ifNotInDisabledList||(o=h.call(t,o,l)),(o||0===o)&&(c+=o),c+='\n        class="boult"\n       title="',(o=i.tip)?o=o.call(t,{hash:{},data:s}):(o=t.tip,o=typeof o===u?o.apply(t):o),c+=p(o)+'">\n\n    </a>\n    <ul class="dropdown-menu pull-right">\n\n    </ul>\n<!--</div>-->\n'})}),define("hbs!template/assignment-btn",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){var n,s="";return s+='\n    <img class="avatar med" src="',(n=i.avatar_url)?n=n.call(e,{hash:{},data:t}):(n=e.avatar_url,n=typeof n===c?n.apply(e):n),s+=d(n)+'"/>\n'}function r(e,t){var n,s,a,r="";return r+="\n  ",a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-assignment","i-4",a):u.call(e,"svgIcon","icon-assignment","i-4",a),(s||0===s)&&(r+=s),r+="\n"}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var o,l="",c="function",d=this.escapeExpression,u=i.helperMissing,h=this;return o=i["if"].call(t,t.is_assignee,{hash:{},inverse:h.program(3,r,s),fn:h.program(1,a,s),data:s}),(o||0===o)&&(l+=o),l+="\n"})}),define("view/taskdetail/assignment/list",["require","exports","module","dao/shareduserdb","model/share-user","lang/index","view/taskdetail/assignment/item","configs/settings","service/userProfile","hbs!template/assignment","hbs!template/assignment-btn"],function(e,t){var i=e("dao/shareduserdb"),n=e("model/share-user").Model,s=e("lang/index"),a=e("view/taskdetail/assignment/item").View,r=e("configs/settings"),o=e("service/userProfile");t.View=Backbone.View.extend({template:e("hbs!template/assignment"),templateBtn:e("hbs!template/assignment-btn"),tagName:"div",className:"btn-assignment dropdown",events:{"click #btn-assignment":"handleBtnAssignment"},messages:function(){this.listenTo(i.db.collection,"refreshUserCollection",this.refreshAssignee),this.listenTo(this.tasks[0],"change:assignee",this.refreshAssignee)},initialize:function(e){this.projectId=e.projectId,this.tasks=e.tasks,this.itemView=[],this.sameAssignee=this.isSameAssignee(),this.messages(),this.render()},isSameAssignee:function(){var e=!0,t=null;return _.each(this.tasks,function(i){return t&&parseInt(t)!==parseInt(i.get("assignee"))?void(e=!1):void(t=i.get("assignee"))}),e},isSingleAssignee:function(){return 1===this.tasks.length&&this.tasks[0].get("assignee")},isMultiAssignee:function(){return this.tasks.length>1&&this.sameAssignee},render:function(){var e=null,t=s.get("assignment_label"),n="",a=-1;if(this.isSingleAssignee()||this.isMultiAssignee()){var r=i.db.getUserById(this.tasks[0].get("assignee"),this.projectId,!0);r&&(e=r.get("avatarUrl"),a=r.get("userId"),n=r.get("username"),t=r.get("userId")===o.get("userId")?s.get("me"):r.get("username"))}this.$el.html(this.template({tip:t})),this.refreshAssignmentButton(e,a,n)},emptySharedUsersMenu:function(){this.$el.find(".dropdown-menu").empty()},refreshAssignmentButton:function(){var e=arguments[0]?arguments[0]:r.defaultAvatar,t=arguments[1]?arguments[1]:null,i=arguments[2]?arguments[2]:null,n=!(-1===parseInt(t)||null===t);this.$el.find("#btn-assignment").html(this.templateBtn({avatar_url:e,username:i,is_assignee:n}))},handleBtnAssignment:function(){this.showSharedUsersMenu(!0)},refreshAssignee:function(){var e=i.db.getUserById(this.tasks[0].get("assignee"));if(e){var t=e.get(e.get("displayName")?"displayName":"username"),n=e.get("userId")===o.get("userId")?s.get("me"):t;this.refreshAssignmentButton(e.get("avatarUrl"),e.get("userId"),t),this.$el.find("#btn-assignment").attr("title",n)}else this.refreshAssignmentButton(),this.$el.find("#btn-assignment").attr("title",s.get("assignment_label"));this.refreshMenu()},refreshMenu:function(){var e=this;if(this.$el.hasClass("open")){for(var t=i.db.getUsersByProjectId(this.projectId,!1),r=this.itemView.length-1;r>=0;r--)this.itemView[r].remove();e.emptySharedUsersMenu();var l;l=this.isSingleAssignee()||this.isMultiAssignee()?{assignee:this.tasks[0].get("assignee")}:{assignee:null};var c=new n({username:s.get("assignment_nobody"),userId:"-1"}),d=_.clone(l);d.model=c;var u=new a(d);e.$el.find(".dropdown-menu").append(u.el),e.itemView.push(u),_.each(t,function(t){if(t.get("isAccept")){var i=_.clone(l);i.model=t;var n=new a(i);if(t.get("userId")===o.get("userId"))return e.$el.find(".dropdown-menu li:first").after(n.el),void e.itemView.push(n);e.$el.find(".dropdown-menu").append(n.el),e.itemView.push(n)}})}},showSharedUsersMenu:function(e){var t=this;if(t.$el.find(".dropdown-toggle").dropdown(),!t.$el.hasClass("open")){var r=i.db.getUsersByProjectId(this.projectId,e);t.emptySharedUsersMenu();var l;l=this.isSingleAssignee()||this.isMultiAssignee()?{assignee:this.tasks[0].get("assignee")}:{assignee:null};var c=new n({username:s.get("assignment_nobody"),userId:"-1"}),d=_.clone(l);d.model=c;var u=new a(d);t.$el.find(".dropdown-menu").append(u.el),t.itemView.push(u),_.each(r,function(e){if(e.get("isAccept")){var i=_.clone(l);i.model=e;var n=new a(i);if(e.get("userId")===o.get("userId"))return t.$el.find(".dropdown-menu li:first").after(n.el),void t.itemView.push(n);t.$el.find(".dropdown-menu").append(n.el),t.itemView.push(n)}})}},onClose:function(){this.remove();for(var e=this.itemView.length-1;e>=0;e--)this.itemView[e]&&this.itemView[e].remove()}})}),define("hbs!template/task_detail",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){return" cr-pointer check-toggle "}function r(e,t){return" cr-disabled "}function o(e,t){return' id="reminder-setting" '}function l(e,t){return' id="preview" class="td-reminder cr-pointer" '}function c(e,t){return' class="td-reminder cr-disabled" '}function d(e,t){return' id="quick-set" '}function u(e,t){return" disabled "}function h(e,t){return" "}function p(e,t){return' data-toggle="dropdown" '}function m(e,t){var n,s,a="";return a+='\n      <div class="content td-content">\n        <div class="caption-section section multi td-caption ',s={hash:{},data:t},a+=U((n=i.isTaskCompleted,n?n.call(e,e.status,s):H.call(e,"isTaskCompleted",e.status,s)))+" ",s={hash:{},data:t},a+=U((n=i.getPriorityClass,n?n.call(e,e.priority,s):H.call(e,"getPriorityClass",e.priority,s)))+'">\n          <h4 class="multi-title">\n            <span class="task-select">',s={hash:{},data:t},a+=U((n=i.I18n_Plus,n?n.call(e,"tasks_selected",e.taskCount,s):H.call(e,"I18n_Plus","tasks_selected",e.taskCount,s)))+"</span>\n          </h4>\n        </div>\n      </div>\n    "}function f(e,t){var n,s,a,r="";return r+='\n      <div class="content td-content antiscroll-wrap">\n        <div class="antiscroll-inner" id="content-view">\n          <div id="td-caption" class="caption-section section td-caption">\n            <div class="switch-mode line-right">\n              <div ',a={hash:{},inverse:F.noop,fn:F.program(22,g,t),data:t},(n=i.ifNotInDisabledList)?n=n.call(e,a):(n=e.ifNotInDisabledList,n=typeof n===q?n.apply(e):n),i.ifNotInDisabledList||(n=Y.call(e,n,a)),(n||0===n)&&(r+=n),r+=' class="dropdown">\n                <a class="avoid-event" ',a={hash:{},inverse:F.program(13,u,t),fn:F.program(15,h,t),data:t},(n=i.ifNotInDisabledList)?n=n.call(e,a):(n=e.ifNotInDisabledList,n=typeof n===q?n.apply(e):n),i.ifNotInDisabledList||(n=Y.call(e,n,a)),(n||0===n)&&(r+=n),r+=">\n                  ",a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-text-mode","i-2",a):H.call(e,"svgIcon","icon-text-mode","i-2",a),(s||0===s)&&(r+=s),r+="\n                  ",a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-subtask-mode","i-2",a):H.call(e,"svgIcon","icon-subtask-mode","i-2",a),(s||0===s)&&(r+=s),r+='\n                </a>\n                <ul class="dropdown-menu task-mode-menu icononly dropdown-tny">\n                    <li class="">\n                      <a class="avoid-event mode text" data-mode="text">\n                          ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-text-mode","i-3",a):H.call(e,"svgIcon","icon-text-mode","i-3",a),(s||0===s)&&(r+=s),r+='\n                      </a>\n                    </li>\n                    <li class="">\n                      <a class="avoid-event mode subtask" data-mode="subtask">\n                          ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-subtask-mode","i-3",a):H.call(e,"svgIcon","icon-subtask-mode","i-3",a),(s||0===s)&&(r+=s),r+='\n                      </a>\n                    </li>\n                </ul>\n              </div>\n            </div>\n            <div id="tasktitle" taskid="',(s=i.taskid)?s=s.call(e,{hash:{},data:t}):(s=e.taskid,s=typeof s===q?s.apply(e):s),r+=U(s)+'" class="line-left"></div>\n          </div>\n          <div id="td-container" class="container-section">\n            <!-- editor -->\n            <div id="td-editor" class="td-editor center-section">\n              <div id="taskcontent" class="td-task-text b-h"></div>\n              <div id="task-desc" class="b-h td-task-desc"></div>\n              <ul id="sub-task-list" class="subtasks b-h p-b"></ul>\n            </div>\n            <!-- /editor -->\n\n            <!-- attachment -->\n            <div id="attachment-view" class="section center-section"></div>\n            <!-- /attachment -->\n\n            <!-- loction -->\n            <div id="loction-view" class="section center-section"></div>\n            <!-- /loction -->  \n\n            <!-- comments -->\n            <div id="comments-view" class="section right-section">\n              \n              \n              <p class="cm-handle"></p>\n            </div>\n            <!-- /comments -->\n\n            <div id="task-activity-view" class="section right-section">\n              \n              <p class="ta-handle"></p>\n            </div>\n          </div>\n        </div>\n      </div>\n    '}function g(e,t){return' id="switch-mode" '}function v(e,t){var n,s,a,r="";return r+='\n        <div id="project-setting" class="td-item">\n          <div class="dropup">\n              <a class="dropdown-toggle boult" \n                  ',a={hash:{},inverse:F.program(27,k,t),fn:F.program(25,y,t),data:t},(n=i.ifNotInDisabledList)?n=n.call(e,a):(n=e.ifNotInDisabledList,n=typeof n===q?n.apply(e):n),i.ifNotInDisabledList||(n=Y.call(e,n,a)),(n||0===n)&&(r+=n),r+=">\n              ",a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-move-list","i-2-1 fast-transition",a):H.call(e,"svgIcon","icon-move-list","i-2-1 fast-transition",a),(s||0===s)&&(r+=s),r+='\n              <input type="button" readonly="readonly" placeholder="List..." class="project text-primary" value="',a={hash:{},data:t},r+=U((n=i.getProjectNameById,n?n.call(e,e.projectId,a):H.call(e,"getProjectNameById",e.projectId,a)))+'" title="',a={hash:{},data:t},r+=U((n=i.I18n,n?n.call(e,"move_to",a):H.call(e,"I18n","move_to",a)))+'" \n                  ',a={hash:{},inverse:F.program(31,b,t),fn:F.program(29,w,t),data:t},(s=i.ifNotInDisabledList)?s=s.call(e,a):(s=e.ifNotInDisabledList,s=typeof s===q?s.apply(e):s),i.ifNotInDisabledList||(s=Y.call(e,s,a)),(s||0===s)&&(r+=s),r+=" />\n            </a>\n          </div>\n        </div>\n      "}function y(e,t){return' \n                  data-toggle="dropdown" \n                  '}function k(e,t){return" \n                  disabled \n                  "}function w(e,t){return" \n                  "}function b(e,t){return' \n                  disabled="disabled"\n                  '}function _(e,t){var n,s,a,r="";return r+='\n        <div class="restore dropup td-item">\n          <a id="task-restore-button" class="dropdown-toggle boult" data-toggle="dropdown" >\n            ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-restore","i-2-1 fast-transition",a):H.call(e,"svgIcon","icon-restore","i-2-1 fast-transition",a),(s||0===s)&&(r+=s),r+='\n            <span class="text-def">',a={hash:{},data:t},r+=U((n=i.I18n,n?n.call(e,"restore",a):H.call(e,"I18n","restore",a)))+"</span>\n          </a>\n        </div>\n      "}function T(e,t){var n,s,a,r="";return r+="\n        <a ",a={hash:{},inverse:F.program(13,u,t),fn:F.program(36,I,t),data:t},n=i.ifequal,s=n?n.call(e,e.type,"single",a):H.call(e,"ifequal",e.type,"single",a),(s||0===s)&&(r+=s),r+=">\n            ",a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-comment","i-2-1 fast-transition",a):H.call(e,"svgIcon","icon-comment","i-2-1 fast-transition",a),(s||0===s)&&(r+=s),r+="\n        </a>\n      "}function I(e,t){return' id="task-add-comment-button" '}function C(e,t){var n,s,a,r="";return r+="\n        <a disabled>\n            ",a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-comment","i-2-1 fast-transition",a):H.call(e,"svgIcon","icon-comment","i-2-1 fast-transition",a),(s||0===s)&&(r+=s),r+="\n        </a>\n      "}function x(e,t){var n,s,a,r="";return r+='\n        <a title="',a={hash:{},data:t},r+=U((n=i.I18n,n?n.call(e,"delete",a):H.call(e,"I18n","delete",a)))+'" ',a={hash:{},inverse:F.program(13,u,t),fn:F.program(41,S,t),data:t},(s=i.ifNotInDisabledList)?s=s.call(e,a):(s=e.ifNotInDisabledList,s=typeof s===q?s.apply(e):s),i.ifNotInDisabledList||(s=Y.call(e,s,a)),(s||0===s)&&(r+=s),r+=">\n            ",a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-delete","i-2-1 fast-transition",a):H.call(e,"svgIcon","icon-delete","i-2-1 fast-transition",a),(s||0===s)&&(r+=s),r+="\n        </a>\n      "}function S(e,t){return' id="task-delete-button" '}function D(e,t){var n,s,a,r="";return r+='\n        <a id="task-deleteforever-button">\n           ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-delete-forever","i-2-1 fast-transition",a):H.call(e,"svgIcon","icon-delete-forever","i-2-1 fast-transition",a),(s||0===s)&&(r+=s),r+="\n           \n        </a>\n      "}function j(e,t){var n,s,a,r="";return r+='\n        <a class="dropdown-toggle power-tip boult" ',a={hash:{},inverse:F.program(13,u,t),fn:F.program(17,p,t),data:t},n=i.ifequal,s=n?n.call(e,e.type,"single",a):H.call(e,"ifequal",e.type,"single",a),(s||0===s)&&(r+=s),r+=' title="',a={hash:{},data:t},r+=U((n=i.I18n,n?n.call(e,"more",a):H.call(e,"I18n","more",a)))+'" >\n          ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-more","i-2-1 fast-transition",a):H.call(e,"svgIcon","icon-more","i-2-1 fast-transition",a),(s||0===s)&&(r+=s),r+="\n        </a>\n      "}function $(e,t){var n,s,a,r="";return r+='\n        <a class="dropdown-toggle power-tip" title="',a={hash:{},data:t},r+=U((n=i.I18n,n?n.call(e,"more",a):H.call(e,"I18n","more",a)))+'" disabled>\n          ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-more","i-2-1 fast-transition",a):H.call(e,"svgIcon","icon-more","i-2-1 fast-transition",a),(s||0===s)&&(r+=s),r+="\n        </a>\n      "}function P(e,t){var n,s,a,r="";return r+='\n        <ul class="dropdown-menu pull-right">\n          <li>\n            <a id="upload-attachment-btn">\n              ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-attachment","i-3",a):H.call(e,"svgIcon","icon-attachment","i-3",a),(s||0===s)&&(r+=s),r+="\n              ",a={hash:{},data:t},r+=U((n=i.I18n,n?n.call(e,"attachment_upload",a):H.call(e,"I18n","attachment_upload",a)))+'\n              <input type="file" value="upload" id="task-file-button" name="file" style="color: transparent;" title="">\n            </a>\n          </li>\n          ',a={hash:{},inverse:F.noop,fn:F.program(50,M,t),data:t},(s=i.isTaskActivityPluginEnabled)?s=s.call(e,a):(s=e.isTaskActivityPluginEnabled,s=typeof s===q?s.apply(e):s),i.isTaskActivityPluginEnabled||(s=Y.call(e,s,a)),(s||0===s)&&(r+=s),r+="\n          ",a={hash:{},inverse:F.program(54,V,t),fn:F.program(52,A,t),data:t},(s=i.ifInCompleted)?s=s.call(e,a):(s=e.ifInCompleted,s=typeof s===q?s.apply(e):s),i.ifInCompleted||(s=Y.call(e,s,a)),(s||0===s)&&(r+=s),r+='\n          <li>\n            <a class="print" id="task-print-button">\n              ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-print","i-3",a):H.call(e,"svgIcon","icon-print","i-3",a),(s||0===s)&&(r+=s),r+="\n              ",a={hash:{},data:t},r+=U((n=i.I18n,n?n.call(e,"print",a):H.call(e,"I18n","print",a)))+"\n            </a>\n          </li>\n        </ul>\n      "}function M(e,t){var n,s,a,r="";return r+='\n            <li class="s-activity">\n              <a id="task-activity-button">\n                  ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-version-history","i-3",a):H.call(e,"svgIcon","icon-version-history","i-3",a),(s||0===s)&&(r+=s),r+="\n                ",a={hash:{},data:t},r+=U((n=i.I18n,n?n.call(e,"task_activity",a):H.call(e,"I18n","task_activity",a)))+"\n              </a>\n            </li>\n          "}function A(e,t){return"\n          \n          "}function V(e,t){var n,s,a="";return a+="\n             ",s={hash:{},inverse:F.noop,fn:F.program(55,O,t),data:t},(n=i.ifNotInAssignedMe)?n=n.call(e,s):(n=e.ifNotInAssignedMe,n=typeof n===q?n.apply(e):n),i.ifNotInAssignedMe||(n=Y.call(e,n,s)),(n||0===n)&&(a+=n),a+="\n          "}function O(e,t){var n,s,a="";return a+="\n              ",s={hash:{},inverse:F.noop,fn:F.program(56,B,t),data:t},(n=i.isDuplicatePluginEnabled)?n=n.call(e,s):(n=e.isDuplicatePluginEnabled,n=typeof n===q?n.apply(e):n),i.isDuplicatePluginEnabled||(n=Y.call(e,n,s)),(n||0===n)&&(a+=n),a+="\n            "}function B(e,t){var n,s,a,r="";return r+='\n                <li>\n                  <a id="task-duplicate-button" class="task-duplicate-button">\n                    ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-copy","i-3",a):H.call(e,"svgIcon","icon-copy","i-3",a),(s||0===s)&&(r+=s),r+="\n                    ",a={hash:{},data:t},r+=U((n=i.I18n,n?n.call(e,"duplicate",a):H.call(e,"I18n","duplicate",a)))+"\n                  </a>\n                </li>\n              "}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var N,E,R,L="",H=i.helperMissing,U=this.escapeExpression,F=this,q="function",Y=i.blockHelperMissing;return L+='\n<div id="task-detail-inner" class="task-detail b-h">\n  <div class="header td-header ',R={hash:{},data:s},L+=U((N=i.isTaskCompleted,N?N.call(t,t.status,R):H.call(t,"isTaskCompleted",t.status,R)))+" ",R={hash:{},data:s},L+=U((N=i.getPriorityClass,N?N.call(t,t.priority,R):H.call(t,"getPriorityClass",t.priority,R)))+'">\n    <div class="toolbar td-bar">\n      <div class="td-btns">\n        <div class="btn-item td-check ',R={hash:{},inverse:F.program(3,r,s),fn:F.program(1,a,s),data:s},(E=i.ifNotInDisabledList)?E=E.call(t,R):(E=t.ifNotInDisabledList,E=typeof E===q?E.apply(t):E),i.ifNotInDisabledList||(E=Y.call(t,E,R)),(E||0===E)&&(L+=E),L+='">\n            <span class="checker avoid-event">\n              ',R={hash:{},data:s},N=i.svgIcon,E=N?N.call(t,"icon-completed","i-4 i-tny",R):H.call(t,"svgIcon","icon-completed","i-4 i-tny",R),(E||0===E)&&(L+=E),L+="\n              ",R={hash:{},data:s},N=i.svgIcon,E=N?N.call(t,"icon-checkbox","i-4 i-tny",R):H.call(t,"svgIcon","icon-checkbox","i-4 i-tny",R),(E||0===E)&&(L+=E),L+="\n              ",R={hash:{},data:s},N=i.svgIcon,E=N?N.call(t,"icon-subtask","i-4 i-tny",R):H.call(t,"svgIcon","icon-subtask","i-4 i-tny",R),(E||0===E)&&(L+=E),L+="\n              ",R={hash:{},data:s},N=i.svgIcon,E=N?N.call(t,"icon-subcalendar","i-4 i-tny",R):H.call(t,"svgIcon","icon-subcalendar","i-4 i-tny",R),(E||0===E)&&(L+=E),L+="\n            </span>\n        </div>\n\n        <div ",R={hash:{},inverse:F.noop,fn:F.program(5,o,s),data:s},(E=i.ifNotInDisabledList)?E=E.call(t,R):(E=t.ifNotInDisabledList,E=typeof E===q?E.apply(t):E),i.ifNotInDisabledList||(E=Y.call(t,E,R)),(E||0===E)&&(L+=E),L+=' class="btn-item timecard-wrap td-timecard">\n          <span ',R={hash:{},inverse:F.program(9,c,s),fn:F.program(7,l,s),data:s},(E=i.ifNotInDisabledList)?E=E.call(t,R):(E=t.ifNotInDisabledList,E=typeof E===q?E.apply(t):E),i.ifNotInDisabledList||(E=Y.call(t,E,R)),(E||0===E)&&(L+=E),L+=' >\n            <a class="td-time" ',R={hash:{},inverse:F.program(13,u,s),fn:F.program(11,d,s),data:s},(E=i.ifNotInDisabledList)?E=E.call(t,R):(E=t.ifNotInDisabledList,E=typeof E===q?E.apply(t):E),i.ifNotInDisabledList||(E=Y.call(t,E,R)),(E||0===E)&&(L+=E),L+='>\n                <span class="icons">\n                    ',R={hash:{},data:s},N=i.svgIcon,E=N?N.call(t,"icon-duedate","i-5 normal-icon",R):H.call(t,"svgIcon","icon-duedate","i-5 normal-icon",R),(E||0===E)&&(L+=E),L+="\n                    ",R={hash:{},data:s},N=i.svgIcon,E=N?N.call(t,"icon-after-duedate","i-5 active-icon",R):H.call(t,"svgIcon","icon-after-duedate","i-5 active-icon",R),(E||0===E)&&(L+=E),L+='\n                </span>\n                <span class="selected-date i-5 text-tny"></span>\n                <span id="quick-time" class="quick-time"></span>\n            </a>\n            <a class="td-preview">\n              <span class="preview-duedate i-5"></span>\n              <span class="preview-time i-5"></span>\n              <span class="preview-snooze i-4"></span>\n            </a>\n            <a class="preview-repeat" ',
R={hash:{},inverse:F.program(13,u,s),fn:F.program(15,h,s),data:s},(E=i.ifNotInDisabledList)?E=E.call(t,R):(E=t.ifNotInDisabledList,E=typeof E===q?E.apply(t):E),i.ifNotInDisabledList||(E=Y.call(t,E,R)),(E||0===E)&&(L+=E),L+=">\n              ",R={hash:{},data:s},N=i.svgIcon,E=N?N.call(t,"icon-repeat","i-4",R):H.call(t,"svgIcon","icon-repeat","i-4",R),(E||0===E)&&(L+=E),L+='\n            </a>\n          </span>\n        </div>\n\n        <div class="btn-item priority-setting td-priority">\n          <div class="dropdown ">\n            <a class="dropdown-toggle insert-shadow priority-tip boult" ',R={hash:{},inverse:F.program(13,u,s),fn:F.program(17,p,s),data:s},(E=i.ifNotInDisabledList)?E=E.call(t,R):(E=t.ifNotInDisabledList,E=typeof E===q?E.apply(t):E),i.ifNotInDisabledList||(E=Y.call(t,E,R)),(E||0===E)&&(L+=E),L+=">\n              ",R={hash:{},data:s},N=i.svgIcon,E=N?N.call(t,"icon-priority-3","i-4",R):H.call(t,"svgIcon","icon-priority-3","i-4",R),(E||0===E)&&(L+=E),L+='\n            </a>\n            <ul class="dropdown-menu priority-menu pull-right">\n                <li>\n                  <a class="priority" value="5">\n                    ',R={hash:{},data:s},N=i.svgIcon,E=N?N.call(t,"icon-priority-3",R):H.call(t,"svgIcon","icon-priority-3",R),(E||0===E)&&(L+=E),L+="\n                    ",R={hash:{},data:s},L+=U((N=i.I18n,N?N.call(t,"high_priority",R):H.call(t,"I18n","high_priority",R)))+'\n                  </a>\n                </li>\n                <li>\n                  <a class="priority" value="3">\n                    ',R={hash:{},data:s},N=i.svgIcon,E=N?N.call(t,"icon-priority-2",R):H.call(t,"svgIcon","icon-priority-2",R),(E||0===E)&&(L+=E),L+="\n                    ",R={hash:{},data:s},L+=U((N=i.I18n,N?N.call(t,"medium_priority",R):H.call(t,"I18n","medium_priority",R)))+'\n                  </a>\n                </li>\n                <li>\n                  <a class="priority" value="1">\n                    ',R={hash:{},data:s},N=i.svgIcon,E=N?N.call(t,"icon-priority-1",R):H.call(t,"svgIcon","icon-priority-1",R),(E||0===E)&&(L+=E),L+="\n                    ",R={hash:{},data:s},L+=U((N=i.I18n,N?N.call(t,"low_priority",R):H.call(t,"I18n","low_priority",R)))+'\n                  </a>\n                </li>\n                <li>\n                  <a class="priority" value="0">\n                    ',R={hash:{},data:s},N=i.svgIcon,E=N?N.call(t,"icon-priority-3","i-4-1",R):H.call(t,"svgIcon","icon-priority-3","i-4-1",R),(E||0===E)&&(L+=E),L+="\n                    ",R={hash:{},data:s},L+=U((N=i.I18n,N?N.call(t,"none_priority",R):H.call(t,"I18n","none_priority",R)))+'\n                  </a>\n                </li>\n            </ul>\n          </div>\n        </div>\n        <div class="btn-item td-assign"></div>\n      </div>\n    </div>\n  </div>\n  <div class="body td-body b-h">\n\n    ',R={hash:{},inverse:F.noop,fn:F.program(19,m,s),data:s},N=i.ifequal,E=N?N.call(t,t.type,"multi",R):H.call(t,"ifequal",t.type,"multi",R),(E||0===E)&&(L+=E),L+="\n\n    ",R={hash:{},inverse:F.noop,fn:F.program(21,f,s),data:s},N=i.ifequal,E=N?N.call(t,t.type,"single",R):H.call(t,"ifequal",t.type,"single",R),(E||0===E)&&(L+=E),L+='\n\n    \n  </div>\n\n\n  <div id="comments-hint"></div>\n  <div class="footer under-footer td-footer">\n    <div class="toolbar">\n\n    <!-- footer bar left half -->\n    <div class="tl-half left">\n      <!-- project set -->\n      ',R={hash:{},inverse:F.program(33,_,s),fn:F.program(24,v,s),data:s},(E=i.ifNotInTrash)?E=E.call(t,R):(E=t.ifNotInTrash,E=typeof E===q?E.apply(t):E),i.ifNotInTrash||(E=Y.call(t,E,R)),(E||0===E)&&(L+=E),L+='\n      <!-- /project set -->\n\n      <!-- comment -->\n      <div class="td-item">\n      ',R={hash:{},inverse:F.program(38,C,s),fn:F.program(35,T,s),data:s},(E=i.ifNotInDisabledList)?E=E.call(t,R):(E=t.ifNotInDisabledList,E=typeof E===q?E.apply(t):E),i.ifNotInDisabledList||(E=Y.call(t,E,R)),(E||0===E)&&(L+=E),L+='\n      </div>\n      <!-- comment -->\n    </div>\n    <!-- /footer bar left half -->\n\n\n    <!-- footer bar right half -->\n    <div class="tl-half right">\n      <!-- delete -->\n      <div class="td-item">\n      ',R={hash:{},inverse:F.program(43,D,s),fn:F.program(40,x,s),data:s},(E=i.ifNotInTrash)?E=E.call(t,R):(E=t.ifNotInTrash,E=typeof E===q?E.apply(t):E),i.ifNotInTrash||(E=Y.call(t,E,R)),(E||0===E)&&(L+=E),L+='\n      </div>\n      <!-- /delete -->\n\n    <!-- more -->\n      <div class="dropup td-item">\n      ',R={hash:{},inverse:F.program(47,$,s),fn:F.program(45,j,s),data:s},(E=i.ifNotInDisabledList)?E=E.call(t,R):(E=t.ifNotInDisabledList,E=typeof E===q?E.apply(t):E),i.ifNotInDisabledList||(E=Y.call(t,E,R)),(E||0===E)&&(L+=E),L+="\n\n      ",R={hash:{},inverse:F.noop,fn:F.program(49,P,s),data:s},(E=i.ifNotInDisabledList)?E=E.call(t,R):(E=t.ifNotInDisabledList,E=typeof E===q?E.apply(t):E),i.ifNotInDisabledList||(E=Y.call(t,E,R)),(E||0===E)&&(L+=E),L+='\n      </div>\n      <!-- /more -->\n    </div>\n    <!-- /footer bar right half -->\n  </div>\n  </div>\n</div>\n\n\n\n<div id="group-dropdown-menu" class="group-dropdown-menu"></div>\n\n<div id="commonTimecard-tip" class="label label-warning hide">',R={hash:{},data:s},L+=U((N=i.I18n,N?N.call(t,"commonTimecard_tip",R):H.call(t,"I18n","commonTimecard_tip",R)))+"</div>\n"})}),define("view/taskdetail/base",["require","exports","module","configs/dict","lang/index","utils/dom","utils/hash","utils/string","offline/storage","utils/timeformat","utils/condition","utils/index","service/prefs","service/project","modules/timecard/timecard","utils/analytics","utils/server","service/task","view/taskdetail/time-menu","modules/project-menu/menu","dao/projectdb","view/taskdetail/assignment/list","utils/browser","utils/log","hbs!template/task_detail"],function(e,t){var i=e("configs/dict"),n=e("lang/index"),s=e("utils/dom"),a=e("utils/hash"),r=(e("utils/string"),e("offline/storage"),e("utils/timeformat")),o=e("utils/condition"),l=e("utils/index"),c=e("service/prefs"),d=e("service/project"),u=e("modules/timecard/timecard").View,h=e("utils/analytics"),p=e("utils/server"),m=e("service/task"),f=e("view/taskdetail/time-menu").View,g=e("modules/project-menu/menu").View,v=e("dao/projectdb").db,y=e("view/taskdetail/assignment/list").View,k=e("utils/browser"),w=e("utils/log");t.View=Backbone.View.extend({template:e("hbs!template/task_detail"),id:"task-detail-view",className:"b-h",events:function(){return{"click .header .check-toggle":"toggleCompleteByClick","click #task-delete-button":"deleteTaskByClick","click #task-deleteforever-button":"deleteForever","click .priority-menu .priority":"__setPriority","click #preview":"toggleTimecard","mouseenter #quick-set":"showTimeMenu","mouseleave #quick-set":"hideTimeMenuSlow"}},messages:function(){this.listenTo(Backbone,"closeDetailView",this.closeView),this.listenTo(Backbone,"saveTaskByShortcut",this.saveByShortcut),this.listenTo(Backbone,"toggleCompleteByShortcut",this.toggleComplete),this.listenTo(Backbone,"toggleCompleteMultiByDrag",this.toggleCompleteTaskByDrag),this.listenTo(Backbone,"deleteTaskByShortcut",this.deleteTask),this.listenTo(Backbone,"setTodayByShortcut",this.setToday),this.listenTo(Backbone,"setTomorrowByShortcut",this.setTomorrow),this.listenTo(Backbone,"setNextWeekByShortcut",this.setNextWeek),this.listenTo(Backbone,"setPriorityByShortcut",this.setPriorityByShortcut),this.listenTo(Backbone,"closeProjectDropdown",this.closeProjectDropdown),this.listenTo(Backbone,"moveSelectedToProject",this.moveSelectedToProject),this.listenTo(Backbone,"setReminderTime",this.setReminderTime),this.listenTo(Backbone,"toggleCalendarByShortcut",this.toggleTimecard),this.listenTo(Backbone,"selectAssignee",this.setAssignee),this.listenTo(Backbone,"hideTimeCard",this.hideTimeCard)},initialize:function(){},renderAssignmentDom:function(e,t){if(d.isShareProejct(e)&&!a.isInTrash()){var i={projectId:e,tasks:t};this.assignment&&this.assignment.onClose(),this.assignment=new y(i),this.$(".td-assign").append(this.assignment.el),this.$el.addClass("has-assignment")}},baseRender:function(){a.isInTrash()?this.renderRetoreMenu():this.renderProjectMenu()},renderProjectMenu:function(){var e;e=this.model?this.model.get("projectId"):this.collection.getCommonProjectId(),this.projectMenu=new g({projectId:e,$wrap:this.$("#project-setting .dropup"),action:_.bind(this.selectItem,this)})},renderRetoreMenu:function(){var e;this.model&&(e=this.model.get("projectId")),this.projectMenu=new g({projectId:e,$wrap:this.$(".restore.dropup"),action:_.bind(this.restore,this)})},_setTime:function(e){this.hideTimeMenu(),this.changeDueDate(e)},renderTimeMenu:function(){this.hideTimeMenu();var e=_.bind(this._setTime,this);this.timeMenu=new f({dueDate:this.getDueDate(),action:e})},showTimeMenu:function(){return this.$("#js-timecard").length?void this.hideTimeMenu():(this.renderTimeMenu(),void this.hideIECaret())},hideIECaret:function(){if(k.isIE){var e=this.$("textarea.link-editor");e.is(":focus")&&(e.blur(),w.log("textarea blur"))}},hideTimeMenu:function(){this.timeMenu&&this.timeMenu.$el.addClass("hide"),this.hideTimeMenuSlow()},hideTimeMenuSlow:function(){this.timeMenu&&this.timeMenu.onSlowClose()},toggleCompleteByClick:function(e){var t=$(e.currentTarget).find(".checkbox").hasClass("checked");h.td_btn(t?"undone":"done"),this.toggleComplete(e)},deleteTaskByClick:function(){this.deleteTask(),Backbone.trigger("doHideMobileList"),h.td_btn("delete")},undoDeleteTask:function(){this.undoDelete(),h.td_btn("undo_delete")},_activeSelectGroup:function(e){e.closest("li").siblings().removeClass("active"),e.closest("li").addClass("active")},_afterMove:function(e){m.updateCalendarDatesWithTask()},selectItem:function(e){var t=e.attr("projectid");this.reRenderProjectName(t),this.moveSelectedToProject(t),h.td_btn("move")},saveByShortcut:function(){o.isSubscribeCalendarTask(this.model)||(s.showStatus(n.get("saving"),1e3),this.save())},initRepeatTip:function(){this.$(".set-repeat.active").css("visibility","visible")},__delete:function(){this.remove()},__setPriority:function(e){var t=$(e.currentTarget).attr("value"),i=parseInt(t);a.isInTrash()||d.isInClosedProject()||(this.trigger("setPriority",i),this.setPriority(i),h.td_btn("priority"))},reRenderProjectName:function(e){this.$("#project-setting input").attr("projectId",e).val(d.getProjectNameById(e))},__timeDropdownScroll:function(e){var t,i=this.$("#time-setting .dropdown-menu");i.scrollTop(0),i.find("li").each(function(){var i=$(this);i.find("a").text()==e&&(i.addClass("active"),t=i.position().top,t>60&&(t-=60))}),i.scrollTop(t)},closeProjectDropdown:function(){this.$("#project-setting .dropdown").removeClass("open")},closeMoreDropdown:function(){this.$(".dropdown.more").removeClass("open")},prepareRender:function(){_.isObject(this.timecard)&&(this.timecard.trigger("hideCard"),this.timecard=null)},initTimecard:function(){if(null==this.timecard){var e=this;this.timecard=new u(this.generateSettings()),this.$("#reminder-setting").append(this.timecard.el),o.isSubscribeCalendarTask(this.model)?this.timecard.$el.append('<div class = "hide-timecard-calendar" ></div>'):(this.timecard.on("confirmTime",function(t){e.confirmTime(t)}),this.timecard.on("clearTime",function(){e.clearTime()}),this.timecard.on("settingsUpdate",function(t){e.previewTime(t)})),Backbone.trigger("openTimecard"),this.timecard.listenTo(Backbone,"openTimecard",function(){null!=e.timecard&&(e.timecard.trigger("hideCard"),e.timecard=null)})}},getRepeateInfo:function(){var e=new u(this.generateSettings());return e.$el.find(".repeat-container .select-menu .select-title").html()},toggleTimecard:function(e){e=e||window.event,this.hideTimeMenu(),a.isInTrash()||d.isInClosedProject()||(this.timecard?(this.timecard.trigger("hideCard"),this.timecard=null):this.initTimecard(),e.stopPropagation())},confirmTime:function(e){this.selfSaveTime(e),s.existAdvanceRepeatView()||(this.timecard=null)},clearTime:function(){this.selfSaveTime(),this.timecard=null},generateSettings:function(){var e={meridiem:c.get("showMeridiem"),weekStart:c.getWeekStartDay(),format:i.format.atomTime};return this.selfSetTimecard(e),e},hideTimeCard:function(){if(null!=this.timecard){if(s.existAdvanceRepeatView())return void this.timecard.repeatView.advancedRepeatView.cancelCard();this.timecard.trigger("hideCard"),this.timecard=null,this.refreshDuedate(),h.d_btn("cancel")}},previewTime:function(e){e=e||{},this.renderDueDatePreview(e.dueDate,e.reminders,e.isAllDay,e.repeatFlag),this.renderSelectedDate(e.dueDate)},renderDueDatePreview:function(e,t,i,s){var a=this.$(".td-reminder"),o=this.$(".preview-duedate"),l=this.$(".preview-time"),d=this.$(".preview-repeat"),u="duedate-today",h="duedate-overdue",p="is-repeat",m="active",f="";if(!e)return o.text(n.get("task_due_date")),a.removeClass(m+" "+h),d.removeClass(p),void l.text("");var g=n.isZHLike()?"MMMDo":"MMM D",v=r.getDueDateLocalZoneDate(e),y=r.prefMoment();d.toggleClass(p,!!s),v.year()!=y.year()&&(g+=v.format(", YYYY")),_.isEmpty(t)||i||(g+=c.get("showMeridiem")?n.isZHLike()?", A hh:mm":", hh:mm A":", HH:mm");var k=r.prefMoment(e);f=k.format(g);var w=r.getRecentlyDueDateTip(e);w&&(f+=", "+r.getRecentlyDueDateTip(e)),o.text(f),a.addClass(m);var b=v.diff(y.startOf("day"),"days");0===b?a.addClass(u).removeClass(h):0>=b?a.addClass(h).removeClass(u):a.removeClass(h).removeClass(u)},getOutOfView:function(){this.closeView()},renderPriorityIcon:function(e){this.$(".priority-setting .priority-tip").html(l.getPriorityIcon([e])),this.$(".priority-menu li").each(function(){$(this).removeClass("active")}),this.$('.priority-menu [value="'+e+'"]').parent().addClass("active")},renderSelectedDate:function(e){var t="";e&&(t=moment(e).date()),this.$(".selected-date").text(t)},_postAssignee:function(e){p.assign(JSON.stringify(e),function(e){_.isEmpty(e.id2error)||w.log(e.id2error)})},isResetAssign:function(e,t,i){if(!e.hasAssign())return!1;var n=d.isShareProejct(t);return n?!0:!1},hideTask:function(e,t){if(!a.isInTKCalendar()&&!a.isInDateView()&&!a.isInTagView())if(a.isInProjectAll()||a.isInToday()||a.isInWeek()||a.isInProjectGroup()){if(v.ifProjectShowInAll(t))return;e.trigger("hideOnListView")}else a.isInCompleted()||a.isInTrash()||a.isInSearchView()||(e.trigger("hideOnListView"),this.getOutOfView())},closeView:function(){this.save(),this.remove(),Backbone.trigger("doHideMobileList")},onClose:function(){this.contentView&&this.contentView.onClose(),this.attachmentView&&this.attachmentView.removeView(),this.locationView&&this.locationView.remove(),this.commentView&&this.commentView.removeView(),this.assignment&&this.assignment.onClose(),this.activityView&&this.activityView.removeView(),this.timeMenu&&this.timeMenu.onClose(),this.projectMenu&&this.projectMenu.remove(),this.stopRun&&this.stopRun(),this.remove()}})}),define("model/subtask",["require","exports","module"],function(e,t){t.Model=Backbone.Model.extend({defaults:{title:"",status:0,sortOrder:0}})}),define("hbs!template/sub_task_list_item",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){var n,s,a,r="";return r+='\n  <span class="drag">\n    ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-drag","i-7 i-tny",a):d.call(e,"svgIcon","icon-drag","i-7 i-tny",a),(s||0===s)&&(r+=s),r+='\n  </span>\n\n    <span class="checker st-checker check-toggle avoid-event cr-pointer">\n        ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-completed","i-4 i-tny",a):d.call(e,"svgIcon","icon-completed","i-4 i-tny",a),(s||0===s)&&(r+=s),r+="\n        ",a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-checkbox","i-4 i-tny",a):d.call(e,"svgIcon","icon-checkbox","i-4 i-tny",a),(s||0===s)&&(r+=s),r+='\n    </span>\n  <div contenteditable="true" class="title typeahead" data-provide="typeahead" placeholder="',a={hash:{},data:t},r+=u((n=i.I18n,n?n.call(e,"placeholder_task_subtask",a):d.call(e,"I18n","placeholder_task_subtask",a)))+'">',(s=i.title)?s=s.call(e,{hash:{},data:t}):(s=e.title,s=typeof s===h?s.apply(e):s),(s||0===s)&&(r+=s),r+='</div>\n  <a class="remove fake-del"></a>\n'}function r(e,t){var n,s,a,r="";return r+='\n  <span class="checker cr-disabled">\n      ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-completed","i-4 i-tny",a):d.call(e,"svgIcon","icon-completed","i-4 i-tny",a),(s||0===s)&&(r+=s),r+="\n      ",a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-checkbox","i-4 i-tny",a):d.call(e,"svgIcon","icon-checkbox","i-4 i-tny",a),(s||0===s)&&(r+=s),r+='\n  </span>\n  <div class="title">',(s=i.title)?s=s.call(e,{hash:{},data:t}):(s=e.title,s=typeof s===h?s.apply(e):s),(s||0===s)&&(r+=s),r+="</div>\n"}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var o,l,c="",d=i.helperMissing,u=this.escapeExpression,h="function",p=this,m=i.blockHelperMissing;return l={hash:{},inverse:p.program(3,r,s),fn:p.program(1,a,s),data:s},(o=i.ifNotInDisabledList)?o=o.call(t,l):(o=t.ifNotInDisabledList,o=typeof o===h?o.apply(t):o),i.ifNotInDisabledList||(o=m.call(t,o,l)),(o||0===o)&&(c+=o),c+="\n"})}),define("view/subtask-item",["require","exports","module","utils/dom","utils/hash","utils/timeformat","utils/browser","service/project","configs/keycode","utils/convert","utils/analytics","hbs!template/sub_task_list_item"],function(e,t){var i=e("utils/dom"),n=e("utils/hash"),s=e("utils/timeformat"),a=e("utils/browser"),r=e("service/project"),o=e("configs/keycode"),l=e("utils/convert"),c=e("utils/analytics");t.View=Backbone.View.extend({tagName:"li",template:e("hbs!template/sub_task_list_item"),className:"sub-task",events:{keydown:"keyShortcuts","keyup .title":"changeTitle","paste .title":"changeTitle","click .title":"activeItemOnClick","mousedown .searchTag":"routerToTag","mousedown .contentUrl":"linkToUrl","click .check-toggle":"toggleComplete","focus .title":"changeToEdit","blur .title":"changeToView"},messages:function(){this.listenTo(this.model,"change:status",this.renderCheckbox)},initialize:function(e){e.created&&this.$el.addClass("created"),this.task=e.task,this.messages(),this.render()},keyShortcuts:function(e){e=e||window.event;var t=this.$el,n=a.isIE;if(e.keyCode===o.up_arrow){e.preventDefault();var s=t.prevAll("li").length?t.prevAll("li").get(0):null;null!=s?($(s).find(".title").text()||n?i.placeCaretAtEnd($(s).find(".title").get(0)):$(s).find(".title").focus(),this.activeItem(s)):this.task.get("desc")?$("#task-desc .link-viewer").click():$("#task-detail-view .task-title").click()}else if(e.keyCode===o.down_arrow){e.preventDefault();var r=t.nextAll("li").length?t.nextAll("li").get(0):null;null!=r&&($(r).find(".title").text()||n?i.placeCaretAtEnd($(r).find(".title").get(0)):$(r).find(".title").focus(),this.activeItem(r))}},changeTitle:function(e){e=e||window.event;var t=this;_.delay(function(){var e=$(t.el);if(t.model.get("title")!=e.find(".title").text()){t.model.set("title",e.find(".title").text());var i=$(t.el).attr("itemid");_.each(t.task.get("items"),function(t){t.id==i&&(t.title=e.find(".title").text())}),t.task.updateModifiedIds(i),t.task.markDirty(),t.task.changedTime=s.prefMoment().unix()}})},activeItemOnClick:function(){if(!n.isInTrash()){var e=this.$el;this.activeItem(e)}},activeItem:function(e){$("#sub-task-list").find("li.active").removeClass("active"),$(e).addClass("active")},_analy:function(){var e=this.$el.hasClass("checked");c.td_sub_task(e?"undone":"done")},toggleComplete:function(){this._analy(),this.$el.addClass("updated"),this.$el.toggleClass("checked");var e=this.$el.attr("itemid");_.each(this.task.get("items"),function(t){t.id==e&&(t.status=0==t.status?1:0)}),this.task.updateModifiedIds(e),this.task.trigger("toggleCompleteFromSubTask")},renderCheckbox:function(){this.$(".checkbox").toggleClass("checked",0==this.get("status"))},domAttr:function(){this.$el.attr({itemid:this.model.get("id"),taskid:this.task.get("id")})},render:function(){var e=this.model.get("title")||"",t=this.template({title:l.convertToHtml(e),task:this.task});return this.$el.toggleClass("checked",1==this.model.get("status")),this.$el.html(t),this.domAttr(),this.subTaskDisableClick(),this},subTaskDisableClick:function(){var e=n.isInTrash()||r.isInClosedProject();e&&this.$(".st-checker").click(function(){return!1})},onClose:function(){this.remove()},changeToView:function(){var e=this.$el.find(".title").text();this.$el.find(".title").html(l.convertToHtml(e)),this.syncViewAndModle()},syncViewAndModle:function(){this.changeTitle()},changeToEdit:function(){l.convertToEdit(this.$el.find(".title")),Backbone.trigger("refreshAutoComplete")},routerToTag:function(e){var t=$(e.currentTarget).html().substring(1);window.location.href="#t/"+t.toLowerCase()+"/tasks"},linkToUrl:function(e){var t=$(e.target).attr("href");window.open(t,"_blank")}})}),define("hbs!template/task_item",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){var n;return(n=i.id)?n=n.call(e,{hash:{},data:t}):(n=e.id,n=typeof n===k?n.apply(e):n),w(n)}function r(e,t){var n;return(n=i.cid)?n=n.call(e,{hash:{},data:t}):(n=e.cid,n=typeof n===k?n.apply(e):n),w(n)}function o(e,t){return"checklist"}function l(e,t){var n,s,a,r="";return r+=' \n      <span class="drag">\n        ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-drag","i-4 i-tny",a):b.call(e,"svgIcon","icon-drag","i-4 i-tny",a),(s||0===s)&&(r+=s),r+="\n      </span>\n    "}function c(e,t){return" check-toggle cr-pointer "}function d(e,t){return" cr-disabled "}function u(e,t){return"show"}function h(e,t){var n,s="";return s+=" ",(n=i.duedateClass)?n=n.call(e,{hash:{},data:t}):(n=e.duedateClass,n=typeof n===k?n.apply(e):n),s+=w(n)+" "}function p(e,t){var n,s,a="";return a+="\n              ",s={hash:{},data:t},a+=w((n=i.getListItemDueDateTip,n?n.call(e,e.dueDate,e.allDay,s):b.call(e,"getListItemDueDateTip",e.dueDate,e.allDay,s)))+"\n            "}function m(e,t){return" contenteditable='true' "}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var f,g,v,y="",k="function",w=this.escapeExpression,b=i.helperMissing,_=this,T=i.blockHelperMissing;return y+='<a taskId="',f=i["if"].call(t,t.id,{hash:{},inverse:_.program(3,r,s),fn:_.program(1,a,s),data:s}),(f||0===f)&&(y+=f),y+='" projectId="',(f=i.projectId)?f=f.call(t,{hash:{},data:s}):(f=t.projectId,f=typeof f===k?f.apply(t):f),y+=w(f)+'"></a>\n<div class="l-task">\n  <div class="t-line top"></div>\n  <div class="t-inner task-inner cr-pointer ',(f=i.priorityClass)?f=f.call(t,{hash:{},data:s}):(f=t.priorityClass,f=typeof f===k?f.apply(t):f),y+=w(f)+" ",v={hash:{},inverse:_.noop,fn:_.program(5,o,s),data:s},(f=i.ifSubtaskNotText)?f=f.call(t,v):(f=t.ifSubtaskNotText,f=typeof f===k?f.apply(t):f),i.ifSubtaskNotText||(f=T.call(t,f,v)),(f||0===f)&&(y+=f),y+='">\n    ',v={hash:{},inverse:_.noop,fn:_.program(7,l,s),data:s},(f=i.ifNotInDisabledList)?f=f.call(t,v):(f=t.ifNotInDisabledList,f=typeof f===k?f.apply(t):f),i.ifNotInDisabledList||(f=T.call(t,f,v)),(f||0===f)&&(y+=f),y+='\n    <span class="t-check ',v={hash:{},inverse:_.program(11,d,s),fn:_.program(9,c,s),data:s},(f=i.ifNotInDisabledList)?f=f.call(t,v):(f=t.ifNotInDisabledList,f=typeof f===k?f.apply(t):f),i.ifNotInDisabledList||(f=T.call(t,f,v)),(f||0===f)&&(y+=f),y+='">\n        <span class="checker avoid-event">\n            ',v={hash:{},data:s},f=i.svgIcon,g=f?f.call(t,"icon-completed","i-4 i-tny",v):b.call(t,"svgIcon","icon-completed","i-4 i-tny",v),(g||0===g)&&(y+=g),y+="\n            ",v={hash:{},data:s},f=i.svgIcon,g=f?f.call(t,"icon-checkbox","i-4 i-tny",v):b.call(t,"svgIcon","icon-checkbox","i-4 i-tny",v),(g||0===g)&&(y+=g),y+="\n            ",v={hash:{},data:s},f=i.svgIcon,g=f?f.call(t,"icon-subtask","i-4 i-tny",v):b.call(t,"svgIcon","icon-subtask","i-4 i-tny",v),(g||0===g)&&(y+=g),y+="\n            ",v={hash:{},data:s},f=i.svgIcon,g=f?f.call(t,"icon-subcalendar","i-4 i-tny",v):b.call(t,"svgIcon","icon-subcalendar","i-4 i-tny",v),(g||0===g)&&(y+=g),y+='\n        </span>\n    </span>\n      <div class="tips line-right">\n        <span class="tip attachment-hint active ',g=i["if"].call(t,t.attachments,{hash:{},inverse:_.noop,fn:_.program(13,u,s),data:s}),(g||0===g)&&(y+=g),y+='">\n          ',v={hash:{},data:s},f=i.svgIcon,g=f?f.call(t,"icon-item-attachment","i-4",v):b.call(t,"svgIcon","icon-item-attachment","i-4",v),(g||0===g)&&(y+=g),y+='\n        </span>\n        <span class="tip note-hint active ',g=i["if"].call(t,t.content,{hash:{},inverse:_.noop,fn:_.program(13,u,s),data:s}),(g||0===g)&&(y+=g),y+='">\n          ',v={hash:{},data:s},f=i.svgIcon,g=f?f.call(t,"icon-item-text","i-4",v):b.call(t,"svgIcon","icon-item-text","i-4",v),(g||0===g)&&(y+=g),y+='\n        </span>\n        <span class="tip location-hint active ',g=i["if"].call(t,(f=t.location,null==f||f===!1?f:f.loc),{hash:{},inverse:_.noop,fn:_.program(13,u,s),data:s}),(g||0===g)&&(y+=g),y+='">\n          ',v={hash:{},data:s},f=i.svgIcon,g=f?f.call(t,"icon-item-location","i-4",v):b.call(t,"svgIcon","icon-item-location","i-4",v),(g||0===g)&&(y+=g),y+='\n        </span>\n        <span class="tip repeat-hint active ',g=i["if"].call(t,t.repeatFlag,{hash:{},inverse:_.noop,fn:_.program(13,u,s),data:s}),(g||0===g)&&(y+=g),y+='">\n          ',v={hash:{},data:s},f=i.svgIcon,g=f?f.call(t,"icon-item-repeat","i-4",v):b.call(t,"svgIcon","icon-item-repeat","i-4",v),(g||0===g)&&(y+=g),y+='\n        </span>\n        <span class="tip reminder-hint active ',g=i["if"].call(t,t.hasReminder,{hash:{},inverse:_.noop,fn:_.program(13,u,s),data:s}),(g||0===g)&&(y+=g),y+='">\n          ',v={hash:{},data:s},f=i.svgIcon,g=f?f.call(t,"icon-item-reminder","i-4",v):b.call(t,"svgIcon","icon-item-reminder","i-4",v),(g||0===g)&&(y+=g),y+='\n        </span>\n\n        <span class="date-hint tip show t-date">\n          <span class="due-date text-tny ',v={hash:{},inverse:_.noop,fn:_.program(15,h,s),data:s},f=i.ifequal,g=f?f.call(t,t.status,0,v):b.call(t,"ifequal",t.status,0,v),(g||0===g)&&(y+=g),y+='">\n            ',g=i["if"].call(t,t.dueDate,{hash:{},inverse:_.noop,fn:_.program(17,p,s),data:s}),(g||0===g)&&(y+=g),y+='\n          </span>\n        </span>\n\n        <span class="assignment tip ',g=i["if"].call(t,t.assignee,{hash:{},inverse:_.noop,fn:_.program(13,u,s),data:s}),(g||0===g)&&(y+=g),y+='">\n            <span>\n              <img class="avatar med" title="'+w((f=t.assignee,f=null==f||f===!1?f:f.display_name,typeof f===k?f.apply(t):f))+'" src="'+w((f=t.assignee,f=null==f||f===!1?f:f.avatar_url,typeof f===k?f.apply(t):f))+'">\n            </span>\n        </span>\n\n      </div>\n    <div class="transition title text-def typeahead line-left" ',v={hash:{},inverse:_.noop,fn:_.program(19,m,s),data:s},(g=i.ifNotInDisabledList)?g=g.call(t,v):(g=t.ifNotInDisabledList,g=typeof g===k?g.apply(t):g),i.ifNotInDisabledList||(g=T.call(t,g,v)),(g||0===g)&&(y+=g),y+=">",(g=i.title)?g=g.call(t,{hash:{},data:s}):(g=t.title,g=typeof g===k?g.apply(t):g),(g||0===g)&&(y+=g),y+='</div>\n\n  </div>\n  <div class="t-line bottom"></div>\n  </div>\n\n'})}),define("view/task-item",["require","exports","module","utils/index","utils/condition","configs/settings","configs/keycode","configs/dict","configs/status","utils/hash","utils/dom","utils/browser","utils/timeformat","utils/log","dao/projectdb","dao/taskdb","utils/string","utils/calculate","lang/index","service/task","service/project","utils/server","dao/shareduserdb","service/prefs","view/tip","utils/limit","configs/regexp","utils/convert","utils/analytics","utils/string","hbs!template/task_item"],function(e,t){var i=e("utils/index"),n=e("utils/condition"),s=e("configs/settings"),a=e("configs/keycode"),r=e("configs/dict"),o=(e("configs/status"),e("utils/hash")),l=e("utils/dom"),c=e("utils/browser"),d=e("utils/timeformat"),u=e("utils/log"),h=e("dao/projectdb").db,p=e("dao/taskdb").db,m=e("utils/string"),f=(e("utils/calculate"),e("lang/index"),e("service/task")),g=e("service/project"),v=e("utils/server"),y=e("dao/shareduserdb").db,k=e("service/prefs"),w=(e("view/tip").View,e("utils/limit")),b=e("configs/regexp"),T=e("utils/convert"),I=e("utils/analytics"),m=e("utils/string");t.View=Backbone.View.extend({tagName:"li",template:e("hbs!template/task_item"),className:"task height-transition",events:{"click .check-toggle":"toggleCompleteByClick","keyup .title":"updateTitle","keydown .title":"beforeChangeTitle","blur .title":"saveTitle","paste .title":"convertHtmlToPlain","mousedown .searchTag":"routerToTag","mousedown .contentUrl":"linkToUrl",keydown:"keyShortcuts","click .drag":"activateSelected","mousedown .drag":"addClassDrag",click:"clickShortcuts","focus .title":"toEditModel","mousedown .title":"mousedownTitle","click .title":"clickedTitle"},regex:{link:b.link,email:b.email,protocol:b.protocol},messages:function(){this.listenTo(this.model,"change:title",this.renderTitle),this.listenTo(this.model,"change:projectId",this.renderProjectInfo),this.listenTo(this.model,"change:repeatFlag",this.renderRepeatIcon),this.listenTo(this.model,"change:reminders change:dueDate change:status",this.renderReminderIcon),this.listenTo(this.model,"change:location",this.renderLocationIcon),this.listenTo(this.model,"change:dueDate change:isAllDay",this.renderDuedate),this.listenTo(this.model,"change:items change:content change:priority",this.renderStatusIcon),this.listenTo(this.model,"change:status",this.statusChanged),this.listenTo(this.model,"change:deleted",this.renderDeleted),this.listenTo(this.model,"change:content",this.renderNoteIcon),this.listenTo(this.model,"change:assignee",this.renderAssignIcon),this.listenTo(this.model,"change:attachments",this.renderAttachmentIcon),this.listenTo(this.model,"destroy",this.hideOnListView),this.listenTo(this.model,"toggleActive",this.toggleActive),this.listenTo(this.model,"placeCaretAtEnd",this.placeCaretAtEnd),this.listenTo(this.model,"deleteForever",this.remove),this.listenTo(this.model,"showOnListView",this.showOnListView),this.listenTo(this.model,"hideOnListView",this.hideOnListView),this.listenTo(this.model,"hideOnListViewForDelete",this.hideOnListViewForDelete),this.listenTo(this.model,"appendTitle",this.appendTitle),this.listenTo(this.model,"removeElement",this.removeElement),this.listenTo(this.model,"toggleCompleteFromDetail",this.toggleComplete),this.listenTo(this.model,"addSelected",this.addSelected),this.listenTo(this.model,"toggleActiveSelected",this.toggleActiveSelected),this.listenTo(y.collection,"refreshUserCollection",this.renderAssignIcon),this.listenTo(Backbone,"renderProjectColor",this.renderProjectInfo),this.listenTo(Backbone,"setTodayByDrag",this.setTodayByDrag),this.listenTo(Backbone,"setTomorrowByDrag",this.setTomorrowByDrag),this.listenTo(Backbone,"toggleCompleteByDrag",this.toggleCompleteByDrag),this.listenTo(Backbone,"deleteTaskByDrag",this.deleteTaskByDrag),this.listenTo(Backbone,"deleteTaskByDragToSubTask",this.deleteTaskByDragToSubTask),this.listenTo(Backbone,"moveSelectedToProjectByDrag",this.moveSelectedToProjectByDrag)},_renderCalendarTips:function(){this.renderNoteIcon(),this.renderRepeatIcon(),this.renderReminderIcon()},_renderAllTips:function(){this._renderCalendarTips(),this.renderProjectInfo(),this.renderLocationIcon(),this.renderDuedate()},renderTips:function(){this.isSubCal?this._renderCalendarTips():this._renderAllTips(),this.renderStatusIcon()},initialize:function(){this.isSubCal=n.isSubscribeCalendarTask(this.model),this.initDomAttr(),this.debounceChangeTitle=_.debounce(this.__changeTitle,s.responsiveTime),this.render(),this.initDom(),this.renderTips(),this.messages()},initDom:function(){this.$duedate=this.$(".due-date")},initDomAttr:function(){var e=this.model.get("dueDate"),t=e?d.prefMoment(e).format("YYYYMMDD"):"";this.$el.attr({order:this.model.get("sortOrder"),date:t})},renderProjectInfo:function(){var e=h.getProjectById(this.model.get("projectId")),t=e?e.get("color"):"transparent";l.setProjectColor(this.$(".l-task"),"4px",t)},activateSelected:function(e){e=e||window.event,this.$el.hasClass("selected")||($("#task-ul-list ul li").removeClass("selected active"),this.$el.addClass("selected active"),l.placeCaretAtEnd(this.$el.find(".title").get(0)),Backbone.trigger("navigateTask",this.model.id));

},addClassDrag:function(e){$("#task-ul-list ul li").removeClass("addClassDrag"),this.$el.addClass("addClassDrag"),$(".TickTick-typeahead,[display=block]").css({display:"none"})},clickShortcuts:function(e){e=e||window.event,e.preventDefault();var t=$("#task-ul-list li.active"),i=$("#task-ul-list li.selected"),n=$("#task-ul-list ul li"),s="active",a="selected",r=s+" "+a,o=".subcalendar";if(e.ctrlKey||e.metaKey)n.not(this.$el).removeClass(s),this.isSubCal||(this.$el.toggleClass(a),this.$el.removeClass(s));else if(e.shiftKey){i.removeClass(a);var c=-1;if(t){var d=n.index(t);d=-1==d?0:d,c=d;var u=n.index(this.$el);if(d>u){var h=u;u=d,d=h}n.slice(d,u+1).not(o).addClass(a)}t.removeClass(s),n.eq(c).not(o).addClass(r)}else t.removeClass(s),i.removeClass(a),this.$el.addClass(this.isSubCal?s:r);Backbone.trigger("navigateTaskManually",this.model.id),l.showMobileDetail()},toEditModel:function(e){return c.isSafari?void(this.markMoseDown||T.convertToEdit(this.$el.find(".title"))):void T.convertToEdit(this.$el.find(".title"))},mousedownTitle:function(){c.isSafari&&(this.markMoseDown=!0,u.log("task item: mousedown"))},clickedTitle:function(){c.isSafari&&(T.convertToEdit(this.$el.find(".title")),this.markMoseDown=!1,u.log("task item: click"))},toViewMode:function(e){var t=this.$el.find(".title"),i=t.text();t.html(T.convertToHtml(i))},renderTitle:function(e,t,i){var n=this.$el.find(".title"),s=n.text(),a=this.model.get("title");s!=a&&n.html(m.replaceSpace(T.convertToHtml(a)))},renderRepeatIcon:function(){this.$(".tips .repeat-hint").toggleClass("show",!_.isEmpty(this.model.get("repeatFlag")))},renderNoteIcon:function(){this.$(".tips .note-hint").toggleClass("show",this.model.hasContent())},renderAssignIcon:function(){var e=this.model.hasAssign();this.$(".tips .assignment").toggleClass("show",e);var t=y.getAssignee(this.model);t&&this.$(".tips .assignment img").attr("src",t.avatar_url)},renderAttachmentIcon:function(){this.$(".tips .attachment-hint").toggleClass("show",!_.isEmpty(this.model.get("attachments")))},renderReminderIcon:function(){var e=this;setTimeout(function(){e.$(".tips .reminder-hint").toggleClass("show",e.model.hasReminder())},10)},renderLocationIcon:function(){this.$(".tips .location-hint").toggleClass("show",_.isObject(this.model.get("location")))},renderDuedate:function(){var e=d.getDueDateClass(this.model.get("dueDate"));this.$duedate.text(this.model.formatItemDuedate()).attr("class",e+" text-tny"),this.$(".tips .date-hint").toggleClass("show",!!this.model.get("dueDate"))},appendTitle:function(e){var t=(l.getCaretPosition(this.$(".title").get(0)),this.model.get("title"));this.model.set("title",t+e),this.model.markDirty();var n=t.length;i.placeCaretAt(this.$(".title").get(0),n>0?n:0)},removeElement:function(){this.remove({silent:!0})},addSelected:function(){this.$el.addClass("selected")},toggleActiveSelected:function(){$("#task-ul-list li.active").removeClass("selected"),$("#task-ul-list li").removeClass("active"),this.$el.addClass("active selected")},keyShortcuts:function(e){if(e=e||window.event,(e.keyCode===a.up_arrow||e.keyCode===a.down_arrow)&&this.timerNavigate&&clearTimeout(this.timerNavigate),e.keyCode==a.up_arrow){if(e.preventDefault(),e.ctrlKey||e.metaKey)return;if(e.shiftKey){var t=$("#task-ul-list").find("li.active"),i=this.findNearItemDom(t),n=i.previous,s=i.next;n.length>0&&(n.hasClass("selected")&&s.hasClass("selected")?(t.removeClass("active"),n.addClass("active")):n.hasClass("selected")?(t.removeClass("active selected"),n.addClass("active")):(t.removeClass("active"),n.toggleClass("selected active")),l.placeCaretAtEnd(n.find(".title").get(0)))}else{var t=$("#task-ul-list").find("li.active"),r=$("#task-ul-list").find("li.selected"),n=this.findNearItemDom(t).previous;n.length>0?(t.removeClass("active"),r.removeClass("selected"),n.toggleClass("selected active"),l.placeCaretAtEnd(n.find(".title").get(0))):$(".task-new").focus()}}else if(e.keyCode==a.down_arrow)if(e.preventDefault(),e.ctrlKey||e.metaKey);else if(e.shiftKey){var t=$("#task-ul-list").find("li.active"),i=this.findNearItemDom(t),n=i.previous,s=i.next;s.length>0&&(s.hasClass("selected")&&n.hasClass("selected")?(t.removeClass("active"),s.addClass("active")):s.hasClass("selected")?(t.removeClass("active selected"),s.addClass("active")):(t.removeClass("active"),s.toggleClass("selected active")),l.placeCaretAtEnd(s.find(".title").get(0)))}else{var t=$("#task-ul-list").find("li.active"),r=$("#task-ul-list").find("li.selected"),s=this.findNearItemDom(t).next;s.length>0&&(t.removeClass("active"),r.removeClass("selected"),s.toggleClass("selected active"),l.placeCaretAtEnd(s.find(".title").get(0)))}},findNearItemDom:function(e){var t=[];e.prevAll("li").length?t=e.prevAll("li").first():e.parents("section").prevAll("section").each(function(){!t.length&&$(this).find("li").length&&(t=$(this).find("li").last())});var i=[];return e.nextAll("li").length?i=e.nextAll("li").first():e.parents("section").nextAll("section").each(function(){!i.length&&$(this).find("li").length&&(i=$(this).find("li").first())}),{previous:t,next:i}},convertHtmlToPlain:function(e){e=e||window.event;var t=this,i=e.currentTarget;setTimeout(function(){i.innerHTML=(i.innerText||i.textContent).trim().replace(/\r?\n/g,""),t.placeCaretAtEnd()},0)},statusChanged:function(){this.model.get("status");this.model.willRepeat()||this.renderStatusIcon(),this.model.trigger("toggleRenderModifyButton")},toggleCompleteByClick:function(e){var t=this.model.get("status");I.t_btn(t?"undone":"done"),this.toggleComplete(e)},toggleComplete:function(e){e=e||window.event,e.stopPropagation(),this.model.toggleModelComplete()},renderStatusIcon:function(){l.switchIcon(this.$el,this.model)},toggleActive:function(){$("#task-ul-list li").removeClass("active selected"),this.$el.addClass("active selected")},placeCaretAtEnd:function(){l.placeCaretAtEnd(this.$(".title").get(0))},switchToDetailView:function(){this.model.subtaskNotText()?l.placeCaretAtEnd($("#sub-task-list").find("li").first().find(".title").get(0)):$(".taskcontent").focus()},beforeChangeTitle:function(e){return w.isOverLimitTitle(e,this.$el.find(".title").html())?(e.preventDefault(),e.stopPropagation(),!1):void 0},updateTitle:function(e){return e=e||window.event,e.keyCode===a.up_arrow||e.keyCode===a.down_arrow?void(this.timerNavigate=setTimeout(function(){var e=$("#task-ul-list").find("li.active.selected");Backbone.trigger("navigateTask",e.find("a").attr("taskid"))},300)):void this.debounceChangeTitle()},__changeTitle:function(){var e=this.$(".title").text(),t=this.model.get("title");e.replace(/\s/gi,"nbsp;")!=t.replace(/\s/gi,"nbsp;")&&(this.model.set({title:e}),this.model.markDirty())},saveTitle:function(){this.__changeTitle(),this.model.isDirty&&this.model.save(),this.toViewMode()},showOnListView:function(){this.$el.removeClass("hide-height")},hideOnListView:function(){var e=this;this.$el.addClass("hide-height"),_.delay(function(){e.$el.hasClass("hide-height")&&e.$el.parent().exists()&&(e.remove({silent:!0}),p.permanentDelete(e.model))},3e3),Backbone.trigger("refresh")},hideOnListViewForDelete:function(){var e=this;this.$el.addClass("hide-height"),_.delay(function(){e.$el.hasClass("hide-height")&&e.remove({silent:!0})},3e3)},render:function(){var e={duedateClass:d.getDueDateClass(this.model.get("dueDate")),priorityClass:r.priority[this.model.get("priority")],cid:this.model.cid,projectId:this.model.get("projectId")};e=_.extend(e,this.model.toJSON()),e.title=m.replaceSpace(T.convertToHtml(this.model.get("title"))),e.assignee=y.getAssignee(this.model);var t=this.template(e);return this.$el.html(t),c.isMobile.any()&&this.$(".title").removeAttr("contenteditable"),this},renderDeleted:function(){},onClose:function(){this.remove()},routerToTag:function(e){var t=$(e.currentTarget).html().substring(1);window.location.href="#t/"+t.toLowerCase()+"/tasks"},linkToUrl:function(e){var t=$(e.target).attr("href");window.open(t,"_blank")},setTodayByDrag:function(e){if(e==this.model.get("id")){var t=d.formatToDateString(d.prefMoment());this.changeDueDate(t)}},setTomorrowByDrag:function(e){if(e==this.model.get("id")){var t=d.formatToDateString(d.prefMoment().add("d",1));this.changeDueDate(t)}},toggleCompleteByDrag:function(e){e===this.model.get("id")&&this.model.toggleModelComplete()},deleteTaskByDrag:function(e){e==this.model.get("id")&&this.deleteTask()},deleteTaskByDragToSubTask:function(e){e==this.model.get("id")&&this.deleteTask()},moveSelectedToProjectByDrag:function(e,t){e==this.model.get("id")&&this.moveSelectedToProject(t)},moveSelectedToProject:function(e){var t=this,i=this.model.get("projectId"),n=g.isShareProejct(i);this.isSubCal||e!=i&&(f.moveToProject(this.model,e,function(){if(n&&t.model.hasAssign()){var i=[{projectId:e,taskId:t.model.get("id"),assignee:-1}];t.model.set("assignee",null),v.assign(JSON.stringify(i),function(e){_.isEmpty(e.id2error)||u.log(e.id2error)})}}),o.isInProjectAll()||o.isInToday()||o.isInWeek()||o.isInProjectGroup()?h.ifProjectShowInAll(e)||this.model.trigger("hideOnListView"):o.isInCompleted()||o.isInTrash()||o.isInSearchView()||this.model.trigger("hideOnListView"),f.updateCalendarDatesWithTask())},deleteTask:function(){this.model.trigger("hideOnListViewForDelete"),this.model.trigger("delAssignee"),p.moveToTrash(this.model)},changeDueDate:function(e){d.getDueDateText(this.model.get("dueDate"));if(m.isValidDate(e)){var t=e;if(null!=this.model.get("dueDate")){var i=!0;Backbone.trigger("updateTaskOrderFromTimecard",e,i),t+=" "+d.prefMoment(this.model.get("dueDate")).format("HH:mm")}this.model.set("dueDate",k.formatToUtcString(t)),this.model.markDirty(),this.model.save()}}})}),define("view/taskdetail/content",["require","exports","module","configs/settings","configs/status","configs/limit","lang/index","utils/hash","utils/condition","utils/dom","utils/timeformat","modules/link-editor/editor","service/project","service/prefs","dao/taskdb","model/subtask","view/subtask-item","view/modal/get-upgrade","view/task-item","utils/browser","configs/keycode","dao/order_by_date","utils/limit","utils/analytics","service/userProfile"],function(e,t){var i=e("configs/settings"),n=e("configs/status"),s=e("configs/limit"),a=e("lang/index"),r=e("utils/hash"),o=e("utils/condition"),l=e("utils/dom"),c=e("utils/timeformat"),d=e("modules/link-editor/editor"),u=e("service/project"),h=e("service/prefs"),p=e("dao/taskdb").db,m=e("model/subtask").Model,f=e("view/subtask-item").View,g=e("view/modal/get-upgrade").View,v=e("view/task-item").View,y=e("utils/browser"),k=e("configs/keycode"),w=e("dao/order_by_date").db,b=e("utils/limit"),T=e("utils/analytics"),I=e("service/userProfile");t.View=Backbone.View.extend({events:{"keydown .task-title":"focusToContentOrSubtask","input #taskcontent":"updateContent","blur #taskcontent":"saveTask","change #taskcontent":"updateContent","blur #sub-task-list":"saveSubTask","click .mode.subtask":"switchModeToSubTask","click .mode.text":"switchModeToText","click .sub-task .check-toggle":"moveSubtask","click .sub-task .remove":"deleteSubtask","paste .sub-task .title":"convertHtmlToPlain","keydown .sub-task":"taskShortcutHandler","input #task-desc":"updateDesc","change #task-desc":"updateDesc","blur #task-desc":"descBlur","keydown .sub-desc":"descKeyDown","mousedown .searchTag":"routerToTag","mouseenter #switch-mode":"showSwitchMode","mouseleave #switch-mode":"hideSwitchMode"},messages:function(){this.listenTo(this.model,"change:content",this.renderContent),this.listenTo(this.model,"change:items",this.chooseTask),this.listenTo(this.model,"change:desc",this.renderDesc),this.listenTo(Backbone,"deleteSubtaskTurned",this.deleteSubtaskTurned)},initialize:function(){this.messages(),this.initDom(),this.subTaskSortable(),this.chooseTask(),this.windowSwitch(),this.initRenderSelectMode(),this.createOnEnter=_.throttle(this.__createOnEnter,200)},initDom:function(){this.$content=this.$("#taskcontent"),this.$subTasks=this.$("#sub-task-list"),this.$desc=this.$("#task-desc")},windowSwitch:function(){var e,t=this,i=!1,n=!1,s=this.$("#taskcontent textarea"),a=this.$("#tasktitle textarea");$(window).blur(function(){i=$(document.activeElement).is("textarea")&&$(document.activeElement).hasClass("content"),n=$(document.activeElement).is("textarea")&&$(document.activeElement).hasClass("title"),document.activeElement&&-1!=document.activeElement.parentNode.className.indexOf("sub-task")&&(e=document.activeElement)}).focus(function(){i?s.css("display","block").focus():n?a.css("display","block").focus():e&&t.subTaskCaret&&l.placeCaretAt(e,t.subTaskCaret)})},focusToContentOrSubtask:function(e){if(e=e||window.event,e.keyCode==k.down_arrow&&0==e.ctrlKey||e.keyCode==k.tab)return this.model.subtaskNotText()?this.model.get("desc")?this._focusDesc():this._focusFirstSubTask():(this.contentEditor.showEditor(),this.$("#taskcontent textarea").focus()),!1;if(e.keyCode==k.enter){if(this.model.subtaskNotText()){var t=this.$(".sub-task").first();if(!_.isEmpty(t.find(".title").text())){var i={id:ObjectId(),status:0,title:"",sortOrder:0},n=new m(i),s=new f({model:n,created:!0,task:this.model}),a=s.render().el;this.$("#sub-task-list").prepend(a),this.model.get("items").unshift(i),this.model.markDirty(),this.changeHolder()}l.placeCaretAtEnd(this.$(".sub-task").first().find(".title").get(0))}else this.contentEditor.showEditor(),this.$("#taskcontent textarea").focus();return!1}},updateContent:function(e){var t=this.contentEditor.getText(),i=this.model.get("content");t!=i&&(this.model.set("content",t,{cid:this.cid}),this.model.markDirty(),this.model.changedTime=c.prefMoment().unix())},updateDesc:function(){var e=this.descEditor.getText(),t=this.model.get("desc");e!=t&&(this.model.set({desc:e},{silent:!0}),this.model.markDirty(),this.model.changedTime=c.prefMoment().unix())},descBlur:function(){this.saveTask()},_createSubTaskFromDesc:function(e){var t=this.model.get("items"),i=$(e.target).val(),n=l.getInputCaretPosition(e.target),s=i.slice(0,n),a=i.slice(n);e.preventDefault();var r=ObjectId(),o=new m({id:r,title:a}),c=new f({model:o,created:!0,task:this.model});this.$subTasks.prepend(c.el),c.$(".title").focus();var d={id:r,status:0,title:a,sortOrder:0};t.unshift(d),this.model.set({items:t},{silent:!0}),this.model.set({desc:s}),this.model.markDirty(),this.model.updateItemsOrder(),this.changeHolder()},_focusTitle:function(){$("#task-detail-view .task-title").click()},_focusFirstSubTask:function(){var e=this.$subTasks.find("li").first();l.placeCaretAtEnd(e.find(".title").get(0))},_focusDesc:function(){this.$desc.find(".link-viewer").click()},descKeyDown:function(e){e=e||window.event;var t=e.keyCode,i=l.getInputCaretPosition(e.target);t===k.enter||(t===k.up_arrow?0===i&&this._focusTitle():t===k.down_arrow&&i===$(e.target).val().length&&this._focusFirstSubTask())},saveTask:function(){n.isWindowBlur||this.model.isDirty&&(this.model.updateItemsOrder(),this.trigger("saveContent"))},initRenderSelectMode:function(){_.isEmpty(this.model.get("items"))?this.$(".mode.text").parent().addClass("active"):this.$(".mode.subtask").parent().addClass("active")},_renderSelectMode:function(e){var t=this.$(e);this.$(".task-mode-menu>li").removeClass("active"),t.parent().addClass("active")},switchModeToText:function(e){if(e=e||window.event,e.preventDefault(),this._renderSelectMode(e.currentTarget),this.hideSwitchMode(),this.model.subtaskNotText()&&!r.isInTrash()){var t=[];_.each(this.model.get("items"),function(e){this.model.updateDeletedIds(e.id),t.push(e.title)},this);var i=this.model.get("desc");i&&(i+="\n  ",t.unshift(i)),this.model.set({content:t.join("\n"),items:[],desc:""}),this.saveModel(),T.td_btn("toggle_to_text")}},switchModeToSubTask:function(e){if(e.preventDefault(),this._renderSelectMode(e.currentTarget),this.hideSwitchMode(),this.model.textNotSubtask()&&!r.isInTrash()){var t=this.model.get("content")||"",i="",n=[""],s=/\n\s{2}/g,a=[],o=0;I.isPro()&&s.test(t)?(o=s.lastIndex,i=t.substring(0,o-3),a=t.substring(o).split("\n"),n=a,n=a.length>1&&0==a[0].trim().length?a.slice(1):a):(i="",n=t.split("\n"));var l=0,c=[];_.each(n,function(e){var t={id:ObjectId(),status:0,title:e,sortOrder:l};c.push(t),l+=1}),this.model.set({items:c,content:"",desc:i}),this.saveModel(),T.td_btn("toggle_to_list")}},hideSwitchMode:function(){this.$(".task-mode-menu").hide()},showSwitchMode:function(e){this.$(".task-mode-menu").show()},doAnimation:function(e,t){var i=e.clone(),n=e.height();e.after(i),t(),e.height(0),i.animate({height:0},200,function(){i.remove()}),e.animate({height:n},200,function(){})},moveSubtask:function(e){e=e||window.event;var t=$(e.currentTarget).parent(".sub-task");t.hasClass("checked")?$("#sub-task-list").find("li").last().attr("itemid")!=t.attr("itemid")&&this.doAnimation(t,function(){$("#sub-task-list").append(t)}):t.prev().hasClass("checked")&&this.doAnimation(t,function(){$("#sub-task-list li.checked").first().before(t)});var i=t.attr("itemid"),n=[],s=null;if(t.hasClass("checked"))_.each(this.model.get("items"),function(e){e.id!=i?n.push(e):s=e}),n.push(s);else{var a=[];_.each(this.model.get("items"),function(e){e.id!=i?0==e.status?n.push(e):a.push(e):s=e}),n.push(s),n=n.concat(a)}this.model.set({items:n},{silent:!0}),this.model.markDirty(),this.saveTask()},deleteSubtask:function(e){e=e||window.event,e.preventDefault();var t=e.currentTarget.parentNode;this.deleteOnBackspace(t),T.td_sub_task("delete_icon")},convertHtmlToPlain:function(e){var t=$(e.currentTarget);_.delay(function(){t.swap(t.text())})},subTaskSortable:function(e){var t=this,i=".sortable, #sub-task-list",n="#container-main";(r.isInTKCalendar()||r.isInAssignedMe())&&(n="#sub-task-list"),$("#sub-task-list").sortable({connectWith:i,handle:".drag",containment:n,items:"li",dropOnEmpty:!1,helper:function(e,t){return"<div class='sub-task drag-help'>"+t.html()+"</div>"},tolerance:"pointer",start:function(e,t){t.item.show()},sort:function(e,t){var i=t.placeholder.siblings().hasClass("task"),n=$("#sub-task-list .ui-sortable-placeholder"),s=$("#task-ul-list .ui-sortable-placeholder");l.showPlaceholder(i?s:n)},over:function(e,t){},beforeStop:function(e,t){},stop:function(e,i){var n=i.item.prevAll("li").length>0?i.item.prevAll("li").get(0):null,s=(i.item.nextAll("li").length>0?i.item.nextAll("li").get(0):null,$(i.item).siblings().hasClass("task"));if(n&&!s){var a=n.getAttribute("itemid"),r=[],o=[],l=i.item[0].getAttribute("itemid"),c=null,d=!1;_.each(t.model.get("items"),function(e){e.id==l?c=e:(d?o.push(e):r.push(e),e.id==a&&(d=!0))}),r.push(c),r=r.concat(o),t.model.set({items:r},{silent:!0}),t.model.updateModifiedIds(l),t.model.markDirty(),t.model.updateItemsOrder(),T.td_sub_task("drag")}else if(s){var u=i.item.closest(".task-sortable-by-date");u.length?t.subtaskToTaskByDate(i):t.subtaskToTaskBySortOrder(i),T.t_drag("drag_from_sub")}else if(i.position.left>=0){var r=[],l=i.item[0].getAttribute("itemid"),c=null;_.each(t.model.get("items"),function(e){e.id==l?c=e:r.push(e)}),c&&r.unshift(c),t.model.set({items:r},{silent:!0}),t.model.updateModifiedIds(l),t.model.markDirty(),t.model.updateItemsOrder(),T.td_sub_task("drag")}}})},getProjectId:function(e){var t=u.getProjectForCreateTask().id;return r.isInProjectGroup()&&(group=e.item.closest(".task-sortable-by-custom"),t=group.attr("projectid")),t},subtaskToTaskBySortOrder:function(e){var t=e.item.closest(".task-sortable-by-custom").attr("projectid"),i=this.model.get("dueDate"),n="",s="";t||(t=this.getProjectId(e)),this.subtaskToTaskSort(e,t,n,s,i)},subtaskToTaskByDate:function(e){var t=u.getCurrentDateProjectId(),i=e.item.closest(".task-sortable-by-date"),n=i.attr("date"),s=w._getTimeByDueDate(this.model.get("dueDate")),a=c.dateFormatToMoment(n,"YYYYMMDD").format("YYYY-MM-DDT"+s+".000ZZ");this.subtaskToTaskSort(e,t,i,n,a)},subtaskToTaskSort:function(e,t,i,n,s){{var a=e.item.find(".title").text(),r=this.model.get("priority"),o=this.model.get("repeatFlag"),l=this.model.get("repeatFrom"),c=this.model.get("reminders"),d=this.model.get("isAllDay"),u=this._getSortOrder(e),m={id:ObjectId(),title:a,projectId:t,priority:r,status:0,sortOrder:u,dueDate:s,reminders:c,isAllDay:d,repeatFlag:o,repeatFrom:l,timeZone:h.get("timeZone"),local:!0},f=p.collection.create(m);new v({model:f})}e.item.find("a").attr("taskid",f.get("id")),n&&w.changeSortOrderByDate(e,i.find("li"),e.item,n,t),Backbone.trigger("refresh"),this.deleteSubtaskTurned(e.item)},_getSortOrder:function(e){var t,n=($(".task-sortable-by-project").length,e.item.prevAll("li").length>0?e.item.prevAll("li").get(0):null),s=e.item.nextAll("li").length>0?e.item.nextAll("li").get(0):null,a=$(n),r=$(s),o=a.attr("order"),l=r.attr("order");return t=r.exists()&&a.exists()?(Number(o)+Number(l))/2:r.exists()&&!a.exists()?Number(l)-i.orderStep:Number(o)+i.orderStep},deleteSubtaskTurned:function(e){var t=e,i=[],n=t.attr("itemid"),s=this.model.get("items");_.each(s,function(e){e.id!=n&&i.push(e)}),t.remove(),i.length?this.model.set({items:i},{silent:!0}):(i.push({id:ObjectId(),sortOrder:0,status:0,title:""}),this.model.set({items:i})),this.model.updateDeletedIds(n),this.model.markDirty(),this.changeHolder()},scrollToBottom:function(e){var t=this.$("#sub-task-list .sub-task").last()[0];this.$el.parent().height()<=this.$("#sub-task-list").height()&&t==e&&this.$el.scrollTo({top:"+=30px",left:"+=0px"})},taskShortcutHandler:function(e){e=e||window.event;var t=e.currentTarget;if(this.subTaskCaret=l.getCaretPosition(document.activeElement),!r.isInTrash())switch(e.keyCode){case k.enter:e.preventDefault(),$("#sub-task-list").find(".sub-task").length<s.subtaskNumber?this.createOnEnter(t):(this.$(t).find(".title").blur(),new g({type:"subtask"}));break;case k.backspace:if(e.ctrlKey||e.metaKey)this.deleteOnBackspace(t),e.preventDefault(),T.td_sub_task("delete_back");else{var i=this.$(t),n=i.prevAll();if(n.length||""==i.find(".title").text()){var a=l.getCaretPosition(i.find(".title").get(0));if(0==a){var o=i.find(".title").text();this.deleteOnBackspace(t,o),e.preventDefault(),T.td_sub_task("delete_back")}}}break;case k.left_arrow:break;case k.right_arrow:break;default:if(b.isOverLimitTitle(e,this.$(t).find(".title").text()))return e.preventDefault(),e.stopPropagation(),!1}},renderSubTasks:function(){var e=this.model.checkItemsOrder();this.$("#sub-task-list").empty();var t=this;_.each(e,function(e){var i=new f({model:new m(e),task:t.model});t.$("#sub-task-list").append(i.el)})},renderDesc:function(){if(!this.model.textNotSubtask())if(I.isPro()||this.model.get("desc")){var e=this.$("#task-desc"),t="",i=r.isInTrash()||u.isInClosedProject()||r.isInSubscribeCalendars(),n=this.model.get("desc");_.isUndefined(this.descEditor)?(this.descEditor=new d({empty:t,text:n,readonly:i,whereUseIt:"desc"}),e.append(this.descEditor.$el)):(this.descEditor.setText(n),this.descEditor.adjustSize())}else{var e=this.$("#task-desc");!_.isUndefined(this.descEditor)&&e&&this.descEditor.$el.remove()}},_showSubAndDesc:function(){this.$content.hide(),this.renderSubTasks(),this.$subTasks.show(),this.renderDesc(),this.$desc.show()},_showText:function(){this.$subTasks.hide(),this.$desc.hide(),this.renderContent(),this.$content.show()},chooseTask:function(){this.model.subtaskNotText()?this._showSubAndDesc():this._showText(),Backbone.trigger("refreshAutoComplete"),this.changeHolder()},changeHolder:function(){var e=this.model.get("items");e&&e.length>1?this.$("#sub-task-list").addClass("more-one"):this.$("#sub-task-list").removeClass("more-one")},__createOnEnter:function(e){var t=this,i=this.$(e),n=i.find(".title"),s=i.attr("itemid"),a=l.getCaretPosition(n.get(0)),r=n.text(),o=r.slice(0,a),c=r.slice(a);n.text(o);var d=ObjectId(),u=new m({id:d,title:c}),h=new f({model:u,created:!0,task:this.model});i.after(h.el),$("#sub-task-list").find("li").removeClass("active"),h.$el.addClass("active"),h.$(".title").focus();var p={id:d,status:0,title:c,sortOrder:0},g=[],v=!1,y=!1;_.each(this.model.get("items"),function(e){v&&(y||(g.push(p),y=!0)),e.id==s&&(v=!0,r!=o&&(e.title=o,t.model.updateModifiedIds(e.id))),g.push(e)}),y||g.push(p),this.model.set({items:g},{silent:!0}),this.model.markDirty(),this.model.updateItemsOrder(),this.scrollToBottom(h.el),this.changeHolder()},deleteOnBackspace:function(e,t){var i=$(e),n=i.prevAll("li"),s=i.nextAll("li"),a=!0,r=!1,o=i.attr("itemid");if(0==n.length)0==s.length?(i.removeClass("checked"),i.find(".title").empty(),a=!1,r=!0):(i.remove(),l.placeCaretAtEnd($(s).find(".title").get(0)));else{i.remove();var c=n.first().find(".title");if(t){var d=c.text();c.text(d+t),l.placeCaretAt(c.get(0),d.length)}else l.placeCaretAtEnd(c.get(0))}var u=[];_.each(this.model.get("items"),function(e){e.id==o&&a||(r&&(e.title=""),u.push(e))}),this.model.set({items:u},{silent:a}),this.model.updateDeletedIds(o),this.model.markDirty(),this.changeHolder()},renderContent:function(e,t,i){if(i&&i.cid==this.cid)return!1;if(_.isUndefined(this.contentEditor)){var n=o.isSubscribeCalendarTask(this.model)?"":a.get("placeholder_task_content");this.contentEditor=new d({empty:n,text:this.model.get("content"),readonly:r.isInTrash()||u.isInClosedProject()||r.isInSubscribeCalendars(),whereUseIt:"content"}),this.$("#taskcontent").append(this.contentEditor.$el)}else this.contentEditor.setText(this.model.get("content"))},routerToTag:function(e){if(y.isIE){var t=$(e.currentTarget).html().substring(1);window.location.href="#t/"+t.toLowerCase()+"/tasks"}},onClose:function(){this.remove()},saveSubTask:function(e){e.relatedTarget&&$(e.relatedTarget).parent().hasClass("sub-task")||this.saveTask()},saveModel:function(){p.collection.contains(this.model)||p.collection.add(this.model),this.model.save()}})}),define("model/attachment",["require","exports","module"],function(e,t){t.Model=Backbone.Model.extend({defaults:{}})}),define("collection/attachment",["require","exports","module","model/attachment"],function(e,t){t.Collection=Backbone.Collection.extend({model:e("model/attachment").Model,comparator:function(e,t){if("IMAGE"===e.get("fileType")&&"IMAGE"!==t.get("fileType"))return-1;if("IMAGE"===t.get("fileType")&&"IMAGE"!==e.get("fileType"))return 1;var i=e.get("createdTime"),n=t.get("createdTime");return i=i?moment(i)._d.getTime():(new Date).getTime(),n=n?moment(n)._d.getTime():(new Date).getTime(),n-i}})}),define("hbs!template/single_attachment",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){return"uploading"}function r(e,t){var i,n="";return n+='\n    <a class="fancybox" rel="group" href="'+y((i=e.model,i=null==i||i===!1?i:i.fullUrl,typeof i===v?i.apply(e):i))+'"></a>\n  '}function o(e,t){var n,s,a="";return a+="\n    ",s=i["if"].call(e,(n=e.model,null==n||n===!1?n:n.isLocal),{hash:{},inverse:k.program(8,c,t),fn:k.program(6,l,t),data:t}),(s||0===s)&&(a+=s),a+="\n  "}function l(e,t){var i,n="";return n+='   \n        <img src="'+y((i=e.model,i=null==i||i===!1?i:i.previewUrl,typeof i===v?i.apply(e):i))+'">\n    '}function c(e,t){var i,n="";return n+='\n        <img src="'+y((i=e.model,i=null==i||i===!1?i:i.thuUrl,typeof i===v?i.apply(e):i))+'">\n    '}function d(e,t){var i,n="";return n+='\n    <div class="hint">\n      <i class="icon_home icon-'+y((i=e.model,i=null==i||i===!1?i:i.iconClass,typeof i===v?i.apply(e):i))+'"></i>\n    </div>\n  '}function u(e,t){return' class="del" '}function h(e,t){return" disabled "}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var p,m,f,g="",v="function",y=this.escapeExpression,k=this,w=i.helperMissing,b=i.blockHelperMissing;return g+='\n<div class="attachment '+y((p=t.model,p=null==p||p===!1?p:p.type,typeof p===v?p.apply(t):p))+" ",m=i["if"].call(t,(p=t.model,null==p||p===!1?p:p.isLocal),{hash:{},inverse:k.noop,fn:k.program(1,a,s),data:s}),(m||0===m)&&(g+=m),g+='">\n  \n  ',f={hash:{},inverse:k.noop,fn:k.program(3,r,s),data:s},p=i.ifequalor,m=p?p.call(t,(p=t.model,null==p||p===!1?p:p.type),"image","audio","video","voice",f):w.call(t,"ifequalor",(p=t.model,null==p||p===!1?p:p.type),"image","audio","video","voice",f),(m||0===m)&&(g+=m),g+="\n\n\n  ",f={hash:{},inverse:k.program(10,d,s),fn:k.program(5,o,s),data:s},p=i.ifequal,m=p?p.call(t,(p=t.model,null==p||p===!1?p:p.type),"image",f):w.call(t,"ifequal",(p=t.model,null==p||p===!1?p:p.type),"image",f),(m||0===m)&&(g+=m),g+='\n    \n    <div class="action line-right">\n      <a class="download" value="download" href="'+y((p=t.model,p=null==p||p===!1?p:p.downUrl,typeof p===v?p.apply(t):p))+'" target="_blank" accept="image/gif, image/jpeg, application/pdf, cation/vnd.ms-excel, application/vnd.ms-powerpoint, application/msword">\n        ',f={hash:{},data:s},p=i.svgIcon,m=p?p.call(t,"icon-download","i-2",f):w.call(t,"svgIcon","icon-download","i-2",f),(m||0===m)&&(g+=m),g+="\n      </a>\n      <a ",f={hash:{},inverse:k.program(14,h,s),fn:k.program(12,u,s),data:s},(m=i.ifNotInDisabledList)?m=m.call(t,f):(m=t.ifNotInDisabledList,m=typeof m===v?m.apply(t):m),i.ifNotInDisabledList||(m=b.call(t,m,f)),(m||0===m)&&(g+=m),g+=">\n        ",f={hash:{},data:s},p=i.svgIcon,m=p?p.call(t,"icon-delete","i-2",f):w.call(t,"svgIcon","icon-delete","i-2",f),(m||0===m)&&(g+=m),g+='\n      </a>\n    </div>\n\n    <div class="info line-left">\n      <div class="name">'+y((p=t.model,p=null==p||p===!1?p:p.fileName,typeof p===v?p.apply(t):p))+'</div>\n      <div class="size text-tny text-info">'+y((p=t.model,p=null==p||p===!1?p:p.sizeMb,typeof p===v?p.apply(t):p))+'</div>\n    </div>\n\n    <div class="loading">\n        ',(m=i.renderLoading)?m=m.call(t,{hash:{},data:s}):(m=t.renderLoading,m=typeof m===v?m.apply(t):m),(m||0===m)&&(g+=m),g+="\n    </div>\n    \n</div>\n"})}),define("view/taskdetail/attachment/item",["require","exports","module","lang/index","utils/dom","configs/dict","utils/index","configs/settings","hbs!template/single_attachment"],function(e,t){var i=(e("lang/index"),e("utils/dom"),e("configs/dict")),n=(e("utils/index"),e("configs/settings"));t.View=Backbone.View.extend({tagName:"li",template:e("hbs!template/single_attachment"),messages:function(){this.listenTo(this.model,"change:isLocal",this.changeLocalStatus)},api:n.API_HOST_V1,events:{"click .del":"deleteFile"},initialize:function(){this.initProps(),this.render(),this.messages()},initProps:function(){this.model.set({baseUrl:this._getBaseUrl(),fullUrl:this._getFullUrl(),downUrl:this._getDownUrl(),sizeMb:this.formatFileSize(this.model.get("size")),type:this.model.get("fileType").toLowerCase(),iconClass:this.getIconClass()}),i.distingFileType.image.test(this.model.get("fileType"))&&this.model.set({thuUrl:this._getThuUrl()})},getIconClass:function(){var e=this.model.get("fileType").toLowerCase();return"voice"===e&&(e="audio"),e},render:function(){this.$el.html(this.template({model:this.model.toJSON()}))},_getBaseUrl:function(){var e=this.model.get("projectId")+"/"+this.model.get("taskId")+"/"+this.model.get("id");return e},_getFullUrl:function(){var e=this.substrFileName(this.model.get("fileName")),t=this.api+"/attachment/"+this._getBaseUrl()+e;return t},_getThuUrl:function(){var e=this.api+"/attachment/thumbnail/"+this._getBaseUrl()+"?size=s";return e},_getDownUrl:function(){var e=this.api+"/attachment/"+this._getBaseUrl()+"?action=download";return e},substrFileName:function(e){return e.substr(e.lastIndexOf(".")).toLowerCase()},deleteFile:function(){Backbone.trigger("deleteAttachment",this.model),this.onClose()},formatFileSize:function(e){var t=0;return 1e3>e?t=e+" B":1e6>e?(t=(e/1e3).toFixed(2),t+=" K"):(t=(e/1e6).toFixed(2),t+=" M"),t},changeLocalStatus:function(){this.$el.find(".uploading").removeClass("uploading")},onClose:function(){this.remove()}})}),define("hbs!template/attachment",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){return this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{},'<ul class="attachment-list"></ul>\n'})}),define("view/taskdetail/attachment/list",["require","exports","module","configs/settings","lang/index","utils/dom","utils/log","configs/dict","configs/limit","utils/server","collection/attachment","view/taskdetail/attachment/item","model/attachment","view/modal/get-upgrade","hbs!template/attachment"],function(e,t){
var i=e("configs/settings"),n=e("lang/index"),s=e("utils/dom"),a=(e("utils/log"),e("configs/dict")),r=e("configs/limit"),o=e("utils/server"),l=e("collection/attachment").Collection,c=e("view/taskdetail/attachment/item").View,d=e("model/attachment").Model,u=e("view/modal/get-upgrade").View;t.View=Backbone.View.extend({template:e("hbs!template/attachment"),className:"attachment-file",events:{},messages:function(){this.listenTo(Backbone,"deleteAttachment",this.deleteAttachment),this.listenTo(this.collection,"add",this.addAttachment);var e=this;this.$uploadInput.on("change.attachment",function(t){var i=t.target.files;i.length&&e.afterSelectFile(i[0])}).on("click.attachment",function(t){e.afterClickUploadBtn(t)}),$("body").on("dragover.attchment",function(e){e.preventDefault()}).on("drop.attachment",function(t){dataTransfer=t.originalEvent&&t.originalEvent.dataTransfer,dataTransfer&&dataTransfer.files&&dataTransfer.files.length&&e.afterSelectFile(dataTransfer.files[0]),t.preventDefault()})},initialize:function(){this.beforeInitDom(),this.initData(),this.render(),this.afterInitDom(),this.showColorBox(),this.messages()},initData:function(){this.collection=new l(this.model.get("attachments")),this.projectId=this.model.get("projectId"),this.taskId=this.model.get("id"),this.initModels()},beforeInitDom:function(){this.$parent=$("#attachment-view"),this.$uploadInput=$("#task-file-button"),this.$uploadInput.css("display","none")},afterInitDom:function(){this.$ul=this.$el.find(".attachment-list")},initModels:function(){_.each(this.collection.models,function(e){this.projectId+"/"+this.taskId+"/"+e.id;e.set({projectId:this.projectId,taskId:this.taskId})},this)},render:function(){this.$el.html(this.template()),this.$parent.html(this.$el),this.renderAttachments(),s.adjustDetailHeight()},renderAttachments:function(){this.collection.sort(),this.collection.each(function(e){this.renderAttachment(e)},this)},renderAttachment:function(e){var t=new c({model:e});$(".attachment-list",this.$el).append(t.el)},createModel:function(e){var t=ObjectId();return new d({id:t,projectId:this.projectId,taskId:this.taskId,fileName:e.name,fileType:e.fileType,size:e.size,isLocal:!0,previewUrl:URL.createObjectURL(e)})},updateTaskAttachment:function(){this.model.set({attachments:this.collection.toJSON()})},deleteAttachment:function(e){var t=this;this.collection.remove(e),o.deleteAttachment(e.get("baseUrl"),function(){t.updateTaskAttachment()})},verifyFile:function(e){return this.verifyFileLimit(e)?!1:!0},afterClickUploadBtn:function(e){i.canUploadAttachment||(new u({type:"attachment"}),e.preventDefault())},afterSelectFile:function(e){if(!i.canUploadAttachment)return void new u({type:"attachment"});this.uploadOneFile(e),this.resetUploadFileBtn()},uploadOneFile:function(e){if(this.extToFileType(e),this.verifyFile(e)){var t=this,n=this.createModel(e);this.collection.add(n);var s=i.API_HOST_V1+"/attachment/upload/"+this.projectId+"/"+this.taskId+"/"+n.get("id");o.uploadFile(e,s,function(e){t.afterUploadFile(e,n)})}},afterUploadFile:function(e,t){t.set(e),t.set({isLocal:!1}),this.collection.add(t,{merge:!0}),this.updateTaskAttachment(),Backbone.trigger("updateAttachmentLimit")},resetUploadFileBtn:function(){this.$uploadInput.val("")},overFileSize:function(e){return e.size>r.uploadFileSize?(s.showStatus(n.get("over_size"),1e3),!0):!1},overFileType:function(e){var t=!1;for(var i in a.distingFileType)if(a.distingFileType[i].test(e.fileType)){t=!0;break}return t?!1:(s.showStatus(n.get("over_type"),1e3),!0)},extToFileType:function(e){var t=e.name,i=t.substring(t.lastIndexOf(".")+1);for(var n in a.extToFileType)for(var s in a.extToFileType[n])a.extToFileType[n][s]==i.toLowerCase()&&(e.fileType=n)},verifyFileLimit:function(e){return this.overFileType(e)?!0:this.overFileSize(e)?!0:!1},addAttachment:function(e){var t=new c({model:e}),i=this.collection.indexOf(e);~i&&(i--,0>i?this.$ul.prepend(t.el):this.$ul.find(">li").eq(i).after(t.el),$("#content-view").scrollTo(t.$el,1e3),this.showColorBox())},_baseMatch:function(e,t){var i="\\.("+a.extToFileType[t].join("|")+")((#|\\?).*)?$",n=new RegExp(i);return n.test(e)},isVideo:function(e){return this._baseMatch(e,"VIDEO")},isAudio:function(e){return this._baseMatch(e,"AUDIO")},showColorBox:function(){var e=this;$(".fancybox").colorbox({rel:"group",opacity:1,maxHeight:"85%",html:function(){var t=$(this).attr("href");if(e.isVideo(t)||e.isAudio(t)){if(e.isAudio(t)){var i="<audio";i+=' width="460" height="180"',$("#cboxContent").css("background","#000")}else{var i='<video poster="/static/img/colorbox/video/';i+='video.png" width="640" height="360"',$("#cboxContent").css("background","#fff")}return i+='controls="controls" preload="none"><source type="video/mp4" src="'+t+'" /><source type="video/webm" src="'+t+'" /><source type="video/ogg" src="'+t+'" /><object width="460" height="260" type="application/x-shockwave-flash" data="'+t+'"><param name="movie" value="'+t+'" /><param name="flashvars" value="controls=true&file='+t+'" /></object></video>'}}})},removeView:function(){this.remove(),this.$uploadInput.off("change.attachment").off("click.attachment"),$("body").off("dragover.attachment").off("drop.attachment")}})}),define("hbs!template/modify_completed_time",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o="",l=i.helperMissing,c=this.escapeExpression;return o+='<div id="modify-completed-time">\n	\n</div>\n<hr class="seperating" />\n<div class="confirm-container section">\n  <div class="cancel-card half-button">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"cancel",r):l.call(t,"I18n","cancel",r)))+'</div>\n  <div class="confirm-card half-button">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"ok",r):l.call(t,"I18n","ok",r)))+"</div>\n</div>"})}),define("view/taskdetail/modify-completed-time",["require","exports","module","utils/dom","service/prefs","utils/timeformat","configs/dict","hbs!template/modify_completed_time"],function(e,t){var i=(e("utils/dom"),e("service/prefs")),n=e("utils/timeformat"),s=e("configs/dict");t.View=Backbone.View.extend({template:e("hbs!template/modify_completed_time"),id:"modify-completed-time-view",className:"modify-timecard",events:{"click .confirm-card":"confirmCard","click .cancel-card":"cancelCard",click:"stopPropagation","dblclick .k-active":"confirmCard"},messages:function(){},initialize:function(e){this.render(),this.messages(),this.initCalendar(),this.initCardToggle()},render:function(){this.$el.html(this.template()),this.$el.appendTo("#task-detail-inner")},initCalendar:function(e){this.calendar=new Kalendae(this.$("#modify-completed-time")[0],{months:1,mode:"single",dayOutOfMonthClickable:!0,weekStart:i.getWeekStartDay(),selected:n.prefMoment(this.model.get("completedTime")).format("YYYY-MM-DD"),useYearNav:!1,navSelector:!0,daysWithColor:!0,direction:"today-past",directionScrolling:!1})},initCardToggle:function(){var e=this;$("#task-detail-inner>div").not(this.$el).click(function(){e.blurCard()}),$("#left-view, #header").click(function(){e.blurCard()})},stopPropagation:function(e){e.stopPropagation()},cancelCard:function(){this.hideCard()},confirmCard:function(){var e=n.prefMoment(this.calendar.getSelected()).format(s.format.atomTime);this.modifyCompletedTime(e),this.hideCard()},blurCard:function(){this.hideCard()},modifyCompletedTime:function(e){this.model.trigger("dropOnCompletedTaskGroupInCompleted",e)},hideCard:function(){this.onClose()},onClose:function(){this.remove()}})}),define("hbs!template/comment_item",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){var n,s="";return s+='\n          \n             <div class="action-btns">\n              ',n=i["if"].call(e,e.isMyself,{hash:{},inverse:p.program(4,o,t),fn:p.program(2,r,t),data:t}),(n||0===n)&&(s+=n),s+="\n             </div>\n          \n          "}function r(e,t){return'\n               <a class="del-btn fake-del"></a>\n               '}function o(e,t){var n,s="";return s+="\n                 ",n=i["if"].call(e,e.isUserInShared,{hash:{},inverse:p.noop,fn:p.program(5,l,t),data:t}),(n||0===n)&&(s+=n),s+="\n              "}function l(e,t){var n,s,a,r="";return r+='\n                 \n                   <a class="reply-btn">\n                     ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-comment","i-2",a):h.call(e,"svgIcon","icon-comment","i-2",a),(s||0===s)&&(r+=s),r+="\n                   </a>\n                 "}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var c,d,u="",h=i.helperMissing,p=this,m="function",f=this.escapeExpression,g=i.blockHelperMissing;return u+='<div class="comment">\n  <div class="comment-photo avatar">\n      <img src="',(c=i.avatarUrl)?c=c.call(t,{hash:{},data:s}):(c=t.avatarUrl,c=typeof c===m?c.apply(t):c),u+=f(c)+'" />\n  </div>\n  <div class="comment-content">\n       <div class="timeline">\n          ',d={hash:{},inverse:p.noop,fn:p.program(1,a,s),data:s},(c=i.ifNotDeletedAndClosed)?c=c.call(t,d):(c=t.ifNotDeletedAndClosed,c=typeof c===m?c.apply(t):c),i.ifNotDeletedAndClosed||(c=g.call(t,c,d)),(c||0===c)&&(u+=c),u+='\n         <div class="timeline-text">\n           <span class="comment-creator">',(c=i.creator)?c=c.call(t,{hash:{},data:s}):(c=t.creator,c=typeof c===m?c.apply(t):c),u+=f(c)+'</span>\n           <span class="comment-time text-info text-sml">',(c=i.time)?c=c.call(t,{hash:{},data:s}):(c=t.time,c=typeof c===m?c.apply(t):c),u+=f(c)+'</span>\n         </div>\n       </div>\n       <div id="comment-text" class="comment-text">\n         <p class="detail">\n           <span class="reply-tip text-sml">',(c=i.replyTip)?c=c.call(t,{hash:{},data:s}):(c=t.replyTip,c=typeof c===m?c.apply(t):c),(c||0===c)&&(u+=c),u+='</span>\n           <span class="c-text">',(c=i.text)?c=c.call(t,{hash:{},data:s}):(c=t.text,c=typeof c===m?c.apply(t):c),(c||0===c)&&(u+=c),u+='</span>\n         </p>\n         <p class="cr-pointer expand text-link hide">',d={hash:{},data:s},u+=f((c=i.I18n,c?c.call(t,"expand",d):h.call(t,"I18n","expand",d)))+'</p>\n         <p class="cr-pointer collapse text-link hide">',d={hash:{},data:s},u+=f((c=i.I18n,c?c.call(t,"collapse",d):h.call(t,"I18n","collapse",d)))+"</p>\n        </div>\n  </div>\n</div>"})}),define("view/taskdetail/comment/item",["require","exports","module","lang/index","utils/timeformat","dao/shareduserdb","service/userProfile","utils/dom","hbs!template/comment_item"],function(e,t){var i=e("lang/index"),n=e("utils/timeformat"),s=e("dao/shareduserdb").db,a=e("service/userProfile"),r=e("utils/dom");t.View=Backbone.View.extend({template:e("hbs!template/comment_item"),tagName:"li",events:{"click .del-btn":"deleteComment","click .reply-btn":"replyComment","keydown #edit-comment":"updateComment","click .expand":"expand","click .collapse":"collapse"},maxLine:3,initialize:function(e){this.task=e.task,this.initLang(),this.render(),this.initDom(),this.initExpandBtn(),this.refreshTimeFromNow()},initDom:function(){this.$handle=$("#comments-view .cm-handle"),this.$detail=this.$(".detail"),this.$expand=this.$(".expand"),this.$collapse=this.$(".collapse")},initLang:function(){this.textMe=i.get("me"),this.textReply=i.get("comment_reply")},initExpandBtn:function(){var e=this.$handle.text(this.$detail.text()).css("line-height"),t=parseInt(e),i=this.$handle.height();i/t>this.maxLine&&(this.$detail.css("max-height",this.maxLine*t+t/2),this.showExpandBtn()),this.$handle.text("")},expand:function(){this.hideExpandBtn(),this.showCollapseBtn(),this.$detail.css("max-height","")},collapse:function(){var e=parseInt(this.$detail.css("line-height"));this.hideCollapseBtn(),this.showExpandBtn(),this.$detail.css("max-height",this.maxLine*e+e/2)},showExpandBtn:function(){this.$expand.removeClass("hide")},hideExpandBtn:function(){this.$expand.addClass("hide")},showCollapseBtn:function(){this.$collapse.removeClass("hide")},hideCollapseBtn:function(){this.$collapse.addClass("hide")},_getDisplayName:function(e){var t=e.isMyself,i="";return i=t?a.get("name"):e.name?e.name:e.username},render:function(){var e=this.model.get("userProfile"),t=this.model.get("replyUserProfile"),i=this.getReplyTip(t),s=e.isMyself,r={creator:this._getDisplayName(e),time:n.formatCommentTime(this.model.get("createdTime")),text:this.replaceMentionUsers(this.model.get("title")),replyTip:i,isMyself:s,avatarUrl:s?a.get("picture"):e.avatarUrl,task:this.task,isUserInShared:this.isUserInShared()};return this.$el.html(this.template(r)),this},isUserInShared:function(){var e=s.getAcceptedUsers(this.task.get("projectId"),!1),t=this.model.get("userProfile");if(t.isMyself)return!0;var i=t.userCode,n=_.findIndex(e,function(e){return e.get("userCode")===i});return-1!==n},createMentionReg:function(){var e=this.model.get("mentions")||[];if(e.length){var t=_.map(e,function(e){return e.atLabel+" "}),i=new RegExp("("+t.join("|")+")","ig");return i}},replaceMentionUsers:function(e){var t=this.createMentionReg(),i=e.replace(t,function(e,t){return'<span class="mention">'+e+"</span>"});return i},getReplyTip:function(e){var t=_.isEmpty(e)?"":this.textReply.replace("%s1",this._getDisplayName(e));return t},refreshTimeFromNow:function(){var e=this;this.refreshHandle(),this.timeOutId=setTimeout(function(){e.refreshTimeFromNow()},6e4)},refreshHandle:function(){var e,t=this.model.get("createdTime"),i=n.getDueDateLocalZoneDate(t).diff(n.prefMoment().startOf("day"),"days");0==i&&(e=n.formatCommentTime(t),this.$(".comment-time").text(e))},deleteComment:function(e){var t=this;Backbone.trigger("deleteComment",this.model.get("id")),this.model.destroy(),this.$el.animate({opacity:0,height:0},200,"swing",function(){t.remove()})},replyComment:function(){var e=this.model.get("userProfile"),t=this.getReplyTip(e),i=t.replace("<span>","").replace("</span>",""),n=$("#add-new-comment");n.val(i),r.setInputCaretPosition(n[0],i.length),Backbone.trigger("replyComment",this.model,i)},onClose:function(){clearTimeout(this.timeOutId)}})}),define("hbs!template/comment_list",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o,l="",c=i.helperMissing,d=this.escapeExpression,u="function";return l+='\n	<div class="ta-header" id="comment_title">\n		<span class="title">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"comments",o):c.call(t,"I18n","comments",o)))+'</span>\n		<span class="count" id="comments_count">',(r=i.count)?r=r.call(t,{hash:{},data:s}):(r=t.count,r=typeof r===u?r.apply(t):r),l+=d(r)+'</span>\n	</div>\n\n	<ul id="comments-list"></ul>\n	<div class="toggle-btn" id="toggle_comment">\n		<i class="fake-icon-triangle-down i-4"></i>	\n		<i class="fake-icon-triangle-up i-4"></i>			\n	</div>\n'})}),define("hbs!template/comments_hint",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){var n,s,a="";return a+='\n    <textarea id="add-new-comment" class="new-comment input-fake" type="text" placeholder="',s={hash:{},data:t},a+=h((n=i.I18n,n?n.call(e,"add_comment",s):u.call(e,"I18n","add_comment",s)))+'"></textarea>\n  '}function r(e,t){var n,s,a="";return a+='\n    <textarea class="new-comment input-fake cr-disabled" type="text" placeholder="',s={hash:{},data:t},a+=h((n=i.I18n,n?n.call(e,"add_comment",s):u.call(e,"I18n","add_comment",s)))+'" readonly disabled></textarea>\n  '}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var o,l,c,d="",u=i.helperMissing,h=this.escapeExpression,p="function",m=this,f=i.blockHelperMissing;return d+='<div class="comments-footer ',(o=i.animateClass)?o=o.call(t,{hash:{},data:s}):(o=t.animateClass,o=typeof o===p?o.apply(t):o),d+=h(o)+' med-fast animated">\n  <div class="comment-holder hide">\n    <div class="last-comment"></div>\n    <a class="co-action">\n      ',c={hash:{},data:s},o=i.svgIcon,l=o?o.call(t,"icon-comment","i-2",c):u.call(t,"svgIcon","icon-comment","i-2",c),(l||0===l)&&(d+=l),d+='\n      <span class="comments-count text-info text-sml">',(l=i.count)?l=l.call(t,{hash:{},data:s}):(l=t.count,l=typeof l===p?l.apply(t):l),d+=h(l)+'</span>\n    </a>\n  </div>\n  <div class="n-bottom">\n  ',c={hash:{},inverse:m.program(3,r,s),fn:m.program(1,a,s),data:s},(l=i.ifNotDeletedAndClosed)?l=l.call(t,c):(l=t.ifNotDeletedAndClosed,l=typeof l===p?l.apply(t):l),i.ifNotDeletedAndClosed||(l=f.call(t,l,c)),(l||0===l)&&(d+=l),d+='\n    <span id="word-count" class="c-count text-info text-tny">140</span>\n  </div>\n</div>\n'})}),define("view/taskdetail/comment/list",["require","exports","module","view/taskdetail/comment/item","model/comment","dao/commentdb","lang/index","utils/timeformat","utils/dom","configs/limit","utils/analytics","configs/keycode","dao/shareduserdb","service/project","utils/hash","utils/log","utils/browser","service/userProfile","hbs!template/comment_list","hbs!template/comments_hint"],function(e,t){var i=e("view/taskdetail/comment/item").View,n=e("model/comment").Model,s=e("dao/commentdb").db,a=(e("lang/index"),e("utils/timeformat"),e("utils/dom")),r=e("configs/limit"),o=e("utils/analytics"),l=e("configs/keycode"),c=e("dao/shareduserdb").db,d=e("service/project"),u=e("utils/hash"),h=e("utils/log"),p=e("utils/browser"),m=e("service/userProfile");t.View=Backbone.View.extend({template:e("hbs!template/comment_list"),templateHint:e("hbs!template/comments_hint"),className:"comments can-select",limit:5,shownAll:!1,replyInfo:{model:{},tip:"",isReply:!1},events:{"click .toggle-btn":"toggleComments"},messages:function(){this.listenTo(Backbone,"deleteComment",this.deleteComment),this.listenTo(Backbone,"replyComment",this.storeReplyModel),this.listenTo(this.commentCollection,"refreshComment",this.refreshComment),this.listenTo(c.collection,"refreshUserCollection",this.refreshUsers),this.listenInput(),this.listenScroll(),this.listenCoAction()},initialize:function(e){_.extend(this,e),this.modelId=this.model.get("id"),this.subCommentView=[],this.mUsers=this.getMentionUsers(!0)||[],this.preloadCommnets(),this.initTemplate(),this.initDom(),this.render(),this.messages(),this.initTextareaAutosize(),this.initAutoComplete()},initDom:function(){this.$scroll=$("#content-view"),this.$cList=this.$("#comments-list"),this.$count=this.$("#comments_count"),this.$toggle=this.$("#toggle_comment"),this.$cTextarea=this.$hint.find("#add-new-comment"),this.$wCount=this.$hint.find("#word-count"),this.$count=this.$count.add(this.$hint.find(".comments-count")),this.textareaHeight=this.$cTextarea.outerHeight()},render:function(){this.addCommentViews(),this.renderComments(),this.showCommentFontCount(),this.renderCount()},initTemplate:function(){this.model.get("commentCount")||this.hideComments(),this.$el.html(this.template({count:this.model.get("commentCount"),model:this.model})),$("#comments-view").append(this.$el),this.$hint=$("#comments-hint").html(this.templateHint({count:this.model.get("commentCount"),model:this.model,animateClass:"addComment"===this.operation?p.isIE?"":"slideInUp":""}))},listenInput:function(){var e=this;this.$hint.on("keydown","textarea",function(t){e.creatNewComment(t)}).on("input","textarea",function(t){e.edittingComment(t)}).on("blur","textarea",function(t){e.setDraft(t)})},listenCoAction:function(){var e=this;this.$hint.find(".co-action").on("click",function(){e.$scroll.scrollTo(e.$cList.find("li:last-child"),100)})},toggleLastComment:function(){if(this.$cList.find("li:last-child").length){var e=this.$cList.find("li:last-child").offset().top,t=this.$hint.find(".comments-footer").offset().top,i=this.$last.parent();t+21>=e?i.addClass("hide"):i.removeClass("hide")}},listenScroll:function(){var e=this;this.$scroll.on("scroll",function(){e.toggleLastComment()})},getProjectId:function(){return this.model.get("projectId")},renderLastComment:function(){var e=this.subCommentView.length;if(this.$last=this.$hint.find(".last-comment"),this.$last.empty().off("click"),e){var t=this,i=this.subCommentView[e-1].$el.clone(!0);this.$last.html(i),this.$last.on("click",".expand, .collapse",function(){i=t.subCommentView[e-1].$el.clone(!0),t.$last.html(i)}),this.subCommentView[e-1].$el.on("click",".expand, .collapse",function(){i=t.subCommentView[e-1].$el.clone(!0),t.$last.html(i)})}a.adjustDetailHeight(),this.toggleLastComment(),this.renderDraft()},renderDraft:function(){var e=s.getDraft(this.modelId);e&&e.local&&(this.draftView&&this.draftView.remove(),e=new n(e),this.draftView=this.getCommentView(e),this.setDraftText(this.draftView))},setDraftText:function(e){var t=e.$el.find(".reply-tip").text()+e.$el.find(".c-text").text();this.$cTextarea.val(t),this.wordCountTip()},toggleComments:function(){this.shownAll?(this.shownAll=!1,this.$toggle.removeClass("open"),this.showLastComments(),this.$scroll.scrollTo(this.$scroll.find("#comment_title"),100)):(this.shownAll=!0,this.$toggle.addClass("open"),this.showAllComments())},initTextareaAutosize:function(){this.$cTextarea.autosize()},renderCount:function(){var e=this.commentCollection.length;this.$count.text(e),e?this.$count.show():this.$count.hide()},hideCommentFontCount:function(){this.$wCount.hide()},showCommentFontCount:function(){this.$wCount.show()},preloadCommnets:function(){this.commentCollection=s.getCommentsById(this.modelId,this.getProjectId(),!0)},renderComments:function(){var e=this;_.each(this.subCommentView,function(t,i){e.renderOneSubComments(t)}),this.showLastComments(),this.showToggle(),this.renderLastComment()},showToggle:function(){this.subCommentView.length>this.limit&&this.$toggle.addClass("toggle")},showLastComments:function(){var e=this.commentCollection.length,t=e-this.limit;this.commentCollection.length>this.limit&&this.$cList.find("li:lt("+t+")").hide(),a.adjustDetailHeight()},showAllComments:function(){this.$cList.find("li").show(),this.$scroll.scrollTo(this.$cList.find("li:first-child"),100)},renderOneSubComments:function(e){this.$cList.append(e.el)},addCommentViews:function(){var e=this;_.each(this.commentCollection.models,function(t){e.addOneSubComment(t)})},getCommentView:function(e){var t=new i({model:e,task:this.model});return t},addOneSubComment:function(e){var t=this.getCommentView(e);return this.subCommentView.push(t),t},reRenderTextarea:function(){this.$cTextarea.val("").css({height:this.textareaHeight,overflow:"hidden"}),this.$wCount.text(r.commentWordLimit)},clearReplyInfo:function(){this.replyInfo={model:{},tip:"",isReply:!1}},clearDraft:function(){s.setDraft(this.modelId,""),this.draftView&&this.draftView.remove(),this.clearReplyInfo()},createMentionReg:function(){var e=this.mUsers;if(e.length){var t=_.map(e,function(e){return e.value+" "}),i=new RegExp("@("+t.join("|")+")","ig");return i}},getMentions:function(){var e=this.mUsers;if(e.length){var t=this.$cTextarea.val(),i=[],n=this.createMentionReg(),s=_.union(t.match(n));try{i=_.map(s,function(t){var t=t.replace(/\s*$/,""),i=_.findIndex(e,{atLabel:t}),n=e[i];return{userId:n.userId,atLabel:n.atLabel}})}catch(a){h.log(a)}return i}},getCommentModel:function(){var e=this.$cTextarea.val(),t=this.getMentions(),i={createdTime:new Date,title:e,taskId:this.modelId,id:ObjectId(),projectId:this.getProjectId(),userProfile:{isMyself:!0},mentions:t};this.replyInfo.isReply&&(i.replyCommentId=this.replyInfo.model.get("id"),i.replyUserProfile=this.replyInfo.model.get("userProfile"),e=e.replace(this.replyInfo.tip,""),i.title=e);var s=new n;return s.local=!0,s.set(i),s},showComments:function(){this.$el.removeClass("hide")},hideComments:function(){this.$el.addClass("hide"),this.model.set({commentCount:0},{silent:!0})},createComment:function(){var e=this.getCommentModel(),t=this;this.commentCollection.create(e,{success:function(){delete e.local,t.model.set({commentCount:1},{silent:!0})}}),this.showComments();var i=this.addOneSubComment(e);this.$cList.append(i.el),this.$scroll.scrollTo(i.el,100)},submitComment:function(){this.createComment(),this.clearDraft(),this.renderCount(),this.reRenderTextarea(),this.renderLastComment(),o.td_comment("add")},storeReplyModel:function(e,t){this.replyInfo.model=e,this.replyInfo.tip=t,this.replyInfo.isReply=!0},creatNewComment:function(e){var e=e||window.event;if(e.stopPropagation(),e.keyCode!=l.enter||!e.shiftKey){if(e.keyCode==l.enter&&e.metaKey){var t=$.caretPos(e.target),i=e.target.value.slice(0,t),n=e.target.value.slice(t);return void(e.target.value=i.concat("\n",n))}if(e.keyCode==l.enter){var s=this.$cTextarea.val();this.commentLimit&&s.length&&this.submitComment(),e.preventDefault()}else e.keyCode==l.tab?this.$cTextarea.focus():e.keyCode==l.escape}},setDraft:function(){if(this.$cTextarea.val()){var e=this.getCommentModel();e.reply=this.replyInfo,e=e.toJSON(),s.setDraft(this.modelId,e)}else this.clearDraft()},isReplyComment:function(){var e=this.$cTextarea.val();if(this.replyInfo.tip){var t=this.replyInfo.tip,i=new RegExp("^("+t+")");this.replyInfo.isReply=i.test(e)}return this.replyInfo.isReply},wordCountTip:function(){var e=this.$wCount,t=this.isReplyComment(),i=this.$cTextarea.length?this.$cTextarea.val().length:0,n=i-(t?this.replyInfo.tip.length:0),s=r.commentWordLimit-n;e.text(s),this.commentLimit=!1,s>=0?(this.commentLimit=!0,e.removeClass("count-warning")):(this.commentLimit=!1,e.addClass("count-warning"))},edittingComment:function(){this.wordCountTip(),this.showCommentFontCount()},deleteComment:function(e){this.commentCollection.remove(e);for(var t=this.subCommentView.length-1;t>=0;t--)if(this.subCommentView[t]&&this.subCommentView[t].model.id==e){this.subCommentView.splice(t,1);break}this.subCommentView.length||this.hideComments(),this.renderCount(),this.renderLastComment(),setTimeout(function(){a.adjustDetailHeight(300)},300)},refreshComment:function(){var e={},t={},i=this;_.each(this.commentCollection.models,function(t){e[t.get("id")]=t});for(var n=this.subCommentView.length-1;n>=0;n--)e[this.subCommentView[n].model.get("id")]?t[this.subCommentView[n].model.get("id")]=this.subCommentView[n]:(this.subCommentView[n].remove(),this.subCommentView.splice(n,1));_.each(this.commentCollection.models,function(e){t[e.get("id")]||i.addOneSubComment(e)}),e=null,t=null,this.orderSubCommentView(),this.renderComments(),this.renderCount()},orderSubCommentView:function(){this.subCommentView=_.sortBy(this.subCommentView,function(e){var t=e.model;return t.get("createdTime")})},initAutoComplete:function(){var e=this;this.typeahead=this.$cTextarea.typeahead({source:e.mUsers,limit:r.shareUserNumber,placement:"n",symbol:["@"],matcher:function(e){return e.value.toLowerCase().match(this.Tick.matchStr.toLowerCase())?!0:!1},sorter:function(e){return e},select:function(){var e=this.getActiveItem(),t=e.value||e;return this.TickInsert(t),this.$element.val(this.Tick.newText),this.$element.change(),this.setCaretPosition(this.$element.get(0)),this.$element.trigger("input"),this.hide()}})},refreshUsers:function(){var e=!1;if(this.mUsers=this.getMentionUsers(e),this.typeahead){var t=this.typeahead.data("typeahead");t&&t.updateSource&&t.updateSource(this.mUsers)}},getMentionUsers:function(e){var t=this.getProjectId();if(!u.isInTrash()&&d.isShareProejct(t)){var i=c.getAcceptedUsers(t,e),n=[];return _.each(i,function(e){var t=e.get(e.get("displayName")?"displayName":"username"),i=e.get("userId");if(i!==m.get("userId")){var s={value:t,key:i,atLabel:"@"+t,userId:i};n.push(s)}}),n}},removeView:function(){this.$hint&&this.$hint.empty(),this.subViews=this.subCommentView,this.draftView&&this.subViews.push(this.draftView),this.removeAll()}})}),define("hbs!template/activity_task_item",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o="",l="function",c=this.escapeExpression,d=i.helperMissing;return o+='<div class="activity">\n  \n  <div class="sum">\n      <span class="',(a=i.hintClass)?a=a.call(t,{hash:{},data:s}):(a=t.hintClass,a=typeof a===l?a.apply(t):a),o+=c(a)+'"><i></i></span>\n      <span class="creator">',(a=i.creator)?a=a.call(t,{hash:{},data:s}):(a=t.creator,a=typeof a===l?a.apply(t):a),o+=c(a)+'</span>\n      <span class="action text-secondary">',(a=i.action)?a=a.call(t,{hash:{},data:s}):(a=t.action,a=typeof a===l?a.apply(t):a),(a||0===a)&&(o+=a),o+='</span>\n      <span class="time text-info text-sml">',(a=i.time)?a=a.call(t,{hash:{},data:s}):(a=t.time,a=typeof a===l?a.apply(t):a),o+=c(a)+'</span>\n  </div>\n\n  <p class="detail text-secondary">',(a=i.detail)?a=a.call(t,{hash:{},data:s}):(a=t.detail,a=typeof a===l?a.apply(t):a),o+=c(a)+'</p>\n  <p class="action-btn expand text-link hide">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"expand",r):d.call(t,"I18n","expand",r)))+'</p>\n  <p class="action-btn collapse text-link hide">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"collapse",r):d.call(t,"I18n","collapse",r)))+"</p>\n\n</div>"})}),define("view/taskdetail/activity/item",["require","exports","module","utils/timeformat","service/prefs","lang/index","utils/index","service/userProfile","hbs!template/activity_task_item"],function(e,t){var i=e("utils/timeformat"),n=(e("service/prefs"),e("lang/index")),s=(e("utils/index"),e("service/userProfile"));t.View=Backbone.View.extend({events:{"click .expand":"expand","click .collapse":"collapse"},tagName:"li",template:e("hbs!template/activity_task_item"),actionType:{T_CREATE:n.get("activity_created_task"),T_DELETE:n.get("activity_deleted_task"),T_DONE:n.get("activity_completed_task"),T_UNDONE:n.get("activity_undone_task"),T_ASSIGN:n.get("activity_assigned_task"),T_DUE:n.get("activity_changed_task_duedate"),T_TITLE:n.get("activity_edited_task_title"),T_CONTENT:n.get("activity_edited_task_content"),T_TRASH_BACK:n.get("activity_undeleted_task"),T_ADD_FILE:n.get("activity_task_add_file"),T_DEL_FILE:n.get("activity_task_del_file")},editIcon:["due","title","content"],undoneIcon:["undone","trash-back"],fileIcon:["add-file","del-file"],maxLine:3,initialize:function(e){this.task=e.task,this.render(),this.initDom(),this.initExpandBtn()},render:function(){var e=this.format();this.$el.html(this.template(e))},initDom:function(){this.$handle=$("#task-activity-view .ta-handle"),this.$detail=this.$(".detail"),this.$expand=this.$(".expand"),this.$collapse=this.$(".collapse")},initExpandBtn:function(){var e=this.$handle.text(this.$detail.text()).css("line-height"),t=parseInt(e),i=this.$handle.height();i/t>this.maxLine&&(this.$detail.css("max-height",this.maxLine*t),this.showExpandBtn()),this.$handle.text("")},expand:function(){this.hideExpandBtn(),this.showCollapseBtn(),this.$detail.css("max-height","")},collapse:function(){var e=parseInt(this.$detail.css("line-height"));this.hideCollapseBtn(),this.showExpandBtn(),this.$detail.css("max-height",this.maxLine*e)},showExpandBtn:function(){this.$expand.removeClass("hide")},hideExpandBtn:function(){this.$expand.addClass("hide")},showCollapseBtn:function(){this.$collapse.removeClass("hide")},hideCollapseBtn:function(){this.$collapse.addClass("hide")},format:function(){var e={hintClass:this.getHint(),creator:this.getCreator(),action:this.getAction(),time:this.getTime(),detail:this.getDetail()};return e},getHint:function(){var e=this.model.get("action"),t=e.toLowerCase().replace(/t_/i,"").replace("_","-");return this.$el.addClass(t),t},getSvg:function(){var e=this.getHint();~this.editIcon.indexOf(e)?e="edit":~this.undoneIcon.indexOf(e)?e="undone":~this.fileIcon.indexOf(e)&&(e="attachment"),this.$el.addClass(e)},getCreator:function(){return this._getDisplayName(this.model.get("whoProfile"))},getAction:function(){var e=this.model.get("action");if("T_ASSIGN"===e){var t=this._getDisplayName(this.model.get("assigneeProfile"));return t?this.actionType.T_ASSIGN.replace("%s1",t):n.get("activity_canceled_assignment")}return this.actionType[e]},getTime:function(){var e=this.model.get("when");return i.formatActivityTime(e)},getDetail:function(){var e=this.model.get("action"),t="";if("T_DUE"===e){var s=this.model.get("dueDateBefore"),a=this.model.get("dueDate");t=a?n.get("activity_task_duedate").replace("%s1",i.formatDueDate(s)).replace("%s2",i.formatDueDate(a)):n.get("activity_task_duedate_clear")}else if("T_CONTENT"===e)t=this.model.get("content");
else if("T_ADD_FILE"===e||"T_DEL_FILE"===e){var r=this.model.get("attachments");t=_.pluck(r,"fileName").join(",")}return t?t:""},_getDisplayName:function(e){if(!e)return"";var t=e.isMyself,i="";return i=t?s.get("name"):e.name?e.name:e.username}})}),define("model/task-activity",["require","exports","module"],function(e,t){t.Model=Backbone.Model.extend({})}),define("collection/task-activity",["require","exports","module","utils/timeformat","model/task-activity"],function(e,t){var i=e("utils/timeformat");t.Collection=Backbone.Collection.extend({model:e("model/task-activity").Model,comparator:function(e){var t=i.prefMoment(e.get("when")).unix();return-t}})}),define("dao/task-activitydb",["require","exports","module","collection/task-activity","configs/settings"],function(e,t){var i=e("collection/task-activity").Collection,n=e("configs/settings");t.db={collectiondb:{},getActivityById:function(e,t,i){var s=this.getCollectionById(e);if(i){s.url=n.API_HOST_V1+"/project/"+t+"/task/"+e+"/activity";var a=this;s.fetch({success:function(i){a.afterFetchCollection(e,t,i)}})}return s},afterFetchCollection:function(e,t,i){_.each(i.models,function(i){i.set({taskId:e,projectId:t})}),i.trigger("refresh")},initCollection:function(e,t){var n=new i(t);return this.setCollection(e,n),n},getCollectionById:function(e){var t=this.collectiondb[e];return(!t||_.isEmpty(t))&&(t=this.initCollection(e)),t},setCollection:function(e,t){this.collectiondb[e]=t}}}),define("hbs!template/activity_task_list",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o="",l=i.helperMissing,c=this.escapeExpression;return o+='\n<div class="ta-header">\n  <span class="title">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"task_activity",r):l.call(t,"I18n","task_activity",r)))+'</span>\n  <span class="count"></span>\n  <a class="close fake-del"></a>\n</div>\n\n<div class="empty hide">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"activity_empty",r):l.call(t,"I18n","activity_empty",r)))+'</div>\n\n<div class="loading"></div>\n\n<ul></ul>\n'})}),define("view/taskdetail/activity/list",["require","exports","module","utils/dom","view/taskdetail/activity/item","dao/task-activitydb","hbs!template/activity_task_list"],function(e,t){var i=e("utils/dom"),n=e("view/taskdetail/activity/item").View,s=e("dao/task-activitydb").db;t.View=Backbone.View.extend({id:"task-activity",className:"t-activity p-b can-select",template:e("hbs!template/activity_task_list"),events:{"click .close":"closeActivity"},messages:function(){this.listenTo(this.collection,"refresh",this.refresh)},initialize:function(){this.subViews=[],this.getActivity(),this.render(),this.messages()},render:function(){this.$el.html(this.template()),$("#task-activity-view").append(this.$el),this.showLoading(),this.renderActivity(),$("#content-view").scrollTo(this.$el,1e3)},refresh:function(){this.removeSubView(),this.hideLoading(),this.renderActivity()},getActivity:function(){var e=this.model.get("projectId"),t=this.model.get("id");this.collection=s.getActivityById(t,e,!0)},renderActivity:function(){_.each(this.collection.models,function(e){var t=new n({model:e,task:this.model});this.subViews.push(t),this.renderOneActivity(t)},this),this.renderCount(),i.adjustDetailHeight()},renderOneActivity:function(e){this.$("ul").append(e.el)},renderCount:function(){this.$(".count").text(this.subViews.length)},showLoading:function(){this.$(".loading").show()},hideLoading:function(){this.$(".loading").hide()},showEmpty:function(){this.$(".empty").removeClass("hide")},hideEmpty:function(){this.$(".empty").addClass("hide")},closeActivity:function(){this.removeView(),i.adjustDetailHeight()},removeSubView:function(){_.each(this.subViews,function(e){e.remove()}),this.subViews=[],this.$("ul").empty()},removeView:function(){this.removeAll()}})}),define("hbs!template/location",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r="",o="function",l=this.escapeExpression;return r+='<div class="m-content">\n    <div class="hint">\n        <i class="icon_home icon-task-location"></i>\n    </div>\n  <div  class="info line-left">\n    <div class="name">\n       ',(a=i.transitionMethod)?a=a.call(t,{hash:{},data:s}):(a=t.transitionMethod,a=typeof a===o?a.apply(t):a),r+=l(a)+": ",(a=i.locationAddressName)?a=a.call(t,{hash:{},data:s}):(a=t.locationAddressName,a=typeof a===o?a.apply(t):a),r+=l(a)+'\n    </div>\n    <div class="address text-tny">\n        ',(a=i.locationAddress)?a=a.call(t,{hash:{},data:s}):(a=t.locationAddress,a=typeof a===o?a.apply(t):a),r+=l(a)+'\n    </div>\n  </div>\n</div>\n<div class="map hide">\n    <div id="map_canvas" style="width: 100%;height: 100%"></div>\n</div>\n\n'})}),define("view/taskdetail/location/item",["require","exports","module","lang/index","utils/calculate","configs/dict","utils/dom","hbs!template/location"],function(e,t){var i=e("lang/index"),n=e("utils/calculate"),s=(e("configs/dict"),e("utils/dom"));t.View=Backbone.View.extend({className:"location",template:e("hbs!template/location"),initialize:function(){this.lc=this.model.get("location"),this.render()},events:{"click .m-content":"toggleMap"},render:function(){this.lc&&this.lc.loc&&(this.pretreatmentLocation(),this.$el.html(this.template(this.lc)).appendTo($("#loction-view")),s.adjustDetailHeight())},pretreatmentLocation:function(){var e=this.lc;e.transitionMethod=i.get("transition_leave"),1==e.transitionType&&(e.transitionMethod=i.get("transition_enter"));var t=e.alias||null,n=null;e.address&&(t?n=e.address:t=e.address),t?n||(n=this.getCoordinat()):t=this.getCoordinat(),e.locationAddressName=t,e.locationAddress=n},getCoordinat:function(){return n.decimalToDegree(this.lc.loc.latitude)+"N, "+n.decimalToDegree(this.lc.loc.longitude)+"E"},getZoomLevel:function(e){var t=e/300;return Math.floor(16-Math.log(t)/Math.log(2))},toggleMap:function(){this.$(".map").hasClass("hide")?this.showMap():this.hideMap()},showMap:function(){this.$(".map").removeClass("hide"),this.showGoogleMap(),$("#content-view").scrollTo(this.$el,1e3)},hideMap:function(){this.$(".map").addClass("hide")},showGoogleMap:function(){var e=null,t=null,i=null,n=4;if(this.lc&&this.lc.loc&&(i=new google.maps.LatLng(this.lc.loc.latitude,this.lc.loc.longitude),n=this.getZoomLevel(this.lc.radius)),e=new google.maps.Map(document.getElementById("map_canvas"),{zoom:n,streetViewControl:!1,panControl:!1,mapTypeControl:!1,center:i,mapTypeId:google.maps.MapTypeId.ROADMAP,zoomControlOptions:{style:google.maps.ZoomControlStyle.SMALL}}),this.lc){var s={strokeColor:"#5f7fb0",strokeOpacity:.8,strokeWeight:3,fillColor:"transparent",fillOpacity:1,clickable:!1,draggable:!1,editable:!1,zIndex:1,center:i,map:e,radius:this.lc.radius};t=new google.maps.Circle(s);{new google.maps.Marker({position:i,map:e})}}}})}),define("view/taskdetail/single",["require","exports","module","utils/index","utils/condition","configs/limit","configs/dict","configs/status","configs/settings","lang/index","utils/dom","utils/print","utils/hash","utils/string","utils/timeformat","utils/log","modules/link-editor/editor","service/task","service/project","dao/projectdb","dao/taskdb","utils/task-util","view/taskdetail/base","view/tip","view/modal/get-upgrade","view/taskdetail/content","view/taskdetail/attachment/list","view/taskdetail/modify-completed-time","service/prefs","view/taskdetail/comment/list","utils/server","view/taskdetail/activity/list","configs/keycode","utils/analytics","utils/browser","view/taskdetail/location/item","utils/limit-lab"],function(e,t){var i=e("utils/index"),n=e("utils/condition"),s=e("configs/limit"),a=e("configs/dict"),r=e("configs/status"),o=(e("configs/settings"),e("lang/index")),l=e("utils/dom"),c=e("utils/print"),d=e("utils/hash"),u=e("utils/string"),h=e("utils/timeformat"),p=e("utils/log"),m=e("modules/link-editor/editor"),f=e("service/task"),g=e("service/project"),v=e("dao/projectdb").db,y=e("dao/taskdb").db,k=(e("utils/task-util"),e("view/taskdetail/base").View),w=e("view/tip").View,b=e("view/modal/get-upgrade").View,T=e("view/taskdetail/content").View,I=e("view/taskdetail/attachment/list").View,C=e("view/taskdetail/modify-completed-time").View,x=e("service/prefs"),S=e("view/taskdetail/comment/list").View,D=e("utils/server"),j=e("view/taskdetail/activity/list").View,P=e("configs/keycode"),M=e("utils/analytics"),A=e("utils/browser"),V=e("view/taskdetail/location/item").View,O=e("utils/limit-lab");t.View=k.extend({events:function(){return _.extend(k.prototype.events.call(this),{"keyup .task-title":"keyupTitle","input .task-title":"updateTitle","paste .task-title":"convertHtmlToPlain","blur .task-title":"saveTitle","keydown #taskcontent":"focusToTitle","click #task-print-button":"printTask","click #task-duplicate-button":"duplicateTask","click #task-modify-completed-button":"showModifyCompletedTime","click #task-add-comment-button":"toggleComment","click .dropdown-toggle":"creatTaskForOutsingle","click #task-activity-button":"showTaskActivity","click #upload-attachment-btn":"analyAttachMenu"})},messages:function(){this.listenTo(this.model,"closeDetailView",this.closeView),this.listenTo(this.model,"destroy",this.remove),this.listenTo(this.model,"change:title",this.renderTitle),this.listenTo(this.model,"change:dueDate change:repeatFlag",this.renderPreviewDuedate),this.listenTo(this.model,"change:priority change:items change:content change:status",this.renderStatus),this.listenTo(this.model,"change:projectId",this.renderProject),this.listenTo(this.model,"change:attachments",this.renderAttachments),this.listenTo(this.model,"change:location",this.renderMap),this.listenTo(this.model,"change:commentCount",this.renderComment),this.listenTo(this.contentView,"saveContent",this.save),this.listenTo(this.model,"toggleCompleteFromSubTask",this.toggleCompleteFromSubTask),this.listenTo(this.model,"toggleRenderModifyButton",this.toggleRenderModifyButton),this.listenTo(this.model,"change:remindTime",this.renderSnooze),this.constructor.__super__.messages&&this.constructor.__super__.messages.call(this)},initialize:function(e){this.options=e,this.render(),this.initDom(),this.renderTitle(),this.initCommpent(),this.watchAutoSaving(),this.constructor.__super__.initialize.apply(this,[e]),this.messages(),this.initAssignment(),this.renderSnooze(),l.adjustDetailHeight()},initCommpent:function(){this.renderContent(),this.renderAttachments(),this.renderMap(),this.renderComment()},initDom:function(){this.$content=this.$("#content-view")},renderContent:function(){this.contentView=new T({el:this.$content,model:this.model})},renderAttachments:function(){this.attachmentView&&this.attachmentView.removeView(),this.attachmentView=new I({model:this.model})},renderMap:function(){_.isObject(this.model.get("location"))&&(this.locationView&&this.locationView.remove(),this.locationView=new V({model:this.model}))},analyAttachMenu:function(){$("#task-file-button").trigger("click.attachment"),A.isIE&&this.$("#task-file-button").blur(),M.td_menu("attachment")},getProjectId:function(){return this.model.get("projectId")},renderSnooze:function(){var e=this.$(".preview-snooze"),t=this.model.get("remindTime"),i=this.model.get("dueDate"),n="";t&&i&&t!==i&&this.model.hasSnoozeTime()&&(n=x.getTaskDetailSnooze(t),n=o.get("snooze_until").replace("%s1",n)),e.text(n)},watchAutoSaving:function(){function e(){if(t.model.isDirty){var i=h.prefMoment().unix()-t.model.changedTime;i>=30&&t.saveByShortcut()}t.model.timer=setTimeout(e,3e4)}this.model.timer&&this.stopRun();var t=this;this.model.timer=setTimeout(e,3e4)},stopRun:function(){clearTimeout(this.model.timer),this.model.timer=0},captureChangeFromServer:function(e,t){null!=t.xhr&&this.rememberFocus()},renderPreviewDuedate:function(){this.updateTimePreview()},_renderPreview:function(){this.renderDueDatePreview(this.model.get("dueDate"),this.model.get("reminders"),this.model.get("isAllDay"),this.model.get("repeatFlag"))},initAssignment:function(){var e=this.model.get("projectId");n.isSubscribeCalendarTask(this.model)||this.renderAssignmentDom(e,[this.model])},deleteAssignee:function(){var e=this,t=this.model.get("assignee");null!=t&&-1!==t&&(this.delAssigneeTimeId=setTimeout(function(){e.model.trigger("delAssignee")},3e3))},restoreAssignee:function(){this.delAssigneeTimeId&&clearTimeout(this.delAssigneeTimeId)},setAssignee:function(e){this.model.set("assignee",e),this.model._setAssignee(e)},refreshDuedate:function(){this.renderPreviewDuedate()},selfSetTimecard:function(e){e||(e={}),e.dueDate=this.model.get("dueDate")||null;var t=this.model.get("reminders")||[];e.reminders=JSON.parse(JSON.stringify(t)),e.isAllDay=this.model.get("isAllDay"),e.repeatFrom=this.model.get("repeatFrom");var i=this.model.get("repeatFlag");return e.repeatFlag=null!=i&&0!==i.length?n.isSubscribeCalendarTask(this.model)?"RRULE:"+this.model.get("repeatFlag"):this.model.get("repeatFlag"):null,e},selfSaveTime:function(e){e||(e={});var t=this.model.get("reminders"),i=this.model.get("repeatFrom"),n=this.model.get("repeatFlag"),s=this.model.get("dueDate"),r=this.model.get("isAllDay");if(r!==e.isAllDay||!_.isEqual(e.reminders,t)||Number(e.repeatFrom)!==Number(i)||e.repeatFlag!=n||h.prefMoment(e.dueDate).unix()!==h.prefMoment(s).unix()){if(e.dueDate){var o=h.prefMoment(e.dueDate);e.isAllDay&&(o=o.startOf("day"));var l=o.utc().format(a.format.atomTime);this.model.set({dueDate:l,repeatFirstDate:l,reminders:e.reminders,isAllDay:e.isAllDay})}else this.model.set({remindTime:null,dueDate:null,reminders:null,isAllDay:null});e.repeatFlag?this.model.set("repeatFlag",e.repeatFlag):this.model.set("repeatFlag",null),this.model.set("repeatFrom",e.repeatFrom),this.model.markDirty(),this.save()}},showTaskActivity:function(){var e=this;O.checkPro(a.pluginId.taskActivity,function(){e.activityView&&e.activityView.removeView(),e.activityView=new j({model:e.model}),M.td_menu("activity")})},showModifyCompletedTime:function(){var e=this,t=moment(this.model.get("completedTime")).format("YYYY-MM-DD");$("#completed-time").text(t),clearTimeout(this.timeOut),$("#modify-completed-time-tip").css({bottom:"50px",top:"auto",right:"10px"}).stop().fadeIn(),this.timeOut=setTimeout(function(){$("#modify-completed-time-tip").fadeOut()},5e3),$("#modify-completed-time").on("click",function(){$("#modify-completed-time-tip").fadeOut(),e.modifyCompletedTime()})},modifyCompletedTime:function(e){e=e||window.event,e.preventDefault(),this.modifyCompletedTimeView&&this.modifyCompletedTimeView.close(),this.modifyCompletedTimeView=new C({model:this.model})},hideComment:function(){this.commentView&&this.commentView.$hint&&(this.commentView.$hint.find(".n-bottom").toggleClass("hide"),this.$el.toggleClass("has-comments-textarea"),l.adjustDetailHeight())},renderComment:function(){this.model.get("commentCount")&&(this.setPadding(),this.commentView&&this.commentView.removeView(),this.commentView=new S({model:this.model,operation:"renderComment"}))},setPadding:function(){this.$el.addClass("has-comments")},resetPadding:function(){this.$el.removeClass("has-comments")},toggleComment:function(){this.commentView?this.hideComment():this.showComment()},showComment:function(){this.setPadding(),this.commentView=new S({model:this.model,operation:"addComment"}),this.commentView.$cTextarea.focus().caretToEnd(),M.td_menu("comment")},placeCaretAtEnd:function(e){l.placeCaretAtEnd(this.$(e).get(0))},toggleCompleteTaskByDrag:function(){Backbone.trigger("toggleCompleteByDrag",this.model.get("id"))},toggleRenderModifyButton:function(){var e=this.model.get("status");e?this.$("#task-modify-completed-button").show():this.$("#task-modify-completed-button").hide()},toggleComplete:function(e){d.isInCompleted()&&this.closeView(),this.model.toggleModelComplete()},toggleCompleteFromSubTask:function(){var e=this.model.get("items"),t=_.pluck(e,"status");t=_.uniq(t),1===t.length&&t[0]&&!this.model.get("status")&&this.model.toggleModelComplete()},renderStatus:function(){l.switchIcon(this.$(".td-header"),this.model),l.switchIcon(this.$(".td-caption"),this.model),this.renderPriorityIcon(this.model.get("priority"))},renderTitle:function(e,t,i){if(i&&i.cid==this.cid)return!1;_.isUndefined(this.titleEditor)&&(this.titleEditor=new m({empty:o.get("placeholder_task_title"),text:this.model.get("title"),readonly:d.isInTrash()||g.isInClosedProject()||d.isInSubscribeCalendars(),whereUseIt:"title"}),this.$el.find("#tasktitle").append(this.titleEditor.$el));var n=this.model.get("title");this.titleEditor.setText(n),""==n&&this.titleEditor.showEditor()},keyupTitle:function(e){this.inputedText!==this.titleEditor.getText()&&this.updateTitle(e)},updateTitle:function(e){e=e||window.event;var t;this.inputedText=this.titleEditor.getText(),t=this.isEndOfSelection?i.verifyPasteEnter(this.model,this.titleEditor.getText())+" ":this.titleEditor.getText().replace(/\r?\n/g,"");var n=this.model.get("title");(n!=t||this.isEndOfSelection)&&(this.model.set("title",t,{cid:this.cid}),this.model.markDirty()),this.isEndOfSelection=!1},saveTitle:function(){r.isWindowBlur||this.model.isDirty&&(this.model.updateItemsOrder(),this.save())},focusToTitle:function(e){e=e||window.event,e.keyCode==P.up_arrow&&0==l.getInputCaretPosition(e.target)?(this.titleEditor.showEditor(),this.$el.find("textarea.title").focus()):e.ctrlKey&&e.keyCode==P.home||e.metaKey&&e.keyCode==P.up_arrow?(l.setInputCaretPosition(e.target,0),this.$content.scrollTo(0,100)):(e.ctrlKey&&e.keyCode==P.end||e.metaKey&&e.keyCode==P.down_arrow)&&(l.setInputCaretPosition(e.target,e.target.value.length),this.$content.scrollTo("100%",100))},deleteTask:function(){if(this.deleteAssignee(),d.isInTKCalendar())Backbone.trigger("deleteOutSingleTask"),this.model.trigger("hideOnDateView"),y.moveToTrash(this.model);else{this.__delete(),this.model.trigger("hideOnListViewForDelete"),y.moveToTrash(this.model);{var e=_.bind(this.undoDelete,this),t=u.cut20(this.model.get("title"))+" ",i=_.string.sprintf(o.get("task_deleted"),t);new w({text:i,action:e,actionText:o.get("undo")})}}},undoDelete:function(){var e=$("#task-ul-list li");e.each(function(e,t){$(t).hasClass("active")&&$(this).removeClass("active selected")}),this.model.trigger("restore"),this.model.trigger("showOnListView"),this.restoreAssignee(),y.moveFromTrash(this.model),Backbone.trigger("refresh"),Backbone.trigger("navigateTask",this.model.id),this.model.trigger("toggleActive placeCaretAtEnd"),u.isValidDate(this.model.get("dueDate"))&&this.model.isNormal()&&f.markDatesHasTask(h.formatUtcToDateString(this.model.get("dueDate")))},restore:function(e){var t=e.attr("projectid");f.restore([this.model],t),0===y.trash.length&&l.hideClearTrashBtn(),this.remove()},deleteForever:function(e){e=e||window.event,e.preventDefault(),this.model.trigger("deleteForever"),y.permanentDelete(this.model),this.remove()},setPriority:function(e){var t=this.model.get("priority");e!=t&&(this.model.set("priority",e),this.model.markDirty(),this.save())},getPriority:function(){var e;return e=$(".priority-setting .priority").hasClass("high-priority")?0:5,$("#task-detail-inner .checkbox, .priority-setting .priority").toggleClass("high-priority"),e},setPriorityByShortcut:function(){if(!n.isSubscribeCalendarTask(this.model)){{this.model.get("priority")}if(!d.isInTrash()){var e=this.getPriority();this.model.updateItemsOrder(),this.save({priority:e})}}},renderProject:function(e){var t=v.getProjectById(e.get("projectId"));this.$(".project").val(t.get("name"))},moveSelectedToProject:function(e){var t=[],i=this.model.get("projectId");if(!n.isSubscribeCalendarTask(this.model)&&e!==i){var s=this.isResetAssign(this.model,i,e);s&&(t=[{projectId:e,taskId:this.model.get("id"),assignee:-1}],this.model.set({assignee:null},{silent:!0})),f.moveToProject(this.model,e,function(){t.length&&D.assign(JSON.stringify(t),function(e){_.isEmpty(e.id2error)||p.log(e.id2error)})}),this._afterMove(e),this.hideTask(this.model,e)}},render:function(){this.prepareRender();var e=this.model.toJSON();return e.taskid=this.model.get("id"),e.type="single",this.$el.html(this.template(e)),this.initRepeatTip(),this.renderPreviewDuedate(),this.modelToPreview(),this.renderStatus(),$("#detail-view").empty().append(this.$el),this.baseRender(),this.initScrollbar(),this},rememberFocus:function(){var e=window.getSelection();e.rangeCount>0&&(this.selection={},$(document.activeElement).is(".title")&&(this.selection.type="title",this.selection.offset=document.activeElement.selectionStart),$(document.activeElement).is(".link-editor")&&(this.selection.type="note",this.selection.offset=document.activeElement.selectionStart))},restoreFocus:function(){if(null!=this.selection)if("title"==this.selection.type){var e=this.$(".title").get(0);e.selectionStart=e.selectionEnd=this.selection.offset}else if("note"==this.selection.type){this.contentEditor.showEditor();var e=this.$(".link-editor").get(0);this.contentEditor.simulateCaret(this.selection.offset)}},modelToPreview:function(){n.isSubscribeCalendarTask(this.model)||this._renderPreview()},initScrollbar:function(){this.$(".antiscroll-wrap").antiscroll()},save:function(e){e=e||{},this.model.isDirty&&(this.model.save(e),d.isInTKCalendar()&&this.model.isNew()&&y.add(this.model))},setToday:function(){var e=h.formatToDateString(h.prefMoment());this.changeDueDate(e)},setTomorrow:function(){var e=h.formatToDateString(h.prefMoment().add("d",1));this.changeDueDate(e)},setNextWeek:function(){var e=h.formatToDateString(h.prefMoment().add("w",1));this.changeDueDate(e)},changeDueDate:function(e){if(!n.isSubscribeCalendarTask(this.model)){var t=h.getDueDateText(this.model.get("dueDate"));if(u.isValidDate(e)&&t!=e){Backbone.trigger("updateTaskOrderFromTimecard",e);var i=e;null!=this.model.get("dueDate")&&(i+=" "+h.prefMoment(this.model.get("dueDate")).format("HH:mm"));var s=x.formatToUtcString(i);this.model.set("dueDate",s),this.model.set("repeatFirstDate",s),this.model.markDirty(),this.model.save(),this._renderPreview(),f.markDatesHasTask(e)}}},updateTimePreview:function(){this._renderPreview(),this.renderSelectedDate(this.model.get("dueDate"))},printTask:function(e){e=e||window.event,e.preventDefault(),c.printTaskDetail(),M.td_menu("print")},duplicateTask:function(e){e=e||window.event,e.preventDefault();var t=this.model.get("projectId"),i=f.getTasksCountByProject(t);if(i<s.projectTaskNumber||n.isToInbox(t)&&i<s.inboxTaskNumber){var a=this.model.cloneTask({status:0,title:this.model.get("title")+" "+o.get("copy_task"),sortOrder:f.getMinSortOrder(t)});a.local=!0,a.updateItemsOrder(),a.resetSubtaskStatus(),a.resetModifyData(),y.add(a),a.save({},{success:function(){Backbone.trigger("navigateTask",a.id),a.trigger("toggleActive placeCaretAtEnd")}})}else new b({type:"task"});M.td_menu("duplicate")},convertHtmlToPlain:function(e){e=e||window.event;var t=e.currentTarget;this.isEndOfSelection=t.selectionEnd==this.titleEditor.getText().length?!0:!1},creatTaskForOutsingle:function(){d.isInTKCalendar()&&this.model.isNew()&&!this.model.get("title")&&(this.model.save(),y.add(this.model))},getDueDate:function(){return this.model.get("dueDate")}})}),define("view/taskdetail/multi",["require","exports","module","utils/dom","utils/hash","lang/index","utils/string","utils/timeformat","service/task","service/project","service/prefs","dao/taskdb","view/taskdetail/base","view/tip","utils/server","utils/condition"],function(e,t){var i=e("utils/dom"),n=e("utils/hash"),s=e("lang/index"),a=(e("utils/string"),e("utils/timeformat")),r=e("service/task"),o=(e("service/project"),e("service/prefs")),l=e("dao/taskdb").db,c=e("view/taskdetail/base").View,d=e("view/tip").View,u=e("utils/server"),h=e("utils/condition");t.View=c.extend({events:function(){return _.extend(c.prototype.events.call(this),{})},messages:function(){this.constructor.__super__.messages&&this.constructor.__super__.messages.call(this),this.listenTo(this.collection,"change:priority",this.renderStatus)},initialize:function(e){this.constructor.__super__.initialize.apply(this,[e]),this.render(),this.messages(),this.initAssignment()},initAssignment:function(){var e=this.collection.getCommonProjectId();e&&this.renderAssignmentDom(e,this.collection.models)},restoreAssignee:function(){this.delAssigneeTimeId&&clearTimeout(this.delAssigneeTimeId)},deleteAssignee:function(){var e=this,t=[];this.collection.each(function(e){var i=e.get("assignee");null!=i&&-1!==i&&t.push({projectId:e.get("projectId"),taskId:e.get("id"),assignee:-1})}),0!==t.length&&(e.delAssigneeTimeId=setTimeout(function(){e._postAssignee(t)},3e3))},setAssignee:function(e){var t=[];this.collection.each(function(i){t.push({projectId:i.get("projectId"),taskId:i.get("id"),assignee:e}),i.set("assignee",e)}),this._postAssignee(t)},selfSetTimecard:function(e){this.toggleCommonTimecardTip(),e||(e={}),e.dueDate=this.getDueDate();var t=this.collection.getCommonRepeatFlag();e.repeatFlag=t;var i,n;return e.dueDate?(i=this.collection.getCommonReminders()||[],n=this.collection.getCommonIsAllDay()):(i=[],n=!0),e.reminders=JSON.parse(JSON.stringify(i)),e.isAllDay=n,e},isTimecardEqual:function(){var e=this.collection.getCommonRepeatFlag();return _.isUndefined(e)?!1:!0},toggleCommonTimecardTip:function(){var e=this.$("#commonTimecard-tip");this.isTimecardEqual()||(e.stop().removeClass("hide").animate({top:11},300),setTimeout(function(){e.stop().animate({top:-20},300).addClass("hide")},3e3))},selfSaveTime:function(e){this.collection.panelSetting(e),this.exnternalUpdates(this.collection.models)},updateTaskOrders:function(){var e=this.$(".checkbox").hasClass("checked")?2:0;e&&Backbone.trigger("updateTaskOrderFromCompleted",this.collection.models)},toggleCompleteTaskByDrag:function(e){e=e||window.event,_.isObject(e)&&e.preventDefault();var t=[],i=[];n.isInCompleted()&&this.closeView(),this.collection.each(function(e){e.willRepeat()?e.toggleModelComplete():(e.set("status",2),i.push(e)),t.push(e)},this),this.exnternalUpdates(t)},toggleComplete:function(e){this.updateTaskOrders();var t=[],i=[];n.isInCompleted()&&this.closeView();var s=0===this.collection.getCommonStatus()?2:0;this.renderStatus(s),this.collection.each(function(e){e.willRepeat()?e.toggleModelComplete():(e.set("status",s),e.trigger("toggleCompleteByShortcut"),i.push(e)),t.push(e)},this),this.exnternalUpdates(t)},exnternalUpdates:function(e){l.batchUpdateTasks(e),r.updateCalendarDatesWithTask()},save:function(){},deleteTask:function(){this.__delete(),this.collection.each(function(e){e.trigger("hideOnListViewForDelete")},this),this.deleteAssignee(),l.batchMoveToTrash(this.collection.models);{var e=_.string.sprintf(s.get("tasks_plural"),this.collection.length),t=_.string.sprintf(s.get("task_deleted"),e),i=_.bind(this.undoDeleteTask,this);new d({text:t,action:i,actionText:s.get("undo")})}this.getOutOfView()},undoDelete:function(){var e=null;this.collection.each(function(t){e=t;var i=[];i.push({taskId:t.id,projectId:t.get("projectId")}),t.trigger("showOnListView"),t.trigger("restoreAssignee"),t.trigger("addSelected"),l.moveFromTrash(t),u.restoreTrash(t.get("projectId"),JSON.stringify(i),!0)},this),this.restoreAssignee(),Backbone.trigger("refresh"),e.trigger("toggleActiveSelected placeCaretAtEnd")},restore:function(e){var t=e.attr("projectid");r.restore(this.collection.models,t),this.remove()},deleteForever:function(e){e=e||window.event,_.isObject(e)&&e.preventDefault(),this.remove();var t=[];this.collection.each(function(e){t.push(e),e.trigger("remove"),l.permanentDelete(e.get("id"))},this),l.batchDeleteForever(t)},clearDueDate:function(e){e=e||window.event,e.preventDefault(),this.__clearDueDate();var t=[];this.collection.each(function(i){i.get("dueDate");i.set({dueDate:null,reminders:null,repeatFlag:null,repeatFirstDate:null}),this.__clearReminderTime(),this.__clearRepeat(e),t.push(i)},this),l.batchUpdateTasks(t),this.collection.trigger("updateTasksForDuedate")},clearReminderTime:function(e){e=e||window.event,e.preventDefault(),this.__clearReminderTime();var t=[],i=this._getDueDateWithoutReminder();this.collection.each(function(e){e.set({dueDate:i,reminders:null}),t.push(e)},this),l.batchUpdateTasks(t)},clearRepeat:function(e){e=e||window.event,e.preventDefault(),this.__clearRepeat();var t=[];this.collection.each(function(e){e.set({repeatFlag:null,repeatFirstDate:null}),t.push(e)},this),l.batchUpdateTasks(t)},setPriority:function(e){var t=[];this.collection.each(function(i){var n=i.get("priority");n!=e&&0==i.get("status")&&(i.set({priority:e}),t.push(i))},this),_.isEmpty(t)||l.batchUpdateTasks(t),this.renderPriorityIcon(e)},moveSelectedToProject:function(e){var t=[],i=[],n=this;this.collection.each(function(s){var a=s.get("projectId");if(a!==e){var r=n.isResetAssign(s,a,e);r&&(i.push({projectId:e,taskId:s.get("id"),assignee:-1}),s.set({assignee:null},{silent:!0})),t.push(s)}}),t.length&&(r.batchMoveToProject(t,e,function(){i.length&&u.assign(JSON.stringify(i),function(e){_.isEmpty(e.id2error)||log.log(e.id2error)})}),this.collection.each(function(t){n.hideTask(t,e)}),this._afterMove(e))},getMultiTaskStatus:function(){var e,t=_.uniq(this.collection.pluck("status"));return e=1==t.length||"1,2"==t.sort().toString()?t.shift():null},render:function(e){this.prepareRender();var t=this.getMultiTaskStatus(),i=this.collection.getCommonProjectId(),n=this.collection.getCommonPriority();return this.$el.show(),this.$el.html(this.template({type:"multi",taskCount:this.collection.length,status:t,priority:n,projectId:i})),this._renderPreview(),this.renderStatus(t),$("#detail-view").empty().append(this.$el),this.baseRender(),this},getProjectId:function(){return this.collection.getCommonProjectId()},refreshDuedate:function(){this._renderPreview()},_renderPreview:function(){var e=this.getDueDate(),t=this.collection.getCommonReminders(),i=this.collection.getCommonRepeatFlag(),n=this.collection.getCommonIsAllDay();this.renderDueDatePreview(e,t,n,i),this.renderSelectedDate(e)},renderStatus:function(e){e instanceof Backbone.Model?(i.switchIcon(this.$(".td-header"),e),i.switchIcon(this.$(".td-caption"),e)):(i.switchIcon(this.$(".td-header"),null,e),i.switchIcon(this.$(".td-caption"),null,e)),this.renderPriorityIcon(this.collection.getCommonPriority())},changeDueDate:function(e){var t=[];this.collection.each(function(i){if(!h.isSubscribeCalendarTask(i)){var n=i.get("dueDate"),s=e;null!=n&&(s+=" "+a.prefMoment(i.get("dueDate")).format("HH:mm"));var r=o.formatToUtcString(s);i.set({dueDate:r,repeatFirstDate:r}),_.isEmpty(i.get("reminders"))&&i.set("isAllDay",!0),t.push(i)}},this),_.isEmpty(t)||(this.collection.add(t,{merge:!0}),this.refreshDuedate(),Backbone.trigger("updateTaskOrderFromTimecard",e),l.batchUpdateTasks(t),r.updateCalendarDatesWithTask())},setToday:function(){var e=a.formatToDateString(a.prefMoment());this.changeDueDate(e)},setTomorrow:function(){var e=a.formatToDateString(a.prefMoment().add("d",1));this.changeDueDate(e)},setNextWeek:function(){var e=a.formatToDateString(a.prefMoment().add("w",1));this.changeDueDate(e)},getDueDate:function(){return this.collection.getCommonDuedate()}})}),define("collection/section",["require","exports","module","collection/task","model/task"],function(e,t){var i=e("collection/task").Collection;t.Collection=i.extend({model:e("model/task").Model})}),define("utils/changetag",["require","exports","module"],function(e,t){t.tagsView={recordLength:function(e){var t,i,n,s,a;return null!=window.getSelection?(a=window.getSelection(),t=a.anchorNode,i=a.anchorOffset,n=e,s=document.createRange(),null!=n&&s.setStartBefore(n),null!=t&&s.setEnd(t,i),s.toString().length,a.removeAllRanges(),a.addRange(s),s.toString().length):0}}}),define("hbs!template/confirm_drag_task_to_subtask",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o="",l=i.helperMissing,c=this.escapeExpression;return o+='<div class="popup-header">\n    <a class="popup-close">&times;</a>\n    <h1 class="popup-title text-lrg text-primary">\n        ',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"drag_task_to_subtask",r):l.call(t,"I18n","drag_task_to_subtask",r)))+'\n    </h1>\n</div>\n\n<div class="popup-body">\n    <p class="text-primary">',
r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"confirm_drag_task_to_subtask_intro",r):l.call(t,"I18n","confirm_drag_task_to_subtask_intro",r)))+'</p>\n</div>\n\n<div class="popup-footer">\n    <button class="btn btn-cancel">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"cancel",r):l.call(t,"I18n","cancel",r)))+'</button>\n    <button class="btn btn-primary">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"ok",r):l.call(t,"I18n","ok",r)))+"</button>\n</div>\n"})}),define("view/modal/drag-to-subtask",["require","exports","module","modules/popup/popup","hbs!template/confirm_drag_task_to_subtask"],function(e,t){var i=e("modules/popup/popup").View;t.View=Backbone.View.extend({id:"confirm-drag-to-subtask-view",template:e("hbs!template/confirm_drag_task_to_subtask"),events:{"click .btn-primary":"dragToSubtask","click .btn-cancel":"close"},initialize:function(e){this.initData(e),this.render()},initData:function(e){_.extend(this,e)},dragToSubtask:function(){this.action&&this.action(),this.close()},render:function(){this.$el.html(this.template({})),this.renderPopup()},renderPopup:function(){this.popupView=new i({view:this})},close:function(){this.popupView.onRemove()}})}),define("view/section/base",["require","exports","module","utils/condition","configs/dict","configs/status","configs/settings","configs/limit","utils/dom","lang/index","utils/timeformat","utils/hash","utils/analytics","service/prefs","dao/taskdb","service/task","service/project","model/task","view/task-item","view/modal/get-upgrade","utils/changetag","utils/server","offline/storage","view/modal/drag-to-subtask","dao/order_by_date","service/sort","configs/keycode","service/filter","service/userProfile"],function(e,t){var i=e("utils/condition"),n=e("configs/dict"),s=e("configs/status"),a=e("configs/settings"),r=e("configs/limit"),o=e("utils/dom"),l=e("lang/index"),c=(e("utils/timeformat"),e("utils/hash")),d=e("utils/analytics"),u=e("service/prefs"),h=e("dao/taskdb").db,p=e("service/task"),m=e("service/project"),f=e("model/task").Model,g=e("view/task-item").View,v=e("view/modal/get-upgrade").View,y=(e("utils/changetag").tagsView,e("utils/server")),k=e("offline/storage"),w=e("view/modal/drag-to-subtask").View,b=e("dao/order_by_date").db,T=(e("service/sort").rank,e("configs/keycode")),I=(e("service/filter"),e("service/userProfile"));t.View=Backbone.View.extend({tagName:"section",events:{"keydown .task":"taskShortcutHandler","click .section-header":"sectionSlideToggle"},messages:function(){this.listenTo(this.collection,"add",this.storeTaskForBatch),this.listenTo(this.collection,"remove",this.removeTaskView)},createOnEnterProperties:{},regSortable:/(task-sortable-by-date|task-sortable-by-custom)/i,showListOnce:50,initialize:function(e){_.extend(this,e),this.initProps&&this.initProps(),this.initComparator(),this.initFilter(),this.filterTasks(),this.initRenderItemCache(),this.subViews=[],this.taskListItemViews={},this.createOnEnter=_.throttle(function(e){this.__createOnEnter(e)},300),this.messages()},initComparator:function(){this.collection.comparator=this.sortBy||this.collection.comparator},initFilter:function(){this.filterAssignedMe(),this.collection.selfFilter=this.filter?this.filter:function(){return!1}},filterAssignedMe:function(){var e=this,t=this.filter;if(c.isInAssignedMe())var i=function(i){return i.get("assignee")!==I.get("userId")?!1:t.call(e,i)};this.filter=i||t},filterTasks:function(){var e=[],t=[];_.each(this.tasks,function(i){this.collection.selfFilter(i)?e.push(i):t.push(i)},this),this.tasks.length=0,_.extend(this.tasks,t),this.collection.add(e)},initRenderItemCache:function(){this.itemCache=[]},removeRenderItemCache:function(e){this.itemCache.splice(this.itemCache.indexOf(e),1)},addRenderItemCache:function(e){this.itemCache.push(e)},getRenderItemCount:function(){return this.itemCache.length},isInItemCache:function(e){return-1!==this.itemCache.indexOf(e)},isSectionOpen:function(){return this.$(".section-header").is(".open")},getHeightBetweenTopAndTask:function(e){var t=35,i=this.collection.get(e),n=t,s=this.isSectionOpen();if(i){var a=this.collection.indexOf(i);s&&(n+=a*t)}else s&&(n+=this.collection.length*t);return{height:n,isExist:!!i}},getProjectId:function(){var e=m.getProjectForCreateTask().id;return c.isInProjectGroup()&&(e=s.CurrentSortType===n.sortType.sortOrder?this.$el.attr("projectid"):m.getFirstProjectByGroupId(this.parentView.project.get("id")).id),e},ifCanShowIn:function(e){var t=!0;if(this.filter){var i=_.filter([e],this.filter,this);0==i.length&&(t=!1)}return t},_deleteHandle:function(e){Backbone.trigger("deleteTaskByShortcut"),this.targetOrientate(e)},taskShortcutHandler:function(e){e=e||window.event;var t=this,n=e.currentTarget;if(!c.isInTrash())switch(e.keyCode){case T.enter:if(e.preventDefault(),c.isInAssignedMe())break;var s=t.getProjectId(),a=p.getTasksCountByProject(s);a<r.projectTaskNumber||i.isToInbox(s)&&a<r.inboxTaskNumber?($("#task-ul-list ul li").removeClass("selected active"),this.createOnEnter(n)):(this.$(n).find(".title").blur(),new v({type:"task"}));break;case T.backspace:if(e.ctrlKey||e.metaKey)return e.preventDefault(),e.stopPropagation(),this._deleteHandle(n),!1;if(!this.$(n).find(".title").text())return e.preventDefault(),e.stopPropagation(),this.deleteOnBackspace(n),!1;case T["delete"]:if(e.ctrlKey||e.metaKey)return e.preventDefault(),e.stopPropagation(),this._deleteHandle(n),!1}},__createOnEnter:function(e){var t,i=this.$(e),n=this.$(e).next(".task"),s=i.attr("order"),r=n.attr("order"),o=this.getProjectId();if(n.exists()){var l=r-s;1==l&&this.enterCreateResetOrderValue(o),t=(Number(s)+Number(r))/2}else t=Number(s)+a.orderStep;var c=new f({id:ObjectId(),title:"",projectId:o,priority:0,sortOrder:t,status:0,timeZone:u.get("timeZone"),isAllDay:!0});c.local=!0;var p=(i.find("a").attr("taskId"),this.createOnEnterProperties()||{});c.set(p,{silent:!0}),c.save({},{silent:!0}),c.local=!1,h.add(c),this.collection.add(c,{silent:!0}),h.collection.on("sync",function(){if(c.hasAssign()){var e=[{projectId:c.get("projectId"),taskId:c.get("id"),assignee:c.get("assignee")}];y.assign(JSON.stringify(e),function(e){h.collection.off("sync")})}});var m=new g({model:c});this.addRenderItemCache(c.get("id")),this.taskListItemViews[c.get("id")]=m,this.parentView.trigger("resetActive"),c.trigger("toggleActive"),this.$(e).removeClass("selected").after(m.el),this.createOnEnterInDateGroup&&this.createOnEnterInDateGroup(m),d.t_group_add(),c.trigger("placeCaretAtEnd"),Backbone.trigger("navigateTask",c.id,!0)},_setTaskGroupCollapseStatus:function(e,t){var i=this;setTimeout(function(){var n=i._getSectionStatusPath(e);k.setCacheItem(n,t)},a.responsiveTime)},_getSectionStatusPath:function(e){var t=I.get("username")+"/collapse/",i=m.getUniqProjectId();return i?t+i+"/"+e+(this.projectId?"/"+this.projectId:""):t},_getTaskGroupCollapseStatus:function(e){if(c.isInSubscribeCalendars())return"open";if(c.isInProjectView()||c.isInSmartProjectView()){var t=this._getSectionStatusPath(e);return 0==k.getCacheItem(t)?"":"open"}return"open"},deleteOnBackspace:function(e){var t=this.$(e),i=t.find("a").attr("taskId"),n=h.getById(i);n.isEmpty()&&(n.unmarkDirty(),n.trigger("destroy",n),h.moveToTrash(n),this.targetOrientate(e))},targetOrientate:function(e){var t=this.$(e),i=(t.find("a").attr("taskId"),t.prevAll("li").first()),n=i.find("a[taskId]").attr("taskId"),s=t.next("li").find("a").attr("taskId"),a=h.getById(n);if(void 0!==a)Backbone.trigger("navigateTask",n),a.trigger("toggleActive"),a.trigger("placeCaretAtEnd");else{var r=h.getById(s);void 0!==r?(Backbone.trigger("navigateTask",s),r.trigger("toggleActive"),r.trigger("placeCaretAtEnd")):(this.$(".alert").fadeIn(),$("#task-new").focus())}},enterCreateResetOrderValue:function(e){y.resetOrder(e,function(){o.resetOrderValue(a.orderStep)})},toggleCountBadge:function(e){if(e.hasClass("open"))e.find(".count").remove();else{var t='<span class="count badge">'+this.collection.length+"</span>";e.find(".section-title").append(t)}},sectionSlideToggle:function(e){e=e||window.event;var t=$(e.currentTarget);t.toggleClass("open"),this._setTaskGroupCollapseStatus(this.className,t.hasClass("open")),this.toggleCountBadge(t),t.next("ul").slideToggle("fast",function(){}),t.is(".open")||this.triggerAdvancePaginationWhenSectionClose()},triggerAdvancePaginationWhenSectionClose:function(){Backbone.trigger("advancePagination",this.collection.length)},createTaskFromSubtask:function(e){var t=e.draggable.find(".title").text(),i=e.draggable.attr("taskid"),n=h.getById(i),s=n.get("priority"),a=n.get("dueDate"),r=n.get("repeatFlag"),o=n.get("repeatFrom"),l=Number(e.draggable.hasClass("checked")),c=n.get("projectId"),d=new f({id:ObjectId(),title:t,projectId:c,priority:s,dueDate:a,repeatFlag:r,repeatFrom:o,status:l,timeZone:u.get("timeZone"),deleted:0,isSubTask:!0});d.local=!0,h.add(d);var p=new g({model:d});return p},dropHandle:function(e){var t=[];_.each(e,function(e){var i=h.getById($(e).find("a").attr("taskid"));t.push(i)}),this.drop&&this.drop(t)},initDroppable:function(){var e=this,t=this.$el;t.droppable({hoverClass:n.hoverClass.section,tolerance:"pointer",over:function(e,t){var i=o.selected_tasks();i.parents("section").removeClass("task-drag-hovered")},drop:function(i,n){if(!c.isInTagView())if(n.draggable.hasClass("sub-task")){var s=e.createTaskFromSubtask(n);e.dropHandle(s.$el),Backbone.trigger("deleteSubtaskTurned",n.draggable),d.t_drag("drag_from_sub")}else{var a=o.selected_tasks();if(!a.length)return;0!==a.parents("section").index(t)&&(e.dropHandle(a),a.removeClass("addClassDrag")),d.t_drag("drag")}}})},initSortable:function(){var e,t,i,n,s,a=this,r=15,u=this.regSortable,h=this.$el.width();this.$el.sortable({connectWith:".sortable, #sub-task-list, #taskcontent",dropOnEmpty:!0,handle:".drag",containment:"body",items:"li",cancel:".subcalendar",tolerance:"pointer",scroll:!0,create:function(e,t){$(this).sortable("option","helper",function(e,t){var i=$("#task-ul-list ul>li.addClassDrag.selected");return i=$(i.length?"#task-ul-list ul>li.selected":"#task-ul-list ul>li.addClassDrag"),i.length>1?"<div class='t-multi drag-help task'>"+_.string.sprintf(l.get("tasks_plural"),i.length)+"</div>":"<div class='drag-help task'>"+t.html()+"</div>"}),$(this).sortable({cursorAt:{top:20,left:-r}})},start:function(n,r){s=$("#tasktitle").attr("taskid"),h=a.$el.width(),r.item.show(),a.copyPloceholder=$('<div class="ui-sortable-placeholder-copy"></div>'),t=r.item.closest(".task-sortable-by-custom"),i=r.item.closest(".task-sortable-by-date"),e=o.selected_tasks(),i.length&&_.each(e,function(e){var t=$(e).closest(".task-sortable-by-date");if(t.length){var i=t.attr("date");$(e).attr("date",i)}})},sort:function(e,t){var i=t.placeholder,r=$("#sub-task-list .ui-sortable-placeholder"),l=$("#task-ul-list .ui-sortable-placeholder"),d=i.siblings().hasClass("sub-task"),p=$("#switch-mode .mode-text").hasClass("show")&&!$("#taskcontent textarea").val();if(t.position.left>=h){var m=t.item.find("a").attr("taskid");if(m===s)return void a.$el.sortable("cancel");p?a._addDragHovered():(o.hidePlaceholder(l),d?(o.showPlaceholder(r),o.hidePlaceholder(a.copyPloceholder)):(o.showPlaceholder(a.copyPloceholder),a.copyPloceholder.appendTo("#sub-task-list")))}else{var f=i.closest("section")[0];n=f&&u.test(f.className.split(/\s+/g))&&!(c.isInAssignedMe()||c.isInTagView()),o.hidePlaceholder(a.copyPloceholder),o.hidePlaceholder(r),a._removeDragHovered(),n?o.showPlaceholder(l):o.hidePlaceholder(l)}},over:function(e,t){},beforeStop:function(e,t){var i=t.item,n=i.find("a").attr("taskid");a.ui={index:i.index(),item:i,position:t.position.left},i.siblings().hasClass("sub-task")||(a.ui.index=-1),s&&n!==s&&t.position.left>=h&&(a.copyPloceholder.remove(),a._removeDragHovered(),a._creatConfirmDragView(),d.t_drag("drag_to_sub"))},stop:function(l,c){if(!n&&c.position.left<h)return void a.$el.sortable("cancel");var u=c.item,p=u.find("a").attr("taskid");if(c.position.left>=h&&p===s)return void a.$el.sortable("cancel");if(c.position.left>=r){if(e=o.selected_tasks(),!e.length)return void a.$el.sortable("cancel");if(!n)return;if(t=u.closest(".task-sortable-by-custom"),i=u.closest(".task-sortable-by-date"),i.length){var f=i.attr("date");a.dateProjectId=m.getCurrentDateProjectId(),b.changeSortOrderByDate(c,i.find("li"),e,f,a.dateProjectId)}else if(t.length){if(t.find("ul>li").length){var g=u.prev(),v=u.next();g.length?g.after(e):v.before(e)}else t.find("ul").append(e);e.length>1?a._changeMultipleSortOrder(t.find("li"),"#task-ul-list ul>li.selected",c):a._changeSortOrder(t.find("li"),p,c)}d.t_drag("drag")}else a.$el.sortable("cancel");a.$el.sortable("cancel")}})},_moveProject:function(e){s.CurrentSortType===n.sortType.project&&e.length&&y.batchTasksMoveToProject(JSON.stringify(e))},_saveTask:function(e,t){e.each(function(){var e=$(this).find("a").attr("taskid"),t=h.getById(e);t.trigger("dropOnSortOrderSection")})},_changeMultipleSortOrder:function(e,t,i){var r,o,l=$(e),c=$(t),d=(i.item.index(),i.item.nextAll().not(".selected")),u=i.item.prevAll().not(".selected"),h=[],p=[],m=this;if(s.CurrentSortType===n.sortType.project?(o=i.item.closest(".task-sortable-by-custom"),r=o.attr("projectid")):r=this.getProjectId(),0==u.length){var f=d.length?Number(d.attr("order")):0;c.each(function(e){var t=f-(c.length-e)*a.orderStep;m._setTaskOrder(t,r,p,h,$(this))})}else if(0==d.length)c.each(function(e){var t=Number(u.attr("order"))+(e+1)*a.orderStep;m._setTaskOrder(t,r,p,h,$(this))});else{var g=Number(d.attr("order"))-Number(u.attr("order"))-1;if(g/c.length<1)l.each(function(e){var t=e*a.orderStep;m._setTaskOrder(t,r,p,h,$(this))});else{var v=Math.abs(Math.floor(g/c.length));c.each(function(e){var t=Number(u.attr("order"))+(e+1)*v;m._setTaskOrder(t,r,p,h,$(this))})}}this._saveTask(c),this._moveProject(p,r),y.sortProject(r,JSON.stringify(h))},_setTaskOrder:function(e,t,i,n,s){var a=s.find("a").attr("taskid");s.attr("order",e);var r=h.getById(a);r.get("projectId")!==t?(i.push({fromProjectId:r.get("projectId"),toProjectId:t,sortOrder:e,taskId:a}),r.set({projectId:t,sortOrder:e})):n.push({taskId:a,sortOrder:e})},__changeTaskSortOrder:function(e,t,i,n){var s=$(e),a=i.item.index(),r=[],o=t,l=0,c=!1,d=i.item.next(),u=i.item.prev();if(0==a)d.length&&(l=Number(d.attr("order"))-n);else if(a==s.length-1)l=Number(u.attr("order"))+n;else{var h=Number(d.attr("order"))-Number(u.attr("order"));1==h?c=!0:l=(Number(d.attr("order"))+Number(u.attr("order")))/2}return c?s.each(function(e){var t=e*n;$(this).attr("order",t),r.push({taskId:$(this).find("a").attr("taskid"),sortOrder:t})}):(i.item.attr("order",l),r.push({taskId:o,sortOrder:l})),{postValue:r,newOrderVal:l}},_changeSortOrder:function(e,t,i){var r,o,l=this.__changeTaskSortOrder(e,t,i,a.orderStep),c=[];s.CurrentSortType===n.sortType.project?(o=i.item.closest(".task-sortable-by-custom"),r=o.attr("projectid")):r=this.getProjectId();var d=h.getById(t);d.get("projectId")!==r?(c.push({fromProjectId:d.get("projectId"),toProjectId:r,sortOrder:l.newOrderVal,taskId:t}),d.set({projectId:r,sortOrder:l.newOrderVal}),this._moveProject(c,r)):(d.set("sortOrder",l.newOrderVal),y.sortProject(r,JSON.stringify(l.postValue))),this._saveTask(i.item)},_creatConfirmDragView:function(e){var t=this.ui,i=$("#task-ul-list").width(),n=$("#sub-task-list li").length||$("#switch-mode .mode-text").hasClass("show")&&!$("#taskcontent textarea").val(),s=this._getDragingTask(t),a=!!s.get("attachments"),r=!!s.get("dueDate"),o=!!s.get("location");if(t.position>=i&&n)if(a||r||o)new w({action:_.bind(this._taskToSubTask,this)});else{var l=this;setTimeout(function(){l._taskToSubTask()},0)}},_taskToSubTask:function(){var e=this.ui,t=e.index,i=e.item.find("a").attr("taskid"),n=h.getById(i),s=n.get("title"),a=n.get("content"),r=n.get("items"),o=n.get("status"),l=$("#task-ul-list ul>li.active").find("a").attr("taskid"),c=h.getById(l),d=c.get("items"),u=0,p=[],m=[],f=[];m.push({title:s,status:o}),""!==a&&m.push({title:a,status:o}),r.length&&_.each(r,function(e){m.push(e)}),_.each(d,function(e){f.push(e)}),-1==t&&(t=f.length),f.splice(t,0,m);var g=_.flatten(f);_.each(g,function(e){var t={id:ObjectId(),status:e.status,title:e.title,sortOrder:u};p.push(t),u+=1}),c.set({items:p,content:""}),c.save(),e.item.remove(),Backbone.trigger("deleteTaskByDragToSubTask",i)},_addDragHovered:function(){$("#taskcontent").addClass("task-drag-hovered")},_removeDragHovered:function(){$("#taskcontent").removeClass("task-drag-hovered")},_getDragingTask:function(e){var t=e.item.find("a").attr("taskid"),i=h.getById(t);return i},render:function(e){return this.beforeRender&&this.beforeRender(),this.renderSectionTitle(),this.renderTaskItems(e),this.hideSectionIfNoTask(),this.initDropAndSortable(),this.afterRender&&this.afterRender(),this},initDropAndSortable:function(){var e=this;setTimeout(function(){return e.canDrop?(e.initSortable(),void e.initDroppable()):void(e.canSort&&e.initSortable())},101)},renderSectionTitle:function(){var e=this._getTaskGroupCollapseStatus(this.className);if(this.title){var t='<div class="section-header transition '+e+'"><h6 class="text-secondary text-sml section-title">'+this.title+'</h6><div class="s-line"></div>';this.$el.addClass(this.className).append(t),this.$(".section-header").prepend('<i class="fake-icon-triangle-down i-4"></i><i class="fake-icon-triangle-right i-4"></i>')}this.$el.append("<ul></ul>"),"open"!=e&&(_.contains(["trash","completed","calendar"],c.readUrl().type)||(this.$("ul").hide(),this.toggleCountBadge(this.$(".section-header"))))},hideSectionIfNoTask:function(){0===this.collection.length||"hide"===this.collection.completedSectionStatus?this.$(".section-header").addClass("hide-section-header"):(this.$(".section-header").removeClass("hide-section-header"),this.$el.find(".count").text(this.collection.length))},renderTaskItems:function(e){var t=[];null==e?e=this.collection.length:0;for(var i,n=0;(i=this.collection.at(n))&&t.length<e;n++)this.isInItemCache(i.get("id"))||t.push(this.addOneRow(i));return t.push(this.getExtraTag()),this.$("ul").append(t),this.hasShowCount=this.isSectionOpen()?t.length-1:0,this.afterRenderTaskItems&&this.afterRenderTaskItems(),this},getExtraTag:function(){var e=this.getRenderItemCount(),t=this.collection.length,i=t-e;return this.$("ul").find(".extra-row").remove(),i?o.extraTag(35*i):null},renderExtraTag:function(){this.$("ul").append(this.getExtraTag())},storeTaskForBatch:function(e){var t=this;this.r=this.r||[],this.r.push(e),this.t||(this.t=setTimeout(function(){t.addTasksView(t.r),t.r=[],clearTimeout(t.t),t.t=null},50))},addTasksView:function(e){var t=e.length-this.showListOnce;t>0&&(e.length=this.showListOnce),e=_.filter(e,this.filter,this),this.sortBy&&e.sort(this.sortBy),_.each(e,function(e){this.addTaskView(e)},this),t>0&&this.renderExtraTag(),this.hideSectionIfNoTask(),this.initDropAndSortable(),this.afterAddTaskView&&this.afterAddTaskView()},addTaskView:function(e){var t=this.collection.indexOf(e),i=this.$("ul").find("li").not(".will-remove").eq(t-1);if(!(i&&!i.length&&t>0)){var n=this.addOneRow(e),s=$(n);return s.addClass(this._popViewStatus(e.get("id"))).hide(),0>=t?this.$("ul").prepend(n):i.after(n),!e.local&&e.isWillRepeat?(_this=this,setTimeout(function(){_this.showTaskItem(s)},700),e.isWillRepeat=null):this.showTaskItem(s),this}},showTaskItem:function(e){e.addClass("hide-height").show(),this.pushAnimation(function(){e.removeClass("hide-height")})},removeTaskView:function(e){var t=this,i=this.taskListItemViews[e.get("id")];i&&(this.removeRenderItemCache(e.get("id")),this.pushAnimation(function(){i.$el.addClass("hide-height")}),i.$el.addClass("will-remove"),setTimeout(function(){i.remove(),t.hideSectionIfNoTask(),t.afterRemoveTaskView&&t.afterRemoveTaskView()},300),this._saveViewStatus(i.$el,e.get("id")))},pushAnimation:function(e){s.animations=s.animations||[],s.animations.push(e),s.animationsTime||(s.animationsTime=setTimeout(function(){for(;s.animations.length;)s.animations.pop()();s.animationsTime=null},100))},_saveViewStatus:function(e,t){var i="";s.viewStatus=s.viewStatus||{},i+=e.hasClass("active")?"active ":"",i+=e.hasClass("selected")?"selected ":"",s.viewStatus[t]=i},_popViewStatus:function(e){s.viewStatus=s.viewStatus||{};var t=s.viewStatus[e];return delete s.viewStatus[e],t},addOneRow:function(e){if(this.isInItemCache(e.get("id")))return this.taskListItemViews[e.get("id")];this.$(".alert").hide();var t=new g({model:e});return this.taskListItemViews[e.get("id")]=t,this.subViews.push(t),this.addRenderItemCache(e.get("id")),t.el},onClose:function(){_.each(this.collection.models,function(e){e.off(null,null,this)}),_.each(this.subViews,function(e){e.close()}),this.remove()}})}),define("view/section/title",["require","exports","module","service/filter","view/section/base","service/sort"],function(e,t){var i=e("service/filter"),n=e("view/section/base").View,s=e("service/sort").rank;t.View=n.extend({filter:i.filter.sortTitle,drop:function(e){_.each(e,function(e){e.trigger("dropOnTitleSection")},this)},createOnEnterProperties:function(){return{}},initialize:function(e){this.events=_.extend({},n.prototype.events,this.events),this.constructor.__super__.initialize.apply(this,[e])},initProps:function(){this.sortBy=s.title,this.initDropOrSort()},initDropOrSort:function(){this.canDrop=!0,this.canSort=!1}})}),define("view/section/completed",["require","exports","module","service/filter","configs/dict","service/sort","lang/index","utils/hash","utils/string","utils/timeformat","view/section/base"],function(e,t){var i=e("service/filter"),n=e("configs/dict"),s=e("service/sort").rank,a=e("lang/index"),r=e("utils/hash"),o=e("utils/string"),l=e("utils/timeformat"),c=e("view/section/base").View;t.View=c.extend({title:a.get("completed_group"),className:"completed",filter:i.filter.completed,lastTaskGroup:!1,drop:function(e){_.each(e,function(e){r.isInCompleted()?(e.trigger("dropOnCompletedTaskGroupInCompleted",this.date),Backbone.trigger("refresh")):e.trigger("dropOnCompletedTaskGroup")},this)},createOnEnterProperties:function(){return{status:2,completedTime:l.prefMoment().format(n.format.atomTime)}},beforeRender:function(){for(;this.collection.length>5&&!r.isInCompleted();)this.collection.pop()},afterRender:function(){this.toggleCompletedSectionStatus(),this.initShowMoreCompletedView()},afterAddTaskView:function(){this.toggleCompletedSectionStatus()},afterRenderTaskItems:function(){this.showMoreCompletedViewOrNot()},showMoreCompletedViewOrNot:function(){this.showMoreView&&(5!==this.collection.length?this.showMoreView.hide():(this.$el.find("ul").append(this.showMoreView),this.showMoreView.show()))},initShowMoreCompletedView:function(){r.isInCompleted()||r.isInDateView()||r.isInAssignedMe()||(this.$el.find("ul").append("<p class='show-more'>"+a.get("show_more_tasks")+"</p>"),this.showMoreView=this.$el.find(".show-more"),this.showMoreCompletedViewOrNot())},toggleCompletedSectionStatus:function(){"hide"===this.collection.completedSectionStatus||this.collection.length<1?this.$el.hide():this.$el.show()},message:function(){this.listenTo(Backbone,"updateCompletedSectionStatus",this.afterUpdateCompletedStatus)},afterUpdateCompletedStatus:function(){this.updateCompletedStatus(),this.toggleCompletedSectionStatus(),this.hideSectionIfNoTask()},updateCompletedStatus:function(){this.collection.completedSectionStatus=this.parentView.getCompletedSectionStatus&&this.parentView.getCompletedSectionStatus()},diffFilter:function(){if(r.isInCompleted()){var e=this;this.filter=function(t){var i=t.get("completedTime")||t.get("modifiedTime");return t.get("status")>0&&o.isValidDate(i)&&l.formatToDateString(l.dateToMoment(i))==e.date}}else(r.isInToday()||r.isInWeek())&&(this.filter=i.filter.getTasksCompletedToday)},initDomAttr:function(){this.date&&this.$el.attr({date:this.date})},initialize:function(e){this.events=_.extend({},c.prototype.events,this.events),this.parentView=e.parentView,this.updateCompletedStatus(),this.title=e.date?l.formatToWeekRough(e.date):this.title,this.diffFilter(),this.constructor.__super__.initialize.apply(this,[e]),this.message()},initProps:function(){this.sortBy=s.completedTime,this.initDropOrSort(),this.initDomAttr()},initDropOrSort:function(){this.canDrop=!0,this.canSort=!1}})}),define("view/section/date-sort",["require","exports","module","view/section/base","service/sort","utils/timeformat","dao/order_by_date","utils/condition","service/project","utils/hash"],function(e,t){var i=e("view/section/base").View,n=e("service/sort").rank,s=e("utils/timeformat"),a=e("dao/order_by_date").db,r=e("utils/condition"),o=e("service/project"),l=e("utils/hash");t.View=i.extend({drop:function(e){this.sortDisabled&&_.each(e,function(e){e.dropOnTodayTomoWeekSection(this.dueDate)},this)},createOnEnterProperties:function(){return{dueDate:this.dueDate}},createOnEnterInDateGroup:function(e){var t=this.date,i={item:e.$el.attr("date",t)},n=this.$el.find("li"),s=e.$el,r=a.getGroupByGroupId(t,this.projectId);r.length&&(noMove=!0,a.changeSortOrderByDate(i,n,s,t,this.projectId,noMove))},initSortByDateGroup:function(){if(l.isInTagView()||r.isCalendarProject(this.parentView.project.get("type")))this.sortBy=n.dueDate;else{this.dateSort=!0;var e=this.projectId=o.getCurrentDateProjectId(),t=a.getTaskOrderByDate(this.date,e);this.sortBy=function(i,r){var o=n.subscribecalendar(i,r);if(0!==o)return o;if(t.length){var l=s.prefMoment(i.get("dueDate")).format("YYYYMMDD"),c=a.getTaskOrderByTaskId(i.get("id"),l,e),d=a.getTaskOrderByTaskId(r.get("id"),l,e);return n.taskGroupSortOrder(c,d,i,r)}return n.dueDate(i,r)}}},initProps:function(){this.sortDisabled=l.isInAssignedMe()||l.isInTagView(),this.initSortByDateGroup(),this.initDropOrSort(),this.initDomAttr()},initDomAttr:function(){this.el.setAttribute("date",this.date)},initDropOrSort:function(){this.sortDisabled?(this.canDrop=!0,this.canSort=!1):(this.canDrop=!1,this.canSort=!0)},initialize:function(e){}})}),define("view/section/today",["require","exports","module","service/filter","lang/index","utils/timeformat","configs/dict","view/section/date-sort"],function(e,t){var i=e("service/filter"),n=e("lang/index"),s=e("utils/timeformat"),a=e("configs/dict"),r=e("view/section/date-sort").View;t.View=r.extend({title:n.get("today_group"),className:"today task-sortable-by-date sortable",filter:i.filter.today,initialize:function(e){this.dueDate=s.prefMoment().format(a.format.dateTime),this.date=s.prefMoment().format("YYYYMMDD"),this.parentView=e.parentView,this.events=_.extend({},r.prototype.events,this.events),this.constructor.__super__.constructor.__super__.initialize.apply(this,[e])}})}),define("view/section/overdue",["require","exports","module","service/filter","lang/index","utils/timeformat","view/section/base","service/sort"],function(e,t){var i=e("service/filter"),n=e("lang/index"),s=e("utils/timeformat"),a=e("view/section/base").View,r=e("service/sort").rank;t.View=a.extend({title:n.get("overdue_group"),className:"overDue",filter:i.filter.overDue,drop:function(e){_.each(e,function(e){e.trigger("dropOnOverdueSection")},this)},createOnEnterProperties:function(){return{dueDate:s.prefMoment().subtract("days",1).format("YYYY-MM-DDT00:00:00.000ZZ")}},initialize:function(e){this.events=_.extend({},a.prototype.events,this.events),this.constructor.__super__.initialize.apply(this,[e])},initProps:function(){this.sortBy=r.dueDate,this.initDropOrSort()},initDropOrSort:function(){this.canDrop=!0,this.canSort=!1}})}),define("view/section/tomorrow",["require","exports","module","service/filter","lang/index","utils/timeformat","view/section/date-sort","service/sort","configs/dict"],function(e,t){var i=e("service/filter"),n=e("lang/index"),s=e("utils/timeformat"),a=e("view/section/date-sort").View,r=(e("service/sort").rank,e("configs/dict"));t.View=a.extend({title:n.get("tomorrow_group"),className:"tomorrow task-sortable-by-date sortable",filter:i.filter.tomorrow,initialize:function(e){var t=s.prefMoment().add("days",1);this.dueDate=t.format(r.format.dateTime),this.date=t.format("YYYYMMDD"),this.parentView=e.parentView,this.events=_.extend({},a.prototype.events,this.events),this.constructor.__super__.constructor.__super__.initialize.apply(this,[e])}})}),define("view/section/no-date",["require","exports","module","service/filter","lang/index","view/section/base","service/sort"],function(e,t){var i=e("service/filter"),n=e("lang/index"),s=e("view/section/base").View,a=e("service/sort").rank;t.View=s.extend({title:n.get("nodate_group"),className:"no-date",filter:i.filter.noDate,drop:function(e){_.each(e,function(e){e.trigger("dropOnNoDateSection")},this)},createOnEnterProperties:function(){return{dueDate:null}},initialize:function(e){this.events=_.extend({},s.prototype.events,this.events),this.constructor.__super__.initialize.apply(this,[e])},initProps:function(){this.sortBy=a.dueDate,this.initDropOrSort()},initDropOrSort:function(){this.canDrop=!0,this.canSort=!1}})}),define("view/section/priority",["require","exports","module","service/filter","lang/index","view/section/base","service/sort","configs/dict"],function(e,t){var i=e("service/filter"),n=e("lang/index"),s=e("view/section/base").View,a=e("service/sort").rank,r=e("configs/dict");t.View=s.extend({drop:function(e){_.each(e,function(e){e.trigger("dropOnPrioritySection",this.priorityValue)},this)},createOnEnterProperties:function(){return{priority:this.priorityValue}},initialize:function(e){this.initPriority(e.priorityValue),this.events=_.extend({},s.prototype.events,this.events),this.constructor.__super__.initialize.apply(this,[e])},initPriority:function(e){var t={};t[r.priorityValue.none]=function(){this.title=n.get("none_priority"),this.className="none-priority",this.filter=i.filter.noPriority,this.priorityValue=r.priorityValue.none},t[r.priorityValue.high]=function(){this.title=n.get("high_priority"),this.className="high-priority sort-high-priority-group",this.filter=i.filter.urgentPriority,this.priorityValue=r.priorityValue.high},t[r.priorityValue.medium]=function(){this.title=n.get("medium_priority"),this.className="medium-priority",this.filter=i.filter.normalPriority,this.priorityValue=r.priorityValue.medium},t[r.priorityValue.low]=function(){this.title=n.get("low_priority"),this.className="low-priority",this.filter=i.filter.lowPriority,this.priorityValue=r.priorityValue.low},t[e].call(this)},initProps:function(){this.sortBy=a.priority,this.initDropOrSort()},initDropOrSort:function(){this.canDrop=!0,this.canSort=!1}})}),define("view/section/order",["require","exports","module","service/filter","view/section/base","service/sort"],function(e,t){var i=e("service/filter"),n=e("view/section/base").View,s=e("service/sort").rank;t.View=n.extend({filter:i.filter.sortOrder,className:"sortable task-sortable-by-custom",createOnEnterProperties:function(){return{}},initialize:function(e){this.events=_.extend({},n.prototype.events,this.events),this.constructor.__super__.initialize.apply(this,[e])},initProps:function(){this.sortBy=s.sortOrder,this.initDropOrSort()},initDropOrSort:function(){this.canDrop=!1,this.canSort=!0}})}),define("view/section/project",["require","exports","module","service/filter","view/section/base","service/sort","utils/hash","utils/server"],function(e,t){var i=e("service/filter").filter,n=e("view/section/base").View,s=e("service/sort").rank,a=e("utils/hash"),r=e("utils/server");t.View=n.extend({filter:i.group,className:"sortable task-sortable-by-custom",drop:function(e){if(this.sortDisabled){var t=[],i=this.projectId;_.each(e,function(e){var n=e.get("projectId");t.push({fromProjectId:n,toProjectId:i,sortOrder:e.get("sortOrder"),taskId:e.get("id")});var s=!1;i!==n?(a.isInTagView()&&e.set({assignee:null}),e.set({projectId:i}),s=!0):e.get("isSubTask")&&(e.set({projectId:i}),s=!0),e.get("status")&&(e.set({status:0}),s=!0),s&&e.save()},this),r.batchTasksMoveToProject(JSON.stringify(t))}},createOnEnterProperties:function(){return{projectId:this.projectId}},initialize:function(e){this.projectId=e.projectId,e.collection.projectId=this.projectId,this.events=_.extend({},n.prototype.events,this.events),
this.constructor.__super__.initialize.apply(this,[e])},initProps:function(){this.sortDisabled=a.isInAssignedMe()||a.isInTagView()||a.isInToday()||a.isInProjectAll(),this.sortBy=s.sortOrder,this.initDropOrSort(),this.initDomAttr()},initDomAttr:function(){this.el.setAttribute("projectid",this.projectId)},initDropOrSort:function(){this.sortDisabled?(this.canDrop=!0,this.canSort=!1):(this.canDrop=!1,this.canSort=!0)}})}),define("view/section/next-7days",["require","exports","module","service/filter","lang/index","utils/timeformat","view/section/base","service/sort"],function(e,t){var i=e("service/filter"),n=e("lang/index"),s=e("utils/timeformat"),a=e("view/section/base").View,r=e("service/sort").rank;t.View=a.extend({title:n.get("next7days_group"),className:"next7days",filter:i.filter.next7days,drop:function(e){_.each(e,function(e){e.trigger("dropOnNext7DaysSection")},this)},createOnEnterProperties:function(e){var t=s.prefMoment().add("days",2).format("YYYY-MM-DDT00:00:00.000ZZ");return e&&(t=s.prefMoment(e.get("dueDate")).format("YYYY-MM-DDT00:00:00.000ZZ")),{dueDate:t}},initialize:function(e){this.events=_.extend({},a.prototype.events,this.events),this.constructor.__super__.initialize.apply(this,[e])},initProps:function(){this.sortBy=r.dueDate,this.initDropOrSort()},initDropOrSort:function(){this.canDrop=!0,this.canSort=!1}})}),define("view/section/later",["require","exports","module","service/filter","lang/index","utils/timeformat","view/section/base","service/sort"],function(e,t){var i=e("service/filter"),n=e("lang/index"),s=e("utils/timeformat"),a=e("view/section/base").View,r=e("service/sort").rank;t.View=a.extend({title:n.get("later_group"),className:"later",filter:i.filter.later,drop:function(e){_.each(e,function(e){e.trigger("dropOnLaterSection")},this)},createOnEnterProperties:function(){return{dueDate:s.prefMoment().add("days",8).format("YYYY-MM-DDT00:00:00.000ZZ")}},initialize:function(e){this.events=_.extend({},a.prototype.events,this.events),this.constructor.__super__.initialize.apply(this,[e])},initProps:function(){this.sortBy=r.dueDate,this.initDropOrSort()},initDropOrSort:function(){this.canDrop=!0,this.canSort=!1}})}),define("model/task-user",["require","exports","module"],function(e,t){t.Model=Backbone.Model.extend({initialize:function(){this.listenTo(Backbone,"destroy",this.remove)}})}),define("hbs!template/share_dialog",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){var n,s="";return s+="\n    <p>",(n=i.message)?n=n.call(e,{hash:{},data:t}):(n=e.message,n=typeof n===d?n.apply(e):n),s+=u(n)+"</p>\n  "}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var r,o,l,c="",d="function",u=this.escapeExpression,h=this,p=i.helperMissing;return c+='<div class="popup-header">\n    <a class="popup-close">×</a>\n    <h1 class="popup-title popup-title text-lrg text-primary">\n        ',(r=i.title)?r=r.call(t,{hash:{},data:s}):(r=t.title,r=typeof r===d?r.apply(t):r),c+=u(r)+'\n    </h1>\n</div>\n\n\n<div class="popup-body">\n  ',l={hash:{},inverse:h.noop,fn:h.program(1,a,s),data:s},r=i.ifnotequal,o=r?r.call(t,t.message,"",l):p.call(t,"ifnotequal",t.message,"",l),(o||0===o)&&(c+=o),c+='\n</div>\n\n\n<div class="popup-footer btns">\n    <button class="btn-cancel btn close-modal">',l={hash:{},data:s},c+=u((r=i.I18n,r?r.call(t,"cancel",l):p.call(t,"I18n","cancel",l)))+'</button>\n    <button class="btn-ok btn btn-primary btn-initial">',(o=i.btnOkText)?o=o.call(t,{hash:{},data:s}):(o=t.btnOkText,o=typeof o===d?o.apply(t):o),c+=u(o)+'</button>\n    <button class="btn-ok btn btn-primary disabled btn-loading">',(o=i.btnOkText)?o=o.call(t,{hash:{},data:s}):(o=t.btnOkText,o=typeof o===d?o.apply(t):o),c+=u(o)+"...</button>\n</div>\n"})}),define("view/project/share/dialog",["require","exports","module","utils/server","utils/log","modules/popup/popup","hbs!template/share_dialog"],function(e,t){var i=(e("utils/server"),e("utils/log"),e("modules/popup/popup").View);t.View=Backbone.View.extend({id:"share-dialog",template:e("hbs!template/share_dialog"),events:{"click .btn-ok":"doOk","click .btn-cancel":"doCancel","click .popup-close":"closeDialog"},initialize:function(e){this.initData(e),this.render(),this.initDomAttr()},initData:function(e){_.extend(this,e)},initDomAttr:function(){this.$btnOk=this.$(".btn-ok")},render:function(){this.$el.html(this.template({title:this.title,message:this.message,btnOkText:this.btnOkText})),this.popupView=new i({view:this})},doOk:function(e){if(e.preventDefault(),this.btnOkCallback){var t=this;this.renderLoading(),this.btnOkCallback(function(){t.closeDialog()})}else this.closeDialog()},renderLoading:function(){this.$(".btns").addClass("ing")},closeDialog:function(){this.popupView.onRemove()},doCancel:function(e){e.preventDefault(),this.closeDialog()}})}),define("hbs!template/share_item",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){var n,s,a="";return a+='<span class="waiting text-sml">',s={hash:{},data:t},a+=k((n=i.I18n,n?n.call(e,"pending",s):y.call(e,"I18n","pending",s)))+"</span>"}function r(e,t){var n,s,a="";return a+='\n          <span class="right text-sml">',s={hash:{},data:t},a+=k((n=i.I18n,n?n.call(e,"owner",s):y.call(e,"I18n","owner",s)))+"</span>\n        "}function o(e,t){var n,s,a="";return a+="\n            ",s=i.unless.call(e,(n=e.model,null==n||n===!1?n:n.isMyself),{hash:{},inverse:w.noop,fn:w.program(6,l,t),data:t}),(s||0===s)&&(a+=s),a+="\n        "}function l(e,t){var n,s,a="";return a+="\n                ",s=i["if"].call(e,(n=e.model,null==n||n===!1?n:n.isProjectShare),{hash:{},inverse:w.noop,fn:w.program(7,c,t),data:t}),(s||0===s)&&(a+=s),a+="\n            "}function c(e,t){var n,s,a="";return a+='\n                  <a class="delete-task-share right text-sml">',s={hash:{},data:t},a+=k((n=i.I18n,n?n.call(e,"delete",s):y.call(e,"I18n","delete",s)))+"</a>\n                "}function d(e,t){var n,s,a="";return a+='\n            <p class="text-primary">\n                ',s=i["if"].call(e,(n=e.model,null==n||n===!1?n:n.isMyself),{hash:{},inverse:w.program(12,h,t),fn:w.program(10,u,t),data:t}),(s||0===s)&&(a+=s),a+='\n            </p>\n            <span class="text-secondary text-sml"> '+k((n=e.model,n=null==n||n===!1?n:n.username,typeof n===b?n.apply(e):n))+" </span>\n        "}function u(e,t){var n,s,a="";return a+="\n                    ",s={hash:{},data:t},a+=k((n=i.I18n,n?n.call(e,"me",s):y.call(e,"I18n","me",s)))+"\n                "}function h(e,t){var i,n="";return n+="\n                    "+k((i=e.model,i=null==i||i===!1?i:i.nickname,typeof i===b?i.apply(e):i))+"\n                "}function p(e,t){var i,n="";return n+='\n            <p class="text-primary v-center">\n                '+k((i=e.model,i=null==i||i===!1?i:i.username,typeof i===b?i.apply(e):i))+"\n            </p>\n        "}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var m,f,g,v="",y=i.helperMissing,k=this.escapeExpression,w=this,b="function";return v+='<img class="avatar" src=',g={hash:{},data:s},m=i.getUserAvatar,f=m?m.call(t,(m=t.model,null==m||m===!1?m:m.avatarUrl),g):y.call(t,"getUserAvatar",(m=t.model,null==m||m===!1?m:m.avatarUrl),g),(f||0===f)&&(v+=f),v+=' />\n\n<div class="display-name">\n\n    <div class="action">\n        ',f=i.unless.call(t,(m=t.model,null==m||m===!1?m:m.isAccept),{hash:{},inverse:w.noop,fn:w.program(1,a,s),data:s}),(f||0===f)&&(v+=f),v+="\n\n        ",f=i["if"].call(t,(m=t.model,null==m||m===!1?m:m.isOwner),{hash:{},inverse:w.program(5,o,s),fn:w.program(3,r,s),data:s}),(f||0===f)&&(v+=f),v+='\n    </div>\n\n    <div class="display">\n        ',f=i["if"].call(t,(m=t.model,null==m||m===!1?m:m.nickname),{hash:{},inverse:w.program(14,p,s),fn:w.program(9,d,s),data:s}),(f||0===f)&&(v+=f),v+='\n    </div>\n\n</div>\n\n\n<div class="bd-divider divider"></div>\n'})}),define("view/project/share/item",["require","exports","module","lang/index","dao/projectdb","dao/taskdb","utils/server","utils/log","view/project/share/dialog","utils/analytics","hbs!template/share_item"],function(e,t){var i=e("lang/index"),n=e("dao/projectdb").db,s=e("dao/taskdb").db,a=e("utils/server"),r=e("utils/log"),o=e("view/project/share/dialog").View,l=e("utils/analytics");t.View=Backbone.View.extend({tagName:"li",className:"share-item",template:e("hbs!template/share_item"),events:{"click .delete-task-share":"deleteSharedUser"},messages:function(){this.listenTo(this.model,"destroy",this.out)},initialize:function(e){this.initDate(e),this.render(),this.addAcceptClass(),this.messages()},initDate:function(e){_.extend(this,e)},addAcceptClass:function(){this.model.get("isAccept")&&!this.model.get("isOwner")&&this.$el.addClass("accept")},resetProjectUserCount:function(){var e=this.model.get("isAccept")?!0:!1;this.projectModel&&this.projectModel.get("userCount")>1&&e&&this.projectModel.set("userCount",this.projectModel.get("userCount")-1)},resetProjectAssignment:function(){var e=s.getTasksByAssignee(this.model.get("userId"),this.projectModel.get("id")),t=[];this.projectModel&&1===this.projectModel.get("userCount")&&(e=s.getTasksAssigned(this.projectModel.get("id"))),_.each(e,function(e){t.push({projectId:e.get("projectId"),taskId:e.get("id"),assignee:-1}),e.set("assignee",-1)}),t.length>0&&a.assign(JSON.stringify(t),function(e){_.isEmpty(e.id2error)||r.log(e.id2error)})},deleteSharedUser:function(){var e=this;e.deleteDialogView&&e.deleteDialogView.closeDialog(),e.deleteDialogView=new o({title:i.get("share_remove"),message:i.get("share_remove_confirm_message",e.model.get("displayName")||e.model.get("username")),btnOkText:i.get("remove"),btnOkCallback:function(t){e.deleteShareUserAction(function(){t&&t()})}})},deleteShareUserAction:function(e){var t=this;a.stopProjectShare(this.projectModel.get("id"),this.model.get("recordId"),function(){t.resetProjectUserCount(),t.resetProjectAssignment();var i=t.model.get("isMyself");i&&n.refresh(),t.sharedUsers.remove(t.model),t.model.trigger("destroy"),e&&e()})},render:function(){this.$el.html(this.template({model:this.model.toJSON()}))},out:function(){this.$el.css("background-color","#F8F9FC");var e=this,t=setTimeout(function(){e.$el.fadeOut(500,function(){e.remove(),clearTimeout(t)})},100);l.l_share("remove")}})}),define("dao/userPublicProfiledb",["require","exports","module","utils/server","offline/storage","configs/dict"],function(e,t,i){var n=e("utils/server"),s=e("offline/storage"),a=e("configs/dict");t.db={userPublicProfileLocal:s.getStoreInfo(a.userPublicProfile.storePath,"json")||{},getUserPublicProfiles:function(e,t){if(!e||!e.length)return[];for(var i=[],n=[],s=!1,a=0;a<e.length;a++){var r=this.userPublicProfileLocal[e[a]];r?i.push(r):(s=!0,n.push(e[a]))}if(s){var o=this;this._getUserPublicProfileFromServer(n,function(){t&&t(o._getUserPublicProfileFromLocal(e))})}else t&&t(i)},_getUserPublicProfileFromLocal:function(e){for(var t=[],i=0;i<e.length;i++){var n=this.userPublicProfileLocal[e[i]];n&&t.push(n)}return t},_getUserPublicProfileFromServer:function(e,t){var i=20,s=[],a=[];e.length<i?a=e:(a=e.slice(0,i),s=e.slice(i,e.length));var r=this;n.getPublicProfile(JSON.stringify(a),function(e){r._storeUserPublicProfileToLocal(e),s.length?r._getUserPublicProfileFromServer(s,t):t&&t()})},_storeUserPublicProfileToLocal:function(e){for(var t=0;t<e.length;t++)this.userPublicProfileLocal[e[t].userCode]=e[t];s.setStoreInfo(a.userPublicProfile.storePath,JSON.stringify(this.userPublicProfileLocal))}}}),define("view/project/share/upgrade-tip",["require","exports","module","lang/index","utils/server","view/modal/get-upgrade","view/tip"],function(e,t){var i=e("lang/index"),n=e("utils/server"),s=e("view/modal/get-upgrade").View,a=e("view/tip").View;t.upgradeTip={showUpgradeView:function(e,t,n){var a={proLimit:e,type:"share"};e||(t.get("isOwner")?_.extend(a,{isOwner:!0,shareLimitText:i.get("get_upgrade_limited_sharing_owner").replace(/\%s1/,1)}):_.extend(a,{isOwner:!1,shareLimitText:i.get("get_upgrade_limited_sharing_other").replace(/\%s1/,1).replace(/\%s2/,this.getProjectOwnUsername(n)),action:_.bind(this.remindOwnerUpgrade,this,t),owner:this.getProjectOwnUsername(n)})),this.getUpgradeView=new s(a)},remindOwnerUpgrade:function(e){n.remindOwnerUpgrade(e.get("id"),function(){this.getUpgradeView&&this.getUpgradeView.remove(),new a({text:i.get("after_remind_owner_upgrade")})})},getProjectOwnUsername:function(e){var t="";return e.map(function(e){e.get("isOwner")&&(t=e.get("nickname")||e.get("username"))}),t}}}),define("hbs!template/share_list",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o,l="",c=i.helperMissing,d=this.escapeExpression,u="function";return l+='<div class="wrap">\n  <ul class="share-user-list antiscroll-inner">\n  </ul>\n</div>\n\n\n<div class="form-share-input">\n\n    <div class="loading"></div>\n\n    <input type="text"\n           disableautocomplete\n           autocomplete="off"\n           class="create typeahead"\n           data-provide=\'typeahead\'\n           id="ipt-share"\n           placeholder="',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"recipient_email",o):c.call(t,"I18n","recipient_email",o)))+'"\n        />\n\n    ',(r=i.renderLoading)?r=r.call(t,{hash:{},data:s}):(r=t.renderLoading,r=typeof r===u?r.apply(t):r),(r||0===r)&&(l+=r),l+='\n\n    <p class="warn text-alert"></p>\n\n</div>\n'})}),define("view/project/share/list",["require","exports","module","configs/settings","lang/index","utils/server","utils/string","service/sort","model/task-user","view/project/share/item","dao/userPublicProfiledb","utils/analytics","view/project/share/upgrade-tip","configs/keycode","hbs!template/share_list"],function(e,t){var i=e("configs/settings"),n=e("lang/index"),s=e("utils/server"),a=e("utils/string"),r=e("service/sort").rank,o=e("model/task-user").Model,l=e("view/project/share/item").View,c=e("dao/userPublicProfiledb").db,d=e("utils/analytics"),u=e("view/project/share/upgrade-tip").upgradeTip,h=e("configs/keycode");t.View=Backbone.View.extend({template:e("hbs!template/share_list"),events:{"keydown #ipt-share":"shareUserByEnter","focus #ipt-share":"resetError"},messages:function(){this.listenTo(this.sharedUsers,"add",this.onSharedUsersAdd)},initDomAttr:function(){this.$sharedUserList=this.$(".share-user-list"),this.$shareInput=this.$("#ipt-share"),this.$warn=this.$(".warn"),this.$loading=this.$(".loading"),this.$inputForm=this.$(".form-share-input")},initialize:function(e){this.initDate(e),this.render(),this.initDomAttr(),this.renderSharedUserList(),this.renderShareForm(),this.messages(),this.renderScroll()},initDate:function(e){_.extend(this,e)},renderSharedUserList:function(){this.$loading.hide();var e=this;this.sharedUsers.comparator=r.sharedUsers,this.sharedUsers.sort(),this.sharedUsers.each(function(t){e.renderSharedUserItem(t)})},buildShareItemView:function(e){var t="shareItemView"+e.cid;return this.subViews[t]=new l({model:e,projectModel:this.model,sharedUsers:this.sharedUsers}),this.subViews[t]},renderScroll:function(){this.$sharedUserList.parent().antiscroll()},renderSharedUserItem:function(e){var t=this.buildShareItemView(e);this.$sharedUserList.append(t.$el)},renderNewSharedUserItem:function(e){var t=this.buildShareItemView(e);this.sharedUsers.at(1).get("isMyself")?this.$sharedUserList.find("li:nth-child(2)").after(t.$el):this.$sharedUserList.find("li:first-child").after(t.$el)},renderShareForm:function(e){var t=this;t.getShareContacts(function(e){t.contacts=e,t.renderAutoComplete(),t.$shareInput.focus()})},generateSharedUserModel:function(e,t){var i=new o({recordId:e.recordId,username:e.email,isProjectShare:!0,projectId:this.model.id,isMyself:!1,isOwner:!1});return null===e.userCode?(i.set("displayName",e.email),t&&t(i)):void c.getUserPublicProfiles([e.userCode],function(e){return i.set("displayName",e[0].displayName||""),i.set("avatarUrl",e[0].avatarUrl||""),t&&t(i)})},createShareUser:function(e){var t=this;this.showLoading(),s.postProjectShare(this.model.id,JSON.stringify({toUsername:e}),function(i){t.afterCreateShareUser(i,e),t.hideLoading()},function(e){var i=$.parseJSON(e.responseText);"exceed_max_share_limit"===i.errorCode?u.showUpgradeView(!1,t.model,t.sharedUsers):"exceed_pro_max_share_limit"===i.errorCode&&u.showUpgradeView(!0,t.model,t.sharedUsers),t.hideLoading()})},showLoading:function(){this.$inputForm.addClass("loading")},hideLoading:function(){this.$inputForm.removeClass("loading")},afterCreateShareUser:function(e,t){var i={recordId:e.recordId,email:t,userCode:e.toUserCode},n=this;this.generateSharedUserModel(i,function(e){n.sharedUsers.add(e),n.resetShareInput()})},resetShareInput:function(){this.$shareInput.val("")},getInputShare:function(){var e=this.$shareInput.val().toLowerCase();return $.trim(e)},shareUserByEnter:function(e){e=e||window.event;var t=this.getInputShare();e.keyCode==h.enter&&""!=t?(e.preventDefault(),this.shareUser(t)):this.resetError()},shareUser:function(e){this.checkEmail(e)&&(this.createShareUser(e),d.l_share("invite_email"))},checkEmail:function(e){if(""===e)return this.error(n.get("nothing_error_me")),!1;if(a.isValidMail(e)){var t=this.sharedUsers.findWhere({username:e});if(!t)return!0;this.showError(n.get("share_note_exist"))}else this.showError(n.get("sign_invalid_email"));return!1},showError:function(e){this.$warn.text(e).slideDown()},resetError:function(){this.$warn.slideUp()},onSharedUsersAdd:function(e){this.renderNewSharedUserItem(e),this.renderScroll()},render:function(){this.$el.html(this.template({name:this.model.get("name")}))},onClose:function(){},renderAutoComplete:function(){var e=this;this.$shareInput.typeahead({source:this.contacts,matcher:function(t){var i=_.pluck(e.sharedUsers.toJSON(),"username");return~i.indexOf(t.email.toLowerCase())?!1:t.email.toLowerCase().match(this.query.toLowerCase())||t.nickname&&t.nickname.toLowerCase().match(this.query.toLowerCase())?!0:!1},sorter:function(e){return e.sort(function(e,t){return e.lstTime<t.lstTime})},item:function(e){e.nickname=e.nickname,e.email=e.email;var t='<li class="share-item"><a></a><div class="bd-divider divider"></div>';return t},highlighter:function(e){var t=/[\-\[\]{}()*+?.,\\\^$|#\s]/g,n=this.query.replace(t,"\\$&"),s=e.nickname||"",a=e.email,r=new RegExp("("+n+")","ig");s=s.replace(r,function(e,t){return"<strong>"+t+"</strong>"}),a=a.replace(r,function(e,t){return"<strong>"+t+"</strong>"});var o=e.avatarUrl||i.defaultAvatar,l=[];return l.push('<div class="avatar">'),l.push('<img src="'+o+'"/>'),l.push("</div>"),l.push('<div class="display">'),s?(l.push('<p class="text-primary">'+s+"</p>"),l.push('<span class="text-secondary text-sml">'+a+"</span>")):l.push('<p class="text-primary">'+a+"</p>"),l.push("</div>"),l.join("")},setMenuPos:function(){{var t=this.$element.position();({top:t.top,left:0,width:this.$element.outerWidth()})}e.$shareInput.after(this.$menu)},select:function(){if(!event||event.keyCode!==h.tab){var t=this.getActiveItem();e.shareUser(t.email),this.hide(),d.l_share("invite_recent")}}})},getUserProfiles:function(e,t){var i=_.compact(_.pluck(e,"userCode"));c.getUserPublicProfiles(i,function(i){var n={};_.each(i,function(e){n[e.userCode]=e}),_.map(e,function(e){var t=n[e.userCode];return t?(e.nickname=t.nickname,e.avatarUrl=t.avatarUrl,e):void 0}),t&&t(e)})},getShareContacts:function(e){var t=this;s.getShareContacts(function(i){t.handleContacts(i,e)})},handleContacts:function(e,t){var i=_.uniq(e.contacts,!1,function(e){return e.email});this.getUserProfiles(i,function(e){t&&t(e)})}})}),define("hbs!template/share_link",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o="",l=i.helperMissing,c=this.escapeExpression;return o+='<p class="share-description line-sml">\n    ',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"shared_link_introduce",r):l.call(t,"I18n","shared_link_introduce",r)))+'\n</p>\n\n<input class="invite-url text-secondary text-sml" readonly="readonly" />\n\n<a class="text-sml invite-action line-sml">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"shared_link_generate",r):l.call(t,"I18n","shared_link_generate",r)))+"</a>\n"})}),define("view/project/share/link",["require","exports","module","utils/server","utils/log","configs/settings","lang/index","utils/dom","utils/browser","utils/analytics","view/project/share/dialog","hbs!template/share_link"],function(e,t){var i=e("utils/server"),n=(e("utils/log"),e("configs/settings")),s=e("lang/index"),a=e("utils/dom"),r=(e("utils/browser"),e("utils/analytics")),o=e("view/project/share/dialog").View;t.View=Backbone.View.extend({className:"share-link-section",template:e("hbs!template/share_link"),events:{"click .invite-url":"selectInviteUrl","click .invite-action":"onClickActionBtn"},messages:function(){this.listenTo(this.model,"change:inviteUrl",this.renderLinkView)},initDomAttr:function(){this.$inviteUrlInput=this.$(".invite-url"),this.$inviteAction=this.$(".invite-action")},initialize:function(){this.render(),this.initDomAttr(),this.renderLinkView(),this.messages()},render:function(){this.$el.html(this.template())},renderLinkView:function(){this.isOpenInviteUrl()?this.renderOpenedView(this.model.get("inviteUrl")):this.renderClosedView()},getInviteProjectCollaboration:function(){var e=this;i.getInviteProjectCollaboration(e.model.get("id"),function(t){e.model.set("inviteUrl",t.inviteUrl)})},selectInviteUrl:function(){this.$inviteUrlInput.focus().select()},renderOpenedView:function(e){e=n.protocol+n.domain+e,this.$inviteUrlInput.show().val(e),this.renderActionBtnValue(s.get("stop"))},isOpenInviteUrl:function(){return this.model.get("inviteUrl")?!0:!1},renderClosedView:function(){this.$inviteUrlInput.hide(),this.renderActionBtnValue(s.get("shared_link_generate"))},renderActionBtnValue:function(e){this.$inviteAction.html(e)},onClickActionBtn:function(e){this.isOpenInviteUrl()?this.closeShareLink():this.generateShareLink()},generateShareLink:function(){var e=this;i.postInviteProjectCollaboration(this.model.get("id"),function(t){t.inviteUrl&&e.model.set("inviteUrl",t.inviteUrl)},function(t){var i=$.parseJSON(t.responseText);(i.errorCode="invite_project_exist")?e.getInviteProjectCollaboration():a.showStatus(s.get("error_unknow_server"),5e3)}),r.l_share("enable_link")},closeShareLink:function(){{var e=this;new o({title:s.get("close_link"),message:s.get("close_link_warning_message"),btnOkText:s.get("close_link"),btnOkCallback:function(t){i.deleteInviteProjectCollaboration(e.model.get("id"),function(){e.model.set("inviteUrl",""),r.l_share("disable_link")}),t&&t()}})}}})}),define("hbs!template/share_index",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o,l="",c=i.helperMissing,d=this.escapeExpression,u="function";return l+='<div class="popup-header">\n  <a class="popup-close">&times;</a>\n  <h1 class="popup-title text-lrg text-primary">\n    <span>\n    ',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"share_project_list",o):c.call(t,"I18n","share_project_list",o)))+'\n    </span>\n    <span>"',(r=i.name)?r=r.call(t,{hash:{},data:s}):(r=t.name,r=typeof r===u?r.apply(t):r),l+=d(r)+'"</span>\n  </h1>\n</div>\n\n<div class="popup-body">\n    <div class="share-list-section"></div>\n    <div class="bd-divider divider"></div>\n    <div class="share-link-section"></div>\n</div>\n'})}),define("view/project/share/index",["require","exports","module","view/project/share/list","view/project/share/link","view/modal/verify-email","model/task-user","utils/server","utils/log","utils/dom","lang/index","dao/userPublicProfiledb","service/userProfile","modules/popup/popup","hbs!template/share_index"],function(e,t){var i=e("view/project/share/list").View,n=e("view/project/share/link").View,s=e("view/modal/verify-email").View,a=e("model/task-user").Model,r=e("utils/server"),o=(e("utils/log"),e("utils/dom")),l=e("lang/index"),c=e("dao/userPublicProfiledb").db,d=e("service/userProfile"),u=e("modules/popup/popup").View;t.View=Backbone.View.extend({id:"project-share-view",template:e("hbs!template/share_index"),sharedUsers:new Backbone.Collection([],{model:a}),events:{"click .popup-close":"onClose"},messages:function(){},initialize:function(){this.messages(),this.render(),this.initDomAttr(),this.initList(),this.initLink()},initDomAttr:function(){this.$shareList=this.$(".share-list-section"),this.$shareLink=this.$(".share-link-section")},removeLoading:function(){this.$("#loading").remove()},renderVerifyEmailView:function(){new s},getCurrentUserObject:function(){return{username:d.get("username"),userCode:d.get("userCode"),isOwner:!0,isAccept:!0,isMyself:!0,projectId:this.model.id,avatarUrl:d.get("picture")}},getUserProfile:function(e){var t=this,i=_.compact(t.sharedUsers.pluck("userCode"));c.getUserPublicProfiles(i,function(i){_.each(i,function(e){t.sharedUsers.findWhere({userCode:e.userCode}).set("nickname",e.nickname||"").set("isMyself",e.isMyself||!1)}),e&&e()})},getSharedUsers:function(e){var t=this;r.getProjectShareUsers(this.model.id,function(i){t.getSharedUsersSuccess(i,e)},function(e){t.getSharedUsersFail(e)})},getSharedUsersSuccess:function(e,t){e.length<=1?this.sharedUsers.set([this.getCurrentUserObject()],{silent:!0}):(e=_.map(e,function(e){return e.projectId=this.model.get("id"),e.nickname=e.displayName,e},this),this.sharedUsers.set(e,{silent:!0})),this.getUserProfile(function(){t&&t()})},getSharedUsersFail:function(e){if(this.onClose(),0===e.status)return void o.showStatus(l.get("error_network_connection"),5e3);var t=$.parseJSON(e.responseText);"user_email_not_verified"==t.errorCode?this.renderVerifyEmailView():o.showStatus(l.get("error_unknow_server"),5e3)},getInviteProjectCollaboration:function(e){var t=this;r.getInviteProjectCollaboration(t.model.get("id"),function(i){t.model.set("inviteUrl",i.inviteUrl),e&&e()})},render:function(){this.$el.html(this.template({name:this.model.get("name")})),this.popupView=new u({view:this})},initList:function(){var e=this;this.getSharedUsers(function(){e.renderList()})},renderList:function(){var e=new i({model:this.model,sharedUsers:this.sharedUsers});this.$shareList.append(e.$el)},initLink:function(){var e=this;this.getInviteProjectCollaboration(function(){e.renderLink()})},renderLink:function(){var e=new n({model:this.model});this.$shareLink.append(e.$el)},onClose:function(){this.popupView&&this.popupView.onRemove()}})}),define("model/project-activity",["require","exports","module"],function(e,t){t.Model=Backbone.Model.extend({})}),define("collection/project-activity",["require","exports","module","utils/timeformat","model/project-activity"],function(e,t){var i=e("utils/timeformat");t.Collection=Backbone.Collection.extend({model:e("model/project-activity").Model,comparator:function(e,t){var n=i.prefMoment(e.get("when")).unix(),s=i.prefMoment(t.get("when")).unix();return n==s?e.get("id")<t.get("id")?1:-1:s-n}})}),define("dao/project-activitydb",["require","exports","module","collection/project-activity","configs/settings"],function(e,t){var i=e("collection/project-activity").Collection,n=e("configs/settings");t.db={collectiondb:{},taskTitles:{},getActivityById:function(e,t,i,s){var a=this.getCollectionById(e);if(t){a.url=n.API_HOST_V1+"/project/"+e+"/activity";{var r=this;a.length}a.fetch({success:function(t){r.afterFetchCollection(e,t),i&&i.apply(s,[t])},error:function(){i&&i.apply(s,[a])}})}else i&&i.apply(s,[a]);return a},afterFetchCollection:function(e,t){var i=this;_.each(t.models,function(e){var t=e.get("taskIds"),n=e.get("description");n&&t&&_.each(t,function(e){i.taskTitles[e]||(i.taskTitles[e]=n)})}),e==Appest.user.inboxId&&(t.pop(),t.pop())},initCollection:function(e,t){var n=new i(t);return this.setCollection(e,n),n},getCollectionById:function(e){var t=this.collectiondb[e];return(!t||_.isEmpty(t))&&(t=this.initCollection(e)),t},setCollection:function(e,t){this.collectiondb[e]=t},getTaskTitle:function(e){return this.taskTitles[e]}}}),define("hbs!template/activity_project_item",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o="",l="function",c=this.escapeExpression,d=i.helperMissing;return o+='<div class="activity">\n  \n  <div class="sum">\n      <span class="',(a=i.hintClass)?a=a.call(t,{hash:{},data:s}):(a=t.hintClass,a=typeof a===l?a.apply(t):a),o+=c(a)+'"><i></i></span>\n      <span class="creator">',(a=i.creator)?a=a.call(t,{hash:{},data:s}):(a=t.creator,a=typeof a===l?a.apply(t):a),o+=c(a)+'</span>\n      <span class="action text-secondary">',(a=i.action)?a=a.call(t,{hash:{},data:s}):(a=t.action,a=typeof a===l?a.apply(t):a),o+=c(a)+'</span>\n      <span class="text-secondary">',(a=i.task)?a=a.call(t,{hash:{},data:s}):(a=t.task,a=typeof a===l?a.apply(t):a),(a||0===a)&&(o+=a),o+='</span>\n      <span class="time text-info text-sml">',(a=i.time)?a=a.call(t,{hash:{},data:s}):(a=t.time,a=typeof a===l?a.apply(t):a),o+=c(a)+'</span>\n  </div>\n\n  <p class="detail text-secondary">',(a=i.detail)?a=a.call(t,{hash:{},data:s}):(a=t.detail,a=typeof a===l?a.apply(t):a),o+=c(a)+'</p>\n  <p class="action-btn expand text-link hide">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"expand",r):d.call(t,"I18n","expand",r)))+'</p>\n  <p class="action-btn collapse text-link hide">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"collapse",r):d.call(t,"I18n","collapse",r)))+"</p>\n\n</div>"})}),define("view/project/activity/item",["require","exports","module","dao/taskdb","utils/timeformat","service/prefs","lang/index","utils/index","service/userProfile","utils/hash","dao/project-activitydb","utils/string","view/tip","hbs!template/activity_project_item"],function(e,t){{var i=e("dao/taskdb").db,n=e("utils/timeformat"),s=(e("service/prefs"),e("lang/index")),a=(e("utils/index"),e("service/userProfile")),r=(e("utils/hash"),e("dao/project-activitydb").db),o=e("utils/string");e("view/tip").View}t.View=Backbone.View.extend({tagName:"li",template:e("hbs!template/activity_project_item"),actionType:{P_CREATE:s.get("activity_created_list"),P_TITLE:s.get("activity_edited_list_title"),P_DELETE:s.get("activity_deleted_list"),P_SHARE_JOIN:s.get("activity_joined_list"),P_SHARE_DELETE:s.get("activity_quitted_list"),P_IN:s.get("activity_moved_task_in"),P_OUT:s.get("activity_moved_task_out"),T_CREATE:s.get("activity_created_task"),T_DELETE:s.get("activity_deleted_task"),T_DONE:s.get("activity_completed_task"),T_UNDONE:s.get("activity_undone_task"),T_ASSIGN:s.get("activity_assigned_task"),T_DUE:s.get("activity_changed_task_duedate"),T_TITLE:s.get("activity_edited_task_title"),T_CONTENT:s.get("activity_edited_task_content"),T_TRASH_BACK:s.get("activity_undeleted_task"),T_REPEAT:s.get("activity_completed_task")},events:{"click a.goto_task":"navigateTask"},maxLine:3,initialize:function(e){this.model=e.model,this.projectId=e.projectId,this.render()},render:function(){var e=this.format();return this.$el.html(this.template(e)),this},format:function(){var e={hintClass:this.getHint(),creator:this.getCreator(),action:this.getAction(),task:this.getTask(),time:this.getTime(),detail:this.getDetail()};return e},getHint:function(){var e=this.model.get("action");return e=e.toLowerCase().replace(/t_/i,"").replace(/p_/i,"").replace("_","-"),e="repeat"==e?"done":e},getCreator:function(){return this._getDisplayName(this.model.get("whoProfile"))},getAction:function(){var e=this.model.get("action");return this.actionType[e]},getTime:function(){var e=this.model.get("when");return this.date=n.formatToDateString(n.getDueDateLocalZoneDate(e)),n.formatActivityTime(e)},getDetail:function(){var e=this.model.get("action"),t="";if("T_DUE"===e){var i=this.model.get("dueDate");t=i?s.get("activity_task_duedate").replace("%s1",n.formatDueDate(i)):s.get("activity_task_duedate_clear")}else"T_CONTENT"===e&&(t=this.model.get("content"));return t?t:""},_getDisplayName:function(e){if(!e)return"";var t=e.isMyself,i="";return i=t?a.get("name"):e.name?e.name:e.username},getTask:function(){
var e=this.model.get("taskId"),t=this.model.get("action"),n="";if(e){var a=i.getById(e),l=a?o.encodeHTML(o.cut20(a.get("title"))):r.getTaskTitle(e)?o.encodeHTML(r.getTaskTitle(e)):'<a class="pop_unknow_task">'+s.get("unknow_task")+"</a>";return 0==$.trim(l).length&&(l=s.get("notitle_task")),t.match(/'T_DELETE'|'P_OUT'/)?l:n=a&&!a.get("deleted")&&this.projectId==a.get("projectId")?'<a class="goto_task" href="#p/'+this.projectId+"/tasks/"+e+'">'+l+"</a>":l}},navigateTask:function(e){e.preventDefault(),e.stopPropagation();var t=e.target.hash,i=t.split("/").pop();Backbone.trigger("showTaskUnderProject",this.projectId,"tasks",i)}})}),define("hbs!template/activity_project_list",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o,l="",c=i.helperMissing,d=this.escapeExpression,u="function";return l+='<div class="td-header n-b">\n	<div class="td-bar text-med">\n		',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"project_activity",o):c.call(t,"I18n","project_activity",o)))+'		\n	</div>\n</div>\n\n<div class="body td-body b-h can-select antiscroll-inner dropdown">\n	<div class="right-section">\n		<ul class="t-activity" id="project-activity-list"></ul>\n		<p class="show-more show-more-p-activity">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"show_more_tasks",o):c.call(t,"I18n","show_more_tasks",o)))+'</p>\n		<div class="dropdown-menu dropdown-center tip-transition">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"what_is_unknow_task",o):c.call(t,"I18n","what_is_unknow_task",o)))+'</div>\n	</div>\n	<div class="loading">\n		',(r=i.renderLoading)?r=r.call(t,{hash:{},data:s}):(r=t.renderLoading,r=typeof r===u?r.apply(t):r),(r||0===r)&&(l+=r),l+='\n	</div>\n	<div class="empty empty-list-info">\n		',o={hash:{},data:s},a=i.renderCustomEmpty,r=a?a.call(t,"icon-empty-project-activity","activity_empty","activity_empty_desc",o):c.call(t,"renderCustomEmpty","icon-empty-project-activity","activity_empty","activity_empty_desc",o),(r||0===r)&&(l+=r),l+="\n	</div>\n</div>\n\n"})}),define("view/project/activity/list",["require","exports","module","utils/dom","utils/server","view/project/activity/item","dao/project-activitydb","utils/timeformat","hbs!template/activity_project_list"],function(e,t){var i=(e("utils/dom"),e("utils/server"),e("view/project/activity/item").View),n=e("dao/project-activitydb").db,s=e("utils/timeformat");t.View=Backbone.View.extend({id:"project-activity-view",className:"b-h",template:e("hbs!template/activity_project_list"),events:{"click .show-more-p-activity":"showMoreView","click a.pop_unknow_task":"popUnknowTask"},listCount:20,messages:function(){},initialize:function(e){this.model=e.model,this.initProps(),this.beforeRender(),this.getActivity(),this.localRender(),this.initScroll(),this.messages(),this.initExtEvent()},initProps:function(){this.isDropdownShow=!1},beforeRender:function(){this.$el.html(this.template()),this.initDom()},initDom:function(){$("#detail-view").empty().append(this.$el),this.$list=this.$("#project-activity-list"),this.$scroll=this.$(".antiscroll-inner"),this.$dropdown=this.$(".dropdown"),this.$(".show-more").hide(),this.$(".empty").hide(),this.$(".loading").show()},initScroll:function(){var e=this;this.$scroll.on("scrollstart",function(){e.doScrollStart()}).on("scrollstop",function(){e.doScrollStop()})},doScrollStart:function(){this.$el.addClass("scrolling")},doScrollStop:function(){0===this.$scroll.scrollTop()&&this.$el.removeClass("scrolling")},initExtEvent:function(){var e=this;$("body").on("click",function(){e.hideUnknowTask()})},afterRender:function(){this.$(".loading").hide()},getActivity:function(){var e=this.model.get("id");this.collection=n.getActivityById(e,!0,this.renderActivity,this),this.projectId=e},localRender:function(){if(0!=this.collection.length){var e=this;this.sectionView={},this.$list.empty(),this.$(".empty").hide(),_.each(this.collection.models,function(t){e.initItemView(t)}),this.renderSection(),this.afterRender()}},renderActivity:function(){var e=this;this.$list.empty(),this.sectionView={},0==this.collection.length?this.$(".empty").show():(this.$(".empty").hide(),_.each(this.collection.models,function(t){e.initItemView(t)}),this.renderSection()),this.afterRender()},initItemView:function(e){var t=this;if(e.get("taskIds"))_.each(e.get("taskIds"),function(n){e.set("taskId",n);var s=new i({model:e,projectId:t.projectId});!t.sectionView[s.date]&&(t.sectionView[s.date]=[]),t.sectionView[s.date].push(s.$el)});else{var n=new i({model:e,projectId:t.projectId});!t.sectionView[n.date]&&(t.sectionView[n.date]=[]),t.sectionView[n.date].push(n.$el)}},renderSection:function(){var e=this.listCount;for(var t in this.sectionView){var i=this.sectionView[t],n=$('<div class="text-info t-section-date">'+s.formatToWeek(t)+'</div><ul class="t-section"></ul>').appendTo(this.$list);if(!(e>i.length)){n.eq("1").append(i.slice(0,e)),e=0,this.currentSection={view:n,date:t,index:e},this.showMoreBtn();break}n.eq("1").append(i),e-=i.length}},showMoreBtn:function(){this.$(".show-more").show()},hideMoreBtn:function(){this.$(".show-more").hide()},showMoreView:function(){var e=this.currentSection;for(var t in this.sectionView){var i=this.sectionView[t];if(e.date==t&&e.index<i.length)e.view.eq(1).append(i.slice(e.index));else if(e.date>t){var n=$('<div class="text-info t-section-date">'+s.formatToWeek(t)+'</div><ul class="t-section"></ul>').appendTo(this.$list);n.eq(1).append(i)}}this.hideMoreBtn()},onClose:function(){this.removeView()},removeView:function(){this.$el.remove()},popUnknowTask:function(e){e.preventDefault(),e.stopPropagation();var t=this,i=e.clientY+this.$scroll.scrollTop()+20+"px";this.isDropdownShow?(this.$dropdown.removeClass("open"),this.isDropdownShow=!1):(this.$(".dropdown-menu").css({top:i}),this.$dropdown.addClass("open"),this.isDropdownShow=!0,this.timer=setTimeout(function(){t.hideUnknowTask.apply(t)},5e3))},hideUnknowTask:function(){this.isDropdownShow&&(this.$dropdown.removeClass("open"),this.isDropdownShow=!1,_.isUndefined(this.timer)||clearTimeout(this.timer))}})}),define("utils/nlp",["require","exports","module","service/prefs","utils/string"],function(e,t){var i=(e("service/prefs"),e("utils/string")),n={"天":"daily","周":"weekly","星期":"weekly","礼拜":"weekly","个月":"monthly","月":"monthly","年":"yearly","个":"yearly",day:"daily",week:"weekly",month:"monthly",year:"yearly"},s={"一":1,"二":2,"三":3,"四":4,"五":5,"六":6,"七":7,"八":8,"九":9,"日":0,"天":0,"两":2},a={"早上":7,"上午":9,"中午":12,"下午":15,"傍晚":17,"晚上":20,"凌晨":0,"午夜":0,"半夜":2,morning:7,afternoon:15,evening:20,midnight:0,noon:12,night:20,tonight:20},r={su:0,mo:1,tu:2,we:3,th:4,fr:5,sa:6},o={jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12},l=function(e){var t=/(([一二三两])百)?(([二三四五六七八九])?十)?([一二三四五六七八九两])?/i,i=e.match(t);if(!i||!i[2]&&!i[3]&&!i[5])return null;var n=0,a=i[2]?s[i[2]]:0,r=i[4]?s[i[4]]:i[3]?1:0,o=i[5]?s[i[5]]:0;return n=100*a+10*r+o},c=function(e,t){if(e.search(/半|half\sa|half\san/i)>-1)i=.5;else if(e.search(/a|an|one/i)>-1)i=1;else{var i=parseInt(e);i=isNaN(i)?l(e,t):i}return t?t>=i?i:null:i},d=function(e){switch(e){case"分":return"M";case"分钟":return"M";case"小时":return"H";case"天":return"D";case"周":case"星期":case"礼拜":return"W"}},u=function(e){switch(e){case"M":return{unit:"M",time:0};case"H":return{unit:"M",time:30};case"D":return{unit:"H",time:12};case"W":return{unit:"D",time:3}}},h=function(e,t){for(var i,n,s=null,a=0,r=e.length;r>a;a++){n=e[a];var o=t.search(n.pattern);0>o||(null==s&&(s=o),s>=o&&(i=n,s=o))}return i},p=function(e){var t={referenceDate:new Date,text:[],index:0,start:{day:null,month:null,year:null},repeat:{},reminder:[],isAllDay:!0};return t=_.extend(t,e),new chrono.ParseResult(t)},m=function(e,t){var i=t.match(this.pattern),n=i[2]&&c(i[2]),s=i[3]&&d(i[3]),a="",r=null,o=!1;if(.5==n){var l=u(s);n=l.time,s=l.unit}return e.start.hour?s&&n&&["M","H"].indexOf(s)>-1?a="-PT":s&&n&&(a="-P"):s&&n&&["D","W"].indexOf(s)>-1&&(a="-P",o=!0),"D"==s&&7==n&&(s="W")&&(n=1),a&&(o&&0==e.reminder.length&&e.reminder.push({id:ObjectId(),trigger:"TRIGGER:PT0S"}),r={id:ObjectId(),trigger:"TRIGGER:".concat(a.concat(n).concat(s))},e.reminder.push(r),e.text=e.text.concat(",",i[0])),e},f=function(e,t){var i=t.match(this.pattern),n=i[1]&&c(i[1]),s=i[2]&&d(i[2]);if(.5==n){var a=u(s);n=a.time,s=a.unit}var r=moment(e.startDate);return r=r.add(s.toLowerCase(),n),e.start={hour:r.hour(),minute:r.minute(),second:r.second(),day:r.date(),month:r.month(),year:r.year()},e.text=e.text.concat(",",i[0]),e=new chrono.ParseResult(e)},g=function(e,t){var i=t.match(this.pattern),n=i[5]||i[8]||i[11];n=c(n);var s=i[6]||i[9]||i[12];s=s.slice(0,1).toUpperCase();var a="",r=null,o=!1;if(.5==n){var l=u(s);n=l.time,s=l.unit}return e.start.hour?s&&n&&["M","H"].indexOf(s)>-1?a="-PT":s&&n&&(a="-P"):s&&n&&["D","W"].indexOf(s)>-1&&(a="-P",o=!0),"D"==s&&7==n&&(s="W")&&(n=1),a&&(o&&0==e.reminder.length&&e.reminder.push({id:ObjectId(),trigger:"TRIGGER:PT0S"}),r={id:ObjectId(),trigger:"TRIGGER:".concat(a.concat(n).concat(s))},e.reminder.push(r),e.text=e.text.concat(",",i[0])),e},v=function(e,t){var i=t.match(this.pattern),n=i[5]||i[8]||i[11];n=c(n);var s=i[6]||i[9]||i[12];if(s=s.slice(0,1).toLowerCase(),.5==n){var a=u(s);n=a.time,s=a.unit}var r=moment(e.startDate);return r=r.add(s,n),e.start={hour:r.hour(),minute:r.minute(),second:r.second(),day:r.date(),month:r.month(),year:r.year()},e.text=e.text.concat(",",i[0]),e=new chrono.ParseResult(e)},y=function(e,t){var i=null,n=!0;e.start.hour&&(i={id:ObjectId(),trigger:"TRIGGER:PT0S"},n=!1);var s=/((提前|提早)?提醒我)|\b(remind|reminds)\s+me(\s+early|earlier)?\b/i,a=t.match(s);if(a&&a[0]){var r=a[2]||a[4];i||(i={id:ObjectId(),trigger:"TRIGGER:PT0S"}),i.trigger=r?"TRIGGER:-PT5M":i.trigger,e.text=e.text.concat(",",a[0])}i&&e.reminder.push(i),e.other.isAllDay=n},k=function(e,t){if(!t)return t;t.text=t.highlight.toString();var i=[{pattern:/(提前|提早)([0-9]{1,2}|[一二三四五六七八九十百两]{1,3}|半)(分|分钟|小时|天|周|星期|礼拜)/,parse:m},{pattern:/([0-9]{1,2}|[一二三四五六七八九十百两]{1,3}|半)(分|分钟|小时|天|周|星期|礼拜)后/,parse:f},{pattern:/\b(remind|reminds)\s+(me)\s+((([0-9]{1,2})\s*(minutes|mins|h|hours|days|weeks))|((a|half\sa|one|1)\s+(minute|min|day|week))|((an|half\san|1|one)\s+(h|hour)))\s+(early|earlier|before|in\sadvance)\b/i,parse:g},{pattern:/\b(remind|reminds)\s+(me)\s+((([0-9]{1,2})\s?(minutes|mins|h|hours|days|weeks))|((a|half\sa)\s+(minute|min|day|week))|((an|half\san)\s+(h|hour)))?\s+later\b/i,parse:v}];return y(t,e),parser=h(i,e),parser?parser.parse(t,e):t},w=function(e,t){var i=t,a=t.match(this.pattern),r=e?moment(e.startDate):moment();r=r.lang("en");var o,l=r.format("d"),d="",u=t.indexOf(a[0]),h=a[1],e=e||p({start:{day:r.date(),month:r.month(),year:r.year()}});if(t=a[0],"个工作日"==h)d="weekday",e.repeat={kind:"advanced",freq:"weekly",digit:"1",weekdays:["MO","TU","WE","TH","FR"],weekStart:0,onMonth:"week"};else if("周末"==h)d="weekend",e.repeat={kind:"advanced",freq:"weekly",digit:"1",weekdays:["SU","SA"],weekStart:0,onMonth:"week"};else{var m=a[8]||"1";if(m=c(m),!m)return null;e.repeat.freq=n[a[2]||a[4]||a[9]]||"yearly",1==m?a[2]?(d="week",o=s[a[3]],e.repeat.kind="advanced",e.repeat.digit=""+m,e.repeat.onMonth="week",e.repeat.weekStart=1):a[4]?(d="advanced",e.repeat.kind="advanced",e.repeat.digit=""+m,e.repeat.weekStart=1,e.repeat.onMonth="date",r=r.set("month",c(a[5])-1),r=r.set("date",c(a[6])),moment().diff(r)>0&&(r=r.add("year",1)),e.start={year:r.year(),month:r.month(),day:r.date()},e.highlight.pop(),e=new chrono.ParseResult(e)):a[6]?(d="advanced",e.repeat.freq="monthly",e.repeat.kind="advanced",e.repeat.digit=""+m,e.repeat.weekStart=1,e.repeat.onMonth="date",r=r.set("date",c(a[6]))):e.repeat.kind=e.repeat.freq:(e.repeat.digit=""+m,"yearly"==e.repeat.freq&&(e.repeat.freq="monthly",e.repeat.digit=""+12*m),d="advanced",e.repeat.kind="advanced",e.repeat.weekStart=0,e.repeat.onMonth=e.start.day?"date":"week")}switch(d){case"weekday":0==l&&6==l&&(r=r.day(1));break;case"weekend":0!=l&&6!=l&&(r=r.day(6));break;case"week":l!=o&&(r=r.day(o)),e.repeat.mweekdays={n:""+m,weekday:r.format("dd").toUpperCase()},e.repeat.weekdays=[r.format("dd").toUpperCase()];break;case"advanced":e.repeat.weekdays=[r.format("dd").toUpperCase()],e.repeat.monthdays=[r.date()]}return e.repeat.date=r.format("YYYY-M-D"),$(e,u,t,i),e},b=function(e,t){var i=t,n=t.match(this.pattern),s=e?moment(e.startDate):moment(),a=31,r=n[2]&&c(n[2]),o=n[1],l=t.indexOf(n[0]),e=e||p();if(t=n[0],"最后一天"==o)s=moment().endOf("M"),e.repeat={kind:"advanced",freq:"monthly",digit:"1",weekStart:0,monthdays:[-1],onMonth:"date"};else{if(a>=r)for(s.date()>r&&(s=s.add("month",1));s.daysInMonth()<r;)s=s.add("month",1);s.set("date",r),e.repeat={kind:"advanced",freq:"monthly",digit:"1",weekStart:0,monthdays:[r],onMonth:"date"}}return e.start.day||(e.start={day:s.date(),month:s.month(),year:s.year()}),e.repeat.date=s.format("YYYY-M-D"),$(e,l,t,i),new chrono.ParseResult(e)},T=function(e,t){var i=t,s=t.match(this.pattern),a=e?moment(e.startDate):moment();a=a.lang("en");var l=a.format("d"),d="",u=t.indexOf(s[0]),h=s[8]&&s[8].toLowerCase(),m=s[2]&&s[2].slice(0,3).toLowerCase(),f=s[3]&&s[3].slice(0,3).toLowerCase(),e=e||p({start:{day:a.date(),month:a.month(),year:a.year()}});if(t=s[0],"weekday"==h)d="weekday",e.repeat={kind:"advanced",freq:"weekly",digit:"1",weekdays:["MO","TU","WE","TH","FR"],weekStart:0,onMonth:"week"};else if("weekend"==h)d="weekend",e.repeat={kind:"advanced",freq:"weekly",digit:"1",weekdays:["SU","SA"],weekStart:0,onMonth:"week"};else{var g=s[9]||"1";if(g=c(g),!g)return null;e.repeat.freq=n[s[10]]||t||"yearly",1==g?s[11]?(d="week",repeatDay=r[s[11].toLowerCase().slice(0,2)],e.repeat.freq="weekly",e.repeat.kind="advanced",e.repeat.digit=""+g,e.repeat.onMonth="week",e.repeat.weekStart=1):s[1]&&"yearly"==e.repeat.freq?(d="advanced",e.repeat.kind="advanced",e.repeat.digit=""+g,e.repeat.weekStart=1,e.repeat.onMonth="date",a=a.set("month",o[m]-1),a=a.set("date",parseInt(f)),moment().diff(a)>0&&(a=a.add("year",1)),e.start={year:a.year(),month:a.month(),day:a.date()},e.highlight.pop(),e=new chrono.ParseResult(e)):s[1]&&"monthly"==e.repeat.freq?(d="advanced",e.repeat.freq="monthly",e.repeat.kind="advanced",e.repeat.digit=""+g,e.repeat.weekStart=1,e.repeat.onMonth="date",a=a.set("date",f)):e.repeat.kind=e.repeat.freq:(d="advanced",e.repeat.digit=""+g,"yearly"==e.repeat.freq&&(e.repeat.freq="monthly",e.repeat.digit=""+12*g),e.repeat.kind="advanced",e.repeat.weekStart=0,e.repeat.onMonth=e.start.day?"date":"week")}switch(d){case"weekday":0==l&&6==l&&(a=a.day(1));break;case"weekend":0!=l&&6!=l&&(a=a.day(6));break;case"week":l!=repeatDay&&(a=a.day(repeatDay)),e.repeat.mweekdays={n:""+g,weekday:a.format("dd").toUpperCase()},e.repeat.weekdays=[a.format("dd").toUpperCase()];break;case"advanced":e.repeat.weekdays=[a.format("dd").toUpperCase()],e.repeat.monthdays=[a.date()]}return e.repeat.date=a.format("YYYY-M-D"),$(e,u,t,i),e},I=function(e,t){var i=t,n=t.match(this.pattern),s=e?moment(e.startDate):moment(),a=31,r=n[2]||n[5];r=parseInt(r);var o=n[1]||n[6],l=t.indexOf(n[0]),e=e||p();if(t=n[0],"last"==o)s=moment().endOf("M"),e.repeat={kind:"monthly",freq:"monthly",digit:"1",weekStart:0,monthdays:[-1],onMonth:"date"};else{if(a>=r)for(s.date()>r&&(s=s.add("month",1));s.daysInMonth()<r;)s=s.add("month",1);s.set("date",r),e.repeat={kind:"advanced",freq:"monthly",digit:"1",weekStart:0,monthdays:[r],onMonth:"date"}}return e.start.day||(e.start={day:s.date(),month:s.month(),year:s.year()}),e.repeat.date=s.format("YYYY-M-D"),$(e,l,t,i),new chrono.ParseResult(e)},C=function(e){var t=[{pattern:/每(个工作日|周末|(周|星期|礼拜)([一二三四五六日天])|([年个]([0-9０-９]{1,2}|[一二三四五六七八九十]{1,2}))?月([0-9０-９]{1,2}|[一二三四五六七八九十]{1,3})[日号]|(([0-9]+|[一二三四五六七八九十百两]+)?(天|周|个月|年|星期|礼拜|月)))/,parse:w},{pattern:/每[个]?月(第([0-9]{1,2}|[一二三四五六七八九十]{1,3})天|最后一天)/,parse:b},{pattern:/\b((January|Jan|February|Feb|March|Mar|April|Apr|May|June|Jun|July|Jul|August|Aug|September|Sep|October|Oct|November|Nov|December|Dec)[\.]?\s(([1-9]*1st|[1-9]*2nd|[1-9]*3rd|[0-9]{1,2}th)|[0-9]{1,2})\s)?((every|each)\s+((([0-9]+)?\s*(day|week|month|year)|weekday|weekend)[s]?|(Sunday|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sun|Mon|Tu|Tues|Tue|Wed|Thur|Th|Thu|Thurs|Fri|Sat)))\b|(daily|weekly|monthly|yearly)\b/i,parse:T},{pattern:/\b(([1-9]*1st|[1-9]*2nd|[1-9]*3rd|[0-9]{1,2}th)|last)\sday\sof\s(each|every)\smonth\b|(each|every)\s(([1-9]*1st|[1-9]*2nd|[1-9]*3rd|[0-9]{1,2}th)|last)\sday\b/i,parse:I}],i=h(t,e);return i},x=function(e,t,i){return e?e.parse(i,t):i},S=function(e,t){var i=t,n=t.match(this.pattern);if(!n||!n[0])return e;var e=e||p(),s=0,r=n[2],o=n[4]&&c(n[4]),l=t.indexOf(n[0]),t=n[0],d=n[11],u=e.start.day?moment(e.startDate):moment();if(n[8]){if(s=n[8],"半"==s){if(-1==["时","点"].indexOf(n[7]))return null;n[9]&&(t=t.slice(0,-1)),s=30}else s=c(s);(s>=60||null==s)&&(s=0)}if(r?o>0&&12>o&&["中午","下午","傍晚","晚上","今晚","明晚"].indexOf(r)>-1?o+=12:o>0&&["午夜","半夜"].indexOf(r)>-1?o%=12:o>=12&&["凌晨","早上","上午","明早"].indexOf(r)>-1&&(12==o?o+=12:o-=12):d&&(o=a[d]),0==o&&(u=u.subtract("d",1))&&(o=24),null==e.start.day){var h=u.hours(),m=u.minutes(),f=60*(h-o)+m-s;d?h>=o&&u.add("d",1):r&&f>0?u.add("d",1):f-720>0?u.add("d",1):f>0&&24>o&&(o>12?u.add("d",1):o+=12)}return e.start.day=u.date(),e.start.month=u.month(),e.start.year=u.year(),void 0==e.start.hour&&(e.start.hour=o,e.start.minute=s),["今晚","明早","明晚"].indexOf(r)>-1&&(t=t.slice(2),l+=2),$(e,l,t,i),new chrono.ParseResult(e)},D=function(e,t){var i=t,n=t.match(this.pattern);if(!n||!n[0])return e;var e=e||p(),s=t.indexOf(n[0]),t=n[0],r=n[7]||0,o=n[2],l=n[9],c=n[11];l=l&&l.toLowerCase().replace(/(in|the)\s/g,"");var d=e.start.day?moment(e.startDate):moment();if(o=parseInt(o),l?12>=o&&["pm","p.m.","evening","afternoon","night","tonight"].indexOf(l)>-1?o+=12:o>0&&["midnight"].indexOf(l)>-1?o%=12:o>12&&["am","a.m.","morning"].indexOf(l)>-1&&(o-=12):c&&(o=a[c]),r&&(r=parseInt(r),r>=60))return null;if(0==o&&(d=d.subtract("d",1))&&(o=24),null==e.start.day){var u=d.hours(),h=d.minutes(),m=60*(u-o)+h-r;c?u>=o&&d.add("d",1):l&&m>0?d.add("d",1):m-720>0?d.add("d",1):m>0&&24>o&&(o>12?d.add("d",1):o+=12)}return("tonight"==c||"tonight"==l)&&(d=moment()),e.start.day=d.date(),e.start.month=d.month(),e.start.year=d.year(),void 0==e.start.hour&&(e.start.hour=o,e.start.minute=r),$(e,s,t,i),new chrono.ParseResult(e)},j=function(e,t){var i=[{pattern:/((早上|上午|中午|下午|傍晚|晚上|今晚|明早|明晚|凌晨|午夜|半夜)?\s*(([0-9]{1,2}|[一二三四五六七八九十两]{1,2})(((\:|\：|时|点)([0-9]{1,2}|[一二三四五六七八九十]{1,2}|半)(分)?)|(时|点钟|点))))|(早上|上午|中午|下午|傍晚|晚上|今晚|明早|明晚|凌晨|午夜|半夜)/,parse:S},{pattern:/\b(at)?\s*([0-9]{1,2})(((([\:\：]([0-9]{1,2}))|\s?o'clock)?(\s*(AM|PM|A\.M\.|P\.M\.|in\sthe\smorning|in\sthe\safternoon|in\sthe\sevening|in\sthe\smidnight|tonight)))|(\s?o'clock))\b|(morning|afternoon|evening|midnight|noon|tonight|night)\b/i,parse:D}],n=h(i,e);return n?n.parse(t,e):t},$=function(e,t,i,n){var s,a,r,o=e.highlight,l=0,c=i;if(!o||!o.length)return void(e.highlight=new Array(i));for(r=0,len=o.length;r<len;r++){if(s=o[r],l=n.indexOf(s),l>t&&(a=l,l=t,t=a,a=s,s=c,c=a,a=""),l+s.length>t+c.length){o[r]=s;break}if(!(l+s.length<t)){o[r]=n.slice(l,t+c.length);break}a=i}a&&e.highlight.splice(r,0,a)};t.getMergeResult=function(e,t){var i=C(t),n=null;if(e.length>1&&i){for(var s=t.match(i.pattern)[0],a=t.indexOf(s),r=a+s.length,o=-1,l=0,c=e.length;c>l;l++)if(o=e[l].index,a>o||o>r){n=e[l];break}}else n=e[0];return n&&!Array.isArray(n.highlight)&&(n.highlight=new Array(n.text)),n=x(i,t,n),n=j(t,n),n=k(t,n)},t.getHighlightText=function(e,t){var n=e.highlight,t=i.encodeHTML(t);return _.each(n,function(e){0!=e.length&&(t=t.replace(e,"<b>"+e+"</b>"))}),t=t.replace(/\s/g,"&nbsp;")},t.removeHightlight=function(e,t){var i=e.highlight;return _.each(i,function(e){0!=e.length&&(t=t.replace("<b>"+e+"</b>",e))}),t=t.replace(/\s/g,"&nbsp;")},t.getChronoResult=function(e){return chrono.parse(e)[0]},t.getNoneSymbolResult=function(e,t){var i={weekStartDay:t},n=chrono.parse(e,null,i);return n.symbol?{symbol:n.symbol,smart:null}:{symbol:null,smart:this.getMergeResult(n,e)}}}),define("hbs!template/hint-tip",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r="",o="function",l=this.escapeExpression;return r+='<div class="pop-tip">\n	',(a=i.text)?a=a.call(t,{hash:{},data:s}):(a=t.text,a=typeof a===o?a.apply(t):a),r+=l(a)+"\n</div>"})}),define("view/hint",["require","exports","module","hbs!template/hint-tip"],function(e,t){t.View=Backbone.View.extend({className:"hint-tip",template:e("hbs!template/hint-tip"),initialize:function(e){this.initData(e),this.render(),this.initEvent()},initData:function(e){this.container=$("body"),this.showTime=5e3,this.isShow=!1,_.extend(this,e),this["class"]=e.dir||"bottom"},render:function(){var e=this.template({text:this.text});this.$el.html(e).appendTo(this.container).addClass(this["class"])},initEvent:function(){var e=this;this.events&&_.each(this.events,function(t){e[t].apply(e)})},hideTip:function(){var e=this;this.isShow&&(this.$el.removeClass("show"),this.isShow=!1,_.isUndefined(this.timer)||clearTimeout(this.timer),this.after&&_.each(this.after,function(t){e[t].apply(e)}))},showTip:function(e){e&&(e.preventDefault(),e.stopPropagation());var t=this;this.isShow?(this.$el.removeClass("show"),this.isShow=!1):(this.$el.addClass("show"),this.isShow=!0,this.showTime&&(this.timer=setTimeout(function(){t.hideTip()},this.showTime)))},removeFromDom:function(){this.remove()}})}),define("hbs!template/quick_preset",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o,l="",c=i.helperMissing,d=this.escapeExpression;return l+='<div class="preset-time">\n  <a>\n    <span class="icons">  \n        ',o={hash:{},data:s},a=i.svgIcon,r=a?a.call(t,"icon-duedate","i-2-1 fast-transition normal-icon",o):c.call(t,"svgIcon","icon-duedate","i-2-1 fast-transition normal-icon",o),(r||0===r)&&(l+=r),l+="\n        ",o={hash:{},data:s},a=i.svgIcon,r=a?a.call(t,"icon-after-duedate","i-2 active-icon",o):c.call(t,"svgIcon","icon-after-duedate","i-2 active-icon",o),(r||0===r)&&(l+=r),l+="\n        ",o={hash:{},data:s},a=i.svgIcon,r=a?a.call(t,"icon-after-duedate-solid","i-2 fast-transition highlight-icon",o):c.call(t,"svgIcon","icon-after-duedate-solid","i-2 fast-transition highlight-icon",o),(r||0===r)&&(l+=r),l+='\n    </span>\n    <span class="selected-title text-tny i-2"></span>\n  </a>\n</div>\n<div class="preset-priority dropdown">\n  <a data-toggle="dropdown" class="boult">\n    ',o={hash:{},data:s},a=i.svgIcon,r=a?a.call(t,"icon-priority-3","i-2-1 fast-transition",o):c.call(t,"svgIcon","icon-priority-3","i-2-1 fast-transition",o),(r||0===r)&&(l+=r),l+='\n  </a>\n    <ul class="dropdown-menu priority-menu pull-right">\n        <li>\n          <a class="priority" value="5">\n            ',o={hash:{},data:s},a=i.svgIcon,r=a?a.call(t,"icon-priority-3",o):c.call(t,"svgIcon","icon-priority-3",o),(r||0===r)&&(l+=r),l+="\n            ",o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"high_priority",o):c.call(t,"I18n","high_priority",o)))+'\n          </a>\n        </li>\n        <li>\n          <a class="priority" value="3">\n            ',o={hash:{},data:s},a=i.svgIcon,r=a?a.call(t,"icon-priority-2",o):c.call(t,"svgIcon","icon-priority-2",o),(r||0===r)&&(l+=r),l+="\n            ",o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"medium_priority",o):c.call(t,"I18n","medium_priority",o)))+'\n          </a>\n        </li>\n        <li>\n          <a class="priority" value="1">\n            ',o={hash:{},data:s},a=i.svgIcon,r=a?a.call(t,"icon-priority-1",o):c.call(t,"svgIcon","icon-priority-1",o),(r||0===r)&&(l+=r),l+="\n            ",o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"low_priority",o):c.call(t,"I18n","low_priority",o)))+'\n          </a>\n        </li>\n        <li>\n          <a class="priority" value="0">\n            ',o={hash:{},data:s},a=i.svgIcon,r=a?a.call(t,"icon-priority-3","i-4-1",o):c.call(t,"svgIcon","icon-priority-3","i-4-1",o),(r||0===r)&&(l+=r),l+="\n            ",o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"none_priority",o):c.call(t,"I18n","none_priority",o)))+'\n          </a>\n        </li>\n    </ul>\n</div>\n<div class="preset-list dropdown">\n  <a data-toggle="dropdown" class="boult">\n    ',o={hash:{},data:s},a=i.svgIcon,r=a?a.call(t,"icon-move-list","i-2-1 fast-transition",o):c.call(t,"svgIcon","icon-move-list","i-2-1 fast-transition",o),(r||0===r)&&(l+=r),l+="\n  </a>\n</div>\n"})}),define("view/quick-preset",["require","exports","module","dao/projectdb","utils/index","service/prefs","configs/dict","modules/timecard/timecard","utils/timeformat","utils/hash","modules/project-menu/menu","hbs!template/quick_preset"],function(e,t){var i=e("dao/projectdb").db,n=e("utils/index"),s=e("service/prefs"),a=e("configs/dict"),r=e("modules/timecard/timecard").View,o=e("utils/timeformat"),l=e("utils/hash"),c=e("modules/project-menu/menu").View;t.View=Backbone.View.extend({className:"preset tl-q-preset",template:e("hbs!template/quick_preset"),events:{"click .preset-priority li>a":"selectPriority","click .preset-time >a":"toggleTimecard"},messages:function(){this.listenTo(Backbone,"hideTimeCard",this.hideTimeCard)},initialize:function(e){this.initData(e),this.render(),this.initDomAttr(),this.messages(),this.renderSelectedDate(),this.renderProjectMenu(),this.afterInitDomAttr()},initData:function(e){_.extend(this,e),this.presetDate={},this.defaultProjectId=this.project.get("id")},renderSelectedDate:function(e){var t="";e?t=e:l.isInToday()?t=o.getStartOfToday():l.isInWeek()&&(t=o.getStartOfTomorrow()),t?(t=moment(t).date(),this.$presetTime.addClass("active")):this.$presetTime.removeClass("active"),this.$presetTime.find(".selected-title").text(t)},renderHighlightDate:function(e){e=moment(e).date(),this.$presetTime.removeClass("active").addClass("highlight"),this.$presetTime.find(".selected-title").text(e)},stopHighlightDate:function(){this.$presetTime.removeClass("highlight")},render:function(){this.$el.html(this.template({projectId:this.project.get("id")})).appendTo($("#add-task"))},renderProjectMenu:function(){this.projectMenu&&this.projectMenu.onClose(),this.projectMenu=new c({projectId:this.project.get("id"),$wrap:this.$presetList,action:_.bind(this.selectList,this)})},initDomAttr:function(){this.$presetTime=this.$(".preset-time"),this.$presetList=this.$(".preset-list"),this.$selectedPriority=this.$(".preset-priority>a"),this.$priorityUl=this.$(".preset-priority ul")},afterInitDomAttr:function(){this.$listUl=this.$(".preset-list ul")},selectList:function(e){var t=e.attr("projectid"),n=i.getProjectById(t);this.setProject(n),this.removeActive(this.$listUl),this.addActive(e.parent()),this.renderPlaceholder()},selectPriority:function(e){var t=$(e.currentTarget).attr("value");t=t||$(e.currentTarget).parent().attr("value"),this.setPriority(t),this.removeActive(this.$priorityUl),this.addActive($(e.currentTarget).parent()),this.changeSelectPriorityIcon(t),this.renderPlaceholder()},changeSelectPriorityIcon:function(e){this.$selectedPriority.html(n.getPriorityIcon([e]))},addActive:function(e){e&&e.addClass("active")},removeActive:function(e){e&&$("li",e).map(function(){$(this).removeClass("active")})},initTimecard:function(){var e={meridiem:s.get("showMeridiem"),weekStart:s.getWeekStartDay()},t=null;if(l.isInToday()&&(t=o.getStartOfToday()),l.isInWeek()&&(t=o.getStartOfTomorrow()),e.dueDate=this.presetDate.dueDate||t||null,e.repeatFlag=this.presetDate.repeatFlag||null,e.format=a.format.atomTime,e.reminders=this.presetDate.reminders||null,e.isAllDay=this.presetDate.isAllDay?!0:this.presetDate.dueDate?!1:!0,null==this.timecard){this.timecard=new r(e),this.timecard.$el.addClass("quick-preset-timecard"),this.$presetTime.append(this.timecard.el);var i=this;this.timecard.on("confirmTime",function(e){i.confirmTime(e)}),this.timecard.on("clearTime",function(e){i.clearTime(e)}),this.timecard.on("settingsUpdate",function(e){i.previewTime(e)}),Backbone.trigger("openTimecard"),this.timecard.listenTo(Backbone,"openTimecard",function(){null!=i.timecard&&(i.timecard.trigger("hideCard"),i.timecard=null)})}},clearTime:function(){this.clearPresetDate(),this.renderPlaceholder(),this.hideTimeCard(),Backbone.trigger("setPresetDuedate")},previewTime:function(e){var t=e.dueDate;this.renderSelectedDate(t)},toggleTimecard:function(){if(this.timecard)this.hideTimeCard();else{var e=this;setTimeout(function(){e.initTimecard()})}},hideTimeCard:function(){null!=this.timecard&&(this.timecard.trigger("hideCard"),this.timecard=null),this.presetDate.dueDate?this.renderSelectedDate(this.presetDate.dueDate):this.renderSelectedDate()},confirmTime:function(e){this.setPresetDate(e),this.renderPlaceholder(),this.hideTimeCard(),Backbone.trigger("setPresetDuedate",e.dueDate)},manualSetTime:function(e,t){t?this.renderHighlightDate(e.dueDate):this.renderSelectedDate(e.dueDate),this.setPresetDate(e)},renderPlaceholder:function(){var e=this.presetDate,t="";e.dueDate&&(t=s.getListItemDueDateForList(e.dueDate,e.isAllDay)),Backbone.trigger("renderPlaceholder",t,this.project)},setPresetDate:function(e){_.extend(this.presetDate,e)},clearPresetDate:function(){this.presetDate={}},setProject:function(e){this.project=e},setPriority:function(e){this.priority=e},resetProject:function(e){this.project=e,this.renderProjectMenu()},resetDuedate:function(){this.presetDate={},this.renderSelectedDate()},resetPriority:function(){this.priority=0,this.$selectedPriority.html(n.svgIcon("icon-priority-3","i-4")),this.removeActive(this.$priorityUl)},reset:function(e){this.resetProject(e),this.resetDuedate(),this.resetPriority(),this.renderPlaceholder()}})}),define("hbs!template/task_auto_complete",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){var i,n="";return n+='\n    <li class="time">\n      <a data-time="'+c((i=e.time,typeof i===l?i.apply(e):i))+'">\n        <span class="task-match">'+c((i=e.match,typeof i===l?i.apply(e):i))+' </span>\n        <span class="task-time">'+c((i=e.calendar,typeof i===l?i.apply(e):i))+"</span>\n      </a>\n    </li>\n  "}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var r,o="",l="function",c=this.escapeExpression,d=this;return o+='<ul class="dropdown-menu">\n  ',r=i.each.call(t,t.hintList,{hash:{},inverse:d.noop,fn:d.program(1,a,s),data:s}),(r||0===r)&&(o+=r),o+="\n</ul>"})}),define("view/quick-add",["require","exports","module","utils/condition","configs/settings","configs/dict","configs/regexp","configs/status","configs/limit","lang/index","configs/keycode","utils/dom","utils/hash","offline/storage","utils/analytics","utils/timeformat","utils/string","utils/log","service/prefs","dao/projectdb","dao/taskdb","service/project","service/task","model/task","view/modal/get-upgrade","dao/order_by_date","dao/project-group","utils/limit","utils/index","utils/reminder-util","utils/nlp","view/tip","view/hint","view/quick-preset","service/userProfile","hbs!template/task_auto_complete"],function(e,t){var n=e("utils/condition"),s=e("configs/settings"),a=e("configs/dict"),r=e("configs/regexp"),o=(e("configs/status"),e("configs/limit")),l=e("lang/index"),c=e("configs/keycode"),d=e("utils/dom"),u=e("utils/hash"),h=e("offline/storage"),p=e("utils/analytics"),m=e("utils/timeformat"),f=e("utils/string"),g=e("utils/log"),v=e("service/prefs"),y=e("dao/projectdb"),k=e("dao/taskdb"),w=e("service/project"),b=e("service/task"),T=e("model/task").Model,I=e("view/modal/get-upgrade").View,C=e("dao/order_by_date").db,x=e("dao/project-group").db,S=e("utils/limit"),D=e("utils/index"),j=e("utils/reminder-util"),P=e("utils/nlp"),M=e("view/tip").View,A=e("view/hint").View,V=e("view/quick-preset").View,O=e("service/userProfile");t.View=Backbone.View.extend({el:"#add-task",template:e("hbs!template/task_auto_complete"),events:{"click #task-auto-complete li":"chooseClickedHint","keydown .task-new":"listenKeydown","keyup .task-new":"listenKeyup","paste .task-new":"listenPaste","cut .task-new":"listenCut","click #preset-time .icon_home":"toggleTimecard",
"click #preset-time .duedate":"toggleTimecard"},messages:function(){this.listenTo(Backbone,"projectDBUpdate",this.updateProjectData),this.listenTo(Backbone,"renderPlaceholder",this.renderPlaceholder),this.listenTo(Backbone,"setPresetDuedate",this.setPresetDuedate);var e=this;$("body").on("click.quick-add",function(t){e.blurInput(t)})},initialize:function(){this.initDom(),this.initProps(),this.initHintTip(),this.updateProjectData(),this.messages(),this.initQuickPreset(),this.renderPlaceholder(),Backbone.trigger("refreshAutoComplete")},initProps:function(){this.beforeCaret="",this.afterCaret="",this.timeText="",this.menuIsOpen=!1,this.presetDueDate=null,this.smartDuedate=null,this.symbolDuedate=null,this.isFirst=h.getStoreInfo("intro_smartDateParsing"),void 0==this.isFirst&&(this.isFirst=!0),this.smartDateParsing=h.getStoreInfo("smartDateParsing")||"show",this.weekStartDay=v.getWeekStartDay()},initQuickPreset:function(){this.presetView=new V({project:this.getProject()})},resetPreset:function(){this.presetView&&this.presetView.reset(this.getProject())},initDom:function(){this.$inputWrap=this.$(".input-like"),this.$taskNew=this.$(".task-new"),this.$placeholder=this.$(".placeholder"),this.$symbol=this.$("#task-copy .symbol"),this.$menuWrap=this.$("#task-auto-complete"),this.taskNewNode=this.$(".task-new").get(0)},getProject:function(){var e=w.getProjectForCreateTask();return u.isInProjectGroup()&&(e=w.getFirstProjectByGroupId(x.getCurrentProjectGroup().get("id"))),e},setCloseIntro:function(){this.isFirst=!1,h.setStoreInfo("intro_smartDateParsing","")},renderPlaceholder:function(e,t){var i="",n=t||this.getProject();if(n&&n.id){var s=f.quote(n.get("name"));i=_.string.sprintf(l.get("add_task_placeholder"),s)}var a;u.isInToday()&&(a=l.get("today")),u.isInWeek()&&(a=l.get("tomorrow")),e&&(a=e),a&&(i=l.get("add_task_placeholder_with_time").replace("%s1",s).replace("%s2",f.quote(a)),this.project_date=a),this.$placeholder.attr("data-placeholder",i),(e||t)&&this.$taskNew.focus(10)},render:function(e){var t=this.template;this.$menuWrap.html(t({hintList:e}))},updateTimeData:function(){var e=[],t=l.isZH()?m.prefMoment():m.prefMoment().lang("en"),n=l.isZH()?l.get("today"):"Today",s=l.isZH()?l.get("tomorrow"):"Tomorrow",r=a.format.atomTime,o=l.isZH()?"MMMDo":"MMM D",c=l.isZH()?"":" ";e.push({match:t.format(o),time:t.startOf("day").format(r),calendar:n});var d=t.add("days",1);e.push({match:d.format(o),time:d.startOf("day").format(r),calendar:s});for(i in[1,2,3,4,5]){var u=t.add("days",1);e.push({match:u.format(o),time:u.startOf("day").format(r),calendar:u.format("dddd")})}for(i in[1,2,3,4,5,6,7])u=u.add("days",1),e.push({match:u.format(o),time:u.startOf("day").format(r),calendar:l.get("next")+c+u.format("dddd")});var h=t.subtract("day",13).add("month",1);e.push({match:h.format(o),time:h.format(r),calendar:l.get("next_month")});for(i in[2,3,4,5,6,7,8,9,10,11,12]){var u=t.add("month",1);e.push({match:"",time:u.startOf("month").format(r),calendar:u.startOf("month").format(o)})}this.timeOptions=e},updateProjectData:function(){var e=y.db.getProjects();this.projectOptions=[];var t=this;_.each(e,function(e){n.isClosedProject(e)||(e.get("id")===O.get("inboxId")?t.projectOptions.unshift({match:e.get("name"),time:"",projectId:O.get("inboxId")}):t.projectOptions.push({match:e.get("name"),time:"",projectId:e.get("id")}))})},listenKeydown:function(e){if(e=e||window.event,this.keydownCode=e.keyCode,e.ctrlKey||e.metaKey)switch(e.keyCode){case 66:case 98:case 73:case 105:case 85:case 117:return!1}e.keyCode==c.enter?(e.preventDefault(),e.stopPropagation(),$.trim(this.getTaskNewText()).length&&(this.menuIsOpen?this.chooseCurrentHint():(this.afterHint(),this.addTask(),h.setStoreInfo("new_draft","")))):e.keyCode==c.down_arrow?this.menuIsOpen?this.chooseNextHint():Backbone.trigger("navigateFirstTaskOnList"):e.keyCode==c.up_arrow?this.menuIsOpen&&this.choosePreviousHint():e.keyCode==c.escape?this.menuIsOpen&&this.hideMenu():e.keyCode==c.tab&&this.menuIsOpen&&this.chooseNextHint();var t=[c.enter,c.up_arrow,c.down_arrow,c.escape,c.tab];return _.contains(t,e.keyCode)&&this.menuIsOpen?(e.preventDefault(),e.stopPropagation(),!1):S.isOverLimitTitle(e,this.getTaskNewText())?(e.preventDefault(),e.stopPropagation(),!1):void 0},isInChineses:function(e){var t=e.keyCode,i=e.originalEvent&&e.originalEvent.code&&e.originalEvent.code.toLowerCase(),n=[c.space,c.enter],s=["enter","space"];return 229!==this.keydownCode?!1:e.shiftKey?!1:229!=t&&-1==n.indexOf(t)||229==t&&i&&-1==s.indexOf(i)||229==t&&!i?!0:void 0},listenKeyup:function(e){if(this.triggerChange(!0),!this.isInChineses(e)){var t=[c.enter,c.down_arrow,c.up_arrow,c.escape,c.tab,c.shift,c.ctrl,c.alt,c.left_window_key,c.right_window_key,c.firefox_command],i=[c.left_arrow,c.right_arrow];-1===t.indexOf(e.keyCode)&&(this.onInput(),-1===i.indexOf(e.keyCode)&&this.triggerChange())}},listenPaste:function(e){e.preventDefault();var t=null;if(t=window.clipboardData&&clipboardData.setData?window.clipboardData.getData("text"):(e.originalEvent||e).clipboardData.getData("text/plain"),t=f.encodeHTML(t).replace(/[\n\r\s]/g," "),document.body.createTextRange){if(document.selection)textRange=document.selection.createRange();else if(window.getSelection){sel=window.getSelection();var i=sel.getRangeAt(0),n=document.createElement("span");n.innerHTML="&#FEFF;",i.deleteContents(),i.insertNode(n),textRange=document.body.createTextRange(),textRange.moveToElementText(n),n.parentNode.removeChild(n)}textRange.text=t,textRange.collapse(!1),textRange.select()}else document.execCommand("insertText",!1,t);this.triggerChange()},listenCut:function(e){var t=this;setTimeout(function(){t.triggerChange()},0)},onInput:function(){this.syncQuickAdd(),this.decideDropMenu()},blurInput:function(e){var t=e.target;t&&!$(t).parents(".hint-tip").length&&this.afterHint(),t&&$(t).parents(".preset-time").length&&this.setCloseIntro(),t&&($(t).parents("#add-task").length||$(t).parents(".quick-preset-timecard").length)?this.$inputWrap.hasClass("focus")&&229!=this.keydownCode||(this.$inputWrap.addClass("focus"),this.triggerChange()):(this.removeHightlight(!0),this.$inputWrap.removeClass("focus"),this.$taskNew.blur(),this.hideMenu(),this.oldTitle="")},syncQuickAdd:function(){var e=this.getTaskNewText(),t=d.getCaretCharacterOffsetWithin(this.taskNewNode),i=e.slice(0,t),n=i.match(/(.*[\*\^])(.*)/);n?(this.before=n[1],this.piece=n[2]):(this.before=i,this.piece=""),this.after=e.slice(t),this.$symbol.text(this.before)},guessFilter:function(e,t,i){if(!t.match(r.autocomplete))return[];var n=t.split("").join(".*"),s=new RegExp("^"+n.toLowerCase());return _.filter(e,function(e){return i&&"time"==i?e.match.toLowerCase().match(s)||e.calendar.toLowerCase().match(s):e.match.toLowerCase().match(s)})},_showProjectMenu:function(){this.menuMode="project";var e=this.projectOptions;return e=this.piece.length?this.guessFilter(e,this.piece):e,e.length?(this.render(e),void this.showMenu()):void this.hideMenu()},_showTimeMenu:function(){this.updateTimeData(),this.menuMode="time";var e=[],t=this.piece;if(!t.length){var i=this.timeOptions;return e.push(i[0],i[1],i[7],i[14]),this.render(e),void this.showMenu()}if(e=this.guessFilter(this.timeOptions,t,this.menuMode),e.length)return this.render(e),void this.showMenu();if(Object.keys&&t.match(r.autocomplete)){var n=P.getChronoResult(t);if(n&&n.text===t){var s=n.startDate,a=m.dateToMoment(s).lang("en"),o="MMMM Do";"1200"!==a.format("HHmm")||t.indexOf("12")>0?o="MMMM Do HH:mm":a=a.startOf("day");var l={match:a.format(o),time:a.format(o),calendar:""},c=l.match+" ";if(-1===t.indexOf(c))return e=[l],this.render(),void this.showMenu()}}this.hideMenu()},decideDropMenu:function(){this._isProject()?this._showProjectMenu():this._isTime()?this._showTimeMenu():this.menuIsOpen&&this.hideMenu()},showMenu:function(){this.setMenuPosition(),this.$menuWrap.find("ul").show(),this.piece.length?this.chooseNextHint():this.chooseOneHint(),this.menuIsOpen=!0},hideMenu:function(){var e=this;setTimeout(function(){e.$menuWrap.find("ul").hide(),e.menuIsOpen=!1},100)},setMenuPosition:function(){var e=this.$symbol.width();e+=this.$symbol.position().left,this.$menuWrap.find("ul").css("left",e)},blurFromInput:function(){this.hideMenu()},_isProject:function(){return/\^$/.test(this.before)},_isTime:function(){return/\*$/.test(this.before)},setTaskNewText:function(e){this.$taskNew.html(e)},getTaskNewText:function(){return this.$taskNew.text()},getTaskNewHTML:function(){return this.$taskNew.html()},triggerChange:function(e){var t=this.getTaskNewText();t?(this.$taskNew.removeClass("show-placeholder"),!e&&this.doSmartParsing(t)):this.$taskNew.addClass("show-placeholder")},doSmartParsing:function(e){"-1"!=this.smartDateParsing&&(this.presetDueDate||(this.matchDueDate(),this.oldTitle=e))},matchDueDate:function(){var e=this.getTaskNewText(),t=P.getNoneSymbolResult(e,this.weekStartDay),i=t.smart,n=t.symbol;if(i){{var s=i.text;i.startDate}this.timeText!=s&&this.afterMatchDueDate(i),this.highlightDuedate(P.getHighlightText(i,e))}else this.timeText&&(this.timeText="",this.presetView.resetDuedate(),this.afterHint(),this.removeHightlight(s));this.smartDuedate=i,this.symbolDuedate=n},setPresetDuedate:function(e){this.presetDueDate=e?e:"clearDate",this.smartDuedate=null,this.removeHightlight()},afterMatchDueDate:function(e){this.timeText&&this.afterHint(),this.timeText=e.text;var t=m.dateToMoment(e.startDate).lang("en"),i={dueDate:t.format(a.format.atomTime),repeatFlag:j.exposeRepeat(e.repeat).repeatFlag,isAllDay:!1,reminders:null,trigger:""};_.extend(i,{reminders:e.reminder,isAllDay:e.other.isAllDay}),this.isFirst?(this.presetView.manualSetTime(i,!0),this.showHintTip()):this.presetView.manualSetTime(i)},initHintTip:function(){this.hintTip=new A({text:l.get("smart_parsing_reminder"),container:this.$el,showTime:!1})},showHintTip:function(){this.hintTip&&this.hintTip.showTip()},hideHintTip:function(){this.hintTip&&this.hintTip.hideTip()},afterHint:function(){this.hintTip&&(this.hideHintTip(),this.presetView.stopHighlightDate())},highlightDuedate:function(e){var t=d.getCaretCharacterOffsetWithin(this.taskNewNode);this.setTaskNewText(e),d.setCharacterOffset(this.taskNewNode,t)},removeHightlight:function(e){if(e)this.smartDuedate&&this.setTaskNewText(P.removeHightlight(this.smartDuedate,this.getTaskNewHTML()));else{var t=d.getCaretCharacterOffsetWithin(this.taskNewNode);this.setTaskNewText(this.getTaskNewText()),d.setCharacterOffset(this.taskNewNode,t)}},chooseOneHint:function(){if(this._isProject())if(u.isInProjectView()){var e=w.getCurrentProject().get("name"),t=this.$el.find("li:contains("+e+")").first();t.addClass("active")}else this.chooseNextHint();else if(this._isTime())if(u.isInToday()){var e="Today",t=this.$el.find("li:contains("+e+")").first();t.addClass("active")}else if(u.isInWeek()){var e="Tomorrow",t=this.$el.find("li:contains("+e+")").first();t.addClass("active")}else this.chooseNextHint()},_chooseHandle:function(e){var t=this.$menuWrap.find("li.active"),i=this.$menuWrap.find("ul>li"),n=this.$menuWrap.find("ul"),s=n.height(),a=i.eq(0).height(),r=s/a,o=i.index(t);if(!t.length)return void i.first().addClass("active");t.removeClass("active"),"next"===e?o==i.length-1?o=0:o++:0==o?o=i.length-1:o--,t=i.eq(o),t.addClass("active");var l=o+1-r;l=0>l?0:l,n.scrollTop(l*a)},chooseNextHint:function(){this._chooseHandle("next")},choosePreviousHint:function(){this._chooseHandle("prev")},chooseCurrentHint:function(){var e=this.$menuWrap.find("li.active");if("time"==this.menuMode)var t=this.hint=e.find(".task-time").text();else var t=this.hint=e.find(".task-match").text();0!==(this.piece+this.after).indexOf(t)&&this.setTaskNewText(this.before+t+"&nbsp;"+$.trim(this.after)),d.setCharacterOffset(this.taskNewNode,(this.before+t).length+1),this.hideMenu(),this.matchDueDate()},chooseClickedHint:function(e){e=e||window.event;var t=this.$menuWrap.find("li.active");t.removeClass("active"),$(e.target).parents("li").addClass("active"),this.chooseCurrentHint()},setDuedateFromSymbol:function(e){if(Object.keys){var t=e.get("title"),i=-1!=this.smartDateParsing?this.symbolDuedate:P.getChronoResult(t);if(i){var n=t,r=i.text,o="\\*[^\\*]{0,}"+r,l=new RegExp(o),c=n.match(l)&&n.match(l)[0];if(n.indexOf(c)>-1){if(n=n.replace(c,"").replace(/\s+/g," ").replace(/^\s*/g,""),e.set("title",n),g.log(i.startDate,m.dateToMoment(i.startDate)),i.start.hour){duedate=m.dateToMoment(i.startDate).lang("en").utc().format(a.format.atomTime),e.set("dueDate",duedate);var d={id:ObjectId(),trigger:s.reminderStamp};e.set("reminders",[d]),e.set("isAllDay",!1)}else{var u=i.start.year,h=i.start.month+1<10?"0"+(i.start.month+1):i.start.month+1,f=i.start.day<10?"0"+i.start.day:i.start.day;duedate=m.dateToMoment(u+"-"+h+"-"+f).utc().format(a.format.atomTime),e.set("dueDate",duedate)}p.t_quick_add_key("quick_date")}}else{var n=e.get("title");n.match(/\*/)&&(n=n.replace("*"+this.hint,"").trim(),e.set("title",n))}}else _.each(this.timeOptions,function(t){var i=e.get("title"),n="*"+t.match;if(i.indexOf(n)>-1){var i=i.replace(n,"").replace(/\s+/g," ").replace(/^\s*/g,"");if(e.set("title",i),e.set("dueDate",t.time),"0000"!==m.prefMoment(t.time).format("HHmm")){var a={id:ObjectId(),trigger:s.reminderStamp};e.set("reminders",[a]),e.set("isAllDay",!1)}p.t_quick_add_key("quick_date")}})},setDuedateFromRouter:function(e){var t=this.getDefaultDuedate();e.set({dueDate:t?t:null},{silent:!0})},getDefaultDuedate:function(){var e="";return u.isInDateView()?e=m.dateToMoment(u.readUrl().name).startOf("day").utc().format(a.format.atomTime):u.isInToday()?e=m.getStartOfToday():u.isInWeek()&&(e=m.getStartOfTomorrow()),e},setDuedateFromPreset:function(e){var t=this.smartDuedate,i=this.presetView.presetDate;if(t){var n=t.highlight,s=e.get("title");"hide"==this.smartDateParsing&&(_.each(n,function(e){s=s.replace(e,"")}),s=s.replace(/\s+/g," ").replace(/^\s*/g,"")),e.set("title",s)}null!=i.dueDate&&(e.set({dueDate:i.dueDate,repeatFlag:i.repeatFlag},{silent:!0}),p.t_quick_add_key("set_date"))},setDuedate:function(e){try{this.setDuedateFromSymbol(e)}catch(t){g.log(t)}e.get("dueDate")||this.setDuedateFromPreset(e),e.get("dueDate")||this.setDuedateFromRouter(e)},setProject:function(e){var t=!1,i=e.get("title");if(i.indexOf("^")>-1){{i.split("^")[1].split(" ")[0]}_.each(this.projectOptions,function(n){if(!t){var s="\\^[^\\^]{0,}"+n.match+"\\s",a=new RegExp(s),r=i.match(a)&&i.match(a)[0];i.indexOf(r)>-1&&(i=i.replace(r,"").replace(/\s+/g," ").replace(/^\s*/g,""),e.set("title",i),e.set("projectId",n.projectId),t=!0,p.t_quick_add_key("quick_list"))}})}var n=this.presetView.project;if(n&&!t&&(e.set({projectId:n.get("id")},{silent:!0}),t=!0),!t){var s=this.getProject();e.set({projectId:s.id},{silent:!0})}},isOverProjectTaskLimit:function(e){var t=e.get("projectId"),i=b.getTasksCountByProject(t);return i<o.projectTaskNumber||n.isToInbox(t)&&i<o.inboxTaskNumber?!1:(new I({type:"task"}),!0)},setReminder:function(e){var t=this.presetView.presetDate;_.isEmpty(t.reminders)||(e.set("reminders",t.reminders),e.set("isAllDay",t.isAllDay)),e.set("reminder",null)},setRepeatFlag:function(e){var t=this.presetView.presetDate;null!=t.repeatFlag&&e.set("repeatFlag",t.repeatFlag)},setPriority:function(e){var t=this.presetView.priority;t&&e.set({priority:t},{silent:!0})},setSortOrder:function(e){var t=b.getMinSortOrder(e.get("projectId"));e.set({sortOrder:t},{silent:!0})},setTaskDefaultDateGroup:function(e){var t=w.getCurrentDateProjectId(),i=e.get("dueDate"),n=m.prefMoment(e.get("dueDate")).format("YYYYMMDD");if(i&&d.isDateGroupSort()){var s=C.getGroupByGroupId(n,t);if(!s.length)return;var a=e.get("id"),r=C.getGroupTaskMinSortOrder(n,t),o=[{id:a,order:r}];s.add(o),C.syncQuickAddTaskOrderByDate(n,t,o)}},showToast:function(){var e=this.presetView;try{if(u.isInProjectAll())return;var t=this.getProject(),i=e.project;t&&i&&t.get("id")!=i.get("id")&&new M({text:l.get("add_to_other_list").replace(/\%s1/,i.get("name"))});var n=this.getDefaultDuedate(),s=e.presetDate.dueDate||"";if(n&&s&&n!=s){var a=D.getOffsetDaysOfDay(s);if(u.isInWeek()&&7>a)return;if(u.isInToday()&&1>a)return;new M({text:l.get("add_to_other_time").replace(/\%s1/,this.project_date).replace(/\%s2/,i.get("name"))})}}catch(r){g.log(r)}},addTask:function(){var e=this.getTaskNewText();this.setTaskNewText("");var t=new T({modifiedTime:m.prefMoment().utc().format(a.format.atomTime),id:ObjectId(),title:e,priority:0,status:0,deleted:0,timeZone:v.get("timeZone")});t.local=!0,this.setProject(t),this.isOverProjectTaskLimit(t)||(this.setDuedate(t),this.setReminder(t),this.setRepeatFlag(t),this.setPriority(t),this.setSortOrder(t),this.setCloseIntro(),h.removeStoreInfo("new_draft"),this.project_date=v.getListItemDueDateForList(t.get("dueDate")),Backbone.trigger("navigateTask",t.get("id"),!0),k.db.add(t),this.showToast(),this.resetPreset(),p.t_quick_add_key("add"),p.t_quick_add(),this.setTaskDefaultDateGroup(t),Backbone.trigger("refresh"),setTimeout(function(){t.trigger("toggleActive")},50),Backbone.trigger("scrollToTask",t.get("id")),t.save(),this.initProps())},onClose:function(){$("body").off("click.quick-add"),this.remove()}})}),define("hbs!template/task_list_actionbar",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){var n,s,a,r="";return r+='\n<div class="tl-bar-action dropdown pull-right">\n    <a class="shareProject">\n        ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-share","i-2-1 fast-transition",a):C.call(e,"svgIcon","icon-share","i-2-1 fast-transition",a),(s||0===s)&&(r+=s),r+="\n    </a>\n</div>\n"}function r(e,t){return"\n"}function o(e,t){var n,s,a="";return a+="\n",s={hash:{},inverse:x.noop,fn:x.program(6,l,t),data:t},(n=i.ifNotInTrash)?n=n.call(e,s):(n=e.ifNotInTrash,n=typeof n===D?n.apply(e):n),i.ifNotInTrash||(n=j.call(e,n,s)),(n||0===n)&&(a+=n),a+="\n"}function l(e,t){var n,s,a,r="";return r+='\n<div id="dropdown-title" class="tl-bar-action dropdown pull-right">\n\n        <a title="',a={hash:{},data:t},r+=S((n=i.I18n,n?n.call(e,"sort",a):C.call(e,"I18n","sort",a)))+'" id="sort-by" class="dropdown-toggle inline-block action-btn boult" data-toggle="dropdown">\n            ',(s=i.iconClass)?s=s.call(e,{hash:{},data:t}):(s=e.iconClass,s=typeof s===D?s.apply(e):s),(s||0===s)&&(r+=s),r+='\n        </a>\n\n        <div class="dropdown-menu pull-right">\n            ',a={hash:{},inverse:x.noop,fn:x.program(7,c,t),data:t},n=i.isContain,s=n?n.call(e,e.sortByList,"byOrder",a):C.call(e,"isContain",e.sortByList,"byOrder",a),(s||0===s)&&(r+=s),r+="\n\n            ",a={hash:{},inverse:x.noop,fn:x.program(10,u,t),data:t},n=i.isContain,s=n?n.call(e,e.sortByList,"byList",a):C.call(e,"isContain",e.sortByList,"byList",a),(s||0===s)&&(r+=s),r+="\n\n            ",a={hash:{},inverse:x.noop,fn:x.program(12,h,t),data:t},n=i.isContain,s=n?n.call(e,e.sortByList,"byDueDate",a):C.call(e,"isContain",e.sortByList,"byDueDate",a),(s||0===s)&&(r+=s),r+="\n\n            ",a={hash:{},inverse:x.noop,fn:x.program(14,p,t),data:t},n=i.isContain,s=n?n.call(e,e.sortByList,"byTitle",a):C.call(e,"isContain",e.sortByList,"byTitle",a),(s||0===s)&&(r+=s),r+="\n\n            ",a={hash:{},inverse:x.noop,fn:x.program(16,m,t),data:t},n=i.isContain,s=n?n.call(e,e.sortByList,"byPriority",a):C.call(e,"isContain",e.sortByList,"byPriority",a),(s||0===s)&&(r+=s),r+="\n\n            ",a={hash:{},inverse:x.noop,fn:x.program(18,f,t),data:t},n=i.isContain,s=n?n.call(e,e.sortByList,"byAssignee",a):C.call(e,"isContain",e.sortByList,"byAssignee",a),(s||0===s)&&(r+=s),r+="\n        </div>\n</div>\n"}function c(e,t){var n,s,a,r="";return r+='\n            <li class="',a={hash:{},inverse:x.noop,fn:x.program(8,d,t),data:t},n=i.ifequal,s=n?n.call(e,e.sortType,"sortOrder",a):C.call(e,"ifequal",e.sortType,"sortOrder",a),(s||0===s)&&(r+=s),r+='">\n              <a title="',a={hash:{},data:t},r+=S((n=i.I18n,n?n.call(e,"sort_by_custom",a):C.call(e,"I18n","sort_by_custom",a)))+'" id="sortByOrder" class="sort-by">\n                  ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-sort-by-custom","i-3",a):C.call(e,"svgIcon","icon-sort-by-custom","i-3",a),(s||0===s)&&(r+=s),r+="\n                  ",a={hash:{},data:t},r+=S((n=i.I18n,n?n.call(e,"sort_by_custom",a):C.call(e,"I18n","sort_by_custom",a)))+"\n              </a>\n            </li>\n            "}function d(e,t){return"active"}function u(e,t){var n,s,a,r="";return r+='\n            <li class="',a={hash:{},inverse:x.noop,fn:x.program(8,d,t),data:t},n=i.ifequal,s=n?n.call(e,e.sortType,"project",a):C.call(e,"ifequal",e.sortType,"project",a),(s||0===s)&&(r+=s),r+='">\n              <a title="',a={hash:{},data:t},r+=S((n=i.I18n,n?n.call(e,"sort_by_project",a):C.call(e,"I18n","sort_by_project",a)))+'" id="sortByProject" class="sort-by">\n                  ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-sort-by-list","i-3",a):C.call(e,"svgIcon","icon-sort-by-list","i-3",a),(s||0===s)&&(r+=s),r+="\n                  ",a={hash:{},data:t},r+=S((n=i.I18n,n?n.call(e,"list_label",a):C.call(e,"I18n","list_label",a)))+"\n              </a>\n            </li>\n            "}function h(e,t){var n,s,a,r="";return r+='\n            <li class="',a={hash:{},inverse:x.noop,fn:x.program(8,d,t),data:t},n=i.ifequal,s=n?n.call(e,e.sortType,"dueDate",a):C.call(e,"ifequal",e.sortType,"dueDate",a),(s||0===s)&&(r+=s),r+='">\n              <a title="',a={hash:{},data:t},r+=S((n=i.I18n,n?n.call(e,"sort_by_duedate",a):C.call(e,"I18n","sort_by_duedate",a)))+'" id="sortByDueDate" class="sort-by">\n                  ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-sort-by-duedate","i-3",a):C.call(e,"svgIcon","icon-sort-by-duedate","i-3",a),(s||0===s)&&(r+=s),r+="\n                  ",a={hash:{},data:t},r+=S((n=i.I18n,n?n.call(e,"due_date_label",a):C.call(e,"I18n","due_date_label",a)))+"\n              </a>\n            </li>\n            "}function p(e,t){var n,s,a,r="";return r+='\n            <li class="',a={hash:{},inverse:x.noop,fn:x.program(8,d,t),data:t},n=i.ifequal,s=n?n.call(e,e.sortType,"title",a):C.call(e,"ifequal",e.sortType,"title",a),(s||0===s)&&(r+=s),r+='">\n              <a title="',a={hash:{},data:t},r+=S((n=i.I18n,n?n.call(e,"sort_by_title",a):C.call(e,"I18n","sort_by_title",a)))+'" id="sortByTitle" class="sort-by">\n                ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-sort-by-title","i-3",a):C.call(e,"svgIcon","icon-sort-by-title","i-3",a),(s||0===s)&&(r+=s),r+="\n                ",a={hash:{},data:t},r+=S((n=i.I18n,n?n.call(e,"title_label",a):C.call(e,"I18n","title_label",a)))+"\n              </a>\n            </li>\n            "}function m(e,t){var n,s,a,r="";return r+='\n            <li class="',a={hash:{},inverse:x.noop,fn:x.program(8,d,t),data:t},n=i.ifequal,s=n?n.call(e,e.sortType,"priority",a):C.call(e,"ifequal",e.sortType,"priority",a),(s||0===s)&&(r+=s),r+='">\n              <a title="',a={hash:{},data:t},r+=S((n=i.I18n,n?n.call(e,"sort_by_priority",a):C.call(e,"I18n","sort_by_priority",a)))+'" id="sortByPriority" class="sort-by">\n                ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-sort-by-priority","i-3",a):C.call(e,"svgIcon","icon-sort-by-priority","i-3",a),(s||0===s)&&(r+=s),r+="\n                ",a={hash:{},data:t},r+=S((n=i.I18n,n?n.call(e,"priority_label",a):C.call(e,"I18n","priority_label",a)))+"\n              </a>\n            </li>\n            "}function f(e,t){var n,s,a,r="";return r+='\n            <li class="',a={hash:{},inverse:x.noop,fn:x.program(8,d,t),data:t},n=i.ifequal,s=n?n.call(e,e.sortType,"assignee",a):C.call(e,"ifequal",e.sortType,"assignee",a),(s||0===s)&&(r+=s),r+='">\n                <a title="',a={hash:{},data:t},r+=S((n=i.I18n,n?n.call(e,"sort_by_assignee",a):C.call(e,"I18n","sort_by_assignee",a)))+'" id="sortByAssignee" class="sort-by">\n                  ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-sort-by-assignee","i-3",a):C.call(e,"svgIcon","icon-sort-by-assignee","i-3",a),(s||0===s)&&(r+=s),r+="\n                    ",a={hash:{},data:t},r+=S((n=i.I18n,n?n.call(e,"assignee_label",a):C.call(e,"I18n","assignee_label",a)))+"\n                </a>\n            </li>\n            "}function g(e,t){var n,s,a="";return a+="\n",s={hash:{},inverse:x.noop,fn:x.program(21,v,t),data:t},(n=i.ifNotInCompleted)?n=n.call(e,s):(n=e.ifNotInCompleted,n=typeof n===D?n.apply(e):n),i.ifNotInCompleted||(n=j.call(e,n,s)),(n||0===n)&&(a+=n),a+="\n"}function v(e,t){var n,s,a,r="";return r+='\n<div class="tl-bar-action dropdown pull-right">\n    <a title="',a={hash:{},data:t},r+=S((n=i.I18n,n?n.call(e,"more",a):C.call(e,"I18n","more",a)))+'" class="dropdown-toggle boult" data-toggle="dropdown">\n        ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-more","i-2-1 fast-transition",a):C.call(e,"svgIcon","icon-more","i-2-1 fast-transition",a),(s||0===s)&&(r+=s),r+='\n    </a>\n    <div class="dropdown-menu pull-right">\n        ',a={hash:{},inverse:x.noop,fn:x.program(22,y,t),data:t},(s=i.ifInNormalProjectWithoutShare)?s=s.call(e,a):(s=e.ifInNormalProjectWithoutShare,s=typeof s===D?s.apply(e):s),i.ifInNormalProjectWithoutShare||(s=j.call(e,s,a)),(s||0===s)&&(r+=s),r+='\n\n        <li class="completed_tasks ',a={hash:{},inverse:x.noop,fn:x.program(8,d,t),data:t},n=i.ifequal,s=n?n.call(e,e.sortType,"completedTime",a):C.call(e,"ifequal",e.sortType,"completedTime",a),(s||0===s)&&(r+=s),r+='">\n            <a title="',a={hash:{},data:t},r+=S((n=i.I18n,n?n.call(e,"completed_tasks",a):C.call(e,"I18n","completed_tasks",a)))+'" id="completed_tasks" class="completed-status">\n                ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-completed-list-view","i-3",a):C.call(e,"svgIcon","icon-completed-list-view","i-3",a),(s||0===s)&&(r+=s),r+='\n                <span class="text">',a={hash:{},data:t},r+=S((n=i.I18n,n?n.call(e,"hide_completed",a):C.call(e,"I18n","hide_completed",a)))+"</span>\n            </a>\n        </li>\n\n        ",a={hash:{},inverse:x.noop,fn:x.program(24,k,t),data:t},(s=i.ifInNormalProject)?s=s.call(e,a):(s=e.ifInNormalProject,s=typeof s===D?s.apply(e):s),i.ifInNormalProject||(s=j.call(e,s,a)),(s||0===s)&&(r+=s),r+='\n\n        <li>\n            <a class="print">\n                ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-print","i-3",a):C.call(e,"svgIcon","icon-print","i-3",a),(s||0===s)&&(r+=s),r+="\n                ",a={hash:{},data:t},r+=S((n=i.I18n,n?n.call(e,"print",a):C.call(e,"I18n","print",a)))+"\n            </a>\n        </li>\n\n    </div>\n</div>\n"}function y(e,t){var n,s,a,r="";return r+='\n        <li>\n            <a class="shareProject">\n                ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-share","i-3",a):C.call(e,"svgIcon","icon-share","i-3",a),(s||0===s)&&(r+=s),r+="\n                ",a={hash:{},data:t},r+=S((n=i.I18n,n?n.call(e,"share",a):C.call(e,"I18n","share",a)))+"\n            </a>\n        </li>\n        "}function k(e,t){var n,s,a,r="";return r+='\n        <li>\n            <a class="projectActivity">\n                ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-s-pro-p-activity","i-3",a):C.call(e,"svgIcon","icon-s-pro-p-activity","i-3",a),(s||0===s)&&(r+=s),r+="\n                ",a={hash:{},data:t},r+=S((n=i.I18n,n?n.call(e,"project_activity",a):C.call(e,"I18n","project_activity",a)))+"\n            </a>\n        </li>\n        "}function w(e,t){var n,s,a,r="";return r+='\n    <a class="print">\n        ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-print","i-2-1 fast-transition",a):C.call(e,"svgIcon","icon-print","i-2-1 fast-transition",a),(s||0===s)&&(r+=s),r+="\n    </a>\n"}function b(e,t){var n,s,a,r="";return r+='\n    <a title="',a={hash:{},data:t},r+=S((n=i.I18n,n?n.call(e,"clear_trash",a):C.call(e,"I18n","clear_trash",a)))+'" id="clearTrash" class="action-btn ',(s=i.ifHasTasksInTrash)?s=s.call(e,{hash:{},data:t}):(s=e.ifHasTasksInTrash,s=typeof s===D?s.apply(e):s),r+=S(s)+'">\n        ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-clear-trash","i-2-1 fast-transition",a):C.call(e,"svgIcon","icon-clear-trash","i-2-1 fast-transition",a),(s||0===s)&&(r+=s),r+="\n    </a>\n"}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var _,T,I="",C=i.helperMissing,x=this,S=this.escapeExpression,D="function",j=i.blockHelperMissing;return I+="\n",T={hash:{},inverse:x.noop,fn:x.program(1,a,s),data:s},(_=i.ifIsShareProject)?_=_.call(t,T):(_=t.ifIsShareProject,_=typeof _===D?_.apply(t):_),i.ifIsShareProject||(_=j.call(t,_,T)),(_||0===_)&&(I+=_),I+="\n\n\n",T={hash:{},inverse:x.program(5,o,s),fn:x.program(3,r,s),data:s},(_=i.ifInSubscribe)?_=_.call(t,T):(_=t.ifInSubscribe,_=typeof _===D?_.apply(t):_),i.ifInSubscribe||(_=j.call(t,_,T)),(_||0===_)&&(I+=_),I+="\n\n\n",T={hash:{},inverse:x.noop,fn:x.program(20,g,s),data:s},(_=i.ifNotInTrash)?_=_.call(t,T):(_=t.ifNotInTrash,_=typeof _===D?_.apply(t):_),i.ifNotInTrash||(_=j.call(t,_,T)),(_||0===_)&&(I+=_),I+="\n\n\n",T={hash:{},inverse:x.noop,fn:x.program(26,w,s),data:s},(_=i.ifInCompleted)?_=_.call(t,T):(_=t.ifInCompleted,_=typeof _===D?_.apply(t):_),i.ifInCompleted||(_=j.call(t,_,T)),(_||0===_)&&(I+=_),I+="\n\n\n\n",T={hash:{},inverse:x.noop,fn:x.program(28,b,s),data:s},(_=i.ifInTrash)?_=_.call(t,T):(_=t.ifInTrash,_=typeof _===D?_.apply(t):_),i.ifInTrash||(_=j.call(t,_,T)),(_||0===_)&&(I+=_),I+="\n     \n"})}),define("hbs!template/task_list_bar",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o="",l=i.helperMissing,c=this.escapeExpression;return o+='<div id="task-list-top" class="tl-project">\n  <div id="task-action-bar" class="line-right"></div>\n  <div id="project-name-bar" class="line-left">\n    <h5 class="text-primary tl-des select-enabled">',r={hash:{},data:s},o+=c((a=i.getTitleByProject,a?a.call(t,t.project,r):l.call(t,"getTitleByProject",t.project,r)))+'</h5>\n  </div>\n</div>\n\n<div id="add-task" class="tl-quick">\n    \n <div class="input-like input-lrg">\n    <div class="typeahead task-new can-select" contenteditable="true" spellcheck="false" autocomplete="false"></div>\n    <div class="placeholder show-placeholder" data-placeholder=\'',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"task_new_placeholder",r):l.call(t,"I18n","task_new_placeholder",r)))+'\'></div>\n </div>\n  <div id="task-copy" class="tl-q-copy">\n      <span class="symbol"></span>\n      <div id="task-auto-complete"></div>\n  </div>\n</div>\n'})}),define("hbs!template/task_list",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r="",o="function",l=this.escapeExpression;return r+='<div id="task-list-view" class="tasks ',(a=i.adjustBarHeight)?a=a.call(t,{hash:{},data:s}):(a=t.adjustBarHeight,a=typeof a===o?a.apply(t):a),r+=l(a)+'">\n\n  <div class="tl-bar"></div>\n\n  <div id="task-list-body" class="tl-body">\n    <div id="task-ul-list" class="antiscroll-wrap">\n      <div id="task-list-scroll" class="tl-inner antiscroll-inner">\n          <div id="task-list-content" class="content"></div>\n          <div class="tl-loading">\n              ',(a=i.renderLoading)?a=a.call(t,{hash:{},data:s}):(a=t.renderLoading,a=typeof a===o?a.apply(t):a),(a||0===a)&&(r+=a),r+='\n          </div>\n          <div class="empty-list-info">\n              ',(a=i.renderEmptyInfo)?a=a.call(t,{hash:{},data:s}):(a=t.renderEmptyInfo,a=typeof a===o?a.apply(t):a),(a||0===a)&&(r+=a),r+="\n          </div>\n      </div>\n    </div>\n  </div>\n  \n</div>\n"})}),define("view/tasklist/base",["require","exports","module","configs/settings","configs/status","configs/dict","lang/index","utils/hash","utils/dom","utils/condition","offline/storage","utils/log","utils/index","dao/taskdb","service/task","service/sort","utils/print","service/filter","utils/limit-lab","collection/multi-tasks","view/taskdetail/single","view/taskdetail/multi","collection/section","view/section/title","view/section/completed","view/section/today","view/section/overdue","view/section/tomorrow","view/section/no-date","view/section/priority","view/section/order","view/section/project","view/section/next-7days","view/section/later","service/prefs","dao/projectdb","utils/analytics","view/project/share/index","view/project/activity/list","view/quick-add","service/userProfile","view/modal/verify-email","hbs!template/task_list_actionbar","hbs!template/task_list_bar","hbs!template/task_list"],function(e,t){
{var i=e("configs/settings"),n=e("configs/status"),s=e("configs/dict"),a=e("lang/index"),r=e("utils/hash"),o=e("utils/dom"),l=e("utils/condition"),d=e("offline/storage"),u=e("utils/log"),h=e("utils/index"),p=e("dao/taskdb").db,m=e("service/task"),f=e("service/sort").rank,g=e("utils/print"),v=e("service/filter").filter,y=e("utils/limit-lab"),k=e("collection/multi-tasks").Collection,w=e("view/taskdetail/single").View,b=e("view/taskdetail/multi").View,T=e("collection/section").Collection,I=e("view/section/title").View,C=e("view/section/completed").View,x=e("view/section/today").View,S=e("view/section/overdue").View,D=e("view/section/tomorrow").View,j=e("view/section/no-date").View,P=e("view/section/priority").View,M=e("view/section/order").View,A=e("view/section/project").View,V=e("view/section/next-7days").View,O=e("view/section/later").View,B=e("service/prefs"),N=e("dao/projectdb").db,E=e("utils/analytics"),R=e("view/project/share/index").View,L=e("view/project/activity/list").View,H=e("view/quick-add").View,U=e("service/userProfile");e("view/modal/verify-email").View}t.View=Backbone.View.extend({templateTaskListActionbar:e("hbs!template/task_list_actionbar"),templateTaskListBar:e("hbs!template/task_list_bar"),templateTaskList:e("hbs!template/task_list"),showListOnce:50,events:function(){return{"dragstart .task a":"disableDefaultDrag","keyup .task-new":"saveDraft","click #sortByDueDate":"sortByDueDate","click #sortByPriority":"sortByPriority","click #sortByTitle":"sortByTitle","click #sortByOrder":"sortBySortOrder","click #sortByAssignee":"sortByAssignee","click #sortByProject":"sortByProject","click #completed_tasks":"changeCompletedSectionStatus","click #project-filter-advance":"showProjectFilterAdvance","click #printCompleted":"printCompleted","click .show-more":"fetchMore","click .sort-by":"analySort","click a.shareProject":"shareProject","click a.print":"printProject","click a.projectActivity":"showProjectActivity"}},messages:function(){this.listenTo(Backbone,"rerenderActionBar",this.renderActionBar),this.listenTo(Backbone,"rerenderActionBarOnCheck",this.renderActionBarOnCheck),this.listenTo(Backbone,"resetActiveTask",this.resetActive),this.listenTo(Backbone,"scrollToTask",this.scrollToTask),this.listenTo(Backbone,"addToTaskdb",this.addToTaskdb),this.listenTo(Backbone,"showMoreCompletedTasks",this.showMoreCompletedTasks),this.listenTo(Backbone,"taskChanged",this.moveTaskCollection),this.listenTo(Backbone,"fetch",this.showIndicator),this.listenTo(Backbone,"refresh",this.refreshView),this.listenTo(Backbone,"advancePagination",this.advancePagination),this.listenTo(Backbone,"printProject",this.printProject)},initialize:function(e){this.initViewStatus(),this.initTaskListDom(),this.renderToolbar(),this.initDomValue(),this.initSubViews(),this.render(),this.afterRender()},afterRender:function(){this.renderCompletedStatus(),this.initScrollbar(),this.initThrottleFun(),this.initPagination(),this.openDetailOnTaskId(),this.resetTransition(),o.highlightList()},initTaskListDom:function(){$("#center-view").append(this.templateTaskList()),this.$el=$("#task-list-view")},initDomValue:function(){this.loadingView=this.$(".tl-loading"),this.taskListScrollView=this.$("#task-list-scroll"),this.taskListContentView=this.$("#task-list-content"),this.$taskListView=this.$("#task-list-view"),this.$detailView=this.$("#detail-view"),this.$taskUlList=this.$("#task-ul-list")},initSubViews:function(){this.subViews=[]},initThrottleFun:function(){this._throttleScroll=_.throttle(this.doScroll,7*i.throttleTime)},showIndicator:function(){o.showRefresh()},sortBy:function(e){var t={};return t[s.sortType.today]="sortByToday",t[s.sortType.week]="sortByWeek",t[s.sortType.trash]="sortByModifiedTime",t[s.sortType.assignee]="sortByAssignee",t[s.sortType.sortOrder]="sortBySortOrder",t[s.sortType.dueDate]="sortByDueDate",t[s.sortType.title]="sortByTitle",t[s.sortType.priority]="sortByPriority",t[s.sortType.project]="sortByProject",e?t[e]:t},fetchMore:function(){this.fetchCompletedTasks(),E.t_btn("view_more")},attachTaskUlAttr:function(){if(this.loadingView.hasClass("hide")){var e=0;for(var t in this.sectionCollectionMap)if(c=this.sectionCollectionMap[t],c){if(~t.indexOf(s.section.completed)&&"hide"==c.completedSectionStatus)continue;e+=c.length}e?this.$taskUlList.removeClass("empty-list"):this.$taskUlList.addClass("empty-list")}else this.$taskUlList.removeClass("empty-list")},analySort:function(e){var t=$(e.currentTarget),i=t.attr("id");E.t_sort(i)},addCompletedSection:function(e,t,i){var n=new T,a=this._getSectionArgs(n,t);i?(a.date=i,e[s.section.completed+"-"+i]=n):e[s.section.completed]=n,this.subViews.push(new C(a))},addTitleSection:function(e,t){var i=new T;e[s.section.title]=i,this.subViews.push(new I(this._getSectionArgs(i,t)))},addOverdueSection:function(e,t){var i=new T;e[s.section.overdue]=i,this.subViews.push(new S(this._getSectionArgs(i,t)))},addNoDateSection:function(e,t){var i=new T;e[s.section.noDate]=i,this.subViews.push(new j(this._getSectionArgs(i,t)))},addPrioriSection:function(e,t,i){var n=new T;e[s.section.priority+"-"+i]=n;var a=this._getSectionArgs(n,t);a.priorityValue=i,this.subViews.push(new P(a))},addTodaySection:function(e,t){var i=new T;e[s.section.today]=i,this.subViews.push(new x(this._getSectionArgs(i,t)))},addTomorrowSection:function(e,t){var i=new T;e[s.section.tomorrow]=i,this.subViews.push(new D(this._getSectionArgs(i,t)))},addNext7DaysSection:function(e,t){var i=new T;e[s.section.next7Days]=i,this.subViews.push(new V(this._getSectionArgs(i,t)))},addLaterSection:function(e,t){var i=new T;e[s.section.later]=i,this.subViews.push(new O(this._getSectionArgs(i,t)))},addOrderSection:function(e,t){var i=new T;e[s.section.order]=i,this.subViews.push(new M(this._getSectionArgs(i,t)))},addProjectSection:function(e,t,i,n){var a=new T;e[s.section.project+"-"+n]=a;var r=this._getSectionArgs(a,t);r.title=i,r.projectId=n,this.subViews.push(new A(r))},sortBySortOrder:function(){this._beforeAddSection(s.sortType.sortOrder),this.addOrderSection(this.sectionCollectionMap,this.tasks),this.addCompletedSection(this.sectionCollectionMap,this.tasks),this._afterAddSection()},sortByTitle:function(){this._beforeAddSection(s.sortType.title),this.addTitleSection(this.sectionCollectionMap,this.tasks),this.addCompletedSection(this.sectionCollectionMap,this.tasks),this._afterAddSection()},sortByPriority:function(){this._beforeAddSection(s.sortType.priority),this.addPrioriSection(this.sectionCollectionMap,this.tasks,s.priorityValue.high),this.addPrioriSection(this.sectionCollectionMap,this.tasks,s.priorityValue.medium),this.addPrioriSection(this.sectionCollectionMap,this.tasks,s.priorityValue.low),this.addPrioriSection(this.sectionCollectionMap,this.tasks,s.priorityValue.none),this.addCompletedSection(this.sectionCollectionMap,this.tasks),this._afterAddSection()},sortByDueDate:function(){r.isInToday()?this.sortByToday(s.sortType.dueDate):r.isInWeek()?this.sortByWeek(s.sortType.dueDate):(this._beforeAddSection(s.sortType.dueDate),this.addOverdueSection(this.sectionCollectionMap,this.tasks),this.addTodaySection(this.sectionCollectionMap,this.tasks),this.addTomorrowSection(this.sectionCollectionMap,this.tasks),this.addNext7DaysSection(this.sectionCollectionMap,this.tasks),this.addLaterSection(this.sectionCollectionMap,this.tasks),this.addNoDateSection(this.sectionCollectionMap,this.tasks),this.addCompletedSection(this.sectionCollectionMap,this.tasks),this._afterAddSection())},sortByProject:function(){var e=this.getProjects();this._beforeAddSection(s.sortType.project),_.each(e,function(e){this.addProjectSection(this.sectionCollectionMap,this.tasks,e.get("name"),e.get("id"))},this),this.addCompletedSection(this.sectionCollectionMap,this.tasks),this._afterAddSection()},_beforeAddSection:function(e){this._initStopAdvancePagination(),this.tasks=this.preloadTasks(!0),this.sectionCollectionMap={},!!e&&this.changeSortBy(e),this._clearSubViews(),this.hideLoadingView()},_afterAddSection:function(){this._renderSubViews(),this.attachTaskUlAttr()},refresh:function(){var e=this.preloadTasks();for(var t in this.sectionCollectionMap)if(c=this.sectionCollectionMap[t],c){var i=_.filter(e,c.selfFilter,c);this._removeLocalTasks(c,i),c.add(i.sort(c.comparator),{merge:!0})}},_removeLocalTasks:function(e,t){var i=_.difference(e.pluck("id"),_.pluck(t,"id"));_.each(i,function(t){var i=e.where({id:t});e.remove(i)},this)},_getSectionArgs:function(e,t){return{parentView:this,collection:e,tasks:t}},getProjectIds:function(){var e=this.getProjects();return _.pluck(e,"id")},getProjects:function(){var e=[];return e=r.isInProjectGroup()?N.getProjectsByGroupId(this.project.get("id")):r.isInAssignedMe()?_.filter(N.getProjects(),function(e){return e.get("closed")?!1:e.isShared()?!0:!1}):r.isInTagView()?_.filter(N.getProjectsWithInbox(),function(e){return e.get("closed")?!1:!0}):_.filter(N.getProjectsWithInbox(),function(e){return e.get("closed")||!e.get("inAll")?!1:!0}),e.sort(f.projectOrder)},changeSortBy:function(e){n.CurrentSortType=e,this.saveSortTypeOfList()},saveSortTypeOfList:function(){var e=s.cachePath,t=n.CurrentSortType;r.isInAssignedMe()?(d.setCacheItem(e.sortTypeAssignedMe,t),N.getSmartProjectById("assignedme").set("sortType",t),B.setSortTypeOfAssignedMe(t)):r.isInToday()?(d.setCacheItem(e.sortTypeToday,t),N.getSmartProjectById("today").set("sortType",t),B.setSortTypeOfToday(t)):r.isInWeek()?(d.setCacheItem(e.sortTypeWeek,t),N.getSmartProjectById("week").set("sortType",t),B.setSortTypeOfWeek(t)):r.isInTagView()?d.setCacheItem(this.getCachePath(),t):"tasks"==this.project.id||l.isCalendarProject(this.project.get("type"))?(d.setCacheItem(e.sortTypeAll,t),N.getSmartProjectById("tasks").set("sortType",t),B.setSortTypeOfAllProject(t)):this.project.id==U.get("inboxId")?(d.setCacheItem(e.sortTypeInbox,t),N.getProjectById(U.get("inboxId")).set("sortType",t),B.setSortTypeOfInbox(t)):(d.setCacheItem(e.sortTypeList+this.project.id,t),this.project.saveSortType(t))},hasTaskInView:function(){if(this.sectionCollectionMap)for(var e in this.sectionCollectionMap)if(c=this.sectionCollectionMap[e],c.models.length>0)return!0;return!1},moveTaskCollection:function(e,t){if(e&&this.sectionCollectionMap){var i,n,s=e,a=e.prviousModel(),o=!0,l=!0;r.isInTagView()&&(o=_.filter([s],v.tag.bind(this)).length,l=_.filter([a],v.tag.bind(this)).length),r.isInToday()&&(o=_.filter([s],v.getTodayAndOverdueTasks.bind(this)).length,l=_.filter([a],v.getTodayAndOverdueTasks.bind(this)).length),r.isInWeek()&&(o=_.filter([s],v.getWeekAndOverdueTasks.bind(this)).length,l=_.filter([a],v.getWeekAndOverdueTasks.bind(this)).length);for(var d in this.sectionCollectionMap)c=this.sectionCollectionMap[d],o&&!n&&_.filter([s],c.selfFilter,c).length>0&&(n=c),l&&!i&&_.filter([a],c.selfFilter,c).length>0&&(i=c);(n||i)&&(t||i!==n||!this._isSameIndex(i,s,a)||s.get("isSubTask"))&&(this._isNeedToRemove(s)&&i&&i.remove(s),this._isNeedToAdd(s)&&n&&n.add(s,{merge:!0}),this.attachTaskUlAttr())}},_isSameIndex:function(e,t,i){var n=e.clone();n.comparator=e.comparator,n.remove(i),n.add(i);var s=n.indexOf(i);n.remove(i),n.add(t);var a=n.indexOf(t);return s===a&&~s?!0:!1},_isNeedToAdd:function(e){return r.isInSmartProjectView()?!0:r.isInTagView()?!0:r.isInSearchView()?!0:r.isInProjectView()?this.project.get("id")===e.get("projectId"):r.isInProjectGroup()?-1!==this.getProjectIds().indexOf(e.get("projectId")):r.isInDateView()?!0:!0},_isNeedToRemove:function(e){return e.isNew()?!1:!0},showMoreCompletedTasks:function(e,t){var i=30,n=this.sectionCollectionMap[s.section.completed];n&&(n.add(_.filter(e,n.selfFilter,n),{merge:!0}),(!e||e.length<i||t)&&(this.hideLoadingView(),this.noMore=!0))},refreshView:function(){r.isInCompleted()||r.isInTrash()||o.hideRefresh(),this.refresh(),this.attachTaskUlAttr()},openDetailOnTaskId:function(){if(this.taskId){var e=p.getById(this.taskId),t=this;e?(setTimeout(function(){t.loadTaskDetailView(t.taskId)}),e.trigger("toggleActive placeCaretAtEnd")):setTimeout(function(){t.loadTaskDetailView(t.taskId)},100)}},initPagination:function(){var e=this;this.firstTime=!0,this.top=$(window).scrollTop(),this.taskListScrollView.on("scroll",function(){e._throttleScroll()}).on("scrollstart",function(){e.doScrollStart()}).on("scrollstop",function(){e.doScrollStop()})},doScrollStart:function(){this.$el.addClass("scrolling")},doScrollStop:function(){0===this.taskListScrollView.scrollTop()&&this.$el.removeClass("scrolling")},doScroll:function(){try{this.pagination(),this.advancePagination()}catch(e){u.log(e)}},advancePagination:function(e){e?this._controlRenderTaskItems(e):this._isScrollToBottom()&&!this.stopAdvancePagination?(this._stopAdvancePagination(),this._controlRenderTaskItems(2e3)):this._isScrollDown()&&!this.stopAdvancePagination&&this._controlRenderTaskItems(this.calculateShowTaskItemCount())},calculateShowTaskItemCount:function(){for(var e,t=35,i=0,n=0;e=this.subViews[n++];){var s=e.isSectionOpen()?e.getRenderItemCount():0;if(s&&(i+=s*t+t),s<e.collection.length)break}var a=this.taskListScrollView.scrollTop()+this.taskListScrollView.height(),r=i-a;return r>50*t?0:0>r?60-r/t:void 0},pagination:function(){this.isShowNextPagination()&&this._isScrollDown()&&this._isScrollToBottom()&&(r.isInTrash()?this.fetchTrashTasks():this.fetchCompletedTasks())},_initStopAdvancePagination:function(){this.stopAdvancePagination=!1},_stopAdvancePagination:function(){this.stopAdvancePagination=!0},_isScrollToBottom:function(){var e=this.taskListScrollView.scrollTop(),t=this.taskListScrollView.height()+this.loadingView.height()+e,i=t>=this.taskListContentView.height();return i},_isScrollDown:function(){var e=this.taskListScrollView.scrollTop(),t=this.top<=e;return this.top=e,t},isShowNextPagination:function(){var e=this.sectionCollectionMap[s.section.completed]||[];return!r.isInCompleted()&&!r.isInTrash()&&e.length<30||this.noMore?!1:!0},showLoadingView:function(){this.loadingView.removeClass("hide"),this.attachTaskUlAttr(),this.hideNoMoreView()},hideLoadingView:function(){this.loadingView.addClass("hide"),this.attachTaskUlAttr()},hideNoMoreView:function(){this.$(".show-more").hide()},scrollToTask:function(e){for(var t,i=0,n=0;t=this.subViews[n++];){var s=t.getHeightBetweenTopAndTask(e);if(i+=s.height,s.isExist)break}var a=this.$("#task-ul-list .antiscroll-inner");a.scrollTop(0);var r=i-a.height()/2;a.scrollTop(r)},addToTaskdb:function(e){p.add(e)},createTaskDetailView:function(e,t){this.taskDetailView=new w({model:e}),t||e.get("deleted")||m.getTaskFromServerById(e.id,e.get("projectId"),function(e){})},loadTaskDetailView:function(e,t){this.taskDetailView&&this.taskDetailView.onClose(),this.projectActivityView&&this.projectActivityView.onClose();var i=$("#task-ul-list ul>li.selected").not(".ui-sortable-placeholder");if(i.length>1){var n=new k;_.each(i,function(e){var t=p.getById($(e).find("a[taskid]").attr("taskid"));n.add(t)},this),this.taskDetailView=new b({collection:n}),n=null}else{var s=p.getById(e);if(s||(t=!0),l.isSubscribeCalendarTask(s))return void this.createTaskDetailView(s,!0);if(s)this.createTaskDetailView(s,t);else if(_.isUndefined(s)){var a=this;m.getTaskFromServerById(e,r.getProjectIdByUrl(),function(e){a.taskDetailView=new w({model:e}),o.showMobileDetail()})}else m.getTaskFromServerById(e,s.get("projectId"),this.createTaskDetailView);s=null}},saveDraft:function(){d.setStoreInfo("new_draft",$(".task-new").text()||"")},resetActive:function(){$("#task-ul-list > .content > section > ul").children().removeClass("active")},restoreQuickAddContent:function(){var e=d.getStoreInfo("new_draft")||"";$(".task-new").text(e),!e&&$(".task-new").addClass("show-placeholder")},initScrollbar:function(){this.$(".antiscroll-wrap").antiscroll()},getCompletedSectionStatus:function(){if(!r.isInCompleted()&&!r.isInTrash()){var e=d.getStoreInfo(s.completedSectionStatus.storePath);return e}},hideCompletedSection:function(){d.setStoreInfo(s.completedSectionStatus.storePath,"hide"),E.t_menu("hide_completed")},showCompletedSection:function(){d.setStoreInfo(s.completedSectionStatus.storePath,"show"),E.t_menu("show_completed")},renderToolbar:function(){this._renderTaskListBar(),this._renderTaskListActionbar(),this.renderQuickAddView()},renderQuickAddView:function(){this.quickAddView=new H},_renderTaskListActionbar:function(e){var t={sortType:n.CurrentSortType,iconClass:this._currentIcon(),sortByList:this.supportSortByList||[]};_.extend(t,e);var i=this.templateTaskListActionbar(t);this.$("#task-action-bar").html(i)},_currentIcon:function(){var e=s.icon[n.CurrentSortType]||"icon-active-sort-order",t=h.svgIcon(e,"i-2-1 fast-transition");return r.isInDateView()&&(t=""),t},_getRenderData:function(){return{project:this.project?this.project.toJSON():{name:this.name}}},_renderTaskListBar:function(){var e=this._getRenderData();this.$(".tl-bar").prepend(this.templateTaskListBar(e))},disableDefaultDrag:function(){return!1},_clearSubViews:function(){$(".content").addClass("hide"),sections=this.$("#task-ul-list .content section").detach();var e=this.subViews.concat();setTimeout(function(){sections.remove(),_.each(e,function(e){e.close(),e=null,delete e})},0),this.subViews=[]},_renderSubViews:function(){var e=$(".content");e.addClass("hide"),this._controlRenderSubViews(),this._renderTaskListActionbar(),this.restoreQuickAddContent(),e.removeClass("hide")},_controlRenderSubViews:function(e){var e=e||this.showListOnce,t=[];_.each(this.subViews,function(i){var n=i.render(e);e-=n.hasShowCount,t.push(n.el)},this),this.$("#task-ul-list .content").append(t)},_controlRenderTaskItems:function(e){if(0!==e){var e=e||this.showListOnce;_.each(this.subViews,function(t){e-=t.renderTaskItems(e).hasShowCount})}},renderCompletedStatus:function(){var e=this.getCompletedSectionStatus(),t=a.get("hide"==e?"show_completed":"hide_completed");this.$(".completed-status .text").text(t)},changeCompletedSectionStatus:function(){var e=this.getCompletedSectionStatus();if("hide"==e?this.showCompletedSection():this.hideCompletedSection(),Backbone.trigger("updateCompletedSectionStatus"),"hide"==e){var t=this.$el.find("section.completed");this.taskListScrollView.scrollTo(t,800)}this.renderCompletedStatus(),this.attachTaskUlAttr()},clearDetailView:function(){this.$detailView.empty()},initViewStatus:function(){n.viewStatus={}},transitionClose:function(){this.$taskListView.css("opacity",0)},resetTransition:function(){this.$taskListView.css("opacity",1)},onClose:function(){this._clearSubViews(),this.taskDetailView&&this.taskDetailView.onClose(),this.projectActivityView&&this.projectActivityView.onClose(),this._onClose&&this._onClose(),this.$(".tl-bar").children().remove(),this.$(".tl-body").children().remove(),this.quickAddView&&this.quickAddView.onClose(),this.remove()},printProject:function(){this.advancePagination(2e3),g.printTasks(),E.l_list("print")},shareProject:function(){new R({model:this.project}),E.l_list("share")},showProjectActivity:function(){var e=this;y.checkPro("project_activity",function(){e.projectActivityView&&e.projectActivityView.onClose(),e.projectActivityView=new L({model:e.project}),e.initScrollbar(),setTimeout(o.showMobileDetail,100)}),E.l_list("project_activity")},renderProjectTitleName:function(){var e=this.project.get("name");$("#project-name-bar h5").text(e)}})}),define("view/section/assigned",["require","exports","module","service/filter","lang/index","utils/log","view/section/base","utils/server","service/sort","dao/shareduserdb","service/userProfile"],function(e,t){var i=e("service/filter"),n=e("lang/index"),s=e("utils/log"),a=e("view/section/base").View,r=e("utils/server"),o=e("service/sort").rank,l=e("dao/shareduserdb").db,c=e("service/userProfile");t.View=a.extend({drop:function(e){var t=[];_.each(e,function(e){e.trigger("dropOnAssigneeSection",this.assignee),t.push({projectId:e.get("projectId"),taskId:e.get("id"),assignee:this.assignee})},this),r.assign(JSON.stringify(t),function(e){_.isEmpty(e.id2error)||s.log(e.id2error)})},createOnEnterProperties:function(){return{assignee:this.assignee}},initialize:function(e){this.assignee=parseInt(e.assignee),e.collection.assignee=this.assignee,this.events=_.extend({},a.prototype.events,this.events),this.constructor.__super__.initialize.apply(this,[e])},initAssignee:function(){if(null!==this.assignee&&-1!==this.assignee){this.className="assigned",this.filter=i.filter.assigned;var e=l.getUserById(this.assignee);if(e){var t=e.get(e.get("displayName")?"displayName":"username");c.get("userId")===e.get("userId")&&(t=n.get("me")),this.title=t}}else this.className="no-assigned",this.filter=i.filter.noAssigned,this.title=n.get("no_assigned_group")},initProps:function(){this.sortBy=o.assignee,this.initAssignee(),this.initDropOrSort()},initDropOrSort:function(){this.canDrop=!0,this.canSort=!1}})}),define("view/tasklist/project",["require","exports","module","configs/status","configs/dict","lang/index","service/filter","utils/dom","utils/hash","utils/timeformat","utils/log","dao/shareduserdb","dao/taskdb","service/task","view/tasklist/base","utils/server","service/project","view/section/assigned","collection/section","service/userProfile"],function(e,t){var i=e("configs/status"),n=e("configs/dict"),s=(e("lang/index"),e("service/filter")),a=e("utils/dom"),r=(e("utils/hash"),e("utils/timeformat"),e("utils/log")),o=e("dao/shareduserdb"),l=e("dao/taskdb"),c=e("service/task"),d=e("view/tasklist/base").View,u=e("utils/server"),h=(e("service/project"),e("view/section/assigned").View),p=e("collection/section").Collection,m=e("service/userProfile");t.View=d.extend({events:function(){return d.prototype.events.call(this)},messages:function(){this.listenTo(this.project,"destroy",this.closeAndNavigateToAllList),this.listenTo(this.project,"change:userCount",this.userCountChanged),this.listenTo(o.db.collection,"refreshUserCollection",this.refreshSortByAssignee),this.constructor.__super__.messages&&this.constructor.__super__.messages.call(this)},initialize:function(e){this.projectNameTemplate=this.templateProjectNameActionbar,this.project=e.project,this.taskId=e.taskId,this.messages(),this.initSupportSort(),this.constructor.__super__.initialize.apply(this,[e])},render:function(){return this[this.sortBy(i.CurrentSortType||n.sortType.sortOrder)](!0),this.clearDetailView(),this},initSupportSort:function(){this.supportSortByList=["byOrder","byDueDate","byTitle","byPriority"],this.isSharedProject()&&this.supportSortByList.push("byAssignee")},addAssigneeSection:function(e,t,i){var s=new p;e[n.section.assigned+"-"+i]=s;var a=this._getSectionArgs(s,t);a.assignee=i,this.subViews.push(new h(a))},sortByAssignee:function(e){this._beforeAddSection(n.sortType.assignee);var t=o.db.getUsersByProject(this.project,e);this.addAssigneeSection(this.sectionCollectionMap,this.tasks,m.get("userId")),_.each(t,function(e){e.get("userId")&&e.get("userId")!=m.get("userId")&&this.addAssigneeSection(this.sectionCollectionMap,this.tasks,e.get("userId"))},this),this.addAssigneeSection(this.sectionCollectionMap,this.tasks,-1),this.addCompletedSection(this.sectionCollectionMap,this.tasks),this._afterAddSection()},refreshSortByAssignee:function(){i.CurrentSortType===n.sortType.assignee&&this.sortByAssignee(!1)},fetchCompletedTasks:function(){c.fetchCompletedTasksPagination(this.project.id,30,this.firstTime),this.firstTime=!1,this.showLoadingView()},_setSelectedTasks:function(e){var t=e?a.selected_tasks():a.selectedTasksNotDrag();return _.each(t,function(e){var t=$(e).closest(".task-sortable-by-date");if(t.length){var i=t.attr("date");$(e).attr("date",i)}}),t},setMinTaskSortOrder:function(e){var t,i=0;_.each(e,function(e,n){t=e.get("projectId"),i=c.getMinSortOrder(t),e.set({sortOrder:i})})},closeAndNavigateToAllList:function(){this.close(),Backbone.trigger("navigateToAllList")},preloadTasks:function(e){return c.getTodoTasksByProjectId(this.project.id,e)},loadTrashTasks:function(){return l.db.collection.filter(s.filter.deleted)},refreshCalendarViewToday:function(){this.taskCalendatview&&this.taskCalendatview.setToday(new Date)},isSharedProject:function(){return this.project.get("userCount")>1},userCountChanged:function(){if(!this.isSharedProject()){this.initSupportSort(),this._renderTaskListActionbar();var e=l.db.getTasksByAssignee(m.get("userId"),this.project.id),t=[];_.each(e,function(e){-1==e.get("assignee")&&e.get("assignee")||t.push({projectId:e.get("projectId"),taskId:e.get("id"),assignee:-1}),e.set("assignee",null)});var s=this;u.assign(JSON.stringify(t),function(e){_.isEmpty(e.id2error)||r.log(e.id2error),i.CurrentSortType===n.sortType.assignee&&s.sortBySortOrder()})}}})}),define("view/section/week",["require","exports","module","service/filter","utils/timeformat","view/section/date-sort","service/sort","configs/dict","service/prefs"],function(e,t){var i=e("service/filter"),n=e("utils/timeformat"),s=e("view/section/date-sort").View,a=(e("service/sort").rank,e("configs/dict")),r=e("service/prefs");t.View=s.extend({filter:i.filter.week,className:"week task-sortable-by-date sortable",initialize:function(e){this.dayOffset=e.weekValue,this.parentView=e.parentView;var t=n.prefMoment().add("days",this.dayOffset),i=r.get("startDayOfWeek");this.dueDate=t.format(a.format.dateTime),this.initDate(e.weekValue),e.collection.dayOffset=this.dayOffset,this.title=this.title||n.formatToWeek(t,i),this.date=t.format("YYYYMMDD"),this.events=_.extend({},s.prototype.events,this.events),this.constructor.__super__.constructor.__super__.initialize.apply(this,[e])},initDate:function(e){var t={};t[a.weekValue.first]=function(){this.className="first_day task-sortable-by-date sortable"},t[a.weekValue.second]=function(){this.className="second_day task-sortable-by-date sortable"},t[a.weekValue.third]=function(){this.className="third_day task-sortable-by-date sortable"},t[a.weekValue.forth]=function(){this.className="forth_day task-sortable-by-date sortable"},t[a.weekValue.fifth]=function(){this.className="fifth_day task-sortable-by-date sortable"},t[a.weekValue.sixth]=function(){this.className="sixth_day task-sortable-by-date sortable"},t[a.weekValue.seventh]=function(){this.className="seventh_day task-sortable-by-date sortable"},t[e].call(this)}})}),define("view/section/trash",["require","exports","module","service/filter","view/section/base","service/sort","dao/order_by_date"],function(e,t){var i=e("service/filter"),n=e("view/section/base").View,s=e("service/sort"),a=e("dao/order_by_date").db;t.View=n.extend({filter:i.filter.deleted,className:"trash-group trash",message:function(){this.listenTo(Backbone,"updateTaskOrderFromRestore",this.updateTaskOrderFromRestore)},updateTaskOrderFromRestore:function(e,t){a.updateTaskOrderFromRestore(e,t)},initialize:function(e){this.events=_.extend({},n.prototype.events,this.events),this.constructor.__super__.initialize.apply(this,[e]),this.message()},initProps:function(){this.sortBy=s.rank.modifiedTime,this.initDropOrSort()},initDropOrSort:function(){this.canDrop=!1,this.canSort=!1}})}),define("hbs!template/trash_confirm_clear",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o="",l=i.helperMissing,c=this.escapeExpression;return o+='<div class="popup-header">\n    <a class="popup-close">&times;</a>\n    <h1 class="popup-title text-lrg text-primary">\n      ',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"clear_trash",r):l.call(t,"I18n","clear_trash",r)))+'\n    </h1>\n</div>\n\n<div class="popup-body">\n    <span class="line-sml">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"clear_trash_intro",r):l.call(t,"I18n","clear_trash_intro",r)))+'</span>\n    <p class="conform-clear line-sml">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"confirm_clear_trash",r):l.call(t,"I18n","confirm_clear_trash",r)))+'</p>\n</div>\n\n<div class="popup-footer">\n    <button type="button" class="cancel btn-med btn-cancel">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"cancel",r):l.call(t,"I18n","cancel",r)))+'</button>\n    <button type="button" class="confirm btn-med btn-primary">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"ok",r):l.call(t,"I18n","ok",r)))+"</button>\n</div>\n"})}),define("view/modal/clear-trash",["require","exports","module","dao/taskdb","modules/popup/popup","hbs!template/trash_confirm_clear"],function(e,t){var i=e("dao/taskdb"),n=e("modules/popup/popup").View;t.View=Backbone.View.extend({id:"trash-confirm-clear-view",template:e("hbs!template/trash_confirm_clear"),events:{"click .btn-primary":"clearTrash","click .btn-cancel":"closeView"},initialize:function(){this.render()},clearTrash:function(){i.db.clearTrash(),$("#clearTrash").removeClass("on"),this.model.hideLoadingView(),this.model.$el.find("#task-list-content").hide(),Backbone.trigger("closeDetailView"),this.closeView()},closeView:function(){this.popupView.onRemove()},render:function(){this.$el.html(this.template({})),this.popupView=new n({view:this})},focusCancel:function(){}})}),define("view/tasklist/smart-project",["require","exports","module","view/tasklist/base","service/task","configs/dict","configs/status","utils/hash","utils/timeformat","lang/index","collection/section","view/section/week","view/section/trash","dao/scalendardb","view/modal/clear-trash","utils/log","utils/analytics","data-sync/index","service/prefs"],function(e,t){var i=e("view/tasklist/base").View,n=e("service/task"),s=e("configs/dict"),a=e("configs/status"),r=e("utils/hash"),o=(e("utils/timeformat"),e("lang/index")),l=e("collection/section").Collection,c=e("view/section/week").View,d=e("view/section/trash").View,u=e("dao/scalendardb"),h=e("view/modal/clear-trash").View,p=e("utils/log"),m=e("utils/analytics"),f=e("data-sync/index"),g=e("service/prefs");t.View=i.extend({events:function(){return _.extend(i.prototype.events.call(this),{"click #clearTrash":"clearTrash"})},messages:function(){r.isInSubscribeCalendars()&&this.listenTo(this.project,"change:name",this.renderProjectTitleName),this.listenTo(Backbone,"showMoreTrashTasks",this.showMoreTrashTasks),this.constructor.__super__.messages&&this.constructor.__super__.messages.call(this)},initialize:function(e){_.extend(this,e),this.messages(),this.initSupportSort(),this.constructor.__super__.initialize.apply(this,[e])},render:function(){var e=r.isInProjectAll()?g.getSortTypeOfAllProject():a.CurrentSortType;try{this[this.sortBy(e)]()}catch(t){this.sortByDueDate(),p.log(t)}},initSupportSort:function(){this.supportSortByList=["byList","byDueDate","byTitle","byPriority"]},addWeekSection:function(e,t,i){var n=new l;e[s.section.priority+"-"+i]=n;var a=this._getSectionArgs(n,t);a.weekValue=i,this.subViews.push(new c(a))},addTrashSection:function(e,t){var i=new l;e[s.section.trash]=i,this.subViews.push(new d(this._getSectionArgs(i,t)))},sortByToday:function(e){this._beforeAddSection(e),this.addTodaySection(this.sectionCollectionMap,this.tasks),this.addOverdueSection(this.sectionCollectionMap,this.tasks),this.addCompletedSection(this.sectionCollectionMap,this.tasks),this._afterAddSection()},sortByWeek:function(e){this._beforeAddSection(e),this.addOverdueSection(this.sectionCollectionMap,this.tasks),this.addWeekSection(this.sectionCollectionMap,this.tasks,s.weekValue.first),this.addWeekSection(this.sectionCollectionMap,this.tasks,s.weekValue.second),this.addWeekSection(this.sectionCollectionMap,this.tasks,s.weekValue.third),this.addWeekSection(this.sectionCollectionMap,this.tasks,s.weekValue.forth),this.addWeekSection(this.sectionCollectionMap,this.tasks,s.weekValue.fifth),this.addWeekSection(this.sectionCollectionMap,this.tasks,s.weekValue.sixth),this.addWeekSection(this.sectionCollectionMap,this.tasks,s.weekValue.seventh),this.addCompletedSection(this.sectionCollectionMap,this.tasks),this._afterAddSection()},sortByModifiedTime:function(){this._beforeAddSection(),this.addTrashSection(this.sectionCollectionMap,this.tasks),this._afterAddSection(),this.showLoadingView()},fetchCompletedTasks:function(){r.isInCompleted()&&n.fetchCompletedTasksPagination(this.project.id,50),r.isInProjectAll()&&n.fetchCompletedTasksPagination(this.project.id,30,this.firstTime,!0),
(r.isInToday()||r.isInWeek())&&n.fetchCompletedTasksPagination(this.project.id,30,this.firstTime,!0,!0),this.firstTime=!1,this.showLoadingView()},fetchTrashTasks:function(){n.fetchTrashTasksPagination(this.project.id,50),this.showLoadingView()},check:function(){f.once()},preloadTasks:function(e){if(r.isInTrash())return n.getTrashTasksInLocal();if(r.isInSubscribeCalendars())return u.db.getCalendar(e,this.project.id);if(r.isInAssignedMe())return this.check(),n.getAssignedMeTasks();var t=null;t=r.isInToday()?n.getTodayAndOverdueTasks(e):r.isInWeek()?n.getWeekAndOverdueTasks(e):n.getTodoTasksByProjectId(this.project.id,e);var i=!0;return t=t.concat(u.db.getAllCalendar(e,i))},showMoreTrashTasks:function(e,t){var i=this.sectionCollectionMap[s.section.trash];t&&this._removeLocalTasks(i,e),i.add(e,{merge:!0}),e&&e.length<50&&(this.hideLoadingView(),this.noMore=!0)},clearTrash:function(){new h({model:this})},_showTrashOverLimit:function(){this.$("p.alert-info").text(o.get("trash_over_limit")).show()},printCompleted:function(){window.print(),m.f_print()}})}),define("view/section/choose-date",["require","exports","module","service/filter","configs/dict","utils/timeformat","view/section/base","service/sort"],function(e,t){var i=e("service/filter"),n=e("configs/dict"),s=e("utils/timeformat"),a=e("view/section/base").View,r=e("service/sort").rank;t.View=a.extend({className:"choose-date",filter:i.filter.chooseDate,drop:function(e){_.each(e,function(e){e.save({status:0})},this)},createOnEnterProperties:function(){return{dueDate:s.dateToMoment(this.chooseDate).format(n.format.atomTime)}},initialize:function(e){e.collection.chooseDate=e.chooseDate,this.events=_.extend({},a.prototype.events,this.events),this.constructor.__super__.initialize.apply(this,[e])},initProps:function(){this.sortBy=r.mincalendar,this.date=s.dateToMoment(this.chooseDate).format("YYYYMMDD"),this.initDropOrSort(),this.initDomAttr()},initDomAttr:function(){this.el.setAttribute("date",this.date)},initDropOrSort:function(){this.canDrop=!0,this.canSort=!1}})}),define("view/tasklist/date",["require","exports","module","lang/index","utils/timeformat","service/task","view/tasklist/base","view/section/choose-date","collection/section","configs/dict"],function(e,t){var i=e("lang/index"),n=e("utils/timeformat"),s=e("service/task"),a=e("view/tasklist/base").View,r=e("view/section/choose-date").View,o=e("collection/section").Collection,l=e("configs/dict");t.View=a.extend({el:$("#task-list-view"),events:function(){return _.extend(a.prototype.events.call(this),{})},initialize:function(e){_.extend(this,e),this.name=this.date,this.date==n.formatToDateString(n.prefMoment())?this.name=i.get("today"):this.date==n.formatToDateString(n.prefMoment().add("days",1))&&(this.name=i.get("tomorrow")),this.initSupportSort(),this.constructor.__super__.initialize.apply(this,[e]),this.messages()},preloadTasks:function(e){return s.getTasksByDate(this.date,e)},initSupportSort:function(){this.supportSortByList=[]},render:function(e){return this.sortByDueDate(),this.hideLoadingView(),this},sortByDueDate:function(){this._beforeAddSection(),this.addChooseDateSection(this.sectionCollectionMap,this.tasks),this.addCompletedSection(this.sectionCollectionMap,this.tasks),this._afterAddSection()},addChooseDateSection:function(e,t){var i=new o;e[l.section.chooseDate]=i;var n=this._getSectionArgs(i,t);n.chooseDate=this.date,this.subViews.push(new r(n))}})}),define("view/section/search",["require","exports","module","service/filter","view/section/base","service/sort"],function(e,t){var i=e("service/filter").filter,n=e("view/section/base").View,s=e("service/sort").rank;t.View=n.extend({filter:i.search,className:"search",createOnEnterProperties:function(){return{}},initialize:function(e){this.events=_.extend({},n.prototype.events,this.events),this.constructor.__super__.initialize.apply(this,[e])},initProps:function(){this.sortBy=s.search,this.initDropOrSort()},initDropOrSort:function(){this.canDrop=!1,this.canSort=!0}})}),define("hbs!template/multi_select_project",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o="",l=i.helperMissing,c=this.escapeExpression;return o+='<div class="menu shadow ">\n    <div>\n        <div class="select-list antiscroll-inner"></div>\n    </div>\n    <div class="control">\n        <button class="btn btn-cancel btn-tny">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"cancel",r):l.call(t,"I18n","cancel",r)))+'</button>\n        <button class="btn btn-confirm btn-tny">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"ok",r):l.call(t,"I18n","ok",r)))+"</button>\n    </div>\n</div>\n\n"})}),define("modules/multi-select/project",["require","exports","module","dao/project-group","dao/projectdb","lang/index","utils/index","hbs!template/multi_select_project"],function(e,t){var i=e("dao/project-group").db,n=e("dao/projectdb").db,s=e("lang/index"),a=e("utils/index");t.View=Backbone.View.extend({className:"multi-select-menu",template:e("hbs!template/multi_select_project"),events:{"click .option-item":"selectItem","click .btn-cancel":"cancel","click .btn-confirm":"confirm"},messages:function(){var e=this;$("html").on("click.dropdown.data-api",function(){setTimeout(function(){e.renderScrollBar()})})},initialize:function(e){this.initData(e),this.render(),this.initDomAttr(),this.handleData(),this.renderList(),this.initEvent(),this.messages()},initEvent:function(){var e=this;$(document).on("click.filter.project",function(){e.close()}).on("click.filter.project",".multi-select-menu",function(e){e.stopPropagation()})},render:function(){this.$el.html(this.template())},renderScrollBar:function(){var e=this.$(".multi-select-menu");"none"!==e.css("display")&&e.antiscroll()},handleData:function(){var e=[];this.projects.map(function(t){t.get("closed")||e.push(t)}),this.projects=e;for(var t,i={},n=[],a=0;t=this.projects[a++];)if(t.get("closed"))n.push(t.toJSON());else if(t.get("groupId")){var r=i[t.get("groupId")];r=r||[],r.push(t.toJSON()),i[t.get("groupId")]=r}else this.items.push(t.toJSON());for(var o,a=0;o=this.groups[a++];)tg=o.toJSON(),tg.ps=i[tg.id],this.items.push(tg);this.items.sort(function(e,t){return~e.id.indexOf("inbox")&&"all-list"===t.id?1:~t.id.indexOf("inbox")&&"all-list"===e.id?-1:~e.id.indexOf("inbox")||"all-list"===e.id?-1:~t.id.indexOf("inbox")||"all-list"===t.id?1:e.sortOrder-t.sortOrder}),_.isEmpty(n)||this.items.push({id:"closed-list",name:s.get("closed_list"),ps:n}),this.items.map(function(e){return _.isEmpty(e.ps)?e:e.ps.sort(function(e,t){return e.sortOrder-t.sortOrder})})},handleSelectedDate:function(){for(var e,t={},i=0;e=this.selects[i++];)t[e.id]=!0;this.utilForItems(function(e){t[e.id]&&(e.selected=!0)}),this.selectAllItem(this.isAllSelected()?!0:!1);var n=this;this.utilForItems(function(e){"group"===e.listType&&(e.selected=n.isAllSelectedUnderGroup(e.id)?!0:!1)})},renderList:function(){var e=this.buildListHtml();this.$selectList.append(e)},renderSelectedStatus:function(){var e=this;this.utilForItems(function(t){t.selected?e.getItemById(t.id).addClass("selected-item"):e.getItemById(t.id).removeClass("selected-item")})},selectItem:function(e){e.stopPropagation();var t=$(e.target).attr("data-key"),i=this;this.utilForItems(function(e){if(e.id===t){if("all-list"==e.id)return void i.selectAll(i.isAllSelected()?!1:!0);e.selected=!e.selected,"group"===e.listType||"closed-list"===e.id?e.ps.map(function(t){t.selected=e.selected}):e.groupId&&(i.isAllSelectedUnderGroup(e.groupId)?i.selectGroup(e.groupId,!0):i.selectGroup(e.groupId,!1)),i.selectAllItem(i.isAllSelected()?!0:!1)}}),this.renderSelectedStatus(),this.confirmBtnStatus()},confirmBtnStatus:function(){this.isCancelAll()?this.$(".btn-confirm").addClass("disabled"):this.$(".btn-confirm").removeClass("disabled")},isCancelAll:function(){var e=this.getSelectItems();return 0===e.length?!0:!1},getSelectItems:function(){var e=[];return this.utilForItems(function(t){"all-list"!==t.id&&"closed-list"!==t.id&&"group"!==t.listType&&t.selected&&e.push(t)}),e},selectAllItem:function(e){this.utilForItems(function(t){"all-list"===t.id&&(t.selected=e)})},selectClosedItem:function(e){this.utilForItems(function(t){"closed-list"===t.id&&(t.selected=e)})},selectAll:function(e){this.utilForItems(function(t){t.selected=e})},selectGroup:function(e,t){this.utilForItems(function(i){i.id===e&&(i.selected=t)})},isAllSelected:function(){var e=this.getSelectItems();return e.length===this.projects.length?!0:!1},isAllSelectedUnderGroup:function(e){var t=!0;return this.utilForItems(function(i){i.id===e&&i.ps.map(function(e){e.selected||(t=!1)})}),t},getItemById:function(e){var t='.option-item[data-key="'+e+'"]';return this.$(t)},buildListHtml:function(){var e=[],t=this;return this.utilForItems(function(i){e.push("group"===i.listType?t.buildItemHtml("group-item",i.id,i.name,null,"l-folder"):i.groupId?t.buildItemHtml("project-item group-project-item",i.id,i.name,i.groupId):"all-list"==i.id?t.buildItemHtml("project-item",i.id,i.name,null,"all-list"):"closed-list"==i.id?t.buildItemHtml("project-item",i.id,i.name,null,"closed-list"):i.closed?t.buildItemHtml("project-item group-project-item",i.id,i.name):t.buildItemHtml("project-item",i.id,i.name))}),e.join("")},buildItemHtml:function(e,t,i,n,s){var a="<div class='option-item %s1' data-key='%s2' %s4 >%s5%s3</div>",r="";return n&&(r="data-group='"+n+"'"),a.replace(/\%s1/,e).replace(/\%s2/,t).replace(/\%s3/,i).replace(/\%s4/,r).replace(/\%s5/,this.getIconDom(t,s))},getIconDom:function(e,t){var i=n.getProjectById(e);if(!i){if("all-list"===t)return a.svgIcon("icon-folder-all-list","i-3");if("l-folder"===t)return a.svgIcon("icon-folder","i-3");if("closed-list"===t)return a.svgIcon("icon-closed-list","i-3")}return"group"===i.get("listType")?a.svgIcon("icon-folder","i-3"):i.get("userCount")>1?a.svgIcon("icon-share-list","i-3"):a.svgIcon("icon-normal-list","i-3")},initData:function(e){_.extend(this,e),this.selects=this.selects||[],this.projects=this.projects||[],this.groups=i.getGroupsNotEmpty()||[],this.items=[{id:"all-list",name:s.get("all_list")}]},initDomAttr:function(){this.$selectList=this.$(".select-list")},utilForItems:function(e){for(var t,i=0;t=this.items[i++];)if(e&&e(t),!_.isEmpty(t.ps))for(var n,s=0;n=t.ps[s++];)e&&e(n)},cancel:function(){this.selectAll(!1),this.close()},confirm:function(){this.isCancelAll()||(this.action&&this.action(this.getSelectItems()),this.close())},open:function(e){e&&(this.selects=e),this.handleSelectedDate(),this.renderSelectedStatus(),this.confirmBtnStatus()},close:function(){this.$el.parent().removeClass("open"),$(document).off("click.filter.project").off("click.filter.project",".multi-select-menu"),$("html").on("click.dropdown.data-api")}})}),define("hbs!template/filter_component",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){var n,s,a="";return a+='\n        <li data-key="lastWeek"><a>',s={hash:{},data:t},a+=f((n=i.I18n,n?n.call(e,"last_week",s):m.call(e,"I18n","last_week",s)))+"</a></li>\n        "}function r(e,t){var n,s,a="";return a+="\n                    ",s={hash:{},data:t},a+=f((n=i.I18n,n?n.call(e,"other_month",s):m.call(e,"I18n","other_month",s)))+"\n                "}function o(e,t){var n,s,a="";return a+="\n                    ",s={hash:{},data:t},a+=f((n=i.I18n,n?n.call(e,"custom",s):m.call(e,"I18n","custom",s)))+"\n                "}function l(e,t){var n,s,a="";return a+='\n<div class="dropdown filter-status">\n    <a class="dropdown-toggle selected-title direct down" data-toggle="dropdown">\n        ',s={hash:{},data:t},a+=f((n=i.I18n,n?n.call(e,"all_status",s):m.call(e,"I18n","all_status",s)))+'\n    </a>\n    <ul class="dropdown-menu">\n        <li class="active" data-key="allStatus"><a>',s={hash:{},data:t},a+=f((n=i.I18n,n?n.call(e,"all_status",s):m.call(e,"I18n","all_status",s)))+'</a></li>\n        <li data-key="undone"><a>',s={hash:{},data:t},a+=f((n=i.I18n,n?n.call(e,"undone",s):m.call(e,"I18n","undone",s)))+'</a></li>\n        <li data-key="completed"><a>',s={hash:{},data:t},a+=f((n=i.I18n,n?n.call(e,"completed",s):m.call(e,"I18n","completed",s)))+"</a></li>\n    </ul>\n</div>\n"}function c(e,t){var n,s,a="";return a+='\n    ,<span class="print-item print-status">',s={hash:{},data:t},a+=f((n=i.I18n,n?n.call(e,"all_status",s):m.call(e,"I18n","all_status",s)))+"</span>\n    "}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var d,u,h,p="",m=i.helperMissing,f=this.escapeExpression,g=this,v="function",y=i.blockHelperMissing;return p+='<div class="dropdown filter-duedate">\n    <a class="dropdown-toggle selected-title direct down" data-toggle="dropdown">\n        ',h={hash:{},data:s},p+=f((d=i.I18n,d?d.call(t,"all_time",h):m.call(t,"I18n","all_time",h)))+' \n    </a>\n    <ul class="dropdown-menu">\n        <li class="active" data-key="allTime"><a>',h={hash:{},data:s},p+=f((d=i.I18n,d?d.call(t,"all_time",h):m.call(t,"I18n","all_time",h)))+'</a></li>\n        <li data-key="thisWeek"><a>',h={hash:{},data:s},p+=f((d=i.I18n,d?d.call(t,"this_week",h):m.call(t,"I18n","this_week",h)))+"</a></li>\n        ",h={hash:{},inverse:g.noop,fn:g.program(1,a,s),data:s},(u=i.ifInCompleted)?u=u.call(t,h):(u=t.ifInCompleted,u=typeof u===v?u.apply(t):u),i.ifInCompleted||(u=y.call(t,u,h)),(u||0===u)&&(p+=u),p+='\n        <li data-key="thisMonth"><a>',h={hash:{},data:s},p+=f((d=i.I18n,d?d.call(t,"this_month",h):m.call(t,"I18n","this_month",h)))+'</a></li>\n        <li data-key="custom">\n            <a>\n                ',h={hash:{},inverse:g.program(5,o,s),fn:g.program(3,r,s),data:s},(u=i.ifInCompleted)?u=u.call(t,h):(u=t.ifInCompleted,u=typeof u===v?u.apply(t):u),i.ifInCompleted||(u=y.call(t,u,h)),(u||0===u)&&(p+=u),p+='\n            </a>\n        </li>\n    </ul>\n    <div class="custom shadow clearfix">\n        <input class="s-time" placeholder="',h={hash:{},data:s},p+=f((d=i.I18n,d?d.call(t,"due_from_placeholder",h):m.call(t,"I18n","due_from_placeholder",h)))+'" type="text" readonly>\n        <input class="e-time" placeholder="',h={hash:{},data:s},p+=f((d=i.I18n,d?d.call(t,"due_to_placeholder",h):m.call(t,"I18n","due_to_placeholder",h)))+'" type="text" readonly>\n        <input class="btn btn-cancel" type="button" value="',h={hash:{},data:s},p+=f((d=i.I18n,d?d.call(t,"cancel",h):m.call(t,"I18n","cancel",h)))+'">\n        <input class="btn btn-confirm" type="button" value="',h={hash:{},data:s},p+=f((d=i.I18n,d?d.call(t,"confirm",h):m.call(t,"I18n","confirm",h)))+'">\n    </div>\n</div>\n\n<div class="dropdown filter-project">\n    <a class="selected-title direct down" data-toggle="dropdown">\n        ',h={hash:{},data:s},p+=f((d=i.I18n,d?d.call(t,"all_list",h):m.call(t,"I18n","all_list",h)))+"\n    </a>\n</div>\n\n",h={hash:{},inverse:g.noop,fn:g.program(7,l,s),data:s},d=i.iffalse,u=d?d.call(t,t.hideFilterStatus,h):m.call(t,"iffalse",t.hideFilterStatus,h),(u||0===u)&&(p+=u),p+='\n\n<a class="print-filter hidden">\n    <span class="print-item print-duedate">',h={hash:{},data:s},p+=f((d=i.I18n,d?d.call(t,"all_time",h):m.call(t,"I18n","all_time",h)))+'</span>,\n    <span class="print-item print-project">',h={hash:{},data:s},p+=f((d=i.I18n,d?d.call(t,"all_list",h):m.call(t,"I18n","all_list",h)))+"</span>\n    ",h={hash:{},inverse:g.noop,fn:g.program(9,c,s),data:s},d=i.iffalse,u=d?d.call(t,t.hideFilterStatus,h):m.call(t,"iffalse",t.hideFilterStatus,h),(u||0===u)&&(p+=u),p+="\n</a>\n"})}),define("modules/filter-component/index",["require","exports","module","dao/projectdb","modules/multi-select/project","lang/index","utils/timeformat","service/prefs","utils/hash","service/userProfile","view/modal/get-upgrade","hbs!template/filter_component"],function(e,t){var i=e("dao/projectdb").db,n=e("modules/multi-select/project").View,s=e("lang/index"),a=e("utils/timeformat"),r=e("service/prefs"),o=e("utils/hash"),l=e("service/userProfile"),c=e("view/modal/get-upgrade").View;t.View=Backbone.View.extend({template:e("hbs!template/filter_component"),className:"filter-advance",events:{"click .selected-title":"checkPermisson","click .s-time, .e-time":"stopEvent","click li>a":"selectItem","click .custom .btn-confirm":"selectCustomTime","click .custom .btn-cancel":"cancelCustomTime","click .filter-project .selected-title":"openSelectProjectMenu"},initialize:function(e){this.initData(e),this.render(),this.initDomAttr(),this.initCustomEvent()},render:function(){this.renderHome(),this.renderSelectProjectComponent(),this.renderCalendar(this.$(".s-time")),this.renderCalendar(this.$(".e-time"))},initData:function(e){_.extend(this,e)},initDomAttr:function(){this.$timeUl=this.$(".filter-duedate ul"),this.$statusUl=this.$(".filter-status ul"),this.$timeSelectdTitle=this.$(".filter-duedate .selected-title"),this.$statusSelectedTitle=this.$(".filter-status .selected-title"),this.$projectSelectedTitle=this.$(".filter-project .selected-title"),this.$sTime=this.$(".s-time"),this.$eTime=this.$(".e-time"),this.$custom=this.$(".custom"),this.$customConfirm=this.$(".btn-confirm")},renderHome:function(){this.$el.html(this.template({hideFilterStatus:o.isInCompleted()}))},renderSelectProjectComponent:function(){var e=i.getProjectsUnClosedWithInbox(),t=this;this.menu=new n({projects:e,selects:e,action:function(e){t.afterSelectProject(e)}}),this.$(".filter-project").append(this.menu.el)},renderCalendar:function(e){var t=new Kalendae.Input(e[0],{month:1,model:"single",format:"YYYY-MM-DD",dayOutOfMonthClickable:!0,useYearNav:!1,navSelector:!0,subscribe:{change:function(){}}}),i=this;$(t.container).addClass("k-pop").on("click",function(t){$(t.target).parent().hasClass("k-days")&&(e.blur(),i.afterSelectedCustomOneDay()),t.preventDefault(),t.stopPropagation()})},initCustomEvent:function(){var e=this;$(document).on("click",function(){e.hideCustom()}).on("click","[data-toggle=dropdown]",function(){e.hideCustom()}).on("click",'li[data-key="custom"], .custom',function(e){e.stopPropagation()})},afterSelectProject:function(e){this.selectedProjects=e,this.doAction(),this.renderProjectTitle()},openSelectProjectMenu:function(){this.menu.open(this.selectedProjects)},stopEvent:function(e){e.preventDefault(),e.stopPropagation()},checkPermisson:function(e){l.isPro()||(e.preventDefault(),e.stopPropagation(),new c({type:"search"}))},showCustom:function(e){this.$(".filter-duedate").removeClass("open"),this.$custom.show()},hideCustom:function(e){this.$custom.hide(),this.$beforeTimeItem=null},afterSelectedCustomOneDay:function(){this.verifyCustomTime()?this.$customConfirm.removeClass("disabled"):this.$customConfirm.addClass("disabled")},verifyCustomTime:function(){var e=this.$sTime.val(),t=this.$eTime.val();return e&&t&&moment(e).isAfter(t)?!1:!0},cancelCustomTime:function(e){this.$beforeTimeItem.find("a").click(),"custom"===this.$beforeTimeItem.attr("data-key")&&this.renderTimeTitle(),this.hideCustom()},selectCustomTime:function(e){this.verifyCustomTime()&&(this.hideCustom(),this.renderTimeTitle(),this.doAction())},selectItem:function(e){var t=$(e.currentTarget).parent(),i=this.$timeUl.find("li.active");this.highItem(t),this.refreshAllTitle(t),"custom"===t.attr("data-key")?(this.$beforeTimeItem=i,this.showCustom()):this.doAction()},highItem:function(e){var t=e.parent();t.children().removeClass("active"),e.addClass("active")},refreshAllTitle:function(e){this.$timeUl.find(e).length?this.refreshSelectedTitle(this.$timeUl,this.$timeSelectdTitle):this.refreshSelectedTitle(this.$statusUl,this.$statusSelectedTitle)},renderTimeTitle:function(){var e=this.$sTime.val(),t=this.$eTime.val(),i="";e&&t?i=s.get("due_from_to").replace("%s1",e).replace("%s2",t):e?i=s.get("due_from").replace("%s1",e):t&&(i=s.get("due_to").replace("%s1",t)),i=i||s.get("all_time"),this.$timeSelectdTitle.html(i)},renderProjectTitle:function(){var e="",t=this.selectedProjects.length;if(t&&t!=i.getProjectsUnClosedWithInbox().length){var n=this.selectedProjects[0].name;e=n,t>1&&(t--,e=s.get("n_list_and_so_on").replace(/\%s1/,n).replace(/\%d/,t))}else e=s.get("all_list");this.$projectSelectedTitle.html(e)},refreshSelectedTitle:function(e,t){var i=e.find(".active>a"),n=i.html();t.html(n)},doAction:function(){var e=this.getValues();this.action&&this.action({data:e}),this.renderPrintFilter(e)},renderPrintFilter:function(e){this.renderPrintDue(e),this.renderPrintProject(e),this.renderPrintStatus(e)},renderPrintDue:function(e){var t=this.$(".print-duedate"),i="",n=e.dueFrom,r=e.dueTo;n&&r?i=s.get("due_from_to").replace("%s1",a.formatUtcToDateString(n)).replace("%s2",a.formatUtcToDateString(r)):n?i=s.get("due_from").replace("%s1",a.formatUtcToDateString(n)):n&&(i+=s.get("due_to").replace("%s1",a.formatUtcToDateString(r))),i=i||s.get("all_time"),t.text(i)},renderPrintProject:function(e){var t=this.$(".print-project"),i=e.projects,n="";if(i){var i=_.map(i,function(e){return e.name});n=i.join(",")}n=n||s.get("all_list"),t.text(n)},renderPrintStatus:function(e){var t=this.$(".print-status"),i=e.status,n="";2===i.length?n=s.get("complete_status"):1===i.length&&(n=s.get("incomplete_status")),n=n||s.get("all_status"),t.text(n)},getValues:function(){var e={};return _.extend(e,this.getDueValue()),_.extend(e,this.getProjectsValue()),_.extend(e,this.getStatusValue()),e},getDueValue:function(){var e=this.$timeUl.find(".active").attr("data-key"),t=this,i={},n={allTime:function(){},thisWeek:function(){this._push(a.getThisWeek(r.getWeekStartDay()))},lastWeek:function(){this._push(a.getLastWeek(r.getWeekStartDay()))},thisMonth:function(){this._push(a.getThisMonth())},custom:function(){var e=t.$sTime.val(),i=t.$eTime.val(),n={};e&&(n.startDay=a.formatToUtc(e)),i&&(n.endDay=a.formatToUtc(i)),this._push(n)},_push:function(e){e.startDay&&(i.dueFrom=e.startDay),e.endDay&&(i.dueTo=e.endDay)}};return n[e]&&n[e](),i},getProjectsValue:function(){return{projects:this.selectedProjects}},getStatusValue:function(){var e=this.$statusUl.find(".active").attr("data-key"),t=[],i={allStatus:function(){t=[0,1,2]},undone:function(){t=[0]},completed:function(){t=[1,2]}};return i[e]&&i[e](),{status:t}}})}),define("hbs!template/task_list_filter_bar",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o,l="",c=i.helperMissing,d=this.escapeExpression;return l+='<div class="filter-name transition">\n    <input class="search-input transition text-lrg input-lrg" type="text" placeholder="',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"search",o):c.call(t,"I18n","search",o)))+'">\n    ',o={hash:{},data:s},a=i.svgIcon,r=a?a.call(t,"icon-search","i-4",o):c.call(t,"svgIcon","icon-search","i-4",o),(r||0===r)&&(l+=r),l+="\n</div>\n\n"})}),define("view/tasklist/search",["require","exports","module","lang/index","dao/taskdb","view/tasklist/base","collection/section","view/section/search","configs/dict","configs/keycode","modules/filter-component/index","hbs!template/task_list_filter_bar"],function(e,t){var i=(e("lang/index"),e("dao/taskdb").db),n=e("view/tasklist/base").View,s=e("collection/section").Collection,a=e("view/section/search").View,r=e("configs/dict"),o=e("configs/keycode"),l=e("modules/filter-component/index").View;t.View=n.extend({template:e("hbs!template/task_list_filter_bar"),messages:function(){this.listenTo(Backbone,"showSearchResult",this.showSearchResultFromServer)},events:function(){return _.extend(n.prototype.events.call(this),{"keydown .search-input":"queryTasks"})},initialize:function(e){this.initData(e),this.messages(),n.prototype.initialize.apply(this,[e]),this.initDomAttr(),this.autoFocus()},initData:function(e){_.extend(this.options),this.qs={},this.filterRes={}},initDomAttr:function(){this.$searchInput=this.$(".search-input")},queryTasks:function(e){var t=this.$searchInput.val();if(e.keyCode==o.enter&&$.trim(t).length){var i=this;setTimeout(function(){i.doSearch()},300),this.resetSearchInput()}},doSearch:function(){var e=this.getSearchQuery();this.searchTasks(e),this.sortBySearch()},getSearchQuery:function(){var e=[];return this.buildKeywords(e),this.buildDue(e),this.buildStatus(e),this.buildProjectId(e),e.join("&")},buildKeywords:function(e){var t=this.$searchInput.val().toLowerCase();this.qs.kw=t,e.push("keywords="+t)},buildDue:function(e){var t="dueFrom=",i="dueTo=",n=this.filterRes.dueFrom,s=this.filterRes.dueTo;n&&(e.push(t+new Date(n).getTime()),this.qs.dueFrom=n),s&&(e.push(i+new Date(s).getTime()),this.qs.dueTo=s)},buildStatus:function(e){var t="status=";this.filterRes.status&&this.filterRes.status.map(function(i){e.push(t+i)}),this.qs.statuss=this.filterRes.status},buildProjectId:function(e){var t="projectId=",i=this.filterRes.projects,n=[];i=i||[],i.map(function(i){e.push(t+i.id),n.push(i.id)}),this.qs.projectIds=n},searchTasks:function(e){i.getTasksBySearch(e)},preloadTasks:function(){var e=i.getTasksBySearchLocal(this.qs);return this.qs={},e},startAnimation:function(){$("#center-view").removeClass("before-animation")},setSearchClass:function(){$("#center-view").addClass("init-search-input before-animation"),setTimeout(function(){$("#center-view").addClass("transition")},100)},centerSearchInput:function(){this.setSearchClass()},resetSearchInput:function(){this.startAnimation(),this.changeFontSize(),_this=this,setTimeout(function(){_this.removeAnimationClass(),_this.initScrollbar()},300)},render:function(){return this.centerSearchInput(),this.renderToolbar(),this.renderFilterComponent(),this},renderToolbar:function(){var e=this.template();this.$(".tl-bar").html(e)},autoFocus:function(){this.$searchInput.focus(10)},renderFilterComponent:function(){var e=this,t=new l({action:function(t){e.filterRes=t.data,e.doSearch()}});this.$(".tl-bar").append(t.$el)},addSearchSection:function(e,t){var i=new s;e[r.section.search]=i,this.subViews.push(new a(this._getSectionArgs(i,t)))},sortBySearch:function(){this._beforeAddSection(),this.addSearchSection(this.sectionCollectionMap,this.tasks),this._afterAddSection(),this.showLoadingView()},showSearchResultFromServer:function(e){this.hideLoadingView();var t=this.sectionCollectionMap[r.section.search];t.sort(),t.add(e,{merge:!0}),this.attachTaskUlAttr(),this.taskDetailView&&this.taskDetailView.onClose()},removeAnimationClass:function(){$("#center-view").removeClass("init-search-input before-animation transition")},changeFontSize:function(){this.$searchInput.removeClass("text-lrg").addClass("text-med")},_onClose:function(){this.removeAnimationClass(),this.remove()}})}),define("view/section/tag",["require","exports","module","service/filter","view/section/base","service/sort"],function(e,t){var i=e("service/filter").filter,n=e("view/section/base").View,s=e("service/sort").rank;t.View=n.extend({filter:i.tag,className:"tag",createOnEnterProperties:function(){return{}},initialize:function(e){this.sortBy=s.tag,this.events=_.extend({},n.prototype.events,this.events),this.constructor.__super__.initialize.apply(this,[e])},initProps:function(){this.sortBy=s.tag,this.initDropOrSort()},initDropOrSort:function(){this.canDrop=!1,this.canSort=!1}})}),define("view/tasklist/tag",["require","exports","module","view/tasklist/base","view/section/tag","collection/section","configs/dict","configs/status","offline/storage","service/filter","dao/taskdb"],function(e,t){var i=e("view/tasklist/base").View,n=e("view/section/tag").View,s=e("collection/section").Collection,a=e("configs/dict"),r=(e("configs/status"),e("offline/storage")),o=e("service/filter").filter,l=e("dao/taskdb").db;t.View=i.extend({initialize:function(e){_.extend(this,e),this.messages(),this.initSupportSort(),this.constructor.__super__.initialize.apply(this,[e])},initSupportSort:function(){this.supportSortByList=["byList","byDueDate","byTitle","byPriority"]},preloadTasks:function(){return l.collection.filter(o.tag.bind(this))},render:function(e){return this.initSortType(),this.clearDetailView(),this},initSortType:function(){var e=r.getCacheItem(this.getCachePath());e=e||a.sortType.project,this[this.sortBy(e)](!0)},_getRenderData:function(){return{project:{name:"#"+this.tName}}},addTagSection:function(e,t){var i=new s;e[a.section.tag]=i,this.subViews.push(new n(this._getSectionArgs(i,t)))},sortByTag:function(){this._beforeAddSection(),this.addTagSection(this.sectionCollectionMap,this.tasks),this._afterAddSection()},getCachePath:function(){return a.cachePath.sortTypeTag+"/"+this.tName},fetchCompletedTasks:function(){var e=l.collection.filter(o.tag.bind(this));completedTasks=e.filter(function(e){return e.get("status")>0}),this.showLoadingView(),this.showMoreCompletedTasks(completedTasks,!0)}})}),define("view/tasklist/completed",["require","exports","module","view/tasklist/base","modules/filter-component/index","service/task","utils/timeformat","configs/dict"],function(e,t){var i=e("view/tasklist/base").View,n=e("modules/filter-component/index").View,s=e("service/task"),a=e("utils/timeformat"),r=e("configs/dict");t.View=i.extend({messages:function(){this.listenTo(Backbone,"showMoreCompletedTasks",this.showMoreCompletedTasks)},initialize:function(e){this.initData(e),this.messages(),i.prototype.initialize.apply(this,[e])},initData:function(e){_.extend(this,e),this.projectIds=this.project.id},render:function(){this.renderFilterComponent(),this.sortByCompletedTime()},renderFilterComponent:function(){var e=this,t=new n({action:function(t){e.handleFilterRes(t.data),e.doFilter()}});this.$(".tl-bar").append(t.$el)},handleFilterRes:function(e){if(this.rangeTime={},e.dueFrom&&(this.rangeTime.fd=a.formatDateForCompleted(e.dueFrom)),e.dueTo&&(this.rangeTime.td=a.formatDateForCompleted(e.dueTo)),e.projects&&!_.isEmpty(e.projects)){var t=[];e.projects.map(function(e){t.push(e.id)}),this.projectIds=t.join(",")}else this.projectIds="all"},doFilter:function(){this.resetCompletedFilter(),this.sortByCompletedTime()},resetCompletedFilter:function(){this.noMore=!1},fetchCompletedTasks:function(e){s.fetchCompletedTasksPagination(this.projectIds,50,e,!1,!1,this.rangeTime),this.showLoadingView()},preloadTasks:function(){var e=!0;return this.fetchCompletedTasks(e),this.rangeTime?[]:s.getCompletedTasksInLocal()},sortByCompletedTime:function(){this._beforeAddSection(),_.each(this.groupByCompletedTime(this.tasks),function(e,t){this.addCompletedSection(this.sectionCollectionMap,e,t)},this),this._afterAddSection(),this.showLoadingView()},groupByCompletedTime:function(e){var t=_.groupBy(e,function(e){var t=e.get("completedTime")||e.get("modifiedTime");return a.formatToDateString(a.prefMoment(t))});return _.object(_.pairs(t).sort().reverse())},showMoreCompletedTasks:function(e){var t=50;_.isEmpty(e)||_.each(this.groupByCompletedTime(e),function(e,t){var i=this.sectionCollectionMap[r.section.completed+"-"+t];i?i.add(e,{merge:!0}):(this.addCompletedSection(this.sectionCollectionMap,e,t),this.renderMoreCompletedSection())},this),(!e||e.length<t)&&(this.hideLoadingView(),this.noMore=!0)},renderMoreCompletedSection:function(){try{this.subViews.sort(function(e,t){return t.date.localeCompare(e.date)})}catch(e){log.log("completedSection sort error , section without date")}for(var t=0;t<this.subViews.length;t++){var i=this.subViews[t];i.collection.length>0&&0===i.subViews.length&&(0===t?this.$("#task-ul-list .content").append(i.render().el):this.subViews[t-1].$el.after(i.render().el))}}})}),define("hbs!template/out_single_subscribe",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){return" "}function r(e,t){var n,s="";return s+=' \n  <div class="repeat">',(n=i.repeatTip)?n=n.call(e,{hash:{},data:t}):(n=e.repeatTip,n=typeof n===h?n.apply(e):n),s+=p(n)+"</div>\n"}function o(e,t){var i,n,s="";return s+='\n  <div class="content text-sml">',i=e.model,i=null==i||i===!1?i:i.content,n=typeof i===h?i.apply(e):i,(n||0===n)&&(s+=n),s+="</div>\n"}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var l,c,d,u="",h="function",p=this.escapeExpression,m=i.helperMissing,f=this;return u+='<div class="subscribe-pop">\n  <div class="text-med title">',l=t.model,l=null==l||l===!1?l:l.title,c=typeof l===h?l.apply(t):l,(c||0===c)&&(u+=c),
u+='</div>\n  <div class="duedate text-sml">',d={hash:{},data:s},u+=p((l=i.getTaskDetailDueDate,l?l.call(t,(l=t.model,null==l||l===!1?l:l.dueDate),d):m.call(t,"getTaskDetailDueDate",(l=t.model,null==l||l===!1?l:l.dueDate),d)))+"</div>\n\n",d={hash:{},inverse:f.program(3,r,s),fn:f.program(1,a,s),data:s},l=i.iffalse,c=l?l.call(t,t.repeatTip,d):m.call(t,"iffalse",t.repeatTip,d),(c||0===c)&&(u+=c),u+="\n\n",d={hash:{},inverse:f.program(5,o,s),fn:f.program(1,a,s),data:s},l=i.iffalse,c=l?l.call(t,(l=t.model,null==l||l===!1?l:l.content),d):m.call(t,"iffalse",(l=t.model,null==l||l===!1?l:l.content),d),(c||0===c)&&(u+=c),u+="\n\n</div>"})}),define("view/tkcalendar/out-single",["require","exports","module","view/taskdetail/single","model/task","configs/dict","utils/timeformat","dao/calendardb","service/prefs","utils/dom","utils/analytics","configs/status","utils/condition","utils/reminder-util","service/task","service/userProfile","hbs!template/out_single_subscribe"],function(e,t){var i=e("view/taskdetail/single").View,n=e("model/task").Model,s=e("configs/dict"),a=e("utils/timeformat"),r=e("dao/calendardb"),o=e("service/prefs"),l=e("utils/dom"),c=e("utils/analytics"),d=e("configs/status"),u=e("utils/condition"),h=e("utils/reminder-util"),p=e("service/task"),m=e("service/userProfile");t.View=Backbone.View.extend({id:"out-single-task-detail",className:"out-detail pop-shadow",template:e("hbs!template/out_single_subscribe"),popTaskClass:"pop-task",events:{},message:function(){this.listenTo(Backbone,"deleteOutSingleTask",this.deleteTask),this.listenTo(Backbone,"hideOutSingleTask",this.hideView)},initialize:function(e){return _.extend(this,e),this.message(),this.initTask(),this.render(),this.initPosition(),this.focusTitle(),this.activeTask(),d.hasOutDetail=!0,this.$el},render:function(){this.model&&u.isSubscribeCalendarTask(this.model)?this.renderSubscribe():this.renderNormal(),this.$elDate.append(this.$el),this.renderScrollbar(),l.adjustDetailHeight()},renderScrollbar:function(){this.$(".antiscroll-wrap").antiscroll()},renderNormal:function(e){this.taskDetailView&&this.taskDetailView.close(),this.taskDetailView=new i({model:this.model}),this.$el.append(this.taskDetailView.$el)},renderSubscribe:function(){var e="";this.model.get("repeatFlag")&&(e=h.exposeRepeat({},this.model).preview),this.$el.html(this.template({model:this.model.toJSON(),repeatTip:e})),this.$el.addClass("subscribe")},renderOutBg:function(){var e='<div class="out-bg"></div>';this.$container=$("#js-c-scroll-container").append(e),this.$bg=this.$container.find(".out-bg")},_renderEmptyTask:function(){this.$t=$('<div class="c-task '+this.popTaskClass+'"></div>'),this.$elDate.find(".c-tasks").prepend(this.$t)},_removeEmptyTask:function(){this.$t&&this.$t.remove()},activeTask:function(){this.parent?(this.parent.$el.addClass(this.popTaskClass),this.parent.renderProjectInfo(100)):this._renderEmptyTask()},unActiveTask:function(){this.parent?(this.parent.$el.removeClass(this.popTaskClass),this.parent.renderProjectInfo(20)):this._removeEmptyTask()},initPosition:function(){var e=this.$el.closest(".c-col"),t=e.offset().top,i=e.outerWidth(),n=this.$el.outerHeight(),s=this.$el.outerWidth(),a=7,r=2,o=e.position().top+a,l=i+r,c=window.innerHeight-t-n,d=window.innerWidth-e.offset().left-l-s;o=c>0?o:c-a,l=d>0?l:-(s+r),this.$el.css({top:o,left:l})},focusTitle:function(){this.taskDetailView&&(this.taskDetailView.titleEditor.showEditor(),this.taskDetailView.titleEditor.$el.find(".task-title").focus())},saveOrDelete:function(){if(Backbone.trigger("hideTimeCard"),this.model.get("title").trim().length||!this.model.isNew()||this.model.isDirty){var e=this.dueDate,t=moment(this.model.get("dueDate")).format("YYYY-MM-DD"),i=r.db.getTaskByDueDateForTKCalendar(e);if(e==t)i.add(this.model,{merge:!0});else{var n=r.db.getTaskByDueDateForTKCalendar(t);n.add(this.model,{merge:!0}),i.remove(this.model)}r.db.add(this.model),c.c_task("add")}else this.model.destroy()},initTask:function(){if(this.dueDate=this.dueDate||moment(this.model.get("dueDate")).format("YYYY-MM-DD"),!this.model){var e=a.prefMoment().utc().format(s.format.atomTime);this.model=new n({id:ObjectId(),title:"",content:"",dueDate:moment(this.dueDate).format(s.format.atomTime),timeZone:o.get("timeZone"),priority:0,status:0,sortOrder:p.getMinSortOrder(m.get("inboxId")),modifiedTime:e,createdTime:e}),this.model.local=!0}},hideView:function(){d.hasOutDetail=!1,this.saveOrDelete(),this.onClose()},deleteTask:function(){setTimeout(function(){d.hasOutDetail=!1}),this.onClose()},onClose:function(){this.unActiveTask(),this.taskDetailView&&this.taskDetailView.onClose(),this.$bg&&this.$bg.remove(),this.remove()}})}),define("hbs!template/tk_calendar_task",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){var n;return(n=i.id)?n=n.call(e,{hash:{},data:t}):(n=e.id,n=typeof n===c?n.apply(e):n),d(n)}function r(e,t){var n;return(n=i.cid)?n=n.call(e,{hash:{},data:t}):(n=e.cid,n=typeof n===c?n.apply(e):n),d(n)}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var o,l="",c="function",d=this.escapeExpression,u=this;return l+='<a taskId="',o=i["if"].call(t,t.id,{hash:{},inverse:u.program(3,r,s),fn:u.program(1,a,s),data:s}),(o||0===o)&&(l+=o),l+='" projectId="',(o=i.projectId)?o=o.call(t,{hash:{},data:s}):(o=t.projectId,o=typeof o===c?o.apply(t):o),l+=d(o)+'"></a>\n<div class="c-task-inner text-tny">\n  \n  <div class="c-task-time line-right"></div>\n  <div class="c-task-title line-left"></div>\n</div>\n'})}),define("view/tkcalendar/calendar-task",["require","exports","module","utils/condition","configs/dict","view/tkcalendar/out-single","service/prefs","dao/taskdb","service/task","utils/analytics","configs/status","utils/dom","utils/index","dao/projectdb","hbs!template/tk_calendar_task"],function(e,t){var i=e("utils/condition"),n=e("configs/dict"),s=e("view/tkcalendar/out-single").View,a=e("service/prefs"),r=e("dao/taskdb"),o=(e("service/task"),e("utils/analytics")),l=e("configs/status"),c=e("utils/dom"),d=e("utils/index"),u=e("dao/projectdb").db;t.View=Backbone.View.extend({tagName:"div",className:"c-task",template:e("hbs!template/tk_calendar_task"),events:{click:"doOnClick","click .check-toggle":"toggleCompleteCTask"},initialize:function(e){this.render(),this.messages(),this.initDraggable()},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.setTitle().setTime().setStatusIcon().setPriorityIcon(),this.renderProjectInfo(),this},messages:function(){this.listenTo(this.model,"destroy",this.remove),this.listenTo(this.model,"hideOnDateView",this.hideOnDateView),this.listenTo(this.model,"change:title",this.setTitle),this.listenTo(this.model,"change:dueDate",this.setTime),this.listenTo(this.model,"change:content change:priority change:status change:items",this.setStatusIcon),this.listenTo(this.model,"change:priority",this.setPriorityIcon),this.listenTo(this.model,"change:projectId",this.projectChanged)},projectChanged:function(e,t){this.renderProjectInfo()},renderProjectInfo:function(e,t){t=t||this.$el,e=e||20;var i=u.getProjectColorById(this.model.get("projectId"));if(i&&"transparent"!==i){c.setProjectColor(t,"3px",i);var n=d.convertHex(i,e);t.css("background-color",n),t.find(".c-task-checker").css("background-color",i)}},hideOnDateView:function(){var e=this.model.get("dueDate"),t=r.db.calendardb.getTaskByDueDateForTKCalendar(e);t.remove(this.model)},setTitle:function(){var e=this.model.get("title");return this.$el.find(".c-task-title").html(e),this},setTime:function(){var e,t=this.model.get("dueDate"),i=moment(t);if(this.model.get("isAllDay")||"0:00"==i.format("H:mm"))return this;e=a.get("showMeridiem")?"h:mm a":"H:mm";var n=t?i.format(e):"";return this.$el.find(".c-task-time").html(n),this},setStatusIcon:function(){return c.switchIcon(this.$el,this.model),this},setPriorityIcon:function(){return this.$el.removeClass("none-priority low-priority medium-priority high-priority"),this.$el.addClass(n.priority[this.model.get("priority")]),this},_analy:function(){var e=this.$el.hasClass("checked");o.c_task(e?"undone":"done")},toggleCompleteCTask:function(e){if(!i.isSubscribeCalendarTask(this.model))if(this._analy(),e=e||window.event,e.stopPropagation(),this.model.willRepeat()){var t=this,n=this.model.get("dueDate"),s=r.db.calendardb.getTaskByDueDateForTKCalendar(n);this.model.toggleModelComplete();var a=t.model.get("dueDate"),o=r.db.calendardb.getTaskByDueDateForTKCalendar(a);o.add(t.model,{merge:!0}),s.remove(t.model)}else this.model.toggleModelComplete()},doOnClick:function(){return l.hasPopup&&!this.$el.closest(".c-date-popup").length&&Backbone.trigger("hidePopup"),l.hasOutDetail&&Backbone.trigger("hideOutSingleTask"),this.outSingleView=new s({model:this.model,$elDate:this.$el.closest(".c-date"),parent:this}),!1},show:function(){return this.$el.removeClass("d-n"),this},hide:function(){return this.$el.addClass("d-n"),this},initDraggable:function(){if(!i.isSubscribeCalendarTask(this.model)){var e=this;this.$el.draggable({revert:"invalid",handle:".drag",containment:"#js-c-scroll-container",zIndex:1e3,drag:function(t,i){e.renderProjectInfo(100,i.helper)},stop:function(e){}})}},onClose:function(){this.remove()}})}),define("hbs!template/tk_calendar_date",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a="";return a+='<div class="c-titlebar clearfix">\n    <div class="c-title text-info">\n      <span class="c-solar text-med"></span>\n      <span class="c-lunar text-info text-tny"></span>\n    </div>\n    \n</div>\n<div class="c-tasks-wrap">\n  <div class="antiscroll-wrap">\n    <div class="c-tasks antiscroll-inner"></div>\n  </div>\n</div>\n\n<div class="c-more d-n text-link text-tny">\n    <span></span>\n</div>'})}),define("view/tkcalendar/calendar-date",["require","exports","module","view/tkcalendar/calendar-task","view/tkcalendar/out-single","utils/timeformat","lang/index","configs/dict","dao/calendardb","configs/settings","utils/analytics","configs/status","utils/browser","hbs!template/tk_calendar_date"],function(e,t){{var i=e("view/tkcalendar/calendar-task").View,n=e("view/tkcalendar/out-single").View,s=(e("utils/timeformat"),e("lang/index")),a=e("configs/dict"),r=e("dao/calendardb").db,o=e("configs/settings"),l=e("utils/analytics"),c=e("configs/status");e("utils/browser")}t.View=Backbone.View.extend({tagName:"div",className:"c-date",template:e("hbs!template/tk_calendar_date"),events:{click:"doOnClick","click .c-more span":"doOnClickMore"},messages:function(){this.listenTo(this.taskCollection,"remove",this.refreshTasks),this.listenTo(this.taskCollection,"sort",this.refreshTasks),this.listenTo(Backbone,"hidePopup",this.hidePopup)},initialize:function(e){var t=e.date;this.date=t,this.taskCollection=r.getTaskByDueDateForTKCalendar(new Date(t.sy,t.sm-1,t.sd)),this.taskViewList=[],this.showMax=3,this.render(),this.messages(),this.initDroppable()},render:function(){return this.$el.html(this.template()),this.$el.attr("id",this.date.symd),this.$elLunar=this.$el.find(".c-lunar"),this.$elSolar=this.$el.find(".c-solar"),this.$elTasks=this.$el.find(".c-tasks"),this.$elMore=this.$el.find(".c-more"),this.renderTitle().renderTasks(),this},renderTitle:function(){var e=this.date,t=e.sy,i=(e.sm,e.sd),n=(e.ly,e.lm,e.ld),s=(e.lY,e.lM),a=e.lD,r=e.st,l=e.sf,c=e.lf,d=(e.smn,2050>t);if(this.$elSolar.text(i),o.iscnlang){var u=d?" "+(r||(1==n?s+"月":a)):"",h=l?" "+l:"",p=d&&c?" "+c:"",m=u+h+p;this.$elLunar.text(m)}return this},refreshTasks:function(){return this.removeSubViews(),this.hideMore(),this.renderTasks(),this},renderTasks:function(){var e=this;return _.each(this.taskCollection.models,function(t){e.renderTask(t)}),e.popupMode||e.hideMoreTasks(),this},renderTask:function(e){var t=new i({model:e});return this.taskViewList.push(t),this.$elTasks.append(t.$el),this},showMore:function(e){return e&&this.$elMore.find("span").html(o.iscnlang?"另外 "+e+" 个":"+"+e+" "+s.get("more").toLowerCase()),this.$elMore.removeClass("d-n"),this},hideMore:function(){return this.$elMore.addClass("d-n"),this},showMoreTasks:function(){return this.hideMore(),this},hideMoreTasks:function(){var e=this.taskCollection.models.length,t=this.showMax;return e>t&&this.showMore(e-t),this},initScrollbar:function(){this.$(".antiscroll-wrap").antiscroll()},showPopup:function(){this.popupMode=!0,c.hasPopup=!0,this.$el.addClass("c-date-popup"),this.$el.closest(".c-row").addClass("c-popup"),this.initScrollbar(),this.showMoreTasks(),this.listenEvents()},listenEvents:function(){var e=this;this.listenToCalendarClickForHidePopup||(this.listenToCalendarClickForHidePopup=!0,this.$el.closest(".tk-calendar").on("click",function(){e.popupMode&&e.hidePopup()}))},hidePopup:function(){this.popupMode=!1,c.hasPopup=!1,this.hideMoreTasks(),this.$el.removeClass("c-date-popup"),this.$el.closest(".c-row").removeClass("c-popup")},_hideAllPopup:function(){c.hasPopup&&Backbone.trigger("hidePopup")},doOnClickMore:function(){return this._hideAllPopup(),this.showPopup(),Backbone.trigger("hideOutSingleTask"),this.showPopupByClick=!0,!1},_openOutSingle:function(e){if(e=e||window.event,c.hasOutDetail){var t=e.target.className;t.indexOf&&~t.indexOf(this.className)&&Backbone.trigger("hideOutSingleTask")}else this.outSingleView=new n({dueDate:this.date.symd,$elDate:this.$el})},doOnClick:function(e){(!c.hasPopup||c.hasOutDetail)&&this._openOutSingle(e)},initDroppable:function(){var e=this,t=this.$el;t.droppable({accept:".c-task",hoverClass:"c-task-drag-hovered",tolerance:"pointer",over:function(e,t){},drop:function(t,i){var n=$("#js-c-scroll-container .c-task.ui-draggable-dragging");if(n.length){var s=r.getById(n.children("a").attr("taskid")),o=r.getTaskByDueDateForTKCalendar(s.get("dueDate"));o.remove(s),e.taskCollection.add(s,{merge:!0}),n.remove();var c=moment(e.date.symd+moment(s.get("dueDate")).format("THH:mm:ss.SSSZZ"));s.save({dueDate:c.format(a.format.atomTime)}),l.c_task("drag")}}})},removeSubViews:function(){for(var e=this.taskViewList.length-1;e>=0;e--)this.taskViewList[e]&&this.taskViewList[e].onClose();this.taskViewList=[]},onClose:function(){this.removeSubViews(),this.remove()}})}),define("hbs!template/tk_calendar_row",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){return this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{},'<table class="c-row-inner">\n    <tbody>\n        <tr>\n            <td class="c-col"></td>\n            <td class="c-col"></td>\n            <td class="c-col"></td>\n            <td class="c-col"></td>\n            <td class="c-col"></td>\n            <td class="c-col"></td>\n            <td class="c-col"></td>\n        </tr>\n    </tbody>\n</table>\n<h5 class="c-tag-month"></h5>'})}),define("view/tkcalendar/calendar-row",["require","exports","module","configs/settings","service/prefs","view/tkcalendar/calendar-date","hbs!template/tk_calendar_row"],function(e,t){var i=e("configs/settings"),n=e("service/prefs"),s=e("view/tkcalendar/calendar-date").View;t.View=Backbone.View.extend({tagName:"div",className:"c-row",template:e("hbs!template/tk_calendar_row"),events:{},initialize:function(e){this.fm=i.iscnlang?"YYYY年MM月":"MMM, YYYY",this.today=e.today,this.dates=e.dates,this.dateViewList=[],this.render()},render:function(){this.$el.html(this.template()),this.$elCols=this.$el.find(".c-col"),this.$elTagMonth=this.$el.find(".c-tag-month");var e=this;return this.$elCols.each(function(t){var i=e.dates[t],n=i.sy,a=i.sm,r=i.sd,o=(i.smn,"");$(this).addClass("c-col-date-"+r);var l=e.today,c=l.sy,d=l.sm;d==a&&c==n&&$(this).addClass("c-col-date-month-now"),1==r&&(o=moment(i.symd).format(e.fm),e.$startMonth=e.$elTagMonth.html(o).addClass("c-month-start"));var u=new s({date:i});e.dateViewList.push(u),$(this).html(u.$el)}),this.setToday(),this.renderWeekend(),this},scrollMonthLabel:function(e,t,i){if(this.$startMonth){var n=this.$el.position().top,s=this.$startMonth.text(),a=e.text();this.$startMonth.css("top",n);var r=3*t;if("down"===i){if(this.$startMonth.removeClass("hide"),-t>n)return;if(t>n)return this.$startMonth.addClass("hide"),void e.text(s).css("top",0);if(r>n)return void e.css("top",n-r);s===a&&(s=moment(a,this.fm).add(-1,"month").format(this.fm),e.text(s))}else if("up"===i){if(n>r+5)return;if(n>-t&&t>n)return void this.$startMonth.addClass("hide");if(n>=t&&r>=n)return a=moment(s,this.fm).add(-1,"month").format(this.fm),e.css("top",n-r).text(a),void this.$startMonth.removeClass("hide")}}},renderWeekend:function(){var e=n.getWeekStartDay(),t=[];t=0===e?[0,6]:6===e?[0,1]:[5,6],this.$elCols.filter(function(e){return~t.indexOf(e)}).addClass("c-col-date-weekend")},setToday:function(e){var t=e,i=this.today;if(!(!t&&!i||t&&i&&t.sd==i.sd&&t.sm==i.sm&&t.sy==i.sy)){var n=this.today=t||i,s=n.sy,a=n.sm,r=n.sd;this.$elTagMonth.removeClass("c-tag-month-now"),this.$el.removeClass("c-row-now"),this.$elCols.filter(".c-col-date-now").removeClass("c-col-date-now");for(var o=this.dates.length,l=0;o>l;l++){var c=this.dates[l],d=c.sy,u=c.sm,h=c.sd;r==h&&a==u&&s==d&&(this.$elCols.filter(".c-col-date-"+h).addClass("c-col-date-now"),this.$el.addClass("c-row-now")),1==h&&a==u&&s==d&&this.$elTagMonth.addClass("c-tag-month-now")}}},onClose:function(){if(this.dateViewList){for(var e=this.dateViewList.length-1;e>=0;e--)this.dateViewList[e]&&this.dateViewList[e].onClose();this.dateViewList=null,this.remove()}}})}),define("hbs!template/tk_calendar",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o="",l=i.helperMissing,c=this.escapeExpression;return o+='<div id="js-c-nav" class="c-nav clearfix">\n    <h5 class="left c-range-wrap">\n        <span class="c-range"></span>\n    </h5>\n    <div class="right clearfix">\n        <button class="c-btn c-prev btn-secondary btn-sml"></button>\n        <button class="c-btn c-today btn-secondary btn-sml text-sml">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"tk_calendar_nav_today",r):l.call(t,"I18n","tk_calendar_nav_today",r)))+'</button>\n        <button class="c-btn c-next btn-secondary btn-sml"></button>\n    </div>\n</div>\n<div id="js-c-day-labels" class="c-day-labels">\n    <div class="scrollbar-fix">\n        <table class="c-day-labels-inner">\n            <tbody>\n                <tr>\n                    <td class="c-day-label">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"tk_calendar_day_label_mon",r):l.call(t,"I18n","tk_calendar_day_label_mon",r)))+'</td>\n                    <td class="c-day-label">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"tk_calendar_day_label_tue",r):l.call(t,"I18n","tk_calendar_day_label_tue",r)))+'</td>\n                    <td class="c-day-label">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"tk_calendar_day_label_wed",r):l.call(t,"I18n","tk_calendar_day_label_wed",r)))+'</td>\n                    <td class="c-day-label">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"tk_calendar_day_label_thu",r):l.call(t,"I18n","tk_calendar_day_label_thu",r)))+'</td>\n                    <td class="c-day-label">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"tk_calendar_day_label_fri",r):l.call(t,"I18n","tk_calendar_day_label_fri",r)))+'</td>\n                    <td class="c-day-label">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"tk_calendar_day_label_sat",r):l.call(t,"I18n","tk_calendar_day_label_sat",r)))+'</td>\n                    <td class="c-day-label">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"tk_calendar_day_label_sun",r):l.call(t,"I18n","tk_calendar_day_label_sun",r)))+'</td>\n                </tr>\n            </tbody>\n        </table>\n    </div>\n    <div class="scrollbar-cover"></div>\n</div>\n<div id="js-c-scroll-container" class="c-scroll-container"></div>\n'})}),define("view/tkcalendar/calendar",["require","exports","module","configs/settings","service/prefs","dao/calendardb","view/tkcalendar/calendar-row","utils/analytics","configs/status","utils/dom","hbs!template/tk_calendar"],function(e,t){var i=e("configs/settings"),n=e("service/prefs"),s=e("dao/calendardb").db,a=e("view/tkcalendar/calendar-row").View,r=e("utils/analytics"),o=e("configs/status"),l=e("utils/dom"),c=i.iscnlang?"YYYY年MM月":"MMM, YYYY";t.View=Backbone.View.extend({tagName:"div",className:"tk-calendar",template:e("hbs!template/tk_calendar"),events:{"click .c-nav .c-today":"doScrollToToday","click .c-nav .c-prev":"doScrollToPrevMonth","click .c-nav .c-next":"doScrollToNextMonth"},initialize:function(){this.cc=new CalendarConverter,this.today=this.convertDate(new Date),this.weeks=[],this.rowViews=[],this.render(),this.st=this.$elScroll.scrollTop(),l.highlightList()},addMeridiemClass:function(){n.get("showMeridiem")&&this.$el.addClass("show-meridiem")},initDom:function(){this.$elWrap=$("#tkcalendar-view"),this.$elScroll=this.$(".c-scroll-container"),this.$cNav=this.$("#js-c-nav"),this.$elLable=this.$("#js-c-day-labels"),this.$elRange=this.$(".c-range")},render:function(){return this.$el.html(this.template()),this.initDom(),this.$elWrap.html(this.$el),this.tkcalendarHeight(),this.setDayLabel(),this.renderFrom(),this.scrollToDate(),this.refreshTasks(),this.bindCustomEvents(),this.addMeridiemClass(),this.setRangeTitle(),this},tkcalendarHeight:function(){var e=window.innerHeight-this.$("#js-c-nav").outerHeight()-this.$("#js-c-day-labels").outerHeight();e>800&&this.$("#js-c-scroll-container").css("height",e)},bindCustomEvents:function(e){var t=this;return setTimeout(function(){t.$elScroll.bind("scroll",function(){t.doScroll()}),t.$elScroll.bind("scrollstop",function(){t.doScrollStop()})},e||1200),this},scrollMonthLabel:function(){var e=this.$elScroll.scrollTop(),t="down";this.st<e?t="down":this.st>e&&(t="up"),this.st=e;for(var i=this.$(".c-range-wrap").position().top,n=this.rowViews.length,s=0;n>s;s++)this.rowViews[s].scrollMonthLabel(this.$elRange,i,t)},setDayLabel:function(){var e=n.getWeekStartDay();if(0==e||6==e){var t=".c-day-label:first",i=".c-day-label:last";this.$el.find(t).before(this.$el.find(i)),6==e&&this.$el.find(t).before(this.$el.find(i))}},renderFrom:function(e){var t=e||this.today;this.weeks=[],this.rowViews=[],this.$elScroll.empty(),this.renderStartWeek(t);var i=this.getDateInWhichWeekOfMonth(t)+1;this.renderPrevWeeks(i);var n=Math.ceil(this.scrollHeight/this.rowHeight)+1-i;return this.renderNextWeeks(n),this},renderStartWeek:function(e){this.scrollHeight=this.$elScroll.innerHeight();var t=this.getStartWeek(e);this.weeks.push(t);var i=new a({today:this.today,dates:t});return this.rowViews.push(i),this.$elScroll.append(i.$el),this.rowHeight=i.$el.outerHeight(),this},renderPrevWeeks:function(e){for(var t=e||1;t>0;t--){var i=this.getPrevWeek(this.weeks[0][0]);this.weeks.unshift(i);var n=new a({today:this.today,dates:i});this.rowViews.unshift(n),this.$elScroll.prepend(n.$el)}return this},renderNextWeeks:function(e){for(var t=e||1;t>0;t--){var i=this.getNextWeek(this.weeks[this.weeks.length-1][0]);this.weeks.push(i);var n=new a({today:this.today,dates:i});this.rowViews.push(n),this.$elScroll.append(n.$el)}return this},getStartWeek:function(e){for(var t=[],i=e.sy,n=e.sm-1,s=e.sd,a=this.getDateInWhichDayOfWeek(e),r=a;r>0;r--)t.push(this.convertDate(new Date(i,n,s-r)));t.push(e);for(var o=7-a-1,r=1;o>=r;r++)t.push(this.convertDate(new Date(i,n,s+r)));return t},getPrevWeek:function(e){for(var t=[],i=e.sy,n=e.sm-1,s=e.sd,a=7;a>0;a--)t.push(this.convertDate(new Date(i,n,s-a)));return t},getNextWeek:function(e){for(var t=[],i=e.sy,n=e.sm-1,s=e.sd,a=7;14>a;a++)t.push(this.convertDate(new Date(i,n,s+a)));return t},getDateInWhichWeekOfMonth:function(e){var t=e.sy,i=e.sm,n=e.sd,s=this.getDateInWhichDayOfWeek(e),a=this.convertDate(new Date(t,i-1,n-s));return a.sm!=i||1==a.sd?0:Math.ceil((a.sd-1)/7)},getDateInWhichDayOfWeek:function(e){var t=e.sw,i=n.getWeekStartDay(),s=(0==t?7:t)-1;return 0==i?s+1:6==i?s+2:s},convertDate:function(e){var t=this.cc.solar2lunar(e),i=t.sYear,n=t.sMonth,s=t.sMonthName,a=t.sDay,r={"日":0,"一":1,"二":2,"三":3,"四":4,"五":5,"六":6};return{sy:i,sm:n,smn:s,sd:a,symd:i+"-"+(10>n?"0"+n:n)+"-"+(10>a?"0"+a:a),sw:r[t.week],sW:t.week,ly:t.lYear,lm:t.lMonth,ld:t.lDay,lY:t.lunarYear,lM:t.lunarMonth,lD:t.lunarDay,st:t.solarTerms,sf:t.solarFestival,lf:t.lunarFestival}},setRange:function(){var e,t=this.$el.height(),i=this.$elLable.outerHeight(),n=this.$cNav.outerHeight(),s=this.$elScroll.scrollTop(),a=t-n-i,r=this.rowHeight||132,o=s%r;e=60>o?this.weeks[(s-o)/r][0]:this.weeks[(s-o)/r+1][0];var l,c=(s+a)%r,d=(s+a-c)/r;return c>12?l=this.weeks[d][6]:(d=0>d-1?0:d-1,l=this.weeks[d][6]),this.rangeDateBegin=e,this.rangeDateEnd=l,this},setRangeTitle:function(){var e=moment(this.rangeDateBegin.symd),t=moment(this.rangeDateEnd.symd);this.$elRange.removeAttr("style");var i=e.diff(t,"days");i=Math.floor(i/2);var n=t.add(i,"day"),s=n.format(c);this.$elRange.text(s)},scrollRangeTitle:function(){var e=moment(this.rangeDateBegin.symd),t=e.format(c);this.$elRange.text(t)},refreshTasks:function(){var e=this.rangeDateBegin,t=this.rangeDateEnd;return e&&t&&s.refreshTasksByDueDateRangeForTKCalendar(new Date(e.sy,e.sm-1,e.sd),new Date(t.sy,t.sm-1,t.sd)),this},setToday:function(e){if(e){var t=this.convertDate(e),i=this.today;if(!t||!i||t.sd!=i.sd||t.sm!=i.sm||t.sy!=i.sy){this.today=t;for(var n=this.rowViews.length,s=0;n>s;s++)this.rowViews[s].setToday(t)}}},getWeekIndex:function(e){var t=-1;if(e){var i=e.symd,n=this.weeks,s=n.length;e:for(var a=0;s>a;a++)for(var r=n[a],o=0;7>o;o++)if(i==r[o].symd){t=a;break e}}return t},scrollToDate:function(e){var t=e||this.today,i=this.getWeekIndex(t);if(-1==i)this.renderFrom().scrollToDate();else{var n=this.getDateInWhichWeekOfMonth(t),s=this.scrollHeight+1,a=this.rowHeight,r=Math.floor(s/a),o=i-(n>=r?r-1:n);this.$elScroll.scrollTop(a*(o>0?o:0))}return this.setRange(),this},scrollToPrevMonth:function(){var e=this.getWeekIndex(this.rangeDateBegin);e:for(;;){0==--e?(this.renderPrevWeeks(),e=1):this.$elScroll.scrollTop(this.rowHeight*e);for(var t=this.weeks[e],i=0;7>i;i++)if(1==t[i].sd)break e}return this.setRange(),this},scrollToNextMonth:function(){var e=this.getWeekIndex(this.rangeDateBegin);e:for(;;){var t=this.scrollHeight,i=this.rowHeight,n=Math.floor(t/i);++e==this.weeks.length-n&&this.renderNextWeeks(),this.$elScroll.scrollTop(this.rowHeight*e);for(var s=this.weeks[e],a=0;7>a;a++)if(1==s[a].sd)break e}return this.setRange(),this},doScrollToToday:function(){this.scrollToDate(),r.c_btn("today")},doScrollToPrevMonth:function(){this.scrollToPrevMonth(),r.c_btn("last_month")},doScrollToNextMonth:function(){this.scrollToNextMonth(),r.c_btn("next_month")},doScroll:function(){if(!this.scrollLock){this.scrollLock=!0,this.doScrollStart();var e=this;return setTimeout(function(){for(;;){var t=e.$elScroll.scrollTop(),i=e.scrollHeight,n=e.rowHeight,s=e.rowViews.length;if(n>t)e.renderPrevWeeks(),e.$elScroll.scrollTop(t+n);else{if(!(t>n*s-i-n))break;e.renderNextWeeks()}}e.scrollLock=!1,e.setRange(),e.scrollRangeTitle()},0),this}},doScrollStart:function(){return this.$elScroll.addClass("c-scrolling"),this},doScrollStop:function(){var e=this;return this.scrollLock||this.setRange(),setTimeout(function(){e.scrollLock||e.refreshTasks()},600),setTimeout(function(){e.scrollLock||(e.$elScroll.removeClass("c-scrolling"),e.setRangeTitle())},800),this},initScrollbar:function(){this.$(".antiscroll-wrap").antiscroll()},onClose:function(){o.hasOutDetail=!1;for(var e=this.rowViews.length-1;e>=0;e--)this.rowViews[e]&&this.rowViews[e].onClose();this.remove(),s.clearCalendarData()}})}),define("view/tasklist/group",["require","exports","module","view/tasklist/base","dao/project-group","service/task","configs/dict","configs/status","utils/hash","dao/taskdb"],function(e,t){{var i=e("view/tasklist/base").View,n=(e("dao/project-group").db,e("service/task")),s=(e("configs/dict"),e("configs/status"));e("utils/hash"),e("dao/taskdb").db}t.View=i.extend({messages:function(){this.listenTo(this.project,"change:name",this.renderProjectTitleName),this.constructor.__super__.messages&&this.constructor.__super__.messages.call(this)},events:function(){return i.prototype.events.call(this)},initialize:function(e){_.extend(this,e),this.project=e.project,this.projectNameTemplate=this.templateProjectNameActionbar,this.messages(),this.initSupportSort(),this.constructor.__super__.initialize.apply(this,[e])},render:function(){try{this[this.sortBy(this.project.get("sortType")||s.CurrentSortType)](!0)}catch(e){this.sortByDueDate(!0)}return this.clearDetailView(),this},initSupportSort:function(){this.supportSortByList=["byList","byDueDate","byTitle","byPriority"]},fetchCompletedTasks:function(){var e=this.getProjectIds();this.projectIds=e.join(","),e.length&&n.fetchCompletedTasksPagination(this.projectIds,30,this.firstTime),this.firstTime=!1,this.showLoadingView()},preloadTasks:function(e){return this._preloadGroupTasks(e)},_preloadGroupTasks:function(e){var t=[],i=this.getProjectIds();return this.projectIds=i.join(","),i.length&&(t=n.getTodoTasksByProjectIds(this.projectIds,e)),t},sortBySortOrder:function(){this.sortByProject()}})}),define("hbs!template/pref_row",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r="",o="function",l=this.escapeExpression;return r+='<div class="row-left text-secondary">',(a=i.rowTitle)?a=a.call(t,{hash:{},data:s}):(a=t.rowTitle,a=typeof a===o?a.apply(t):a),r+=l(a)+'</div>\n<div class="left s-menu">\n  \n</div>\n\n'})}),define("view/modal/setting-tabs/pref/row",["require","exports","module","modules/drop-menu/menu","hbs!template/pref_row"],function(e,t){var i=e("modules/drop-menu/menu").Menu;t.View=Backbone.View.extend({template:e("hbs!template/pref_row"),className:"row clearfix",events:{},initialize:function(){this.render()},render:function(){this.$el.html(this.template({rowTitle:this.rowTitle}))},_createMenu:function(e,t){var n=new i({data:e,select:t});return this.$(".s-menu").prepend(n.el),n},save:function(e){this.model.save(),e||Backbone.trigger("needToLoadwholePage")}})}),define("view/modal/setting-tabs/pref/set-theme",["require","exports","module","lang/index","view/modal/setting-tabs/pref/row","utils/analytics"],function(e,t){var i=e("lang/index"),n=e("view/modal/setting-tabs/pref/row").View,s=e("utils/analytics");t.View=n.extend({initialize:function(){this.rowTitle=i.get("theme"),this.constructor.__super__.initialize.apply(this),this.initMenu()},_getData:function(){var e={colors:["#617fde","#313643"],colorMap:{"#617fde":"classic","#313643":"dark"},themeMap:{classic:"#617fde",dark:"#313643"}};return e},initMenu:function(){var e=this,t=this._getData(),i=this.model.get("theme"),n=t.colors.indexOf(t.themeMap[i]);this.$(".s-menu").colorPicker({defaultColor:~n?n:0,columns:2,noColor:!0,color:t.colors,click:function(i){var n=t.colorMap[i];e.afterSelectTheme(n)}})},afterSelectTheme:function(e){var t=this.model.get("theme");if(t!==e){var i=!0;this.model.set("theme",e),this.save(i),s.set_theme(e)}}})}),define("view/modal/setting-tabs/pref/set-language",["require","exports","module","lang/index","configs/settings","configs/regexp","utils/analytics","view/modal/setting-tabs/pref/row","service/userProfile"],function(e,t){var i=e("lang/index"),n=e("configs/settings"),s=e("configs/regexp"),a=e("utils/analytics"),r=e("view/modal/setting-tabs/pref/row").View,o=e("service/userProfile");t.View=r.extend({id:"set-language-menu",className:"row clearfix",initialize:function(e){this.rowTitle=i.get("set_language"),this.constructor.__super__.initialize.apply(this,[e]),this.events=_.extend({},r.prototype.events,this.events),this.initMenu()},thanksInfo:function(e){var t={ru:"Vadim Barsukov",pt:"Mauro Cunha Ramos",uk:"Leokha Fedir",it:"Antonio Pasquale",pl:"Waldemar Prabucki",lt:"Arūnas"},i=t[e];i?this.showThanks(i):this.hideThanks()},showThanks:function(e){var t,i=this.$(".thanks");t=n.iscnlang?"*感谢 %s 提供翻译。":"*Thank %s for translation.",t=t.replace("%s",e),i.text(t).show()},hideThanks:function(){var e=this.$(".thanks");e.hide()},_getData:function(){var e=[{key:"en_US",value:"English"
},{key:"zh_CN",value:"简体中文"},{key:"it",value:"Italiano‬"},{key:"lt",value:"Lietuvių"},{key:"pl",value:"Polski"},{key:"pt",value:"Português"},{key:"ru",value:"Pусский"},{key:"uk",value:"Українська"},{key:"ko",value:"한국어"},{key:"ja",value:"日本語"},{key:"none",value:i.get("language_is_not_available")}];return e},initMenu:function(){var e=this,t=this._getData(),i=_.pluck(t,"key"),s=n.language,a=_.find(i,function(e){return e.replace("_","-").toLowerCase()==s}),r=a?a:"en_US";this.menu=this._createMenu(t,r),this.menu.on("select",function(t){e.saveLanguage(t.key)})},saveLanguage:function(e){var t=o.get("username"),i=s.emailRegexp.test(t)?t:"",n="https://docs.google.com/forms/d/1Sdj-SFoH0gvR2U6fX4qxWQJ9A5F1TuVp0_4hHfhaInE/viewform?entry.580223055="+i,r=this.model.get("language");e!==r&&("none"!==e?(this.model.set("language",e),this.save()):(a.set_lang("not_available"),window.open(n)))}})}),define("view/modal/setting-tabs/pref/time-format",["require","exports","module","lang/index","view/modal/setting-tabs/pref/row"],function(e,t){var i=e("lang/index"),n=e("view/modal/setting-tabs/pref/row").View;t.View=n.extend({initialize:function(){this.rowTitle=i.get("time_format"),this.constructor.__super__.initialize.apply(this),this.initMenu()},_getData:function(){var e=[{key:"12",value:i.get("time_format_12")},{key:"24",value:i.get("time_format_24")}];return e},initMenu:function(){var e=this,t=this._getData(),i=this.model.get("showMeridiem")?"12":"24";this.menu=this._createMenu(t,i),this.menu.on("select",function(t){e.model.set("showMeridiem","12"===t.key),e.save()})}})}),define("view/modal/setting-tabs/pref/week-start",["require","exports","module","lang/index","view/modal/setting-tabs/pref/row"],function(e,t){var i=e("lang/index"),n=e("view/modal/setting-tabs/pref/row").View;t.View=n.extend({initialize:function(){this.rowTitle=i.get("start_of_week"),this.constructor.__super__.initialize.apply(this),this.initMenu()},_getData:function(){var e=[{key:"SUN",value:i.get("start_on_sunday")},{key:"MON",value:i.get("start_on_monday")},{key:"SAT",value:i.get("start_on_saturday")}];return e},initMenu:function(){var e=this,t=this._getData(),i=this.model.get("startDayOfWeek");this.menu=this._createMenu(t,i),this.menu.on("select",function(t){e.model.set("startDayOfWeek",t.key),e.save()})}})}),define("view/modal/setting-tabs/pref/daily-remind",["require","exports","module","lang/index","configs/dict","configs/settings","utils/index","view/modal/setting-tabs/pref/row"],function(e,t){var i=e("lang/index"),n=(e("configs/dict"),e("configs/settings")),s=e("utils/index"),a=e("view/modal/setting-tabs/pref/row").View;t.View=a.extend({messages:function(){this.listenTo(this.model,"change:showMeridiem",this.changeMeridiem)},initialize:function(){this.initText(),this.constructor.__super__.initialize.apply(this),this.initComments(),this.listenEvent(),this.initTimePicker(),this.messages()},initComments:function(){this._createMenu(),this.createActionBtn(),this.renderDesc()},initText:function(){this.rowTitle=i.get("daily_remind_time"),this.textDisable=i.get("settings_disable_daily"),this.textEnable=i.get("settings_enable_daily"),this.textDesc=i.get("settings_daily_remind_desc").replace("%s1",n.productName),this.textNever=i.get("never_remind")},renderDesc:function(){var e='<p class="text-sml text-info-title daily-info">%s1</p>';e=e.replace("%s1",this.textDesc),this.$(".s-menu").append(e)},_createMenu:function(){var e=this.model.get("dailyRemindTime"),t=this.model.getLocalHourString(e)||"",i='<input class="input-sml" type="text" placeholder="%s1">';i=i.replace("%s1",this.textNever);var n=this.$input=$(i);n.val(t),"-1"==this.model.get("dailyRemindTime")&&n.addClass("hide"),this.$(".s-menu").prepend(n)},createActionBtn:function(){var e='<p><a class="action">%s1</a></p>',t="-1"==this.model.get("dailyRemindTime")?this.textEnable:this.textDisable;e=e.replace("%s1",t),this.$(".s-menu").append(e)},listenEvent:function(){var e=this;this.$(".s-menu .action").on("click",function(){var t=e.model.get("dailyRemindTime");"-1"!=t?(e.$input.addClass("hide"),$(this).text(e.textEnable),e.model.setDailyRemindTime(""),e.save()):(e.$input.removeClass("hide"),$(this).text(e.textDisable),e.model.setDailyRemindTime(e.getDailyRemindTime()),e.$input.timepicker("setTime",e.getDailyRemindTime()),e.save())}),this.$input.on("blur",function(){e.model.setDailyRemindTime(e.$input.val()),e.save()})},initTimePicker:function(){var e=this;this.$input.on("keydown",s.timeKeyLimit),this.$input.timepicker({template:!1,showMeridian:this.model.get("showMeridiem"),defaultTime:e.getDailyRemindTime(),showTimeSelect:!1})},changeMeridiem:function(){this.$input.val()&&(this.$input.timepicker("setShowMeridian",this.model.get("showMeridiem")),this.$input.timepicker("setTime",this.getDailyRemindTime()))},getDailyRemindTime:function(){return this.model.getLocalHourString(this.model.getDailyRemindTime())}})}),define("view/modal/setting-tabs/pref/smart_parsing",["require","exports","module","lang/index","offline/storage","view/modal/setting-tabs/pref/row"],function(e,t){var i=e("lang/index"),n=e("offline/storage"),s=e("view/modal/setting-tabs/pref/row").View;t.View=s.extend({initialize:function(){this.initText(),this.constructor.__super__.initialize.apply(this),this.initData(),this.initMenu(),this.renderActionBtn(),this.renderDesc(),this.listenEvent()},initText:function(){this.rowTitle=i.get("smart_date_parsing"),this.textDisable=i.get("settings_disable_smart"),this.textEnable=i.get("settings_enable_smart"),this.textDesc=i.get("settings_smart_parsing_desc")},initData:function(){this.smartDateParsing=n.getStoreInfo("smartDateParsing"),!this.smartDateParsing&&(this.smartDateParsing="show")&&this.save()},_getData:function(){var e=[{key:"show",value:i.get("keep_text_in_tasks")},{key:"hide",value:i.get("remove_text_in_tasks")}];return e},initMenu:function(){var e=this,t=this._getData(),i=this.smartDateParsing;this.menu=this._createMenu(t,i),this.menu.on("select",function(t){e.smartDateParsing=t.key,this.el.find(".select-title").text(t.value),e.save()}),"-1"==i&&this.menu.el.addClass("hide")},renderActionBtn:function(){var e='<p><a class="action">%s1</a></p>',t="-1"==this.smartDateParsing?this.textEnable:this.textDisable;e=e.replace("%s1",t),this.$(".s-menu").append(e)},renderDesc:function(){var e='<p class="text-sml text-info-title daily-info">%s1</p>';e=e.replace("%s1",this.textDesc),this.$(".s-menu").append(e)},listenEvent:function(){var e=this;this.$(".action").on("click",function(){var t=e.smartDateParsing;"-1"!=t?(e.menu.el.addClass("hide"),$(this).text(e.textEnable),e.smartDateParsing="-1",e.save()):(e.menu.el.removeClass("hide"),$(this).text(e.textDisable),e.smartDateParsing="show",e.menu.trySelectItem("show"),e.save())})},save:function(){n.setStoreInfo("smartDateParsing",this.smartDateParsing)}})}),define("view/modal/setting-tabs/pref/main",["require","exports","module","lang/index","utils/timeformat","service/prefs","modules/drop-menu/menu","utils/analytics","view/modal/setting-tabs/pref/set-theme","view/modal/setting-tabs/pref/set-language","view/modal/setting-tabs/pref/time-format","view/modal/setting-tabs/pref/week-start","view/modal/setting-tabs/pref/daily-remind","view/modal/setting-tabs/pref/smart_parsing"],function(e,t){var i=(e("lang/index"),e("utils/timeformat"),e("service/prefs"),e("modules/drop-menu/menu").Menu,e("utils/analytics")),n=e("view/modal/setting-tabs/pref/set-theme").View,s=e("view/modal/setting-tabs/pref/set-language").View,a=e("view/modal/setting-tabs/pref/time-format").View,r=e("view/modal/setting-tabs/pref/week-start").View,o=e("view/modal/setting-tabs/pref/daily-remind").View,l=e("view/modal/setting-tabs/pref/smart_parsing").View;t.View=Backbone.View.extend({className:"pref-panel",initialize:function(){this.render(),this.initComponent(),this.recordData()},events:{"click #save-preference-modal-btn":"saveUserPreference"},render:function(){this.$el.html()},initComponent:function(){var e={model:this.model};this.renderComponent(new n(e)),this.renderComponent(new s(e)),this.renderComponent(new a(e)),this.renderComponent(new r(e)),this.renderComponent(new o(e)),this.renderComponent(new l(e))},renderComponent:function(e){this.$el.append(e.$el)},recordData:function(){var e=this.model.get("dailyRemindTime");e=this.model.getLocalHourString(e)||"no",this.oldData={lang:this.model.get("language"),format:this.model.get("showMeridiem")?"12":"24",daily:e}},analyticsData:function(){var e=this.oldData,t=this.model.get("dailyRemindTime");t=this.model.getLocalHourString(t)||"no";var n={lang:this.model.get("language"),format:this.model.get("showMeridiem")?"12":"24",daily:t};e.lang!==n.lang&&i.set_lang(n.lang),e.format!==n.format&&i.set_format(n.format),e.daily!==n.daily&&i.set_daily(n.daily)},saveUserPreference:function(){this.model.save(),l&&l.save(),this.analyticsData()}})}),define("hbs!template/smart_project_row",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r="",o="function",l=this.escapeExpression;return r+='\n<div class="row-left text-secondary">'+l((a=t.model,a=null==a||a===!1?a:a.name,typeof a===o?a.apply(t):a))+'</div>\n<div class="left s-menu">\n  \n</div>\n\n\n'})}),define("view/modal/setting-tabs/smart-project/item",["require","exports","module","modules/drop-menu/menu","configs/dict","lang/index","view/modal/get-upgrade","dao/projectdb","service/prefs","service/userProfile","hbs!template/smart_project_row"],function(e,t){var i=e("modules/drop-menu/menu").Menu,n=e("configs/dict"),s=e("lang/index"),a=e("view/modal/get-upgrade").View,r=(e("dao/projectdb").db,e("service/prefs")),o=e("service/userProfile");t.View=Backbone.View.extend({template:e("hbs!template/smart_project_row"),className:"row bd-divider clearfix",events:{},initialize:function(){this.render()},createMenu:function(){var e=[{key:"auto",value:s.get("auto")},{key:"show",value:s.get("show")},{key:"hide",value:s.get("hide")}],t=this.model.get("status");(this.model.get("id")===n.smartProjectId.tkcalendar||this.model.get("id")===n.smartProjectId.trash)&&e.splice(0,1);var a=this.menu=new i({data:e,select:t});this.$(".s-menu").prepend(a.el);var r=this;return a.on("select",function(e){r.saveChange(e.key)}),a},_getStatusKeyById:function(e){switch(e){case n.smartProjectId.all:return"showAllList";case n.smartProjectId.today:return"showTodayList";case n.smartProjectId.week:return"showNext7DaysList";case n.smartProjectId.tkcalendar:return"showTKCalendar";case n.smartProjectId.assignedme:return"showAssignedMeList";case n.smartProjectId.completed:return"showCompletedList";case n.smartProjectId.trash:return"showTrashList"}},render:function(){this.$el.html(this.template({model:this.model.toJSON()})),this.createMenu()},saveChange:function(e){return this.model.get("id")!==n.smartProjectId.tkcalendar||o.isPro()||"show"!==e?(this.model.set("status",e),r.set(this._getStatusKeyById(this.model.get("id")),e),void r.save()):(new a({type:n.smartProjectId.tkcalendar}),void this.menu.trySelectItem("hide"))}})}),define("view/modal/setting-tabs/smart-project/main",["require","exports","module","view/modal/setting-tabs/smart-project/item","configs/dict","dao/projectdb"],function(e,t){var i=e("view/modal/setting-tabs/smart-project/item").View,n=e("configs/dict"),s=e("dao/projectdb").db;t.View=Backbone.View.extend({className:"smart-project-panel",initialize:function(){this.render(),this.initComponent()},render:function(){this.$el.html()},initComponent:function(){var e=n.smartProjectId,t=[e.all,e.today,e.week,e.tkcalendar,e.assignedme,e.completed,e.trash];_.each(t,function(e){this.renderComponent(new i({model:s.getSmartProjectById(e)}))},this)},renderComponent:function(e){this.$el.append(e.$el)}})}),define("hbs!template/service_row",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o="",l="function",c=this.escapeExpression,d=i.helperMissing;return o+='<div class="row-left text-secondary">',(a=i.textTitle)?a=a.call(t,{hash:{},data:s}):(a=t.textTitle,a=typeof a===l?a.apply(t):a),o+=c(a)+'</div>\n<div class="row-right">\n  <p class="desc line-sml">',(a=i.textDesc)?a=a.call(t,{hash:{},data:s}):(a=t.textDesc,a=typeof a===l?a.apply(t):a),(a||0===a)&&(o+=a),o+='</p>\n  <ul></ul>\n  <div class="action-result hide">\n    <input type="text" placeholder="',(a=i.textHolder)?a=a.call(t,{hash:{},data:s}):(a=t.textHolder,a=typeof a===l?a.apply(t):a),o+=c(a)+'">\n    <p class="text-alert hide line-sml">',(a=i.textAlert)?a=a.call(t,{hash:{},data:s}):(a=t.textAlert,a=typeof a===l?a.apply(t):a),o+=c(a)+'</p>\n    <p class="text-info-title text-sml action-info hide line-sml">',(a=i.textInfo)?a=a.call(t,{hash:{},data:s}):(a=t.textInfo,a=typeof a===l?a.apply(t):a),o+=c(a)+'</p>\n  </div>\n  <a class="action-btn">',(a=i.textEnable)?a=a.call(t,{hash:{},data:s}):(a=t.textEnable,a=typeof a===l?a.apply(t):a),o+=c(a)+'</a>\n  <a class="cancel-btn hide">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"cancel",r):d.call(t,"I18n","cancel",r)))+'</a>\n</div>\n<div class="clearfix"></div>\n'})}),define("view/modal/setting-tabs/service/row",["require","exports","module","hbs!template/service_row"],function(e,t){t.View=Backbone.View.extend({template:e("hbs!template/service_row"),className:"row bd-divider clearfix",events:{"click .action-btn":"actionFn","click .cancel-btn":"cancelFn"},render:function(){this.$el.html(this.template({textTitle:this.textTitle||"",textDesc:this.textDesc||"",textEnable:this.textEnable||"",textHolder:this.textHolder||"",textAlert:this.textAlert||"",textInfo:this.textInfo||""}))}})}),define("hbs!template/unsubscribe",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o="",l=i.helperMissing,c=this.escapeExpression;return o+='<div class="popup-header">\n    <a class="popup-close">&times;</a>\n    <h1 class="popup-title text-lrg text-primary">\n        ',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"settings_cal_subscription_close",r):l.call(t,"I18n","settings_cal_subscription_close",r)))+'\n    </h1>\n</div>\n\n<div class="popup-body">\n  <p>',r={hash:{},data:s},o+=c((a=i.I18n_Plus,a?a.call(t,"settings_cal_unsubscription_confirm",t.productName,r):l.call(t,"I18n_Plus","settings_cal_unsubscription_confirm",t.productName,r)))+'</p>\n</div>\n\n<div class="popup-footer">\n    <button type="button" class="btn btn-cancel cancel">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"cancel",r):l.call(t,"I18n","cancel",r)))+'</button>\n    <button type="button" class="btn btn-primary confirm">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"confirm",r):l.call(t,"I18n","confirm",r)))+"</button>\n</div>\n"})}),define("view/modal/setting-tabs/service/unsubscribe",["require","exports","module","configs/settings","modules/popup/popup","hbs!template/unsubscribe"],function(e,t){var i=e("configs/settings"),n=e("modules/popup/popup").View;t.View=Backbone.View.extend({className:"unsubscribe",template:e("hbs!template/unsubscribe"),events:{"click .cancel":"close","click .confirm":"confirm"},initialize:function(e){this.initData(e),this.render()},initData:function(e){_.extend(this,e)},render:function(){this.$el.html(this.template({productName:i.productName})),this.popupView=new n({view:this})},close:function(){this.popupView.onRemove()},confirm:function(){this.action(),this.close()}})}),define("hbs!template/edit_subscribe",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o,l="",c=i.helperMissing,d=this.escapeExpression,u="function";return l+='<div class="popup-header">\n    <a class="popup-close">&times;</a>\n    <h1 class="popup-title text-lrg text-primary">\n        ',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"edit",o):c.call(t,"I18n","edit",o)))+'\n    </h1>\n</div>\n\n<div class="popup-body">\n  <input class="input-lrg input-w100" type="text" value="',(r=i.url)?r=r.call(t,{hash:{},data:s}):(r=t.url,r=typeof r===u?r.apply(t):r),l+=d(r)+'">\n  <p class="text-alert line-sml hide">',(r=i.textAlert)?r=r.call(t,{hash:{},data:s}):(r=t.textAlert,r=typeof r===u?r.apply(t):r),l+=d(r)+'</p>\n</div>\n\n<div class="popup-footer">\n	<a class="text-alert unsubscribe">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"settings_cal_subscription_close",o):c.call(t,"I18n","settings_cal_subscription_close",o)))+'</a>\n    <button type="button" class="btn btn-cancel cancel">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"cancel",o):c.call(t,"I18n","cancel",o)))+'</button>\n    <button type="button" class="btn btn-primary confirm">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"confirm",o):c.call(t,"I18n","confirm",o)))+"</button>\n</div>\n"})}),define("view/modal/setting-tabs/service/edit-subscribe",["require","exports","module","configs/settings","modules/popup/popup","hbs!template/edit_subscribe"],function(e,t){var i=(e("configs/settings"),e("modules/popup/popup").View);t.View=Backbone.View.extend({className:"edit-subscribe",template:e("hbs!template/edit_subscribe"),events:{"click .unsubscribe":"unsubscribe","click .cancel":"close","click .confirm":"confirm","click input":"hideError"},initialize:function(e){this.initData(e),this.render(),this.initDom()},initData:function(e){_.extend(this,e)},initDom:function(){this.$input=this.$("input"),this.$alert=this.$(".popup-body .text-alert"),this.$confirm=this.$(".confirm"),this.$unsubscribe=this.$(".unsubscribe")},render:function(){this.$el.html(this.template({url:this.url,textAlert:this.textAlert})),this.popupView=new i({view:this})},unsubscribe:function(){this.unsubscribe()},close:function(){this.popupView.onRemove()},confirm:function(){var e=this.$input.val();e!==this.url?this.action(e):this.close()},saving:function(e){this.textConfirm=this.$confirm.text(),this.$unsubscribe.addClass("hide"),this.$confirm.text(e).attr("disabled","disabled")},saved:function(){this.$unsubscribe.removeClass("hide"),this.$confirm.text(this.textConfirm).removeAttr("disabled")},hideError:function(){this.$unsubscribe.removeClass("hide"),this.$input.removeClass("input-alert"),this.$alert.addClass("hide")},renderError:function(e){this.$confirm.text(this.textConfirm).removeAttr("disabled"),this.$unsubscribe.addClass("hide"),this.$input.addClass("input-alert"),e&&this.$alert.text(e),this.$alert.removeClass("hide")}})}),define("view/modal/setting-tabs/service/subscribe",["require","exports","module","lang/index","view/modal/setting-tabs/service/row","dao/projectdb","dao/scalendardb","service/plugin","utils/server","utils/analytics","configs/dict","configs/limit","configs/settings","view/modal/get-upgrade","view/modal/setting-tabs/service/unsubscribe","view/modal/setting-tabs/service/edit-subscribe","service/userProfile"],function(e,t){var i=e("lang/index"),n=e("view/modal/setting-tabs/service/row").View,s=e("dao/projectdb").db,a=e("dao/scalendardb").db,r=(e("service/plugin"),e("utils/server")),o=e("utils/analytics"),l=e("configs/dict"),c=e("configs/limit"),d=e("configs/settings"),u=e("view/modal/get-upgrade").View,h=e("view/modal/setting-tabs/service/unsubscribe").View,p=e("view/modal/setting-tabs/service/edit-subscribe").View,m=e("service/userProfile");t.View=n.extend({events:{"click input":"enterEditMode","click .edit_btn":"showEditPop"},initialize:function(){this.editing=!1,this.saving=!1,this.initText(),this.render(),this.initDom(),this.renderStatus(),this.events=_.extend({},n.prototype.events,this.events)},initText:function(){this.textTitle=i.get("settings_cal_subscription_title"),this.textDesc=i.get("settings_cal_subscription_desc").replace("%s1",d.productName),this.textEnable=i.get("settings_cal_subscription_enable"),this.textClose=i.get("settings_cal_subscription_close"),this.textHolder=i.get("settings_cal_subscription_holder"),this.textAlert=i.get("settings_cal_subscription_alert"),this.textSubscribed=i.get("settings_cal_subscription_subscribed"),this.textSave=i.get("save")},initDom:function(){this.$result=this.$(".action-result"),this.$action=this.$(".action-btn"),this.$cancel=this.$(".cancel-btn"),this.$input=this.$("input"),this.$alert=this.$(".text-alert"),this.$list=this.$("ul")},renderStatus:function(){this.sproject=s.getSubscribeList(),this.sproject?this.renderSubscribed():this._unsubscribe()},isSubscribed:function(e){for(var t in this.sproject)if(this.sproject[t]&&e===this.sproject[t].url)return!0;return!1},_showInput:function(){this.$result.removeClass("hide"),this.$input.removeClass("input-alert").focus()},renderSubscribed:function(){var e=this,t=[],i=this.sproject;_.each(i,function(i,n){i&&t.push(e.renderSubscribedItem(i,n))}),this.$list.html(t.join(""))},renderSubscribedItem:function(e,t){var n=[];return n.push('<li class="text-secondary">'),n.push(e.name||e.url),n.push('<a class="right edit_btn" data="'),n.push(t),n.push('">'),n.push(i.get("edit")),n.push("</a></li>"),n.join("")},renderUnSubscribed:function(e){this.$list.find('a[data="'+e+'"]').parent().remove(),this.editSubscribe&&this.editSubscribe.close(),this.exitEditMode()},enterEditMode:function(){this.editing=!0,this.hideError(),this._showInput(),this.$action.text(this.textSave),this.$cancel.removeClass("hide")},exitEditMode:function(){this.$input.val(""),this.$result.addClass("hide"),this.$cancel.addClass("hide"),this.$action.text(this.textEnable),this.editing=!1},actionFn:function(){return m.isPro()?c.subscribeLimit<=_.keys(this.sproject).length?void new u({type:"subscribe"}):void(this.editing?!this.saving&&this.createSubscribe():this.enterEditMode()):void new u({type:l.pluginId.calSubscribe})},cancelFn:function(){this.exitEditMode()},enable:function(){this.sproject.get("url")?this.renderSubscribed():this.enterEditMode()},_unsubscribe:function(e){var t=this.sproject;t[e]=null,delete t[e],this.renderUnSubscribed(e),this.sproject=t,a.deleteCalendar(e,function(){o.s_btn("delete")}),Backbone.trigger("needToLoadwholePage")},disable:function(e){var t=_.bind(this._unsubscribe,this,e);new h({action:t})},showEditPop:function(e){var t=this,i=$(e.target).attr("data"),n=this.sproject[i],s=_.bind(this.saveCalendar,this,i),a=_.bind(this.disable,this,i);this.editSubscribe=new p({url:n.url,textAlert:t.textAlert,action:s,unsubscribe:a})},createSubscribe:function(){var e=this.$input.val().trim(),t=this;if(!e)return void this.renderError();var i={url:this.checkWebcals(e)};return this.isSubscribed(i.url)?(this.renderError(this.textSubscribed),!1):(this.saving=!0,this.$action.text(this.textSave+"..."),this.hideError(),void r.postCalendarSubscribe(JSON.stringify(i),function(e){var i=t.sproject||{};i[e.id]={name:e.name,url:e.url},t.sproject=i,t.renderSubscribed(),Backbone.trigger("needToLoadwholePage"),o.s_btn("add"),t.exitEditMode(),t.saving=!1},function(e){t.saving=!1,t.renderError()}))},saveCalendar:function(e,t){var i=this,n={url:this.checkWebcals(t),id:e};return this.isSubscribed(n.url)?(this.editSubscribe.renderError(this.textSubscribed),!1):(this.editSubscribe.saving(this.textSave+"..."),void r.postCalendarSubscribe(JSON.stringify(n),function(e){var t=i.sproject||{};t[e.id]={name:e.name,url:e.url},i.sproject=t,i.editSubscribe.close(),i.editSubscribe.saved(),i.renderSubscribed(),Backbone.trigger("needToLoadwholePage"),o.s_btn("edit")},function(e){i.editSubscribe.renderError()}))},hideError:function(){this.$input.removeClass("input-alert"),this.$alert.addClass("hide")},renderError:function(e){this.$action.text(this.textSave),this.$input.addClass("input-alert");var e=e||this.textAlert;this.$alert.text(e).removeClass("hide")},checkWebcals:function(e){return e?e.replace(/webcals/i,"webcal"):""}})}),define("view/modal/setting-tabs/service/subscribe-tick",["require","exports","module","configs/settings","lang/index","utils/server","utils/analytics","view/modal/setting-tabs/service/row"],function(e,t){var i=e("configs/settings"),n=e("lang/index"),s=e("utils/server"),a=e("utils/analytics"),r=e("view/modal/setting-tabs/service/row").View;t.View=r.extend({events:{"click input":"selectInput"},initialize:function(){this.initText(),this.render(),this.initDom(),this.getUrlFeedStatus(),this.events=_.extend({},r.prototype.events,this.events)},initText:function(){this.textTitle=n.get("settings_subscribe_tick_title").replace("%s1",i.productName),this.textDesc=n.get("settings_subscribe_tick_desc").replace("%s1",i.productName),this.textEnable=n.get("settings_subscribe_tick_enable"),this.textClose=n.get("settings_subscribe_tick_close"),this.textHolder="",this.textInfo=n.get("settings_subscribe_tick_info")},initDom:function(){this.$result=this.$(".action-result"),this.$action=this.$(".action-btn"),this.$input=this.$("input"),this.$info=this.$(".text-info-title")},actionFn:function(){this.isEnabled?this.disable():this.enable()},getUrlFeedStatus:function(){var e=this;this.isEnabled=!1,s.getCalendarFeeds(function(t){e.isEnabled=!0,e.renderEnabled(),e.renderUrl(t)},function(){e.renderDisabled()})},renderEnabled:function(){this.$action.text(this.textClose),this.$result.removeClass("hide"),this.$info.removeClass("hide")},renderDisabled:function(){this.$action.text(this.textEnable),this.$result.addClass("hide"),this.$info.addClass("hide")},renderUrl:function(e){var t="webcal://"+i.domain+"/pub/calendar/feeds/"+e+"/basic.ics";this.renderInput(t)},renderInput:function(e){this.$input.val(e).attr("readonly","true")},selectInput:function(){this.$input.select()},enable:function(){var e=this;e.isEnabled=!0,s.makeCalendarFeeds(function(t){e.renderEnabled(),e.renderUrl(t)},function(){}),a.set_sub("enable")},disable:function(){var e=this;e.isEnabled=!1,s.disableCalendarFeeds(function(){e.renderDisabled()},function(){}),a.set_sub("disable")}})}),define("view/modal/setting-tabs/service/mail",["require","exports","module","configs/settings","lang/index","utils/server","utils/analytics","view/modal/setting-tabs/service/row"],function(e,t){var i=e("configs/settings"),n=e("lang/index"),s=e("utils/server"),a=e("utils/analytics"),r=e("view/modal/setting-tabs/service/row").View;t.View=r.extend({events:{"click input":"selectInput"},initialize:function(){this.initText(),this.render(),this.initDom(),this.getMailCode(),this.events=_.extend({},r.prototype.events,this.events)},initText:function(){this.textTitle=n.get("settings_mail_service_title"),this.textDesc=n.get("settings_mail_service_desc").replace("%s1",i.productName).replace(/%s2/g,i.domain),this.textEnable=n.get("settings_mail_service_enable"),this.textClose=n.get("settings_mail_service_close"),this.textReset=n.get("reset_mail"),this.textHolder="",this.textInfo=n.get("settings_mail_service_info").replace("%s1",i.productName)},initDom:function(){this.$result=this.$(".action-result"),this.$action=this.$(".action-btn"),this.$input=this.$("input"),this.$info=this.$(".text-info-title")},getMailCode:function(){var e=this;s.getMailCode(function(t){e.renderMailCode(t),e.renderEnabled()})},renderMailCode:function(e){var t="todo+"+e+"@mail."+i.domain;this.$input.val(t).attr("readonly","true")},renderEnabled:function(){this.$action.text(this.textReset),this.$result.removeClass("hide"),this.$info.removeClass("hide")},selectInput:function(){this.$input.select()},resetCode:function(){var e=this;s.resetMailCode(function(t){e.renderMailCode(t)}),a.set_mail("reset")},actionFn:function(){this.resetCode()}})}),define("view/modal/setting-tabs/service/main",["require","exports","module","view/modal/setting-tabs/service/subscribe","view/modal/setting-tabs/service/subscribe-tick","view/modal/setting-tabs/service/mail"],function(e,t){var i=e("view/modal/setting-tabs/service/subscribe").View,n=e("view/modal/setting-tabs/service/subscribe-tick").View,s=e("view/modal/setting-tabs/service/mail").View;t.View=Backbone.View.extend({className:"service-panel",initialize:function(){this.render(),this.initComponent()},render:function(){this.$el.html()},initComponent:function(){var e={model:this.model};this.renderComponent(new i(e)),this.renderComponent(new n(e)),this.renderComponent(new s(e))},renderComponent:function(e){this.$el.append(e.$el)}})}),define("hbs!template/backup_generate",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){var n,s,a="";return a+='\n    <br>\n    <a href="/import/#ticktick" target="_blank">',s={hash:{},data:t},a+=u((n=i.I18n,n?n.call(e,"import_from_tick",s):d.call(e,"I18n","import_from_tick",s)))+"</a>\n    "}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var r,o,l,c="",d=i.helperMissing,u=this.escapeExpression,h=this,p="function",m=i.blockHelperMissing;return c+='<p class="title text-secondary">',l={hash:{},data:s},c+=u((r=i.I18n,r?r.call(t,"settings_backup_and_restore",l):d.call(t,"I18n","settings_backup_and_restore",l)))+'</p>\n<div class="btns">\n  <button id="btn-generate" class="btn-sml btn-secondary">',l={hash:{},data:s},c+=u((r=i.I18n,r?r.call(t,"settings_backup_generate",l):d.call(t,"I18n","settings_backup_generate",l)))+'</button>\n  <div id="btn-import" class="btn btn-sml btn-secondary file-wrap" title="',l={hash:{},data:s},c+=u((r=i.I18n,r?r.call(t,"settings_backup_file_type",l):d.call(t,"I18n","settings_backup_file_type",l)))+'">\n    <span>',l={hash:{},data:s},c+=u((r=i.I18n,r?r.call(t,"settings_backup_import",l):d.call(t,"I18n","settings_backup_import",l)))+'</span>\n    <input type="file" name="file" accept=".json,.csv">\n  </div>\n</div>\n<div class="desc text-sml text-info-title">\n    ',l={hash:{},data:s},c+=u((r=i.I18n,r?r.call(t,"settings_backup_file_desc",l):d.call(t,"I18n","settings_backup_file_desc",l)))+"\n    ",l={hash:{},inverse:h.noop,fn:h.program(1,a,s),data:s},(o=i.ifcn)?o=o.call(t,l):(o=t.ifcn,o=typeof o===p?o.apply(t):o),i.ifcn||(o=m.call(t,o,l)),(o||0===o)&&(c+=o),c+='\n</div>\n\n\n<div class="import-apps text-secondary">',l={hash:{},data:s},c+=u((r=i.I18n,r?r.call(t,"settings_backup_from_apps",l):d.call(t,"I18n","settings_backup_from_apps",l)))+"</div>\n"})}),define("view/modal/setting-tabs/backup/generate",["require","exports","module","utils/analytics","utils/server","configs/settings","utils/timeformat","lang/index","hbs!template/backup_generate"],function(e,t){var i=e("utils/analytics"),n=e("utils/server"),s=e("configs/settings"),a=e("utils/timeformat"),r=e("lang/index");t.View=Backbone.View.extend({template:e("hbs!template/backup_generate"),className:"generate",events:{"click #btn-generate":"generate"},initialize:function(){this.render(),this.initDom(),this.initImport()},render:function(){this.$el.html(this.template())},initDom:function(){this.$btnGen=this.$("#btn-generate"),this.$btnImp=this.$("#btn-import")},getSaveName:function(){var e=s.isCnSites?"Dida":"TickTick";return e+"-backup-"+a.getDueDateText(new Date)+".csv"},generate:function(){var e=this,t=r.get("settings_backup_generate"),a=r.get("settings_backup_generating"),o=r.get("settings_backup_limit");this.generating||(this.generating=!0,e.$btnGen.text(a),window.Blob?n.downloadBackup(function(i){var n=new Blob([i],{encoding:"UTF-16LE",type:"text/csv;charset=UTF-16LE"});saveAs(n,e.getSaveName()),e.generating=!1,e.$btnGen.text(t)},function(){e.generating=!1,e.$btnGen.text(o)}):(e.generating=!1,e.$btnGen.text(t),window.open(s.API_HOST+"/data/export")),i.set_account("backup"))},initImport:function(){var e=this,t=s.API_HOST_V1+"/import/restore",n=r.get("settings_backup_import"),a=n+"...";this.$btnImp.find("input").fileupload({url:t,dataType:"json",cache:!1,singleFileUploads:!0,add:function(t,i){e.importing||(e.importing=!0,e.$btnImp.text(a),i.submit())},done:function(e,t){i.set_account("import_backup"),window.location.href="/"},fail:function(e,t){},always:function(){e.importing=!1,e.$btnImp.text(n)}})}})}),define("hbs!template/backup_row",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o,l="",c="function",d=this.escapeExpression,u=i.helperMissing;return l+='<div class="row-left text-secondary">\n  <span class="r-name">',(a=i.rName)?a=a.call(t,{hash:{},data:s}):(a=t.rName,
a=typeof a===c?a.apply(t):a),l+=d(a)+'</span>\n</div>\n<div class="row-right">\n  <form id="import" action="',(a=i.rAction)?a=a.call(t,{hash:{},data:s}):(a=t.rAction,a=typeof a===c?a.apply(t):a),l+=d(a)+'" method="post" enctype="multipart/form-data" class="file-wrap">\n    <a>\n    <span>',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"settings_backup_import_btn",o):u.call(t,"I18n","settings_backup_import_btn",o)))+'</span>\n    <input type="file" name="file" accept="',(r=i.rAccept)?r=r.call(t,{hash:{},data:s}):(r=t.rAccept,r=typeof r===c?r.apply(t):r),l+=d(r)+'">\n    </a>\n  </form>\n</div>\n\n'})}),define("view/modal/setting-tabs/backup/row",["require","exports","module","hbs!template/backup_row"],function(e,t){t.View=Backbone.View.extend({template:e("hbs!template/backup_row"),className:"row bd-divider clearfix",events:{"change input":"import"},initialize:function(){this.initProps(),this.render()},render:function(){this.$el.html(this.template({rName:this.rName,rAction:this.rAction,rAccept:this.rAccept}))},"import":function(){this.$("form")[0].submit()}})}),define("view/modal/setting-tabs/backup/wunderlist",["require","exports","module","view/modal/setting-tabs/backup/row"],function(e,t){var i=e("view/modal/setting-tabs/backup/row").View;t.View=i.extend({initProps:function(){this.rName="Wunderlist",this.rAction="/import/wunderlist",this.rAccept=".json"}})}),define("view/modal/setting-tabs/backup/astrid",["require","exports","module","view/modal/setting-tabs/backup/row"],function(e,t){var i=e("view/modal/setting-tabs/backup/row").View;t.View=i.extend({initProps:function(){this.rName="Astrid",this.rAction="/import/astrid",this.rAccept=".csv"}})}),define("view/modal/setting-tabs/backup/springpad",["require","exports","module","view/modal/setting-tabs/backup/row"],function(e,t){var i=e("view/modal/setting-tabs/backup/row").View;t.View=i.extend({initProps:function(){this.rName="Springpad",this.rAction="/import/springpad",this.rAccept=".json"}})}),define("view/modal/setting-tabs/backup/toodledo",["require","exports","module","view/modal/setting-tabs/backup/row"],function(e,t){var i=e("view/modal/setting-tabs/backup/row").View;t.View=i.extend({initProps:function(){this.rName="Toodledo",this.rAction="/import/toodledo",this.rAccept=".csv"}})}),define("hbs!template/backup_ical_row",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o,l="",c=i.helperMissing,d=this.escapeExpression,u="function";return l+='<div class="popup-header">\n  <a class="popup-close">&times;</a>\n  <h1 class="popup-title text-med text-primary">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"settings_backup_import_ical",o):c.call(t,"I18n","settings_backup_import_ical",o)))+'</h1>\n</div>\n\n<div class="popup-body">\n  <form action="',(r=i.rAction)?r=r.call(t,{hash:{},data:s}):(r=t.rAction,r=typeof r===u?r.apply(t):r),l+=d(r)+'" method="post" enctype="multipart/form-data">\n    <div class="line clearfix">\n      <div class="left text-secondary">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"settings_backup_select_file",o):c.call(t,"I18n","settings_backup_select_file",o)))+'</div>\n      <div class="left file-wrap">\n        <button class="btn-primary btn-sml">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"settings_backup_select_file",o):c.call(t,"I18n","settings_backup_select_file",o)))+'</button>\n        <p class="file-name text-info text-sml"></p>\n        <input class="file-input" type="file" name="file" accept="',(r=i.rAccept)?r=r.call(t,{hash:{},data:s}):(r=t.rAccept,r=typeof r===u?r.apply(t):r),l+=d(r)+'">\n      </div>\n    </div>\n\n    <div class="line clearfix">\n      <div class="left text-secondary">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"settings_backup_import_list",o):c.call(t,"I18n","settings_backup_import_list",o)))+'</div>\n      <div class="left s-menu">\n        <div class="select-menu">\n          <div class="select-title" data-toggle="dropdown">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"list_inbox",o):c.call(t,"I18n","list_inbox",o)))+'</div>\n          <div class="select-arrow" data-toggle="dropdown">▾</div>\n        </div>\n        \n      </div>\n    </div>\n\n    <select id="select" name="projectId" class="hide">\n      <option value="" selected></option>\n    </select>\n  </form>\n</div>\n\n<div class="popup-footer">\n    <button id="cancel" class="btn-sml btn-cancel">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"cancel",o):c.call(t,"I18n","cancel",o)))+'</button>\n    <button id="import" class="btn-sml btn-primary">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"settings_backup_import_btn",o):c.call(t,"I18n","settings_backup_import_btn",o)))+"</button>\n</div>\n"})}),define("view/modal/setting-tabs/backup/ical-pop",["require","exports","module","modules/project-menu/menu","dao/projectdb","modules/popup/popup","hbs!template/backup_ical_row"],function(e,t){var i=e("modules/project-menu/menu").View,n=e("dao/projectdb").db,s=e("modules/popup/popup").View;t.View=Backbone.View.extend({template:e("hbs!template/backup_ical_row"),className:"ical-pop",events:{"click #cancel":"cancel","click #import":"import","change input":"selectFile"},initialize:function(e){_.extend(this,e),this.render(),this.initDom(),this.initMenu()},initDom:function(){this.$file=this.$(".file-name"),this.$input=this.$(".file-input")},render:function(){this.$el.html(this.template({rAction:this.rAction,rAccept:this.rAccept})),this.renderPop()},renderPop:function(){this.popupView=new s({view:this})},"import":function(){this.$("form")[0].submit()},cancel:function(){this.hidePop()},hidePop:function(){this.popupView.onRemove(),this.projectMenu&&this.projectMenu.remove()},selectFile:function(){var e=this.$input[0],t=e.files[0]&&e.files[0].name;this.$file.text(t)},initMenu:function(){var e=n.projectInbox.get("id"),t=this.$(".select-menu");this.projectMenu=new i({projectId:e,action:_.bind(this.setSelect,this),$wrap:t})},setSelect:function(e){var t=e.attr("projectId"),i=e.text();this.$("#select option").val(t),this.$(".select-title").text(i)}})}),define("view/modal/setting-tabs/backup/ical",["require","exports","module","view/modal/setting-tabs/backup/row","view/modal/setting-tabs/backup/ical-pop"],function(e,t){var i=e("view/modal/setting-tabs/backup/row").View,n=e("view/modal/setting-tabs/backup/ical-pop").View;t.View=i.extend({events:{"click a":"showPop"},initProps:function(){this.rName="iCal",this.rAction="/import/ics",this.rAccept=".ics"},initialize:function(){this.constructor.__super__.initialize.apply(this),this.$("input").remove()},showPop:function(){new n({rAction:this.rAction,rAccept:this.rAccept})}})}),define("view/modal/setting-tabs/backup/main",["require","exports","module","view/modal/setting-tabs/backup/generate","view/modal/setting-tabs/backup/wunderlist","view/modal/setting-tabs/backup/astrid","view/modal/setting-tabs/backup/springpad","view/modal/setting-tabs/backup/toodledo","view/modal/setting-tabs/backup/ical"],function(e,t){var i=e("view/modal/setting-tabs/backup/generate").View,n=e("view/modal/setting-tabs/backup/wunderlist").View,s=e("view/modal/setting-tabs/backup/astrid").View,a=e("view/modal/setting-tabs/backup/springpad").View,r=e("view/modal/setting-tabs/backup/toodledo").View,o=e("view/modal/setting-tabs/backup/ical").View;t.View=Backbone.View.extend({className:"backup-panel",initialize:function(){this.render(),this.initComponent()},render:function(){this.$el.html()},initComponent:function(){this.renderComponent(new i),this.renderComponent(new n),this.renderComponent(new s),this.renderComponent(new a),this.renderComponent(new r),this.renderComponent(new o)},renderComponent:function(e){this.$el.append(e.$el)}})}),define("hbs!template/labs_item",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){return" checked "}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var r,o,l,c="",d="function",u=this.escapeExpression,h=this,p=i.helperMissing;return c+='<div class="v-background"></div>\n\n<div class="v-header">\n  <i class="icon_home icon-',(r=i.icon)?r=r.call(t,{hash:{},data:s}):(r=t.icon,r=typeof r===d?r.apply(t):r),c+=u(r)+'"></i>\n</div>\n\n<div class="v-content">\n  <p class="v-title">'+u((r=t.model,r=null==r||r===!1?r:r.title,typeof r===d?r.apply(t):r))+'</p>\n  <p class="v-info text-info-title text-sml">'+u((r=t.model,r=null==r||r===!1?r:r.description,typeof r===d?r.apply(t):r))+'</p>\n\n  <div class="switch small round">\n    <input id="'+u((r=t.model,r=null==r||r===!1?r:r.id,typeof r===d?r.apply(t):r))+'" type="checkbox" ',l={hash:{},inverse:h.noop,fn:h.program(1,a,s),data:s},r=i.iftrue,o=r?r.call(t,(r=t.model,null==r||r===!1?r:r.enabled),l):p.call(t,"iftrue",(r=t.model,null==r||r===!1?r:r.enabled),l),(o||0===o)&&(c+=o),c+='>\n    <label for="'+u((r=t.model,r=null==r||r===!1?r:r.id,typeof r===d?r.apply(t):r))+'"></label>\n  </div>\n\n</div>\n\n'})}),define("view/modal/setting-tabs/labs/item",["require","exports","module","configs/dict","service/plugin","view/modal/get-upgrade","service/userProfile","hbs!template/labs_item"],function(e,t){var i=e("configs/dict"),n=e("service/plugin"),s=e("view/modal/get-upgrade").View,a=e("service/userProfile");t.View=Backbone.View.extend({template:e("hbs!template/labs_item"),className:"vcard transition",events:{"click input":"changeShow"},iconMap:{"s-tag":i.pluginId.tag,"s-copy":i.pluginId.duplicate,"s-min-cal":i.pluginId.calendar,"s-t-activity":i.pluginId.taskActivity},initialize:function(){this.iconMap=_.invert(this.iconMap),this.initPlugin(),this.renderStatus()},renderStatus:function(){this.model.get("enabled")?this.$el.addClass("active"):this.$el.removeClass("active")},initPlugin:function(){this.plugin=this.model,this.render()},render:function(){this.$el.html(this.template({model:this.plugin.toJSON(),icon:this.iconMap[this.plugin.id]}))},changeShow:function(){var e=this.$("input").prop("checked");return _.contains(i.plugin.pro_only,this.plugin.id)&&!a.isPro()&&e?(new s({type:this.plugin.id}),void this.$("input").prop("checked",!1)):(this.plugin.set("enabled",e),this.save(),void this.renderStatus())},save:function(){n.applyChanges(),Backbone.trigger("needToLoadwholePage")}})}),define("view/modal/setting-tabs/labs/main",["require","exports","module","configs/dict","service/plugin","view/modal/setting-tabs/labs/item"],function(e,t){var i=e("configs/dict"),n=e("service/plugin"),s=e("view/modal/setting-tabs/labs/item").View;t.View=Backbone.View.extend({className:"labs-panel",initialize:function(){this.render(),this.initComponent()},render:function(){this.$el.html()},initComponent:function(){var e=[i.pluginId.tag,i.pluginId.duplicate,i.pluginId.taskActivity,i.pluginId.calendar];_.each(e,function(e){this.renderComponent(new s({model:n.getPlugin(e)}))},this)},renderComponent:function(e){this.$el.append(e.$el)}})}),define("hbs!template/premium_header",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){var n,s,a="";return a+='\n <div class="header-inner">\n  <div class="header-pro">\n    <i class="icon_home icon-setting-pro icon"></i>\n    <div class="pro-info">\n      <p class="title">',s={hash:{},data:t},a+=u((n=i.I18n,n?n.call(e,"settings_premium_pro_desc",s):d.call(e,"I18n","settings_premium_pro_desc",s)))+'</p>\n      <p class="info">\n        <span class="">',s={hash:{},data:t},a+=u((n=i.I18n,n?n.call(e,"settings_premium_billing_date",s):d.call(e,"I18n","settings_premium_billing_date",s)))+'</span>\n        <span class="date">',s={hash:{format:"YYYY-M-D"},data:t},a+=u((n=i.dateFormat,n?n.call(e,e.end_date,s):d.call(e,"dateFormat",e.end_date,s)))+'</span>\n        <a href="/payment" target="_blank" class="renew">',s={hash:{},data:t},a+=u((n=i.I18n,n?n.call(e,"settings_premium_renew",s):d.call(e,"I18n","settings_premium_renew",s)))+'</a>\n      </p>  \n    </div>  \n  </div>\n </div>\n <p class="privileges-header">',s={hash:{},data:t},a+=u((n=i.I18n,n?n.call(e,"settings_premium_enjoying",s):d.call(e,"I18n","settings_premium_enjoying",s)))+"</p>\n\n"}function r(e,t){var n,s,a="";return a+='\n  <div class="header-inner">\n    <div class="title">\n      <span>',s={hash:{},data:t},a+=u((n=i.I18n,n?n.call(e,"settings_premium_upgrade",s):d.call(e,"I18n","settings_premium_upgrade",s)))+'</span>\n      <i class="icon_home icon-setting-pro-mid icon icon-sup"></i>    \n    </div>\n    <a href="/payment?target=month" target="_blank" class="btn month">',s={hash:{},data:t},a+=u((n=i.I18n,n?n.call(e,"settings_premium_cost_month",s):d.call(e,"I18n","settings_premium_cost_month",s)))+'</a>\n    <a href="/payment?target=year" target="_blank" class="btn year">',s={hash:{},data:t},a+=u((n=i.I18n,n?n.call(e,"settings_premium_cost_year",s):d.call(e,"I18n","settings_premium_cost_year",s)))+'</a>\n  </div>\n\n  <p class="privileges-header">',s={hash:{},data:t},a+=u((n=i.I18n,n?n.call(e,"settings_premium_privileges",s):d.call(e,"I18n","settings_premium_privileges",s)))+"</p>\n\n"}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var o,l,c="",d=i.helperMissing,u=this.escapeExpression,h=this,p="function",m=i.blockHelperMissing;return c+="\n",l={hash:{},inverse:h.program(3,r,s),fn:h.program(1,a,s),data:s},(o=i.ifpro)?o=o.call(t,l):(o=t.ifpro,o=typeof o===p?o.apply(t):o),i.ifpro||(o=m.call(t,o,l)),(o||0===o)&&(c+=o),c})}),define("view/modal/setting-tabs/premium/header",["require","exports","module","configs/settings","hbs!template/premium_header"],function(e,t){var i=e("configs/settings");t.View=Backbone.View.extend({template:e("hbs!template/premium_header"),className:"premium-header",initialize:function(){this.render()},render:function(){this.$el.html(this.template({end_date:i.end_date}))}})}),define("hbs!template/premium_item",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o="",l="function",c=this.escapeExpression;return o+='\n<span class="p-icon">\n  ',a=t.model,a=null==a||a===!1?a:a.pIcon,r=typeof a===l?a.apply(t):a,(r||0===r)&&(o+=r),o+='\n</span>\n\n<div class="desc">\n  <p class="title">'+c((a=t.model,a=null==a||a===!1?a:a.pTitle,typeof a===l?a.apply(t):a))+'</p>\n  <p class="info text-info-title">'+c((a=t.model,a=null==a||a===!1?a:a.pInfo,typeof a===l?a.apply(t):a))+"</p>\n</div>\n\n"})}),define("view/modal/setting-tabs/premium/item",["require","exports","module","hbs!template/premium_item"],function(e,t){t.View=Backbone.View.extend({template:e("hbs!template/premium_item"),className:"premium-item",initialize:function(e){this.render(e)},render:function(e){this.$el.html(this.template({model:e}))}})}),define("view/modal/setting-tabs/premium/body",["require","exports","module","lang/index","configs/settings","view/modal/setting-tabs/premium/item","utils/index"],function(e,t){var i=e("lang/index"),n=e("configs/settings"),s=e("view/modal/setting-tabs/premium/item").View,a=e("utils/index");t.View=Backbone.View.extend({className:"premium-body",initialize:function(){this.render()},render:function(){this.$el.html(),this.initComponent()},initComponent:function(){var e=this.getOptions();_.each(e,function(e){this.renderComponent(new s(e))},this)},renderComponent:function(e){this.$el.append(e.$el)},getOptions:function(){var e=[["s-pro-subtask-desc","settings_premium_description_of_checklist","settings_premium_description_of_checklist_desc"],["s-pro-cal","settings_premium_cal_view","settings_premium_cal_view_desc"],["s-pro-subscribe","settings_premium_cal_subscription","settings_premium_cal_subscription_desc"],["s-pro-limit","settings_premium_lists_tasks","settings_premium_lists_tasks_desc"],["s-pro-reminder","settings_premium_reminders","settings_premium_reminders_desc"],["s-pro-share","settings_premium_share","settings_premium_share_desc"],["s-pro-attachment","settings_premium_attachments","settings_premium_attachments_desc"],["s-pro-t-activity","settings_premium_task_activities","settings_premium_task_activities_desc"],["s-pro-search","settings_premium_search","settings_premium_search_desc"],["s-pro-mini-cal","settings_premium_mini_cal","settings_premium_mini_cal_desc"],["s-pro-siri","settings_premium_siri","settings_premium_siri_desc"]];return _.map(e,function(e){return{pIcon:a.imgIcon("icon-"+e[0],"icon_pro"),pTitle:i.get(e[1]),pInfo:i.get(e[2]).replace(/\%s1/g,n.productName)}})}})}),define("view/modal/setting-tabs/premium/main",["require","exports","module","view/modal/setting-tabs/premium/header","view/modal/setting-tabs/premium/body"],function(e,t){var i=e("view/modal/setting-tabs/premium/header").View,n=e("view/modal/setting-tabs/premium/body").View;t.View=Backbone.View.extend({className:"premium-panel",initialize:function(){this.render(),this.initComponent()},render:function(){this.$el.html()},initComponent:function(){this.renderComponent(new i),this.renderComponent(new n)},renderComponent:function(e){this.$el.append(e.$el)}})}),define("utils/btns",["require","exports","module"],function(e,t){t.doing=function(e){e.addClass("ing")},t.done=function(e){e.removeClass("ing")}}),define("hbs!template/redeem",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o,l="",c=i.helperMissing,d=this.escapeExpression,u="function";return l+='<div class="r-icon">\n  ',o={hash:{},data:s},a=i.svgIcon,r=a?a.call(t,"icon-s-redeem","i-8 i-redeem",o):c.call(t,"svgIcon","icon-s-redeem","i-8 i-redeem",o),(r||0===r)&&(l+=r),l+='\n</div>\n\n<p class="r-title">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"settings_premium_redeem_title",o):c.call(t,"I18n","settings_premium_redeem_title",o)))+'</p>\n\n<p class="text-info-title r-account text-sml">\n  <span class="">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"account",o):c.call(t,"I18n","account",o)))+': </span>\n  <span class="account">',(r=i.username)?r=r.call(t,{hash:{},data:s}):(r=t.username,r=typeof r===u?r.apply(t):r),l+=d(r)+'</span>\n</p>\n\n<div class="r-action">\n  <input type="text">\n  <p class="r-error text-alert hide">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"settings_premium_redeem_error",o):c.call(t,"I18n","settings_premium_redeem_error",o)))+'</p>\n</div>\n<div class="btns">\n    <button id="redeem" class="btn-primary btn-sml btn-initial">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"redeem",o):c.call(t,"I18n","redeem",o)))+'</button>\n    <button class="btn-primary btn-sml btn-loading disabled">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"redeem",o):c.call(t,"I18n","redeem",o)))+"...</button>\n</div>\n"})}),define("view/modal/setting-tabs/redeem/main",["require","exports","module","utils/server","utils/hash","utils/btns","configs/keycode","view/tip","lang/index","service/userProfile","hbs!template/redeem"],function(e,t){var i=e("utils/server"),n=e("utils/hash"),s=e("utils/btns"),a=e("configs/keycode"),r=e("view/tip").View,o=e("lang/index"),l=e("service/userProfile");t.View=Backbone.View.extend({template:e("hbs!template/redeem"),className:"redeem-panel",events:{"click #redeem":"redeem","input input":"hideError","keydown input":"keyRedeem"},initialize:function(){this.render(),this.initDom()},initDom:function(){this.$error=this.$(".r-error")},render:function(){this.$el.html(this.template({username:l.get("username")}))},keyRedeem:function(e){var e=e||window.event;e.keyCode===a.enter&&this.redeem()},redeem:function(){var e=this.$("input").val(),t=1e3,a=this;e&&(s.doing(this.$(".btns")),i.redeem(e,function(e){s.done(this.$(".btns")),e.success?(new r({text:o.get("settings_premium_redeem_success"),delayTime:t}),setTimeout(function(){n.reload()},t)):a.showError()},function(){a.showError(),s.done(this.$(".btns"))}))},hideError:function(){this.$error.addClass("hide")},showError:function(){this.$error.removeClass("hide")}})}),define("hbs!template/shortcuts_helper",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o,l="",c=i.helperMissing,d=this.escapeExpression,u="function";return l+='\n<div class="col">\n  <div class="col-left text-secondary">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"navigation",o):c.call(t,"I18n","navigation",o)))+'</div>\n  <div class="col-right">\n    <div class="line clearfix">\n      <span class="text left">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"goto_all",o):c.call(t,"I18n","goto_all",o)))+'</span>\n      <div class="text line-right">\n        <span class="key">TAB</span>\n        <span class="join">+</span>\n        <span class="key">a</span>\n      </div>\n    </div>\n\n    <div class="line clearfix">\n      <span class="text left">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"goto_completed",o):c.call(t,"I18n","goto_completed",o)))+'</span>\n      <div class="text line-right">\n        <span class="key">TAB</span>\n        <span class="join">+</span>\n        <span class="key">c</span>\n      </div>\n    </div>\n\n    <div class="line clearfix">\n      <span class="text left">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"goto_trash",o):c.call(t,"I18n","goto_trash",o)))+'</span>\n      <div class="text line-right">\n        <span class="key">TAB</span>\n        <span class="join">+</span>\n        <span class="key">t</span>\n      </div>\n    </div>\n\n    <div class="line clearfix">\n      <span class="text left">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"goto_list",o):c.call(t,"I18n","goto_list",o)))+'</span>\n      <div class="text line-right">\n        <span class="key">TAB</span>\n        <span class="join">+</span>\n        <span class="key">l</span>\n      </div>\n    </div>\n\n  </div>\n</div>\n\n<div class="col">\n  <div class="col-left text-secondary">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"select_range",o):c.call(t,"I18n","select_range",o)))+'</div>\n  <div class="col-right">\n    <div class="line clearfix">\n      <span class="text left">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"change_selection",o):c.call(t,"I18n","change_selection",o)))+'</span>\n      <div class="text line-right">\n        <span class="key">↑</span>\n        <span class="join">/</span>\n        <span class="key">↓</span>\n      </div>\n    </div>\n\n    <div class="line clearfix">\n      <span class="text left">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"select_range",o):c.call(t,"I18n","select_range",o)))+'</span>\n      <div class="text line-right">\n        <span class="key">Shift</span>\n        <span class="join">+</span>\n        <span class="key">Click</span>\n      </div>\n    </div>\n\n    <div class="line clearfix">\n      <span class="text left">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"select_range",o):c.call(t,"I18n","select_range",o)))+'</span>\n      <div class="text line-right">\n        <span class="key">Shift</span>\n        <span class="join">+</span>\n        <span class="key">↑</span>\n        <span class="join">/</span>\n        <span class="key">Shift</span>\n        <span class="join">+</span>\n        <span class="key">↓</span>\n      </div>\n    </div>\n\n    <div class="line clearfix">\n      <span class="text left">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"multi_select",o):c.call(t,"I18n","multi_select",o)))+'</span>\n      <div class="text line-right">\n        <span class="key">',(r=i.commandKey)?r=r.call(t,{hash:{},data:s}):(r=t.commandKey,r=typeof r===u?r.apply(t):r),l+=d(r)+'</span>\n        <span class="join">+</span>\n        <span class="key">Click</span>\n      </div>\n    </div>\n\n  </div>\n</div>\n\n<div class="col">\n  <div class="col-left text-secondary">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"actions",o):c.call(t,"I18n","actions",o)))+'</div>\n  <div class="col-right">\n    <div class="line clearfix">\n      <span class="text left">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"new_task",o):c.call(t,"I18n","new_task",o)))+'</span>\n      <div class="text line-right">\n        <span class="key">TAB</span>\n        <span class="join">+</span>\n        <span class="key">n</span>\n      </div>\n    </div>\n\n    <div class="line clearfix">\n      <span class="text left">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"delete_task",o):c.call(t,"I18n","delete_task",o)))+'</span>\n      <div class="text line-right">\n        <span class="key">',(r=i.commandKey)?r=r.call(t,{hash:{},data:s}):(r=t.commandKey,r=typeof r===u?r.apply(t):r),l+=d(r)+'</span>\n        <span class="join">+</span>\n        <span class="key">BKSP</span>\n        <span class="join">/</span>\n        <span class="key">Del</span>\n      </div>\n    </div>\n\n    <div class="line clearfix">\n      <span class="text left">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"save_task",o):c.call(t,"I18n","save_task",o)))+'</span>\n      <div class="text line-right">\n        <span class="key">',(r=i.commandKey)?r=r.call(t,{hash:{},data:s}):(r=t.commandKey,r=typeof r===u?r.apply(t):r),l+=d(r)+'</span>\n        <span class="join">+</span>\n        <span class="key">s</span>\n      </div>\n    </div>\n\n    <div class="line clearfix">\n      <span class="text left">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"complete_task",o):c.call(t,"I18n","complete_task",o)))+'</span>\n      <div class="text line-right">\n        <span class="key">TAB</span>\n        <span class="join">+</span>\n        <span class="key">m</span>\n      </div>\n    </div>\n\n    <div class="line clearfix">\n      <span class="text left">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"set_due_date",o):c.call(t,"I18n","set_due_date",o)))+'</span>\n      <div class="text line-right">\n        <span class="key">TAB</span>\n        <span class="join">+</span>\n        <span class="key">d</span>\n      </div>\n    </div>\n\n    <div class="line clearfix">\n      <span class="text left">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"set_today",o):c.call(t,"I18n","set_today",o)))+'</span>\n      <div class="text line-right">\n        <span class="key">TAB</span>\n        <span class="join">+</span>\n        <span class="key">1</span>\n      </div>\n    </div>\n\n    <div class="line clearfix">\n      <span class="text left">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"set_tomorrow",o):c.call(t,"I18n","set_tomorrow",o)))+'</span>\n      <div class="text line-right">\n        <span class="key">TAB</span>\n        <span class="join">+</span>\n        <span class="key">2</span>\n      </div>\n    </div>\n\n    <div class="line clearfix">\n      <span class="text left">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"set_nextweek",o):c.call(t,"I18n","set_nextweek",o)))+'</span>\n      <div class="text line-right">\n        <span class="key">TAB</span>\n        <span class="join">+</span>\n        <span class="key">3</span>\n      </div>\n    </div>\n\n  </div>\n</div>\n\n<div class="col">\n  <div class="col-left text-secondary">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"input_box",o):c.call(t,"I18n","input_box",o)))+'</div>\n  <div class="col-right">\n    <div class="line clearfix">\n      <span class="text left">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"add_task_to_custom_project",o):c.call(t,"I18n","add_task_to_custom_project",o)))+'</span>\n      <div class="text line-right">\n        <span class="">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"input",o):c.call(t,"I18n","input",o)))+'</span>\n        <span class="key">^</span>\n      </div>\n    </div>\n\n    <div class="line clearfix">\n      <span class="text left">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"set_date_for_task_added",o):c.call(t,"I18n","set_date_for_task_added",o)))+'</span>\n      <div class="text line-right">\n        <span class="">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"input",o):c.call(t,"I18n","input",o)))+'</span>\n        <span class="key">*</span>\n      </div>\n    </div>\n  </div>\n</div>\n'})}),define("view/modal/setting-tabs/shortcuts/main",["require","exports","module","utils/browser","hbs!template/shortcuts_helper"],function(e,t){var i=e("utils/browser");t.View=Backbone.View.extend({className:"shortcuts-panel",template:e("hbs!template/shortcuts_helper"),initialize:function(){this.commandKey=i.isMac?"⌘":"Ctrl",this.render()},render:function(){this.$el.html(this.template({commandKey:this.commandKey}))}})}),define("hbs!template/support",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){var n,s,a,o="";return o+='\n      <a class="l-item" href="http://weibo.com/ticktickteam" target="_blank">\n        ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-weibo","i-lrg i-4",a):m.call(e,"svgIcon","icon-weibo","i-lrg i-4",a),(s||0===s)&&(o+=s),o+='\n        <p class="text-info-title text-sml">',a={hash:{},data:t},o+=f((n=i.I18n,n?n.call(e,"weibo",a):m.call(e,"I18n","weibo",a)))+'</p>\n      </a>\n      <input type="text" id="copy-input" value="205208598" class="copy-holder">\n      <span class="l-item ',(s=i.copyClass)?s=s.call(e,{hash:{},data:t}):(s=e.copyClass,s=typeof s===g?s.apply(e):s),o+=f(s)+'">\n        ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-qq","i-lrg i-4",a):m.call(e,"svgIcon","icon-qq","i-lrg i-4",a),(s||0===s)&&(o+=s),o+='\n        <p class="text-info-title text-sml">',a={hash:{},inverse:v.noop,fn:v.program(2,r,t),data:t},(s=i.ifzh)?s=s.call(e,a):(s=e.ifzh,s=typeof s===g?s.apply(e):s),i.ifzh||(s=y.call(e,s,a)),(s||0===s)&&(o+=s),o+="205208598</p>\n      </span>\n    "}function r(e,t){return"群 "}function o(e,t){var n,s,a,r="";return r+='\n      <a class="l-item" href="https://www.facebook.com/pages/Tick-Tick/114408518756703" target="_blank">\n        ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-facebook","i-lrg i-4",a):m.call(e,"svgIcon","icon-facebook","i-lrg i-4",a),(s||0===s)&&(r+=s),r+='\n        <p class="text-info-title text-sml">Facebook</p>\n      </a>\n      <a class="l-item" href="https://twitter.com/TickTickTeam" target="_blank">\n        ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-twitter","i-lrg i-4",a):m.call(e,"svgIcon","icon-twitter","i-lrg i-4",a),(s||0===s)&&(r+=s),r+='\n        <p class="text-info-title text-sml">Twitter</p>\n      </a>\n    '}function l(e,t){var n,s,a,r="";return r+='\n    <a class="l-item" href="/static/getApp/download?type=apk" target="_blank">\n      ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-android","i-lrg i-4",a):m.call(e,"svgIcon","icon-android","i-lrg i-4",a),(s||0===s)&&(r+=s),r+='\n      <p class="text-info-title text-sml">Android</p>\n    </a>\n    <a class="l-item" href="https://itunes.apple.com/cn/app/di-da-qing-dan-dai-ban-shi/id626144601?mt=8" target="_blank">\n      ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-ios","i-lrg i-4",a):m.call(e,"svgIcon","icon-ios","i-lrg i-4",a),(s||0===s)&&(r+=s),r+='\n      <p class="text-info-title text-sml">iOS</p>\n    </a>\n  '}function c(e,t){var n,s,a,r="";return r+='\n    <a class="l-item" href="https://play.google.com/store/apps/details?id=com.ticktick.task" target="_blank">\n      ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-android","i-lrg i-4",a):m.call(e,"svgIcon","icon-android","i-lrg i-4",a),(s||0===s)&&(r+=s),r+='\n      <p class="text-info-title text-sml">Android</p>\n    </a>\n    <a class="l-item" href="https://itunes.apple.com/app/tick-tick/id626144601" target="_blank">\n      ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-ios","i-lrg i-4",a):m.call(e,"svgIcon","icon-ios","i-lrg i-4",a),(s||0===s)&&(r+=s),r+='\n      <p class="text-info-title text-sml">iOS</p>\n    </a>\n  '}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var d,u,h,p="",m=i.helperMissing,f=this.escapeExpression,g="function",v=this,y=i.blockHelperMissing;return p+='<div class="s-row">\n  \n  <h5 class="title text-lrg text-primary">',h={hash:{},data:s},p+=f((d=i.I18n_Plus,d?d.call(t,"settings_support_title",(d=t.model,null==d||d===!1?d:d.productName),h):m.call(t,"I18n_Plus","settings_support_title",(d=t.model,null==d||d===!1?d:d.productName),h)))+'</h5>\n  <p class="text-secondary">',h={hash:{},data:s},d=i.I18n_Plus,u=d?d.call(t,"settings_support_dest_guide",(d=t.model,
null==d||d===!1?d:d.domain),(d=t.model,null==d||d===!1?d:d.productName),h):m.call(t,"I18n_Plus","settings_support_dest_guide",(d=t.model,null==d||d===!1?d:d.domain),(d=t.model,null==d||d===!1?d:d.productName),h),(u||0===u)&&(p+=u),p+='</p>\n  <p class="text-secondary">',h={hash:{},data:s},d=i.I18n_Plus,u=d?d.call(t,"settings_support_dest_help",(d=t.model,null==d||d===!1?d:d.domain),h):m.call(t,"I18n_Plus","settings_support_dest_help",(d=t.model,null==d||d===!1?d:d.domain),h),(u||0===u)&&(p+=u),p+='</p>\n\n  <div class="links">\n    <a class="l-item" href="http://guide.'+f((d=t.model,d=null==d||d===!1?d:d.domain,typeof d===g?d.apply(t):d))+'" target="_blank">\n      ',h={hash:{},data:s},d=i.svgIcon,u=d?d.call(t,"icon-user-guide","i-lrg i-4",h):m.call(t,"svgIcon","icon-user-guide","i-lrg i-4",h),(u||0===u)&&(p+=u),p+='\n      <p class="text-info-title text-sml">',h={hash:{},data:s},p+=f((d=i.I18n,d?d.call(t,"settings_support_user_guide",h):m.call(t,"I18n","settings_support_user_guide",h)))+'</p>\n    </a>\n    <a class="l-item" href="/forum" target="_blank">\n      ',h={hash:{},data:s},d=i.svgIcon,u=d?d.call(t,"icon-forum","i-lrg i-4",h):m.call(t,"svgIcon","icon-forum","i-lrg i-4",h),(u||0===u)&&(p+=u),p+='\n      <p class="text-info-title text-sml">',h={hash:{},data:s},p+=f((d=i.I18n,d?d.call(t,"settings_support_help",h):m.call(t,"I18n","settings_support_help",h)))+'</p>\n    </a>\n    <a class="l-item" href="mailto:support@'+f((d=t.model,d=null==d||d===!1?d:d.domain,typeof d===g?d.apply(t):d))+'">\n      ',h={hash:{},data:s},d=i.svgIcon,u=d?d.call(t,"icon-email","i-lrg i-4",h):m.call(t,"svgIcon","icon-email","i-lrg i-4",h),(u||0===u)&&(p+=u),p+='\n      <p class="text-info-title text-sml">',h={hash:{},data:s},p+=f((d=i.I18n,d?d.call(t,"email",h):m.call(t,"I18n","email",h)))+"</p>\n    </a>\n\n    ",h={hash:{},inverse:v.program(4,o,s),fn:v.program(1,a,s),data:s},(u=i.ifcn)?u=u.call(t,h):(u=t.ifcn,u=typeof u===g?u.apply(t):u),i.ifcn||(u=y.call(t,u,h)),(u||0===u)&&(p+=u),p+='\n  </div>\n</div>\n\n<div class="s-row get-app">\n  <h5 class="title text-lrg text-primary">',h={hash:{},data:s},p+=f((d=i.I18n,d?d.call(t,"settings_support_get_apps",h):m.call(t,"I18n","settings_support_get_apps",h)))+'</h5>\n  <p class="text-secondary">',h={hash:{},data:s},d=i.I18n_Plus,u=d?d.call(t,"settings_support_platform",(d=t.model,null==d||d===!1?d:d.productName),h):m.call(t,"I18n_Plus","settings_support_platform",(d=t.model,null==d||d===!1?d:d.productName),h),(u||0===u)&&(p+=u),p+='</p>\n  <div class="links">\n  ',h={hash:{},inverse:v.program(8,c,s),fn:v.program(6,l,s),data:s},(u=i.ifcn)?u=u.call(t,h):(u=t.ifcn,u=typeof u===g?u.apply(t):u),i.ifcn||(u=y.call(t,u,h)),(u||0===u)&&(p+=u),p+='\n    <a class="l-item" href="/home#download-link" target="_blank">\n      ',h={hash:{},data:s},d=i.svgIcon,u=d?d.call(t,"icon-platform-more","i-lrg i-4",h):m.call(t,"svgIcon","icon-platform-more","i-lrg i-4",h),(u||0===u)&&(p+=u),p+='\n      <p class="text-info-title text-sml">',h={hash:{},data:s},p+=f((d=i.I18n,d?d.call(t,"settings_support_other_platform",h):m.call(t,"I18n","settings_support_other_platform",h)))+'</p>\n    </a>\n  </div>\n</div>\n\n<div class="s-row thanks">\n  <h5 class="title text-lrg text-primary">',h={hash:{},data:s},p+=f((d=i.I18n,d?d.call(t,"settings_support_thanks",h):m.call(t,"I18n","settings_support_thanks",h)))+'</h5>\n  <p class="p-desc text-secondary">',h={hash:{},data:s},p+=f((d=i.I18n_Plus,d?d.call(t,"settings_support_thanks_p1",(d=t.model,null==d||d===!1?d:d.productName),h):m.call(t,"I18n_Plus","settings_support_thanks_p1",(d=t.model,null==d||d===!1?d:d.productName),h)))+'</p>\n  <p class="p-desc text-secondary">',h={hash:{},data:s},p+=f((d=i.I18n,d?d.call(t,"settings_support_thanks_p2",h):m.call(t,"I18n","settings_support_thanks_p2",h)))+'</p>\n  <ul class="nice-people text-secondary"></ul>\n\n</div>\n'})}),define("view/modal/setting-tabs/support/main",["require","exports","module","configs/settings","utils/dom","lang/index","utils/browser","hbs!template/support"],function(e,t){var i=e("configs/settings"),n=e("utils/dom"),s=e("lang/index"),a=e("utils/browser");t.View=Backbone.View.extend({className:"support-panel",template:e("hbs!template/support"),events:{"click .copy":"copyqq"},initialize:function(){this.render(),this.renderNicePeople()},render:function(){var e={productName:i.productName,domain:i.domain};this.$el.html(this.template({model:e,copyClass:this.isSupportCopy()?"copy cr-pointer":"cr-text"}))},isSupportCopy:function(){return document.execCommand?a.isSafari?!1:!0:!1},renderNicePeople:function(){var e=this.$(".nice-people"),t=[["Portuguese","Mauro Cunha Ramos"],["Russian","Vadim Barsukov"],["Ukrainian","Leokha Fedir"],["Italian","Antonio Pasquale"],["Polish","Waldemar Prabucki"]];t=_.map(t,function(e){return{lang:e[0],author:e[1]}});var i=_.template("<li><span><%= lang %>: </span><%= author %></li>"),n="";_.each(t,function(e){n+=i(e)}),e.append(n)},copyqq:function(){var e=this.$("#copy-input");e.select();var t=!1;try{t=document.execCommand("copy")}catch(i){t=!1}t&&n.showStatus(s.get("copy_qq").replace("%s",e.val()))}})}),define("hbs!template/hard_working",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o,l="",c=i.helperMissing,d=this.escapeExpression,u="function";return l+='<div class="hw-panel">\n    <ul class="hw-list text-secondary">\n        <li class="hw-item">\n            <p class="name">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"task_count",o):c.call(t,"I18n","task_count",o)))+'</p>\n            <p class="number">',(r=i.taskCount)?r=r.call(t,{hash:{},data:s}):(r=t.taskCount,r=typeof r===u?r.apply(t):r),l+=d(r)+"</p>\n            ",o={hash:{},data:s},a=i.svgIcon,r=a?a.call(t,"icon-count-task","i-9 icon",o):c.call(t,"svgIcon","icon-count-task","i-9 icon",o),(r||0===r)&&(l+=r),l+='\n        </li><li class="hw-item">\n            <p class="name">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"completed_count",o):c.call(t,"I18n","completed_count",o)))+'</p>\n            <p class="number">',(r=i.completedCount)?r=r.call(t,{hash:{},data:s}):(r=t.completedCount,r=typeof r===u?r.apply(t):r),l+=d(r)+"</p>\n            ",o={hash:{},data:s},a=i.svgIcon,r=a?a.call(t,"icon-count-completed","i-8 icon",o):c.call(t,"svgIcon","icon-count-completed","i-8 icon",o),(r||0===r)&&(l+=r),l+='\n        </li><li class="hw-item">\n            <p class="name">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"project_count",o):c.call(t,"I18n","project_count",o)))+'</p>\n            <p class="number">',(r=i.projectCount)?r=r.call(t,{hash:{},data:s}):(r=t.projectCount,r=typeof r===u?r.apply(t):r),l+=d(r)+"</p>\n            ",o={hash:{},data:s},a=i.svgIcon,r=a?a.call(t,"icon-count-project","i-10 icon",o):c.call(t,"svgIcon","icon-count-project","i-10 icon",o),(r||0===r)&&(l+=r),l+='\n        </li><li class="hw-item">\n            <p class="name">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"day_count",o):c.call(t,"I18n","day_count",o)))+'</p>\n            <p class="number">',(r=i.dayCount)?r=r.call(t,{hash:{},data:s}):(r=t.dayCount,r=typeof r===u?r.apply(t):r),l+=d(r)+"</p>\n            ",o={hash:{},data:s},a=i.svgIcon,r=a?a.call(t,"icon-count-day","i-11 icon",o):c.call(t,"svgIcon","icon-count-day","i-11 icon",o),(r||0===r)&&(l+=r),l+='\n        </li>\n    </ul>\n    <p class="hw-more-hard">',o={hash:{},data:s},a=i.I18n_Plus,r=a?a.call(t,"exceeded_info",t.ranking,o):c.call(t,"I18n_Plus","exceeded_info",t.ranking,o),(r||0===r)&&(l+=r),l+="</p>\n</div>\n"})}),define("view/modal/setting-tabs/personal/hardworking",["require","exports","module","utils/server","offline/storage","service/userProfile","hbs!template/hard_working"],function(e,t){var i=e("utils/server"),n=e("offline/storage"),s=e("service/userProfile");t.View=Backbone.View.extend({tagName:"div",className:"settings-rank",template:e("hbs!template/hard_working"),initialize:function(e){return this.render(),this.getRanking(),this},render:function(){var e=this.getLocalRanking();this.$el.html(this.template(e))},getRanking:function(){var e=this;i.getRanking(function(t){e.afterSer(t)})},afterSer:function(e){e&&(n.setCacheItem(s.get("username")+"/rank",e),this.render(e))},getLocalRanking:function(){var e=n.getCacheItem(s.get("username")+"/rank");return e||(e={ranking:0,taskCount:0,completedCount:0,projectCount:0,dayCount:0}),e}})}),define("hbs!template/cut_avatar",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o="",l=i.helperMissing,c=this.escapeExpression;return o+='<div class="popup-header">\n    <a class="popup-close">&times;</a>\n    <h1 class="popup-title text-lrg text-primary">\n        ',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"upload_avatar",r):l.call(t,"I18n","upload_avatar",r)))+'\n    </h1>\n</div>\n<div class="popup-body">\n    <div class="image-view">\n        <img class="image-place" id="image-place">\n        <div class="on-image">\n            <div class="move-div">\n                <div class="change-size">\n                    <div class="change-size-view"></div>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>\n<div class="popup-footer">\n    <button class="btn btn-cancel no-cut-image">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"cancel",r):l.call(t,"I18n","cancel",r)))+'</button>\n    <button class="btn cut-image">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"save",r):l.call(t,"I18n","save",r)))+"</button>\n</div>\n"})}),define("view/modal/setting-tabs/personal/cut-avatar",["require","exports","module","utils/index","modules/popup/popup","hbs!template/cut_avatar"],function(e,t){var i=e("utils/index"),n=e("modules/popup/popup").View;t.View=Backbone.View.extend({template:e("hbs!template/cut_avatar"),id:"cut-avatar",className:"can-not-select",events:{"mousedown .move-div":"upDiv","mousemove .image-view":"moveDiv","mousedown .change-size":"upChangeSize","click .cut-image":"cutImage","click .no-cut-image":"closeView"},messages:function(){var e=this;$("html").on("mouseup.avatar",function(){e.downDiv()})},initialize:function(e){this.initDate(e),this.render(),this.messages(),this.initDomAttr()},initDomAttr:function(){this.$imagePlace=this.$el.find(".image-place"),this.moveDivView=this.$el.find(".move-div"),this.imageDivView=this.$el.find(".image-view")},initDate:function(e){_.extend(this,e)},render:function(){this.$el.html(this.template()),this.renderImage(),this.popupView=new n({view:this})},renderImage:function(){var e=this,t=new FileReader;t.readAsDataURL(this.file),t.onload=function(t){e.$imagePlace.attr("src",this.result)}},upChangeSize:function(e){e.stopPropagation(),this.isHold=!1,this.isChangeSize=!0},upDiv:function(e){1==e.which&&(this.isHold=!0,this.oldPosition={x:e.offsetX,y:e.offsetY})},downDiv:function(e){this.isHold=!1,this.isChangeSize=!1},moveDiv:function(e){var t=this.$("#image-place"),i=t.height(),n=t.width();if(this.isHold){var s=this.moveDivView.height(),a=this.moveDivView.width(),r=e.pageY-this.oldPosition.y-this.imageDivView.offset().top,o=e.pageX-this.oldPosition.x-this.imageDivView.offset().left;0>r&&(r=0),r+s>i-1&&(r=i-1-s),0>o&&(o=0),o+a>n-1&&(o=n-1-a),this.$el.find(".move-div").css({top:r+"px",left:o+"px"})}else if(this.isChangeSize){var l=this.getCursorRelative(e,t),c=this.moveDivView.position(),d=l.top-c.top,u=l.left-c.left,h=u>d?d:u;if(!this.checkSize(h))return;this.$el.find(".move-div").css({height:h+"px",width:h+"px"})}},getCursorRelative:function(e,t){var i=t.offset();return{top:e.clientY-i.top,left:e.clientX-i.left}},checkSize:function(e){return 100>e||e>300?!1:this.moveDivView.position().top+e>300||this.moveDivView.position().left+e>300?!1:!0},getPosition:function(){return[this.moveDivView.position().left,this.moveDivView.position().top,this.moveDivView.width(),this.moveDivView.height()]},cutImage:function(){var e=this.getPosition(),t=i.screenshotImage(document.getElementById("image-place"),e);this.action&&this.action(t),this.closeView()},closeView:function(){this.popupView.onRemove(),$("html").off("mouseup.avatar")}})}),define("hbs!template/settings_avatar",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){return'\n          <i class="pro-sml icon-s-pro-sml icon_home"> </i>\n        '}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var r,o,l,c="",d="function",u=this.escapeExpression,h=this,p=i.blockHelperMissing,m=i.helperMissing;return c+='<div class="avatar-panel">\n    <a class="avatar-img">\n        <img class="avatar lrg" src=',(r=i.avatarUrl)?r=r.call(t,{hash:{},data:s}):(r=t.avatarUrl,r=typeof r===d?r.apply(t):r),c+=u(r)+" />\n        ",l={hash:{},inverse:h.noop,fn:h.program(1,a,s),data:s},(r=i.ifpro)?r=r.call(t,l):(r=t.ifpro,r=typeof r===d?r.apply(t):r),i.ifpro||(r=p.call(t,r,l)),(r||0===r)&&(c+=r),c+='\n        <div class="edit-avatar">\n            ',l={hash:{},data:s},r=i.svgIcon,o=r?r.call(t,"icon-edit-avatar","i-med i-1-1",l):m.call(t,"svgIcon","icon-edit-avatar","i-med i-1-1",l),(o||0===o)&&(c+=o),c+='\n        </div>\n        <input type="file" name="file" class="avatar-file-input" accept="image/gif,image/png,image/jpeg,image/tiff,image/bmp,image/jpg">\n    </a>\n    <p class="nickname">',(o=i.nickname)?o=o.call(t,{hash:{},data:s}):(o=t.nickname,o=typeof o===d?o.apply(t):o),c+=u(o)+"</p>\n    <input type='text' class='input-tny edit-nickname' value=",(o=i.nickname)?o=o.call(t,{hash:{},data:s}):(o=t.nickname,o=typeof o===d?o.apply(t):o),c+=u(o)+">\n</div>\n\n"})}),define("view/modal/setting-tabs/personal/avatar",["require","exports","module","configs/settings","service/userProfile","utils/server","configs/keycode","view/modal/setting-tabs/personal/cut-avatar","hbs!template/settings_avatar"],function(e,t){var i=e("configs/settings"),n=e("service/userProfile"),s=e("utils/server"),a=e("configs/keycode"),r=e("view/modal/setting-tabs/personal/cut-avatar").View;t.View=Backbone.View.extend({tagName:"div",className:"settings-avatar",template:e("hbs!template/settings_avatar"),events:{"click .nickname":"editName","blur .edit-nickname":"afterInput","keyup .edit-nickname":"onKeyup","change .avatar-file-input":"changeAvatar"},messages:function(){this.listenTo(n,"change:picture",this.updateAvatar)},initialize:function(e){return this.render(),this.initDomAttr(),this.messages(),this.$editNickname.hide(),this},initDomAttr:function(){this.$editNickname=this.$el.find(".edit-nickname"),this.$nickname=this.$el.find(".nickname"),this.$avatarFileInput=this.$el.find(".avatar-file-input"),this.$avatarImage=this.$el.find(".avatar-img img")},afterInput:function(){this.saveNewNickname(),this.toggleEditNicknameView()},onKeyup:function(e){e.keyCode===a.enter&&this.$editNickname.blur()},saveNewNickname:function(){var e=this.$editNickname.val();this.checkNickname(e)&&(s.updateUsername(JSON.stringify({name:e}),function(){n.set("name",e)}),this.$nickname.text(e))},checkNickname:function(e){return e&&e!=n.get("name")?!0:!1},render:function(){var e={nickname:n.get("name"),avatarUrl:n.get("picture"),loadingImg:i.cdn+"/static/img/refresh-blue.gif"};this.$el.html(this.template(e))},toggleEditNicknameView:function(){this.$editNickname.fadeToggle(150),this.$editNickname.css("display","block")},editName:function(){this.toggleEditNicknameView(),this.$editNickname.focus()},changeAvatar:function(e){var t=e.target.files,i=t[0];new r({file:i,action:_.bind(this.uploadAvatar,this)}),this.$(".avatar-file-input").val("")},uploadAvatar:function(e){var t=this.base64toFile(e),i=new FormData;i.append("file",t,"filename.png");var n=this;s.postUserAvatar(i,function(){n.afterUploadAvatar(e)})},afterUploadAvatar:function(e){n.set("picture",e)},base64toFile:function(e){for(var t=e.split(",")[1],i=atob(t),n=i.length,s=new ArrayBuffer(n),a=new Uint8Array(s),r=0;n>r;r++)a[r]=i.charCodeAt(r);var o=new Blob([s],{type:"image/png"});return o},updateAvatar:function(){this.$avatarImage.attr("src",n.get("picture"))}})}),define("hbs!template/settings_personal_row",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){var n,s="";return s+='<input type="',(n=i.type2)?n=n.call(e,{hash:{},data:t}):(n=e.type2,n=typeof n===d?n.apply(e):n),s+=u(n)+'" data="type2" placeholder="',(n=i.ph2)?n=n.call(e,{hash:{},data:t}):(n=e.ph2,n=typeof n===d?n.apply(e):n),s+=u(n)+'">'}function r(e,t){var n,s="";return s+='<input type="',(n=i.type3)?n=n.call(e,{hash:{},data:t}):(n=e.type3,n=typeof n===d?n.apply(e):n),s+=u(n)+'" data="type3" placeholder="',(n=i.ph3)?n=n.call(e,{hash:{},data:t}):(n=e.ph3,n=typeof n===d?n.apply(e):n),s+=u(n)+'">'}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var o,l,c="",d="function",u=this.escapeExpression,h=this,p=i.helperMissing;return c+='<label class="control-label text-secondary row-left">',(o=i.label)?o=o.call(t,{hash:{},data:s}):(o=t.label,o=typeof o===d?o.apply(t):o),c+=u(o)+'</label>\n<div class="controls"> \n    <div class="control-action">\n        <span class="control-name">',(o=i.name)?o=o.call(t,{hash:{},data:s}):(o=t.name,o=typeof o===d?o.apply(t):o),c+=u(o)+'</span> \n        <a class="control-edit">',(o=i.editName)?o=o.call(t,{hash:{},data:s}):(o=t.editName,o=typeof o===d?o.apply(t):o),c+=u(o)+'</a>\n    </div>\n\n    <div class="control-form">\n        <input type="',(o=i.type1)?o=o.call(t,{hash:{},data:s}):(o=t.type1,o=typeof o===d?o.apply(t):o),c+=u(o)+'" data="type1" placeholder="',(o=i.ph1)?o=o.call(t,{hash:{},data:s}):(o=t.ph1,o=typeof o===d?o.apply(t):o),c+=u(o)+'" value="',(o=i.value1)?o=o.call(t,{hash:{},data:s}):(o=t.value1,o=typeof o===d?o.apply(t):o),c+=u(o)+'">\n        ',o=i["if"].call(t,t.type2,{hash:{},inverse:h.noop,fn:h.program(1,a,s),data:s}),(o||0===o)&&(c+=o),c+="\n        ",o=i["if"].call(t,t.type3,{hash:{},inverse:h.noop,fn:h.program(3,r,s),data:s}),(o||0===o)&&(c+=o),c+='\n        <p class="error-msg text-alert text-sml"></p>\n        <div class="btns">\n            <button class="cancel btn-cancel btn-med">',l={hash:{},data:s},c+=u((o=i.I18n,o?o.call(t,"cancel",l):p.call(t,"I18n","cancel",l)))+'</button>\n            <button class="confirm btn-primary btn-med btn-initial">',l={hash:{},data:s},c+=u((o=i.I18n,o?o.call(t,"save",l):p.call(t,"I18n","save",l)))+'</button>\n            <button class="btn-primary btn-med disabled btn-loading">',l={hash:{},data:s},c+=u((o=i.I18n,o?o.call(t,"save",l):p.call(t,"I18n","save",l)))+"...</button>\n        </div>\n    </div>\n</div>\n"})}),define("view/modal/setting-tabs/personal/formBase",["require","exports","module","lang/index","utils/btns","hbs!template/settings_personal_row"],function(e,t){var i=e("lang/index"),n=e("utils/btns");t.View=Backbone.View.extend({tagName:"div",template:e("hbs!template/settings_personal_row"),events:{"click .control-edit":"editAction","click .cancel":"cancel","click .confirm":"confirm","input input":"hideErrorMsg"},initialize:function(e){return this.render(),this.initDomAttr(),this},render:function(){var e=this.getRenderData();this.$el.html(this.template(e))},initDomAttr:function(){this.$controlForm=this.$el.find(".control-form"),this.$controlAction=this.$el.find(".control-action"),this.$controlName=this.$controlAction.find(".control-name"),this.$controlEdit=this.$controlAction.find(".control-edit"),this.$errorMsg=this.$el.find(".error-msg"),this.$controlForm.hide()},toggleEditView:function(){var e=this.$controlAction.hasClass("hide"),t=this;e?this.$controlForm.slideToggle(function(){t.$controlAction.fadeToggle(),t.$controlAction.toggleClass("hide")}):(this.$controlAction.toggleClass("hide"),this.$controlForm.slideToggle())},showErrorMsg:function(e){this.$errorMsg.text(e)},hideErrorMsg:function(){this.$errorMsg.text("")},editAction:function(){this.toggleEditView()},cancel:function(){this.toggleEditView(),this.hideErrorMsg(),this.resetInputValue()},resetInputValue:function(){this.$("input").not('[type="email"]').val("")},confirm:function(){this.checkAll()&&(n.doing(this.$(".btns")),this.saveValue(this.values))},afterSaveSuccess:function(e){n.done(this.$(".btns")),this.hideErrorMsg(),this.toggleEditView(),this.$controlName.text(e),this.$controlEdit.text(i.get("edit"))},afterSaveFail:function(e){n.done(this.$(".btns")),this.showErrorMsg(e)},checkAll:function(){var e="checkValue";this.values={};for(var t=1;4>t;t++){var i=this.$el.find("[data=type"+t+"]").val();if(null!=this[e+t]&&!this[e+t](i))return this.values={},!1;this.values[t]=i}return!0}})}),define("view/modal/setting-tabs/personal/mail",["require","exports","module","view/modal/setting-tabs/personal/formBase","lang/index","service/userProfile","configs/regexp","utils/server"],function(e,t){var i=e("view/modal/setting-tabs/personal/formBase").View,n=e("lang/index"),s=e("service/userProfile"),a=e("configs/regexp"),r=e("utils/server");t.View=i.extend({className:"row settings-mail",initialize:function(e){return this.constructor.__super__.initialize.apply(this,[e]),this},getRenderData:function(){var e={label:n.get("email"),type1:"email",type2:"password"};return s.get("fakedEmail")?_.extend(e,{editName:n.get("third_account_sign_up"),ph1:n.get("third_account_sign_up"),ph2:n.get("set_password")}):_.extend(e,{name:s.get("username"),editName:n.get("change_email"),ph1:n.get("email_address"),value1:s.get("username"),ph2:n.get("current_password")}),e},checkValue1:function(e){if(!e)return this.showErrorMsg(n.get("nothing_error_me")),!1;var t=e.match(a.emailRegexp);return t?!0:(this.showErrorMsg(n.get("sign_invalid_email")),!1)},checkValue2:function(e){return e?e&&e.length>=6&&e.length<=20?!0:(this.showErrorMsg(n.get("password_length_error_info")),!1):(this.showErrorMsg(n.get("password_empty")),!1)},saveValue:function(e){var t,i=JSON.stringify({username:e[1],password:e[2]});t=s.get("fakedEmail")?r.saveEmail:r.changeEmail;var a=this;t(i,function(){a.afterSaveSuccess(e[1]),s.get("fakedEmail")&&(s.set("fakedEmail",!1),s.set("filledPassword",!0)),s.set("username",e[1])},function(e){a.afterSaveFail("username_password_not_match"==JSON.parse(e.responseText).errorCode?n.get("password_incorrect"):n.get("sign_email_taken"))})}})}),define("view/modal/setting-tabs/personal/password",["require","exports","module","view/modal/setting-tabs/personal/formBase","lang/index","service/userProfile","utils/server"],function(e,t){var i=e("view/modal/setting-tabs/personal/formBase").View,n=e("lang/index"),s=e("service/userProfile"),a=e("utils/server");t.View=i.extend({className:"row settings-password",messages:function(){this.listenTo(s,"change:filledPassword",this.changeFilledPassword)},initialize:function(e){return this.constructor.__super__.initialize.apply(this,[e]),this.messages(),this},changeFilledPassword:function(){this.$el.show(),this.$controlName.text("●●●●●●"),this.$controlEdit.text(n.get("change"))},getRenderData:function(){var e={label:n.get("password"),type1:"password"};return _.extend(e,{name:"●●●●●●",editName:n.get("change_password"),ph1:n.get("current_password"),type2:"password",ph2:n.get("new_password")}),s.get("fakedEmail")&&this.$el.hide(),e},checkValue1:function(e){return e?e&&e.length>=6&&e.length<=20?!0:(this.showErrorMsg(n.get("password_length_error_info")),!1):(this.showErrorMsg(n.get("password_empty")),!1)},checkValue2:function(e){return s.get("filledPassword")?this.checkValue1(e):!0},saveValue:function(e){var t=a.changePassword,i=this;if(s.get("filledPassword"))var r=JSON.stringify({password:e[1],newPassword1:e[2],newPassword2:e[2]});else var r=JSON.stringify({newPassword1:e[1],newPassword2:e[1]});t(r,function(e){e&&e.error?"password_incorrect"==e.error.code&&i.afterSaveFail(n.get("password_incorrect")):(s.get("filledPassword")||s.set("filledPassword",!0),i.afterSaveSuccess("●●●●●●"))})}})}),define("hbs!template/preferences_account_binding_delete",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o,l="",c=i.helperMissing,d=this.escapeExpression;return l+='<div class="popup-header">\n    <a class="popup-close">&times;</a>\n    <h1 class="popup-title text-lrg text-primary">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"are_you_sure_unbind_it",o):c.call(t,"I18n","are_you_sure_unbind_it",o)))+'</h1>\n</div>\n\n<div class="popup-body">\n  <p class="description">\n    ',o={hash:{},data:s},a=i.I18n_Plus,r=a?a.call(t,"are_you_sure_unbind_it_description",t.reminderAccountName,t.deleteAccountName,o):c.call(t,"I18n_Plus","are_you_sure_unbind_it_description",t.reminderAccountName,t.deleteAccountName,o),(r||0===r)&&(l+=r),l+='\n  </p>\n  <div id="error-delete-binding" class="text-alert alert hide">\n    ',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"binding_delete_error",o):c.call(t,"I18n","binding_delete_error",o)))+'\n  </div>\n</div>\n\n<div class="popup-footer">\n  <button id="btn-cancel" class="btn-med btn close-modal">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"cancel",o):c.call(t,"I18n","cancel",o)))+'</button>\n  <button id="btn-confirm" class="btn-med btn btn-primary">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"unbind",o):c.call(t,"I18n","unbind",o)))+"</button>\n</div>\n"})}),define("view/modal/setting-tabs/personal/unbinding",["require","exports","module","lang/index","utils/server","utils/analytics","modules/popup/popup","service/userProfile","hbs!template/preferences_account_binding_delete"],function(e,t){var i=e("lang/index"),n=e("utils/server"),s=e("utils/analytics"),a=e("modules/popup/popup").View,r=e("service/userProfile");t.View=Backbone.View.extend({id:"binding-delete",template:e("hbs!template/preferences_account_binding_delete"),events:{"click #btn-confirm":"unbind","click #btn-cancel":"close",hide:"remove"},initialize:function(e){this.initData(e),this.render()},initData:function(e){_.extend(this,e.data),this.action=e.action||function(){}},render:function(){var e={reminderAccountName:r.get("fakedEmail")?this.reminderNickName?i.get(this.reminderSiteName)+"："+this.reminderNickName:i.get(this.reminderSiteName):r.get("username"),deleteAccountName:this.deleteNickName?i.get(this.deleteSiteName)+"："+this.deleteNickName:i.get(this.deleteSiteName)};this.$el.html(this.template(e)),this.popupView=new a({view:this})},close:function(){this.popupView.onRemove()},unbind:function(){var e=this;n.deleteBindings(e.deleteSiteId,function(){$("#error-delete-binding").hide(),e.action.apply(),e.close(),s.set_account("unbind")},function(){$("#error-delete-binding").show()})}})}),define("hbs!template/settings_third_account_row",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r="",o="function",l=this.escapeExpression;return r+='<label class="control-label text-secondary row-left">',(a=i.label)?a=a.call(t,{hash:{},data:s}):(a=t.label,a=typeof a===o?a.apply(t):a),r+=l(a)+'</label>\n<div class="controls text-secondary"> \n    <div class="control-action">\n        <span class="control-name">',(a=i.name)?a=a.call(t,{hash:{},data:s}):(a=t.name,a=typeof a===o?a.apply(t):a),r+=l(a)+'</span>\n        <a class="control-edit">',(a=i.editName)?a=a.call(t,{hash:{},data:s}):(a=t.editName,a=typeof a===o?a.apply(t):a),r+=l(a)+"</a>\n    </div>\n</div>\n"})}),define("view/modal/setting-tabs/personal/thirdAccountBase",["require","exports","module","view/modal/setting-tabs/personal/unbinding","service/userProfile","lang/index","hbs!template/settings_third_account_row"],function(e,t){var i=e("view/modal/setting-tabs/personal/unbinding").View,n=e("service/userProfile"),s=e("lang/index");t.View=Backbone.View.extend({tagName:"div",template:e("hbs!template/settings_third_account_row"),events:{"click .control-edit":"unBinding"},messages:function(){this.listenTo(n,"change:fakedEmail",this.changeFakedEmail),this.listenTo(n,"changeBinds",this.changeBinds)},initialize:function(e){return this.render(),this.initDomAttr(),this.messages(),this},render:function(){var e=this.getRenderData();this.$el.html(this.template(e))},changeFakedEmail:function(){this.refreshRenderUnbindBtn()},changeBinds:function(e){this.binds=this.binds||[],this.binds.length="add"===e?2:0,this.refreshRenderUnbindBtn()},initDomAttr:function(){this.$controlEdit=this.$el.find(".control-edit"),this.$controlName=this.$el.find(".control-name")},unBinding:function(){if(this.canUnbinding()){var e={3:"weibo",4:"qq",5:"wechat"},t={deleteSiteId:this.siteId,deleteSiteName:e[this.siteId],deleteNickName:this.nickName};if(n.get("fakedEmail"))for(var s,a=0;s=this.binds[a++];)if(s.siteId!=this.siteId){_.extend(t,{reminderNickName:s.nickName,reminderSiteName:e[s.siteId]});break}new i({data:t,action:_.bind(this.unBindingAction,this)})}},unBindingAction:function(){n.trigger("changeBinds","reduce"),this.remove()},initData:function(e){_.extend(this,e)},canUnbinding:function(){return n.get("fakedEmail")&&this.binds&&this.binds.length<=1?!1:!0},refreshRenderUnbindBtn:function(){this.$controlEdit.text(this.canUnbinding()?s.get("unbind"):"")}})}),define("hbs!template/wechat-qrcode",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o="",l=i.helperMissing,c=this.escapeExpression;return o+='<div class="popup-header">\n  <a class="popup-close close">&times;</a>\n</div>\n\n<div class="popup-body">\n  <section class="text-center transition">\n    <p id="qrcode">\n      <img alt="',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"title",r):l.call(t,"I18n","title",r)))+'">\n    </p>\n\n    <div class="wechat-qrcode-loading" id="wechat-qrcode-loading">\n      <div class="pinwheel loading-circle"></div>\n      <p class="text-secondary">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"wechat_qrcode_loading",r):l.call(t,"I18n","wechat_qrcode_loading",r)))+'</p>\n    </div>\n\n    <div id="title">\n      <h1 class="popup-title text-lrg text-primary">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"wechat_qrcode_header",r):l.call(t,"I18n","wechat_qrcode_header",r)))+'</h1>\n      <p class="text-secondary">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"wechat_qrcode_desc",r):l.call(t,"I18n","wechat_qrcode_desc",r)))+'</p>\n    </div>\n\n    <div class="verified" id="verified">\n      <div class="checkmark"></div>\n      <h4 class="verified-title text-secondary">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"wechat_qrcode_follow_success",r):l.call(t,"I18n","wechat_qrcode_follow_success",r)))+'</h4>\n    </div>\n\n    <div id="error-fail-to-bind-empty" class="error-message">\n      <p class="title text-alert text-med">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"bind_fail",r):l.call(t,"I18n","bind_fail",r)))+'</p>\n      <p class="description text-secondary">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"wechat_qrcode_error_fail_bind_binded",r):l.call(t,"I18n","wechat_qrcode_error_fail_bind_binded",r)))+'</p>\n      <a class="control help" href="/public/wechat/help.html">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"help",r):l.call(t,"I18n","help",r)))+'</a>\n      <a class="control retry">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"retry",r):l.call(t,"I18n","retry",r)))+'</a>\n    </div>\n\n    <div id="error-fail-to-bind" class="error-message">\n      <p class="title text-alert text-med">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"bind_fail",r):l.call(t,"I18n","bind_fail",r)))+'</p>\n      <p class="description text-secondary">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"wechat_qrcode_error_fail_bind_user",r):l.call(t,"I18n","wechat_qrcode_error_fail_bind_user",r)))+'</p>\n      <a class="control retry">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"retry",r):l.call(t,"I18n","retry",r)))+'</a>\n    </div>\n\n    <div id="error-fail" class="error-message">\n      <p class="title text-alert text-med">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"network_error",r):l.call(t,"I18n","network_error",r)))+'</p>\n      <a class="control retry">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"retry",r):l.call(t,"I18n","retry",r)))+'</a>\n    </div>\n\n  </section>\n</div>\n<div class="popup-footer"></div>';

})}),define("modules/wechat/qrcode",["require","exports","module","utils/server","utils/log","configs/settings","modules/popup/popup","hbs!template/wechat-qrcode"],function(e,t){var i=e("utils/server"),n=e("utils/log"),s=e("configs/settings"),a=e("modules/popup/popup").View;t.View=Backbone.View.extend({tagName:"div",className:"wechat-qrcode-container",template:e("hbs!template/wechat-qrcode"),canStopConnect:!1,scanConnecting:!1,url:"",expireSeconds:1800,events:{click:"remover","click .close":"remover","click .retry":"retry","click .help":"gotoHelpView"},messages:function(){var e=this;$("body").on("keydown",function(t){return 27===t.keyCode?(e.removeQRCode(t),!1):void 0})},initialize:function(e){this.initData(e),this.getQRCode=_.debounce(this.__getQRCode,10*s.responsiveTime),this.messages(),this.getQRCode(),this.render(),this.scanPolling()},initData:function(e){_.extend(this,e),this.action=e.action},showVerified:function(){this.$el.find("#title").hide(),this.$el.find("img").hide(),this.$el.find("#verified").show()},loadingStart:function(){this.$el.find("img").hide(),this.$el.find("#wechat-qrcode-loading").show()},loadingEnd:function(){this.$el.find("#wechat-qrcode-loading").hide(),this.$el.find("img").show()},refreshQRCode:function(){var e=this,t=new Image;t.src=e.url,t.onload=function(){e.$el.find("img").attr("src",e.url),e.loadingEnd(),e.$el.find("img").show()}},__getQRCode:function(){var e=this;i.getWechatQrcode(function(t){e.url=t.url,e.expireSeconds=t.expireSeconds,e.refreshQRCode(),e.getQRCodeRealtime()},function(t){e.getQRCode(),n.log("加载微信二维码失败,重新获取")})},getQRCodeRealtime:function(){var e=this;e.$el.everyTime(1e3*e.expireSeconds,"getQRCodeRealtime",function(){i.getWechatQrcode(function(t){e.url=t.url,e.expireSeconds=t.expireSeconds,e.refreshQRCode(),e.$el.stopTime("getQRCodeRealtime"),e.getQRCodeRealtime()},function(t){n.log("加载微信二维码失败,重新获取"),e.getQRCode()})})},render:function(){this.$el.append(this.template()),this.loadingStart(),this.$el.focus(),this.popupView=new a({view:this})},retry:function(){this.loadingStart(),this.$el.focus(),this.getQRCode(),this.$el.find("#title").show(),this.$(".error-message").hide(),this.scanPolling()},gotoHelpView:function(){window.location.href="/public/wechat/help.html"},showError:function(){var e=arguments[0];if(this.$el.find("#title").hide(),this.$el.find("img").hide(),e){if("fail_to_bind"==e.code)this.$el.find("#error-fail-to-bind-empty").show();else if("success_to_bind"==e.code){var t=this.$el.find("#error-fail-to-bind"),i=t.find(".description"),n=i.text();n=n.replace("%s1",e.userProfile.nickname),i.text(n),t.show()}}else this.$el.find("#error-fail").show()},remover:function(e){var t=$(e.target);return(t.is("."+this.className)||t.is(".close"))&&this.removeQRCode(e),!1},removeQRCode:function(){this.canStopConnect=!0,this.$el.stopTime("getQRCodeRealtime"),this.popupView.onRemove()},scanPolling:function(){this.scanConnecting=!1,this.canStopConnect=!1,this.polling()},polling:function(){if(!this.scanConnecting&&!this.canStopConnect){this.scanConnecting=!0;var e=this;i.getWechatStatus(function(t){e.scanConnecting=!1,e.successPolling(t)},function(t){e.scanConnecting=!1,e.failPolling()})}},successPolling:function(e){_.isEmpty(e)?this.polling():("success_to_bind"==e.code&&e.userProfile.subscribe?(this.action(e.userProfile),this.showVerified()):this.showError(e),this.canStopConnect=!0)},failPolling:function(){this.showError(),this.canStopConnect=!0}})}),define("view/modal/setting-tabs/personal/wechat",["require","exports","module","view/modal/setting-tabs/personal/thirdAccountBase","lang/index","utils/server","service/userProfile","modules/wechat/qrcode"],function(e,t){var i=e("view/modal/setting-tabs/personal/thirdAccountBase").View,n=e("lang/index"),s=(e("utils/server"),e("service/userProfile"),e("modules/wechat/qrcode").View);t.View=i.extend({className:"row settings-wechat",events:{"click .control-edit":"showWechatBindMsg"},initialize:function(e){return this.initData(e),this.constructor.__super__.initialize.apply(this,[e]),this},getRenderData:function(){var e={label:n.get("wechat"),name:this.nickName,editName:this.openId?this.canUnbinding()?n.get("unbind"):"":n.get("wechat_form_link")};return e},showWechatBindMsg:function(){this.openId?this.unBinding():new s({action:_.bind(this.bindAction,this)})},bindAction:function(){Backbone.trigger("refreshThirdAccount")},refreshRenderUnbindBtn:function(){this.openId&&this.$controlEdit.text(this.canUnbinding()?n.get("unbind"):"")},unBindingAction:function(){Backbone.trigger("refreshThirdAccount")}})}),define("view/modal/setting-tabs/personal/weibo",["require","exports","module","view/modal/setting-tabs/personal/thirdAccountBase","lang/index"],function(e,t){var i=e("view/modal/setting-tabs/personal/thirdAccountBase").View,n=e("lang/index");t.View=i.extend({className:"row settings-weibo",initialize:function(e){return this.initData(e),this.constructor.__super__.initialize.apply(this,[e]),this},getRenderData:function(){var e={label:n.get("weibo"),name:this.nickName,editName:this.canUnbinding()?n.get("unbind"):""};return e}})}),define("view/modal/setting-tabs/personal/qq",["require","exports","module","view/modal/setting-tabs/personal/thirdAccountBase","lang/index"],function(e,t){var i=e("view/modal/setting-tabs/personal/thirdAccountBase").View,n=e("lang/index");t.View=i.extend({className:"row settings-qq",initialize:function(e){return this.initData(e),this.constructor.__super__.initialize.apply(this,[e]),this},getRenderData:function(){var e={label:n.get("qq"),name:this.nickName,editName:this.canUnbinding()?n.get("unbind"):""};return e}})}),define("hbs!template/delete_account_pop",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){var n,s,a="";return a+='\n\n        <div class="controls has-password">\n          \n          <input class="psw" id="password-input" type="password" name="password" placeholder="',s={hash:{},data:t},a+=h((n=i.I18n,n?n.call(e,"settings_confirm_current_password",s):u.call(e,"I18n","settings_confirm_current_password",s)))+'"/>\n          <p class="text-alert text-sml warn format-warn hide">',s={hash:{},data:t},a+=h((n=i.I18n,n?n.call(e,"password_min_length_error",s):u.call(e,"I18n","password_min_length_error",s)))+'</p>\n          <p class="text-alert text-sml warn match-warn hide">',s={hash:{},data:t},a+=h((n=i.I18n,n?n.call(e,"password_incorrect",s):u.call(e,"I18n","password_incorrect",s)))+"</p>\n        </div>\n\n      "}function r(e,t){var n,s,a="";return a+='\n\n        <div class="controls">\n          <p class="control-label">\n            <span>',s={hash:{},data:t},a+=h((n=i.I18n,n?n.call(e,"please_input",s):u.call(e,"I18n","please_input",s)))+"</span>\n            <strong>",s={hash:{},data:t},a+=h((n=i.I18n,n?n.call(e,"im_sure_to_delete_account",s):u.call(e,"I18n","im_sure_to_delete_account",s)))+'</strong>\n          </p>\n          <input class="psw" id="nopassword" type="text" name="sure-delete" placeholder="',s={hash:{},data:t},a+=h((n=i.I18n,n?n.call(e,"im_sure_to_delete_account",s):u.call(e,"I18n","im_sure_to_delete_account",s)))+'"/>\n          <p id="error-invalid-input" class="text-alert text-sml warn hide">',s={hash:{},data:t},a+=h((n=i.I18n,n?n.call(e,"invalid_input",s):u.call(e,"I18n","invalid_input",s)))+"</p>\n        </div>\n\n      "}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var o,l,c,d="",u=i.helperMissing,h=this.escapeExpression,p=this;return d+='<div class="popup-header">\n    <a class="popup-close">&times;</a>\n    <h1 class="popup-title text-lrg text-primary">',c={hash:{},data:s},d+=h((o=i.I18n,o?o.call(t,"delete_account",c):u.call(t,"I18n","delete_account",c)))+'</h1>\n</div>\n\n<div class="popup-body">\n  \n  <div class="delete-wrap">\n    <div class="alert text-alert text-sml">',c={hash:{},data:s},o=i.I18n,l=o?o.call(t,"delete_will_do",c):u.call(t,"I18n","delete_will_do",c),(l||0===l)&&(d+=l),d+='</div>\n    <div class="control-group">\n\n      ',l=i["if"].call(t,t.filledPassword,{hash:{},inverse:p.program(3,r,s),fn:p.program(1,a,s),data:s}),(l||0===l)&&(d+=l),d+='\n\n    </div>\n\n    <div class="control-group">\n      <div class="controls">\n\n        <p class="box">\n          <input id="check-data" type="checkbox" class="confirm-1">\n          <label class="checkbox" for="check-data">',c={hash:{},data:s},d+=h((o=i.I18n,o?o.call(t,"delete_account_confirm_1",c):u.call(t,"I18n","delete_account_confirm_1",c)))+'</label>\n        </p>\n\n        <p class="box">\n          <input id="check-account" type="checkbox" class="confirm-2">\n          <label class="checkbox" for="check-account">',c={hash:{},data:s},d+=h((o=i.I18n,o?o.call(t,"delete_account_confirm_2",c):u.call(t,"I18n","delete_account_confirm_2",c)))+'</label>\n        </p>\n\n      </div>\n    </div>\n\n  </div>\n\n</div>\n\n<div class="popup-footer project-edit-footer">\n    <button type="button" class="cancel btn-med btn-cancel">',c={hash:{},data:s},d+=h((o=i.I18n,o?o.call(t,"cancel",c):u.call(t,"I18n","cancel",c)))+'</button>\n    <button type="button" class="confirm btn-med btn-primary" disabled=\'true\'>',c={hash:{},data:s},d+=h((o=i.I18n,o?o.call(t,"confirm",c):u.call(t,"I18n","confirm",c)))+"</button>\n</div>"})}),define("view/modal/setting-tabs/personal/delete-account-pop",["require","exports","module","utils/hash","utils/server","lang/index","utils/analytics","modules/popup/popup","service/userProfile","hbs!template/delete_account_pop"],function(e,t){var i=e("utils/hash"),n=e("utils/server"),s=e("lang/index"),a=e("utils/analytics"),r=e("modules/popup/popup").View,o=e("service/userProfile");t.View=Backbone.View.extend({template:e("hbs!template/delete_account_pop"),events:{"click .confirm":"deleteAccount","click .cancel":"closeModal","blur #password-input":"checkPassword","input #password-input":"hideErrorPassword","blur #nopassword":"checkSureDelete","input #nopassword":"hideErrorSure","change .confirm-1, .confirm-2":"check"},initialize:function(){this.render(),this.initDom()},initDom:function(){this.$password=this.$("#password-input"),this.$nopassword=this.$("#nopassword"),this.$check1=this.$(".confirm-1"),this.$check2=this.$(".confirm-2"),this.$invalid=this.$("#error-invalid-input"),this.$format=this.$(".format-warn"),this.$match=this.$(".match-warn"),this.$confirm=this.$(".confirm")},check:function(){o.get("filledPassword")?this.checkPassword():this.checkSureDelete()},render:function(){this.$el.html(this.template({filledPassword:o.get("filledPassword")})),this.popupView=new r({view:this})},closeModal:function(){this.popupView.onRemove()},deleteAccount:function(){if(!this.$confirm.is(":disabled")){var e=this;if(o.get("filledPassword")){var t=this.$password.val();n.deleteAccount({password:t},function(){i.redirectToSignout()},function(){e.$match.removeClass("hide")})}else n.deleteThirdSiteAccount(function(){i.redirectToSignout()},function(){e.$invalid.removeClass("hide")});a.set_account("real_delete")}},checkSureDelete:function(){var e=this.$nopassword.val();e=e.trim(),e=e.toUpperCase();var t=e===s.get("im_sure_to_delete_account");t?this.$invalid.addClass("hide"):this.$invalid.removeClass("hide");var i=this.$check1.is(":checked"),n=this.$check2.is(":checked");t&&i&&n?this.$confirm.prop("disabled",!1):this.$confirm.prop("disabled",!0)},checkPassword:function(){var e=this.$password.val(),t=e.length>=6;t?this.$format.addClass("hide"):this.$format.removeClass("hide"),this.$match.addClass("hide");var i=this.$check1.is(":checked"),n=this.$check2.is(":checked");t&&i&&n?this.$confirm.prop("disabled",!1):this.$confirm.prop("disabled",!0)},hideErrorPassword:function(){this.$format.addClass("hide"),this.$match.addClass("hide");var e=this.$password.val(),t=e.length>=6,i=this.$check1.is(":checked"),n=this.$check2.is(":checked");t&&i&&n?this.$confirm.prop("disabled",!1):this.$confirm.prop("disabled",!0)},hideErrorSure:function(){this.$invalid.addClass("hide");var e=this.$nopassword.val();e=e.trim(),e=e.toUpperCase();var t=e===s.get("im_sure_to_delete_account"),i=this.$check1.is(":checked"),n=this.$check2.is(":checked");t&&i&&n?this.$confirm.prop("disabled",!1):this.$confirm.prop("disabled",!0)}})}),define("hbs!template/delete_account_btn",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o="",l=i.helperMissing,c=this.escapeExpression;return o+='<button class="delete btn-secondary btn-sml">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"delete_account",r):l.call(t,"I18n","delete_account",r)))+"</button>"})}),define("view/modal/setting-tabs/personal/delete-account",["require","exports","module","utils/analytics","view/modal/setting-tabs/personal/delete-account-pop","hbs!template/delete_account_btn"],function(e,t){var i=e("utils/analytics"),n=e("view/modal/setting-tabs/personal/delete-account-pop").View;t.View=Backbone.View.extend({template:e("hbs!template/delete_account_btn"),className:"delete-account-btn",events:{"click .delete":"delete"},initialize:function(){this.render()},render:function(){this.$el.html(this.template())},"delete":function(){this.deleteView&&this.deleteView.closeModal(),this.deleteView=new n,i.set_account("delete")},onClose:function(){this.deleteView&&this.deleteView.closeModal(),this.remove()}})}),define("view/modal/setting-tabs/personal/main",["require","exports","module","view/modal/setting-tabs/personal/hardworking","view/modal/setting-tabs/personal/avatar","view/modal/setting-tabs/personal/mail","view/modal/setting-tabs/personal/password","view/modal/setting-tabs/personal/wechat","view/modal/setting-tabs/personal/weibo","view/modal/setting-tabs/personal/qq","view/modal/setting-tabs/personal/delete-account","configs/settings","utils/server"],function(e,t){var i=e("view/modal/setting-tabs/personal/hardworking").View,n=e("view/modal/setting-tabs/personal/avatar").View,s=e("view/modal/setting-tabs/personal/mail").View,a=e("view/modal/setting-tabs/personal/password").View,r=e("view/modal/setting-tabs/personal/wechat").View,o=e("view/modal/setting-tabs/personal/weibo").View,l=e("view/modal/setting-tabs/personal/qq").View,c=e("view/modal/setting-tabs/personal/delete-account").View,d=e("configs/settings"),u=e("utils/server");t.View=Backbone.View.extend({tagName:"div",className:"personal-panel",messages:function(){this.listenTo(Backbone,"refreshThirdAccount",this.refreshThirdAccount)},thirdAccountCode:{google:1,facebook:2,weibo:3,qq:4,wechat:5,lewa:6,twitter:7},initialize:function(e){this.thirdViews=[],this.subViews=[],this.render(),this.renderComponent(),this.messages()},render:function(){this.$el.html()},renderComponent:function(){this.renderComponentUtil(new i),this.renderComponentUtil(new n),this.renderComponentUtil(new s),this.renderComponentUtil(new a),this.renderComponentUtil(new c),this.renderThirdAccount()},renderThirdAccount:function(){if(d.isCnSites){var e=this;this.fetchAndHandleUserBanging(function(t){var i=t[e.thirdAccountCode.wechat];e.renderThirdAccountComponent(r,i||{}),i=t[e.thirdAccountCode.weibo],e.renderThirdAccountComponent(o,i),i=t[e.thirdAccountCode.qq],e.renderThirdAccountComponent(l,i)})}},renderThirdAccountComponent:function(e,t){if(t){var i=new e(t);this.thirdViews.push(i),this.renderComponentUtil(i)}},refreshThirdAccount:function(){for(;this.thirdViews.length>0;){var e=this.thirdViews.pop();e.remove()}this.renderThirdAccount()},fetchAndHandleUserBanging:function(e){u.getBindings(function(t){var i={};if(t&&t.thirdSiteBinds){for(var n,s=t.thirdSiteBinds,a=0;n=s[a++];)i[n.siteId]=n,n.binds=s;e&&e(i)}})},renderComponentUtil:function(e){this.$el.append(e.$el),this.subViews.push(e)},onClose:function(){var e=this.subViews.concat(this.thirdViews);_.each(e,function(e){e.onClose?e.onClose():e.remove()}),this.$el.remove()}})}),define("hbs!template/settings",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){var n,s="";return s+='\n          <li class="tab ',(n=i.active)?n=n.call(e,{hash:{},data:t}):(n=e.active,n=typeof n===d?n.apply(e):n),s+=u(n)+'" data-tab="',(n=i.key)?n=n.call(e,{hash:{},data:t}):(n=e.key,n=typeof n===d?n.apply(e):n),s+=u(n)+'">\n              <a class="text-secondary avoid-event">\n                  ',(n=i.sicon)?n=n.call(e,{hash:{},data:t}):(n=e.sicon,n=typeof n===d?n.apply(e):n),(n||0===n)&&(s+=n),s+="\n                  <span>",(n=i.text)?n=n.call(e,{hash:{},data:t}):(n=e.text,n=typeof n===d?n.apply(e):n),s+=u(n)+"</span>\n              </a>\n          </li>\n        "}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var r,o,l,c="",d="function",u=this.escapeExpression,h=i.helperMissing,p=this;return c+='<div class="s-inner">\n  <div class="s-header text-primary">\n    <button class="btn-done btn-med line-right btn-primary">',l={hash:{},data:s},c+=u((r=i.I18n,r?r.call(t,"done",l):h.call(t,"I18n","done",l)))+'</button>\n    <h5 class="line-left">',l={hash:{},data:s},c+=u((r=i.I18n,r?r.call(t,"settings",l):h.call(t,"I18n","settings",l)))+'</h5>\n    <a id="toggle-tabs" class="toggle-tabs"></a>\n  </div>\n\n  <div class="s-body">\n  <div class="s-wrap">\n    <div class="antiscroll-wrap s-tabs">\n      <ul class="tabs vertical antiscroll-inner">\n        <div class="handle-line transition"></div>\n\n        ',o=i.each.call(t,t.tabs,{hash:{},inverse:p.noop,fn:p.program(1,a,s),data:s}),(o||0===o)&&(c+=o),c+='\n        \n      </ul>\n    </div>\n\n    <div class="antiscroll-wrap s-content">\n      <div class="tabs-content antiscroll-inner"></div>\n    </div>\n  </div>\n\n  </div>  \n</div>\n\n'})}),define("view/modal/setting-tabs/main",["require","exports","module","configs/settings","lang/index","utils/server","offline/storage","utils/dom","service/prefs","utils/index","utils/analytics","view/modal/setting-tabs/pref/main","view/modal/setting-tabs/smart-project/main","view/modal/setting-tabs/service/main","view/modal/setting-tabs/backup/main","view/modal/setting-tabs/labs/main","view/modal/setting-tabs/premium/main","view/modal/setting-tabs/redeem/main","view/modal/setting-tabs/shortcuts/main","view/modal/setting-tabs/support/main","view/modal/setting-tabs/personal/main","service/userProfile","dao/shareduserdb","hbs!template/settings"],function(e,t){var i=e("configs/settings"),n=e("lang/index"),s=(e("utils/server"),e("offline/storage"),e("utils/dom")),a=e("service/prefs"),r=e("utils/index"),o=e("utils/analytics"),l=e("view/modal/setting-tabs/pref/main").View,c=e("view/modal/setting-tabs/smart-project/main").View,d=e("view/modal/setting-tabs/service/main").View,u=e("view/modal/setting-tabs/backup/main").View,h=e("view/modal/setting-tabs/labs/main").View,p=e("view/modal/setting-tabs/premium/main").View,m=e("view/modal/setting-tabs/redeem/main").View,f=e("view/modal/setting-tabs/shortcuts/main").View,g=e("view/modal/setting-tabs/support/main").View,v=e("view/modal/setting-tabs/personal/main").View,y=e("service/userProfile"),k=e("dao/shareduserdb").db;t.View=Backbone.View.extend({template:e("hbs!template/settings"),id:"settings-view",className:"settings transition before-animation",needToLoadwholePage:!1,events:{"click .tab":"switchTab","click .btn-done":"removeModal","mouseenter .tab":"doMove","mouseleave .tab":"stopMove","click #toggle-tabs":"toggleTabs"},messages:function(){this.listenTo(Backbone,"needToLoadwholePage",this.markAsUpdated)},initialize:function(){this.render(),this.setAnimation(),this.initDom(),this.messages(),this.showTab("preferences"),this.updateProfile()},updateProfile:function(){y.fetch({success:function(){k.setUserAvatar(y.get("userId"),y.get("picture")),y.set("name",y.get("name")||y.get("username")),y.set("picture",y.get("picture")||i.defaultAvatar)}})},getRenderData:function(){var e="i-sml i-3-1",t=[{active:"active",key:"preferences",sicon:r.svgIcon("icon-setting-preferences",e),text:n.get("preferences")},{active:"",key:"smart",sicon:r.svgIcon("icon-setting-smart-list",e),text:n.get("smart_project")},{active:"",key:"subscribe",sicon:r.svgIcon("icon-setting-subcalendar",e),text:n.get("settings_cal_mail")},{active:"",key:"backup",sicon:r.svgIcon("icon-setting-backup",e),text:n.get("backup_data")},{active:"",key:"labs",sicon:r.svgIcon("icon-setting-labs",e),text:n.get("labs_settings")},{active:"",key:"personal",sicon:r.svgIcon("icon-setting-profile",e),text:n.get("personal_settings")},{active:"",key:"premium",sicon:r.svgIcon("icon-setting-premium",e),text:n.get("premium_account")},{active:"",key:"redeem",sicon:r.svgIcon("icon-setting-redeem",e),text:n.get("redeem")},{active:"",key:"shortcuts",sicon:r.svgIcon("icon-setting-shortcuts",e),text:n.get("shortcuts")},{active:"",key:"about",sicon:r.svgIcon("icon-setting-support",e),text:n.get("about")}];return t},render:function(){var e=this.template({tabs:this.getRenderData()});this.$el.html(e).appendTo($("body"))},setAnimation:function(){var e=this;setTimeout(function(){e.$el.removeClass("before-animation")})},setCloseAnimation:function(){this.$el.addClass("before-animation")},initDom:function(){this.$ul=this.$(".tabs"),this.$tabs=this.$(".tabs > li"),this.$panels=this.$(".tabs-content"),this.$handle=this.$(".handle-line")},getTab:function(e){var t={};return t.preferences="showPreferences",t.smart="showSmartProject",t.subscribe="showSubscribe",t.backup="showBackup",t.labs="showLabs",t.personal="showPersonal",t.premium="showPremium",t.redeem="showRedeem",t.shortcuts="showShortcuts",t.about="showAbout",t[e]},move:function(e){var t=this.$ul.scrollTop(),i=e.position().top;this.$handle.css("top",t+i)},doMove:function(e){this.move($(e.target))},stopMove:function(){this.move(this.$(".tab.active"))},hideAlltabs:function(){this.$tabs.removeClass("active"),this.removeTabViews()},switchTab:function(e){var t=$(e.currentTarget);t.hasClass("active")||(this.hideAlltabs(),t.addClass("active"),this.showTab(t.attr("data-tab")))},showTab:function(e){var t=this.getTab(e);this[t](),s.initScrollbar(this.$(".antiscroll-wrap"))},_appendView:function(){this.$panels.append(this.tabView.$el)},showPreferences:function(){this.tabView=new l({model:a}),this._appendView()},showSmartProject:function(){this.tabView=new c({model:a}),this._appendView()},showSubscribe:function(){this.tabView=new d({model:a}),this._appendView()},showBackup:function(){this.tabView=new u,this._appendView()},showLabs:function(){this.tabView=new h,this._appendView()},showPersonal:function(){this.tabView=new v({model:a}),this._appendView()},showPremium:function(){this.tabView=new p,this._appendView()},showRedeem:function(){this.tabView=new m,this._appendView()},showShortcuts:function(){this.tabView=new f,this._appendView()},showAbout:function(){this.tabView=new g,this._appendView()},toggleTabs:function(e){e=e||window.event,e.stopPropagation(),$("body").toggleClass("tabs-show")},markAsUpdated:function(){this.needToLoadwholePage=!0},_removeModal:function(){this.needToLoadwholePage?window.location.href="/":!window.history||1!==window.history.length&&2!==window.history.length?window.history.back():Backbone.history.navigate("q/all/tasks",{trigger:!0})},removeModal:function(){try{this._removeModal()}catch(e){o.error(e),window.location.href="/"}},removeTabViews:function(){this.tabView&&(this.tabView.onClose?this.tabView.onClose():this.tabView.remove())},removeAllView:function(){this.setCloseAnimation();var e=this;setTimeout(function(){e.removeTabViews(),e.remove()},200)}})}),define("utils/limit-tip",["require","exports","module","configs/settings","configs/limit","offline/storage","lang/index","utils/analytics","utils/server","utils/log","service/userProfile","view/tip","service/project","model/task-user","view/project/share/upgrade-tip"],function(e,t){var i=e("configs/settings"),n=e("configs/limit"),s=e("offline/storage"),a=e("lang/index"),r=e("utils/analytics"),o=e("utils/server"),l=e("utils/log"),c=e("service/userProfile"),d=e("view/tip").View,u=e("service/project"),h=e("model/task-user").Model,p=e("view/project/share/upgrade-tip").upgradeTip;t._getTodayDate=function(){var e=new Date,t=""+e.getFullYear()+(e.getMonth()+1)+e.getDate();return t},t._showUpgrade=function(e,t,i){new d({text:e,actionText:t,action:i,delayTime:1e4})},t._showTip=function(e,i){var n=t._getTodayDate(),a=s.getStoreInfo(e);a&&a===n||(s.setStoreInfo(e,n),i&&i())},t._listsAction=function(){window.open(i.protocol+i.domain+"/payment"),r.u_sub("list")},t.checkListsLimit=function(){if(!c.isPro()&&u.getProjectsCount()>n.projectNumber){var e="limitList",i=a.get("limit_tip_lists").replace("%s1",n.projectNumber),s=a.get("upgrade_now"),r=_.bind(t._showUpgrade,this,i,s,t._listsAction);t._showTip(e,r)}},t._shareAction=function(){window.open(i.protocol+i.domain+"/payment"),r.u_sub("sharing")},t._checkOwnerShareLimit=function(e){var i="limitShare"+e.id,s=a.get("limit_tip_share").replace("%s1",n.pro.shareUserNumber),r=a.get("renew_now"),o=_.bind(t._showUpgrade,this,s,r,t._shareAction);t._showTip(i,o)},t._freeShareAction=function(e,t){var i=!1;p.showUpgradeView(i,e,t)},t._checkFreeShareCb=function(e){var i=this,s=e.get("id");o.getShareMoreCount(s,function(r){r>0||o.getProjectShareUsers(s,function(r){var o=new Backbone.Collection([],{model:h});r=_.map(r,function(e){return e.projectId=s,e.nickname=e.displayName,e},i),o.set(r,{silent:!0});var l=a.get("limit_tip_share").replace("%s1",n.pro.shareUserNumber),c=a.get("learn_more"),d=_.bind(t._freeShareAction,i,e,o);t._showUpgrade(l,c,d)},function(e){l.log(e)})})},t._checkFreeShareLimit=function(e){var i="limitShare"+e.id,n=_.bind(t._checkFreeShareCb,this,e);t._showTip(i,n)},t.checkShareLimit=function(e){if(!c.isPro()){var i=e.get("userCount");i&&(i<=n.shareUserNumber+1||i!==n.pro.shareUserNumber+1&&(e.get("isOwner")?t._checkOwnerShareLimit(e):t._checkFreeShareLimit(e)))}}}),define("service/router",["require","exports","module","configs/settings","configs/dict","lang/index","configs/status","utils/analytics","utils/dom","utils/hash","utils/string","offline/storage","utils/log","dao/projectdb","view/tasklist/project","view/tasklist/smart-project","view/tasklist/date","view/tasklist/search","view/tasklist/tag","view/tasklist/completed","view/tkcalendar/calendar","view/notification/list","configs/regexp","dao/project-group","view/tasklist/group","service/prefs","view/modal/setting-tabs/main","utils/limit-tip","utils/limit-lab"],function(e,t){var i=e("configs/settings"),n=e("configs/dict"),s=(e("lang/index"),e("configs/status")),a=e("utils/analytics"),r=e("utils/dom"),o=e("utils/hash"),l=(e("utils/string"),e("offline/storage"),e("utils/log")),c=e("dao/projectdb").db,d=e("view/tasklist/project").View,u=e("view/tasklist/smart-project").View,h=e("view/tasklist/date").View,p=e("view/tasklist/search").View,m=e("view/tasklist/tag").View,f=e("view/tasklist/completed").View,g=e("view/tkcalendar/calendar").View,v=e("view/notification/list").View,y=e("configs/regexp"),k=e("dao/project-group").db,w=e("view/tasklist/group").View,b=e("service/prefs"),T=e("view/modal/setting-tabs/main").View,I=e("utils/limit-tip"),C=e("utils/limit-lab"),x=Backbone.Router.extend({initialize:function(){this.messages()},messages:function(){this.listenTo(Backbone,"navigateToAllList",this.navigateToAllList),this.listenTo(Backbone,"navigateTaskManually",this.navigateTaskManually),this.listenTo(Backbone,"navigateTask",this.navigateTask),this.listenTo(Backbone,"navigateProject",this.navigateProject),this.listenTo(Backbone,"navigateFirstTaskOnList",this.goToFirstTaskOnList),this.listenTo(Backbone,"navigateUrl",this.navigateUrl),this.listenTo(Backbone,"navigateListViewByfilter",this.showCompletedTasksByFilter),this.listenTo(Backbone,"showTaskUnderProject",this.showTaskUnderProject)},routes:{"":"home",refresh:"refresh","q/:name/:type":"listBySmartProject","q/:name/:type/:id":"showTaskUnderSmartProject","p/:pid/:type":"listByProject","p/:pid/:type/:id":"showTaskUnderProject","g/:pid/:type":"listByProjectGroup","g/:pid/:type/:id":"showTaskUnderProjectGroup","d/:date/:type":"listByDate","d/:date/:type/:id":"showTaskUnderDate","s/":"listBySearch","n/:pid/:type":"showNotificationList","t/:tagName/:type":"listByTag","c/:id/:type":"showCalendar",settings:"showSettings","*actions":"defaultRoute"},showSettings:function(){$("#project-list-view").find(".project.active").removeClass("active"),this.settingsView=new T,a.me_settings()},_loadListViewByProject:function(e,t,i){return this.project=e,this.project?(this._initProjectListView(),this._initSortType(t),void(o.isInCompleted()?this.projectListView=new f({project:this.project,sortType:s.CurrentSortType}):o.isInSmartProjectView()?this.projectListView=new u({project:this.project,sortType:s.CurrentSortType,taskId:i}):o.isInProjectGroup()?this.projectListView=new w({project:this.project,sortType:s.CurrentSortType,taskId:i}):o.isInProjectView()&&(this.projectListView=new d({project:this.project,sortType:s.CurrentSortType,taskId:i})))):void this.home()},_initProjectListView:function(){this.settingsView&&this.settingsView.removeAllView(),this.projectListView&&this.projectListView.onClose()},_initSortType:function(e){return"assignedme"===e?void(s.CurrentSortType=b.getSortTypeOfAssignedMe()):"today"===e?void(s.CurrentSortType=b.getSortTypeOfToday()):"week"===e?void(s.CurrentSortType=b.getSortTypeOfWeek()):void(s.CurrentSortType=n.sortType[e]?n.sortType[e]:this.project.get("sortType"))},_validateType:function(e){return _.include(n.projectType,e)},navigateTaskManually:function(e,t){var i=o.getTaskUpperLevelPath()+"/"+e;this.navigate(i,{replace:!0}),this.projectListView.loadTaskDetailView(e,t),l.log("navigateTask:",e)},navigateTask:function(e,t){_.debounce(this.navigateTaskManually,3*i.responsiveTime).apply(this,[e,t])},_navigateProject:function(e,t){Backbone.history.fragment===e?Backbone.history.loadUrl(Backbone.history.fragment):this.navigate(e,t),l.log("navigateProject:",e)},navigateProject:function(e,t){_.debounce(this._navigateProject,5*i.responsiveTime).apply(this,[e,t])},goToFirstTaskOnList:function(){var e=$("#task-ul-list").find("li");if(e.length>0){$("#task-ul-list ul li").removeClass("selected active");var t=$(e.get(0));t.toggleClass("selected active"),r.placeCaretAtEnd(t.find(".title").get(0)),this.navigateTask(t.find("a").attr("taskid"))}},defaultRoute:function(e){this.refresh()},navigateUrl:function(e,t){this.navigate(e,t)},navigateToAllList:function(){this.navigate("",{trigger:!0,replace:!0})},home:function(){var e=y.urlTaskId.exec(location.pathname),t=e?e[1]:null,i=t&&"q/all/tasks/"+t||"q/all/tasks";this.navigateProject(i,!0)},refresh:function(){var e=this;c.refresh(function(){e.navigateProject("q/all/tasks",!0)})},listByProject:function(e,t){$(".k-days span").removeClass("k-selected"),this._validateType(t)&&(this.project=c.getProjectById(e),this.project||(this.project=c.getProjectByName(decodeURIComponent(e))),this._loadListViewByProject(this.project,t),I.checkShareLimit(this.project))},listByProjectGroup:function(e,t){$(".k-days span").removeClass("k-selected"),this._validateType(t)&&(this.projectGroup=k.getGroupById(e),this.projectGroup||(this.projectGroup=k.getGroupByName(decodeURIComponent(e))),this._loadListViewByProject(this.projectGroup,t),a.l_view("group"))},showTaskUnderSmartProject:function(e,t,i){l.log("showTaskUnderSmartProject:",e,t,i),this._openSmartProject(e,t,i)},listBySmartProject:function(e,t){l.log("listBySmartProject:",e,t),$(".k-days span").removeClass("k-selected"),this._openSmartProject(e,t)},showTaskUnderProject:function(e,t,i){l.log("showTaskUnderProject:",e,t,i),this._validateType(t)&&(this.project=c.getProjectById(e),this.project||(this.project=c.getProjectByName(decodeURIComponent(e))),this._loadListViewByProject(this.project,t,i))},showTaskUnderProjectGroup:function(e,t,i){l.log("showTaskUnderProject:",e,t,i),this._validateType(t)&&(this.projectGroup=k.getGroupById(e),this.projectGroup||(this.projectGroup=k.getGroupByName(decodeURIComponent(e))),this._loadListViewByProject(this.projectGroup,t,i))},listByDate:function(e,t,i){var r=this;C.checkPro(n.pluginId.calendar,function(){return s.calendar?(s.calendar.isSelected(e)||s.calendar.setSelected(e),r._initProjectListView(),
r._validateType(t)&&(r.projectListView=new h({date:e,taskId:i})),void a.m_date(e)):r.defaultRoute()})},showTaskUnderDate:function(e,t,i){this._validateType(t)&&this.listByDate(e,t,i)},listBySearch:function(){this._initProjectListView(),this.projectListView=new p,a.se_normal()},listByTag:function(e,t){this._initProjectListView(),this._validateType(t)&&(this.projectListView=new m({tName:decodeURIComponent(e)})),a.l_view("tag")},showCalendar:function(e,t){var i=this;C.checkPro(n.smartProjectId.tkcalendar,function(){i._initProjectListView(),i._validateType(t)&&(i.projectListView&&i.projectListView.onClose(),i.projectListView=new g),a.l_view("calendar")})},showNotificationList:function(e,t){var i;i=c.getProjectById(e),this.project||(i=c.getProjectByName(decodeURIComponent(name))),i?this.navigate("p/"+e+"/tasks",!0):(this.home(),setTimeout(function(){$(".dropdown.notification").addClass("open"),new v},1e3))},showCompletedTasksByFilter:function(e,t,i){this._initProjectListView(),s.CurrentSortType=n.sortType.filterCompleted,this.project=c.getSmartProjectById("tasks"),this.project=this.project.clone(),this.project.set("id",e),this.project.set("name",i),this.projectListView=new u({project:this.project,sortType:s.CurrentSortType,rangeTime:t})},_openSmartProject:function(e,t,i){if(this._validateType(t))this.project=c.getSmartProjectById("tasks"),this._loadListViewByProject(this.project,t,i),a.l_view(t);else if(t===n.smartProjectId.subscribe){var s=this;C.checkPro(n.pluginId.calSubscribe,function(){s.project="calendar"!=e?c.getSmartProjectById(e):null,s._loadListViewByProject(s.project,t)})}}});t.router=new x}),define("service/shortcuts",["require","exports","module","utils/hash","utils/dom","utils/browser","configs/status"],function(e,t){var i=e("utils/hash"),n=e("utils/dom"),s=e("utils/browser"),a=e("configs/status"),r=function(e){return e.is(".high-priority")||e.is(".medium-priority")||e.is(".low-priority")||e.is(".none-priority")};t.use={initialize:function(){$(document).keydown(function(e){return e=e||window.event,9!=e.keyCode||i.isSettings()||s.isFirefox?8==e.keyCode&&e.target==document.body?(e.preventDefault(),!1):void(83==e.keyCode&&e.ctrlKey&&!e.altKey&&e.preventDefault()):(e.preventDefault(),!1)}),my_combos=[{keys:"meta /",is_exclusive:!0,is_ordered:!0,on_keydown:function(e){return!1},on_keyup:function(e){return!1},"this":this},{keys:"meta p",is_exclusive:!0,is_ordered:!0,on_keydown:function(e){return!1},on_keyup:function(e){return e.preventDefault(),Backbone.trigger("printProject"),!1},"this":this},{keys:"ctrl alt s",is_exclusive:!0,is_ordered:!0,on_keydown:function(){return!0},on_keyup:function(e){return!1},"this":this},{keys:"meta s",is_exclusive:!0,is_ordered:!0,on_keydown:function(){return!1},on_keyup:function(e){return Backbone.trigger("saveTaskByShortcut"),e.preventDefault(),!1},"this":this},{keys:"tab a",is_exclusive:!0,on_keydown:function(){return Backbone.trigger("navigateProject","q/all/tasks",!0),!1},on_keyup:function(e){return!1},"this":this},{keys:"tab c",is_exclusive:!0,on_keydown:function(){return Backbone.trigger("navigateProject","q/all/completed",!0),!1},on_keyup:function(e){return!1},"this":this},{keys:"tab t",is_exclusive:!0,on_keydown:function(){return Backbone.trigger("navigateProject","q/all/trash",!0),!1},on_keyup:function(e){return!1},"this":this},{keys:"tab l",is_exclusive:!0,on_keydown:function(){return n.setFocusToCurrentProject(),!1},on_keyup:function(e){return!1},"this":this},{keys:"tab n",is_exclusive:!0,on_keydown:function(){return $(".task-new").focus(),!1},on_keyup:function(e){return!1},"this":this},{keys:"tab m",is_exclusive:!0,on_keydown:function(e){e=e||window.event;var t=$(e.target);return(t.is("#task-ul-list li .title")||t.is(".task-title")||t.is(".taskcontent")||t.is(".sub-task .title")||t.is(".dueDate")||t.is(".reminder")||t.is(".repeat")||t.is(".high-priority")||t.is(".medium-priority")||t.is(".low-priority")||t.is(".none-priority")||t.is("#project-setting .project"))&&(Backbone.trigger("toggleCompleteByShortcut"),t.is(".title.span6")&&this.setFocusToCurrentTask()),!1},on_keyup:function(e){return!1},"this":this},{keys:"tab s",is_exclusive:!0,on_keydown:function(e){e=e||window.event;var t=$(e.target);return(t.is("#task-ul-list li .title")||t.is(".task-title")||t.is(".taskcontent")||t.is(".sub-task .title")||t.is(".dueDate")||t.is(".reminder")||t.is(".repeat")||r(t)||t.is("#project-setting .project")||$("#task-ul-list .task.active").length>0)&&(Backbone.trigger("setPriorityByShortcut"),this.setFocusToCurrentTask()),!1},on_keyup:function(e){return!1},"this":this},{keys:"tab d",is_exclusive:!0,on_keydown:function(e){return Backbone.trigger("toggleCalendarByShortcut",e),!1},on_keyup:function(e){return!1},"this":this},{keys:"tab 1",is_exclusive:!0,on_keydown:function(e){e=e||window.event;var t=$(e.target);if(t.is("#task-ul-list li .title")||t.is(".task-title")||t.is(".taskcontent")||t.is(".sub-task .title")||t.is(".dueDate")||t.is(".reminder")||t.is(".repeat")||r(t)||t.is("#project-setting .project")||$("#task-ul-list .task.active").length>0){var i=!1;t.is("#task-ul-list li .title")&&(i=!0),Backbone.trigger("setTodayByShortcut"),this.setFocusToCurrentTask(i)}return!1},on_keyup:function(e){return!1},"this":this},{keys:"tab 2",is_exclusive:!0,on_keydown:function(e){e=e||window.event;var t=$(e.target);if(t.is("#task-ul-list li .title")||t.is(".task-title")||t.is(".taskcontent")||t.is(".sub-task .title")||t.is(".dueDate")||t.is(".reminder")||t.is(".repeat")||r(t)||t.is("#project-setting .project")||$("#task-ul-list .task.active").length>0){var i=!1;t.is("#task-ul-list li .title")&&(i=!0),Backbone.trigger("setTomorrowByShortcut"),this.setFocusToCurrentTask(i)}return!1},on_keyup:function(e){return!1},"this":this},{keys:"tab 3",is_exclusive:!0,on_keydown:function(e){e=e||window.event;var t=$(e.target);if(t.is("#task-ul-list li .title")||t.is(".task-title")||t.is(".taskcontent")||t.is(".sub-task .title")||t.is(".dueDate")||t.is(".reminder")||t.is(".repeat")||r(t)||t.is("#project-setting .project")||$("#task-ul-list .task.active").length>0){var i=!1;t.is("#task-ul-list li .title")&&(i=!0),Backbone.trigger("setNextWeekByShortcut"),this.setFocusToCurrentTask(i)}return!1},on_keyup:function(e){return!1},"this":this},{keys:"tab",is_exclusive:!0,on_keydown:function(){},on_keyup:function(e){e=e||window.event;var t=$(e.target);if(t.is("#task-new"))i.isShowDetailView()?this.setFocusToTaskContent():Backbone.trigger("navigateFirstTaskOnList");else if(t.is("#project-list-view .project"))Backbone.trigger("navigateFirstTaskOnList");else if(t.is(".task-title")||t.is("#task-ul-list li .title"))this.setFocusToTaskContent();else if(t.is(".taskcontent")||t.is(".sub-task .title"))$("#task-detail-view").find(".dueDate").focus();else if(t.is(".dueDate"))Backbone.trigger("closeCalendarPicker"),$("#task-detail-view").find(".reminder").focus();else{if(t.is(".reminder")||t.is(".timepicker-quick-selector li"))return;if(t.is(".repeat"))Backbone.trigger("closeRepeatPicker"),$("#task-detail-view").find(".high-priority").focus();else if(t.is(".high-priority"))$("#task-detail-view").find(".medium-priority").focus();else if(t.is(".medium-priority"))$("#task-detail-view").find(".low-priority").focus();else if(t.is(".low-priority"))$("#task-detail-view").find(".none-priority").focus();else if(t.is(".none-priority"))$("#task-detail-view").find(".project").focus();else if(t.is(".project"))$("#task-detail-view").find(".task-title").focus(),Backbone.trigger("closeProjectDropdown");else if(t.is("#password-input"))$("#new-password-input1").focus();else if(t.is("#new-password-input1"))$("#new-password-input2").focus();else if(t.is("#new-password-input2"))$("#change-password-modal-btn").focus();else if(t.is("#change-password-modal-btn"))$("#password-input").focus();else if(t.is("#time-setting input"));else if(t.is("#project-name"))$("#project-save-button").focus();else if(t.is(".btn"))t.siblings(".btn").focus();else{if(t.is(".modal *"))return;n.setFocusToCurrentProject()}}return!1},"this":this},{keys:"shift tab",is_exclusive:!0,on_keydown:function(){},on_keyup:function(e){e=e||window.event;var t=$(e.target);if(t.is("#task-new"))n.setFocusToCurrentProject();else if(t.is(".task-title"))$("#task-detail-view").find(".project").focus();else if(t.is(".taskcontent")||t.is(".sub-task .title"))$("#task-detail-view").find(".task-title").focus();else if(t.is(".dueDate")){Backbone.trigger("closeCalendarPicker");var i=$("#task-detail-view").find(".taskcontent");i.is(":hidden")?$("#task-detail-view").find(".sub-task .title").get(0).focus():i.focus()}else if(t.is(".reminder"))Backbone.trigger("closeReminderDropdown"),$("#task-detail-view").find(".dueDate").focus();else if(t.is(".repeat"))Backbone.trigger("closeRepeatPicker"),$("#task-detail-view").find(".reminder").focus();else if(t.is(".high-priority")){var s=$("#task-detail-view").find(".repeat");"none"==s.css("display")?$("#task-detail-view").find(".reminder").focus():$("#task-detail-view").find(".repeat").focus()}else t.is(".medium-priority")?$("#task-detail-view").find(".high-priority").focus():t.is(".low-priority")?$("#task-detail-view").find(".medium-priority").focus():t.is(".none-priority")?$("#task-detail-view").find(".low-priority").focus():t.is(".project")?(Backbone.trigger("closeProjectDropdown"),$("#task-detail-view").find(".none-priority").focus()):t.is("#password-input")?$("#change-password-modal-btn").focus():t.is("#new-password-input1")?$("#password-input").focus():t.is("#new-password-input2")?$("#new-password-input1").focus():t.is("#change-password-modal-btn")&&$("#new-password-input2").focus();return!1},"this":this},{keys:"escape",is_exclusive:!0,on_keydown:function(e){e=e||window.event;var t=$(e.target);return $.fn.colorbox.close(),t.is("#task-new")||t.is("#task-ul-list .title")?n.setFocusToCurrentProject():$(".modal.in").length>0&&0===$(".wechat-qrcode-container").length?$(".modal.in").modal("hide"):t.is(".task-title")||t.is(".taskcontent")||t.is(".sub-task .title")||t.is(".dueDate")||t.is(".reminder")||t.is(".repeat")||r(t)||t.is("#project-setting .project")?(this.setFocusToCurrentTask(),Backbone.trigger("closeCalendarPicker"),Backbone.trigger("closeReminderDropdown"),Backbone.trigger("closeRepeatPicker"),Backbone.trigger("closeProjectDropdown")):t.is(".dropdown-menu a")?t.parents("ul").prevAll("input.dropdown-toggle").focus():n.setFocusToCurrentProject(),$("#out-single-task-detail").length&&!$("#js-timecard").length&&Backbone.trigger("hideOutSingleTask"),i.isInTKCalendar()&&a.hasPopup&&Backbone.trigger("hidePopup"),$("#project-dropdown-menu").length&&$("#project-dropdown-menu").addClass("hide"),$("#js-timecard").length&&$("#js-timecard").remove(),!1},on_keyup:function(e){return!1},"this":this}];var e=new window.keypress.Listener;e.register_many(my_combos)},setFocusToCurrentTask:function(e){var t=!0;if("undefined"==typeof e||e||(t=!1),t){var i=$(".task.active").first().find(".title").get(0);i&&n.placeCaretAtEnd(i)}},setFocusToTaskContent:function(){var e=$("#task-detail-view").find(".taskcontent");e.is(":hidden")?$("#task-detail-view").find(".sub-task .title").get(0).focus():e.focus()}}}),define("hbs!template/userTagList",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){var n,s,a,r="";return r+='\n    <li class="tagItem-li project ui-droppable tag-li">\n      <a class="tagItem project-box" href="#t/',(n=i.tagName)?n=n.call(e,{hash:{},data:t}):(n=e.tagName,n=typeof n===l?n.apply(e):n),r+=c(n)+'/tasks">\n      ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-tag","i-1",a):d.call(e,"svgIcon","icon-tag","i-1",a),(s||0===s)&&(r+=s),r+='\n      <span class="project-title l-title">',(s=i.tagName)?s=s.call(e,{hash:{},data:t}):(s=e.tagName,s=typeof s===l?s.apply(e):s),r+=c(s)+'</span>\n      <span class="count">',(s=i.tagCount)?s=s.call(e,{hash:{},data:t}):(s=e.tagCount,s=typeof s===l?s.apply(e):s),r+=c(s)+"</span>\n      </a>\n    </li>\n    "}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var r,o="",l="function",c=this.escapeExpression,d=i.helperMissing,u=this;return o+='<ul class="tag-ul">\n    ',r=i.each.call(t,t.tagsList,{hash:{},inverse:u.noop,fn:u.program(1,a,s),data:s}),(r||0===r)&&(o+=r),o+="\n</ul>\n"})}),define("view/userTag/list",["require","exports","module","service/tag","hbs!template/userTagList"],function(e,t){var i=e("service/tag");t.View=Backbone.View.extend({template:e("hbs!template/userTagList"),isNum:1,isAlpha:2,isLocale:3,events:{"click .tag-li > a":"doClick"},messages:function(){this.listenTo(this.model,"change:taglist",this.render),this.listenTo(Backbone,"refreshTagsList",this.refreshTagsList),this.listenTo(Backbone,"UpdateTagsCount",this.updateTagsCount)},initialize:function(e){this.model=e.tags,this.messages(),this.render()},refreshTagsList:function(){i.updateTags()},render:function(){var e=this.model.get("tags"),t=(e.length,[]);for(var i in e)t.push({tagName:i,tagCount:e[i]});this.el=this.template({tagsList:t}),this.$el=$(this.el),$(".tag-ul").remove(),_.isEmpty(e)||$(".tag-list").prepend(this.$el)},updateTagsCount:function(){var e=this.model.get("tags");for(var t in e){var i=$(".tag-list").find('a[href="#t/'+t+'/tasks"] .count');i.text(e[t])}},sort:function(e,t){if(""===e||""===t){if(""===e&&""===t)return 0;if(""===e)return-1;if(""===t)return 1}var i=e.substr(0,1),n=t.substr(0,1),s=this.type(i),a=this.type(n);if(a>s)return-1;if(s>a)return 1;if(s===this.isNum||s===this.isAlpha)return n>i?-1:i>n?1:this.sort(e.substr(1),t.substr(1));var r=i.localeCompare(n);return 0!==r?r:this.sort(e.substr(1),t.substr(1))},type:function(e){var t=/^[0-9]$/,i=/^[a-zA-Z]$/;return t.test(e)?this.isNum:i.test(e)?this.isAlpha:this.isLocale},doClick:function(e){e=e||window.event;var t=e.currentTarget.href;setTimeout(function(){Backbone.history.fragment===t.replace(/[\s\S]+#/g,"")&&Backbone.history.loadUrl(Backbone.history.fragment)},200)}})}),define("hbs!template/project_item",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){var n,s,a,l="";return l+='\n    <a href="#p/',(n=i.id2)?n=n.call(e,{hash:{},data:t}):(n=e.id2,n=typeof n===m?n.apply(e):n),l+=f(n)+'/tasks" projectId="',(n=i.id)?n=n.call(e,{hash:{},data:t}):(n=e.id,n=typeof n===m?n.apply(e):n),l+=f(n)+'" id="project_',(n=i.id)?n=n.call(e,{hash:{},data:t}):(n=e.id,n=typeof n===m?n.apply(e):n),l+=f(n)+'" \n        class="',a={hash:{},inverse:g.noop,fn:g.program(2,r,t),data:t},n=i.ifnotequal,s=n?n.call(e,e.id2,"inbox",a):v.call(e,"ifnotequal",e.id2,"inbox",a),(s||0===s)&&(l+=s),l+=" project-box project-link ",a={hash:{},inverse:g.noop,fn:g.program(4,o,t),data:t},n=i.ifgreaterthan,s=n?n.call(e,e.userCount,1,a):v.call(e,"ifgreaterthan",e.userCount,1,a),(s||0===s)&&(l+=s),l+='">\n  '}function r(e,t){return"l-item"}function o(e,t){return" shared"}function l(e,t){var n,s="";return s+='\n    <a href="#q/all/',(n=i.taskType)?n=n.call(e,{hash:{},data:t}):(n=e.taskType,n=typeof n===m?n.apply(e):n),s+=f(n)+'" projectId="',(n=i.id)?n=n.call(e,{hash:{},data:t}):(n=e.id,n=typeof n===m?n.apply(e):n),s+=f(n)+'" id="project_',(n=i.id)?n=n.call(e,{hash:{},data:t}):(n=e.id,n=typeof n===m?n.apply(e):n),s+=f(n)+'" class="project-box project-link">\n  '}function c(e,t){var n,s,a,r="";return r+='\n        <span class="dropdown p-caret">\n          <span class="dropdown-toggle" data-toggle="dropdown" data-dropdown="#list-dropdown-id_',(n=i.id)?n=n.call(e,{hash:{},data:t}):(n=e.id,n=typeof n===m?n.apply(e):n),r+=f(n)+'">\n          ',a={hash:{},data:t},n=i.svgIcon,s=n?n.call(e,"icon-more","i-1",a):v.call(e,"svgIcon","icon-more","i-1",a),(s||0===s)&&(r+=s),r+="\n          </span>\n        </span>\n      "}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var d,u,h,p="",m="function",f=this.escapeExpression,g=this,v=i.helperMissing;return p+="  ",h={hash:{},inverse:g.program(6,l,s),fn:g.program(1,a,s),data:s},d=i.ifnotequal,u=d?d.call(t,t.listType,"non-project",h):v.call(t,"ifnotequal",t.listType,"non-project",h),(u||0===u)&&(p+=u),p+="\n\n      ",h={hash:{},data:s},d=i.getProjectInnerHtml,u=d?d.call(t,t.id,t.name,h):v.call(t,"getProjectInnerHtml",t.id,t.name,h),(u||0===u)&&(p+=u),p+="\n      ",h={hash:{},inverse:g.noop,fn:g.program(8,c,s),data:s},d=i.ifnotequal,u=d?d.call(t,t.listType,"non-project",h):v.call(t,"ifnotequal",t.listType,"non-project",h),(u||0===u)&&(p+=u),p+='\n      <span class="count"></span>\n    </a>\n  \n'})}),define("view/project/list/base",["require","exports","module","configs/dict","dao/taskdb","service/prefs","configs/status","hbs!template/project_item"],function(e,t){var i=e("configs/dict"),n=e("dao/taskdb").db,s=e("service/prefs"),a=e("configs/status");t.View=Backbone.View.extend({tagName:"li",attributes:{tabindex:"1"},template:e("hbs!template/project_item"),events:{"click a.project-link":"navigateByClick"},messages:function(){},initialize:function(e){},baseRender:function(e){var t=this.model.toJSON();return t.id2=e||t.id,this.$el.html(this.template(t)),this},navigateByClick:function(e){$("#taskcontent").length&&$("#taskcontent").blur();var t=$(e.currentTarget),i=t.attr("href").replace("#","");Backbone.history.fragment===i?Backbone.history.loadUrl(Backbone.history.fragment):Backbone.trigger("navigateUrl",i,{trigger:!0})},_initDroppable:function(e,t){var n=this,s=e||this.$el,r=!0,t=t||".task, .sub-task";s.droppable({accept:t,tolerance:"pointer",greedy:!0,hoverClass:i.hoverClass.project,activate:function(e,t){n._activateUI&&n._activateUI(e,t)},deactivate:function(e,t){},over:function(e,t){a.dropOnMinCalendar&&(r=!1),n._overUI&&n._overUI(e,t)},out:function(e,t){n._outUI&&n._outUI(e,t)},drop:function(e,t){return r?(n._dropUI&&n._dropUI(e,t),t.draggable.hasClass("sub-task")?(n._createTaskFromSubtask(t),void Backbone.trigger("deleteSubtaskTurned",t.draggable)):t.draggable.hasClass("task")?void n._moveTaskToProject(t):void(n._drop&&n._drop(e,t))):void 0}})},_createTaskFromSubtask:function(e){var t,i,a,r=e.draggable.find(".title").text(),o=this.model.get("id");a=this._getTaskProperties&&this._getTaskProperties(),a=a||{};var l=a.projectId||o,c=$("#task-ul-list ul>li.active").find("a").attr("taskid"),d=n.getById(c),u=d.get("priority"),t=a.dueDate||d.get("dueDate"),h=d.get("repeatFlag"),p=d.get("repeatFrom"),m=d.get("reminders"),f=d.get("isAllDay"),i=a.status||(e.draggable.hasClass("checked")?2:0),g={id:ObjectId(),title:r,projectId:l,priority:u,dueDate:t,reminders:m,isAllDay:f,repeatFlag:h,repeatFrom:p,status:i,timeZone:s.get("timeZone")};n.collection.create(g)},_moveTaskToProject:function(e){var t,i=e.draggable,n=(this.model.get("id"),i.find("a").attr("projectId"),$("#task-ul-list ul>li.addClassDrag.selected").not(".ui-sortable-placeholder"));n.length>0?this._taskDrop&&this._taskDrop():(n=$("#task-ul-list ul>li.addClassDrag"),t=n.find("a").attr("taskid"),this._taskDrop&&this._taskDrop(t))}})}),define("view/project/list/all",["require","exports","module","view/project/list/base","utils/analytics"],function(e,t){var i=e("view/project/list/base").View,n=e("utils/analytics");t.View=i.extend({className:"project smart-project",events:{"click a":"analyticsByclick"},messages:function(){},initialize:function(e){this.render(),this.events=_.extend({},i.prototype.events,this.events),this.constructor.__super__.initialize.apply(this,[e])},render:function(){this.baseRender(),this.initDroppable()},initDroppable:function(){this._initDroppable(this.$el,".task, .sub-task")},analyticsByclick:function(){n.l_view("all_click")}})}),define("view/project/list/today",["require","exports","module","utils/timeformat","view/project/list/base","service/userProfile"],function(e,t){var i=e("utils/timeformat"),n=e("view/project/list/base").View,s=e("service/userProfile");t.View=n.extend({className:"project smart-project",events:{},messages:function(){},initialize:function(e){this.render(),this.events=_.extend({},n.prototype.events,this.events),this.constructor.__super__.initialize.apply(this,[e])},render:function(){this.baseRender(),this.initDroppable()},_getTaskProperties:function(){return{projectId:s.get("inboxId"),dueDate:i.prefMoment().format("YYYY-MM-DDT00:00:00.000ZZ")}},_taskDrop:function(e){e?Backbone.trigger("setTodayByDrag",e):Backbone.trigger("setTodayByShortcut")},initDroppable:function(){this._initDroppable(this.$el,".task, .sub-task")}})}),define("view/project/list/next7days",["require","exports","module","utils/timeformat","view/project/list/base","service/userProfile"],function(e,t){var i=e("utils/timeformat"),n=e("view/project/list/base").View,s=e("service/userProfile");t.View=n.extend({className:"project smart-project",events:{},messages:function(){},initialize:function(e){this.render(),this.events=_.extend({},n.prototype.events,this.events),this.constructor.__super__.initialize.apply(this,[e])},_getTaskProperties:function(){return{projectId:s.get("inboxId"),dueDate:i.prefMoment().add("days",1).format("YYYY-MM-DDT00:00:00.000ZZ")}},_taskDrop:function(e){e?Backbone.trigger("setTomorrowByDrag",e):Backbone.trigger("setTomorrowByShortcut")},render:function(){this.baseRender(),this.initDroppable()},initDroppable:function(){this._initDroppable(this.$el,".task, .sub-task")}})}),define("view/project/list/inbox",["require","exports","module","view/project/list/base","utils/analytics"],function(e,t){var i=e("view/project/list/base").View,n=e("utils/analytics");t.View=i.extend({className:"project smart-project",events:{"click a":"analyticsByclick"},messages:function(){},initialize:function(e){this.messages(),this.render(),this.events=_.extend({},i.prototype.events,this.events),this.constructor.__super__.initialize.apply(this,[e])},render:function(){this.baseRender("inbox"),this.initDroppable()},initDroppable:function(){this._initDroppable(this.$el,".task, .sub-task",function(e,t){})},_taskDrop:function(e){var t=this.model.get("id");e?Backbone.trigger("moveSelectedToProjectByDrag",e,t):Backbone.trigger("moveSelectedToProject",t)},analyticsByclick:function(){n.l_view("inbox")}})}),define("hbs!template/project_calendar_item",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o,l="",c="function",d=this.escapeExpression,u=i.helperMissing;return l+='<a href="#c/all/',(a=i.taskType)?a=a.call(t,{hash:{},data:s}):(a=t.taskType,a=typeof a===c?a.apply(t):a),l+=d(a)+'" projectId="',(a=i.id)?a=a.call(t,{hash:{},data:s}):(a=t.id,a=typeof a===c?a.apply(t):a),l+=d(a)+'" id="project_',(a=i.id)?a=a.call(t,{hash:{},data:s}):(a=t.id,a=typeof a===c?a.apply(t):a),l+=d(a)+'" class="project-box project-link">\n    ',o={hash:{},data:s},a=i.getProjectInnerHtml,r=a?a.call(t,t.id,t.name,o):u.call(t,"getProjectInnerHtml",t.id,t.name,o),(r||0===r)&&(l+=r),l+='<span class="count"></span>\n</a>\n'})}),define("view/project/list/calendar",["require","exports","module","view/project/list/base","hbs!template/project_calendar_item"],function(e,t){var i=e("view/project/list/base").View;t.View=i.extend({className:"project smart-project",template:e("hbs!template/project_calendar_item"),initialize:function(e){this.identifyCalendrView(),this.render(),this.events=_.extend({},i.prototype.events,this.events),this.constructor.__super__.initialize.apply(this,[e])},identifyCalendrView:function(){"calendar"==this.model.get("id")&&this.$el.addClass("tkcalendar")},render:function(){return this.baseRender()}})}),define("hbs!template/project_confirm_delete",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){var n,s,a="";return a+="\n        ",s={hash:{},data:t},a+=I((n=i.I18n,n?n.call(e,"delete_group_title",s):T.call(e,"I18n","delete_group_title",s)))+"\n      "}function r(e,t){var n,s,a="";return a+="\n        ",s=i["if"].call(e,(n=e.model,null==n||n===!1?n:n.isOwner),{hash:{},inverse:C.program(6,l,t),fn:C.program(4,o,t),data:t}),(s||0===s)&&(a+=s),a+="\n      "}function o(e,t){var n,s,a="";return a+="\n            ",s={hash:{},data:t},a+=I((n=i.I18n,n?n.call(e,"delete_project",s):T.call(e,"I18n","delete_project",s)))+"\n        "}function l(e,t){var n,s,a="";return a+="\n            ",s={hash:{},data:t},a+=I((n=i.I18n,n?n.call(e,"share_exit_confirm_title",s):T.call(e,"I18n","share_exit_confirm_title",s)))+"\n        "}function c(e,t){var n,s,a="";return a+="\n            ",s={hash:{},data:t},a+=I((n=i.I18n_Plus,n?n.call(e,"delete_group_content",(n=e.model,null==n||n===!1?n:n.name),s):T.call(e,"I18n_Plus","delete_group_content",(n=e.model,null==n||n===!1?n:n.name),s)))+"\n        "}function d(e,t){var n,s,a="";return a+="\n            ",s=i["if"].call(e,(n=e.model,null==n||n===!1?n:n.isOwner),{hash:{},inverse:C.program(16,m,t),fn:C.program(11,u,t),data:t}),(s||0===s)&&(a+=s),a+="\n        "}function u(e,t){var n,s,a,r="";return r+="\n                ",n=i["if"].call(e,e.isOwnerShare,{hash:{},inverse:C.program(14,p,t),fn:C.program(12,h,t),data:t}),(n||0===n)&&(r+=n),r+="\n                ",a={hash:{},data:t},n=i.I18n_Plus,s=n?n.call(e,"confirm_delete_project",(n=e.model,null==n||n===!1?n:n.name),a):T.call(e,"I18n_Plus","confirm_delete_project",(n=e.model,null==n||n===!1?n:n.name),a),(s||0===s)&&(r+=s),r+="\n            "}function h(e,t){var n,s,a="";return a+="\n                    ",s={hash:{},data:t},a+=I((n=i.I18n,n?n.call(e,"delete_share_project",s):T.call(e,"I18n","delete_share_project",s)))+"\n                "}function p(e,t){var n,s,a="";return a+="\n                    ",s={hash:{},data:t},a+=I((n=i.I18n,n?n.call(e,"delete_project_intro",s):T.call(e,"I18n","delete_project_intro",s)))+"\n                "}function m(e,t){var n,s,a="";return a+="\n                ",s={hash:{},data:t},a+=I((n=i.I18n_Plus,n?n.call(e,"share_exit_confirm_message",(n=e.model,null==n||n===!1?n:n.name),s):T.call(e,"I18n_Plus","share_exit_confirm_message",(n=e.model,null==n||n===!1?n:n.name),s)))+"\n            "}function f(e,t){var n,s,a="";return a+="\n            ",s={hash:{},data:t},a+=I((n=i.I18n,n?n.call(e,"delete",s):T.call(e,"I18n","delete",s)))+"\n        "}function g(e,t){var n,s="";return s+="\n            ",n=i["if"].call(e,e.isGroup,{hash:{},inverse:C.program(23,y,t),fn:C.program(21,v,t),data:t}),(n||0===n)&&(s+=n),s+="\n        "}function v(e,t){var n,s,a="";return a+="\n                ",s={hash:{},data:t},a+=I((n=i.I18n,n?n.call(e,"delete",s):T.call(e,"I18n","delete",s)))+"\n            "}function y(e,t){var n,s,a="";return a+="\n                ",s={hash:{},data:t},a+=I((n=i.I18n,n?n.call(e,"exit",s):T.call(e,"I18n","exit",s)))+"\n            "}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var k,w,b,_="",T=i.helperMissing,I=this.escapeExpression,C=this;return _+='<div class="popup-header">\n    <a class="popup-close">&times;</a>\n    <h1 class="popup-title text-lrg text-primary">\n      ',k=i["if"].call(t,t.isGroup,{hash:{},inverse:C.program(3,r,s),fn:C.program(1,a,s),data:s}),(k||0===k)&&(_+=k),_+='\n    </h1>\n</div>\n\n<div class="popup-body">\n    <span class="line-sml">\n        ',k=i["if"].call(t,t.isGroup,{hash:{},inverse:C.program(10,d,s),fn:C.program(8,c,s),data:s}),(k||0===k)&&(_+=k),_+='\n    </span>\n</div>\n\n<div class="popup-footer">\n    <button type="button" class="cancel btn-med btn-cancel">',b={hash:{},data:s},_+=I((k=i.I18n,k?k.call(t,"cancel",b):T.call(t,"I18n","cancel",b)))+'</button>\n    <button type="button" class="confirm btn-med btn-primary">\n        ',w=i["if"].call(t,(k=t.model,null==k||k===!1?k:k.isOwner),{hash:{},inverse:C.program(20,g,s),fn:C.program(18,f,s),data:s}),(w||0===w)&&(_+=w),_+="\n    </button>\n</div>\n"})}),define("view/project/delete",["require","exports","module","utils/analytics","modules/popup/popup","hbs!template/project_confirm_delete"],function(e,t){var i=(e("utils/analytics"),e("modules/popup/popup").View);t.View=Backbone.View.extend({className:"modal",template:e("hbs!template/project_confirm_delete"),events:{"keypress .confirm":"deleteProject","click .confirm":"deleteProject","click .cancel, .popup-close":"closeView"},initialize:function(){this.render()},deleteProject:function(){this.model.destroy(),this.closeView(),Backbone.trigger("toggleClosedProject")},closeView:function(){this.popupView.onRemove()},isGroup:function(){return this.model.get("isGroup")},isOwnerShare:function(){var e=this.model.get("userCount"),t=this.model.get("isOwner");return e>1&&t},render:function(){this.$el.html(this.template({model:this.model.toJSON(),isOwnerShare:this.isOwnerShare(),isGroup:this.isGroup()})),this.popupView=new i({view:this})}})}),define("hbs!template/project_edit_modal_detail",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o,l="",c="function",d=this.escapeExpression,u=i.helperMissing;return l+='<div class="popup-header">\n    <a class="popup-close">&times;</a>\n    <h1 class="popup-title text-lrg text-primary">',(a=i.title)?a=a.call(t,{hash:{},data:s}):(a=t.title,a=typeof a===c?a.apply(t):a),l+=d(a)+'</h1>\n</div>\n<div class="popup-body">\n    <div class="project-detail-panel">\n\n        <div class="row">\n          <input class="project-name input-lrg"  type="text" placeholder=\'',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"name",o):u.call(t,"I18n","name",o)))+"' value=\""+d((a=t.model,a=null==a||a===!1?a:a.name,typeof a===c?a.apply(t):a))+'"/>\n          <p class="help-inline warn text-alert text-sml"></p>\n        </div>\n\n        <div class="row">\n          <div class="project-color"></div>\n        </div>\n\n        <div class="bd-divider divider"> </div>\n\n        <div class="row">\n            <div class="showinall-label">\n                <p class="text-secondary line-sml"> \n                    ',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"show_in_all",o):u.call(t,"I18n","show_in_all",o)))+'\n                </p>\n                <p class="text-info text-sml line-sml">\n                    ',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"help_show_in_all",o):u.call(t,"I18n","help_show_in_all",o)))+'\n                </p>\n            </div>\n            <div class="showinall-checkbox">\n                <div class="switch small round">\n                        <input id="showinall" type="checkbox" ',(r=i.checked)?r=r.call(t,{hash:{},data:s}):(r=t.checked,r=typeof r===c?r.apply(t):r),l+=d(r)+" ",(r=i.disabled)?r=r.call(t,{hash:{},data:s}):(r=t.disabled,r=typeof r===c?r.apply(t):r),l+=d(r)+'>    \n                        <label for="showinall"></label>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>\n<div class="popup-footer project-edit-footer">\n    <div class="btns">\n        <button type="button" class="project-cancel-btn btn-med btn-cancel">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"cancel",o):u.call(t,"I18n","cancel",o)))+'</button>\n        <button type="button" class="project-save-btn btn-med btn-primary btn-initial">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"save",o):u.call(t,"I18n","save",o)))+'</button>\n        <button type="button" class="btn-med disabled btn-loading">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"saving",o):u.call(t,"I18n","saving",o)))+"</button>\n    </div>\n</div>\n"})}),define("view/project/edit",["require","exports","module","configs/settings","utils/index","configs/regexp","lang/index","dao/projectdb","model/project","utils/server","utils/analytics","configs/keycode","modules/popup/popup","utils/dom","dao/project-group","hbs!template/project_edit_modal_detail"],function(e,t){var i=e("configs/settings"),n=e("utils/index"),s=e("configs/regexp"),a=e("lang/index"),r=e("dao/projectdb").db,o=e("model/project").Model,l=(e("utils/server"),e("utils/analytics")),c=e("configs/keycode"),d=e("modules/popup/popup").View,u=e("utils/dom"),h=e("dao/project-group").db;t.View=Backbone.View.extend({id:"project-modal-detail-view",template:e("hbs!template/project_edit_modal_detail"),events:{"focus .project-name":"hideWarn","keypress .project-name":"saveProjectOnEnter","click .jColorSelect .color":"renderCheckColor","click .project-save-btn":"saveProject","click .project-cancel-btn":"closeModal"
},initialize:function(e){this.initDate(e),this.render(),this.renderColorPicker(),this.initDomAttr(),this.afterInit()},afterInit:function(){var e=this.model?this.model.get("name").length:0;u.setInputCaretPosition(this.$projectName[0],e),this.renderCheckColor();var t=!0;this.hideWarn(null,t)},initDate:function(e){_.extend(this,e),this.color=this.model?this.model.get("color"):""},initDomAttr:function(){this.$showInAll=this.$("#showinall"),this.$projectName=this.$(".project-name"),this.$warn=this.$(".warn"),this.$colorSelect=this.$(".jColorSelect"),this.$colors=this.$(".color")},renderCheckColor:function(){this.cleanAllColorCheck();var e=this.$colorSelect.find(".jColorCheck.checkblk");e.addClass("checked")},cleanAllColorCheck:function(){this.$colors.removeClass("checked")},renderColorPicker:function(){var e=this;this.$(".project-color").colorPicker({defaultColor:n.getDefaultColorIndex(this.color),columns:10,color:i.colors,click:function(t){e.color=t},noColorIcon:'<i class="icon_home icon-color-picker-transparent"></i>'})},checkProjectName:function(){var e=this.$projectName.val().trim(),t=/^[#|＃]/i;return e?t.test(e)?(this.toggleInputProjectNameWarn(a.get("invalid_project_name")),!1):e.match(s.projectNameFilter)?(this.toggleInputProjectNameWarn(a.get("warn_project_name")),!1):r.isDuplicate(this.model,e)?(this.toggleInputProjectNameWarn(a.get("duplicate_project_name")),!1):(this.toggleInputProjectNameWarn(),!0):void this.toggleInputProjectNameWarn(a.get("empty_project_name"))},toggleInputProjectNameWarn:function(e){e?this.$warn.text(e).slideDown():this.$warn.slideUp()},hideWarn:function(e,t){t?this.$warn.hide():this.$warn.slideUp()},saveProjectOnEnter:function(e){e=e||window.event,e.keyCode===c.enter&&this.saveProject()},saveProject:function(){if(!this.isSaving()&&this.checkProjectName()){var e=this.getDomAttr();this.toggleSavingBtn(),null==this.model?this.createProject(e):(this.model.set(e),this.model.isDirty&&this.model.save(),this.afterSave(this.model))}},isSaving:function(){return this.$(".btns").hasClass("ing")},toggleSavingBtn:function(){this.$(".btns").toggleClass("ing")},getDomAttr:function(){var e="checked"==this.$showInAll.attr("checked")?!1:!0,t=this.$projectName.val().replace(s.projectNameFilter,""),i=this.color;return{name:t,color:i,inAll:e}},createProject:function(e){var t=new o,n=Math.min(r.getMinSortOrder(),h.getMinSortOrder());_.extend(e,{sortOrder:n-i.orderStep,isOwner:!0}),t.set(e),t.local=!0;var s=this;r.collection.create(t,{wait:!0,success:function(){s.afterSave(t)}}),l.l_list("add")},afterSave:function(e){this.toggleSavingBtn(),Backbone.trigger("navigateProject","p/"+e.get("id")+"/tasks",!0),r.collection.trigger("initProjectDropable"),e.local=!1,this.closeModal()},closeModal:function(){this.popupView.onRemove()},render:function(){var e=this.getRenderData();this.$el.html(this.template(e)),this.popupView=new d({view:this})},getRenderData:function(){var e={};if(null==this.model)_.extend(e,{title:a.get("create_project")});else{var t="",i="";this.model.get("inAll")||(t="checked"),this.model.get("closed")&&(i="disabled"),_.extend(e,{title:a.get("edit_project"),model:this.model.toJSON(),checked:t,disabled:i})}return e}})}),define("hbs!template/project_confirm_close",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o,l="",c=i.helperMissing,d=this.escapeExpression;return l+='<div class="popup-header">\n    <a class="popup-close">&times;</a>\n    <h1 class="popup-title text-lrg text-primary">\n      ',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"close_project",o):c.call(t,"I18n","close_project",o)))+'\n    </h1>\n</div>\n\n<div class="popup-body">\n      <span class="line-sml">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"close_project_intro_list",o):c.call(t,"I18n","close_project_intro_list",o)))+'</span>\n      <br>\n      <span class="line-sml">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"close_project_intro_list1",o):c.call(t,"I18n","close_project_intro_list1",o)))+'</span>\n      <br>\n      <span class="line-sml">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"close_project_intro_list2",o):c.call(t,"I18n","close_project_intro_list2",o)))+'</span>\n      <p class="conform-close line-sml">',o={hash:{},data:s},a=i.I18n_Plus,r=a?a.call(t,"confirm_close_project",(a=t.model,null==a||a===!1?a:a.name),o):c.call(t,"I18n_Plus","confirm_close_project",(a=t.model,null==a||a===!1?a:a.name),o),(r||0===r)&&(l+=r),l+='</p>\n</div>\n\n<div class="popup-footer">\n    <button type="button" class="cancel btn-med btn-cancel">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"cancel",o):c.call(t,"I18n","cancel",o)))+'</button>\n    <button type="button" class="confirm btn-med btn-primary">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"close",o):c.call(t,"I18n","close",o)))+"</button>\n</div>\n"})}),define("view/project/close",["require","exports","module","modules/popup/popup","hbs!template/project_confirm_close"],function(e,t){var i=e("modules/popup/popup").View;t.View=Backbone.View.extend({className:"modal",template:e("hbs!template/project_confirm_close"),events:{"keypress .confirm":"closeProject","click .confirm":"closeProject","click .cancel, .popup-close":"closeView"},initialize:function(){this.render()},closeProject:function(){this.model.set({closed:!0}),this.model.save(),this.closeView(),Backbone.trigger("navigateToAllList")},closeView:function(){this.popupView.onRemove()},render:function(){this.$el.html(this.template({model:this.model.toJSON()})),this.popupView=new i({view:this})}})}),define("hbs!template/project_sub_menu",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){var n,s,a,l="";return l+='\n  <ul class="dropdown-menu">\n    <li><a class="closeProject">',a={hash:{},data:t},l+=h((n=i.I18n,n?n.call(e,"open",a):u.call(e,"I18n","open",a)))+'</a></li>\n    <li class="divide"></li>\n    <li><a class="edit">',a={hash:{},data:t},l+=h((n=i.I18n,n?n.call(e,"edit",a):u.call(e,"I18n","edit",a)))+'</a></li>\n    <li><a class="delete">',s=i["if"].call(e,e.isOwner,{hash:{},inverse:p.program(4,o,t),fn:p.program(2,r,t),data:t}),(s||0===s)&&(l+=s),l+="</a></li>\n  </ul>\n"}function r(e,t){var n,s;return s={hash:{},data:t},h((n=i.I18n,n?n.call(e,"delete",s):u.call(e,"I18n","delete",s)))}function o(e,t){var n,s;return s={hash:{},data:t},h((n=i.I18n,n?n.call(e,"exit",s):u.call(e,"I18n","exit",s)))}function l(e,t){var n,s,a,l="";return l+='\n  <ul class="dropdown-menu">\n   <li><a class="edit">',a={hash:{},data:t},l+=h((n=i.I18n,n?n.call(e,"edit",a):u.call(e,"I18n","edit",a)))+'</a></li>\n      \n      <li><a class="closeProject">',a={hash:{},data:t},l+=h((n=i.I18n,n?n.call(e,"close",a):u.call(e,"I18n","close",a)))+'</a></li>\n      <li><a class="delete">',s=i["if"].call(e,e.isOwner,{hash:{},inverse:p.program(4,o,t),fn:p.program(2,r,t),data:t}),(s||0===s)&&(l+=s),l+="</a></li>\n  </ul>\n"}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var c,d="",u=i.helperMissing,h=this.escapeExpression,p=this;return c=i["if"].call(t,t.closedProject,{hash:{},inverse:p.program(6,l,s),fn:p.program(1,a,s),data:s}),(c||0===c)&&(d+=c),d+="\n\n"})}),define("view/project/menu",["require","exports","module","view/project/activity/list","utils/analytics","view/project/delete","view/project/edit","view/project/close","utils/dom","hbs!template/project_sub_menu"],function(e,t){var i=e("view/project/activity/list").View,n=e("utils/analytics"),s=e("view/project/delete").View,a=e("view/project/edit").View,r=e("view/project/close").View,o=e("utils/dom");t.View=Backbone.View.extend({id:"project-dropdown-menu",className:"l-dropdown boult list-menu",template:e("hbs!template/project_sub_menu"),events:{"click .dropdown-menu a":"onClose","click a.edit":"edit","click a.delete":"confirmDeleteProject","click a.closeProject":"confirmCloseProject","click a.activity":"showActivity"},initialize:function(e){_.extend(this,e),this.initDropdownToggle(),this.addAttr(),this.render()},addAttr:function(){this.$el.attr("projectId",this.model.get("id"))},showActivity:function(){new i({model:this.model}),n.l_list("activity")},edit:function(){new a({model:this.model}),n.l_list("edit")},confirmDeleteProject:function(){new s({model:this.model})},confirmCloseProject:function(){var e=this.model.get("closed");e?(this.model.set({closed:!1}),this.model.save(),Backbone.trigger("navigateProject","p/"+this.model.get("id")+"/tasks",!0),this.onClose()):new r({model:this.model}),n.l_list("close")},initDropdownToggle:function(){var e=this;$("html").on("click.project-menu",function(){e.onClose(),$("html").off("click.project-menu")}),$(".project-list-inner .antiscroll-inner").on("scroll.project-menu",function(){e.onClose(),$(".project-list-inner .antiscroll-inner").off("scroll.project-menu")})},hideDropdownMenu:function(){$(".dropdown.open").removeClass("open"),this.$el.addClass("hide")},render:function(){var e=this;this.$el.hasClass("hide")&&this.$el.removeClass("hide"),this.$el.html(this.template({isOwner:e.model.get("isOwner"),closedProject:e.model.get("closed")}));var t=$(".list-menu"),i=t.attr("projectId");t.length>0&&t.remove(),i!==this.model.get("id")?($("body").append($(this.el)),o.setProjectMenuTop(this.$sel,$("#project-dropdown-menu"))):this.hideDropdownMenu()},onClose:function(){this.hideDropdownMenu(),this.remove()}})}),define("view/project/list/project",["require","exports","module","view/project/menu","view/project/list/base","service/task","utils/analytics","utils/dom","utils/hash"],function(e,t){{var i=e("view/project/menu").View,n=e("view/project/list/base").View,s=e("service/task"),a=e("utils/analytics"),r=e("utils/dom");e("utils/hash")}t.View=n.extend({className:"project",events:{"click .dropdown":"stopPropagationInMenuView","click .dropdown-toggle":"subMenuDropdown","click .project-link":"doClick"},messages:function(){this.listenTo(this.model,"change:name",this.changeName),this.listenTo(this.model,"change:color",this.renderColor),this.listenTo(this.model,"destroy",this.removeProject),this.listenTo(this.model,"change:closed",this.toggleCloseProject),this.listenTo(this.model,"change:sortOrder",this.resetSortOrder),this.listenTo(this.model,"change:groupId",this.changedGroupId),this.listenTo(this.model,"change:userCount",this.changeUserCount)},initialize:function(e){this.$el.attr("order",this.model.get("sortOrder")),this.parentView=e.parentView,this.render(),this.dropElement=this.$el,this.messages(),this.initDroppable(),this.events=_.extend({},n.prototype.events,this.events),this.constructor.__super__.initialize.apply(this,[e])},removeProject:function(){s.clearTasksByProjectId(this.model.get("id")),this.toggleCloseProject(),this.remove(),a.l_list("delete")},toggleDroppable:function(){var e=this;setTimeout(function(){e.dropElement.droppable("option","accept",e._getAcceptElement())},200)},_taskDrop:function(e){var t=this.model.get("id");e?Backbone.trigger("moveSelectedToProjectByDrag",e,t):Backbone.trigger("moveSelectedToProject",t)},toggleCloseProject:function(){Backbone.trigger("toggleClosedProject",this),Backbone.trigger("projectsChange"),this.initDroppable()},render:function(){var e=this.model.toJSON();return e.id2=e.id,this.$el.html(this.template(e)),this.renderColor(),this},stopPropagationInMenuView:function(e){e=e||window.event,e.stopPropagation()},subMenuDropdown:function(e){e=e||window.event,e.preventDefault();var t=e.currentTarget;new i({model:this.model,$sel:$(t)})},resetSortOrder:function(){this.$el.attr("order",this.model.get("sortOrder")),this.model.hasChanged("etag")&&Backbone.trigger("moveProjectGroup",this)},initDroppable:function(){var e=this.model.get("closed")?"none":this._getAcceptElement();this._initDroppable(this.dropElement,e)},_drop:function(e,t){var i=this.$el;return this.isOver?void(t.draggable.hasClass("project")&&i&&Backbone.trigger("createGroupByDrag",t.draggable,i)):!1},_activateUI:function(e,t){},_overUI:function(e,t){if(t.draggable.hasClass("project")){var i=this;i.isOver=!1,setTimeout(function(){i.isOver=!0},100)}},_outUI:function(e,t){},_dropUI:function(e,t){},_getAcceptElement:function(){var e=".task, .sub-task";return this.model.get("groupId")&&"NONE"!=this.model.get("groupId")||(e=".task, .sub-task, .project"),e},changedGroupId:function(){var e=this;setTimeout(function(){Backbone.trigger("moveProjectGroup",e),Backbone.trigger("projectsChange"),e.toggleDroppable()},100)},changeName:function(){this.$(".project-title").html(this.model.get("name"))},changeUserCount:function(){this.model.get("userCount")<2?this.$(".l-item").removeClass("shared"):this.$(".l-item").addClass("shared")},renderColor:function(){r.setProjectColor(this.$el.find("a"),"4px",this.model.get("color")),Backbone.trigger("renderProjectColor")},doClick:function(e){this.doFocus(e),this.analyticsByclick(),$(".TickTick-typeahead,[display=block]").css({display:"none"})},doFocus:function(e){e=e||window.event,$(e.currentTarget).focus()},analyticsByclick:function(){a.l_view("list")},onClose:function(){}})}),define("hbs!template/project_group_option_menu",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o="",l=i.helperMissing,c=this.escapeExpression;return o+='<ul class="dropdown-menu">\n  <li><a class="edit">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"edit",r):l.call(t,"I18n","edit",r)))+'</a></li>\n  <li><a class="delete">',r={hash:{},data:s},o+=c((a=i.I18n,a?a.call(t,"delete",r):l.call(t,"I18n","delete",r)))+"</a></li>\n</ul>"})}),define("view/project/group-menu",["require","exports","module","utils/condition","configs/settings","dao/projectdb","utils/analytics","view/project/delete","utils/dom","hbs!template/project_group_option_menu"],function(e,t){var i=(e("utils/condition"),e("configs/settings"),e("dao/projectdb").db),n=e("utils/analytics"),s=e("view/project/delete").View,a=e("utils/dom");t.View=Backbone.View.extend({id:"project-group-option-menu",className:"l-dropdown boult list-menu",template:e("hbs!template/project_group_option_menu"),events:{"click a.edit":"edit","click a.delete":"deleteProjectGroup"},initialize:function(e){_.extend(this,e),this.initDropdownToggle(),this.initAttr(),this.render()},initAttr:function(){this.$el.attr("groupId",this.model.get("id"))},edit:function(){this.model.trigger("editTitle"),n.l_folder("edit")},deleteProjectGroup:function(){var e=i.getProjectsByGroupId(this.model.get("id"));e&&e.length>0?(this.model.set("isGroup",!0),new s({model:this.model})):this.model.destroy()},initDropdownToggle:function(){var e=this;$("html").on("click.group-menu",function(){e.onClose(),$("html").off("click.group-menu")}),$(".project-list-inner .antiscroll-inner").on("scroll.group-menu",function(){e.onClose(),$(".project-list-inner .antiscroll-inner").off("scroll.group-menu")})},hideDropdownMenu:function(){$(".dropdown.open").removeClass("open"),this.$el.addClass("hide")},render:function(){this.$el.hasClass("hide")&&this.$el.removeClass("hide"),this.$el.html(this.template());var e=$(".list-menu"),t=e.attr("groupId");e.length>0&&e.remove(),t!==this.model.get("id")?($("body").append(this.$el),a.setProjectMenuTop(this.$sel,$("#project-group-option-menu"))):this.hideDropdownMenu()},onClose:function(){this.hideDropdownMenu(),this.remove()}})}),define("hbs!template/group_list",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o,l="",c=i.helperMissing,d="function",u=this.escapeExpression;return l+='\n\n<div class="f-container">\n  <div class="f-header group-header">\n    <a class="l-item group-header-box project-group-toggle">\n        <span class="icons toggle">\n            ',o={hash:{},data:s},a=i.svgIcon,r=a?a.call(t,"icon-folder","i-1 normal-icon",o):c.call(t,"svgIcon","icon-folder","i-1 normal-icon",o),(r||0===r)&&(l+=r),l+="\n            ",o={hash:{},data:s},a=i.svgIcon,r=a?a.call(t,"icon-folder-open","i-1 open-icon",o):c.call(t,"svgIcon","icon-folder-open","i-1 open-icon",o),(r||0===r)&&(l+=r),l+='\n        </span><input type="text" class="input-sml title-edit hide" value="" maxlength="30"><span class=\'l-title group-title project-title\'>'+u((a=t.model,a=null==a||a===!1?a:a.name,typeof a===d?a.apply(t):a))+'</span>\n      <span class="dropdown p-caret">\n        <span class="dropdown-toggle" data-toggle="dropdown">\n          ',o={hash:{},data:s},a=i.svgIcon,r=a?a.call(t,"icon-more","i-1",o):c.call(t,"svgIcon","icon-more","i-1",o),(r||0===r)&&(l+=r),l+='\n        </span>\n      </span>\n      <span class="count">\n        <b class="direct"></b>\n      </span>\n    </a>\n    \n  </div>\n  <ul class="group-project-ul inner-ul">\n    <div class="group-all-task fake-li">\n      <a class="l-item project-link group-project-all" href="#g/'+u((a=t.model,a=null==a||a===!1?a:a.id,typeof a===d?a.apply(t):a))+'/tasks" groupId="'+u((a=t.model,a=null==a||a===!1?a:a.id,typeof a===d?a.apply(t):a))+'">\n        ',o={hash:{},data:s},a=i.svgIcon,r=a?a.call(t,"icon-folder-all-list","i-1 normar-icon active-icon",o):c.call(t,"svgIcon","icon-folder-all-list","i-1 normar-icon active-icon",o),(r||0===r)&&(l+=r),l+='<span class="l-title project-title">',o={hash:{},data:s},l+=u((a=i.I18n,a?a.call(t,"all_tasks",o):c.call(t,"I18n","all_tasks",o)))+'</span>\n      <span class="count"></span></a>\n    </div>\n  </ul>\n\n\n</div>\n'})}),define("view/project/list/group",["require","exports","module","configs/keycode","view/project/list/base","view/project/group-menu","configs/settings","dao/projectdb","utils/browser","utils/analytics","configs/dict","configs/status","hbs!template/group_list"],function(e,t){var i=e("configs/keycode"),n=e("view/project/list/base").View,s=e("view/project/group-menu").View,a=e("configs/settings"),r=e("dao/projectdb").db,o=e("utils/browser"),l=e("utils/analytics"),c=e("configs/dict"),d=e("configs/status");t.View=n.extend({className:"l-folder",template:e("hbs!template/group_list"),events:{"click .title-edit":"stopEvent","mousedown .title-edit":"stopEvent","click .project-group-toggle":"slideToggle","blur .title-edit":"saveTitle","keydown .title-edit":"saveTitleByKey","click .dropdown-toggle":"groupOptionDropdown"},messages:function(){this.listenTo(this.model,"destroy",this.removeGroup),this.listenTo(this.model,"editTitle",this.editTitle),this.listenTo(Backbone,"projectsChange",this.projectsChange),this.listenTo(Backbone,"updateProjectGroupTasksCount",this.updateProjectGroupTasksCount),this.listenTo(this.model,"slideGroupUp",this.slideGroupUp),this.listenTo(this.model,"slideToggle",this.slideToggle)},initialize:function(e){this.parentView=e.parentView,this.render(),this.initGroupStatus(),this.messages(),this.initDroppable(),this.constructor.__super__.initialize.apply(this,[e]),this.initBlur()},initBlur:function(){var e=this;$("body").on("mousedown",".project-link, .dropdown-toggle, .project-group-toggle",function(t){o.isSafari&&t.currentTarget.className.match("project-group-toggle")||e.$(".title-edit").blur()})},removeGroup:function(){for(var e=r.getProjectsByGroupId(this.model.get("id")),t=0;t<e.length;t++)e[t].changeGroupId("NONE");var i=this;setTimeout(function(){i.remove()},200),l.l_folder("delete")},projectsChange:function(){var e=this;setTimeout(function(){var t=e.$el.find(".group-project-ul li"),i=t.length;i>1?(e.allTaskView.show().removeClass("hide"),t.eq(i-1).after(e.allTaskView)):e.allTaskView.slideUp("fast",function(){e.allTaskView.addClass("hide")})},100)},render:function(){var e=this.template({model:this.model.toJSON()});return this.$el.html(e),this.$el.attr({order:this.model.get("sortOrder"),groupid:this.model.get("id")}),this.model.get("open")&&this.$el.addClass("open"),this.allTaskView=this.$el.find(".group-all-task"),this.allTaskView.hide().addClass("hide"),this.editTitleInLocalGroup(),this},slideGroupUp:function(){this.$el.removeClass("open"),this.$("ul").stop().slideUp("fast",function(){}),this.model.set("open",!1)},slideToggle:function(){if(this.model.get("open")){var e=this;this.$("ul").stop().slideToggle("fast",function(){e.$el.removeClass("open")})}else this.$el.addClass("open"),this.$("ul").stop().slideToggle("fast",function(){});this.toggleOpen()},initGroupStatus:function(){var e=this.model.get("open");e?this.$("ul").show():this.$("ul").hide()},toggleOpen:function(){this.model.set("open",!this.model.get("open"))},stopEvent:function(e){var e=e||window.event;e.stopPropagation()},editTitleInLocalGroup:function(){if(this.model.local){var e=this;setTimeout(function(){e.editTitle()})}},editTitle:function(){var e=this.$el.find(".group-title"),t=this.$el.find(".title-edit");e.addClass("hide"),t.val(this.model.get("name")).removeClass("hide").focus().select()},saveTitleByKey:function(e){var e=e||window.event;e.keyCode==i.enter&&$(e.target).blur()},saveTitle:function(e){var e=e||window.event,t=$(e.target).val();$.trim(t)?this.model.get("name")!==t&&(this.model.set("name",t),this.model.save(),Backbone.trigger("storeGroupInfoToLocal")):t=this.model.get("name"),$(e.target).addClass("hide"),this.$(".group-title").text(t).removeClass("hide")},groupOptionDropdown:function(e){var e=e||window.event;e.preventDefault(),e.stopPropagation();{var t=e.currentTarget;new s({model:this.model,$sel:$(t)})}},initDroppable:function(){this.$elDrop=this.$el.find(".group-header"),this._initDroppable(this.$elDrop,".project")},_drop:function(e,t){Backbone.trigger("changeGroupByDrag",t.draggable,this),d.drop_folder=!0},_activateUI:function(e,t){},_overUI:function(e,t){this.$elDrop.removeClass(c.hoverClass.project),this.$(".f-container").addClass(c.hoverClass.group)},_outUI:function(e,t){this.$(".f-container").removeClass(c.hoverClass.group)},_dropUI:function(e,t){this.$(".f-container").removeClass(c.hoverClass.group)},getFirstOrderInGroup:function(){var e=$("#project-ul li"),t=a.orderStep,i=e.index(this.$el),n=this.model.get("sortOrder"),s=e.eq(i+1);if(s){var r=parseInt(s.attr("order"));return(n+r)/2}return n+t},updateProjectGroupTasksCount:function(){var e=this.$("li .count"),t=0;_.each(e,function(e){t+=Number($(e).text())}),t=t?t:"",this.$(".group-all-task .count").text(t)}})}),define("view/project/list/completed",["require","exports","module","view/project/list/base","service/userProfile"],function(e,t){var i=e("view/project/list/base").View,n=e("service/userProfile");t.View=i.extend({className:"project smart-project",events:{},messages:function(){},initialize:function(e){this.render(),this.events=_.extend({},i.prototype.events,this.events),this.constructor.__super__.initialize.apply(this,[e])},_getTaskProperties:function(){return{projectId:n.get("inboxId"),status:2}},_taskDrop:function(e){_.delay(function(){e?Backbone.trigger("toggleCompleteByDrag",e):Backbone.trigger("toggleCompleteMultiByDrag")},600)},render:function(){this.baseRender(),this.initDroppable()},initDroppable:function(){this._initDroppable(this.$el,".task, .sub-task")}})}),define("view/project/list/trash",["require","exports","module","utils/hash","view/project/list/base"],function(e,t){var i=e("utils/hash"),n=e("view/project/list/base").View;t.View=n.extend({className:"project smart-project",events:{},messages:function(){},initialize:function(e){this.render(),this.events=_.extend({},n.prototype.events,this.events),this.constructor.__super__.initialize.apply(this,[e])},_taskDrop:function(e){i.isInTrash()||(e?Backbone.trigger("deleteTaskByDrag",e):Backbone.trigger("deleteTaskByShortcut"))},render:function(){this.baseRender(),this.initDroppable()},initDroppable:function(){this._initDroppable(this.$el,".task, .sub-task")}})}),define("view/project/list/assignedme",["require","exports","module","view/project/list/base"],function(e,t){var i=e("view/project/list/base").View;t.View=i.extend({className:"project smart-project assigned-me",messages:function(){},initialize:function(e){this.messages(),this.render(),this.events=_.extend({},i.prototype.events,this.events),this.constructor.__super__.initialize.apply(this,[e])},render:function(){this.baseRender()}})}),define("hbs!template/project_item_close",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o,l="",c=i.helperMissing,d=this.escapeExpression;return l+="\n\n",o={hash:{},data:s},a=i.svgIcon,r=a?a.call(t,"icon-closed-list","i-1 normal-icon",o):c.call(t,"svgIcon","icon-closed-list","i-1 normal-icon",o),(r||0===r)&&(l+=r),l+='<span class="text-sml l-close-title" id="show-closed">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"closed_project_list",o):c.call(t,"I18n","closed_project_list",o)))+'</span>\n<span class="count badge"></span>\n'})}),define("view/project/list/close",["require","exports","module","lang/index","hbs!template/project_item_close"],function(e,t){e("lang/index");t.View=Backbone.View.extend({id:"l-closed-toggle",tagName:"a",template:e("hbs!template/project_item_close"),events:{click:"slideToggleClosed"},initialize:function(e){this.render(),this.initDomAttr()},initDomAttr:function(){this.$count=this.$(".count")},render:function(){this.$el.html(this.template()),$(".list-closed").prepend(this.$el),$("#close-project-ul").hide()},slideToggleClosed:function(e){e=e||window.event;var t=$(e.currentTarget);t.toggleClass("open");var i=this;$("#close-project-ul").slideToggle(120,function(){i.$count.text($("#close-project-ul").find("li.project").length)})}})}),define("hbs!template/calendar_item",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o,l="",c="function",d=this.escapeExpression,u=i.helperMissing;return l+='\n\n  <a href="#q/',(a=i.id)?a=a.call(t,{hash:{},data:s}):(a=t.id,a=typeof a===c?a.apply(t):a),l+=d(a)+'/subscribe-calendar" projectId="',(a=i.id)?a=a.call(t,{hash:{},data:s}):(a=t.id,a=typeof a===c?a.apply(t):a),l+=d(a)+'" id="project_',(a=i.id)?a=a.call(t,{hash:{},data:s}):(a=t.id,a=typeof a===c?a.apply(t):a),l+=d(a)+'" class="project-box">\n      ',o={hash:{},data:s},a=i.svgIcon,r=a?a.call(t,"icon-subcalendar-list","i-1",o):u.call(t,"svgIcon","icon-subcalendar-list","i-1",o),(r||0===r)&&(l+=r),l+='<span class="l-title">',(r=i.name)?r=r.call(t,{hash:{},data:s}):(r=t.name,r=typeof r===c?r.apply(t):r),l+=d(r)+'</span>\n      <span class="count"></span>\n  </a>\n'})}),define("view/project/list/subscribe",["require","exports","module","view/project/list/base","utils/analytics","utils/server","dao/projectdb","hbs!template/calendar_item"],function(e,t){{var i=e("view/project/list/base").View,n=e("utils/analytics");e("utils/server"),e("dao/projectdb")}t.View=i.extend({className:"calendar-item",template:e("hbs!template/calendar_item"),events:{"click a.project-box":"navigateByClick"},message:function(){this.listenTo(Backbone,"renderCalenderProjectName",this.renderCalenderProjectName)},initialize:function(e){this.message(),this.render(),this.events=_.extend({},i.prototype.events,this.events),this.constructor.__super__.initialize.apply(this,[e])},render:function(){this.$el.html(this.template({name:this.model.get("name"),id:this.model.get("id")}))},renderCalenderProjectName:function(e,t){this.model.get("id")===e&&(this.model.set("name",t),this.$("#project_"+e+" .l-title").html(t))},routerNavigate:function(e){e=e||window.event,e.preventDefault();var t=this.$(".project-box").attr("href").replace("#","");Backbone.history.fragment===t?Backbone.history.loadUrl(Backbone.history.fragment):Backbone.trigger("navigateUrl",t,{trigger:!0})},navigateByClick:function(e){this.routerNavigate(e),n.l_view("subscribe")}})}),define("hbs!template/create_project_btn",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r,o,l="",c=i.helperMissing,d=this.escapeExpression;return l+="\n\n",o={hash:{},data:s},a=i.svgIcon,r=a?a.call(t,"icon-add-new-list","i-1",o):c.call(t,"svgIcon","icon-add-new-list","i-1",o),(r||0===r)&&(l+=r),l+='<span class="l-title">',o={hash:{},data:s},l+=d((a=i.I18n,a?a.call(t,"new_project",o):c.call(t,"I18n","new_project",o)))+"</span>\n"})}),define("view/project/create/index",["require","exports","module","view/project/edit","configs/limit","service/project","view/modal/get-upgrade","hbs!template/create_project_btn"],function(e,t){var i=e("view/project/edit").View,n=e("configs/limit"),s=e("service/project"),a=e("view/modal/get-upgrade").View;t.View=Backbone.View.extend({className:"pointer",id:"project-new-button",tagName:"a",events:{click:"showCreateProjectDialogue"},template:e("hbs!template/create_project_btn"),initialize:function(){this.render()},render:function(){this.$el.html(this.template()),$(".l-new").append(this.$el)},showCreateProjectDialogue:function(){s.getProjectsCount()<n.projectNumber?new i:new a({type:"list"})}})}),define("hbs!template/logout_from_extension",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var a,r="",o="function";return r+='<div id="logout-from-extension">\n  <div class="username">',(a=i.username)?a=a.call(t,{hash:{},data:s}):(a=t.username,a=typeof a===o?a.apply(t):a),(a||0===a)&&(r+=a),r+='</div>\n  <a href="#">\n    <i class="icon_home icon-signout"></i>\n  </a>\n</div>'})}),define("view/project/list",["require","exports","module","configs/settings","configs/status","configs/keycode","utils/condition","service/filter","configs/dict","lang/index","utils/hash","utils/dom","service/project","dao/projectdb","dao/taskdb","dao/userTagdb","dao/project-group","view/userTag/list","utils/server","view/project/list/all","view/project/list/today","view/project/list/next7days","view/project/list/inbox","view/project/list/calendar","view/project/list/project","view/project/list/group","view/project/list/completed","view/project/list/trash","view/project/list/assignedme","utils/analytics","view/project/list/close","service/plugin","view/project/list/subscribe","utils/limit-tip","offline/storage","view/project/create/index","service/userProfile","hbs!template/logout_from_extension"],function(e,t){var i=e("configs/settings"),n=e("configs/status"),s=e("configs/keycode"),a=e("utils/condition"),r=e("service/filter").filter,o=e("configs/dict"),l=e("lang/index"),c=e("utils/hash"),d=e("utils/dom"),u=(e("service/project"),e("dao/projectdb").db),h=e("dao/taskdb").db,p=e("dao/userTagdb").db,m=e("dao/project-group").db,f=e("view/userTag/list").View,g=e("utils/server"),v=e("view/project/list/all").View,y=e("view/project/list/today").View,k=e("view/project/list/next7days").View,w=e("view/project/list/inbox").View,b=e("view/project/list/calendar").View,T=e("view/project/list/project").View,I=e("view/project/list/group").View,C=e("view/project/list/completed").View,x=e("view/project/list/trash").View,S=e("view/project/list/assignedme").View,D=e("utils/analytics"),j=e("view/project/list/close").View,P=e("service/plugin"),M=e("view/project/list/subscribe").View,A=e("utils/limit-tip"),V=e("offline/storage"),O=e("view/project/create/index").View,B=e("service/userProfile"),N="l-folder";t.View=Backbone.View.extend({el:"#project-list-view",template:e("hbs!template/logout_from_extension"),projectItemViews:[],events:{"focus .dropdown":"toggleDropDown","blur .dropdown":"toggleDropDown","keyup .list-group":"navigateByKeyUp","click #logout-from-extension a":"logoutExtension","click .l-tab":"switchListTag"},messages:function(){this.listenTo(Backbone,"updateCounts",this.updateCounts),this.listenTo(Backbone,"toggleClosedProject",this.toggleClosedProject),this.listenTo(Backbone,"showSubscribe",this.showSubscribe),this.listenTo(this.collection,"add",this.addOneProject),this.listenTo(this.collection,"reset",this.refresh),this.listenTo(m.groupCollection,"reset",this.refresh),this.listenTo(m.groupCollection,"add",this.addOneGroup),this.listenTo(Backbone,"createGroupByDrag",this.createProjectGroup),this.listenTo(Backbone,"moveProjectGroup",this.moveProjectGroup),this.listenTo(Backbone,"changeGroupByDrag",this.changeGroupByDrag),this.listenTo(Backbone,"toggleSmartProject",this.toggleSmartProject);

},initialize:function(e){this.initProjectGroup(),this.showProjectView(),this.renderSmartProjectList(),this.renderCreateProjectBtn(),this.renderCloseProjectItem(),this.render(),this.renderTagList(),this.messages(),this.toggleClosedProject(),this.toggleSmartProject(),this.initListTag(),A.checkListsLimit()},initProjectGroup:function(){this.projectGroupCollection=m.groupCollection,m.fetchProjectGroups()},logoutExtension:function(e){return e.preventDefault(),Action.signout(),!1},toggleClosedProject:function(e){var t=this.$(".list-closed");e&&this.commonAddOne(e),u.hasClosedProject()?t.removeClass("hide"):t.addClass("hide"),this.showCloedCount()},showSubscribe:function(){var e=this,t=(u.smartCollection,u.getSubscribeModels());_.each(t,function(t){var i=new M({model:t});e.commonAddOne(i)}),t.length&&this.$(".calendar-list .l-divider").removeClass("hide")},showCloedCount:function(){$("#l-closed-toggle .count").text($("#close-project-ul").find("li.project").length)},toggleDropDown:function(e){e=e||window.event,$(e.currentTarget).toggleClass("open")},initScrollbar:function(){this.$(".project-list-inner").antiscroll()},render:function(){return this.addAll(),this.initScrollbar(),this.projectSortable(),Backbone.trigger("projectsChange"),this},refresh:function(){this.removeAllItemView(),this.render(),this.toggleClosedProject(),this.refreshHight(),this.refreshSortType()},refreshHight:function(){d.highlightList()},removeAllItemView:function(){_.each(this.projectItemViews,function(e){e&&e.remove()}),this.projectItemViews=[]},refreshSortType:function(){var e=this.$el.find("li.active a").attr("projectId"),t=u.getProjectById(e);if(t){var i=t.get("sortType"),s=c.getTaskIdFromPath();n.CurrentSortType!==i&&Backbone.trigger("navigateProject","p/"+e+"/tasks/"+s,!0)}},updateCounts:function(){var e=u.getCountingProjects(),t=o.smartProjectId;e=_.uniq(e.concat(u.getProjects())),_.map(e,function(e){if(e){var i=e.get("id"),n={countAll:t.all,countTodayAndOverdue:t.today,countWeek:t.week,tasksAssignedMe:t.assignedme};n=_.invert(n),n[B.get("inboxId")]="countInbox";var s=n[i]?r[n[i]]:function(e){return 0==e.get("status")&&e.get("projectId")==i},a=h.collection.filter(s),o=a.length||"";this.$("#project_"+i).find(".count").text(o)}})},toggleSmartProject:function(){var e,t,i=u.smartCollection,n=o.smartProjectStatus,s=o.smartProjectId,a={countAll:s.all,countTodayAndOverdue:s.today,countWeek:s.week,tasksAssignedMe:s.assignedme,completed:s.completed,deleted:s.trash};a=_.invert(a),i.each(function(i){if(e=i.get("status"),id=i.get("id"),t=$('[projectid="'+id+'"]').closest("li"),i.get("type")!==s.subscribe){if(e===n.hide)return void t.addClass("hide");if(e===n.auto){var o=id===s.trash?h.trash:h.collection;return void(o.some(r[a[id]])?t.removeClass("hide"):t.addClass("hide"))}t.removeClass("hide")}})},addOneProject:function(e){var t,i=this;t=new T({model:e,parentView:i}),this.projectItemViews.push(t),this.commonAddOne(t)},addOneGroup:function(e){var t=this,i=new I({model:e,parentView:t});this.projectItemViews.push(i),this.commonAddOne(i)},_findAfterItemPlace:function(e,t){var i,n=e.length;t=parseInt(t);for(var s=0;n>s;s++){var a=$(e[s]);if(parseInt(a.attr("order"))>t){i=a;break}}return i},commonAddOne:function(e){var t=this.$(".project-list #project-ul"),i=this.$(".project-list #project-ul>li"),n=this.$(".project-list #close-project-ul>li"),s=e.$el.attr("order");if(e instanceof I){var r=this._findAfterItemPlace(i,s);r?r.before(e.el):t.append(e.el)}else{var l=e.model,c=o.projectPlace[l.id];if(c)this.$("#"+c).append(e.el);else if(l.get("closed")){var r=this._findAfterItemPlace(n,s);r?r.before(e.el):this.$(".project-list #close-project-ul").append(e.el),this.$("#close-project-ul").append(e.el)}else if(a.isCalendarProject(l.get("type")))this.$("#calendar-ul").append(e.el);else if(l.get("groupId")&&"NONE"!=l.get("groupId")){var d=t.find("[groupid="+l.get("groupId")+"]").find("ul"),r=this._findAfterItemPlace(d.find("li"),s);if(r)r.before(e.el);else{var u=d.find(".group-all-task");null!=u&&0!=u.length?u.before(e.el):t.append(e.el)}}else{var r=this._findAfterItemPlace(i,s);r?r.before(e.el):t.append(e.el)}}},renderTagList:function(){P.isPluginEnable(o.pluginId.tag)&&new f({tags:p.getUserTagsModel(),parentView:this.$el})},renderCreateProjectBtn:function(){new O},renderCloseProjectItem:function(){new j},renderSmartProjectList:function(){var e=u.smartCollection,t=o.smartProjectId,i=function(t){return{model:e.get(t)}},n=u.projectInbox,s=[];s.push(new v(i(t.all))),s.push(new y(i(t.today))),s.push(new k(i(t.week))),s.push(new b(i(t.tkcalendar))),s.push(new S(i(t.assignedme))),s.push(new w({model:n})),s.push(new C(i(t.completed))),s.push(new x(i(t.trash)));var a=this;_.each(s,function(e){a.commonAddOne(e,e.model)})},addAll:function(){var e=m.getProjectGroups(!1);e.each(this.addOneGroup,this),this.collection.each(this.addOneProject,this)},getNextLi:function(e){e=e||window.event;var t,i=e.keyCode,n="li, .fake-li",a=".list-group",r=".hide",o=".list-closed, .hide",l=$(e.target).closest(n),c=$(e.currentTarget),d=l.nextAll(n).not(r).first(),u=l.prevAll(n).not(r).first(),h=function(e,t){if(e.hasClass(N)){var i=m.getGroupById(e.attr("groupid"));i.get("open")||i.trigger("slideToggle"),e=e.find(n).not(r)[t]()}return e},p=function(e,t){var i="next",s="first";"up"===e&&(i="prev",s="last");var d;if(t.length)d=h(t,s);else{var u=l.parents(n),t=u.length&&u[i+"All"](n).not(r).first();t&&t.length?d=h(t,s):(d=c[i+"All"](a).not(o).first().find(n).not(r)[s](),d=h(d,s))}return d};return i===s.up_arrow?t=p("up",u):i===s.down_arrow&&(t=p("down",d)),t},navigateByKeyUp:function(e){var t=this.getNextLi(e);if(t&&t.length){var i=t.find("a");Backbone.trigger("navigateProject",i.attr("href").slice(1),!0),i.focus()}},_resetSortOrder:function(){var e=$("#project-ul li"),t=i.orderStep,n=[],s=[];e.each(function(e){var i=e*t;if($(this).attr("order",i),$(this).hasClass(N))s.push({id:$(this).attr("groupid"),order:i});else{var a=$(this).find(".project-box").attr("projectid");n.push({id:a,order:i})}}),g.sortProject(JSON.stringify(n)),u.updateProjectsSortOrder(n),m.updateProjectGroups(s)},_changeSortOrder:function(e,t){var n=$("#project-ul li"),s=n.index(t),a=!1,r=0,o=i.orderStep,l=parseInt(n.eq(s-1).attr("order")),c=parseInt(n.eq(s+1).attr("order"));if(_.isNaN(l)&&_.isNaN(c)?a=!0:0===s&&(r=c-o),s===n.length-1)r=l+o;else{var d=c-l;1>=d?a=!0:r=(c+l)/2}a?this._resetSortOrder():g.sortProject(JSON.stringify([{id:e.get("id"),order:r}])),t.attr("order",r),e.set("sortOrder",r)},projectSortable:function(){var e,t,i=".project-list ul",s=this;$(i).sortable({connectWith:i,cancel:".group-all-task",delay:200,containment:this.el,items:"li",refreshPositions:!0,opacity:1,scroll:!0,cursor:"pointer",tolerance:"intersect",helper:function(e,t){var i="";return t.hasClass(N)&&(i=" f-li "),"<li class='p-sort-help active"+i+"'>"+t.html()+"</li>"},activate:function(e,i){t=i.item.attr("groupid")},start:function(t,i){e=i.helper.find("a").attr("projectId"),i.item.hide()},sort:function(e,t){var i=t.placeholder;d.showPlaceholder(i),t.placeholder.parents("."+N).length&&t.item.hasClass(N)&&d.hidePlaceholder(i)},beforeStop:function(e,t){},stop:function(i,a){if(n.drop_folder)return n.drop_folder=!1,void $(this).sortable("cancel");if(e){var r=u.getProjectById(e);s._changeSortOrder(r,a.item),s._changeGroupId(r,a),D.l_list("drag")}else t&&!a.item.parent().hasClass("group-project-ul")?(s._resetSortOrder(),D.l_folder("drag")):$(this).sortable("cancel")}})},onClose:function(){},showProjectView:function(){this.$el.find(".first-hide").show()},_changeGroupId:function(e,t){var i=null;t.item.parent().hasClass("group-project-ul")&&(t.item.next().hasClass("hide")||(i=t.item.parents("."+N).attr("groupid"))),e.changeGroupId(e.get("groupId")&&!i?"NONE":i)},changeGroupByDrag:function(e,t){var i=this._findProjectIdFromView(e),n=this.collection.get(i);e.detach();var s=t.getFirstOrderInGroup();_.isNaN(s)&&this._resetSortOrder(),n.set("sortOrder",s),n.changeGroupId(t.model.get("id"))},createProjectGroup:function(e,t){var i=parseInt(t.attr("order")),n=ObjectId(),s=new this.projectGroupCollection.model({id:n,name:l.get("new_project_group"),sortType:o.sortType.sortOrder,sortOrder:i,open:!0});s.local=!0,m.addNewGroup(s),e.detach(),t.detach();var a,r=[this._findProjectIdFromView(t),this._findProjectIdFromView(e)],c=this.findProjectsByIds(r),d=$("#project-ul ."+N);d.each(function(e){$(this).attr("groupid")===n&&(a=$(this))}),a.after(e).after(t),this._resetSortOrder();var u=this._findProjectIdFromView(e),h=this.findProjectById(u);this._changeSortOrder(h,e),_.each(c,function(e){e.changeGroupId(n)}),this.projectSortable(),D.l_folder("add")},findProjectsByIds:function(e){return this.collection.filter(function(t){return-1!=_.indexOf(e,t.get("id"))?!0:!1})},findProjectById:function(e){return this.collection.find(function(t){return t.get("id")===e})},_findProjectIdFromView:function(e){return e.find(".project-box").attr("projectid")},moveProjectGroup:function(e){this.commonAddOne(e)},getProjectId2OrderMap:function(e,t,n){var s=$(e),a=t.attr("order"),r=s.eq(s.index(t)+1),o=a+i.orderStep;r&&(o=r.attr("order"));var l={};return _.each(n,function(e){l[e]=(parseInt(a)+parseInt(o))/2,a=l[e]}),l},initListTag:function(){var e=V.getStoreInfo("list_tag_tab")||0;this.doSwitch(e)},doSwitch:function(e){var t=this.$(".l-tab"),i=this.$("[class*=l-tab-pane]");t.eq(e).hasClass("t-active")||(t.removeClass("t-active"),i.removeClass("t-active").addClass("hide"),t.eq(e).addClass("t-active"),this.$(".l-tab-pane-"+e).addClass("t-active").removeClass("hide"))},switchListTag:function(e){e=e||window.event;var t=$(e.currentTarget),i=this.$(".l-tab"),n=i.index(t);V.setStoreInfo("list_tag_tab",n),this.doSwitch(n)}})}),define("service/webnotify",["require","exports","module","configs/settings","utils/timeformat","service/prefs","utils/analytics"],function(e,t){var i=e("configs/settings"),n=e("utils/timeformat"),s=e("service/prefs"),a=e("utils/analytics"),r={};t.isSupportWebNotification="Notification"in window,t.getUserPermission=function(e){try{"granted"===Notification.permission?e():"denied"!==Notification.permission&&Notification.requestPermission(function(t){"permission"in Notification||(Notification.permission=t),"granted"===t&&e()})}catch(t){a.error("get_user_permission_error")}},t.createWebNotification=function(e){if(!t.isSupportWebNotification)return!1;if(s.get("showMeridiem"))var a="YYYY-MM-DD hh:mm A";else var a="YYYY-MM-DD HH:mm";e.get("isAllDay")&&(a="YYYY-MM-DD");var o=n.prefMomentFromUtc(e.get("dueDate")).format(a),l={icon:i.protocol+i.domain+"/static/img/icon_128.png",body:e.get("title"),tag:e.get("id")};t.getUserPermission(function(){var t=new Notification(o,l);r[e.get("id")]=t,t.onclick=function(){var t=i.protocol+i.domain+"/#p/"+e.get("projectId")+"/tasks/"+e.get("id");window.open(t)},t.onclose=function(e){var t=e.target.tag;r[t]=null}})},t.closeWebNotification=function(e){var t=r[e];t&&t.close()}}),define("hbs!template/reminder_list_item",["Handlebars"],function(e){return e.template(function(e,t,i,n,s){function a(e,t){return" dropdown-toggle "}function r(e,t){return" disabled "}function o(e,t){var n,s="";return s+='\n        <a class="snooze-action" data-snooze="nextPeriod">',(n=i.nextPeriod)?n=n.call(e,{hash:{},data:t}):(n=e.nextPeriod,n=typeof n===p?n.apply(e):n),s+=m(n)+"</a>\n        "}function l(e,t){var n,s,a="";return a+='\n        <a class="snooze-action" data-snooze="tomorrow">',s={hash:{},data:t},a+=m((n=i.I18n,n?n.call(e,"tomorrow",s):f.call(e,"I18n","tomorrow",s)))+"</a>\n        "}this.compilerInfo=[2,">= 1.0.0-rc.3"],i=i||e.helpers,s=s||{};var c,d,u,h="",p="function",m=this.escapeExpression,f=i.helperMissing,g=this,v=i.blockHelperMissing;return h+='<div class="r-inner">\n  \n  <div class="checker check-toggle avoid-event cr-pointer">\n        ',u={hash:{},data:s},c=i.svgIcon,d=c?c.call(t,"icon-completed","i-4 i-tny",u):f.call(t,"svgIcon","icon-completed","i-4 i-tny",u),(d||0===d)&&(h+=d),h+="\n        ",u={hash:{},data:s},c=i.svgIcon,d=c?c.call(t,"icon-checkbox","i-4 i-tny",u):f.call(t,"svgIcon","icon-checkbox","i-4 i-tny",u),(d||0===d)&&(h+=d),h+="\n        ",u={hash:{},data:s},c=i.svgIcon,d=c?c.call(t,"icon-subtask","i-4 i-tny",u):f.call(t,"svgIcon","icon-subtask","i-4 i-tny",u),(d||0===d)&&(h+=d),h+="\n        ",u={hash:{},data:s},c=i.svgIcon,d=c?c.call(t,"icon-subcalendar","i-4 i-tny",u):f.call(t,"svgIcon","icon-subcalendar","i-4 i-tny",u),(d||0===d)&&(h+=d),h+='\n  </div>\n\n  <div class="title">'+m((c=t.model,c=null==c||c===!1?c:c.title,typeof c===p?c.apply(t):c))+'</div>\n\n  <div class="action">\n    <button class="btn btn-tny btn-primary ',u={hash:{},inverse:g.program(3,r,s),fn:g.program(1,a,s),data:s},(d=i.ifNotInDisabledList)?d=d.call(t,u):(d=t.ifNotInDisabledList,d=typeof d===p?d.apply(t):d),i.ifNotInDisabledList||(d=v.call(t,d,u)),(d||0===d)&&(h+=d),h+='" data-toggle="dropdown">',u={hash:{},data:s},h+=m((c=i.I18n,c?c.call(t,"postpone_snooze_title",u):f.call(t,"I18n","postpone_snooze_title",u)))+'</button>\n    <button class="btn btn-tny btn-cancel close">',u={hash:{},data:s},h+=m((c=i.I18n,c?c.call(t,"close",u):f.call(t,"I18n","close",u)))+'</button>\n\n    <!-- dropdown menu -->\n    <div class="dropdown-menu pull-right">\n      <li>\n        <a class="snooze-action" data-snooze="15m">',u={hash:{},data:s},h+=m((c=i.I18n,c?c.call(t,"after_15minutes",u):f.call(t,"I18n","after_15minutes",u)))+'</a>\n      </li>\n      <li>\n        <a class="snooze-action" data-snooze="1h">',u={hash:{},data:s},h+=m((c=i.I18n,c?c.call(t,"after_1hour",u):f.call(t,"I18n","after_1hour",u)))+'</a>\n      </li>\n      <li>\n        <a class="snooze-action" data-snooze="3h">',u={hash:{},data:s},h+=m((c=i.I18n,c?c.call(t,"after_3hours",u):f.call(t,"I18n","after_3hours",u)))+"</a>\n      </li>\n\n      <li>\n        ",u={hash:{},inverse:g.program(7,l,s),fn:g.program(5,o,s),data:s},(d=i.ifWillRepeat)?d=d.call(t,u):(d=t.ifWillRepeat,d=typeof d===p?d.apply(t):d),i.ifWillRepeat||(d=v.call(t,d,u)),(d||0===d)&&(h+=d),h+="\n      </li>\n    </div>\n    <!-- /dropdown menu -->\n  </div>\n</div>\n"})}),define("view/modal/reminder/item",["require","exports","module","utils/condition","utils/timeformat","service/webnotify","service/prefs","utils/task-util","configs/dict","utils/analytics","utils/dom","hbs!template/reminder_list_item"],function(e,t){var i=e("utils/condition"),n=e("utils/timeformat"),s=e("service/webnotify"),a=e("service/prefs"),r=e("utils/task-util"),o=e("configs/dict"),l=e("utils/analytics"),c=e("utils/dom");t.View=Backbone.View.extend({tagName:"li",template:e("hbs!template/reminder_list_item"),className:"r-task before-animation",events:{"click .title":"gotoTask","click .check-toggle":"checkedTask","click .snooze-action":"doSnooze","click .close":"onClose"},initialize:function(){this.resetAttr(),this.render(),this.setAnimation(),this.webNotify(),this.currentTime=n.prefMoment()},resetAttr:function(){c.switchIcon(this.$el,this.model)},render:function(){return this.$el.html(this.template({model:this.model.toJSON(),nextPeriod:this.getNextReminder(),projectId:this.model.get("projectId")})),this},setAnimation:function(){var e=this;setTimeout(function(){e.$el.removeClass("before-animation")},100)},webNotify:function(){s.createWebNotification(this.model)},closeWebNotify:function(){s.closeWebNotification(this.model.get("id"))},getNextReminder:function(){if(this.model.get("repeatFlag")){var e=r.getNextReminderTime(this.model);return a.getTaskDetailDueDateTip(e)}},setNewRemindTime:function(e){var t=n.prefMoment(e).utc().format(o.format.atomTime);this.model.set("remindTime",t),this.model.save()},setNewDueDate:function(e){var t=n.prefMoment(e).utc().format(o.format.atomTime);this.model.set("dueDate",t),this.model.set("remindTime",t),this.model.save()},setPostponeSnooze:function(e){var t="",i="",n=/([0-9]+|[a-z]+)/gi,s=e.match(n),a=e;if("nextPeriod"==e)return t=r.getNextReminderTime(this.model),void this.setNewDueDate(t);if("tomorrow"==e)i=this.currentTime,e=moment(i).add("d",1);else if(2===s.length){var o="h"===s[1]?60:1;e=moment().add("m",s[0]*o)}this.setNewRemindTime(e),l.r_snooze(a)},doSnooze:function(e){var e=e||window.event;if(!e.target.className.match(/tip/i)){var t=$(e.currentTarget),i=t.attr("data-snooze");this.setPostponeSnooze(i),this.onClose()}},checkedTask:function(){i.isSubscribeCalendarTask(this.model)||(this.model.toggleModelComplete(),this.resetAttr(),this.onClose(),l.r_mark_done())},gotoTask:function(){var e=this.model.get("id"),t=this.model.get("projectId"),n="p/"+t+"/tasks/"+e;i.isSubscribeCalendarTask(this.model)&&(n="q/all/tasks/"+e),Backbone.trigger("navigateProject",n,{trigger:!0,replace:!0}),this.onClose(),l.r_view()},onClose:function(){this.$el.addClass("close-animation");var e=this;setTimeout(function(){e.remove()},200),this.closeWebNotify()}})}),define("modules/reminder-alert/reminder_alert",["require","exports","module","utils/timeformat","dao/taskdb","dao/scalendardb","service/task","view/modal/reminder/item"],function(e,t){function i(){this.initialize()}var n=e("utils/timeformat"),s=e("dao/taskdb").db,a=e("dao/scalendardb").db,r=e("service/task"),o=e("view/modal/reminder/item").View;i.prototype={initialize:function(){this.$ul=$("#reminders-modal ul"),this.reminderAction()},refreshAllTodoTasks:function(){$(document).everyTime(6e5,function(){r.getAllTodoTasks(!0)})},refreshReminderTasks:function(){$(document).everyTime(3e5,function(){r.refreshReminderTasks()})},reminderAction:function(){var e=this;$(document).everyTime(1e3,function(t){var i=s.getOnTimeTasks(),r=a.getOnTimeSCalendarTasks(),o=i.concat(r);if(o.length){var l=n.prefMoment().format("HH:mm");if(l===e.lastTime)return;e.lastTime=l,_.each(o,function(t){e.renderItem(t)})}})},renderItem:function(e){var t=new o({model:e});this.$ul.find(".open").removeClass("open"),this.$ul.append(t.$el)}},t.Alert=i}),define("view/event",["require","exports","module","dao/project-group","dao/userTagdb"],function(e,t){var i=e("dao/project-group").db,n=e("dao/userTagdb").db;Backbone.on("refreshAutoComplete",n.autoCompleteTags,n),Backbone.on("storeGroupInfoToLocal",i.storeInfo,i)}),define("webapp",["require","exports","module","rewrite/index","dao/sync","utils/browser","template/helper/all","template/helper/I18n","view/body","configs/settings","utils/dbstore","utils/server","service/router","service/shortcuts","service/prefs","service/userProfile","utils/timeformat","service/plugin","dao/taskdb","dao/projectdb","dao/shareduserdb","dao/notificationdb","view/project/list","modules/reminder-alert/reminder_alert","view/tip","lang/index","utils/hash","data-sync/index","utils/print","view/event","configs/dict","offline/storage"],function(e,t){e("rewrite/index"),e("dao/sync"),e("utils/browser"),e("template/helper/all"),e("template/helper/I18n");var i=e("view/body").View;new i;var n=e("configs/settings"),s=e("utils/dbstore"),a=e("utils/server"),r=e("service/router").router,o=e("service/shortcuts"),l=e("service/prefs"),c=e("service/userProfile"),d=e("utils/timeformat"),u=e("service/plugin"),h=e("dao/taskdb").db,p=e("dao/projectdb").db,m=e("dao/shareduserdb").db,f=e("dao/notificationdb").db,g=e("view/project/list").View,v=e("modules/reminder-alert/reminder_alert").Alert,y=(e("view/tip").View,e("lang/index")),k=e("utils/hash"),w=e("data-sync/index"),b=e("utils/print");e("view/event");var T=e("configs/dict"),I=e("offline/storage");u.installationBeforeRendering(),p.resetSmartProjectByLocal(),a.getCalendarSubscribe(function(e){p.replaceSubscribeProject(e),l.fetch({success:function(){B()},error:function(){B()}})});var C=function(){c.fetch({success:function(){var e=c;m.setUserAvatar(e.get("userId"),e.get("picture")),e.set("name",e.get("name")||e.get("username")),e.set("picture",e.get("picture")||n.defaultAvatar)},error:function(){}})},x=function(){f.initialize(),$(document).everyTime(3e5,function(){f.getCountFromServer()})},S=function(){_.delay(function(){r.projectListView.render(),p.refresh()},d.prefMoment().endOf("day")-d.prefMoment())},D=function(){var e=d.prefMoment(),t=1e4,i=function(){var n=d.prefMoment();n-e>2*t&&n.date()!=e.date()&&(r.projectListView.render(),Backbone.trigger("refreshCalendarViewToday")),e=d.prefMoment(),_.delay(i,t)};i()},j=function(){var e=n.productName,t=" - ",i=k.isSettings()?y.get("settings"):$("#project-name-bar").text(),s=i?i+t+e:e;document.title=s},P=function(){"onhashchange"in window&&(j(),$(window).on("hashchange",function(){j()}))},M=function(){$(window).on("beforeunload",function(){s.listenBrowserClose()})},A=function(){M(),P()},V=function(){var e=p.getNotInAllProjects();h.getTasksByProjects(e)},O=function(){p.refresh(function(){new g({collection:p.collection}),N(),V(),Backbone.history.start(),C(),u.installPlugins(),new v,x(),o.use.initialize(),S(),D(),A(),w.start(),Backbone.trigger("refreshAutoComplete")})},B=function(){var e=I.getCacheItem(T.cachePath.smartProjects);_.isEmpty(e)?a.getUserRegistered(function(e){e&&(n.user.isJustRegistered=!0),O()},function(){O()}):O()},N=function(){setTimeout(function(){$("#loading-view").hide()})};window.getCountTodayAndOverdue=function(){return $("#project_today .count").html()},$(function(){b.preloadcss()})});